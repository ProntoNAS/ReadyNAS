From 50befdb659585b9840264c77708d2dc638624137 Mon Sep 17 00:00:00 2001
From: Matt Caswell <matt@openssl.org>
Date: Sat, 3 Jan 2015 00:54:35 +0000
Subject: [PATCH 12/15] Follow on from CVE-2014-3571. This fixes the code that
 was the original source of the crash due to p being NULL. Steve's fix
 prevents this situation from occuring - however this is by no means obvious
 by looking at the code for dtls1_get_record. This fix just makes things look
 a bit more sane.

Conflicts:
	ssl/d1_pkt.c

Reviewed-by: Dr Stephen Henson <steve@openssl.org>
---
 ssl/d1_pkt.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/ssl/d1_pkt.c b/ssl/d1_pkt.c
index 5eac25fb..bc478c2 100644
--- a/ssl/d1_pkt.c
+++ b/ssl/d1_pkt.c
@@ -624,7 +624,8 @@ again:
 	 * would be dropped unnecessarily.
 	 */
 	if (!(s->d1->listen && rr->type == SSL3_RT_HANDSHAKE &&
-		*p == SSL3_MT_CLIENT_HELLO) &&
+		s->packet_length > DTLS1_RT_HEADER_LENGTH &&
+		s->packet[DTLS1_RT_HEADER_LENGTH] == SSL3_MT_CLIENT_HELLO) &&
 		! dtls1_record_replay_check(s, bitmap, &(rr->seq_num)))
 		{
 		rr->length = 0;
-- 
2.1.4

