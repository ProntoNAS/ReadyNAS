#! /bin/sh /usr/share/dpatch/dpatch-run
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Fix regression DoS introduced by fix for CVE-2011-0419
## DP: Patch by "William A. Rowe Jr." <wrowe@rowe-clan.net>
@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' squeeze-branch~/strings/apr_fnmatch.c squeeze-branch/strings/apr_fnmatch.c
--- squeeze-branch~/strings/apr_fnmatch.c	2011-05-19 07:53:41.553556013 +0200
+++ squeeze-branch/strings/apr_fnmatch.c	2011-05-19 07:53:41.609556010 +0200
@@ -196,7 +196,10 @@
     const char *mismatch = NULL;
     int matchlen = 0;
 
-    while (*pattern)
+    if (*pattern == '*')
+        goto firstsegment;
+
+    while (*pattern && *string)
     {
         /* Match balanced slashes, starting a new segment pattern
          */
@@ -207,6 +210,7 @@
             ++string;
         }            
 
+firstsegment:
         /* At the beginning of each segment, validate leading period behavior.
          */
         if ((flags & APR_FNM_PERIOD) && (*string == '.'))
@@ -361,9 +365,9 @@
             return APR_FNM_NOMATCH;
     }
 
-    /* pattern is at EOS; if string is also, declare success
+    /* Where both pattern and string are at EOS, declare success
      */
-    if (!*string)
+    if (!*string && !*pattern)
         return 0;
 
     /* pattern didn't match to the end of string */
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' squeeze-branch~/test/testfnmatch.c squeeze-branch/test/testfnmatch.c
--- squeeze-branch~/test/testfnmatch.c	2011-05-19 07:53:41.553556013 +0200
+++ squeeze-branch/test/testfnmatch.c	2011-05-19 07:53:55.929556004 +0200
@@ -95,6 +95,8 @@
     {"test/?this", "test/.this",        FAILS_IF(APR_FNM_PERIOD | APR_FNM_PATHNAME)},
     {"test/[.]this", "test/.this",      FAILS_IF(APR_FNM_PERIOD | APR_FNM_PATHNAME)},
 
+    {"/*/WEB-INF/", "/wontmatch",       FAILS},
+
     {NULL, NULL, 0}
 };
 
