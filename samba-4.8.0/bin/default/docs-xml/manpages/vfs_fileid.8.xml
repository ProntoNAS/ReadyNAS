<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN" "http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">
<refentry id="vfs_fileid.8">

<refmeta>
	<refentrytitle>vfs_fileid</refentrytitle>
	<manvolnum>8</manvolnum>
	<refmiscinfo class="source">Samba</refmiscinfo>
	<refmiscinfo class="manual">System Administration tools</refmiscinfo>
	<refmiscinfo class="version">4.8.0</refmiscinfo>
</refmeta>


<refnamediv>
	<refname>vfs_fileid</refname>
	<refpurpose>Generates file_id structs with unique device id values for
	cluster setups</refpurpose>
</refnamediv>

<refsynopsisdiv>
	<cmdsynopsis sepchar=" ">
		<literal>vfs objects = fileid</literal>
	</cmdsynopsis>
</refsynopsisdiv>

<refsect1>
	<title>DESCRIPTION</title>

	<para>This VFS module is part of the
	<citerefentry><refentrytitle>samba</refentrytitle>
	<manvolnum>7</manvolnum></citerefentry>
	suite.</para>

	<para>Samba uses file_id structs to uniquely identify files
	for locking purpose. By default the file_id contains the device
	and inode number returned by the <literal>stat()</literal> system call.
	As the file_id is a unique identifier of a file, it must be the same
	on all nodes in a cluster setup. This module overloads the
	<literal>SMB_VFS_FILE_ID_CREATE()</literal> operation and
	generates the device number based on the configured algorithm
	(see the "fileid:algorithm" option).
	</para>

	<para>When using the fsname or fsid algorithm a
	<literal>stat()</literal> and <literal>statfs()</literal> call is
	required for all mounted file systems to generate the file_id. If e.g.
	an NFS file system is unresponsive such a call might block and the smbd
	process will become unresponsive. Use the "fileid:fstype deny",
	"fileid:fstype allow", "fileid:mntdir deny", or "fileid:mntdir allow"
	options to ignore potentially unresponsive file systems.
	</para>
</refsect1>


<refsect1>
	<title>OPTIONS</title>

	<variablelist>

		<varlistentry>
		<term>fileid:algorithm = ALGORITHM</term>
		<listitem>
		<para>Available algorithms are <literal>fsname</literal>,
		<literal>fsname_nodirs</literal>, <literal>fsid</literal> and
		<literal>hostname</literal>. The default value is
		<literal>fsname</literal>.
		</para>
		<para>The <literal>fsname</literal> algorithm generates
		device id by hashing the kernel device name.
		</para>
		<para>The <literal>fsname_nodirs</literal> algorithm generates
		device id by hashing the kernel device name for files and by hashing
		the hostname for directories. This can be used to deliberately
		break lock coherency for directories in a cluster.
		</para>
		<para>The <literal>fsid</literal> algorithm generates
		the device id from the <literal>f_fsid</literal> returned
		from the <literal>statfs()</literal> syscall.
		</para>
		<para>The <literal>hostname</literal> algorithm generates device
		id by hashing the hostname. This can be used to deliberately
		break lock coherency in a cluster.
		</para>
		<para>The <literal>fsname_norootdir</literal> algorithm
		generates device ids by hashing the kernel device name, except
		for the root directory of shares where it will use the hostname
		algorithm. This can be used to deliberately break lock coherency
		in a cluster for the root directory of a share.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:mapping = ALGORITHM</term>
		<listitem>
		<para>This option is the legacy version of the
		<literal>fileid:algorithm</literal> option, which was used in earlier
		versions of fileid mapping feature in custom Samba 3.0 versions.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:fstype deny = LIST</term>
		<listitem>
		<para>List of file system types to be ignored for file_id
		generation.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:fstype allow = LIST</term>
		<listitem>
		<para>List of file system types to be allowed for file_id
		generation. If this option is set, file system types not listed
		here are ignored.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:mntdir deny = LIST</term>
		<listitem>
		<para>List of file system mount points to be ignored for
		file_id	generation.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:mntdir allow = LIST</term>
		<listitem>
		<para>List of file system mount points to be allowed for file_id
		generation. If this option is set, file system mount points
		not listed here are ignored.
		</para>
		</listitem>
		</varlistentry>

		<varlistentry>
		<term>fileid:nolockinode</term>
		<listitem>
		<para>This option triggers use of the fileid hostname algorithm
		for the configured inode which can be used to deliberately break
		lock coherency for the corresponding file or directory in a
		cluster.
		</para>
		</listitem>
		</varlistentry>
	</variablelist>
</refsect1>

<refsect1>
	<title>EXAMPLES</title>

	<para>Usage of the <literal>fileid</literal> module with the
	<literal>fsid</literal> algorithm:</para>

<programlisting format="linespecific">
        <parameter>[global]</parameter>
	<link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="VFSOBJECTS" xlink:href="smb.conf.5.html#VFSOBJECTS">vfs objects = fileid</link>
	<link xmlns:xlink="http://www.w3.org/1999/xlink" linkend="FILEID:ALGORITHM" xlink:href="smb.conf.5.html#FILEID:ALGORITHM">fileid:algorithm = fsid</link>
</programlisting>

</refsect1>

<refsect1>
	<title>VERSION</title>

	<para>This man page is part of version 4.8.0 of the Samba suite.
	</para>
</refsect1>

<refsect1>
	<title>AUTHOR</title>

	<para>The original Samba software and related utilities
	were created by Andrew Tridgell. Samba is now developed
	by the Samba Team as an Open Source project similar
	to the way the Linux kernel is developed.</para>

</refsect1>

</refentry>
