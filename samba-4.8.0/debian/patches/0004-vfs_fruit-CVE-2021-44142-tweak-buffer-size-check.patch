From 254316b25c346c0c12c7a0052d2441291777534b Mon Sep 17 00:00:00 2001
From: Noel Power <noel.power@suse.com>
Date: Fri, 21 Jan 2022 14:52:53 +0000
Subject: [PATCH 4/6] vfs_fruit: CVE-2021-44142 tweak buffer size check

---
 source3/modules/vfs_fruit.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/source3/modules/vfs_fruit.c b/source3/modules/vfs_fruit.c
index b8daaf5..5b01f74 100644
--- a/source3/modules/vfs_fruit.c
+++ b/source3/modules/vfs_fruit.c
@@ -774,7 +774,7 @@ static bool ad_unpack_xattrs(struct adouble *ad)
 		DBG_ERR("Bad total size: 0x%" PRIx32 "\n", h->adx_total_size);
 		return false;
 	}
-	if (h->adx_total_size > AD_XATTR_MAX_HDR_SIZE) {
+	if (bufsize < AD_DATASZ_DOT_UND || bufsize > AD_XATTR_MAX_HDR_SIZE) {
 		DBG_ERR("Bad total size: 0x%" PRIx32 "\n", h->adx_total_size);
 		return false;
 	}
-- 
2.1.4

