diff -Npur samba-4.8.4/WHATSNEW.txt samba-4.8.5/WHATSNEW.txt
--- samba-4.8.4/WHATSNEW.txt	2018-08-11 08:16:04.000000000 +0200
+++ samba-4.8.5/WHATSNEW.txt	2018-08-24 09:58:20.000000000 +0200
@@ -1,4 +1,119 @@
                    =============================
+                   Release Notes for Samba 4.8.5
+                           August 24, 2018
+                   =============================
+
+
+This is the latest stable release of the Samba 4.8 release series.
+
+
+Changes since 4.8.4:
+--------------------
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13474: python: pysmbd: Additional error path leak fix.
+   * BUG 13511: libsmbclient: Initialize written value before use.
+   * BUG 13519: ldb: Refuse to build Samba against a newer minor version of
+     ldb.
+   * BUG 13527: s3: libsmbclient: Fix cli_splice() fallback when reading less
+     than a complete file.
+   * BUG 13537: Using "sendfile = yes" with SMB2 can cause CPU spin.
+
+o  Andrew Bartlett <abartlet@samba.org>
+   * BUG 13575: ldb: Release LDB 1.3.6.
+
+o  Bailey Berro <baileyberro@chromium.org>
+   * BUG 13511: libsmbclient: Initialize written in cli_splice_fallback().
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 13318: Durable Handles reconnect fails in a cluster when the cluster
+     fs uses different device ids.
+   * BUG 13351: s3: smbd: Always set vuid in check_user_ok().
+   * BUG 13441: vfs_fruit: Delete 0 byte size streams if AAPL is enabled.
+   * BUG 13451: Fail renaming file if that file has open streams.
+   * BUG 13505: lib: smb_threads: Fix access before init bug.
+   * BUG 13535: s3: smbd: Fix path check in
+     smbd_smb2_create_durable_lease_check().
+
+o  Alexander Bokovoy <ab@samba.org>
+   * BUG 13538: samba-tool trust: Support discovery via netr_GetDcName.
+
+o  Samuel Cabrero <scabrero@suse.de>
+   * BUG 13540: ctdb_mutex_ceph_rados_helper: Set SIGINT signal handler.
+
+o  David Disseldorp <ddiss@samba.org>
+   * BUG 13506: vfs_ceph: Don't lie about flock support.
+   * BUG 13540: Fix deadlock with ctdb_mutex_ceph_rados_helper.
+
+o  Amitay Isaacs <amitay@gmail.com>
+   * BUG 13493: ctdb: Fix build on FreeBSD and AIX.
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13553: libsmb: Fix CID 1438243 (Unchecked return value), CID 1438244
+     (Unsigned compared against 0), CID 1438245 (Dereference before null check),
+     CID 1438246 (Unchecked return value).
+   * BUG 13584: vfs_fruit: Fix a panic if fruit_access_check detects a locking
+     conflict.
+
+o  Gary Lockyer <gary@catalyst.net.nz>
+   * BUG 13536: The current position in the dns name was not advanced past the
+     '.' character.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13308: samba-tool domain trust: Fix trust compatibility to Windows
+     Server 1709 and FreeIPA.
+
+o  Oleksandr Natalenko <oleksandr@redhat.com>
+   * BUG 13559: systemd: Only start smb when network interfaces are up.
+
+o  Noel Power <noel.power@suse.com>
+   * BUG 13553: Fix quotas with SMB2.
+   * BUG 13563: s3/smbd: Ensure quota code is only called when quota support
+     detected.
+
+o  Anoop C S <anoopcs@redhat.com>
+   * BUG 13204: s3/libsmb: Explicitly set delete_on_close token for rmdir.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 13489: krb5_plugin: Install plugins to krb5 modules dir.
+   * BUG 13503: s3:winbind: Do not lookup local system accounts in AD.
+
+o  Martin Schwenke <martin@meltin.net>
+   * BUG 13499: Don't use CTDB_BROADCAST_VNNMAP.
+   * BUG 13500: ctdb-daemon: Only consider client ID for local database attach.
+
+o  Justin Stephenson <jstephen@redhat.com>
+   * BUG 13485: s3:client: Add "--quiet" option to smbclient.
+
+o  Ralph Wuerthner <ralph.wuerthner@de.ibm.com>
+   * BUG 13568: s3: vfs: time_audit: Fix handling of token_blob in
+     smb_time_audit_offload_read_recv().
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
+                   =============================
                    Release Notes for Samba 4.8.4
                            August 14, 2018
                    =============================
@@ -85,8 +200,8 @@ database (https://bugzilla.samba.org/).
 ======================================================================
 
 
-Release notes for older releases follow:
-----------------------------------------
+----------------------------------------------------------------------
+
 
                    =============================
                    Release Notes for Samba 4.8.3
diff -Npur samba-4.8.4/buildtools/wafsamba/samba_autoconf.py samba-4.8.5/buildtools/wafsamba/samba_autoconf.py
--- samba-4.8.4/buildtools/wafsamba/samba_autoconf.py	2018-01-25 20:55:34.000000000 +0100
+++ samba-4.8.5/buildtools/wafsamba/samba_autoconf.py	2018-08-24 09:58:20.000000000 +0200
@@ -365,7 +365,7 @@ def CHECK_CODE(conf, code, define,
                headers=None, msg=None, cflags='', includes='# .',
                local_include=True, lib=None, link=True,
                define_ret=False, quote=False,
-               on_target=True):
+               on_target=True, strict=False):
     '''check if some code compiles and/or runs'''
 
     if CONFIG_SET(conf, define):
@@ -395,6 +395,16 @@ def CHECK_CODE(conf, code, define,
 
     cflags = TO_LIST(cflags)
 
+    # Be strict when relying on a compiler check
+    # Some compilers (e.g. xlc) ignore non-supported features as warnings
+    if strict:
+        extra_cflags = None
+        if conf.env["CC_NAME"] == "gcc":
+            extra_cflags = "-Werror"
+        elif conf.env["CC_NAME"] == "xlc":
+            extra_cflags = "-qhalt=w"
+        cflags.append(extra_cflags)
+
     if local_include:
         cflags.append('-I%s' % conf.curdir)
 
diff -Npur samba-4.8.4/buildtools/wafsamba/wscript samba-4.8.5/buildtools/wafsamba/wscript
--- samba-4.8.4/buildtools/wafsamba/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/buildtools/wafsamba/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -374,6 +374,7 @@ def configure(conf):
         conf.CHECK_CODE('''int main(void) { return 0; }
                            __attribute__((visibility("default"))) void vis_foo2(void) {}''',
                         cflags=conf.env.VISIBILITY_CFLAGS,
+                        strict=True,
                         define='HAVE_VISIBILITY_ATTR', addmain=False)
 
     # check HAVE_CONSTRUCTOR_ATTRIBUTE
@@ -391,6 +392,7 @@ def configure(conf):
             ''',
             'HAVE_CONSTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library constructor support')
 
         # check HAVE_DESTRUCTOR_ATTRIBUTE
@@ -408,6 +410,7 @@ def configure(conf):
             ''',
             'HAVE_DESTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library destructor support')
 
     conf.CHECK_CODE('''
@@ -424,6 +427,7 @@ def configure(conf):
             ''',
             'HAVE___ATTRIBUTE__',
             addmain=False,
+            strict=True,
             msg='Checking for __attribute__')
 
     if sys.platform.startswith('aix'):
diff -Npur samba-4.8.4/ctdb/client/client_tunnel.c samba-4.8.5/ctdb/client/client_tunnel.c
--- samba-4.8.4/ctdb/client/client_tunnel.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/client/client_tunnel.c	2018-08-24 09:58:20.000000000 +0200
@@ -431,8 +431,8 @@ struct tevent_req *ctdb_tunnel_request_s
 	};
 
 	if (destnode == CTDB_BROADCAST_ALL ||
-	    destnode == CTDB_BROADCAST_VNNMAP ||
-	    destnode == CTDB_BROADCAST_ALL) {
+	    destnode == CTDB_BROADCAST_ACTIVE ||
+	    destnode == CTDB_BROADCAST_CONNECTED) {
 		state->wait_for_reply = false;
 	}
 	if (! state->wait_for_reply) {
diff -Npur samba-4.8.4/ctdb/common/ctdb_util.c samba-4.8.5/ctdb/common/ctdb_util.c
--- samba-4.8.4/ctdb/common/ctdb_util.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/common/ctdb_util.c	2018-08-24 09:58:20.000000000 +0200
@@ -389,8 +389,8 @@ void ctdb_canonicalize_ip(const ctdb_soc
 			       sizeof(cip->ip.sin_addr));
 		} else {
 			cip->ip6.sin6_family = AF_INET6;
-#ifdef HAVE_SOCK_SIN_LEN
-			cip->ip6.sin_len = sizeof(ctdb_sock_addr);
+#ifdef HAVE_SOCK_SIN6_LEN
+			cip->ip6.sin6_len = sizeof(ctdb_sock_addr);
 #endif
 			cip->ip6.sin6_port   = ip->ip6.sin6_port;
 			memcpy(&cip->ip6.sin6_addr,
diff -Npur samba-4.8.4/ctdb/common/sock_io.c samba-4.8.5/ctdb/common/sock_io.c
--- samba-4.8.4/ctdb/common/sock_io.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/common/sock_io.c	2018-08-24 09:58:20.000000000 +0200
@@ -275,7 +275,7 @@ int sock_queue_write(struct sock_queue *
 {
 	struct tevent_req *req;
 	struct sock_queue_write_state *state;
-	bool status;
+	struct tevent_queue_entry *qentry;
 
 	if (buflen >= INT32_MAX) {
 		return -1;
@@ -289,9 +289,9 @@ int sock_queue_write(struct sock_queue *
 	state->pkt = buf;
 	state->pkt_size = (uint32_t)buflen;
 
-	status = tevent_queue_add_entry(queue->queue, queue->ev, req,
+	qentry = tevent_queue_add_entry(queue->queue, queue->ev, req,
 					sock_queue_trigger, queue);
-	if (! status) {
+	if (qentry == NULL) {
 		talloc_free(req);
 		return -1;
 	}
diff -Npur samba-4.8.4/ctdb/common/system_util.c samba-4.8.5/ctdb/common/system_util.c
--- samba-4.8.4/ctdb/common/system_util.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/common/system_util.c	2018-08-24 09:58:20.000000000 +0200
@@ -154,7 +154,7 @@ static bool parse_ipv6(const char *s, co
 		saddr->ip6.sin6_scope_id = if_nametoindex(ifaces);
 	}
 
-#ifdef HAVE_SOCK_SIN_LEN
+#ifdef HAVE_SOCK_SIN6_LEN
 	saddr->ip6.sin6_len = sizeof(*saddr);
 #endif
 	return true;
diff -Npur samba-4.8.4/ctdb/doc/ctdb-etcd.7 samba-4.8.5/ctdb/doc/ctdb-etcd.7
--- samba-4.8.4/ctdb/doc/ctdb-etcd.7	2018-08-11 08:18:30.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb-etcd.7	2018-08-24 10:19:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdb-statistics.7 samba-4.8.5/ctdb/doc/ctdb-statistics.7
--- samba-4.8.4/ctdb/doc/ctdb-statistics.7	2018-08-11 08:18:29.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb-statistics.7	2018-08-24 10:19:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdb-tunables.7 samba-4.8.5/ctdb/doc/ctdb-tunables.7
--- samba-4.8.4/ctdb/doc/ctdb-tunables.7	2018-08-11 08:18:30.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb-tunables.7	2018-08-24 10:19:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdb.1 samba-4.8.5/ctdb/doc/ctdb.1
--- samba-4.8.4/ctdb/doc/ctdb.1	2018-08-11 08:18:26.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb.1	2018-08-24 10:19:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -164,7 +164,7 @@ Sometimes this number will be shown as "
 \fBVirtual Node Number (VNN) map\fR
 .RS 4
 .PP
-Consists of the number of virtual nodes and mapping from virtual node numbers to physical node numbers\&. Virtual nodes host CTDB databases\&. Only nodes that are participating in the VNN map can become lmaster or dmaster for database records\&.
+Consists of the number of virtual nodes and mapping from virtual node numbers to physical node numbers\&. Only nodes that are participating in the VNN map can become lmaster for database records\&.
 .RE
 .sp
 .it 1 an-trap
diff -Npur samba-4.8.4/ctdb/doc/ctdb.1.html samba-4.8.5/ctdb/doc/ctdb.1.html
--- samba-4.8.4/ctdb/doc/ctdb.1.html	2018-08-11 08:18:26.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb.1.html	2018-08-24 10:19:31.000000000 +0200
@@ -96,10 +96,9 @@
 	  through a recovery.
 	</p></div><div class="refsect3"><a name="idm128"></a><h4>Virtual Node Number (VNN) map</h4><p>
 	  Consists of the number of virtual nodes and mapping from
-	  virtual node numbers to physical node numbers.  Virtual
-	  nodes host CTDB databases.  Only nodes that are
-	  participating in the VNN map can become lmaster or dmaster
-	  for database records.
+	  virtual node numbers to physical node numbers.  Only nodes
+	  that are participating in the VNN map can become lmaster for
+	  database records.
 	</p></div><div class="refsect3"><a name="idm131"></a><h4>Recovery mode</h4><p>
 	  This is the current recovery mode of the cluster. There are two possible modes:
 	</p><p>
diff -Npur samba-4.8.4/ctdb/doc/ctdb.1.xml samba-4.8.5/ctdb/doc/ctdb.1.xml
--- samba-4.8.4/ctdb/doc/ctdb.1.xml	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/doc/ctdb.1.xml	2018-08-24 09:58:20.000000000 +0200
@@ -292,10 +292,9 @@
 	<title>Virtual Node Number (VNN) map</title>
 	<para>
 	  Consists of the number of virtual nodes and mapping from
-	  virtual node numbers to physical node numbers.  Virtual
-	  nodes host CTDB databases.  Only nodes that are
-	  participating in the VNN map can become lmaster or dmaster
-	  for database records.
+	  virtual node numbers to physical node numbers.  Only nodes
+	  that are participating in the VNN map can become lmaster for
+	  database records.
 	</para>
       </refsect3>
 
diff -Npur samba-4.8.4/ctdb/doc/ctdb.7 samba-4.8.5/ctdb/doc/ctdb.7
--- samba-4.8.4/ctdb/doc/ctdb.7	2018-08-11 08:18:29.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb.7	2018-08-24 10:19:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdb_diagnostics.1 samba-4.8.5/ctdb/doc/ctdb_diagnostics.1
--- samba-4.8.4/ctdb/doc/ctdb_diagnostics.1	2018-08-11 08:18:27.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb_diagnostics.1	2018-08-24 10:19:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.8.5/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.8.4/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-08-11 08:18:30.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-08-24 10:19:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdbd.1 samba-4.8.5/ctdb/doc/ctdbd.1
--- samba-4.8.4/ctdb/doc/ctdbd.1	2018-08-11 08:18:26.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdbd.1	2018-08-24 10:19:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdbd.conf.5 samba-4.8.5/ctdb/doc/ctdbd.conf.5
--- samba-4.8.4/ctdb/doc/ctdbd.conf.5	2018-08-11 08:18:29.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdbd.conf.5	2018-08-24 10:19:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ctdbd_wrapper.1 samba-4.8.5/ctdb/doc/ctdbd_wrapper.1
--- samba-4.8.4/ctdb/doc/ctdbd_wrapper.1	2018-08-11 08:18:28.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ctdbd_wrapper.1	2018-08-24 10:19:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ltdbtool.1 samba-4.8.5/ctdb/doc/ltdbtool.1
--- samba-4.8.4/ctdb/doc/ltdbtool.1	2018-08-11 08:18:27.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ltdbtool.1	2018-08-24 10:19:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/onnode.1 samba-4.8.5/ctdb/doc/onnode.1
--- samba-4.8.4/ctdb/doc/onnode.1	2018-08-11 08:18:28.000000000 +0200
+++ samba-4.8.5/ctdb/doc/onnode.1	2018-08-24 10:19:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/doc/ping_pong.1 samba-4.8.5/ctdb/doc/ping_pong.1
--- samba-4.8.4/ctdb/doc/ping_pong.1	2018-08-11 08:18:27.000000000 +0200
+++ samba-4.8.5/ctdb/doc/ping_pong.1	2018-08-24 10:19:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "08/11/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "08/24/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/ctdb/include/ctdb_private.h samba-4.8.5/ctdb/include/ctdb_private.h
--- samba-4.8.4/ctdb/include/ctdb_private.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/include/ctdb_private.h	2018-08-24 09:58:20.000000000 +0200
@@ -726,9 +726,12 @@ int ctdb_set_db_readonly(struct ctdb_con
 
 int ctdb_process_deferred_attach(struct ctdb_context *ctdb);
 
-int32_t ctdb_control_db_attach(struct ctdb_context *ctdb, TDB_DATA indata,
+int32_t ctdb_control_db_attach(struct ctdb_context *ctdb,
+			       TDB_DATA indata,
 			       TDB_DATA *outdata,
-			       uint8_t db_flags, uint32_t client_id,
+			       uint8_t db_flags,
+			       uint32_t srcnode,
+			       uint32_t client_id,
 			       struct ctdb_req_control_old *c,
 			       bool *async_reply);
 int32_t ctdb_control_db_detach(struct ctdb_context *ctdb, TDB_DATA indata,
diff -Npur samba-4.8.4/ctdb/protocol/protocol.h samba-4.8.5/ctdb/protocol/protocol.h
--- samba-4.8.4/ctdb/protocol/protocol.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/protocol/protocol.h	2018-08-24 09:58:20.000000000 +0200
@@ -44,7 +44,7 @@ enum ctdb_operation {
 /* send a broadcast to all nodes in the cluster, active or not */
 #define CTDB_BROADCAST_ALL    0xF0000002
 /* send a broadcast to all nodes in the current vnn map */
-#define CTDB_BROADCAST_VNNMAP 0xF0000003
+#define CTDB_BROADCAST_ACTIVE 0xF0000003
 /* send a broadcast to all connected nodes */
 #define CTDB_BROADCAST_CONNECTED 0xF0000004
 /* send a broadcast to selected connected nodes */
diff -Npur samba-4.8.4/ctdb/protocol/protocol_debug.c samba-4.8.5/ctdb/protocol/protocol_debug.c
--- samba-4.8.4/ctdb/protocol/protocol_debug.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/protocol/protocol_debug.c	2018-08-24 09:58:20.000000000 +0200
@@ -264,8 +264,8 @@ static void ctdb_pnn_print(uint32_t pnn,
 		fprintf(fp, "CURRENT");
 	} else if (pnn == CTDB_BROADCAST_ALL) {
 		fprintf(fp, "ALL");
-	} else if (pnn == CTDB_BROADCAST_VNNMAP) {
-		fprintf(fp, "VNNMAP");
+	} else if (pnn == CTDB_BROADCAST_ACTIVE) {
+		fprintf(fp, "ACTIVE");
 	} else  if (pnn == CTDB_BROADCAST_CONNECTED) {
 		fprintf(fp, "CONNECTED");
 	} else if (pnn == CTDB_MULTICAST) {
diff -Npur samba-4.8.4/ctdb/protocol/protocol_util.c samba-4.8.5/ctdb/protocol/protocol_util.c
--- samba-4.8.4/ctdb/protocol/protocol_util.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/protocol/protocol_util.c	2018-08-24 09:58:20.000000000 +0200
@@ -206,7 +206,7 @@ static int ipv6_from_string(const char *
 		return EINVAL;
 	}
 
-#ifdef HAVE_SOCK_SIN_LEN
+#ifdef HAVE_SOCK_SIN6_LEN
 	ip6->sin6_len = sizeof(*ip6);
 #endif
 	return 0;
diff -Npur samba-4.8.4/ctdb/server/ctdb_cluster_mutex.c samba-4.8.5/ctdb/server/ctdb_cluster_mutex.c
--- samba-4.8.4/ctdb/server/ctdb_cluster_mutex.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/server/ctdb_cluster_mutex.c	2018-08-24 09:58:20.000000000 +0200
@@ -19,11 +19,11 @@
    along with this program; if not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <tevent.h>
-
 #include "replace.h"
 #include "system/network.h"
 
+#include <tevent.h>
+
 #include "lib/util/debug.h"
 #include "lib/util/time.h"
 #include "lib/util/strv.h"
diff -Npur samba-4.8.4/ctdb/server/ctdb_control.c samba-4.8.5/ctdb/server/ctdb_control.c
--- samba-4.8.4/ctdb/server/ctdb_control.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/server/ctdb_control.c	2018-08-24 09:58:20.000000000 +0200
@@ -267,18 +267,34 @@ static int32_t ctdb_control_dispatch(str
 	}
 
 	case CTDB_CONTROL_DB_ATTACH:
-	  return ctdb_control_db_attach(ctdb, indata, outdata, 0, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					0,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_DB_ATTACH_PERSISTENT:
-	  return ctdb_control_db_attach(ctdb, indata, outdata,
-					CTDB_DB_FLAGS_PERSISTENT, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					CTDB_DB_FLAGS_PERSISTENT,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_DB_ATTACH_REPLICATED:
-	  return ctdb_control_db_attach(ctdb, indata, outdata,
-					CTDB_DB_FLAGS_REPLICATED, client_id,
-					c, async_reply);
+	  return ctdb_control_db_attach(ctdb,
+					indata,
+					outdata,
+					CTDB_DB_FLAGS_REPLICATED,
+					srcnode,
+					client_id,
+					c,
+					async_reply);
 
 	case CTDB_CONTROL_SET_CALL:
 		return control_not_implemented("SET_CALL", NULL);
@@ -860,7 +876,7 @@ int ctdb_daemon_send_control(struct ctdb
 		return -1;
 	}
 
-	if (((destnode == CTDB_BROADCAST_VNNMAP) || 
+	if (((destnode == CTDB_BROADCAST_ACTIVE) ||
 	     (destnode == CTDB_BROADCAST_ALL) ||
 	     (destnode == CTDB_BROADCAST_CONNECTED)) && 
 	    !(flags & CTDB_CTRL_FLAG_NOREPLY)) {
@@ -868,7 +884,7 @@ int ctdb_daemon_send_control(struct ctdb
 		return -1;
 	}
 
-	if (destnode != CTDB_BROADCAST_VNNMAP && 
+	if (destnode != CTDB_BROADCAST_ACTIVE &&
 	    destnode != CTDB_BROADCAST_ALL && 
 	    destnode != CTDB_BROADCAST_CONNECTED && 
 	    (!ctdb_validate_pnn(ctdb, destnode) || 
diff -Npur samba-4.8.4/ctdb/server/ctdb_ltdb_server.c samba-4.8.5/ctdb/server/ctdb_ltdb_server.c
--- samba-4.8.4/ctdb/server/ctdb_ltdb_server.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/server/ctdb_ltdb_server.c	2018-08-24 09:58:20.000000000 +0200
@@ -1105,9 +1105,12 @@ int ctdb_process_deferred_attach(struct
 /*
   a client has asked to attach a new database
  */
-int32_t ctdb_control_db_attach(struct ctdb_context *ctdb, TDB_DATA indata,
+int32_t ctdb_control_db_attach(struct ctdb_context *ctdb,
+			       TDB_DATA indata,
 			       TDB_DATA *outdata,
-			       uint8_t db_flags, uint32_t client_id,
+			       uint8_t db_flags,
+			       uint32_t srcnode,
+			       uint32_t client_id,
 			       struct ctdb_req_control_old *c,
 			       bool *async_reply)
 {
@@ -1128,7 +1131,7 @@ int32_t ctdb_control_db_attach(struct ct
 	 * allow all attach from the network since these are always from remote
 	 * recovery daemons.
 	 */
-	if (client_id != 0) {
+	if (srcnode == ctdb->pnn && client_id != 0) {
 		client = reqid_find(ctdb->idr, client_id, struct ctdb_client);
 	}
 	if (client != NULL) {
@@ -1535,9 +1538,15 @@ static void ctdb_ltdb_seqnum_check(struc
 		TDB_DATA data;
 		data.dptr = (uint8_t *)&ctdb_db->db_id;
 		data.dsize = sizeof(uint32_t);
-		ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0,
-					 CTDB_CONTROL_UPDATE_SEQNUM, 0, CTDB_CTRL_FLAG_NOREPLY,
-					 data, NULL, NULL);		
+		ctdb_daemon_send_control(ctdb,
+					 CTDB_BROADCAST_ACTIVE,
+					 0,
+					 CTDB_CONTROL_UPDATE_SEQNUM,
+					 0,
+					 CTDB_CTRL_FLAG_NOREPLY,
+					 data,
+					 NULL,
+					 NULL);
 	}
 	ctdb_db->seqnum = new_seqnum;
 
diff -Npur samba-4.8.4/ctdb/server/ctdb_server.c samba-4.8.5/ctdb/server/ctdb_server.c
--- samba-4.8.4/ctdb/server/ctdb_server.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/server/ctdb_server.c	2018-08-24 09:58:20.000000000 +0200
@@ -394,14 +394,18 @@ static void ctdb_broadcast_packet_all(st
 }
 
 /*
-  broadcast a packet to all nodes in the current vnnmap
+  broadcast a packet to all active nodes
 */
-static void ctdb_broadcast_packet_vnnmap(struct ctdb_context *ctdb, 
+static void ctdb_broadcast_packet_active(struct ctdb_context *ctdb,
 					 struct ctdb_req_header *hdr)
 {
 	int i;
-	for (i=0;i<ctdb->vnn_map->size;i++) {
-		hdr->destnode = ctdb->vnn_map->map[i];
+	for (i = 0; i < ctdb->num_nodes; i++) {
+		if (ctdb->nodes[i]->flags & NODE_FLAGS_INACTIVE) {
+			continue;
+		}
+
+		hdr->destnode = ctdb->nodes[i]->pnn;
 		ctdb_queue_packet(ctdb, hdr);
 	}
 }
@@ -435,8 +439,8 @@ void ctdb_queue_packet(struct ctdb_conte
 	case CTDB_BROADCAST_ALL:
 		ctdb_broadcast_packet_all(ctdb, hdr);
 		return;
-	case CTDB_BROADCAST_VNNMAP:
-		ctdb_broadcast_packet_vnnmap(ctdb, hdr);
+	case CTDB_BROADCAST_ACTIVE:
+		ctdb_broadcast_packet_active(ctdb, hdr);
 		return;
 	case CTDB_BROADCAST_CONNECTED:
 		ctdb_broadcast_packet_connected(ctdb, hdr);
diff -Npur samba-4.8.4/ctdb/server/ctdb_traverse.c samba-4.8.5/ctdb/server/ctdb_traverse.c
--- samba-4.8.4/ctdb/server/ctdb_traverse.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/server/ctdb_traverse.c	2018-08-24 09:58:20.000000000 +0200
@@ -387,8 +387,8 @@ static struct ctdb_traverse_all_handle *
 	}
 
 	if (ctdb_db_volatile(ctdb_db)) {
-		/* normal database, traverse all nodes */	  
-		destination = CTDB_BROADCAST_VNNMAP;
+		/* volatile database, traverse all active nodes */
+		destination = CTDB_BROADCAST_ACTIVE;
 	} else {
 		int i;
 		/* persistent database, traverse one node, preferably
diff -Npur samba-4.8.4/ctdb/server/ipalloc.c samba-4.8.5/ctdb/server/ipalloc.c
--- samba-4.8.4/ctdb/server/ipalloc.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/server/ipalloc.c	2018-08-24 09:58:20.000000000 +0200
@@ -19,11 +19,11 @@
    along with this program; if not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <talloc.h>
-
 #include "replace.h"
 #include "system/network.h"
 
+#include <talloc.h>
+
 #include "lib/util/debug.h"
 
 #include "common/logging.h"
diff -Npur samba-4.8.4/ctdb/tests/scripts/integration.bash samba-4.8.5/ctdb/tests/scripts/integration.bash
--- samba-4.8.4/ctdb/tests/scripts/integration.bash	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tests/scripts/integration.bash	2018-08-24 09:58:20.000000000 +0200
@@ -336,6 +336,7 @@ node_has_status ()
 	(frozen)       fpat='^[[:space:]]+frozen[[:space:]]+1$' ;;
 	(unfrozen)     fpat='^[[:space:]]+frozen[[:space:]]+0$' ;;
 	(recovered)    rpat='^Recovery mode:RECOVERY \(1\)$' ;;
+	(notlmaster)   rpat="^hash:.* lmaster:${pnn}\$" ;;
 	*)
 	    echo "node_has_status: unknown status \"$status\""
 	    return 1
diff -Npur samba-4.8.4/ctdb/tests/simple/79_volatile_db_traverse.sh samba-4.8.5/ctdb/tests/simple/79_volatile_db_traverse.sh
--- samba-4.8.4/ctdb/tests/simple/79_volatile_db_traverse.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/ctdb/tests/simple/79_volatile_db_traverse.sh	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,94 @@
+#!/bin/bash
+
+test_info()
+{
+    cat <<EOF
+Confirm that traverses of volatile databases work as expected
+
+This is a very simple example.  It writes a single record, updates it
+on another node and then confirms that the correct value is found when
+traversing.  It then repeats this after removing the LMASTER role from
+the node where the value is updated.
+
+Expected results:
+
+* The expected records should be found
+
+EOF
+}
+
+. "${TEST_SCRIPTS_DIR}/integration.bash"
+
+ctdb_test_init "$@"
+
+set -e
+
+cluster_is_healthy
+
+# Reset configuration
+ctdb_restart_when_done
+
+#
+# Main test
+#
+TESTDB="traverse_db.tdb"
+
+echo "create volatile test database $TESTDB"
+try_command_on_node 0 $CTDB attach "$TESTDB"
+
+echo "wipe test database $TESTDB"
+try_command_on_node 0 $CTDB wipedb "$TESTDB"
+
+echo "write foo=bar0 on node 0"
+try_command_on_node 0 $CTDB writekey "$TESTDB" "foo" "bar0"
+
+echo "write foo=bar1 on node 1"
+try_command_on_node 1 $CTDB writekey "$TESTDB" "foo" "bar1"
+
+echo "do traverse on node 0"
+try_command_on_node -v 0 $CTDB catdb "$TESTDB"
+
+echo "do traverse on node 1"
+try_command_on_node -v 1 $CTDB catdb "$TESTDB"
+
+cat <<EOF
+
+Again, this time with lmaster role off on node 1
+
+EOF
+
+echo "wipe test database $TESTDB"
+try_command_on_node 0 $CTDB wipedb "$TESTDB"
+
+echo "switching off lmaster role on node 1"
+try_command_on_node 1 $CTDB setlmasterrole off
+
+try_command_on_node -v 1 $CTDB getcapabilities
+
+wait_until_node_has_status 1 notlmaster 10 0
+# Wait for recovery and new VNN map to be pushed
+#sleep_for 10
+
+echo "write foo=bar0 on node 0"
+try_command_on_node 0 $CTDB writekey "$TESTDB" "foo" "bar0"
+
+echo "write foo=bar1 on node 1"
+try_command_on_node 1 $CTDB writekey "$TESTDB" "foo" "bar1"
+
+echo "do traverse on node 0"
+try_command_on_node -v 0 $CTDB catdb "$TESTDB"
+
+num=$(echo "$out" | sed -n -e 's|^Dumped \(.*\) records$|\1|p')
+if [ "$num" = 1 ] ; then
+	echo "OK: There was 1 record"
+else
+	echo "BAD: There were ${num} (!= 1) records"
+	exit 1
+fi
+
+if echo "$out" | grep -q "^data(4) = \"bar1\"\$" ; then
+	echo "OK: Data from node 1 was returned"
+else
+	echo "BAD: Data from node 1 was not returned"
+	exit 1
+fi
diff -Npur samba-4.8.4/ctdb/tests/src/ctdb_takeover_tests.c samba-4.8.5/ctdb/tests/src/ctdb_takeover_tests.c
--- samba-4.8.4/ctdb/tests/src/ctdb_takeover_tests.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/ctdb_takeover_tests.c	2018-08-24 09:58:20.000000000 +0200
@@ -17,12 +17,12 @@
    along with this program; if not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <assert.h>
-#include <talloc.h>
-
 #include "replace.h"
 #include "system/network.h"
 
+#include <assert.h>
+#include <talloc.h>
+
 #include "lib/util/debug.h"
 
 #include "protocol/protocol.h"
@@ -254,6 +254,8 @@ int main(int argc, const char *argv[])
 	int loglevel;
 	const char *debuglevelstr = getenv("CTDB_TEST_LOGLEVEL");
 
+	setup_logging("ctdb_takeover_tests", DEBUG_STDERR);
+
 	if (! debug_level_parse(debuglevelstr, &loglevel)) {
                 loglevel = DEBUG_DEBUG;
         }
diff -Npur samba-4.8.4/ctdb/tests/src/fake_ctdbd.c samba-4.8.5/ctdb/tests/src/fake_ctdbd.c
--- samba-4.8.4/ctdb/tests/src/fake_ctdbd.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fake_ctdbd.c	2018-08-24 09:58:20.000000000 +0200
@@ -40,6 +40,7 @@
 #include "common/logging.h"
 #include "common/tunable.h"
 #include "common/srvid.h"
+#include "common/system.h"
 
 #include "ipalloc_read_known_ips.h"
 
@@ -3050,8 +3051,6 @@ static struct tevent_req *client_send(TA
 {
 	struct tevent_req *req;
 	struct client_state *state;
-	struct ucred cr;
-	socklen_t crl = sizeof(struct ucred);
 	int ret;
 
 	req = tevent_req_create(mem_ctx, &state, struct client_state);
@@ -3064,12 +3063,7 @@ static struct tevent_req *client_send(TA
 	state->ctdb = ctdb;
 	state->pnn = pnn;
 
-	ret = getsockopt(fd, SOL_SOCKET, SO_PEERCRED, &cr, &crl);
-	if (ret != 0) {
-		tevent_req_error(req, ret);
-		return tevent_req_post(req, ev);
-	}
-	state->pid = cr.pid;
+	(void) ctdb_get_peer_pid(fd, &state->pid);
 
 	ret = comm_setup(state, ev, fd, client_read_handler, req,
 			 client_dead_handler, req, &state->comm);
diff -Npur samba-4.8.4/ctdb/tests/src/fetch_loop.c samba-4.8.5/ctdb/tests/src/fetch_loop.c
--- samba-4.8.4/ctdb/tests/src/fetch_loop.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fetch_loop.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -230,6 +231,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/fetch_loop_key.c samba-4.8.5/ctdb/tests/src/fetch_loop_key.c
--- samba-4.8.4/ctdb/tests/src/fetch_loop_key.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fetch_loop_key.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -155,6 +156,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_loop_key", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/fetch_readonly.c samba-4.8.5/ctdb/tests/src/fetch_readonly.c
--- samba-4.8.4/ctdb/tests/src/fetch_readonly.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fetch_readonly.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -107,6 +108,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_readonly", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/fetch_readonly_loop.c samba-4.8.5/ctdb/tests/src/fetch_readonly_loop.c
--- samba-4.8.4/ctdb/tests/src/fetch_readonly_loop.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fetch_readonly_loop.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -214,6 +215,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_readonly_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/fetch_ring.c samba-4.8.5/ctdb/tests/src/fetch_ring.c
--- samba-4.8.4/ctdb/tests/src/fetch_ring.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/fetch_ring.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/time.h"
 #include "lib/util/tevent_unix.h"
 
@@ -331,6 +332,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("fetch_ring", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/g_lock_loop.c samba-4.8.5/ctdb/tests/src/g_lock_loop.c
--- samba-4.8.4/ctdb/tests/src/g_lock_loop.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/g_lock_loop.c	2018-08-24 09:58:20.000000000 +0200
@@ -213,6 +213,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("glock_loop", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
@@ -230,8 +232,6 @@ int main(int argc, const char *argv[])
 		exit(1);
 	}
 
-	setup_logging("glock_loop", DEBUG_STDERR);
-
 	ret = ctdb_client_init(mem_ctx, ev, opts->socket, &client);
 	if (ret != 0) {
 		fprintf(stderr, "Failed to initialize client, ret=%d\n", ret);
diff -Npur samba-4.8.4/ctdb/tests/src/ipalloc_read_known_ips.c samba-4.8.5/ctdb/tests/src/ipalloc_read_known_ips.c
--- samba-4.8.4/ctdb/tests/src/ipalloc_read_known_ips.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/ipalloc_read_known_ips.c	2018-08-24 09:58:20.000000000 +0200
@@ -17,11 +17,11 @@
    along with this program; if not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <talloc.h>
-
 #include "replace.h"
 #include "system/network.h"
 
+#include <talloc.h>
+
 #include "lib/util/debug.h"
 
 #include "protocol/protocol.h"
diff -Npur samba-4.8.4/ctdb/tests/src/message_ring.c samba-4.8.5/ctdb/tests/src/message_ring.c
--- samba-4.8.4/ctdb/tests/src/message_ring.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/message_ring.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/time.h"
 #include "lib/util/tevent_unix.h"
 
@@ -317,6 +318,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("message_ring", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/transaction_loop.c samba-4.8.5/ctdb/tests/src/transaction_loop.c
--- samba-4.8.4/ctdb/tests/src/transaction_loop.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/transaction_loop.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "client/client.h"
@@ -342,6 +343,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("transaction_loop", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/tunnel_test.c samba-4.8.5/ctdb/tests/src/tunnel_test.c
--- samba-4.8.4/ctdb/tests/src/tunnel_test.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/tunnel_test.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "protocol/protocol_private.h"
@@ -429,6 +430,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("tunnel_test", DEBUG_STDERR);
+
 	status = process_options_basic(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/update_record.c samba-4.8.5/ctdb/tests/src/update_record.c
--- samba-4.8.4/ctdb/tests/src/update_record.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/update_record.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "protocol/protocol_api.h"
@@ -177,6 +178,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("update_record", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tests/src/update_record_persistent.c samba-4.8.5/ctdb/tests/src/update_record_persistent.c
--- samba-4.8.4/ctdb/tests/src/update_record_persistent.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/tests/src/update_record_persistent.c	2018-08-24 09:58:20.000000000 +0200
@@ -20,6 +20,7 @@
 #include "replace.h"
 #include "system/network.h"
 
+#include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
 #include "protocol/protocol_api.h"
@@ -153,6 +154,8 @@ int main(int argc, const char *argv[])
 	int ret;
 	bool status;
 
+	setup_logging("update_record_persistene", DEBUG_STDERR);
+
 	status = process_options_database(argc, argv, &opts);
 	if (! status) {
 		exit(1);
diff -Npur samba-4.8.4/ctdb/tools/ctdb_killtcp.c samba-4.8.5/ctdb/tools/ctdb_killtcp.c
--- samba-4.8.4/ctdb/tools/ctdb_killtcp.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/ctdb/tools/ctdb_killtcp.c	2018-08-24 09:58:20.000000000 +0200
@@ -17,12 +17,12 @@
    along with this program; if not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <talloc.h>
-#include <tevent.h>
-
 #include "replace.h"
 #include "system/network.h"
 
+#include <talloc.h>
+#include <tevent.h>
+
 #include "lib/util/debug.h"
 #include "lib/util/tevent_unix.h"
 
diff -Npur samba-4.8.4/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c samba-4.8.5/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c
--- samba-4.8.4/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/utils/ceph/ctdb_mutex_ceph_rados_helper.c	2018-08-24 09:58:20.000000000 +0200
@@ -1,7 +1,7 @@
 /*
    CTDB mutex helper using Ceph librados locks
 
-   Copyright (C) David Disseldorp 2016
+   Copyright (C) David Disseldorp 2016-2018
 
    Based on ctdb_mutex_fcntl_helper.c, which is:
    Copyright (C) Martin Schwenke 2015
@@ -29,6 +29,11 @@
 #define CTDB_MUTEX_CEPH_LOCK_NAME	"ctdb_reclock_mutex"
 #define CTDB_MUTEX_CEPH_LOCK_COOKIE	CTDB_MUTEX_CEPH_LOCK_NAME
 #define CTDB_MUTEX_CEPH_LOCK_DESC	"CTDB recovery lock"
+/*
+ * During failover it may take up to <lock duration> seconds before the
+ * newly elected recovery master can obtain the lock.
+ */
+#define CTDB_MUTEX_CEPH_LOCK_DURATION_SECS_DEFAULT	10
 
 #define CTDB_MUTEX_STATUS_HOLDING "0"
 #define CTDB_MUTEX_STATUS_CONTENDED "1"
@@ -88,24 +93,20 @@ static int ctdb_mutex_rados_ctx_create(c
 	return 0;
 }
 
-static void ctdb_mutex_rados_ctx_destroy(rados_t ceph_cluster,
-					 rados_ioctx_t ioctx)
-{
-	rados_ioctx_destroy(ioctx);
-	rados_shutdown(ceph_cluster);
-}
-
 static int ctdb_mutex_rados_lock(rados_ioctx_t *ioctx,
-				 const char *oid)
+				 const char *oid,
+				 uint64_t lock_duration_s,
+				 uint8_t flags)
 {
 	int ret;
+	struct timeval tv = { lock_duration_s, 0 };
 
 	ret = rados_lock_exclusive(ioctx, oid,
-                                   CTDB_MUTEX_CEPH_LOCK_NAME,
+				   CTDB_MUTEX_CEPH_LOCK_NAME,
 				   CTDB_MUTEX_CEPH_LOCK_COOKIE,
 				   CTDB_MUTEX_CEPH_LOCK_DESC,
-                                   NULL, /* infinite duration */
-                                   0);
+				   lock_duration_s == 0 ? NULL : &tv,
+				   flags);
 	if ((ret == -EEXIST) || (ret == -EBUSY)) {
 		/* lock contention */
 		return ret;
@@ -145,10 +146,13 @@ struct ctdb_mutex_rados_state {
 	const char *ceph_auth_name;
 	const char *pool_name;
 	const char *object;
+	uint64_t lock_duration_s;
 	int ppid;
 	struct tevent_context *ev;
-	struct tevent_signal *sig_ev;
-	struct tevent_timer *timer_ev;
+	struct tevent_signal *sigterm_ev;
+	struct tevent_signal *sigint_ev;
+	struct tevent_timer *ppid_timer_ev;
+	struct tevent_timer *renew_timer_ev;
 	rados_t ceph_cluster;
 	rados_ioctx_t ioctx;
 };
@@ -161,29 +165,24 @@ static void ctdb_mutex_rados_sigterm_cb(
 					void *private_data)
 {
 	struct ctdb_mutex_rados_state *cmr_state = private_data;
-	int ret;
+	int ret = 0;
 
 	if (!cmr_state->holding_mutex) {
 		fprintf(stderr, "Sigterm callback invoked without mutex!\n");
 		ret = -EINVAL;
-		goto err_ctx_cleanup;
 	}
 
-	ret = ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
-err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
 	talloc_free(cmr_state);
 	exit(ret ? 1 : 0);
 }
 
-static void ctdb_mutex_rados_timer_cb(struct tevent_context *ev,
-				      struct tevent_timer *te,
-				      struct timeval current_time,
-				      void *private_data)
+static void ctdb_mutex_rados_ppid_timer_cb(struct tevent_context *ev,
+					   struct tevent_timer *te,
+					   struct timeval current_time,
+					   void *private_data)
 {
 	struct ctdb_mutex_rados_state *cmr_state = private_data;
-	int ret;
+	int ret = 0;
 
 	if (!cmr_state->holding_mutex) {
 		fprintf(stderr, "Timer callback invoked without mutex!\n");
@@ -193,26 +192,81 @@ static void ctdb_mutex_rados_timer_cb(st
 
 	if ((kill(cmr_state->ppid, 0) == 0) || (errno != ESRCH)) {
 		/* parent still around, keep waiting */
-		cmr_state->timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
+		cmr_state->ppid_timer_ev = tevent_add_timer(cmr_state->ev,
+							    cmr_state,
 					       tevent_timeval_current_ofs(5, 0),
-						      ctdb_mutex_rados_timer_cb,
-						       cmr_state);
-		if (cmr_state->timer_ev == NULL) {
+						ctdb_mutex_rados_ppid_timer_cb,
+							    cmr_state);
+		if (cmr_state->ppid_timer_ev == NULL) {
 			fprintf(stderr, "Failed to create timer event\n");
 			/* rely on signal cb */
 		}
 		return;
 	}
 
-	/* parent ended, drop lock and exit */
-	ret = ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
+	/* parent ended, drop lock (via destructor) and exit */
 err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
 	talloc_free(cmr_state);
 	exit(ret ? 1 : 0);
 }
 
+#define USECS_IN_SEC 1000000
+
+static void ctdb_mutex_rados_lock_renew_timer_cb(struct tevent_context *ev,
+						 struct tevent_timer *te,
+						 struct timeval current_time,
+						 void *private_data)
+{
+	struct ctdb_mutex_rados_state *cmr_state = private_data;
+	struct timeval tv;
+	int ret;
+
+	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object,
+				    cmr_state->lock_duration_s,
+				    LIBRADOS_LOCK_FLAG_RENEW);
+	if (ret == -EBUSY) {
+		/* should never get -EEXIST on renewal */
+		fprintf(stderr, "Lock contention during renew: %d\n", ret);
+		goto err_ctx_cleanup;
+	} else if (ret < 0) {
+		fprintf(stderr, "Lock renew failed\n");
+		goto err_ctx_cleanup;
+	}
+
+	tv = tevent_timeval_current_ofs(0,
+			    cmr_state->lock_duration_s * (USECS_IN_SEC / 2));
+	cmr_state->renew_timer_ev = tevent_add_timer(cmr_state->ev,
+						       cmr_state,
+						       tv,
+					ctdb_mutex_rados_lock_renew_timer_cb,
+						       cmr_state);
+	if (cmr_state->renew_timer_ev == NULL) {
+		fprintf(stderr, "Failed to create timer event\n");
+		goto err_ctx_cleanup;
+	}
+
+	return;
+
+err_ctx_cleanup:
+	/* drop lock (via destructor) and exit */
+	talloc_free(cmr_state);
+	exit(1);
+}
+
+static int ctdb_mutex_rados_state_destroy(struct ctdb_mutex_rados_state *cmr_state)
+{
+	if (cmr_state->holding_mutex) {
+		ctdb_mutex_rados_unlock(cmr_state->ioctx, cmr_state->object);
+	}
+	if (cmr_state->ioctx != NULL) {
+		rados_ioctx_destroy(cmr_state->ioctx);
+	}
+	if (cmr_state->ceph_cluster != NULL) {
+		rados_shutdown(cmr_state->ceph_cluster);
+	}
+	return 0;
+}
+
 int main(int argc, char *argv[])
 {
 	int ret;
@@ -220,9 +274,10 @@ int main(int argc, char *argv[])
 
 	progname = argv[0];
 
-	if (argc != 5) {
+	if ((argc != 5) && (argc != 6)) {
 		fprintf(stderr, "Usage: %s <Ceph Cluster> <Ceph user> "
-				"<RADOS pool> <RADOS object>\n",
+				"<RADOS pool> <RADOS object> "
+				"[lock duration secs]\n",
 			progname);
 		ret = -EINVAL;
 		goto err_out;
@@ -240,10 +295,24 @@ int main(int argc, char *argv[])
 		goto err_out;
 	}
 
+	talloc_set_destructor(cmr_state, ctdb_mutex_rados_state_destroy);
 	cmr_state->ceph_cluster_name = argv[1];
 	cmr_state->ceph_auth_name = argv[2];
 	cmr_state->pool_name = argv[3];
 	cmr_state->object = argv[4];
+	if (argc == 6) {
+		/* optional lock duration provided */
+		char *endptr = NULL;
+		cmr_state->lock_duration_s = strtoull(argv[5], &endptr, 0);
+		if ((endptr == argv[5]) || (*endptr != '\0')) {
+			fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+			ret = -EINVAL;
+			goto err_ctx_cleanup;
+		}
+	} else {
+		cmr_state->lock_duration_s
+			= CTDB_MUTEX_CEPH_LOCK_DURATION_SECS_DEFAULT;
+	}
 
 	cmr_state->ppid = getppid();
 	if (cmr_state->ppid == 1) {
@@ -257,7 +326,7 @@ int main(int argc, char *argv[])
 		 */
 		fprintf(stderr, "%s: PPID == 1\n", progname);
 		ret = -EPIPE;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	cmr_state->ev = tevent_context_init(cmr_state);
@@ -265,30 +334,40 @@ int main(int argc, char *argv[])
 		fprintf(stderr, "tevent_context_init failed\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	/* wait for sigterm */
-	cmr_state->sig_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGTERM, 0,
+	cmr_state->sigterm_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGTERM, 0,
 					      ctdb_mutex_rados_sigterm_cb,
 					      cmr_state);
-	if (cmr_state->sig_ev == NULL) {
-		fprintf(stderr, "Failed to create signal event\n");
+	if (cmr_state->sigterm_ev == NULL) {
+		fprintf(stderr, "Failed to create term signal event\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
+	}
+
+	cmr_state->sigint_ev = tevent_add_signal(cmr_state->ev, cmr_state, SIGINT, 0,
+					      ctdb_mutex_rados_sigterm_cb,
+					      cmr_state);
+	if (cmr_state->sigint_ev == NULL) {
+		fprintf(stderr, "Failed to create int signal event\n");
+		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+		ret = -ENOMEM;
+		goto err_ctx_cleanup;
 	}
 
 	/* periodically check parent */
-	cmr_state->timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
+	cmr_state->ppid_timer_ev = tevent_add_timer(cmr_state->ev, cmr_state,
 					       tevent_timeval_current_ofs(5, 0),
-					       ctdb_mutex_rados_timer_cb,
+					       ctdb_mutex_rados_ppid_timer_cb,
 					       cmr_state);
-	if (cmr_state->timer_ev == NULL) {
+	if (cmr_state->ppid_timer_ev == NULL) {
 		fprintf(stderr, "Failed to create timer event\n");
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		ret = -ENOMEM;
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
 	ret = ctdb_mutex_rados_ctx_create(cmr_state->ceph_cluster_name,
@@ -298,10 +377,12 @@ int main(int argc, char *argv[])
 					  &cmr_state->ioctx);
 	if (ret < 0) {
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
-		goto err_state_free;
+		goto err_ctx_cleanup;
 	}
 
-	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object);
+	ret = ctdb_mutex_rados_lock(cmr_state->ioctx, cmr_state->object,
+				    cmr_state->lock_duration_s,
+				    0);
 	if ((ret == -EEXIST) || (ret == -EBUSY)) {
 		fprintf(stdout, CTDB_MUTEX_STATUS_CONTENDED);
 		goto err_ctx_cleanup;
@@ -309,8 +390,28 @@ int main(int argc, char *argv[])
 		fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
 		goto err_ctx_cleanup;
 	}
-
 	cmr_state->holding_mutex = true;
+
+	if (cmr_state->lock_duration_s != 0) {
+		/*
+		 * renew (reobtain) the lock, using a period of half the lock
+		 * duration. Convert to usecs to avoid rounding.
+		 */
+		struct timeval tv = tevent_timeval_current_ofs(0,
+			       cmr_state->lock_duration_s * (USECS_IN_SEC / 2));
+		cmr_state->renew_timer_ev = tevent_add_timer(cmr_state->ev,
+							       cmr_state,
+							       tv,
+					ctdb_mutex_rados_lock_renew_timer_cb,
+							       cmr_state);
+		if (cmr_state->renew_timer_ev == NULL) {
+			fprintf(stderr, "Failed to create timer event\n");
+			fprintf(stdout, CTDB_MUTEX_STATUS_ERROR);
+			ret = -ENOMEM;
+			goto err_ctx_cleanup;
+		}
+	}
+
 	fprintf(stdout, CTDB_MUTEX_STATUS_HOLDING);
 
 	/* wait for the signal / timer events to do their work */
@@ -319,9 +420,6 @@ int main(int argc, char *argv[])
 		goto err_ctx_cleanup;
 	}
 err_ctx_cleanup:
-	ctdb_mutex_rados_ctx_destroy(cmr_state->ceph_cluster,
-				     cmr_state->ioctx);
-err_state_free:
 	talloc_free(cmr_state);
 err_out:
 	return ret ? 1 : 0;
diff -Npur samba-4.8.4/ctdb/utils/ceph/test_ceph_rados_reclock.sh samba-4.8.5/ctdb/utils/ceph/test_ceph_rados_reclock.sh
--- samba-4.8.4/ctdb/utils/ceph/test_ceph_rados_reclock.sh	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/utils/ceph/test_ceph_rados_reclock.sh	2018-08-24 09:58:20.000000000 +0200
@@ -46,7 +46,9 @@ which ctdb_mutex_ceph_rados_helper || ex
 TMP_DIR="$(mktemp --directory)" || exit 1
 rados -p "$POOL" rm "$OBJECT"
 
-(ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" \
+# explicitly disable lock expiry (duration=0), to ensure that we don't get
+# intermittent failures (due to renewal) from the lock state diff further down
+(ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" 0 \
 							> ${TMP_DIR}/first) &
 locker_pid=$!
 
@@ -78,6 +80,9 @@ LOCKER_COOKIE="$(jq -r '.lockers[0].cook
 LOCKER_DESC="$(jq -r '.lockers[0].description' ${TMP_DIR}/lock_state_first)"
 [ "$LOCKER_DESC" == "CTDB recovery lock" ] \
 	|| _fail "unexpected locker description: $LOCKER_DESC"
+LOCKER_EXP="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_first)"
+[ "$LOCKER_EXP" == "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP"
 
 # second attempt while first is still holding the lock - expect failure
 ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" "$POOL" "$OBJECT" \
@@ -145,6 +150,56 @@ third_out=$(cat ${TMP_DIR}/third)
 [ "$third_out" == "0" ] \
 	|| _fail "expected lock acquisition (0), but got $third_out"
 
+# test renew / expire behaviour using a 1s expiry (update period = 500ms)
+exec >${TMP_DIR}/forth -- ctdb_mutex_ceph_rados_helper "$CLUSTER" "$USER" \
+							"$POOL" "$OBJECT" 1 &
+locker_pid=$!
+
+sleep 1
+
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_fifth_a
+#echo "with lock fifth: `cat ${TMP_DIR}/lock_state_fifth_a`"
+
+LOCK_NAME="$(jq -r '.name' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCK_NAME" == "ctdb_reclock_mutex" ] \
+	|| _fail "unexpected lock name: $LOCK_NAME"
+LOCK_TYPE="$(jq -r '.type' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCK_TYPE" == "exclusive" ] \
+	|| _fail "unexpected lock type: $LOCK_TYPE"
+LOCK_COUNT="$(jq -r '.lockers | length' ${TMP_DIR}/lock_state_fifth_a)"
+[ $LOCK_COUNT -eq 1 ] || _fail "expected 1 lock in rados state, got $LOCK_COUNT"
+LOCKER_EXP_A="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_fifth_a)"
+[ "$LOCKER_EXP_A" != "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP_A"
+sleep 1 # sleep until renewal
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_fifth_b
+LOCKER_EXP_B="$(jq -r '.lockers[0].expiration' ${TMP_DIR}/lock_state_fifth_b)"
+[ "$LOCKER_EXP_B" != "0.000000" ] \
+	|| _fail "unexpected locker expiration: $LOCKER_EXP_B"
+#echo "lock expiration before renewal $LOCKER_EXP_A, after renewal $LOCKER_EXP_B"
+[ "$LOCKER_EXP_B" != "$LOCKER_EXP_A" ] \
+	|| _fail "locker expiration matches: $LOCKER_EXP_B"
+
+# no chance to drop the lock, rely on expiry
+kill -KILL $locker_pid || exit 1
+wait $locker_pid &> /dev/null
+sleep 1	# sleep until lock expiry
+
+rados -p "$POOL" lock info "$OBJECT" ctdb_reclock_mutex \
+						> ${TMP_DIR}/lock_state_sixth
+#echo "lock expiry sixth: `cat ${TMP_DIR}/lock_state_sixth`"
+
+LOCK_NAME="$(jq -r '.name' ${TMP_DIR}/lock_state_sixth)"
+[ "$LOCK_NAME" == "ctdb_reclock_mutex" ] \
+	|| _fail "unexpected lock name: $LOCK_NAME"
+LOCK_TYPE="$(jq -r '.type' ${TMP_DIR}/lock_state_sixth)"
+[ "$LOCK_TYPE" == "exclusive" ] \
+	|| _fail "unexpected lock type: $LOCK_TYPE"
+LOCK_COUNT="$(jq -r '.lockers | length' ${TMP_DIR}/lock_state_sixth)"
+[ $LOCK_COUNT -eq 0 ] || _fail "expected 0 locks in rados state, got $LOCK_COUNT"
+
 rm ${TMP_DIR}/*
 rmdir $TMP_DIR
 
diff -Npur samba-4.8.4/ctdb/utils/pmda/pmda_ctdb.c samba-4.8.5/ctdb/utils/pmda/pmda_ctdb.c
--- samba-4.8.4/ctdb/utils/pmda/pmda_ctdb.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/ctdb/utils/pmda/pmda_ctdb.c	2018-08-24 09:58:20.000000000 +0200
@@ -33,9 +33,17 @@
 #include "client/client_sync.h"
 
 #include <pcp/pmapi.h>
-#include <pcp/impl.h>
 #include <pcp/pmda.h>
 
+#ifdef HAVE___PMID_INT
+#include <pcp/impl.h>
+
+#define pmID_cluster(id)	id->cluster
+#define pmID_item(id)		id->item
+#define pmGetProgname()		pmProgname
+#define pmSetProgname(a)	__pmSetProgname(a)
+#endif
+
 #include "domain.h"
 
 /*
@@ -386,7 +394,11 @@ static int
 pmda_ctdb_fetch_cb(pmdaMetric *mdesc, unsigned int inst, pmAtomValue *atom)
 {
 	int ret;
+#ifdef HAVE___PMID_INT
 	__pmID_int *id = (__pmID_int *)&(mdesc->m_desc.pmid);
+#else
+	pmID id = *(pmID *)&(mdesc->m_desc.pmid);
+#endif
 
 	if (inst != PM_IN_NULL) {
 		return PM_ERR_INST;
@@ -399,27 +411,27 @@ pmda_ctdb_fetch_cb(pmdaMetric *mdesc, un
 	}
 
 
-	switch (id->cluster) {
+	switch (pmID_cluster(id)) {
 	case 0:
-		ret = fill_base(id->item, atom);
+		ret = fill_base(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 1:
-		ret = fill_node(id->item, atom);
+		ret = fill_node(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 2:
-		ret = fill_client(id->item, atom);
+		ret = fill_client(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
 		break;
 	case 3:
-		ret = fill_timeout(id->item, atom);
+		ret = fill_timeout(pmID_item(id), atom);
 		if (ret) {
 			goto err_out;
 		}
@@ -502,7 +514,7 @@ helpfile(void)
 static void
 usage(void)
 {
-	fprintf(stderr, "Usage: %s [options]\n\n", pmProgname);
+	fprintf(stderr, "Usage: %s [options]\n\n", pmGetProgname());
 	fputs("Options:\n"
 	  "  -d domain        use domain (numeric) for metrics domain of PMDA\n"
 	  "  -l logfile       write log into logfile rather than using default log name\n"
@@ -524,9 +536,9 @@ main(int argc, char **argv)
 	char log_file[] = "pmda_ctdb.log";
 	pmdaInterface dispatch;
 
-	__pmSetProgname(argv[0]);
+	pmSetProgname(argv[0]);
 
-	pmdaDaemon(&dispatch, PMDA_INTERFACE_2, pmProgname, CTDB,
+	pmdaDaemon(&dispatch, PMDA_INTERFACE_2, argv[0], CTDB,
 		   log_file, helpfile());
 
 	if (pmdaGetOpt(argc, argv, "d:i:l:pu:?", &dispatch, &err) != EOF) {
diff -Npur samba-4.8.4/ctdb/wscript samba-4.8.5/ctdb/wscript
--- samba-4.8.4/ctdb/wscript	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.5/ctdb/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -83,6 +83,10 @@ def set_options(opt):
     opt.add_option('--enable-etcd-reclock',
                    help=("Enable etcd recovery lock helper (default=no)"),
                    action="store_true", dest='ctdb_etcd_reclock', default=False)
+
+    opt.add_option('--with-libcephfs',
+                   help=("Directory under which libcephfs is installed"),
+                   action="store", dest='libcephfs_dir', default=None)
     opt.add_option('--enable-ceph-reclock',
                    help=("Enable Ceph CTDB recovery lock helper (default=no)"),
                    action="store_true", dest='ctdb_ceph_reclock', default=False)
@@ -175,6 +179,7 @@ def configure(conf):
         if not conf.CHECK_FUNCS_IN('pmdaDaemon', 'pcp_pmda'):
             pmda_support = False
         if pmda_support:
+            conf.CHECK_TYPE_IN('__pmID_int', 'pcp/pmapi.h pcp/impl.h')
             have_pmda = True
         else:
             Logs.error("PMDA support not available")
@@ -218,8 +223,16 @@ def configure(conf):
     conf.env.etcd_reclock = have_etcd_reclock
 
     if Options.options.ctdb_ceph_reclock:
+        # Use custom libcephfs library path if provided. XXX The top level build
+        # explicitly sets LIBPATH_CEPH-COMMON when libcephfs_dir isn't provided.
+        if Options.options.libcephfs_dir:
+            conf.env['CPPPATH_RADOS'] = Options.options.libcephfs_dir + '/include'
+            conf.env['LIBPATH_RADOS'] = Options.options.libcephfs_dir + '/lib'
+            conf.env['LIBPATH_CEPH-COMMON'] = conf.env['LIBPATH_RADOS'] + '/ceph'
+
         if (conf.CHECK_HEADERS('rados/librados.h', False, False, 'rados') and
 					conf.CHECK_LIB('rados', shlib=True)):
+            conf.CHECK_LIB('ceph-common', shlib=True)
             Logs.info('Building with Ceph librados recovery lock support')
             conf.define('HAVE_LIBRADOS', 1)
         else:
@@ -592,7 +605,7 @@ def build(bld):
     if bld.env.HAVE_LIBRADOS:
         bld.SAMBA_BINARY('ctdb_mutex_ceph_rados_helper',
                          source='utils/ceph/ctdb_mutex_ceph_rados_helper.c',
-			 deps='talloc tevent rados',
+			 deps='talloc tevent rados ceph-common',
 			 includes='include',
 			 install_path='${CTDB_HELPER_BINDIR}')
 
@@ -815,7 +828,7 @@ def build(bld):
                         source=bld.SUBDIR('tests/src',
                                           'cluster_wait.c test_options.c'),
                         includes='include',
-                        deps='replace popt talloc tevent tdb')
+                        deps='samba-util replace popt talloc tevent tdb')
 
     # Test binaries
     ctdb_tests = [
diff -Npur samba-4.8.4/docs/manpages/cifsdd.8 samba-4.8.5/docs/manpages/cifsdd.8
--- samba-4.8.4/docs/manpages/cifsdd.8	2018-08-11 08:18:32.000000000 +0200
+++ samba-4.8.5/docs/manpages/cifsdd.8	2018-08-24 10:19:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "CIFSDD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/dbwrap_tool.1 samba-4.8.5/docs/manpages/dbwrap_tool.1
--- samba-4.8.4/docs/manpages/dbwrap_tool.1	2018-08-11 08:18:32.000000000 +0200
+++ samba-4.8.5/docs/manpages/dbwrap_tool.1	2018-08-24 10:19:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -301,7 +301,7 @@ dbwrap_tool
 Use with caution!
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/eventlogadm.8 samba-4.8.5/docs/manpages/eventlogadm.8
--- samba-4.8.4/docs/manpages/eventlogadm.8	2018-08-11 08:18:32.000000000 +0200
+++ samba-4.8.5/docs/manpages/eventlogadm.8	2018-08-24 10:19:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "EVENTLOGADM" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -339,7 +339,7 @@ Filter messages from the system log into
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/findsmb.1 samba-4.8.5/docs/manpages/findsmb.1
--- samba-4.8.4/docs/manpages/findsmb.1	2018-08-11 08:18:32.000000000 +0200
+++ samba-4.8.5/docs/manpages/findsmb.1	2018-08-24 10:19:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "FINDSMB" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -119,7 +119,7 @@ IP ADDR         NETBIOS NAME   WORKGROUP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/idmap_ad.8 samba-4.8.5/docs/manpages/idmap_ad.8
--- samba-4.8.4/docs/manpages/idmap_ad.8	2018-08-11 08:18:33.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_ad.8	2018-08-24 10:19:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_AD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_autorid.8 samba-4.8.5/docs/manpages/idmap_autorid.8
--- samba-4.8.4/docs/manpages/idmap_autorid.8	2018-08-11 08:18:33.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_autorid.8	2018-08-24 10:19:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_hash.8 samba-4.8.5/docs/manpages/idmap_hash.8
--- samba-4.8.4/docs/manpages/idmap_hash.8	2018-08-11 08:18:33.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_hash.8	2018-08-24 10:19:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_HASH" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_ldap.8 samba-4.8.5/docs/manpages/idmap_ldap.8
--- samba-4.8.4/docs/manpages/idmap_ldap.8	2018-08-11 08:18:33.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_ldap.8	2018-08-24 10:19:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_nss.8 samba-4.8.5/docs/manpages/idmap_nss.8
--- samba-4.8.4/docs/manpages/idmap_nss.8	2018-08-11 08:18:34.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_nss.8	2018-08-24 10:19:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_NSS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_rfc2307.8 samba-4.8.5/docs/manpages/idmap_rfc2307.8
--- samba-4.8.4/docs/manpages/idmap_rfc2307.8	2018-08-11 08:18:34.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_rfc2307.8	2018-08-24 10:19:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_rid.8 samba-4.8.5/docs/manpages/idmap_rid.8
--- samba-4.8.4/docs/manpages/idmap_rid.8	2018-08-11 08:18:34.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_rid.8	2018-08-24 10:19:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_RID" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_script.8 samba-4.8.5/docs/manpages/idmap_script.8
--- samba-4.8.4/docs/manpages/idmap_script.8	2018-08-11 08:18:34.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_script.8	2018-08-24 10:19:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_tdb.8 samba-4.8.5/docs/manpages/idmap_tdb.8
--- samba-4.8.4/docs/manpages/idmap_tdb.8	2018-08-11 08:18:34.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_tdb.8	2018-08-24 10:19:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_TDB" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/idmap_tdb2.8 samba-4.8.5/docs/manpages/idmap_tdb2.8
--- samba-4.8.4/docs/manpages/idmap_tdb2.8	2018-08-11 08:18:35.000000000 +0200
+++ samba-4.8.5/docs/manpages/idmap_tdb2.8	2018-08-24 10:19:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/libsmbclient.7 samba-4.8.5/docs/manpages/libsmbclient.7
--- samba-4.8.4/docs/manpages/libsmbclient.7	2018-08-11 08:18:35.000000000 +0200
+++ samba-4.8.5/docs/manpages/libsmbclient.7	2018-08-24 10:19:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: 7
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "08/11/2018" "Samba 4\&.8\&.4" "7"
+.TH "LIBSMBCLIENT" "7" "08/24/2018" "Samba 4\&.8\&.5" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ parameter was not included in the URL\&.
 Watch this space for future updates\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/lmhosts.5 samba-4.8.5/docs/manpages/lmhosts.5
--- samba-4.8.4/docs/manpages/lmhosts.5	2018-08-11 08:18:35.000000000 +0200
+++ samba-4.8.5/docs/manpages/lmhosts.5	2018-08-24 10:19:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "08/11/2018" "Samba 4\&.8\&.4" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "08/24/2018" "Samba 4\&.8\&.5" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ or
 /usr/local/samba/lib\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbclient\fR(1),
diff -Npur samba-4.8.4/docs/manpages/log2pcap.1 samba-4.8.5/docs/manpages/log2pcap.1
--- samba-4.8.4/docs/manpages/log2pcap.1	2018-08-11 08:18:35.000000000 +0200
+++ samba-4.8.5/docs/manpages/log2pcap.1	2018-08-24 10:19:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "LOG2PCAP" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -107,7 +107,7 @@ Convert to pcap using text2pcap:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "BUGS"
 .PP
 Only SMB data is extracted from the samba logs, no LDAP, NetBIOS lookup or other data\&.
diff -Npur samba-4.8.4/docs/manpages/mvxattr.1 samba-4.8.5/docs/manpages/mvxattr.1
--- samba-4.8.4/docs/manpages/mvxattr.1	2018-08-11 08:18:35.000000000 +0200
+++ samba-4.8.5/docs/manpages/mvxattr.1	2018-08-24 10:19:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "MVXATTR" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Force overwriting of destination xattr\&
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/net.8 samba-4.8.5/docs/manpages/net.8
--- samba-4.8.4/docs/manpages/net.8	2018-08-11 08:18:36.000000000 +0200
+++ samba-4.8.5/docs/manpages/net.8	2018-08-24 10:19:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "NET" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "NET" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/nmbd.8 samba-4.8.5/docs/manpages/nmbd.8
--- samba-4.8.4/docs/manpages/nmbd.8	2018-08-11 08:18:36.000000000 +0200
+++ samba-4.8.5/docs/manpages/nmbd.8	2018-08-24 10:19:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "NMBD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -278,7 +278,7 @@ The debug log level of nmbd may be raise
 (SIGUSR[1|2] signals are no longer used since Samba 2\&.2)\&. This is to allow transient problems to be diagnosed, whilst still running at a normally low log level\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBinetd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/nmblookup.1 samba-4.8.5/docs/manpages/nmblookup.1
--- samba-4.8.4/docs/manpages/nmblookup.1	2018-08-11 08:18:36.000000000 +0200
+++ samba-4.8.5/docs/manpages/nmblookup.1	2018-08-24 10:19:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "NMBLOOKUP" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -214,7 +214,7 @@ nmblookup \-U samba\&.org \-R \*(AqIRIX#
 would query the WINS server samba\&.org for the domain master browser (1B name type) for the IRIX workgroup\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/ntlm_auth.1 samba-4.8.5/docs/manpages/ntlm_auth.1
--- samba-4.8.4/docs/manpages/ntlm_auth.1	2018-08-11 08:18:36.000000000 +0200
+++ samba-4.8.5/docs/manpages/ntlm_auth.1	2018-08-24 10:19:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "NTLM_AUTH" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -421,7 +421,7 @@ If you\*(Aqre experiencing problems with
 the Microsoft Knowledge Base article #239869 and follow instructions described there\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/pam_winbind.8 samba-4.8.5/docs/manpages/pam_winbind.8
--- samba-4.8.4/docs/manpages/pam_winbind.8	2018-08-11 08:18:37.000000000 +0200
+++ samba-4.8.5/docs/manpages/pam_winbind.8	2018-08-24 10:19:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: 8
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "08/11/2018" "Samba 4\&.8\&.4" "8"
+.TH "PAM_WINBIND" "8" "08/24/2018" "Samba 4\&.8\&.5" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -172,7 +172,7 @@ This is the profile path set in the prof
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of Samba\&.
+This man page is part of version 4\&.8\&.5 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/pam_winbind.conf.5 samba-4.8.5/docs/manpages/pam_winbind.conf.5
--- samba-4.8.4/docs/manpages/pam_winbind.conf.5	2018-08-11 08:18:37.000000000 +0200
+++ samba-4.8.5/docs/manpages/pam_winbind.conf.5	2018-08-24 10:19:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: 5
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "08/11/2018" "Samba 4\&.8\&.4" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "08/24/2018" "Samba 4\&.8\&.5" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -137,7 +137,7 @@ Defines number of days before pam_winbin
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of Samba\&.
+This man page is part of version 4\&.8\&.5 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/pdbedit.8 samba-4.8.5/docs/manpages/pdbedit.8
--- samba-4.8.4/docs/manpages/pdbedit.8	2018-08-11 08:18:37.000000000 +0200
+++ samba-4.8.5/docs/manpages/pdbedit.8	2018-08-24 10:19:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "PDBEDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -619,7 +619,7 @@ option "<name>" to value "<value>" from
 This command may be used only by root\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.4/docs/manpages/profiles.1 samba-4.8.5/docs/manpages/profiles.1
--- samba-4.8.4/docs/manpages/profiles.1	2018-08-11 08:18:37.000000000 +0200
+++ samba-4.8.5/docs/manpages/profiles.1	2018-08-24 10:19:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "PROFILES" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/rpcclient.1 samba-4.8.5/docs/manpages/rpcclient.1
--- samba-4.8.4/docs/manpages/rpcclient.1	2018-08-11 08:18:37.000000000 +0200
+++ samba-4.8.5/docs/manpages/rpcclient.1	2018-08-24 10:19:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "RPCCLIENT" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -803,7 +803,7 @@ and
 that are incompatible for some commands or services\&. Additionally, the developers are sending reports to Microsoft, and problems found or reported to Microsoft are fixed in Service Packs, which may result in incompatibilities\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/samba-regedit.8 samba-4.8.5/docs/manpages/samba-regedit.8
--- samba-4.8.4/docs/manpages/samba-regedit.8	2018-08-11 08:18:38.000000000 +0200
+++ samba-4.8.5/docs/manpages/samba-regedit.8	2018-08-24 10:19:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -207,7 +207,7 @@ The supplied password is the NT hash\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/samba-tool.8 samba-4.8.5/docs/manpages/samba-tool.8
--- samba-4.8.4/docs/manpages/samba-tool.8	2018-08-11 08:18:38.000000000 +0200
+++ samba-4.8.5/docs/manpages/samba-tool.8	2018-08-24 10:19:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -470,7 +470,7 @@ because the repsFrom/To objects are not
 Gives usage information\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.4 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/samba.7 samba-4.8.5/docs/manpages/samba.7
--- samba-4.8.4/docs/manpages/samba.7	2018-08-11 08:18:38.000000000 +0200
+++ samba-4.8.5/docs/manpages/samba.7	2018-08-24 10:19:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: Miscellanea
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "08/11/2018" "Samba 4\&.8\&.4" "Miscellanea"
+.TH "SAMBA" "7" "08/24/2018" "Samba 4\&.8\&.5" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -237,7 +237,7 @@ https://lists\&.samba\&.org
 you can find a lot of information in the archives and you can subscribe to the samba list and ask for help or discuss things\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "CONTRIBUTIONS"
 .PP
 If you wish to contribute to the Samba project, then I suggest you join the Samba mailing list at
diff -Npur samba-4.8.4/docs/manpages/samba.8 samba-4.8.5/docs/manpages/samba.8
--- samba-4.8.4/docs/manpages/samba.8	2018-08-11 08:18:38.000000000 +0200
+++ samba-4.8.5/docs/manpages/samba.8	2018-08-24 10:19:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SAMBA" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -198,7 +198,7 @@ The number and nature of diagnostics ava
 Most messages are reasonably self\-explanatory\&. Unfortunately, at the time this man page was created, there are too many diagnostics available in the source code to warrant describing each and every diagnostic\&. At this stage your best bet is still to grep the source code and inspect the conditions that gave rise to the diagnostics you are seeing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBhosts_access\fR(5)
diff -Npur samba-4.8.4/docs/manpages/sharesec.1 samba-4.8.5/docs/manpages/sharesec.1
--- samba-4.8.4/docs/manpages/sharesec.1	2018-08-11 08:18:39.000000000 +0200
+++ samba-4.8.5/docs/manpages/sharesec.1	2018-08-24 10:19:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SHARESEC" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -337,7 +337,7 @@ List all ACEs for
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/smb.conf.5 samba-4.8.5/docs/manpages/smb.conf.5
--- samba-4.8.4/docs/manpages/smb.conf.5	2018-08-11 08:18:40.000000000 +0200
+++ samba-4.8.5/docs/manpages/smb.conf.5	2018-08-24 10:19:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "08/11/2018" "Samba 4\&.8\&.4" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "08/24/2018" "Samba 4\&.8\&.5" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -12953,7 +12953,7 @@ and
 special sections make life for an administrator easy, but the various combinations of default attributes can be tricky\&. Take extreme care when designing these sections\&. In particular, ensure that the permissions on spool directories are correct\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsamba\fR(7),
diff -Npur samba-4.8.4/docs/manpages/smbcacls.1 samba-4.8.5/docs/manpages/smbcacls.1
--- samba-4.8.4/docs/manpages/smbcacls.1	2018-08-11 08:18:40.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbcacls.1	2018-08-24 10:19:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBCACLS" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -491,7 +491,7 @@ smbcacls
 couldn\*(Aqt connect to the specified server, or there was an error getting or setting the ACLs, an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/smbclient.1 samba-4.8.5/docs/manpages/smbclient.1
--- samba-4.8.4/docs/manpages/smbclient.1	2018-08-11 08:18:41.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbclient.1	2018-08-24 10:19:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBCLIENT" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -1151,7 +1151,7 @@ Most diagnostics issued by the client ar
 The number and nature of diagnostics available depends on the debug level used by the client\&. If you have problems, set the debug level to 3 and peruse the log files\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/smbcontrol.1 samba-4.8.5/docs/manpages/smbcontrol.1
--- samba-4.8.4/docs/manpages/smbcontrol.1	2018-08-11 08:18:41.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbcontrol.1	2018-08-24 10:19:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBCONTROL" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -309,7 +309,7 @@ Query the number of smbd child processes
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8)
diff -Npur samba-4.8.4/docs/manpages/smbcquotas.1 samba-4.8.5/docs/manpages/smbcquotas.1
--- samba-4.8.4/docs/manpages/smbcquotas.1	2018-08-11 08:18:41.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbcquotas.1	2018-08-24 10:19:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBCQUOTAS" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -247,7 +247,7 @@ smbcquotas
 couldn\*(Aqt connect to the specified server, or when there was an error getting or setting the quota(s), an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/smbd.8 samba-4.8.5/docs/manpages/smbd.8
--- samba-4.8.4/docs/manpages/smbd.8	2018-08-11 08:18:41.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbd.8	2018-08-24 10:19:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SMBD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -252,7 +252,7 @@ parameter\&. When this is set, the follo
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "DIAGNOSTICS"
 .PP
 Most diagnostics issued by the server are logged in a specified log file\&. The log file name is specified at compile time, but may be overridden on the command line\&.
diff -Npur samba-4.8.4/docs/manpages/smbget.1 samba-4.8.5/docs/manpages/smbget.1
--- samba-4.8.4/docs/manpages/smbget.1	2018-08-11 08:18:42.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbget.1	2018-08-24 10:19:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBGET" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -189,7 +189,7 @@ smbget \-Rr smb://rhonwyn/
 Permission denied is returned in some cases where the cause of the error is unknown (such as an illegally formatted smb:// url or trying to get a directory without \-R turned on)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/smbgetrc.5 samba-4.8.5/docs/manpages/smbgetrc.5
--- samba-4.8.4/docs/manpages/smbgetrc.5	2018-08-11 08:18:42.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbgetrc.5	2018-08-24 10:19:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "08/11/2018" "Samba 4\&.8\&.4" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "08/24/2018" "Samba 4\&.8\&.5" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -87,7 +87,7 @@ Number of bytes to put in a block\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbget\fR(1)
diff -Npur samba-4.8.4/docs/manpages/smbpasswd.5 samba-4.8.5/docs/manpages/smbpasswd.5
--- samba-4.8.4/docs/manpages/smbpasswd.5	2018-08-11 08:18:42.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbpasswd.5	2018-08-24 10:19:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "08/11/2018" "Samba 4\&.8\&.4" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "08/24/2018" "Samba 4\&.8\&.5" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -165,7 +165,7 @@ This field consists of the time the acco
 All other colon separated fields are ignored at this time\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/smbpasswd.8 samba-4.8.5/docs/manpages/smbpasswd.8
--- samba-4.8.4/docs/manpages/smbpasswd.8	2018-08-11 08:18:42.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbpasswd.8	2018-08-24 10:19:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SMBPASSWD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -316,7 +316,7 @@ file and neglecting to allow "localhost"
 In addition, the smbpasswd command is only useful if Samba has been set up to use encrypted passwords\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.4/docs/manpages/smbspool.8 samba-4.8.5/docs/manpages/smbspool.8
--- samba-4.8.4/docs/manpages/smbspool.8	2018-08-11 08:18:42.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbspool.8	2018-08-24 10:19:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SMBSPOOL" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -173,7 +173,7 @@ The filename argument (argv[6]) contains
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.4/docs/manpages/smbspool_krb5_wrapper.8 samba-4.8.5/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.8.4/docs/manpages/smbspool_krb5_wrapper.8	2018-08-11 08:18:43.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbspool_krb5_wrapper.8	2018-08-24 10:19:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/smbstatus.1 samba-4.8.5/docs/manpages/smbstatus.1
--- samba-4.8.4/docs/manpages/smbstatus.1	2018-08-11 08:18:43.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbstatus.1	2018-08-24 10:19:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBSTATUS" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -154,7 +154,7 @@ causes smbstatus to display numeric UIDs
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.4/docs/manpages/smbtar.1 samba-4.8.5/docs/manpages/smbtar.1
--- samba-4.8.4/docs/manpages/smbtar.1	2018-08-11 08:18:43.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbtar.1	2018-08-24 10:19:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBTAR" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -145,7 +145,7 @@ section for the
 command\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.4/docs/manpages/smbtree.1 samba-4.8.5/docs/manpages/smbtree.1
--- samba-4.8.4/docs/manpages/smbtree.1	2018-08-11 08:18:43.000000000 +0200
+++ samba-4.8.5/docs/manpages/smbtree.1	2018-08-24 10:19:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "SMBTREE" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -191,7 +191,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/testparm.1 samba-4.8.5/docs/manpages/testparm.1
--- samba-4.8.4/docs/manpages/testparm.1	2018-08-11 08:18:43.000000000 +0200
+++ samba-4.8.5/docs/manpages/testparm.1	2018-08-24 10:19:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "TESTPARM" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -169,7 +169,7 @@ This is usually the name of the configur
 The program will issue a message saying whether the configuration file loaded OK or not\&. This message may be preceded by errors and warnings if the file did not load\&. If the file was loaded OK, the program then dumps all known service details to stdout\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmb.conf\fR(5),
diff -Npur samba-4.8.4/docs/manpages/traffic_learner.7 samba-4.8.5/docs/manpages/traffic_learner.7
--- samba-4.8.4/docs/manpages/traffic_learner.7	2018-08-11 08:18:44.000000000 +0200
+++ samba-4.8.5/docs/manpages/traffic_learner.7	2018-08-24 10:19:49.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: traffic_learner
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "TRAFFIC_LEARNER" "7" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "TRAFFIC_LEARNER" "7" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ There are two special packet types here\
 The other special packet is "\-", which represents the limit of the conversation\&. In the example, this indicates that one observed conversation ended after this particular ngram\&. This special opcode is also used at the beginning of conversations, which are indicated by the ngram "\-\et\-"\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.4 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_replay\fR(7)\&.
diff -Npur samba-4.8.4/docs/manpages/traffic_replay.7 samba-4.8.5/docs/manpages/traffic_replay.7
--- samba-4.8.4/docs/manpages/traffic_replay.7	2018-08-11 08:18:44.000000000 +0200
+++ samba-4.8.5/docs/manpages/traffic_replay.7	2018-08-24 10:19:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: traffic_replay
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "TRAFFIC_REPLAY" "7" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "TRAFFIC_REPLAY" "7" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -327,7 +327,7 @@ traffic_replay traffic\-model\&.txt my\-
 The users created by the test will have names like STGU\-0\-xyz\&. The groups generated have names like STGG\-0\-xyz\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.4 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_learner\fR(7)\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_acl_tdb.8 samba-4.8.5/docs/manpages/vfs_acl_tdb.8
--- samba-4.8.4/docs/manpages/vfs_acl_tdb.8	2018-08-11 08:18:44.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_acl_tdb.8	2018-08-24 10:19:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_acl_xattr.8 samba-4.8.5/docs/manpages/vfs_acl_xattr.8
--- samba-4.8.4/docs/manpages/vfs_acl_xattr.8	2018-08-11 08:18:44.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_acl_xattr.8	2018-08-24 10:19:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_aio_fork.8 samba-4.8.5/docs/manpages/vfs_aio_fork.8
--- samba-4.8.4/docs/manpages/vfs_aio_fork.8	2018-08-11 08:18:45.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_aio_fork.8	2018-08-24 10:19:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Straight forward use:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_aio_pthread.8 samba-4.8.5/docs/manpages/vfs_aio_pthread.8
--- samba-4.8.4/docs/manpages/vfs_aio_pthread.8	2018-08-11 08:18:45.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_aio_pthread.8	2018-08-24 10:19:50.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -78,7 +78,7 @@ By default this is set to 100\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_audit.8 samba-4.8.5/docs/manpages/vfs_audit.8
--- samba-4.8.4/docs/manpages/vfs_audit.8	2018-08-11 08:18:45.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_audit.8	2018-08-24 10:19:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_AUDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -118,7 +118,7 @@ Log operations on all shares using the L
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_btrfs.8 samba-4.8.5/docs/manpages/vfs_btrfs.8
--- samba-4.8.4/docs/manpages/vfs_btrfs.8	2018-08-11 08:18:45.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_btrfs.8	2018-08-24 10:19:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_BTRFS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -104,7 +104,7 @@ to Windows Explorer as file / directory
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_cacheprime.8 samba-4.8.5/docs/manpages/vfs_cacheprime.8
--- samba-4.8.4/docs/manpages/vfs_cacheprime.8	2018-08-11 08:18:45.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_cacheprime.8	2018-08-24 10:19:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ cacheprime
 is not a substitute for a general\-purpose readahead mechanism\&. It is intended for use only in very specific environments where disk operations must be aligned and sized to known values (as much as that is possible)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_cap.8 samba-4.8.5/docs/manpages/vfs_cap.8
--- samba-4.8.4/docs/manpages/vfs_cap.8	2018-08-11 08:18:46.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_cap.8	2018-08-24 10:19:51.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_CAP" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -63,7 +63,7 @@ On a system using GNU libiconv, use CAP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_catia.8 samba-4.8.5/docs/manpages/vfs_catia.8
--- samba-4.8.4/docs/manpages/vfs_catia.8	2018-08-11 08:18:46.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_catia.8	2018-08-24 10:19:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_CATIA" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_ceph.8 samba-4.8.5/docs/manpages/vfs_ceph.8
--- samba-4.8.4/docs/manpages/vfs_ceph.8	2018-08-11 08:18:46.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_ceph.8	2018-08-24 10:19:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_CEPH" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -58,11 +58,25 @@ requires that the underlying share path
 .nf
 		\fI[share]\fR
 		\m[blue]\fBvfs objects = ceph\fR\m[]
+		\m[blue]\fBpath = /non\-mounted/cephfs/path\fR\m[]
+		\m[blue]\fBkernel share modes = no\fR\m[]
 	
 .fi
 .if n \{\
 .RE
 .\}
+.PP
+Since
+vfs_ceph
+does not require a filesystem mount, the share
+path
+is treated differently: it is interpreted as an absolute path within the Ceph filesystem on the attached Ceph cluster\&. In a ctdb cluster environment where ctdb manages Samba,
+CTDB_SAMBA_SKIP_SHARE_CHECK=yes
+must be configured to disable local share path checks, otherwise ctdb will not reach a healthy state\&.
+.PP
+Note that currently
+kernel share modes
+have to be disabled in a share running with the CephFS vfs module for file serving to work properly\&.
 .SH "OPTIONS"
 .PP
 ceph:config_file = path
@@ -80,7 +94,7 @@ Example: ceph:user_id = samba
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_commit.8 samba-4.8.5/docs/manpages/vfs_commit.8
--- samba-4.8.4/docs/manpages/vfs_commit.8	2018-08-11 08:18:46.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_commit.8	2018-08-24 10:19:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_COMMIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -116,7 +116,7 @@ commit
 may reduce performance\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_crossrename.8 samba-4.8.5/docs/manpages/vfs_crossrename.8
--- samba-4.8.4/docs/manpages/vfs_crossrename.8	2018-08-11 08:18:46.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_crossrename.8	2018-08-24 10:19:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -89,7 +89,7 @@ To add server\-side cross\-device rename
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_default_quota.8 samba-4.8.5/docs/manpages/vfs_default_quota.8
--- samba-4.8.4/docs/manpages/vfs_default_quota.8	2018-08-11 08:18:47.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_default_quota.8	2018-08-24 10:19:52.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ Store the default quota record in the qu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_dirsort.8 samba-4.8.5/docs/manpages/vfs_dirsort.8
--- samba-4.8.4/docs/manpages/vfs_dirsort.8	2018-08-11 08:18:47.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_dirsort.8	2018-08-24 10:19:53.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Sort directories for all shares:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_extd_audit.8 samba-4.8.5/docs/manpages/vfs_extd_audit.8
--- samba-4.8.4/docs/manpages/vfs_extd_audit.8	2018-08-11 08:18:47.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_extd_audit.8	2018-08-24 10:19:53.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -55,7 +55,7 @@ is identical to
 This module is stackable\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_fake_perms.8 samba-4.8.5/docs/manpages/vfs_fake_perms.8
--- samba-4.8.4/docs/manpages/vfs_fake_perms.8	2018-08-11 08:18:47.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_fake_perms.8	2018-08-24 10:19:53.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -58,7 +58,7 @@ This module is stackable\&.
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_fileid.8 samba-4.8.5/docs/manpages/vfs_fileid.8
--- samba-4.8.4/docs/manpages/vfs_fileid.8	2018-08-11 08:18:48.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_fileid.8	2018-08-24 10:19:53.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_FILEID" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ algorithm:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_fruit.8 samba-4.8.5/docs/manpages/vfs_fruit.8
--- samba-4.8.4/docs/manpages/vfs_fruit.8	2018-08-11 08:18:48.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_fruit.8	2018-08-24 10:19:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_FRUIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_full_audit.8 samba-4.8.5/docs/manpages/vfs_full_audit.8
--- samba-4.8.4/docs/manpages/vfs_full_audit.8	2018-08-11 08:18:48.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_full_audit.8	2018-08-24 10:19:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -400,7 +400,7 @@ Log file and directory open operations o
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_glusterfs.8 samba-4.8.5/docs/manpages/vfs_glusterfs.8
--- samba-4.8.4/docs/manpages/vfs_glusterfs.8	2018-08-11 08:18:48.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_glusterfs.8	2018-08-24 10:19:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -109,7 +109,7 @@ Defines the glusterfs volumename to use
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_gpfs.8 samba-4.8.5/docs/manpages/vfs_gpfs.8
--- samba-4.8.4/docs/manpages/vfs_gpfs.8	2018-08-11 08:18:48.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_gpfs.8	2018-08-24 10:19:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_GPFS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -692,7 +692,7 @@ gpfs\&.h
 in gpfs versions newer than 3\&.2\&.1 PTF8\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.8.5/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.8.4/docs/manpages/vfs_linux_xfs_sgid.8	2018-08-11 08:18:49.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_linux_xfs_sgid.8	2018-08-24 10:19:54.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_media_harmony.8 samba-4.8.5/docs/manpages/vfs_media_harmony.8
--- samba-4.8.4/docs/manpages/vfs_media_harmony.8	2018-08-11 08:18:49.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_media_harmony.8	2018-08-24 10:19:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ vfs_media_harmony
 is designed to work with Avid editing applications that look in the Avid MediaFiles or OMFI MediaFiles directories for media\&. It is not designed to work as expected in all circumstances for general use\&. For example: It is possible to open a client\-specific file such as msmMMOB\&.mdb_192\&.168\&.1\&.10_userx even though it doesn\*(Aqt show up in a directory listing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_netatalk.8 samba-4.8.5/docs/manpages/vfs_netatalk.8
--- samba-4.8.4/docs/manpages/vfs_netatalk.8	2018-08-11 08:18:49.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_netatalk.8	2018-08-24 10:19:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_NETATALK" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Hide \&.AppleDouble files on the [data]
 This module is largely historic and unlikely to be of use in modern networks since current Apple systems are able to mount CIFS shares natively\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_nfs4acl_xattr.8 samba-4.8.5/docs/manpages/vfs_nfs4acl_xattr.8
--- samba-4.8.4/docs/manpages/vfs_nfs4acl_xattr.8	2018-08-11 08:18:49.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_nfs4acl_xattr.8	2018-08-24 10:19:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_nfs4acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_NFS4ACL_XATTR" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_NFS4ACL_XATTR" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_offline.8 samba-4.8.5/docs/manpages/vfs_offline.8
--- samba-4.8.4/docs/manpages/vfs_offline.8	2018-08-11 08:18:50.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_offline.8	2018-08-24 10:19:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Mark all files in a share as offline:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_prealloc.8 samba-4.8.5/docs/manpages/vfs_prealloc.8
--- samba-4.8.4/docs/manpages/vfs_prealloc.8	2018-08-11 08:18:50.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_prealloc.8	2018-08-24 10:19:55.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ vfs_prealloc
 is not supported on all platforms and filesystems\&. Currently only XFS filesystems on Linux and IRIX are supported\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_preopen.8 samba-4.8.5/docs/manpages/vfs_preopen.8
--- samba-4.8.4/docs/manpages/vfs_preopen.8	2018-08-11 08:18:50.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_preopen.8	2018-08-24 10:19:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -67,7 +67,7 @@ Number of files that should be speculati
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_readahead.8 samba-4.8.5/docs/manpages/vfs_readahead.8
--- samba-4.8.4/docs/manpages/vfs_readahead.8	2018-08-11 08:18:50.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_readahead.8	2018-08-24 10:19:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ G
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_readonly.8 samba-4.8.5/docs/manpages/vfs_readonly.8
--- samba-4.8.4/docs/manpages/vfs_readonly.8	2018-08-11 08:18:50.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_readonly.8	2018-08-24 10:19:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_READONLY" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -81,7 +81,7 @@ Mark the [backup] share as read only dur
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_recycle.8 samba-4.8.5/docs/manpages/vfs_recycle.8
--- samba-4.8.4/docs/manpages/vfs_recycle.8	2018-08-11 08:18:51.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_recycle.8	2018-08-24 10:19:56.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -136,7 +136,7 @@ instead of deleting them:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_shadow_copy.8 samba-4.8.5/docs/manpages/vfs_shadow_copy.8
--- samba-4.8.4/docs/manpages/vfs_shadow_copy.8	2018-08-11 08:18:51.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_shadow_copy.8	2018-08-24 10:19:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -167,7 +167,7 @@ vfs_shadow_copy
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_shadow_copy2.8 samba-4.8.5/docs/manpages/vfs_shadow_copy2.8
--- samba-4.8.4/docs/manpages/vfs_shadow_copy2.8	2018-08-11 08:18:51.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_shadow_copy2.8	2018-08-24 10:19:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -519,7 +519,7 @@ vfs_shadow_copy2
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_shell_snap.8 samba-4.8.5/docs/manpages/vfs_shell_snap.8
--- samba-4.8.4/docs/manpages/vfs_shell_snap.8	2018-08-11 08:18:51.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_shell_snap.8	2018-08-24 10:19:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ Samba\*(Aqs FSRVP server must be configu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_snapper.8 samba-4.8.5/docs/manpages/vfs_snapper.8
--- samba-4.8.4/docs/manpages/vfs_snapper.8	2018-08-11 08:18:51.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_snapper.8	2018-08-24 10:19:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -85,7 +85,7 @@ Remote snapshot creation and deletion is
 The DiskShadow\&.exe FSRVP client initially authenticates as the Active Directory computer account\&. This account must therefore be granted the same permissions as the user account issuing the snapshot creation and deletion requests\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_streams_depot.8 samba-4.8.5/docs/manpages/vfs_streams_depot.8
--- samba-4.8.4/docs/manpages/vfs_streams_depot.8	2018-08-11 08:18:52.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_streams_depot.8	2018-08-24 10:19:57.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_streams_xattr.8 samba-4.8.5/docs/manpages/vfs_streams_xattr.8
--- samba-4.8.4/docs/manpages/vfs_streams_xattr.8	2018-08-11 08:18:52.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_streams_xattr.8	2018-08-24 10:19:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_syncops.8 samba-4.8.5/docs/manpages/vfs_syncops.8
--- samba-4.8.4/docs/manpages/vfs_syncops.8	2018-08-11 08:18:52.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_syncops.8	2018-08-24 10:19:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_time_audit.8 samba-4.8.5/docs/manpages/vfs_time_audit.8
--- samba-4.8.4/docs/manpages/vfs_time_audit.8	2018-08-11 08:18:52.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_time_audit.8	2018-08-24 10:19:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -72,7 +72,7 @@ This would log VFS calls that take longe
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_tsmsm.8 samba-4.8.5/docs/manpages/vfs_tsmsm.8
--- samba-4.8.4/docs/manpages/vfs_tsmsm.8	2018-08-11 08:18:52.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_tsmsm.8	2018-08-24 10:19:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_TSMSM" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -83,7 +83,7 @@ A GPFS mount with TSM support can be exp
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_unityed_media.8 samba-4.8.5/docs/manpages/vfs_unityed_media.8
--- samba-4.8.4/docs/manpages/vfs_unityed_media.8	2018-08-11 08:18:53.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_unityed_media.8	2018-08-24 10:19:58.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -111,7 +111,7 @@ Enable unityed_media for Mac and Windows
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_virusfilter.8 samba-4.8.5/docs/manpages/vfs_virusfilter.8
--- samba-4.8.4/docs/manpages/vfs_virusfilter.8	2018-08-11 08:18:53.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_virusfilter.8	2018-08-24 10:19:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_virusfilter
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.8
 .\"  Language: English
 .\"
-.TH "VFS_VIRUSFILTER" "8" "08/11/2018" "Samba 4\&.8" "System Administration tools"
+.TH "VFS_VIRUSFILTER" "8" "08/24/2018" "Samba 4\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_worm.8 samba-4.8.5/docs/manpages/vfs_worm.8
--- samba-4.8.4/docs/manpages/vfs_worm.8	2018-08-11 08:18:53.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_worm.8	2018-08-24 10:19:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_WORM" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -68,7 +68,7 @@ Deny the write access to files and folde
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfs_xattr_tdb.8 samba-4.8.5/docs/manpages/vfs_xattr_tdb.8
--- samba-4.8.4/docs/manpages/vfs_xattr_tdb.8	2018-08-11 08:18:53.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_xattr_tdb.8	2018-08-24 10:19:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.4/docs/manpages/vfs_zfsacl.8 samba-4.8.5/docs/manpages/vfs_zfsacl.8
--- samba-4.8.4/docs/manpages/vfs_zfsacl.8	2018-08-11 08:18:54.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfs_zfsacl.8	2018-08-24 10:19:59.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ A ZFS mount can be exported via Samba as
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/vfstest.1 samba-4.8.5/docs/manpages/vfstest.1
--- samba-4.8.4/docs/manpages/vfstest.1	2018-08-11 08:18:54.000000000 +0200
+++ samba-4.8.5/docs/manpages/vfstest.1	2018-08-24 10:20:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "VFSTEST" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -807,7 +807,7 @@ exit
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.4/docs/manpages/wbinfo.1 samba-4.8.5/docs/manpages/wbinfo.1
--- samba-4.8.4/docs/manpages/wbinfo.1	2018-08-11 08:18:54.000000000 +0200
+++ samba-4.8.5/docs/manpages/wbinfo.1	2018-08-24 10:20:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "08/11/2018" "Samba 4\&.8\&.4" "User Commands"
+.TH "WBINFO" "1" "08/24/2018" "Samba 4\&.8\&.5" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -440,7 +440,7 @@ wbinfo
 will always return failure\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBwinbindd\fR(8)
diff -Npur samba-4.8.4/docs/manpages/winbind_krb5_localauth.8 samba-4.8.5/docs/manpages/winbind_krb5_localauth.8
--- samba-4.8.4/docs/manpages/winbind_krb5_localauth.8	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/docs/manpages/winbind_krb5_localauth.8	2018-08-24 10:20:00.000000000 +0200
@@ -0,0 +1,74 @@
+'\" t
+.\"     Title: winbind_krb5_localauth
+.\"    Author: [see the "AUTHOR" section]
+.\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
+.\"      Date: 08/24/2018
+.\"    Manual: 8
+.\"    Source: Samba 4.8.5
+.\"  Language: English
+.\"
+.TH "WINBIND_KRB5_LOCALAU" "8" "08/24/2018" "Samba 4\&.8\&.5" "8"
+.\" -----------------------------------------------------------------
+.\" * Define some portability stuff
+.\" -----------------------------------------------------------------
+.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+.\" http://bugs.debian.org/507673
+.\" http://lists.gnu.org/archive/html/groff/2009-02/msg00013.html
+.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+.ie \n(.g .ds Aq \(aq
+.el       .ds Aq '
+.\" -----------------------------------------------------------------
+.\" * set default formatting
+.\" -----------------------------------------------------------------
+.\" disable hyphenation
+.nh
+.\" disable justification (adjust text to left margin only)
+.ad l
+.\" -----------------------------------------------------------------
+.\" * MAIN CONTENT STARTS HERE *
+.\" -----------------------------------------------------------------
+.SH "NAME"
+winbind_krb5_localauth \- A plugin for MIT Kerberos for mapping user accounts\&.
+.SH "DESCRIPTION"
+.PP
+This plugin is part of the
+\fBsamba\fR(7)
+suite\&.
+.PP
+winbind_krb5_localauth
+is a plugin that permits the MIT Kerberos libraries that Kerberos principals can be validated against local user accounts\&.
+.SH "PREREQUISITES"
+.PP
+MIT Kerberos (at least version 1\&.12) is required\&.
+.PP
+The plugin queries the
+\fBwinbindd\fR(8)
+daemon which needs to be configured and started separately\&.
+.PP
+The following sections needs to be added to the
+krb5\&.conf
+file\&.
+.sp
+.if n \{\
+.RS 4
+.\}
+.nf
+[plugins]
+	localauth = {
+		module = winbind:/usr/lib64/samba/krb5/winbind_krb5_localauth\&.so
+		enable_only = winbind
+	}
+		
+.fi
+.if n \{\
+.RE
+.\}
+.sp
+.SH "VERSION"
+.PP
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
+.SH "AUTHOR"
+.PP
+The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
+.PP
+The winbind_krb5_localauth manpage was written by Andreas Schneider\&.
diff -Npur samba-4.8.4/docs/manpages/winbind_krb5_locator.7 samba-4.8.5/docs/manpages/winbind_krb5_locator.7
--- samba-4.8.4/docs/manpages/winbind_krb5_locator.7	2018-08-11 08:18:54.000000000 +0200
+++ samba-4.8.5/docs/manpages/winbind_krb5_locator.7	1970-01-01 01:00:00.000000000 +0100
@@ -1,65 +0,0 @@
-'\" t
-.\"     Title: winbind_krb5_locator
-.\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
-.\"    Manual: 7
-.\"    Source: Samba 4.8.4
-.\"  Language: English
-.\"
-.TH "WINBIND_KRB5_LOCATOR" "7" "08/11/2018" "Samba 4\&.8\&.4" "7"
-.\" -----------------------------------------------------------------
-.\" * Define some portability stuff
-.\" -----------------------------------------------------------------
-.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-.\" http://bugs.debian.org/507673
-.\" http://lists.gnu.org/archive/html/groff/2009-02/msg00013.html
-.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-.ie \n(.g .ds Aq \(aq
-.el       .ds Aq '
-.\" -----------------------------------------------------------------
-.\" * set default formatting
-.\" -----------------------------------------------------------------
-.\" disable hyphenation
-.nh
-.\" disable justification (adjust text to left margin only)
-.ad l
-.\" -----------------------------------------------------------------
-.\" * MAIN CONTENT STARTS HERE *
-.\" -----------------------------------------------------------------
-.SH "NAME"
-winbind_krb5_locator \- A plugin for MIT and Heimdal Kerberos for detecting KDCs using Windows semantics\&.
-.SH "DESCRIPTION"
-.PP
-This plugin is part of the
-\fBsamba\fR(7)
-suite\&.
-.PP
-winbind_krb5_locator
-is a plugin that permits MIT and Heimdal Kerberos libraries to detect Kerberos Servers (for the KDC and kpasswd service) using the same semantics that other tools of the Samba suite use\&. This include site\-aware DNS service record lookups and caching of closest dc\&. The plugin uses the public locator API provided by most modern Kerberos implementations\&.
-.SH "PREREQUISITES"
-.PP
-MIT Kerberos (at least version 1\&.5) or Heimdal Kerberos (at least version 1\&.0) is required\&.
-.PP
-The plugin queries the
-\fBwinbindd\fR(8)
-daemon which needs to be configured and started separately\&.
-.PP
-The
-winbind_krb5_locator\&.so
-file needs to be manually copied to the plugin directory of the system Kerberos library\&. For MIT Kerberos this is often:
-/usr/lib/krb5/plugins/libkrb5/\&. For Heimdal Kerberos this is often:
-/usr/lib/plugin/krb5/\&. Please check your local Kerberos installation for the correct paths\&. No modification in
-/etc/krb5\&.conf
-is required to enable the use of this plugin\&.
-.PP
-After copying the locator plugin to the appropriate plugin directory it should immediately be available for use\&. Users should be able to kinit into their kerberized Windows environment without any modification or servers being put manually into
-/etc/krb5\&.conf\&.
-.SH "VERSION"
-.PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
-.SH "AUTHOR"
-.PP
-The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
-.PP
-The winbind_krb5_locator manpage was written by Guenther Deschner\&.
diff -Npur samba-4.8.4/docs/manpages/winbind_krb5_locator.8 samba-4.8.5/docs/manpages/winbind_krb5_locator.8
--- samba-4.8.4/docs/manpages/winbind_krb5_locator.8	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/docs/manpages/winbind_krb5_locator.8	2018-08-24 10:20:00.000000000 +0200
@@ -0,0 +1,65 @@
+'\" t
+.\"     Title: winbind_krb5_locator
+.\"    Author: [see the "AUTHOR" section]
+.\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
+.\"      Date: 08/24/2018
+.\"    Manual: 8
+.\"    Source: Samba 4.8.5
+.\"  Language: English
+.\"
+.TH "WINBIND_KRB5_LOCATOR" "8" "08/24/2018" "Samba 4\&.8\&.5" "8"
+.\" -----------------------------------------------------------------
+.\" * Define some portability stuff
+.\" -----------------------------------------------------------------
+.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+.\" http://bugs.debian.org/507673
+.\" http://lists.gnu.org/archive/html/groff/2009-02/msg00013.html
+.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+.ie \n(.g .ds Aq \(aq
+.el       .ds Aq '
+.\" -----------------------------------------------------------------
+.\" * set default formatting
+.\" -----------------------------------------------------------------
+.\" disable hyphenation
+.nh
+.\" disable justification (adjust text to left margin only)
+.ad l
+.\" -----------------------------------------------------------------
+.\" * MAIN CONTENT STARTS HERE *
+.\" -----------------------------------------------------------------
+.SH "NAME"
+winbind_krb5_locator \- A plugin for MIT and Heimdal Kerberos for detecting KDCs using Windows semantics\&.
+.SH "DESCRIPTION"
+.PP
+This plugin is part of the
+\fBsamba\fR(7)
+suite\&.
+.PP
+winbind_krb5_locator
+is a plugin that permits MIT and Heimdal Kerberos libraries to detect Kerberos Servers (for the KDC and kpasswd service) using the same semantics that other tools of the Samba suite use\&. This include site\-aware DNS service record lookups and caching of closest dc\&. The plugin uses the public locator API provided by most modern Kerberos implementations\&.
+.SH "PREREQUISITES"
+.PP
+MIT Kerberos (at least version 1\&.5) or Heimdal Kerberos (at least version 1\&.0) is required\&.
+.PP
+The plugin queries the
+\fBwinbindd\fR(8)
+daemon which needs to be configured and started separately\&.
+.PP
+The
+winbind_krb5_locator\&.so
+file needs to be manually copied to the plugin directory of the system Kerberos library\&. For MIT Kerberos this is often:
+/usr/lib/krb5/plugins/libkrb5/\&. For Heimdal Kerberos this is often:
+/usr/lib/plugin/krb5/\&. Please check your local Kerberos installation for the correct paths\&. No modification in
+/etc/krb5\&.conf
+is required to enable the use of this plugin\&.
+.PP
+After copying the locator plugin to the appropriate plugin directory it should immediately be available for use\&. Users should be able to kinit into their kerberized Windows environment without any modification or servers being put manually into
+/etc/krb5\&.conf\&.
+.SH "VERSION"
+.PP
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
+.SH "AUTHOR"
+.PP
+The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
+.PP
+The winbind_krb5_locator manpage was written by Guenther Deschner\&.
diff -Npur samba-4.8.4/docs/manpages/winbindd.8 samba-4.8.5/docs/manpages/winbindd.8
--- samba-4.8.4/docs/manpages/winbindd.8	2018-08-11 08:18:54.000000000 +0200
+++ samba-4.8.5/docs/manpages/winbindd.8	2018-08-24 10:20:00.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 08/11/2018
+.\"      Date: 08/24/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.4
+.\"    Source: Samba 4.8.5
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "08/11/2018" "Samba 4\&.8\&.4" "System Administration tools"
+.TH "WINBINDD" "8" "08/24/2018" "Samba 4\&.8\&.5" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -579,7 +579,7 @@ Storage for cached user and group inform
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.4 of the Samba suite\&.
+This man page is part of version 4\&.8\&.5 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 nsswitch\&.conf(5),
diff -Npur samba-4.8.4/docs-xml/manpages/vfs_ceph.8.xml samba-4.8.5/docs-xml/manpages/vfs_ceph.8.xml
--- samba-4.8.4/docs-xml/manpages/vfs_ceph.8.xml	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/docs-xml/manpages/vfs_ceph.8.xml	2018-08-24 09:58:20.000000000 +0200
@@ -62,7 +62,26 @@
 	<programlisting>
 		<smbconfsection name="[share]"/>
 		<smbconfoption name="vfs objects">ceph</smbconfoption>
+		<smbconfoption name="path">/non-mounted/cephfs/path</smbconfoption>
+		<smbconfoption name="kernel share modes">no</smbconfoption>
 	</programlisting>
+
+	<para>
+		Since <command>vfs_ceph</command> does not require a filesystem
+		mount, the share <command>path</command> is treated differently:
+		it is interpreted as an absolute path within the Ceph filesystem
+		on the attached Ceph cluster.
+		In a ctdb cluster environment where ctdb manages Samba,
+		<command>CTDB_SAMBA_SKIP_SHARE_CHECK=yes</command> must be
+		configured to disable local share path checks, otherwise ctdb
+		will not reach a healthy state.
+	</para>
+
+	<para>
+		Note that currently <command>kernel share modes</command> have
+		to be disabled in a share running with the CephFS vfs module for
+		file serving to work properly.
+	</para>
 </refsect1>
 
 <refsect1>
diff -Npur samba-4.8.4/docs-xml/manpages/winbind_krb5_localauth.8.xml samba-4.8.5/docs-xml/manpages/winbind_krb5_localauth.8.xml
--- samba-4.8.4/docs-xml/manpages/winbind_krb5_localauth.8.xml	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/docs-xml/manpages/winbind_krb5_localauth.8.xml	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,86 @@
+<?xml version="1.0" encoding="iso-8859-1"?>
+<!DOCTYPE refentry PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
+<refentry id="winbind_krb5_localauth.8">
+
+<refmeta>
+	<refentrytitle>winbind_krb5_localauth</refentrytitle>
+	<manvolnum>8</manvolnum>
+	<refmiscinfo class="source">Samba</refmiscinfo>
+	<refmiscinfo class="manual">8</refmiscinfo>
+	<refmiscinfo class="version">&doc.version;</refmiscinfo>
+</refmeta>
+
+
+<refnamediv>
+	<refname>winbind_krb5_localauth</refname>
+	<refpurpose>A plugin for MIT Kerberos for mapping user accounts.</refpurpose>
+</refnamediv>
+
+
+<refsect1>
+	<title>DESCRIPTION</title>
+
+	<para>
+		This plugin is part of the
+		<citerefentry><refentrytitle>samba</refentrytitle>
+		<manvolnum>7</manvolnum></citerefentry> suite.
+	</para>
+
+	<para>
+		<command>winbind_krb5_localauth</command> is a plugin that
+		permits the MIT Kerberos libraries that Kerberos principals can
+		be validated against local user accounts.
+	</para>
+</refsect1>
+<refsect1>
+	<title>PREREQUISITES</title>
+	<para>
+		MIT Kerberos (at least version 1.12) is required.
+	</para>
+
+	<para>
+		The plugin queries the <citerefentry><refentrytitle>winbindd</refentrytitle>
+		<manvolnum>8</manvolnum></citerefentry> daemon which needs to be configured
+		and started separately.
+	</para>
+
+	<para>
+		The following sections needs to be added to the
+		<filename>krb5.conf</filename> file.
+
+		<programlisting>
+[plugins]
+	localauth = {
+		module = winbind:/usr/lib64/samba/krb5/winbind_krb5_localauth.so
+		enable_only = winbind
+	}
+		</programlisting>
+	</para>
+</refsect1>
+
+<refsect1>
+	<title>VERSION</title>
+
+	<para>
+		This man page is part of version &doc.version; of the Samba
+		suite.
+	</para>
+</refsect1>
+
+<refsect1>
+	<title>AUTHOR</title>
+
+	<para>
+		The original Samba software and related utilities were created
+		by Andrew Tridgell. Samba is now developed by the Samba Team as
+		an Open Source project similar to the way the Linux kernel is
+		developed.
+	</para>
+
+	<para>
+		The winbind_krb5_localauth manpage was written by Andreas
+		Schneider.
+	</para>
+</refsect1>
+
+</refentry>
diff -Npur samba-4.8.4/docs-xml/manpages/winbind_krb5_locator.7.xml samba-4.8.5/docs-xml/manpages/winbind_krb5_locator.7.xml
--- samba-4.8.4/docs-xml/manpages/winbind_krb5_locator.7.xml	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/docs-xml/manpages/winbind_krb5_locator.7.xml	1970-01-01 01:00:00.000000000 +0100
@@ -1,95 +0,0 @@
-<?xml version="1.0" encoding="iso-8859-1"?>
-<!DOCTYPE refentry PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
-<refentry id="winbind_krb5_locator.7">
-
-<refmeta>
-	<refentrytitle>winbind_krb5_locator</refentrytitle>
-	<manvolnum>7</manvolnum>
-	<refmiscinfo class="source">Samba</refmiscinfo>
-	<refmiscinfo class="manual">7</refmiscinfo>
-	<refmiscinfo class="version">&doc.version;</refmiscinfo>
-</refmeta>
-
-
-<refnamediv>
-	<refname>winbind_krb5_locator</refname>
-	<refpurpose>A plugin for MIT and Heimdal Kerberos for detecting KDCs using Windows semantics.</refpurpose>
-</refnamediv>
-
-
-<refsect1>
-	<title>DESCRIPTION</title>
-
-	<para>
-	This plugin is part of the <citerefentry><refentrytitle>samba</refentrytitle>
-	<manvolnum>7</manvolnum></citerefentry> suite.
-	</para>
-
-	<para>
-		<command>winbind_krb5_locator</command> is a plugin that permits MIT and
-		Heimdal Kerberos libraries to detect Kerberos Servers (for the KDC and
-		kpasswd service) using the same semantics that other tools of the Samba
-		suite use. This include site-aware DNS service record lookups and caching
-		of closest dc.
-		The plugin uses the public locator API provided by most modern Kerberos
-		implementations.
-	</para>
-</refsect1>
-<refsect1>
-	<title>PREREQUISITES</title>
-	<para>
-		MIT Kerberos (at least version 1.5) or Heimdal Kerberos (at least version
-		1.0) is required.
-	</para>
-
-	<para>
-		The plugin queries the <citerefentry><refentrytitle>winbindd</refentrytitle>
-		<manvolnum>8</manvolnum></citerefentry> daemon which needs to be configured
-		and started separately.
-	</para>
-
-	<para>
-		The <command>winbind_krb5_locator.so</command> file needs to be manually
-		copied to the plugin directory of the system Kerberos library.
-
-		For MIT Kerberos this is often:
-			<filename>/usr/lib/krb5/plugins/libkrb5/</filename>.
-		For Heimdal Kerberos this is often:
-			<filename>/usr/lib/plugin/krb5/</filename>.
-
-		Please check your local Kerberos installation for the correct
-		paths. No modification in <filename>/etc/krb5.conf</filename>
-		is required to enable the use of this plugin.
-	</para>
-	<para>
-		After copying the locator plugin to the appropriate plugin
-		directory it should immediately be available for use.
-		Users should be able to kinit into their kerberized Windows
-		environment without any modification or servers
-		being put manually into <filename>/etc/krb5.conf</filename>.
-	</para>
-</refsect1>
-
-<refsect1>
-	<title>VERSION</title>
-
-	<para>
-	This man page is part of version &doc.version; of the Samba suite.
-	</para>
-</refsect1>
-
-<refsect1>
-	<title>AUTHOR</title>
-
-	<para>
-		The original Samba software and related utilities were created by Andrew
-		Tridgell. Samba is now developed by the Samba Team as an Open Source
-		project similar to the way the Linux kernel is developed.
-	</para>
-
-	<para>
-		The winbind_krb5_locator manpage was written by Guenther Deschner.
-	</para>
-</refsect1>
-
-</refentry>
diff -Npur samba-4.8.4/docs-xml/manpages/winbind_krb5_locator.8.xml samba-4.8.5/docs-xml/manpages/winbind_krb5_locator.8.xml
--- samba-4.8.4/docs-xml/manpages/winbind_krb5_locator.8.xml	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/docs-xml/manpages/winbind_krb5_locator.8.xml	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,95 @@
+<?xml version="1.0" encoding="iso-8859-1"?>
+<!DOCTYPE refentry PUBLIC "-//Samba-Team//DTD DocBook V4.2-Based Variant V1.0//EN" "http://www.samba.org/samba/DTD/samba-doc">
+<refentry id="winbind_krb5_locator.8">
+
+<refmeta>
+	<refentrytitle>winbind_krb5_locator</refentrytitle>
+	<manvolnum>8</manvolnum>
+	<refmiscinfo class="source">Samba</refmiscinfo>
+	<refmiscinfo class="manual">8</refmiscinfo>
+	<refmiscinfo class="version">&doc.version;</refmiscinfo>
+</refmeta>
+
+
+<refnamediv>
+	<refname>winbind_krb5_locator</refname>
+	<refpurpose>A plugin for MIT and Heimdal Kerberos for detecting KDCs using Windows semantics.</refpurpose>
+</refnamediv>
+
+
+<refsect1>
+	<title>DESCRIPTION</title>
+
+	<para>
+	This plugin is part of the <citerefentry><refentrytitle>samba</refentrytitle>
+	<manvolnum>7</manvolnum></citerefentry> suite.
+	</para>
+
+	<para>
+		<command>winbind_krb5_locator</command> is a plugin that permits MIT and
+		Heimdal Kerberos libraries to detect Kerberos Servers (for the KDC and
+		kpasswd service) using the same semantics that other tools of the Samba
+		suite use. This include site-aware DNS service record lookups and caching
+		of closest dc.
+		The plugin uses the public locator API provided by most modern Kerberos
+		implementations.
+	</para>
+</refsect1>
+<refsect1>
+	<title>PREREQUISITES</title>
+	<para>
+		MIT Kerberos (at least version 1.5) or Heimdal Kerberos (at least version
+		1.0) is required.
+	</para>
+
+	<para>
+		The plugin queries the <citerefentry><refentrytitle>winbindd</refentrytitle>
+		<manvolnum>8</manvolnum></citerefentry> daemon which needs to be configured
+		and started separately.
+	</para>
+
+	<para>
+		The <command>winbind_krb5_locator.so</command> file needs to be manually
+		copied to the plugin directory of the system Kerberos library.
+
+		For MIT Kerberos this is often:
+			<filename>/usr/lib/krb5/plugins/libkrb5/</filename>.
+		For Heimdal Kerberos this is often:
+			<filename>/usr/lib/plugin/krb5/</filename>.
+
+		Please check your local Kerberos installation for the correct
+		paths. No modification in <filename>/etc/krb5.conf</filename>
+		is required to enable the use of this plugin.
+	</para>
+	<para>
+		After copying the locator plugin to the appropriate plugin
+		directory it should immediately be available for use.
+		Users should be able to kinit into their kerberized Windows
+		environment without any modification or servers
+		being put manually into <filename>/etc/krb5.conf</filename>.
+	</para>
+</refsect1>
+
+<refsect1>
+	<title>VERSION</title>
+
+	<para>
+	This man page is part of version &doc.version; of the Samba suite.
+	</para>
+</refsect1>
+
+<refsect1>
+	<title>AUTHOR</title>
+
+	<para>
+		The original Samba software and related utilities were created by Andrew
+		Tridgell. Samba is now developed by the Samba Team as an Open Source
+		project similar to the way the Linux kernel is developed.
+	</para>
+
+	<para>
+		The winbind_krb5_locator manpage was written by Guenther Deschner.
+	</para>
+</refsect1>
+
+</refentry>
diff -Npur samba-4.8.4/docs-xml/wscript_build samba-4.8.5/docs-xml/wscript_build
--- samba-4.8.4/docs-xml/wscript_build	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.5/docs-xml/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -103,7 +103,8 @@ pam_winbind_manpages = '''
                        manpages/pam_winbind.conf.5
                        '''
 
-krb5_locator_manpages = 'manpages/winbind_krb5_locator.7'
+krb5_locator_manpages = 'manpages/winbind_krb5_locator.8'
+krb5_localauth_manpages = 'manpages/winbind_krb5_localauth.8'
 
 def smbdotconf_generate_parameter_list(task):
     parameter_all = task.outputs[0].bldpath(task.env)
@@ -162,5 +163,8 @@ if ('XSLTPROC_MANPAGES' in bld.env and b
     if bld.CONFIG_SET('HAVE_KRB5_LOCATE_PLUGIN_H'):
         bld.SAMBAMANPAGES(krb5_locator_manpages)
 
+    if bld.CONFIG_SET('HAVE_KRB5_LOCALAUTH_PLUGIN_H'):
+        bld.SAMBAMANPAGES(krb5_localauth_manpages)
+
     if bld.SAMBA3_IS_ENABLED_MODULE('vfs_zfsacl'):
         bld.SAMBAMANPAGES('manpages/vfs_zfsacl.8')
diff -Npur samba-4.8.4/lib/ldb/ABI/ldb-1.3.6.sigs samba-4.8.5/lib/ldb/ABI/ldb-1.3.6.sigs
--- samba-4.8.4/lib/ldb/ABI/ldb-1.3.6.sigs	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/lib/ldb/ABI/ldb-1.3.6.sigs	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,279 @@
+ldb_add: int (struct ldb_context *, const struct ldb_message *)
+ldb_any_comparison: int (struct ldb_context *, void *, ldb_attr_handler_t, const struct ldb_val *, const struct ldb_val *)
+ldb_asprintf_errstring: void (struct ldb_context *, const char *, ...)
+ldb_attr_casefold: char *(TALLOC_CTX *, const char *)
+ldb_attr_dn: int (const char *)
+ldb_attr_in_list: int (const char * const *, const char *)
+ldb_attr_list_copy: const char **(TALLOC_CTX *, const char * const *)
+ldb_attr_list_copy_add: const char **(TALLOC_CTX *, const char * const *, const char *)
+ldb_base64_decode: int (char *)
+ldb_base64_encode: char *(TALLOC_CTX *, const char *, int)
+ldb_binary_decode: struct ldb_val (TALLOC_CTX *, const char *)
+ldb_binary_encode: char *(TALLOC_CTX *, struct ldb_val)
+ldb_binary_encode_string: char *(TALLOC_CTX *, const char *)
+ldb_build_add_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, const struct ldb_message *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_del_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, struct ldb_dn *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_extended_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, const char *, void *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_mod_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, const struct ldb_message *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_rename_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, struct ldb_dn *, struct ldb_dn *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_search_req: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, struct ldb_dn *, enum ldb_scope, const char *, const char * const *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_build_search_req_ex: int (struct ldb_request **, struct ldb_context *, TALLOC_CTX *, struct ldb_dn *, enum ldb_scope, struct ldb_parse_tree *, const char * const *, struct ldb_control **, void *, ldb_request_callback_t, struct ldb_request *)
+ldb_casefold: char *(struct ldb_context *, TALLOC_CTX *, const char *, size_t)
+ldb_casefold_default: char *(void *, TALLOC_CTX *, const char *, size_t)
+ldb_check_critical_controls: int (struct ldb_control **)
+ldb_comparison_binary: int (struct ldb_context *, void *, const struct ldb_val *, const struct ldb_val *)
+ldb_comparison_fold: int (struct ldb_context *, void *, const struct ldb_val *, const struct ldb_val *)
+ldb_connect: int (struct ldb_context *, const char *, unsigned int, const char **)
+ldb_control_to_string: char *(TALLOC_CTX *, const struct ldb_control *)
+ldb_controls_except_specified: struct ldb_control **(struct ldb_control **, TALLOC_CTX *, struct ldb_control *)
+ldb_debug: void (struct ldb_context *, enum ldb_debug_level, const char *, ...)
+ldb_debug_add: void (struct ldb_context *, const char *, ...)
+ldb_debug_end: void (struct ldb_context *, enum ldb_debug_level)
+ldb_debug_set: void (struct ldb_context *, enum ldb_debug_level, const char *, ...)
+ldb_delete: int (struct ldb_context *, struct ldb_dn *)
+ldb_dn_add_base: bool (struct ldb_dn *, struct ldb_dn *)
+ldb_dn_add_base_fmt: bool (struct ldb_dn *, const char *, ...)
+ldb_dn_add_child: bool (struct ldb_dn *, struct ldb_dn *)
+ldb_dn_add_child_fmt: bool (struct ldb_dn *, const char *, ...)
+ldb_dn_alloc_casefold: char *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_alloc_linearized: char *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_canonical_ex_string: char *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_canonical_string: char *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_check_local: bool (struct ldb_module *, struct ldb_dn *)
+ldb_dn_check_special: bool (struct ldb_dn *, const char *)
+ldb_dn_compare: int (struct ldb_dn *, struct ldb_dn *)
+ldb_dn_compare_base: int (struct ldb_dn *, struct ldb_dn *)
+ldb_dn_copy: struct ldb_dn *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_escape_value: char *(TALLOC_CTX *, struct ldb_val)
+ldb_dn_extended_add_syntax: int (struct ldb_context *, unsigned int, const struct ldb_dn_extended_syntax *)
+ldb_dn_extended_filter: void (struct ldb_dn *, const char * const *)
+ldb_dn_extended_syntax_by_name: const struct ldb_dn_extended_syntax *(struct ldb_context *, const char *)
+ldb_dn_from_ldb_val: struct ldb_dn *(TALLOC_CTX *, struct ldb_context *, const struct ldb_val *)
+ldb_dn_get_casefold: const char *(struct ldb_dn *)
+ldb_dn_get_comp_num: int (struct ldb_dn *)
+ldb_dn_get_component_name: const char *(struct ldb_dn *, unsigned int)
+ldb_dn_get_component_val: const struct ldb_val *(struct ldb_dn *, unsigned int)
+ldb_dn_get_extended_comp_num: int (struct ldb_dn *)
+ldb_dn_get_extended_component: const struct ldb_val *(struct ldb_dn *, const char *)
+ldb_dn_get_extended_linearized: char *(TALLOC_CTX *, struct ldb_dn *, int)
+ldb_dn_get_ldb_context: struct ldb_context *(struct ldb_dn *)
+ldb_dn_get_linearized: const char *(struct ldb_dn *)
+ldb_dn_get_parent: struct ldb_dn *(TALLOC_CTX *, struct ldb_dn *)
+ldb_dn_get_rdn_name: const char *(struct ldb_dn *)
+ldb_dn_get_rdn_val: const struct ldb_val *(struct ldb_dn *)
+ldb_dn_has_extended: bool (struct ldb_dn *)
+ldb_dn_is_null: bool (struct ldb_dn *)
+ldb_dn_is_special: bool (struct ldb_dn *)
+ldb_dn_is_valid: bool (struct ldb_dn *)
+ldb_dn_map_local: struct ldb_dn *(struct ldb_module *, void *, struct ldb_dn *)
+ldb_dn_map_rebase_remote: struct ldb_dn *(struct ldb_module *, void *, struct ldb_dn *)
+ldb_dn_map_remote: struct ldb_dn *(struct ldb_module *, void *, struct ldb_dn *)
+ldb_dn_minimise: bool (struct ldb_dn *)
+ldb_dn_new: struct ldb_dn *(TALLOC_CTX *, struct ldb_context *, const char *)
+ldb_dn_new_fmt: struct ldb_dn *(TALLOC_CTX *, struct ldb_context *, const char *, ...)
+ldb_dn_remove_base_components: bool (struct ldb_dn *, unsigned int)
+ldb_dn_remove_child_components: bool (struct ldb_dn *, unsigned int)
+ldb_dn_remove_extended_components: void (struct ldb_dn *)
+ldb_dn_replace_components: bool (struct ldb_dn *, struct ldb_dn *)
+ldb_dn_set_component: int (struct ldb_dn *, int, const char *, const struct ldb_val)
+ldb_dn_set_extended_component: int (struct ldb_dn *, const char *, const struct ldb_val *)
+ldb_dn_update_components: int (struct ldb_dn *, const struct ldb_dn *)
+ldb_dn_validate: bool (struct ldb_dn *)
+ldb_dump_results: void (struct ldb_context *, struct ldb_result *, FILE *)
+ldb_error_at: int (struct ldb_context *, int, const char *, const char *, int)
+ldb_errstring: const char *(struct ldb_context *)
+ldb_extended: int (struct ldb_context *, const char *, void *, struct ldb_result **)
+ldb_extended_default_callback: int (struct ldb_request *, struct ldb_reply *)
+ldb_filter_from_tree: char *(TALLOC_CTX *, const struct ldb_parse_tree *)
+ldb_get_config_basedn: struct ldb_dn *(struct ldb_context *)
+ldb_get_create_perms: unsigned int (struct ldb_context *)
+ldb_get_default_basedn: struct ldb_dn *(struct ldb_context *)
+ldb_get_event_context: struct tevent_context *(struct ldb_context *)
+ldb_get_flags: unsigned int (struct ldb_context *)
+ldb_get_opaque: void *(struct ldb_context *, const char *)
+ldb_get_root_basedn: struct ldb_dn *(struct ldb_context *)
+ldb_get_schema_basedn: struct ldb_dn *(struct ldb_context *)
+ldb_global_init: int (void)
+ldb_handle_get_event_context: struct tevent_context *(struct ldb_handle *)
+ldb_handle_new: struct ldb_handle *(TALLOC_CTX *, struct ldb_context *)
+ldb_handle_use_global_event_context: void (struct ldb_handle *)
+ldb_handler_copy: int (struct ldb_context *, void *, const struct ldb_val *, struct ldb_val *)
+ldb_handler_fold: int (struct ldb_context *, void *, const struct ldb_val *, struct ldb_val *)
+ldb_init: struct ldb_context *(TALLOC_CTX *, struct tevent_context *)
+ldb_ldif_message_redacted_string: char *(struct ldb_context *, TALLOC_CTX *, enum ldb_changetype, const struct ldb_message *)
+ldb_ldif_message_string: char *(struct ldb_context *, TALLOC_CTX *, enum ldb_changetype, const struct ldb_message *)
+ldb_ldif_parse_modrdn: int (struct ldb_context *, const struct ldb_ldif *, TALLOC_CTX *, struct ldb_dn **, struct ldb_dn **, bool *, struct ldb_dn **, struct ldb_dn **)
+ldb_ldif_read: struct ldb_ldif *(struct ldb_context *, int (*)(void *), void *)
+ldb_ldif_read_file: struct ldb_ldif *(struct ldb_context *, FILE *)
+ldb_ldif_read_file_state: struct ldb_ldif *(struct ldb_context *, struct ldif_read_file_state *)
+ldb_ldif_read_free: void (struct ldb_context *, struct ldb_ldif *)
+ldb_ldif_read_string: struct ldb_ldif *(struct ldb_context *, const char **)
+ldb_ldif_write: int (struct ldb_context *, int (*)(void *, const char *, ...), void *, const struct ldb_ldif *)
+ldb_ldif_write_file: int (struct ldb_context *, FILE *, const struct ldb_ldif *)
+ldb_ldif_write_redacted_trace_string: char *(struct ldb_context *, TALLOC_CTX *, const struct ldb_ldif *)
+ldb_ldif_write_string: char *(struct ldb_context *, TALLOC_CTX *, const struct ldb_ldif *)
+ldb_load_modules: int (struct ldb_context *, const char **)
+ldb_map_add: int (struct ldb_module *, struct ldb_request *)
+ldb_map_delete: int (struct ldb_module *, struct ldb_request *)
+ldb_map_init: int (struct ldb_module *, const struct ldb_map_attribute *, const struct ldb_map_objectclass *, const char * const *, const char *, const char *)
+ldb_map_modify: int (struct ldb_module *, struct ldb_request *)
+ldb_map_rename: int (struct ldb_module *, struct ldb_request *)
+ldb_map_search: int (struct ldb_module *, struct ldb_request *)
+ldb_match_message: int (struct ldb_context *, const struct ldb_message *, const struct ldb_parse_tree *, enum ldb_scope, bool *)
+ldb_match_msg: int (struct ldb_context *, const struct ldb_message *, const struct ldb_parse_tree *, struct ldb_dn *, enum ldb_scope)
+ldb_match_msg_error: int (struct ldb_context *, const struct ldb_message *, const struct ldb_parse_tree *, struct ldb_dn *, enum ldb_scope, bool *)
+ldb_match_msg_objectclass: int (const struct ldb_message *, const char *)
+ldb_mod_register_control: int (struct ldb_module *, const char *)
+ldb_modify: int (struct ldb_context *, const struct ldb_message *)
+ldb_modify_default_callback: int (struct ldb_request *, struct ldb_reply *)
+ldb_module_call_chain: char *(struct ldb_request *, TALLOC_CTX *)
+ldb_module_connect_backend: int (struct ldb_context *, const char *, const char **, struct ldb_module **)
+ldb_module_done: int (struct ldb_request *, struct ldb_control **, struct ldb_extended *, int)
+ldb_module_flags: uint32_t (struct ldb_context *)
+ldb_module_get_ctx: struct ldb_context *(struct ldb_module *)
+ldb_module_get_name: const char *(struct ldb_module *)
+ldb_module_get_ops: const struct ldb_module_ops *(struct ldb_module *)
+ldb_module_get_private: void *(struct ldb_module *)
+ldb_module_init_chain: int (struct ldb_context *, struct ldb_module *)
+ldb_module_load_list: int (struct ldb_context *, const char **, struct ldb_module *, struct ldb_module **)
+ldb_module_new: struct ldb_module *(TALLOC_CTX *, struct ldb_context *, const char *, const struct ldb_module_ops *)
+ldb_module_next: struct ldb_module *(struct ldb_module *)
+ldb_module_popt_options: struct poptOption **(struct ldb_context *)
+ldb_module_send_entry: int (struct ldb_request *, struct ldb_message *, struct ldb_control **)
+ldb_module_send_referral: int (struct ldb_request *, char *)
+ldb_module_set_next: void (struct ldb_module *, struct ldb_module *)
+ldb_module_set_private: void (struct ldb_module *, void *)
+ldb_modules_hook: int (struct ldb_context *, enum ldb_module_hook_type)
+ldb_modules_list_from_string: const char **(struct ldb_context *, TALLOC_CTX *, const char *)
+ldb_modules_load: int (const char *, const char *)
+ldb_msg_add: int (struct ldb_message *, const struct ldb_message_element *, int)
+ldb_msg_add_empty: int (struct ldb_message *, const char *, int, struct ldb_message_element **)
+ldb_msg_add_fmt: int (struct ldb_message *, const char *, const char *, ...)
+ldb_msg_add_linearized_dn: int (struct ldb_message *, const char *, struct ldb_dn *)
+ldb_msg_add_steal_string: int (struct ldb_message *, const char *, char *)
+ldb_msg_add_steal_value: int (struct ldb_message *, const char *, struct ldb_val *)
+ldb_msg_add_string: int (struct ldb_message *, const char *, const char *)
+ldb_msg_add_value: int (struct ldb_message *, const char *, const struct ldb_val *, struct ldb_message_element **)
+ldb_msg_canonicalize: struct ldb_message *(struct ldb_context *, const struct ldb_message *)
+ldb_msg_check_string_attribute: int (const struct ldb_message *, const char *, const char *)
+ldb_msg_copy: struct ldb_message *(TALLOC_CTX *, const struct ldb_message *)
+ldb_msg_copy_attr: int (struct ldb_message *, const char *, const char *)
+ldb_msg_copy_shallow: struct ldb_message *(TALLOC_CTX *, const struct ldb_message *)
+ldb_msg_diff: struct ldb_message *(struct ldb_context *, struct ldb_message *, struct ldb_message *)
+ldb_msg_difference: int (struct ldb_context *, TALLOC_CTX *, struct ldb_message *, struct ldb_message *, struct ldb_message **)
+ldb_msg_element_compare: int (struct ldb_message_element *, struct ldb_message_element *)
+ldb_msg_element_compare_name: int (struct ldb_message_element *, struct ldb_message_element *)
+ldb_msg_element_equal_ordered: bool (const struct ldb_message_element *, const struct ldb_message_element *)
+ldb_msg_find_attr_as_bool: int (const struct ldb_message *, const char *, int)
+ldb_msg_find_attr_as_dn: struct ldb_dn *(struct ldb_context *, TALLOC_CTX *, const struct ldb_message *, const char *)
+ldb_msg_find_attr_as_double: double (const struct ldb_message *, const char *, double)
+ldb_msg_find_attr_as_int: int (const struct ldb_message *, const char *, int)
+ldb_msg_find_attr_as_int64: int64_t (const struct ldb_message *, const char *, int64_t)
+ldb_msg_find_attr_as_string: const char *(const struct ldb_message *, const char *, const char *)
+ldb_msg_find_attr_as_uint: unsigned int (const struct ldb_message *, const char *, unsigned int)
+ldb_msg_find_attr_as_uint64: uint64_t (const struct ldb_message *, const char *, uint64_t)
+ldb_msg_find_common_values: int (struct ldb_context *, TALLOC_CTX *, struct ldb_message_element *, struct ldb_message_element *, uint32_t)
+ldb_msg_find_duplicate_val: int (struct ldb_context *, TALLOC_CTX *, const struct ldb_message_element *, struct ldb_val **, uint32_t)
+ldb_msg_find_element: struct ldb_message_element *(const struct ldb_message *, const char *)
+ldb_msg_find_ldb_val: const struct ldb_val *(const struct ldb_message *, const char *)
+ldb_msg_find_val: struct ldb_val *(const struct ldb_message_element *, struct ldb_val *)
+ldb_msg_new: struct ldb_message *(TALLOC_CTX *)
+ldb_msg_normalize: int (struct ldb_context *, TALLOC_CTX *, const struct ldb_message *, struct ldb_message **)
+ldb_msg_remove_attr: void (struct ldb_message *, const char *)
+ldb_msg_remove_element: void (struct ldb_message *, struct ldb_message_element *)
+ldb_msg_rename_attr: int (struct ldb_message *, const char *, const char *)
+ldb_msg_sanity_check: int (struct ldb_context *, const struct ldb_message *)
+ldb_msg_sort_elements: void (struct ldb_message *)
+ldb_next_del_trans: int (struct ldb_module *)
+ldb_next_end_trans: int (struct ldb_module *)
+ldb_next_init: int (struct ldb_module *)
+ldb_next_prepare_commit: int (struct ldb_module *)
+ldb_next_read_lock: int (struct ldb_module *)
+ldb_next_read_unlock: int (struct ldb_module *)
+ldb_next_remote_request: int (struct ldb_module *, struct ldb_request *)
+ldb_next_request: int (struct ldb_module *, struct ldb_request *)
+ldb_next_start_trans: int (struct ldb_module *)
+ldb_op_default_callback: int (struct ldb_request *, struct ldb_reply *)
+ldb_options_find: const char *(struct ldb_context *, const char **, const char *)
+ldb_pack_data: int (struct ldb_context *, const struct ldb_message *, struct ldb_val *)
+ldb_parse_control_from_string: struct ldb_control *(struct ldb_context *, TALLOC_CTX *, const char *)
+ldb_parse_control_strings: struct ldb_control **(struct ldb_context *, TALLOC_CTX *, const char **)
+ldb_parse_tree: struct ldb_parse_tree *(TALLOC_CTX *, const char *)
+ldb_parse_tree_attr_replace: void (struct ldb_parse_tree *, const char *, const char *)
+ldb_parse_tree_copy_shallow: struct ldb_parse_tree *(TALLOC_CTX *, const struct ldb_parse_tree *)
+ldb_parse_tree_walk: int (struct ldb_parse_tree *, int (*)(struct ldb_parse_tree *, void *), void *)
+ldb_qsort: void (void * const, size_t, size_t, void *, ldb_qsort_cmp_fn_t)
+ldb_register_backend: int (const char *, ldb_connect_fn, bool)
+ldb_register_extended_match_rule: int (struct ldb_context *, const struct ldb_extended_match_rule *)
+ldb_register_hook: int (ldb_hook_fn)
+ldb_register_module: int (const struct ldb_module_ops *)
+ldb_rename: int (struct ldb_context *, struct ldb_dn *, struct ldb_dn *)
+ldb_reply_add_control: int (struct ldb_reply *, const char *, bool, void *)
+ldb_reply_get_control: struct ldb_control *(struct ldb_reply *, const char *)
+ldb_req_get_custom_flags: uint32_t (struct ldb_request *)
+ldb_req_is_untrusted: bool (struct ldb_request *)
+ldb_req_location: const char *(struct ldb_request *)
+ldb_req_mark_trusted: void (struct ldb_request *)
+ldb_req_mark_untrusted: void (struct ldb_request *)
+ldb_req_set_custom_flags: void (struct ldb_request *, uint32_t)
+ldb_req_set_location: void (struct ldb_request *, const char *)
+ldb_request: int (struct ldb_context *, struct ldb_request *)
+ldb_request_add_control: int (struct ldb_request *, const char *, bool, void *)
+ldb_request_done: int (struct ldb_request *, int)
+ldb_request_get_control: struct ldb_control *(struct ldb_request *, const char *)
+ldb_request_get_status: int (struct ldb_request *)
+ldb_request_replace_control: int (struct ldb_request *, const char *, bool, void *)
+ldb_request_set_state: void (struct ldb_request *, int)
+ldb_reset_err_string: void (struct ldb_context *)
+ldb_save_controls: int (struct ldb_control *, struct ldb_request *, struct ldb_control ***)
+ldb_schema_attribute_add: int (struct ldb_context *, const char *, unsigned int, const char *)
+ldb_schema_attribute_add_with_syntax: int (struct ldb_context *, const char *, unsigned int, const struct ldb_schema_syntax *)
+ldb_schema_attribute_by_name: const struct ldb_schema_attribute *(struct ldb_context *, const char *)
+ldb_schema_attribute_fill_with_syntax: int (struct ldb_context *, TALLOC_CTX *, const char *, unsigned int, const struct ldb_schema_syntax *, struct ldb_schema_attribute *)
+ldb_schema_attribute_remove: void (struct ldb_context *, const char *)
+ldb_schema_attribute_remove_flagged: void (struct ldb_context *, unsigned int)
+ldb_schema_attribute_set_override_handler: void (struct ldb_context *, ldb_attribute_handler_override_fn_t, void *)
+ldb_schema_set_override_GUID_index: void (struct ldb_context *, const char *, const char *)
+ldb_schema_set_override_indexlist: void (struct ldb_context *, bool)
+ldb_search: int (struct ldb_context *, TALLOC_CTX *, struct ldb_result **, struct ldb_dn *, enum ldb_scope, const char * const *, const char *, ...)
+ldb_search_default_callback: int (struct ldb_request *, struct ldb_reply *)
+ldb_sequence_number: int (struct ldb_context *, enum ldb_sequence_type, uint64_t *)
+ldb_set_create_perms: void (struct ldb_context *, unsigned int)
+ldb_set_debug: int (struct ldb_context *, void (*)(void *, enum ldb_debug_level, const char *, va_list), void *)
+ldb_set_debug_stderr: int (struct ldb_context *)
+ldb_set_default_dns: void (struct ldb_context *)
+ldb_set_errstring: void (struct ldb_context *, const char *)
+ldb_set_event_context: void (struct ldb_context *, struct tevent_context *)
+ldb_set_flags: void (struct ldb_context *, unsigned int)
+ldb_set_modules_dir: void (struct ldb_context *, const char *)
+ldb_set_opaque: int (struct ldb_context *, const char *, void *)
+ldb_set_require_private_event_context: void (struct ldb_context *)
+ldb_set_timeout: int (struct ldb_context *, struct ldb_request *, int)
+ldb_set_timeout_from_prev_req: int (struct ldb_context *, struct ldb_request *, struct ldb_request *)
+ldb_set_utf8_default: void (struct ldb_context *)
+ldb_set_utf8_fns: void (struct ldb_context *, void *, char *(*)(void *, void *, const char *, size_t))
+ldb_setup_wellknown_attributes: int (struct ldb_context *)
+ldb_should_b64_encode: int (struct ldb_context *, const struct ldb_val *)
+ldb_standard_syntax_by_name: const struct ldb_schema_syntax *(struct ldb_context *, const char *)
+ldb_strerror: const char *(int)
+ldb_string_to_time: time_t (const char *)
+ldb_string_utc_to_time: time_t (const char *)
+ldb_timestring: char *(TALLOC_CTX *, time_t)
+ldb_timestring_utc: char *(TALLOC_CTX *, time_t)
+ldb_transaction_cancel: int (struct ldb_context *)
+ldb_transaction_cancel_noerr: int (struct ldb_context *)
+ldb_transaction_commit: int (struct ldb_context *)
+ldb_transaction_prepare_commit: int (struct ldb_context *)
+ldb_transaction_start: int (struct ldb_context *)
+ldb_unpack_data: int (struct ldb_context *, const struct ldb_val *, struct ldb_message *)
+ldb_unpack_data_only_attr_list: int (struct ldb_context *, const struct ldb_val *, struct ldb_message *, const char * const *, unsigned int, unsigned int *)
+ldb_unpack_data_only_attr_list_flags: int (struct ldb_context *, const struct ldb_val *, struct ldb_message *, const char * const *, unsigned int, unsigned int, unsigned int *)
+ldb_val_dup: struct ldb_val (TALLOC_CTX *, const struct ldb_val *)
+ldb_val_equal_exact: int (const struct ldb_val *, const struct ldb_val *)
+ldb_val_map_local: struct ldb_val (struct ldb_module *, void *, const struct ldb_map_attribute *, const struct ldb_val *)
+ldb_val_map_remote: struct ldb_val (struct ldb_module *, void *, const struct ldb_map_attribute *, const struct ldb_val *)
+ldb_val_string_cmp: int (const struct ldb_val *, const char *)
+ldb_val_to_time: int (const struct ldb_val *, time_t *)
+ldb_valid_attr_name: int (const char *)
+ldb_vdebug: void (struct ldb_context *, enum ldb_debug_level, const char *, va_list)
+ldb_wait: int (struct ldb_handle *, enum ldb_wait_type)
diff -Npur samba-4.8.4/lib/ldb/ABI/pyldb-util-1.3.6.sigs samba-4.8.5/lib/ldb/ABI/pyldb-util-1.3.6.sigs
--- samba-4.8.4/lib/ldb/ABI/pyldb-util-1.3.6.sigs	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/lib/ldb/ABI/pyldb-util-1.3.6.sigs	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,2 @@
+pyldb_Dn_FromDn: PyObject *(struct ldb_dn *)
+pyldb_Object_AsDn: bool (TALLOC_CTX *, PyObject *, struct ldb_context *, struct ldb_dn **)
diff -Npur samba-4.8.4/lib/ldb/ABI/pyldb-util.py3-1.3.6.sigs samba-4.8.5/lib/ldb/ABI/pyldb-util.py3-1.3.6.sigs
--- samba-4.8.4/lib/ldb/ABI/pyldb-util.py3-1.3.6.sigs	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/lib/ldb/ABI/pyldb-util.py3-1.3.6.sigs	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,2 @@
+pyldb_Dn_FromDn: PyObject *(struct ldb_dn *)
+pyldb_Object_AsDn: bool (TALLOC_CTX *, PyObject *, struct ldb_context *, struct ldb_dn **)
diff -Npur samba-4.8.4/lib/ldb/tests/ldb_mod_op_test.c samba-4.8.5/lib/ldb/tests/ldb_mod_op_test.c
--- samba-4.8.4/lib/ldb/tests/ldb_mod_op_test.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/lib/ldb/tests/ldb_mod_op_test.c	2018-08-24 09:58:20.000000000 +0200
@@ -3314,7 +3314,7 @@ static int ldb_unique_index_test_setup(v
 		"dn: @INDEXLIST\n"
 		"@IDXATTR: cn\n"
 		"\n";
-	const char *options[] = {"modules:unique_index_test"};
+	const char *options[] = {"modules:unique_index_test", NULL};
 
 
 	ret = ldb_register_module(&ldb_unique_index_test_module_ops);
@@ -3416,7 +3416,7 @@ static int ldb_non_unique_index_test_set
 		"dn: @INDEXLIST\n"
 		"@IDXATTR: cn\n"
 		"\n";
-	const char *options[] = {"modules:unique_index_test"};
+	const char *options[] = {"modules:unique_index_test", NULL};
 
 
 	ret = ldb_register_module(&ldb_unique_index_test_module_ops);
diff -Npur samba-4.8.4/lib/ldb/wscript samba-4.8.5/lib/ldb/wscript
--- samba-4.8.4/lib/ldb/wscript	2018-08-11 08:16:04.000000000 +0200
+++ samba-4.8.5/lib/ldb/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -1,7 +1,7 @@
 #!/usr/bin/env python
 
 APPNAME = 'ldb'
-VERSION = '1.3.5'
+VERSION = '1.3.6'
 
 blddir = 'bin'
 
@@ -63,23 +63,33 @@ def configure(conf):
     conf.env.standalone_ldb = conf.IN_LAUNCH_DIR()
 
     if not conf.env.standalone_ldb:
+        max_ldb_version = [int(x) for x in VERSION.split(".")]
+        max_ldb_version[2] = 999
+        max_ldb_version_dots = "%d.%d.%d" % tuple(max_ldb_version)
+
         if conf.env.disable_python:
-            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb', minversion=VERSION,
-                                         onlyif='talloc tdb tevent',
-                                         implied_deps='replace talloc tdb tevent'):
+            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb',
+                                             minversion=VERSION,
+                                             maxversion=max_ldb_version_dots,
+                                             onlyif='talloc tdb tevent',
+                                             implied_deps='replace talloc tdb tevent'):
                 conf.define('USING_SYSTEM_LDB', 1)
         else:
             using_system_pyldb_util = True
-            if not conf.CHECK_BUNDLED_SYSTEM_PKG('pyldb-util', minversion=VERSION,
-                                             onlyif='talloc tdb tevent',
-                                             implied_deps='replace talloc tdb tevent ldb'):
+            if not conf.CHECK_BUNDLED_SYSTEM_PKG('pyldb-util',
+                                                 minversion=VERSION,
+                                                 maxversion=max_ldb_version_dots,
+                                                 onlyif='talloc tdb tevent',
+                                                 implied_deps='replace talloc tdb tevent ldb'):
                 using_system_pyldb_util = False
 
             # We need to get a pyldb-util for all the python versions
             # we are building for
             if conf.env['EXTRA_PYTHON']:
                 name = 'pyldb-util' + conf.all_envs['extrapython']['PYTHON_SO_ABI_FLAG']
-                if not conf.CHECK_BUNDLED_SYSTEM_PKG(name, minversion=VERSION,
+                if not conf.CHECK_BUNDLED_SYSTEM_PKG(name,
+                                                     minversion=VERSION,
+                                                     maxversion=max_ldb_version_dots,
                                                      onlyif='talloc tdb tevent',
                                                      implied_deps='replace talloc tdb tevent ldb'):
                     using_system_pyldb_util = False
@@ -87,9 +97,11 @@ def configure(conf):
             if using_system_pyldb_util:
                 conf.define('USING_SYSTEM_PYLDB_UTIL', 1)
 
-            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb', minversion=VERSION,
-                                         onlyif='talloc tdb tevent pyldb-util',
-                                         implied_deps='replace talloc tdb tevent'):
+            if conf.CHECK_BUNDLED_SYSTEM_PKG('ldb',
+                                             minversion=VERSION,
+                                             maxversion=max_ldb_version_dots,
+                                             onlyif='talloc tdb tevent pyldb-util',
+                                             implied_deps='replace talloc tdb tevent'):
                 conf.define('USING_SYSTEM_LDB', 1)
 
     if conf.CONFIG_SET('USING_SYSTEM_LDB'):
diff -Npur samba-4.8.4/lib/replace/wscript samba-4.8.5/lib/replace/wscript
--- samba-4.8.4/lib/replace/wscript	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/lib/replace/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -632,6 +632,10 @@ removeea setea
                                 headers='sys/socket.h netinet/in.h',
                                 define='HAVE_SOCK_SIN_LEN')
 
+    conf.CHECK_STRUCTURE_MEMBER('struct sockaddr_in6', 'sin6_len',
+                                headers='sys/socket.h netinet/in.h',
+                                define='HAVE_SOCK_SIN6_LEN')
+
     conf.CHECK_CODE('struct sockaddr_un sunaddr; sunaddr.sun_family = AF_UNIX;',
                     define='HAVE_UNIXSOCKET', headers='sys/socket.h sys/un.h')
 
diff -Npur samba-4.8.4/lib/tdb/tools/tdbtool.c samba-4.8.5/lib/tdb/tools/tdbtool.c
--- samba-4.8.4/lib/tdb/tools/tdbtool.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/lib/tdb/tools/tdbtool.c	2018-08-24 09:58:20.000000000 +0200
@@ -36,7 +36,7 @@ char *line;
 TDB_DATA iterate_kbuf;
 char cmdline[1024];
 static int disable_mmap;
-static int disable_lock;
+static int _disable_lock;
 
 enum commands {
 	CMD_CREATE_TDB,
@@ -263,7 +263,7 @@ static void create_tdb(const char *tdbna
 	tdb = tdb_open_ex(tdbname, 0,
 			  TDB_CLEAR_IF_FIRST |
 			  (disable_mmap?TDB_NOMMAP:0) |
-			  (disable_lock?TDB_NOLOCK:0),
+			  (_disable_lock?TDB_NOLOCK:0),
 			  O_RDWR | O_CREAT | O_TRUNC, 0600, &log_ctx, NULL);
 	if (!tdb) {
 		printf("Could not create %s: %s\n", tdbname, strerror(errno));
@@ -278,7 +278,7 @@ static void open_tdb(const char *tdbname
 	if (tdb) tdb_close(tdb);
 	tdb = tdb_open_ex(tdbname, 0,
 			  (disable_mmap?TDB_NOMMAP:0) |
-			  (disable_lock?TDB_NOLOCK:0),
+			  (_disable_lock?TDB_NOLOCK:0),
 			  O_RDWR, 0600,
 			  &log_ctx, NULL);
 
@@ -890,7 +890,7 @@ int main(int argc, char *argv[])
 	arg2len = 0;
 
 	if (argv[1] && (strcmp(argv[1], "-l") == 0)) {
-		disable_lock = 1;
+		_disable_lock = 1;
 		argv[1] = argv[0];
 		argv += 1;
 		argc -= 1;
diff -Npur samba-4.8.4/lib/util/smb_threads.h samba-4.8.5/lib/util/smb_threads.h
--- samba-4.8.4/lib/util/smb_threads.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/lib/util/smb_threads.h	2018-08-24 09:58:20.000000000 +0200
@@ -119,6 +119,9 @@ static int smb_set_tls_pthread(void *pke
  \
 static void *smb_get_tls_pthread(void *pkey, const char *location) \
 { \
+	if (pkey == NULL) { \
+		return NULL; \
+	} \
         return pthread_getspecific(*(pthread_key_t *)pkey); \
 } \
  \
diff -Npur samba-4.8.4/librpc/idl/quota.idl samba-4.8.5/librpc/idl/quota.idl
--- samba-4.8.4/librpc/idl/quota.idl	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/librpc/idl/quota.idl	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,54 @@
+#include "idl_types.h"
+
+import "security.idl";
+
+[
+	pointer_default(unique)
+]
+
+interface file_quota {
+
+	/* MS-FSCC 2.4.33.1 */
+	typedef [public] struct {
+		uint32 next_entry_offset;
+		uint32 sid_length;
+		dom_sid sid;
+	} file_get_quota_info;
+
+	/* MS-FSCC 2.4.33 */
+	typedef [public] struct {
+		uint32 next_entry_offset;
+		uint32 sid_length;
+		hyper change_time;
+		hyper quota_used;
+		hyper quota_threshold;
+		hyper quota_limit;
+		dom_sid sid;
+	} file_quota_information;
+}
+
+interface smb2_query_quoata
+{
+	/* MS-SMB2 2.2.37.1 */
+	typedef [public] struct {
+		uint8 return_single;
+		uint8 restart_scan;
+		uint16 reserved;
+		uint32 sid_list_length;
+		uint32 start_sid_length;
+		uint32 start_sid_offset;
+	} smb2_query_quota_info;
+}
+
+interface smb1_nt_transact_query_quota
+{
+	/* MS-SMB 2.2.7.5.1 */
+	typedef [public] struct {
+		uint16 fid;
+		uint8 return_single_entry;
+		uint8 restart_scan;
+		uint32 sid_list_length;
+		uint32 start_sid_length;
+		uint32 start_sid_offset;
+	} nttrans_query_quota_params;
+}
diff -Npur samba-4.8.4/librpc/idl/wscript_build samba-4.8.5/librpc/idl/wscript_build
--- samba-4.8.4/librpc/idl/wscript_build	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/librpc/idl/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -38,6 +38,7 @@ bld.SAMBA_PIDL_LIST('PIDL',
                     fsrvp_state.idl
                     cab.idl
                     nfs4acl.idl
+                    quota.idl
                     ''',
                     options='--header --ndr-parser',
                     output_dir='../gen_ndr')
diff -Npur samba-4.8.4/librpc/rpc/binding.c samba-4.8.5/librpc/rpc/binding.c
--- samba-4.8.4/librpc/rpc/binding.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/librpc/rpc/binding.c	2018-08-24 09:58:20.000000000 +0200
@@ -103,6 +103,7 @@ static const struct ncacn_option {
 	{"print", DCERPC_DEBUG_PRINT_BOTH},
 	{"padcheck", DCERPC_DEBUG_PAD_CHECK},
 	{"bigendian", DCERPC_PUSH_BIGENDIAN},
+	{"smb1", DCERPC_SMB1},
 	{"smb2", DCERPC_SMB2},
 	{"ndr64", DCERPC_NDR64},
 	{"packet", DCERPC_PACKET},
diff -Npur samba-4.8.4/librpc/rpc/rpc_common.h samba-4.8.5/librpc/rpc/rpc_common.h
--- samba-4.8.4/librpc/rpc/rpc_common.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/librpc/rpc/rpc_common.h	2018-08-24 09:58:20.000000000 +0200
@@ -108,6 +108,8 @@ struct dcerpc_binding;
 
 #define DCERPC_PACKET			(1<<26)
 
+#define DCERPC_SMB1                    (1<<27)
+
 /* The following definitions come from ../librpc/rpc/dcerpc_error.c  */
 
 const char *dcerpc_errstr(TALLOC_CTX *mem_ctx, uint32_t fault_code);
diff -Npur samba-4.8.4/librpc/wscript_build samba-4.8.5/librpc/wscript_build
--- samba-4.8.4/librpc/wscript_build	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/librpc/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -399,6 +399,11 @@ bld.SAMBA_SUBSYSTEM('NDR_SMB2_LEASE_STRU
     public_headers='gen_ndr/smb2_lease_struct.h'
     )
 
+bld.SAMBA_SUBSYSTEM('NDR_QUOTA',
+    source='gen_ndr/ndr_quota.c',
+    public_deps='ndr',
+    )
+
 bld.SAMBA_SUBSYSTEM('NDR_SCHANNEL',
     source='ndr/ndr_schannel.c gen_ndr/ndr_schannel.c',
     public_deps='ndr ndr_nbt'
diff -Npur samba-4.8.4/nsswitch/krb5_plugin/winbind_krb5_locator.c samba-4.8.5/nsswitch/krb5_plugin/winbind_krb5_locator.c
--- samba-4.8.4/nsswitch/krb5_plugin/winbind_krb5_locator.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/nsswitch/krb5_plugin/winbind_krb5_locator.c	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,418 @@
+/*
+   Unix SMB/CIFS implementation.
+   kerberos locator plugin
+   Copyright (C) Guenther Deschner 2007-2008
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "nsswitch/winbind_client.h"
+#include "libwbclient/wbclient.h"
+
+#ifndef DEBUG_KRB5
+#undef DEBUG_KRB5
+#endif
+
+#if defined(HAVE_KRB5) && defined(HAVE_KRB5_LOCATE_PLUGIN_H)
+
+#if HAVE_COM_ERR_H
+#include <com_err.h>
+#endif
+
+#include <krb5.h>
+#include <krb5/locate_plugin.h>
+
+#ifndef KRB5_PLUGIN_NO_HANDLE
+#define KRB5_PLUGIN_NO_HANDLE KRB5_KDC_UNREACH /* Heimdal */
+#endif
+
+static const char *get_service_from_locate_service_type(enum locate_service_type svc)
+{
+	switch (svc) {
+		case locate_service_kdc:
+		case locate_service_master_kdc:
+			return "88";
+		case locate_service_kadmin:
+		case locate_service_krb524:
+			/* not supported */
+			return NULL;
+		case locate_service_kpasswd:
+			return "464";
+		default:
+			break;
+	}
+	return NULL;
+
+}
+
+#ifdef DEBUG_KRB5
+static const char *locate_service_type_name(enum locate_service_type svc)
+{
+	switch (svc) {
+		case locate_service_kdc:
+			return "locate_service_kdc";
+		case locate_service_master_kdc:
+			return "locate_service_master_kdc";
+		case locate_service_kadmin:
+			return "locate_service_kadmin";
+		case locate_service_krb524:
+			return "locate_service_krb524";
+		case locate_service_kpasswd:
+			return "locate_service_kpasswd";
+		default:
+			break;
+	}
+	return NULL;
+}
+
+static const char *socktype_name(int socktype)
+{
+	switch (socktype) {
+		case SOCK_STREAM:
+			return "SOCK_STREAM";
+		case SOCK_DGRAM:
+			return "SOCK_DGRAM";
+		default:
+			break;
+	}
+	return "unknown";
+}
+
+static const char *family_name(int family)
+{
+	switch (family) {
+		case AF_UNSPEC:
+			return "AF_UNSPEC";
+		case AF_INET:
+			return "AF_INET";
+#if defined(HAVE_IPV6)
+		case AF_INET6:
+			return "AF_INET6";
+#endif
+		default:
+			break;
+	}
+	return "unknown";
+}
+#endif
+
+/**
+ * Check input parameters, return KRB5_PLUGIN_NO_HANDLE for unsupported ones
+ *
+ * @param svc
+ * @param realm string
+ * @param socktype integer
+ * @param family integer
+ *
+ * @return integer.
+ */
+
+static int smb_krb5_locator_lookup_sanity_check(enum locate_service_type svc,
+						const char *realm,
+						int socktype,
+						int family)
+{
+	if (!realm || strlen(realm) == 0) {
+		return EINVAL;
+	}
+
+	switch (svc) {
+		case locate_service_kdc:
+		case locate_service_master_kdc:
+		case locate_service_kpasswd:
+			break;
+		case locate_service_kadmin:
+		case locate_service_krb524:
+			return KRB5_PLUGIN_NO_HANDLE;
+		default:
+			return EINVAL;
+	}
+
+	switch (family) {
+		case AF_UNSPEC:
+		case AF_INET:
+#if defined(HAVE_IPV6)
+		case AF_INET6:
+#endif
+			break;
+		default:
+			return EINVAL;
+	}
+
+	switch (socktype) {
+		case SOCK_STREAM:
+		case SOCK_DGRAM:
+		case 0: /* Heimdal uses that */
+			break;
+		default:
+			return EINVAL;
+	}
+
+	return 0;
+}
+
+/**
+ * Try to get addrinfo for a given host and call the krb5 callback
+ *
+ * @param name string
+ * @param service string
+ * @param in struct addrinfo hint
+ * @param cbfunc krb5 callback function
+ * @param cbdata void pointer cbdata
+ *
+ * @return krb5_error_code.
+ */
+
+static krb5_error_code smb_krb5_locator_call_cbfunc(const char *name,
+						    const char *service,
+						    struct addrinfo *in,
+						    int (*cbfunc)(void *, int, struct sockaddr *),
+						    void *cbdata)
+{
+	struct addrinfo *out = NULL;
+	int ret = 0;
+	struct addrinfo *res = NULL;
+	int count = 3;
+
+	while (count) {
+
+		ret = getaddrinfo(name, service, in, &out);
+		if (ret == 0) {
+			break;
+		}
+
+		if ((ret == EAI_AGAIN) && (count > 1)) {
+			count--;
+			continue;
+		}
+
+#ifdef DEBUG_KRB5
+		fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+			"getaddrinfo failed: %s (%d)\n",
+			(unsigned int)getpid(), gai_strerror(ret), ret);
+#endif
+
+		return KRB5_PLUGIN_NO_HANDLE;
+	}
+
+	for (res = out; res; res = res->ai_next) {
+		if (!res->ai_addr || res->ai_addrlen == 0) {
+			continue;
+		}
+
+		ret = cbfunc(cbdata, res->ai_socktype, res->ai_addr);
+		if (ret) {
+#ifdef DEBUG_KRB5
+			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+				"failed to call callback: %s (%d)\n",
+				(unsigned int)getpid(), error_message(ret), ret);
+#endif
+			break;
+		}
+	}
+
+	if (out) {
+		freeaddrinfo(out);
+	}
+	return ret;
+}
+
+/**
+ * PUBLIC INTERFACE: locate init
+ *
+ * @param context krb5_context
+ * @param privata_data pointer to private data pointer
+ *
+ * @return krb5_error_code.
+ */
+
+static krb5_error_code smb_krb5_locator_init(krb5_context context,
+					     void **private_data)
+{
+	return 0;
+}
+
+/**
+ * PUBLIC INTERFACE: close locate
+ *
+ * @param private_data pointer to private data
+ *
+ * @return void.
+ */
+
+static void smb_krb5_locator_close(void *private_data)
+{
+	return;
+}
+
+
+static bool ask_winbind(const char *realm, char **dcname)
+{
+	wbcErr wbc_status;
+	const char *dc = NULL;
+	struct wbcDomainControllerInfoEx *dc_info = NULL;
+	uint32_t flags;
+
+	flags = WBC_LOOKUP_DC_KDC_REQUIRED |
+		WBC_LOOKUP_DC_IS_DNS_NAME |
+		WBC_LOOKUP_DC_RETURN_DNS_NAME;
+
+	wbc_status = wbcLookupDomainControllerEx(realm, NULL, NULL, flags, &dc_info);
+
+	if (!WBC_ERROR_IS_OK(wbc_status)) {
+#ifdef DEBUG_KRB5
+		fprintf(stderr,"[%5u]: smb_krb5_locator_lookup: failed with: %s\n",
+			(unsigned int)getpid(), wbcErrorString(wbc_status));
+#endif
+		return false;
+	}
+
+	if (!dc && dc_info->dc_unc) {
+		dc = dc_info->dc_unc;
+		if (dc[0] == '\\') dc++;
+		if (dc[0] == '\\') dc++;
+	}
+
+	if (!dc) {
+		wbcFreeMemory(dc_info);
+		return false;
+	}
+
+	*dcname = strdup(dc);
+	if (!*dcname) {
+		wbcFreeMemory(dc_info);
+		return false;
+	}
+
+	wbcFreeMemory(dc_info);
+	return true;
+}
+
+/**
+ * PUBLIC INTERFACE: locate lookup
+ *
+ * @param private_data pointer to private data
+ * @param svc enum locate_service_type.
+ * @param realm string
+ * @param socktype integer
+ * @param family integer
+ * @param cbfunc callback function to send back entries
+ * @param cbdata void pointer to cbdata
+ *
+ * @return krb5_error_code.
+ */
+
+static krb5_error_code smb_krb5_locator_lookup(void *private_data,
+					       enum locate_service_type svc,
+					       const char *realm,
+					       int socktype,
+					       int family,
+					       int (*cbfunc)(void *, int, struct sockaddr *),
+							void *cbdata)
+{
+	krb5_error_code ret;
+	struct addrinfo aihints;
+	char *kdc_name = NULL;
+	const char *service = get_service_from_locate_service_type(svc);
+
+	ZERO_STRUCT(aihints);
+
+#ifdef DEBUG_KRB5
+	fprintf(stderr,"[%5u]: smb_krb5_locator_lookup: called for '%s' "
+			"svc: '%s' (%d) "
+			"socktype: '%s' (%d), family: '%s' (%d)\n",
+			(unsigned int)getpid(), realm,
+			locate_service_type_name(svc), svc,
+			socktype_name(socktype), socktype,
+		        family_name(family), family);
+#endif
+	ret = smb_krb5_locator_lookup_sanity_check(svc, realm, socktype,
+						   family);
+	if (ret) {
+#ifdef DEBUG_KRB5
+		fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+			"returning ret: %s (%d)\n",
+			(unsigned int)getpid(), error_message(ret), ret);
+#endif
+		return ret;
+	}
+
+	if (!winbind_env_set()) {
+		if (!ask_winbind(realm, &kdc_name)) {
+#ifdef DEBUG_KRB5
+			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+				"failed to query winbindd\n",
+				(unsigned int)getpid());
+#endif
+			goto failed;
+		}
+	} else {
+		const char *env = NULL;
+		char *var = NULL;
+		if (asprintf(&var, "%s_%s",
+			     WINBINDD_LOCATOR_KDC_ADDRESS, realm) == -1) {
+			goto failed;
+		}
+		env = getenv(var);
+		if (!env) {
+#ifdef DEBUG_KRB5
+			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+				"failed to get kdc from env %s\n",
+				(unsigned int)getpid(), var);
+#endif
+			free(var);
+			goto failed;
+		}
+		free(var);
+
+		kdc_name = strdup(env);
+		if (!kdc_name) {
+			goto failed;
+		}
+	}
+#ifdef DEBUG_KRB5
+	fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
+		"got '%s' for '%s' from winbindd\n", (unsigned int)getpid(),
+		kdc_name, realm);
+#endif
+
+	aihints.ai_family = family;
+	aihints.ai_socktype = socktype;
+
+	ret = smb_krb5_locator_call_cbfunc(kdc_name,
+					   service,
+					   &aihints,
+					   cbfunc, cbdata);
+	SAFE_FREE(kdc_name);
+
+	return ret;
+
+ failed:
+	return KRB5_PLUGIN_NO_HANDLE;
+}
+
+#ifdef HEIMDAL_KRB5_LOCATE_PLUGIN_H
+#define SMB_KRB5_LOCATOR_SYMBOL_NAME resolve /* Heimdal */
+#else
+#define SMB_KRB5_LOCATOR_SYMBOL_NAME service_locator /* MIT */
+#endif
+
+const krb5plugin_service_locate_ftable SMB_KRB5_LOCATOR_SYMBOL_NAME = {
+	0, /* version */
+	smb_krb5_locator_init,
+	smb_krb5_locator_close,
+	smb_krb5_locator_lookup,
+};
+
+#endif
diff -Npur samba-4.8.4/nsswitch/winbind_krb5_locator.c samba-4.8.5/nsswitch/winbind_krb5_locator.c
--- samba-4.8.4/nsswitch/winbind_krb5_locator.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/nsswitch/winbind_krb5_locator.c	1970-01-01 01:00:00.000000000 +0100
@@ -1,418 +0,0 @@
-/*
-   Unix SMB/CIFS implementation.
-   kerberos locator plugin
-   Copyright (C) Guenther Deschner 2007-2008
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 3 of the License, or
-   (at your option) any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program.  If not, see <http://www.gnu.org/licenses/>.
-*/
-
-#include "nsswitch/winbind_client.h"
-#include "libwbclient/wbclient.h"
-
-#ifndef DEBUG_KRB5
-#undef DEBUG_KRB5
-#endif
-
-#if defined(HAVE_KRB5) && defined(HAVE_KRB5_LOCATE_PLUGIN_H)
-
-#if HAVE_COM_ERR_H
-#include <com_err.h>
-#endif
-
-#include <krb5.h>
-#include <krb5/locate_plugin.h>
-
-#ifndef KRB5_PLUGIN_NO_HANDLE
-#define KRB5_PLUGIN_NO_HANDLE KRB5_KDC_UNREACH /* Heimdal */
-#endif
-
-static const char *get_service_from_locate_service_type(enum locate_service_type svc)
-{
-	switch (svc) {
-		case locate_service_kdc:
-		case locate_service_master_kdc:
-			return "88";
-		case locate_service_kadmin:
-		case locate_service_krb524:
-			/* not supported */
-			return NULL;
-		case locate_service_kpasswd:
-			return "464";
-		default:
-			break;
-	}
-	return NULL;
-
-}
-
-#ifdef DEBUG_KRB5
-static const char *locate_service_type_name(enum locate_service_type svc)
-{
-	switch (svc) {
-		case locate_service_kdc:
-			return "locate_service_kdc";
-		case locate_service_master_kdc:
-			return "locate_service_master_kdc";
-		case locate_service_kadmin:
-			return "locate_service_kadmin";
-		case locate_service_krb524:
-			return "locate_service_krb524";
-		case locate_service_kpasswd:
-			return "locate_service_kpasswd";
-		default:
-			break;
-	}
-	return NULL;
-}
-
-static const char *socktype_name(int socktype)
-{
-	switch (socktype) {
-		case SOCK_STREAM:
-			return "SOCK_STREAM";
-		case SOCK_DGRAM:
-			return "SOCK_DGRAM";
-		default:
-			break;
-	}
-	return "unknown";
-}
-
-static const char *family_name(int family)
-{
-	switch (family) {
-		case AF_UNSPEC:
-			return "AF_UNSPEC";
-		case AF_INET:
-			return "AF_INET";
-#if defined(HAVE_IPV6)
-		case AF_INET6:
-			return "AF_INET6";
-#endif
-		default:
-			break;
-	}
-	return "unknown";
-}
-#endif
-
-/**
- * Check input parameters, return KRB5_PLUGIN_NO_HANDLE for unsupported ones
- *
- * @param svc
- * @param realm string
- * @param socktype integer
- * @param family integer
- *
- * @return integer.
- */
-
-static int smb_krb5_locator_lookup_sanity_check(enum locate_service_type svc,
-						const char *realm,
-						int socktype,
-						int family)
-{
-	if (!realm || strlen(realm) == 0) {
-		return EINVAL;
-	}
-
-	switch (svc) {
-		case locate_service_kdc:
-		case locate_service_master_kdc:
-		case locate_service_kpasswd:
-			break;
-		case locate_service_kadmin:
-		case locate_service_krb524:
-			return KRB5_PLUGIN_NO_HANDLE;
-		default:
-			return EINVAL;
-	}
-
-	switch (family) {
-		case AF_UNSPEC:
-		case AF_INET:
-#if defined(HAVE_IPV6)
-		case AF_INET6:
-#endif
-			break;
-		default:
-			return EINVAL;
-	}
-
-	switch (socktype) {
-		case SOCK_STREAM:
-		case SOCK_DGRAM:
-		case 0: /* Heimdal uses that */
-			break;
-		default:
-			return EINVAL;
-	}
-
-	return 0;
-}
-
-/**
- * Try to get addrinfo for a given host and call the krb5 callback
- *
- * @param name string
- * @param service string
- * @param in struct addrinfo hint
- * @param cbfunc krb5 callback function
- * @param cbdata void pointer cbdata
- *
- * @return krb5_error_code.
- */
-
-static krb5_error_code smb_krb5_locator_call_cbfunc(const char *name,
-						    const char *service,
-						    struct addrinfo *in,
-						    int (*cbfunc)(void *, int, struct sockaddr *),
-						    void *cbdata)
-{
-	struct addrinfo *out = NULL;
-	int ret = 0;
-	struct addrinfo *res = NULL;
-	int count = 3;
-
-	while (count) {
-
-		ret = getaddrinfo(name, service, in, &out);
-		if (ret == 0) {
-			break;
-		}
-
-		if ((ret == EAI_AGAIN) && (count > 1)) {
-			count--;
-			continue;
-		}
-
-#ifdef DEBUG_KRB5
-		fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-			"getaddrinfo failed: %s (%d)\n",
-			(unsigned int)getpid(), gai_strerror(ret), ret);
-#endif
-
-		return KRB5_PLUGIN_NO_HANDLE;
-	}
-
-	for (res = out; res; res = res->ai_next) {
-		if (!res->ai_addr || res->ai_addrlen == 0) {
-			continue;
-		}
-
-		ret = cbfunc(cbdata, res->ai_socktype, res->ai_addr);
-		if (ret) {
-#ifdef DEBUG_KRB5
-			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-				"failed to call callback: %s (%d)\n",
-				(unsigned int)getpid(), error_message(ret), ret);
-#endif
-			break;
-		}
-	}
-
-	if (out) {
-		freeaddrinfo(out);
-	}
-	return ret;
-}
-
-/**
- * PUBLIC INTERFACE: locate init
- *
- * @param context krb5_context
- * @param privata_data pointer to private data pointer
- *
- * @return krb5_error_code.
- */
-
-static krb5_error_code smb_krb5_locator_init(krb5_context context,
-					     void **private_data)
-{
-	return 0;
-}
-
-/**
- * PUBLIC INTERFACE: close locate
- *
- * @param private_data pointer to private data
- *
- * @return void.
- */
-
-static void smb_krb5_locator_close(void *private_data)
-{
-	return;
-}
-
-
-static bool ask_winbind(const char *realm, char **dcname)
-{
-	wbcErr wbc_status;
-	const char *dc = NULL;
-	struct wbcDomainControllerInfoEx *dc_info = NULL;
-	uint32_t flags;
-
-	flags = WBC_LOOKUP_DC_KDC_REQUIRED |
-		WBC_LOOKUP_DC_IS_DNS_NAME |
-		WBC_LOOKUP_DC_RETURN_DNS_NAME;
-
-	wbc_status = wbcLookupDomainControllerEx(realm, NULL, NULL, flags, &dc_info);
-
-	if (!WBC_ERROR_IS_OK(wbc_status)) {
-#ifdef DEBUG_KRB5
-		fprintf(stderr,"[%5u]: smb_krb5_locator_lookup: failed with: %s\n",
-			(unsigned int)getpid(), wbcErrorString(wbc_status));
-#endif
-		return false;
-	}
-
-	if (!dc && dc_info->dc_unc) {
-		dc = dc_info->dc_unc;
-		if (dc[0] == '\\') dc++;
-		if (dc[0] == '\\') dc++;
-	}
-
-	if (!dc) {
-		wbcFreeMemory(dc_info);
-		return false;
-	}
-
-	*dcname = strdup(dc);
-	if (!*dcname) {
-		wbcFreeMemory(dc_info);
-		return false;
-	}
-
-	wbcFreeMemory(dc_info);
-	return true;
-}
-
-/**
- * PUBLIC INTERFACE: locate lookup
- *
- * @param private_data pointer to private data
- * @param svc enum locate_service_type.
- * @param realm string
- * @param socktype integer
- * @param family integer
- * @param cbfunc callback function to send back entries
- * @param cbdata void pointer to cbdata
- *
- * @return krb5_error_code.
- */
-
-static krb5_error_code smb_krb5_locator_lookup(void *private_data,
-					       enum locate_service_type svc,
-					       const char *realm,
-					       int socktype,
-					       int family,
-					       int (*cbfunc)(void *, int, struct sockaddr *),
-							void *cbdata)
-{
-	krb5_error_code ret;
-	struct addrinfo aihints;
-	char *kdc_name = NULL;
-	const char *service = get_service_from_locate_service_type(svc);
-
-	ZERO_STRUCT(aihints);
-
-#ifdef DEBUG_KRB5
-	fprintf(stderr,"[%5u]: smb_krb5_locator_lookup: called for '%s' "
-			"svc: '%s' (%d) "
-			"socktype: '%s' (%d), family: '%s' (%d)\n",
-			(unsigned int)getpid(), realm,
-			locate_service_type_name(svc), svc,
-			socktype_name(socktype), socktype,
-		        family_name(family), family);
-#endif
-	ret = smb_krb5_locator_lookup_sanity_check(svc, realm, socktype,
-						   family);
-	if (ret) {
-#ifdef DEBUG_KRB5
-		fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-			"returning ret: %s (%d)\n",
-			(unsigned int)getpid(), error_message(ret), ret);
-#endif
-		return ret;
-	}
-
-	if (!winbind_env_set()) {
-		if (!ask_winbind(realm, &kdc_name)) {
-#ifdef DEBUG_KRB5
-			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-				"failed to query winbindd\n",
-				(unsigned int)getpid());
-#endif
-			goto failed;
-		}
-	} else {
-		const char *env = NULL;
-		char *var = NULL;
-		if (asprintf(&var, "%s_%s",
-			     WINBINDD_LOCATOR_KDC_ADDRESS, realm) == -1) {
-			goto failed;
-		}
-		env = getenv(var);
-		if (!env) {
-#ifdef DEBUG_KRB5
-			fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-				"failed to get kdc from env %s\n",
-				(unsigned int)getpid(), var);
-#endif
-			free(var);
-			goto failed;
-		}
-		free(var);
-
-		kdc_name = strdup(env);
-		if (!kdc_name) {
-			goto failed;
-		}
-	}
-#ifdef DEBUG_KRB5
-	fprintf(stderr, "[%5u]: smb_krb5_locator_lookup: "
-		"got '%s' for '%s' from winbindd\n", (unsigned int)getpid(),
-		kdc_name, realm);
-#endif
-
-	aihints.ai_family = family;
-	aihints.ai_socktype = socktype;
-
-	ret = smb_krb5_locator_call_cbfunc(kdc_name,
-					   service,
-					   &aihints,
-					   cbfunc, cbdata);
-	SAFE_FREE(kdc_name);
-
-	return ret;
-
- failed:
-	return KRB5_PLUGIN_NO_HANDLE;
-}
-
-#ifdef HEIMDAL_KRB5_LOCATE_PLUGIN_H
-#define SMB_KRB5_LOCATOR_SYMBOL_NAME resolve /* Heimdal */
-#else
-#define SMB_KRB5_LOCATOR_SYMBOL_NAME service_locator /* MIT */
-#endif
-
-const krb5plugin_service_locate_ftable SMB_KRB5_LOCATOR_SYMBOL_NAME = {
-	0, /* version */
-	smb_krb5_locator_init,
-	smb_krb5_locator_close,
-	smb_krb5_locator_lookup,
-};
-
-#endif
diff -Npur samba-4.8.4/nsswitch/wscript_build samba-4.8.5/nsswitch/wscript_build
--- samba-4.8.4/nsswitch/wscript_build	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/nsswitch/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -105,16 +105,18 @@ if bld.CONFIG_SET('WITH_PAM_MODULES') an
 		)
 
 if bld.CONFIG_SET('HAVE_KRB5_LOCATE_PLUGIN_H'):
-	bld.SAMBA_LIBRARY('winbind_krb5_locator',
-		source='winbind_krb5_locator.c',
-		deps='wbclient krb5 com_err',
-		realname='winbind_krb5_locator.so')
+    bld.SAMBA_LIBRARY('winbind_krb5_locator',
+                      source='krb5_plugin/winbind_krb5_locator.c',
+                      deps='wbclient krb5 com_err',
+                      realname='winbind_krb5_locator.so',
+                      install_path='${MODULESDIR}/krb5')
 
 if bld.CONFIG_SET('HAVE_KRB5_LOCALAUTH_PLUGIN_H'):
     bld.SAMBA_LIBRARY('winbind_krb5_localauth',
                       source='krb5_plugin/winbind_krb5_localauth.c',
                       deps='wbclient krb5 com_err',
-                      realname='winbind-krb5-localauth.so')
+                      realname='winbind_krb5_localauth.so',
+                      install_path='${MODULESDIR}/krb5')
 
 bld.SAMBA_SUBSYSTEM('WB_REQTRANS',
 	source='wb_reqtrans.c',
diff -Npur samba-4.8.4/packaging/systemd/smb.service.in samba-4.8.5/packaging/systemd/smb.service.in
--- samba-4.8.4/packaging/systemd/smb.service.in	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/packaging/systemd/smb.service.in	2018-08-24 09:58:20.000000000 +0200
@@ -1,7 +1,8 @@
 [Unit]
 Description=Samba SMB Daemon
 Documentation=man:smbd(8) man:samba(7) man:smb.conf(5)
-After=network.target nmb.service winbind.service
+Wants=network-online.target
+After=network.target network-online.target nmb.service winbind.service
 
 [Service]
 Type=notify
diff -Npur samba-4.8.4/python/samba/netcmd/domain.py samba-4.8.5/python/samba/netcmd/domain.py
--- samba-4.8.4/python/samba/netcmd/domain.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/python/samba/netcmd/domain.py	2018-08-24 09:58:20.000000000 +0200
@@ -1824,6 +1824,15 @@ class DomainTrustCommand(Command):
 
         return (policy, info)
 
+    def get_netlogon_dc_unc(self, conn, server, domain):
+        try:
+            info = conn.netr_DsRGetDCNameEx2(server,
+                                             None, 0, None, None, None,
+                                             netlogon.DS_RETURN_DNS_NAME)
+            return info.dc_unc
+        except RuntimeError:
+            return conn.netr_GetDcName(server, domain)
+
     def get_netlogon_dc_info(self, conn, server):
         info = conn.netr_DsRGetDCNameEx2(server,
                                          None, 0, None, None, None,
@@ -2458,7 +2467,8 @@ class cmd_domain_trust_create(DomainTrus
                 raise self.RemoteRuntimeError(self, error, "failed to connect netlogon server")
 
             try:
-                remote_netlogon_info = self.get_netlogon_dc_info(remote_netlogon, remote_server)
+                remote_netlogon_dc_unc = self.get_netlogon_dc_unc(remote_netlogon,
+                                                                  remote_server, domain)
             except RuntimeError as error:
                 raise self.RemoteRuntimeError(self, error, "failed to get netlogon dc info")
 
@@ -2608,9 +2618,9 @@ class cmd_domain_trust_create(DomainTrus
                         # this triggers netr_GetForestTrustInformation to our domain.
                         # and lsaRSetForestTrustInformation() remotely, but new top level
                         # names are disabled by default.
-                        remote_forest_info = remote_netlogon.netr_DsRGetForestTrustInformation(remote_netlogon_info.dc_unc,
-                                                                      local_lsa_info.dns_domain.string,
-                                                                      netlogon.DS_GFTI_UPDATE_TDO)
+                        remote_forest_info = remote_netlogon.netr_DsRGetForestTrustInformation(remote_netlogon_dc_unc,
+                                                                                               local_lsa_info.dns_domain.string,
+                                                                                               netlogon.DS_GFTI_UPDATE_TDO)
                     except RuntimeError as error:
                         raise self.RemoteRuntimeError(self, error, "netr_DsRGetForestTrustInformation() failed")
 
@@ -2661,10 +2671,10 @@ class cmd_domain_trust_create(DomainTrus
                 if remote_trust_info.trust_direction & lsa.LSA_TRUST_DIRECTION_OUTBOUND:
                     self.outf.write("Validating incoming trust...\n")
                     try:
-                        remote_trust_verify = remote_netlogon.netr_LogonControl2Ex(remote_netlogon_info.dc_unc,
-                                                                      netlogon.NETLOGON_CONTROL_TC_VERIFY,
-                                                                      2,
-                                                                      local_lsa_info.dns_domain.string)
+                        remote_trust_verify = remote_netlogon.netr_LogonControl2Ex(remote_netlogon_dc_unc,
+                                                                                   netlogon.NETLOGON_CONTROL_TC_VERIFY,
+                                                                                   2,
+                                                                                   local_lsa_info.dns_domain.string)
                     except RuntimeError as error:
                         raise self.RemoteRuntimeError(self, error, "NETLOGON_CONTROL_TC_VERIFY failed")
 
diff -Npur samba-4.8.4/python/samba/tests/auth_log.py samba-4.8.5/python/samba/tests/auth_log.py
--- samba-4.8.4/python/samba/tests/auth_log.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/python/samba/tests/auth_log.py	2018-08-24 09:58:20.000000000 +0200
@@ -33,6 +33,7 @@ from samba.credentials import Credential
 from samba import NTSTATUSError
 from subprocess import call
 from ldb import LdbError
+import re
 
 class AuthLogTests(samba.tests.auth_log_base.AuthLogTestBase):
 
@@ -71,6 +72,20 @@ class AuthLogTests(samba.tests.auth_log_
         messages = self.waitForMessages(isLastExpectedMessage, x)
         checkFunction(messages, authTypes, service, binding, protection)
 
+    def _assert_ncacn_np_serviceDescription(self, binding, serviceDescription):
+        # Turn "[foo,bar]" into a list ("foo", "bar") to test
+        # lambda x: x removes anything that evaluates to False,
+        # including empty strings, so we handle "" as well
+        binding_list = filter(lambda x: x, re.compile('[\[,\]]').split(binding))
+
+        # Handle explicit smb2, smb1 or auto negotiation
+        if "smb2" in binding_list:
+            self.assertEquals(serviceDescription, "SMB2")
+        elif "smb1" in binding_list:
+            self.assertEquals(serviceDescription, "SMB")
+        else:
+            self.assertIn(serviceDescription, ["SMB", "SMB2"])
+
     def rpc_ncacn_np_ntlm_check(self, messages, authTypes, service,
                                 binding, protection):
 
@@ -83,14 +98,14 @@ class AuthLogTests(samba.tests.auth_log_
         msg = messages[0]
         self.assertEquals("Authentication", msg["type"])
         self.assertEquals("NT_STATUS_OK", msg["Authentication"]["status"])
-        self.assertEquals("SMB",
-                           msg["Authentication"]["serviceDescription"])
+        self._assert_ncacn_np_serviceDescription(binding,
+                          msg["Authentication"]["serviceDescription"])
         self.assertEquals(authTypes[1], msg["Authentication"]["authDescription"])
 
         # Check the second message it should be an Authorization
         msg = messages[1]
         self.assertEquals("Authorization", msg["type"])
-        self.assertEquals("SMB",
+        self._assert_ncacn_np_serviceDescription(binding,
                           msg["Authorization"]["serviceDescription"])
         self.assertEquals(authTypes[2], msg["Authorization"]["authType"])
         self.assertEquals("SMB", msg["Authorization"]["transportProtection"])
@@ -139,12 +154,7 @@ class AuthLogTests(samba.tests.auth_log_
         # Check the third message it should be an Authorization
         msg = messages[2]
         self.assertEquals("Authorization", msg["type"])
-        serviceDescription = "SMB"
-        print "binding %s" % binding
-        if binding == "[smb2]":
-            serviceDescription = "SMB2"
-
-        self.assertEquals(serviceDescription,
+        self._assert_ncacn_np_serviceDescription(binding,
                           msg["Authorization"]["serviceDescription"])
         self.assertEquals(authTypes[3], msg["Authorization"]["authType"])
         self.assertEquals("SMB", msg["Authorization"]["transportProtection"])
diff -Npur samba-4.8.4/python/samba/tests/dns_wildcard.py samba-4.8.5/python/samba/tests/dns_wildcard.py
--- samba-4.8.4/python/samba/tests/dns_wildcard.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/python/samba/tests/dns_wildcard.py	2018-08-24 09:58:20.000000000 +0200
@@ -172,6 +172,30 @@ class TestWildCardQueries(DNSTest):
         self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
         self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
 
+    def test_one_a_query_match_wildcard_2_labels(self):
+        """ Query an A record, should match the wild card entry
+            have two labels to the left of the wild card target.
+        """
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "label2.label1.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, WILDCARD_IP)
+
     def test_one_a_query_wildcard_entry(self):
         "Query the wildcard entry"
 
@@ -228,6 +252,30 @@ class TestWildCardQueries(DNSTest):
         q = self.make_name_question(name,
                                     dns.DNS_QTYPE_A,
                                     dns.DNS_QCLASS_IN)
+        questions.append(q)
+
+        self.finish_name_packet(p, questions)
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+        self.assert_dns_rcode_equals(response, dns.DNS_RCODE_OK)
+        self.assert_dns_opcode_equals(response, dns.DNS_OPCODE_QUERY)
+        self.assertEquals(response.ancount, 1)
+        self.assertEquals(response.answers[0].rr_type, dns.DNS_QTYPE_A)
+        self.assertEquals(response.answers[0].rdata, LEVEL2_WILDCARD_IP)
+
+    def test_one_a_query_match_wildcard_l2_2_labels(self):
+        """Query an A record, should match the level 2 wild card entry
+           have two labels to the left of the wild card target
+        """
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        # Check the record
+        name = "label1.label2.level2.wildcardtest.%s" % self.get_dns_domain()
+        q = self.make_name_question(name,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
         questions.append(q)
 
         self.finish_name_packet(p, questions)
diff -Npur samba-4.8.4/python/samba/tests/net_join_no_spnego.py samba-4.8.5/python/samba/tests/net_join_no_spnego.py
--- samba-4.8.4/python/samba/tests/net_join_no_spnego.py	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/python/samba/tests/net_join_no_spnego.py	2018-08-24 09:58:20.000000000 +0200
@@ -42,6 +42,7 @@ class NetJoinNoSpnegoTests(samba.tests.T
         super(NetJoinNoSpnegoTests, self).tearDown()
 
     def test_net_join_no_spnego(self):
+        self.lp.set("client ipc max protocol", "NT1")
         self.lp.set("client use spnego", "no")
         netbios_name = "NetJoinNoSpnego"
         machinepass  = "abcdefghij"
@@ -65,6 +66,7 @@ class NetJoinNoSpnegoTests(samba.tests.T
         self.fail("Shoud have rejected NTLMv2 without SPNEGO")
 
     def test_net_join_no_spnego_ntlmv1(self):
+        self.lp.set("client ipc max protocol", "NT1")
         self.lp.set("client use spnego", "no")
         self.lp.set("client ntlmv2 auth", "no")
         netbios_name = "NetJoinNoSpnego"
diff -Npur samba-4.8.4/selftest/knownfail samba-4.8.5/selftest/knownfail
--- samba-4.8.4/selftest/knownfail	2018-08-11 08:16:03.000000000 +0200
+++ samba-4.8.5/selftest/knownfail	2018-08-24 09:58:20.000000000 +0200
@@ -177,6 +177,9 @@
 ^samba3.smb2.streams.rename
 ^samba3.smb2.streams.rename2
 ^samba3.smb2.streams.attributes
+^samba3.smb2.streams streams_xattr.rename\(nt4_dc\)
+^samba3.smb2.streams streams_xattr.rename2\(nt4_dc\)
+^samba3.smb2.streams streams_xattr.attributes\(nt4_dc\)
 ^samba3.smb2.getinfo.complex
 ^samba3.smb2.getinfo.fsinfo # quotas don't work yet
 ^samba3.smb2.setinfo.setinfo
diff -Npur samba-4.8.4/selftest/subunithelper.py samba-4.8.5/selftest/subunithelper.py
--- samba-4.8.4/selftest/subunithelper.py	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/selftest/subunithelper.py	2018-08-24 09:58:20.000000000 +0200
@@ -82,7 +82,8 @@ def parse_results(msg_ops, statistics, f
                     if l == "":
                         break
                     msg_ops.control_msg(l)
-                    if l == "]\n":
+                    if l[-2:] == "]\n":
+                        reason += l[:-2]
                         terminated = True
                         break
                     else:
diff -Npur samba-4.8.4/selftest/target/Samba3.pm samba-4.8.5/selftest/target/Samba3.pm
--- samba-4.8.4/selftest/target/Samba3.pm	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/selftest/target/Samba3.pm	2018-08-24 09:58:20.000000000 +0200
@@ -790,14 +790,10 @@ sub setup_simpleserver($$)
 	my $simpleserver_options = "
 	lanman auth = yes
 	ntlm auth = yes
-	vfs objects = xattr_tdb streams_depot time_audit full_audit
+	vfs objects = xattr_tdb streams_depot
 	change notify = no
 	smb encrypt = off
 
-	full_audit:syslog = no
-	full_audit:success = none
-	full_audit:failure = none
-
 [vfs_aio_fork]
 	path = $prefix_abs/share
         vfs objects = aio_fork
@@ -866,6 +862,9 @@ sub setup_fileserver($$)
 	push(@dirs, "$dfree_share_dir/subdir2");
 	push(@dirs, "$dfree_share_dir/subdir3");
 
+	my $quotadir_dir="$share_dir/quota";
+	push(@dirs, $quotadir_dir);
+
 	my $valid_users_sharedir="$share_dir/valid_users";
 	push(@dirs,$valid_users_sharedir);
 
@@ -892,6 +891,8 @@ sub setup_fileserver($$)
 	usershare allow guests = yes
 	usershare prefix allow list = $usershare_sharedir
 
+	get quota command = $prefix_abs/getset_quota.py
+	set quota command = $prefix_abs/getset_quota.py
 [lowercase]
 	path = $lower_case_share_dir
 	comment = smb username is [%U]
@@ -1742,7 +1743,11 @@ sub provision($$$$$$$$$)
 	dos filemode = yes
 	strict rename = yes
 	strict sync = yes
-	vfs objects = acl_xattr fake_acls xattr_tdb streams_depot
+	vfs objects = acl_xattr fake_acls xattr_tdb streams_depot time_audit full_audit
+
+	full_audit:syslog = no
+	full_audit:success = none
+	full_audit:failure = none
 
 	printing = vlp
 	print command = $bindir_abs/vlp tdbfile=$lockdir/vlp.tdb print %p %s
@@ -2151,6 +2156,10 @@ sub provision($$$$$$$$$)
 	vfs objects = acl_xattr fake_acls xattr_tdb fake_dfq
 	inherit owner = yes
 	include = $dfqconffile
+[quotadir]
+	path = $shrdir/quota
+	admin users = $unix_name
+
 [acl_xattr_ign_sysacl_posix]
 	copy = tmp
 	acl_xattr:ignore system acls = yes
diff -Npur samba-4.8.4/source3/client/client.c samba-4.8.5/source3/client/client.c
--- samba-4.8.4/source3/client/client.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/client/client.c	2018-08-24 09:58:20.000000000 +0200
@@ -52,6 +52,7 @@ static int port = 0;
 static char *service;
 static char *desthost;
 static bool grepable = false;
+static bool quiet = false;
 static char *cmdstr = NULL;
 const char *cmd_ptr = NULL;
 
@@ -6059,7 +6060,9 @@ static int process_stdin(void)
 {
 	int rc = 0;
 
-	d_printf("Try \"help\" to get a list of possible commands.\n");
+	if (!quiet) {
+		d_printf("Try \"help\" to get a list of possible commands.\n");
+	}
 
 	while (!finished) {
 		TALLOC_CTX *frame = talloc_stackframe();
@@ -6329,6 +6332,7 @@ int main(int argc,char *argv[])
 		{ "timeout", 't', POPT_ARG_INT, &io_timeout, 'b', "Changes the per-operation timeout", "SECONDS" },
 		{ "port", 'p', POPT_ARG_INT, &port, 'p', "Port to connect to", "PORT" },
 		{ "grepable", 'g', POPT_ARG_NONE, NULL, 'g', "Produce grepable output" },
+		{ "quiet", 'q', POPT_ARG_NONE, NULL, 'q', "Suppress help message" },
                 { "browse", 'B', POPT_ARG_NONE, NULL, 'B', "Browse SMB servers using DNS" },
 		POPT_COMMON_SAMBA
 		POPT_COMMON_CONNECTION
@@ -6451,6 +6455,9 @@ int main(int argc,char *argv[])
 		case 'g':
 			grepable=true;
 			break;
+		case 'q':
+			quiet=true;
+			break;
 		case 'e':
 			smb_encrypt=true;
 			break;
diff -Npur samba-4.8.4/source3/include/smb.h samba-4.8.5/source3/include/smb.h
--- samba-4.8.4/source3/include/smb.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/include/smb.h	2018-08-24 09:58:20.000000000 +0200
@@ -419,6 +419,9 @@ Offset  Data			length.
 /* Private options for printer support */
 #define NTCREATEX_OPTIONS_PRIVATE_DELETE_ON_CLOSE 0x0008
 
+/* Private option for streams support */
+#define NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN 0x0010
+
 /* Flag for NT transact rename call. */
 #define RENAME_REPLACE_IF_EXISTS 1
 
diff -Npur samba-4.8.4/source3/lib/sendfile.c samba-4.8.5/source3/lib/sendfile.c
--- samba-4.8.4/source3/lib/sendfile.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/lib/sendfile.c	2018-08-24 09:58:20.000000000 +0200
@@ -24,6 +24,7 @@
  */
 
 #include "includes.h"
+#include "system/filesys.h"
 
 #if defined(LINUX_SENDFILE_API)
 
@@ -36,8 +37,10 @@
 ssize_t sys_sendfile(int tofd, int fromfd, const DATA_BLOB *header, off_t offset, size_t count)
 {
 	size_t total=0;
-	ssize_t ret;
+	ssize_t ret = -1;
 	size_t hdr_len = 0;
+	int old_flags = 0;
+	bool socket_flags_changed = false;
 
 	/*
 	 * Send the header first.
@@ -48,8 +51,25 @@ ssize_t sys_sendfile(int tofd, int fromf
 		hdr_len = header->length;
 		while (total < hdr_len) {
 			ret = sys_send(tofd, header->data + total,hdr_len - total, MSG_MORE);
-			if (ret == -1)
-				return -1;
+			if (ret == -1) {
+				if (errno == EAGAIN || errno == EWOULDBLOCK) {
+					/*
+					 * send() must complete before we can
+					 * send any other outgoing data on the
+					 * socket. Ensure socket is in blocking
+					 * mode. For SMB2 by default the socket
+					 * is in non-blocking mode.
+					 */
+					old_flags = fcntl(tofd, F_GETFL, 0);
+					ret = set_blocking(tofd, true);
+					if (ret == -1) {
+						goto out;
+					}
+					socket_flags_changed = true;
+					continue;
+				}
+				goto out;
+			}
 			total += ret;
 		}
 	}
@@ -59,8 +79,34 @@ ssize_t sys_sendfile(int tofd, int fromf
 		ssize_t nwritten;
 		do {
 			nwritten = sendfile(tofd, fromfd, &offset, total);
-		} while (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK));
+		} while (nwritten == -1 && errno == EINTR);
 		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				if (socket_flags_changed) {
+					/*
+					 * We're already in blocking
+					 * mode. This is an error.
+					 */
+					ret = -1;
+					goto out;
+				}
+
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+
 			if (errno == ENOSYS || errno == EINVAL) {
 				/* Ok - we're in a world of pain here. We just sent
 				 * the header, but the sendfile failed. We have to
@@ -72,17 +118,41 @@ ssize_t sys_sendfile(int tofd, int fromf
 				 */
 				errno = EINTR; /* Normally we can never return this. */
 			}
-			return -1;
+			ret = -1;
+			goto out;
 		}
 		if (nwritten == 0) {
 			/*
 			 * EOF, return a short read
 			 */
-			return hdr_len + (count - total);
+			ret = hdr_len + (count - total);
+			goto out;
 		}
 		total -= nwritten;
 	}
-	return count + hdr_len;
+
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(SOLARIS_SENDFILE_API)
@@ -99,6 +169,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 	size_t total, xferred;
 	struct sendfilevec vec[2];
 	ssize_t hdr_len = 0;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		sfvcnt = 2;
@@ -135,17 +208,37 @@ ssize_t sys_sendfile(int tofd, int fromf
 		xferred = 0;
 
 			nwritten = sendfilev(tofd, vec, sfvcnt, &xferred);
-		if  (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK)) {
+		if  (nwritten == -1 && errno == EINTR) {
 			if (xferred == 0)
 				continue; /* Nothing written yet. */
 			else
 				nwritten = xferred;
 		}
 
-		if (nwritten == -1)
-			return -1;
-		if (nwritten == 0)
-			return -1; /* I think we're at EOF here... */
+		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			ret = -1;
+			goto out;
+		}
+		if (nwritten == 0) {
+			ret = -1;
+			goto out; /* I think we're at EOF here... */
+		}
 
 		/*
 		 * If this was a short (signal interrupted) write we may need
@@ -167,7 +260,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		}
 		total -= nwritten;
 	}
-	return count + hdr_len;
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(HPUX_SENDFILE_API)
@@ -180,6 +294,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 	size_t total=0;
 	struct iovec hdtrl[2];
 	size_t hdr_len = 0;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		/* Set up the header/trailer iovec. */
@@ -205,11 +322,31 @@ ssize_t sys_sendfile(int tofd, int fromf
 
 		do {
 			nwritten = sendfile(tofd, fromfd, offset, total, &hdtrl[0], 0);
-		} while (nwritten == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK));
-		if (nwritten == -1)
-			return -1;
-		if (nwritten == 0)
-			return -1; /* I think we're at EOF here... */
+		} while (nwritten == -1 && errno == EINTR);
+		if (nwritten == -1) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			ret = -1;
+			goto out;
+		}
+		if (nwritten == 0) {
+			ret = -1; /* I think we're at EOF here... */
+			goto out;
+		}
 
 		/*
 		 * If this was a short (signal interrupted) write we may need
@@ -233,7 +370,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		total -= nwritten;
 		offset += nwritten;
 	}
-	return count + hdr_len;
+	ret = count + hdr_len;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(FREEBSD_SENDFILE_API) || defined(DARWIN_SENDFILE_API)
@@ -247,9 +405,11 @@ ssize_t sys_sendfile(int tofd, int fromf
 {
 	struct sf_hdtr	sf_header = {0};
 	struct iovec	io_header = {0};
+	int old_flags = 0;
 
 	off_t	nwritten;
-	int	ret;
+	ssize_t	ret = -1;
+	bool socket_flags_changed = false;
 
 	if (header) {
 		sf_header.headers = &io_header;
@@ -270,9 +430,26 @@ ssize_t sys_sendfile(int tofd, int fromf
 #else
 		ret = sendfile(fromfd, tofd, offset, count, &sf_header, &nwritten, 0);
 #endif
-		if (ret == -1 && errno != EINTR && errno != EAGAIN && errno != EWOULDBLOCK) {
+		if (ret == -1 && errno != EINTR) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
 			/* Send failed, we are toast. */
-			return -1;
+			ret = -1;
+			goto out;
 		}
 
 		if (nwritten == 0) {
@@ -299,7 +476,28 @@ ssize_t sys_sendfile(int tofd, int fromf
 		count -= nwritten;
 	}
 
-	return nwritten;
+	ret = nwritten;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
+			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
+	}
+
+	return ret;
 }
 
 #elif defined(AIX_SENDFILE_API)
@@ -312,6 +510,9 @@ ssize_t sys_sendfile(int tofd, int fromf
 ssize_t sys_sendfile(int tofd, int fromfd, const DATA_BLOB *header, off_t offset, size_t count)
 {
 	struct sf_parms hdtrl;
+	int old_flags = 0;
+	ssize_t ret = -1;
+	bool socket_flags_changed = false;
 
 	/* Set up the header/trailer struct params. */
 	if (header) {
@@ -329,8 +530,6 @@ ssize_t sys_sendfile(int tofd, int fromf
 	hdtrl.file_bytes = count;
 
 	while ( hdtrl.file_bytes + hdtrl.header_length ) {
-		ssize_t ret;
-
 		/*
 		 Return Value
 
@@ -348,12 +547,50 @@ ssize_t sys_sendfile(int tofd, int fromf
 		*/
 		do {
 			ret = send_file(&tofd, &hdtrl, 0);
-		} while ((ret == 1) || (ret == -1 && (errno == EINTR || errno == EAGAIN || errno == EWOULDBLOCK)));
-		if ( ret == -1 )
+		} while ((ret == 1) || (ret == -1 && errno == EINTR));
+		if ( ret == -1 ) {
+			if (errno == EAGAIN || errno == EWOULDBLOCK) {
+				/*
+				 * Sendfile must complete before we can
+				 * send any other outgoing data on the socket.
+				 * Ensure socket is in blocking mode.
+				 * For SMB2 by default the socket is in
+				 * non-blocking mode.
+				 */
+				old_flags = fcntl(tofd, F_GETFL, 0);
+				ret = set_blocking(tofd, true);
+				if (ret == -1) {
+					goto out;
+				}
+				socket_flags_changed = true;
+				continue;
+			}
+			goto out;
+		}
+	}
+
+	ret = count + header->length;
+
+  out:
+
+	if (socket_flags_changed) {
+		int saved_errno;
+		int err;
+
+		if (ret == -1) {
+			saved_errno = errno;
+		}
+		/* Restore the old state of the socket. */
+		err = fcntl(tofd, F_SETFL, old_flags);
+		if (err == -1) {
 			return -1;
+		}
+		if (ret == -1) {
+			errno = saved_errno;
+		}
 	}
 
-	return count + header->length;
+	return ret;
 }
 /* END AIX SEND_FILE */
 
diff -Npur samba-4.8.4/source3/lib/sysquotas.c samba-4.8.5/source3/lib/sysquotas.c
--- samba-4.8.4/source3/lib/sysquotas.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/lib/sysquotas.c	2018-08-24 09:58:20.000000000 +0200
@@ -418,7 +418,7 @@ static int command_set_quota(const char
 			return -1;
 		}
 
-		DEBUG (3, ("get_quota: Running command %s\n", syscmd));
+		DBG_NOTICE("set_quota: Running command %s\n", syscmd);
 
 		lines = file_lines_pload(talloc_tos(), syscmd, NULL);
 		SAFE_FREE(syscmd);
diff -Npur samba-4.8.4/source3/libsmb/cli_smb2_fnum.c samba-4.8.5/source3/libsmb/cli_smb2_fnum.c
--- samba-4.8.4/source3/libsmb/cli_smb2_fnum.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/libsmb/cli_smb2_fnum.c	2018-08-24 09:58:20.000000000 +0200
@@ -41,6 +41,7 @@
 #include "lib/util_ea.h"
 #include "librpc/gen_ndr/ndr_ioctl.h"
 #include "ntioctl.h"
+#include "librpc/gen_ndr/ndr_quota.h"
 
 struct smb2_hnd {
 	uint64_t fid_persistent;
@@ -682,7 +683,7 @@ NTSTATUS cli_smb2_rmdir(struct cli_state
 			FILE_ATTRIBUTE_DIRECTORY, /* file attributes */
 			FILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE, /* share_access */
 			FILE_OPEN,		/* create_disposition */
-			FILE_DIRECTORY_FILE|FILE_DELETE_ON_CLOSE,	/* create_options */
+			FILE_DIRECTORY_FILE,	/* create_options */
 			&fnum,
 			NULL);
 
@@ -710,6 +711,13 @@ NTSTATUS cli_smb2_rmdir(struct cli_state
 	if (!NT_STATUS_IS_OK(status)) {
 		return status;
 	}
+
+	status = cli_smb2_delete_on_close(cli, fnum, true);
+	if (!NT_STATUS_IS_OK(status)) {
+		cli_smb2_close_fnum(cli, fnum);
+		return status;
+	}
+
 	return cli_smb2_close_fnum(cli, fnum);
 }
 
@@ -2908,12 +2916,16 @@ NTSTATUS cli_smb2_get_user_quota(struct
 {
 	NTSTATUS status;
 	DATA_BLOB inbuf = data_blob_null;
+	DATA_BLOB info_blob = data_blob_null;
 	DATA_BLOB outbuf = data_blob_null;
 	struct smb2_hnd *ph = NULL;
 	TALLOC_CTX *frame = talloc_stackframe();
 	unsigned sid_len;
 	unsigned int offset;
-	uint8_t *buf;
+	struct smb2_query_quota_info query = {0};
+	struct file_get_quota_info info = {0};
+	enum ndr_err_code err;
+	struct ndr_push *ndr_push = NULL;
 
 	if (smbXcli_conn_has_async_calls(cli->conn)) {
 		/*
@@ -2935,27 +2947,48 @@ NTSTATUS cli_smb2_get_user_quota(struct
 
 	sid_len = ndr_size_dom_sid(&pqt->sid, 0);
 
-	inbuf = data_blob_talloc_zero(frame, 24 + sid_len);
-	if (inbuf.data == NULL) {
+	query.return_single = 1;
+
+	info.next_entry_offset = 0;
+	info.sid_length = sid_len;
+	info.sid = pqt->sid;
+
+	err = ndr_push_struct_blob(
+			&info_blob,
+			frame,
+			&info,
+			(ndr_push_flags_fn_t)ndr_push_file_get_quota_info);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto fail;
+	}
+
+	query.sid_list_length = info_blob.length;
+	ndr_push = ndr_push_init_ctx(frame);
+	if (!ndr_push) {
 		status = NT_STATUS_NO_MEMORY;
 		goto fail;
 	}
 
-	buf = inbuf.data;
+	err = ndr_push_smb2_query_quota_info(ndr_push,
+					     NDR_SCALARS | NDR_BUFFERS,
+					     &query);
 
-	SCVAL(buf, 0, 1);	   /* ReturnSingle */
-	SCVAL(buf, 1, 0);	   /* RestartScan */
-	SSVAL(buf, 2, 0);	   /* Reserved */
-	if (8 + sid_len < 8) {
-		status = NT_STATUS_INVALID_PARAMETER;
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
 		goto fail;
 	}
-	SIVAL(buf, 4, 8 + sid_len); /* SidListLength */
-	SIVAL(buf, 8, 0);	   /* StartSidLength */
-	SIVAL(buf, 12, 0);	  /* StartSidOffset */
-	SIVAL(buf, 16, 0);	  /* NextEntryOffset */
-	SIVAL(buf, 20, sid_len);    /* SidLength */
-	sid_linearize(buf + 24, sid_len, &pqt->sid);
+
+	err = ndr_push_array_uint8(ndr_push, NDR_SCALARS, info_blob.data,
+				   info_blob.length);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto fail;
+	}
+	inbuf.data = ndr_push->data;
+	inbuf.length = ndr_push->offset;
 
 	status = smb2cli_query_info(cli->conn, cli->timeout, cli->smb2.session,
 				    cli->smb2.tcon, 4, /* in_info_type */
@@ -3000,7 +3033,8 @@ NTSTATUS cli_smb2_list_user_quota_step(s
 	DATA_BLOB outbuf = data_blob_null;
 	struct smb2_hnd *ph = NULL;
 	TALLOC_CTX *frame = talloc_stackframe();
-	uint8_t *buf;
+	struct smb2_query_quota_info info = {0};
+	enum ndr_err_code err;
 
 	if (smbXcli_conn_has_async_calls(cli->conn)) {
 		/*
@@ -3020,20 +3054,19 @@ NTSTATUS cli_smb2_list_user_quota_step(s
 		goto cleanup;
 	}
 
-	inbuf = data_blob_talloc_zero(frame, 16);
-	if (inbuf.data == NULL) {
-		status = NT_STATUS_NO_MEMORY;
-		goto cleanup;
-	}
 
-	buf = inbuf.data;
+	info.restart_scan = first ? 1 : 0;
 
-	SCVAL(buf, 0, 0);	     /* ReturnSingle */
-	SCVAL(buf, 1, first ? 1 : 0); /* RestartScan */
-	SSVAL(buf, 2, 0);	     /* Reserved */
-	SIVAL(buf, 4, 0);	     /* SidListLength */
-	SIVAL(buf, 8, 0);	     /* StartSidLength */
-	SIVAL(buf, 12, 0);	    /* StartSidOffset */
+	err = ndr_push_struct_blob(
+			&inbuf,
+			frame,
+			&info,
+			(ndr_push_flags_fn_t)ndr_push_smb2_query_quota_info);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto cleanup;
+	}
 
 	status = smb2cli_query_info(cli->conn, cli->timeout, cli->smb2.session,
 				    cli->smb2.tcon, 4, /* in_info_type */
@@ -3045,6 +3078,14 @@ NTSTATUS cli_smb2_list_user_quota_step(s
 				    ph->fid_persistent, ph->fid_volatile, frame,
 				    &outbuf);
 
+	/*
+	 * safeguard against panic from calling parse_user_quota_list with
+	 * NULL buffer
+	 */
+	if (NT_STATUS_IS_OK(status) && outbuf.length == 0) {
+		status = NT_STATUS_NO_MORE_ENTRIES;
+	}
+
 	if (!NT_STATUS_IS_OK(status)) {
 		goto cleanup;
 	}
diff -Npur samba-4.8.4/source3/libsmb/cliquota.c samba-4.8.5/source3/libsmb/cliquota.c
--- samba-4.8.4/source3/libsmb/cliquota.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/libsmb/cliquota.c	2018-08-24 09:58:20.000000000 +0200
@@ -24,6 +24,7 @@
 #include "../libcli/security/security.h"
 #include "trans2.h"
 #include "../libcli/smb/smbXcli_base.h"
+#include "librpc/gen_ndr/ndr_quota.h"
 
 NTSTATUS cli_get_quota_handle(struct cli_state *cli, uint16_t *quota_fnum)
 {
@@ -75,61 +76,39 @@ bool parse_user_quota_record(const uint8
 			     unsigned int *offset,
 			     SMB_NTQUOTA_STRUCT *pqt)
 {
-	int sid_len;
-	SMB_NTQUOTA_STRUCT qt;
-
-	ZERO_STRUCT(qt);
-
-	if (!rdata||!offset||!pqt) {
-		smb_panic("parse_quota_record: called with NULL POINTER!");
-	}
-
-	if (rdata_count < 40) {
-		return False;
-	}
-
-	/* offset to next quota record.
-	 * 4 bytes IVAL(rdata,0)
-	 * unused here...
-	 */
-	*offset = IVAL(rdata,0);
-
-	/* sid len */
-	sid_len = IVAL(rdata,4);
-	if (40 + sid_len < 40) {
-		return false;
-	}
-
-	if (rdata_count < 40+sid_len) {
-		return False;		
-	}
-
-	if (*offset != 0 && *offset < 40 + sid_len) {
-		return false;
-	}
-
-	/* unknown 8 bytes in pdata 
-	 * maybe its the change time in NTTIME
-	 */
-
-	/* the used space 8 bytes (uint64_t)*/
-	qt.usedspace = BVAL(rdata,16);
-
-	/* the soft quotas 8 bytes (uint64_t)*/
-	qt.softlim = BVAL(rdata,24);
-
-	/* the hard quotas 8 bytes (uint64_t)*/
-	qt.hardlim = BVAL(rdata,32);
-
-	if (!sid_parse(rdata+40,sid_len,&qt.sid)) {
-		return false;
-	}
-
-	qt.qtype = SMB_USER_QUOTA_TYPE;
-
-	*pqt = qt;
-
-	return True;
+	struct file_quota_information info = {0};
+	TALLOC_CTX *frame = talloc_stackframe();
+	DATA_BLOB blob;
+	enum ndr_err_code err;
+	bool result = false;
+
+	blob.data = discard_const_p(uint8_t, rdata);
+	blob.length = rdata_count;
+	err = ndr_pull_struct_blob(
+			&blob,
+			frame,
+			&info,
+			(ndr_pull_flags_fn_t)ndr_pull_file_quota_information);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		goto out;
+	}
+
+	*offset = info.next_entry_offset;
+
+	ZERO_STRUCTP(pqt);
+	pqt->usedspace = info.quota_used;
+
+	pqt->softlim = info.quota_threshold;
+
+	pqt->hardlim = info.quota_limit;
+
+	pqt->qtype = SMB_USER_QUOTA_TYPE;
+	pqt->sid = info.sid;
+	result = true;
+out:
+	TALLOC_FREE(frame);
+	return result;
 }
 
 NTSTATUS parse_user_quota_list(const uint8_t *curdata,
@@ -217,111 +196,12 @@ NTSTATUS build_user_quota_buffer(SMB_NTQ
 				 DATA_BLOB *outbuf,
 				 SMB_NTQUOTA_LIST **end_ptr)
 {
-	uint32_t qt_len = 0;
-	uint8_t *entry;
-	uint32_t entry_len;
-	int sid_len;
-	SMB_NTQUOTA_LIST *qtl;
-	DATA_BLOB qbuf = data_blob_null;
-	NTSTATUS status = NT_STATUS_UNSUCCESSFUL;
-
-	if (qt_list == NULL) {
-		status = NT_STATUS_OK;
-		*outbuf = data_blob_null;
-		if (end_ptr) {
-			*end_ptr = NULL;
-		}
-		return NT_STATUS_OK;
-	}
-
-	for (qtl = qt_list; qtl != NULL; qtl = qtl->next) {
-
-		sid_len = ndr_size_dom_sid(&qtl->quotas->sid, 0);
-		if (47 + sid_len < 47) {
-			status = NT_STATUS_INVALID_PARAMETER;
-			goto fail;
-		}
-		entry_len = 40 + sid_len;
-		entry_len = ((entry_len + 7) / 8) * 8;
-
-		if (qt_len + entry_len < qt_len) {
-			status = NT_STATUS_INVALID_PARAMETER;
-			goto fail;
-		}
-		qt_len += entry_len;
-	}
-
-	if (maxlen > 0 && qt_len > maxlen) {
-		qt_len = maxlen;
-	}
-
-	qbuf = data_blob_talloc_zero(mem_ctx, qt_len);
-	if (qbuf.data == NULL) {
-		status = NT_STATUS_NO_MEMORY;
-		goto fail;
-	}
-
-	for (qt_len = 0, entry = qbuf.data; qt_list != NULL;
-	     qt_list = qt_list->next, qt_len += entry_len, entry += entry_len) {
-
-		sid_len = ndr_size_dom_sid(&qt_list->quotas->sid, 0);
-		entry_len = 40 + sid_len;
-		entry_len = ((entry_len + 7) / 8) * 8;
-
-		if (qt_len + entry_len > qbuf.length) {
-			/* check for not-enough room even for a single
-			 * entry
-			 */
-			if (qt_len == 0) {
-				status = NT_STATUS_BUFFER_TOO_SMALL;
-				goto fail;
-			}
-
-			break;
-		}
-
-		/* nextoffset entry 4 bytes */
-		SIVAL(entry, 0, entry_len);
-
-		/* then the len of the SID 4 bytes */
-		SIVAL(entry, 4, sid_len);
-
-		/* NTTIME of last record change */
-		SBIG_UINT(entry, 8, (uint64_t)0);
-
-		/* the used disk space 8 bytes uint64_t */
-		SBIG_UINT(entry, 16, qt_list->quotas->usedspace);
-
-		/* the soft quotas 8 bytes uint64_t */
-		SBIG_UINT(entry, 24, qt_list->quotas->softlim);
-
-		/* the hard quotas 8 bytes uint64_t */
-		SBIG_UINT(entry, 32, qt_list->quotas->hardlim);
-
-		/* and now the SID */
-		sid_linearize((uint8_t *)(entry + 40), sid_len,
-			      &qt_list->quotas->sid);
-	}
-
-	/* overwrite the offset of the last entry */
-	SIVAL(entry - entry_len, 0, 0);
-
-	/*potentially shrink the buffer if max was given
-	 * and we haven't quite reached the max
-	 */
-	qbuf.length = qt_len;
-	*outbuf = qbuf;
-	qbuf = data_blob_null;
-	status = NT_STATUS_OK;
-
-	if (end_ptr) {
-		*end_ptr = qt_list;
-	}
-
-fail:
-	data_blob_free(&qbuf);
-
-	return status;
+	return fill_quota_buffer(mem_ctx,
+				 qt_list,
+				 false,
+				 maxlen,
+				 outbuf,
+				 end_ptr);
 }
 
 NTSTATUS build_fs_quota_buffer(TALLOC_CTX *mem_ctx,
@@ -367,43 +247,68 @@ NTSTATUS cli_get_user_quota(struct cli_s
 			    SMB_NTQUOTA_STRUCT *pqt)
 {
 	uint16_t setup[1];
-	uint8_t params[16];
-	unsigned int data_len;
-	uint8_t data[SID_MAX_SIZE+8];
-	uint8_t *rparam, *rdata;
+	uint8_t *rparam = NULL, *rdata = NULL;
 	uint32_t rparam_count, rdata_count;
 	unsigned int sid_len;
 	unsigned int offset;
+	struct nttrans_query_quota_params get_quota = {0};
+	struct file_get_quota_info info =  {0};
+	enum ndr_err_code err;
 	NTSTATUS status;
+	TALLOC_CTX *frame = talloc_stackframe();
+	DATA_BLOB data_blob = data_blob_null;
+	DATA_BLOB param_blob = data_blob_null;
 
 	if (!cli||!pqt) {
 		smb_panic("cli_get_user_quota() called with NULL Pointer!");
 	}
 
 	if (smbXcli_conn_protocol(cli->conn) >= PROTOCOL_SMB2_02) {
+		TALLOC_FREE(frame);
 		return cli_smb2_get_user_quota(cli, quota_fnum, pqt);
 	}
 
-	SSVAL(setup + 0, 0, NT_TRANSACT_GET_USER_QUOTA);
-
-	SSVAL(params, 0,quota_fnum);
-	SSVAL(params, 2,TRANSACT_GET_USER_QUOTA_FOR_SID);
-	SIVAL(params, 4,0x00000024);
-	SIVAL(params, 8,0x00000000);
-	SIVAL(params,12,0x00000024);
+	get_quota.fid = quota_fnum;
+	get_quota.return_single_entry = 1;
+	get_quota.restart_scan = 0;
 
 	sid_len = ndr_size_dom_sid(&pqt->sid, 0);
-	data_len = sid_len+8;
-	SIVAL(data, 0, 0x00000000);
-	SIVAL(data, 4, sid_len);
-	sid_linearize(data+8, sid_len, &pqt->sid);
+
+	info.next_entry_offset = 0;
+	info.sid_length = sid_len;
+	info.sid = pqt->sid;
+
+	err = ndr_push_struct_blob(
+			&data_blob,
+			frame,
+			&info,
+			(ndr_push_flags_fn_t)ndr_push_file_get_quota_info);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto out;
+	}
+
+	get_quota.sid_list_length = data_blob.length;
+	get_quota.start_sid_offset = data_blob.length;
+
+	err = ndr_push_struct_blob(
+		&param_blob,
+		frame,
+		&get_quota,
+		(ndr_push_flags_fn_t)ndr_push_nttrans_query_quota_params);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto out;
+	}
 
 	status = cli_trans(talloc_tos(), cli, SMBnttrans,
 			   NULL, -1, /* name, fid */
 			   NT_TRANSACT_GET_USER_QUOTA, 0,
 			   setup, 1, 0, /* setup */
-			   params, 16, 4, /* params */
-			   data, data_len, 112, /* data */
+			   param_blob.data, param_blob.length, 4, /* params */
+			   data_blob.data, data_blob.length, 112, /* data */
 			   NULL,		/* recv_flags2 */
 			   NULL, 0, NULL,	/* rsetup */
 			   &rparam, 4, &rparam_count,
@@ -411,7 +316,7 @@ NTSTATUS cli_get_user_quota(struct cli_s
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("NT_TRANSACT_GET_USER_QUOTA failed: %s\n",
 			  nt_errstr(status)));
-		return status;
+		goto out;
 	}
 
 	if (!parse_user_quota_record(rdata, rdata_count, &offset, pqt)) {
@@ -419,8 +324,10 @@ NTSTATUS cli_get_user_quota(struct cli_s
 		DEBUG(0,("Got INVALID NT_TRANSACT_GET_USER_QUOTA reply.\n"));
 	}
 
+out:
 	TALLOC_FREE(rparam);
 	TALLOC_FREE(rdata);
+	TALLOC_FREE(frame);
 	return status;
 }
 
@@ -442,7 +349,15 @@ cli_set_user_quota(struct cli_state *cli
 
 	status = build_user_quota_buffer(qtl, 0, talloc_tos(), &data, NULL);
 	if (!NT_STATUS_IS_OK(status)) {
-		goto cleanup;
+		/*
+		 * smb1 doesn't send NT_STATUS_NO_MORE_ENTRIES so swallow
+		 * this status.
+		 */
+		if (NT_STATUS_EQUAL(status, NT_STATUS_NO_MORE_ENTRIES)) {
+			status = NT_STATUS_OK;
+		} else {
+			goto cleanup;
+		}
 	}
 
 	SSVAL(setup + 0, 0, NT_TRANSACT_SET_USER_QUOTA);
@@ -477,31 +392,42 @@ static NTSTATUS cli_list_user_quota_step
 					 bool first)
 {
 	uint16_t setup[1];
-	uint8_t params[16];
+	DATA_BLOB params_blob = data_blob_null;
 	uint8_t *rparam=NULL, *rdata=NULL;
 	uint32_t rparam_count=0, rdata_count=0;
 	NTSTATUS status;
-	uint16_t op = first ? TRANSACT_GET_USER_QUOTA_LIST_START
-			    : TRANSACT_GET_USER_QUOTA_LIST_CONTINUE;
+	struct nttrans_query_quota_params quota_params = {0};
+	enum ndr_err_code err;
 
+	TALLOC_CTX *frame = NULL;
 	if (smbXcli_conn_protocol(cli->conn) >= PROTOCOL_SMB2_02) {
 		return cli_smb2_list_user_quota_step(cli, mem_ctx, quota_fnum,
 						     pqt_list, first);
 	}
+	frame = talloc_stackframe();
 
 	SSVAL(setup + 0, 0, NT_TRANSACT_GET_USER_QUOTA);
 
-	SSVAL(params, 0,quota_fnum);
-	SSVAL(params, 2, op);
-	SIVAL(params, 4,0x00000000);
-	SIVAL(params, 8,0x00000000);
-	SIVAL(params,12,0x00000000);
+	quota_params.fid = quota_fnum;
+	if (first) {
+		quota_params.restart_scan = 1;
+	}
+	err = ndr_push_struct_blob(
+		&params_blob,
+		frame,
+		&quota_params,
+		(ndr_push_flags_fn_t)ndr_push_nttrans_query_quota_params);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		status = NT_STATUS_INVALID_PARAMETER;
+		goto cleanup;
+	}
 
 	status = cli_trans(talloc_tos(), cli, SMBnttrans,
 			   NULL, -1, /* name, fid */
 			   NT_TRANSACT_GET_USER_QUOTA, 0,
 			   setup, 1, 0, /* setup */
-			   params, 16, 4, /* params */
+			   params_blob.data, params_blob.length, 4, /* params */
 			   NULL, 0, 2048, /* data */
 			   NULL,		/* recv_flags2 */
 			   NULL, 0, NULL,	/* rsetup */
@@ -524,6 +450,7 @@ static NTSTATUS cli_list_user_quota_step
 cleanup:
 	TALLOC_FREE(rparam);
 	TALLOC_FREE(rdata);
+	TALLOC_FREE(frame);
 
 	return status;
 }
@@ -651,3 +578,115 @@ NTSTATUS cli_set_fs_quota_info(struct cl
 
 	return status;
 }
+
+NTSTATUS fill_quota_buffer(TALLOC_CTX *mem_ctx,
+			      SMB_NTQUOTA_LIST *qlist,
+			      bool return_single,
+			      uint32_t max_data,
+			      DATA_BLOB *blob,
+			      SMB_NTQUOTA_LIST **end_ptr)
+{
+	int ndr_flags = NDR_SCALARS | NDR_BUFFERS;
+	struct ndr_push *qndr = ndr_push_init_ctx(mem_ctx);
+	uint32_t start_offset = 0;
+	uint32_t padding = 0;
+	if (qlist == NULL) {
+		/* We must push at least one. */
+		return NT_STATUS_NO_MORE_ENTRIES;
+	}
+	for (;qlist != NULL; qlist = qlist->next) {
+		struct file_quota_information info = {0};
+		enum ndr_err_code err;
+		uint32_t dsize = sizeof(info.next_entry_offset)
+			+ sizeof(info.sid_length)
+			+ sizeof(info.change_time)
+			+ sizeof(info.quota_used)
+			+ sizeof(info.quota_threshold)
+			+ sizeof(info.quota_limit);
+
+
+		info.sid_length = ndr_size_dom_sid(&qlist->quotas->sid, 0);
+
+		if (max_data) {
+			uint32_t curr_pos_no_padding = qndr->offset - padding;
+			uint32_t payload = dsize + info.sid_length;
+			uint32_t new_pos = (curr_pos_no_padding + payload);
+			if (new_pos < curr_pos_no_padding) {
+				/* Detect unlikely integer wrap */
+				DBG_ERR("Integer wrap while adjusting pos "
+					"0x%x by offset 0x%x\n",
+					curr_pos_no_padding, payload);
+				return NT_STATUS_INTERNAL_ERROR;
+			}
+			if (new_pos > max_data) {
+				DBG_WARNING("Max data will be exceeded "
+					    "writing next query info. "
+					    "cur_pos 0x%x, sid_length 0x%x, "
+					    "dsize 0x%x, max_data 0x%x\n",
+					    curr_pos_no_padding,
+					    info.sid_length,
+					    dsize,
+					    max_data);
+				break;
+			}
+		}
+
+		start_offset = qndr->offset;
+		info.sid = qlist->quotas->sid;
+		info.quota_used = qlist->quotas->usedspace;
+		info.quota_threshold = qlist->quotas->softlim;
+		info.quota_limit = qlist->quotas->hardlim;
+
+		err = ndr_push_file_quota_information(qndr,
+						      ndr_flags,
+						      &info);
+
+		if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+			DBG_DEBUG("Failed to push the quota sid\n");
+			return NT_STATUS_INTERNAL_ERROR;
+		}
+
+		/* pidl will align to 8 bytes due to 8 byte members*/
+		/* Remember how much align padding we've used. */
+		padding = qndr->offset;
+
+		err = ndr_push_align(qndr, 8);
+		if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+			DBG_DEBUG("ndr_push_align returned %s\n",
+				  ndr_map_error2string(err));
+			return ndr_map_error2ntstatus(err);
+		}
+
+		padding = qndr->offset - padding;
+
+		/*
+		 * Overwrite next_entry_offset for this entry now
+		 * we know what it should be. We know we're using
+		 * LIBNDR_FLAG_LITTLE_ENDIAN here so we can use
+		 * SIVAL.
+		 */
+		info.next_entry_offset = qndr->offset - start_offset;
+		SIVAL(qndr->data, start_offset, info.next_entry_offset);
+
+		if (return_single) {
+			break;
+		}
+	}
+
+	if (end_ptr != NULL) {
+		*end_ptr = qlist;
+	}
+
+	/* Remove the padding alignment on the last element pushed. */
+	blob->length = qndr->offset - padding;
+	blob->data = qndr->data;
+
+	/*
+	 * Terminate the pushed array by setting next_entry_offset
+	 * for the last element to zero.
+	 */
+	if (blob->length >= sizeof(uint32_t)) {
+		SIVAL(qndr->data, start_offset, 0);
+	}
+	return NT_STATUS_OK;
+}
diff -Npur samba-4.8.4/source3/libsmb/clireadwrite.c samba-4.8.5/source3/libsmb/clireadwrite.c
--- samba-4.8.4/source3/libsmb/clireadwrite.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/libsmb/clireadwrite.c	2018-08-24 09:58:20.000000000 +0200
@@ -1459,10 +1459,13 @@ static NTSTATUS cli_splice_fallback(TALL
 	uint8_t *buf = talloc_size(frame, SPLICE_BLOCK_SIZE);
 	size_t nread;
 	off_t remaining = initial_size;
+	*written = 0;
 
 	while (remaining) {
+		size_t to_read = MIN(remaining, SPLICE_BLOCK_SIZE);
+
 		status = cli_read(srccli, src_fnum,
-				  (char *)buf, src_offset, SPLICE_BLOCK_SIZE,
+				  (char *)buf, src_offset, to_read,
 				  &nread);
 		if (!NT_STATUS_IS_OK(status)) {
 			return status;
@@ -1480,6 +1483,7 @@ static NTSTATUS cli_splice_fallback(TALL
 		}
 		src_offset += nread;
 		dst_offset += nread;
+		*written += nread;
 		if (remaining < nread) {
 			return NT_STATUS_INTERNAL_ERROR;
 		}
diff -Npur samba-4.8.4/source3/libsmb/libsmb_file.c samba-4.8.5/source3/libsmb/libsmb_file.c
--- samba-4.8.4/source3/libsmb/libsmb_file.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/libsmb/libsmb_file.c	2018-08-24 09:58:20.000000000 +0200
@@ -298,7 +298,7 @@ SMBC_splice_ctx(SMBCCTX *context,
                 int (*splice_cb)(off_t n, void *priv),
                 void *priv)
 {
-	off_t written;
+	off_t written = 0;
 	TALLOC_CTX *frame = talloc_stackframe();
 	NTSTATUS status;
 
diff -Npur samba-4.8.4/source3/libsmb/proto.h samba-4.8.5/source3/libsmb/proto.h
--- samba-4.8.4/source3/libsmb/proto.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/libsmb/proto.h	2018-08-24 09:58:20.000000000 +0200
@@ -974,6 +974,12 @@ NTSTATUS cli_readlink(struct cli_state *
 		       TALLOC_CTX *mem_ctx, char **psubstitute_name,
 		      char **pprint_name, uint32_t *pflags);
 
+NTSTATUS fill_quota_buffer(TALLOC_CTX *mem_ctx,
+			   SMB_NTQUOTA_LIST *tmp_list,
+			   bool return_single,
+			   uint32_t max_data,
+			   DATA_BLOB *blob,
+			   SMB_NTQUOTA_LIST **end_ptr);
 /* The following definitions come from libsmb/passchange.c  */
 
 NTSTATUS remote_password_change(const char *remote_machine,
diff -Npur samba-4.8.4/source3/locking/locking.c samba-4.8.5/source3/locking/locking.c
--- samba-4.8.4/source3/locking/locking.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/locking/locking.c	2018-08-24 09:58:20.000000000 +0200
@@ -1318,3 +1318,34 @@ struct timespec get_share_mode_write_tim
 	}
 	return d->old_write_time;
 }
+
+bool file_has_open_streams(files_struct *fsp)
+{
+	struct share_mode_lock *lock = NULL;
+	struct share_mode_data *d = NULL;
+	uint32_t i;
+
+	lock = get_existing_share_mode_lock(talloc_tos(), fsp->file_id);
+	if (lock == NULL) {
+		return false;
+	}
+	d = lock->data;
+
+	for (i = 0; i < d->num_share_modes; i++) {
+		struct share_mode_entry *e = &d->share_modes[i];
+
+		if (share_mode_stale_pid(d, i)) {
+			continue;
+		}
+
+		if (e->private_options &
+		    NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN)
+		{
+			TALLOC_FREE(lock);
+			return true;
+		}
+	}
+
+	TALLOC_FREE(lock);
+	return false;
+}
diff -Npur samba-4.8.4/source3/locking/proto.h samba-4.8.5/source3/locking/proto.h
--- samba-4.8.4/source3/locking/proto.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/locking/proto.h	2018-08-24 09:58:20.000000000 +0200
@@ -205,6 +205,7 @@ bool is_delete_on_close_set(struct share
 bool set_sticky_write_time(struct file_id fileid, struct timespec write_time);
 bool set_write_time(struct file_id fileid, struct timespec write_time);
 struct timespec get_share_mode_write_time(struct share_mode_lock *lck);
+bool file_has_open_streams(files_struct *fsp);
 int share_mode_forall(int (*fn)(struct file_id fid,
 				const struct share_mode_data *data,
 				void *private_data),
diff -Npur samba-4.8.4/source3/modules/vfs_ceph.c samba-4.8.5/source3/modules/vfs_ceph.c
--- samba-4.8.4/source3/modules/vfs_ceph.c	2018-05-16 12:09:25.000000000 +0200
+++ samba-4.8.5/source3/modules/vfs_ceph.c	2018-08-24 09:58:20.000000000 +0200
@@ -1261,12 +1261,11 @@ static bool cephwrap_lock(struct vfs_han
 static int cephwrap_kernel_flock(struct vfs_handle_struct *handle, files_struct *fsp,
 				uint32_t share_mode, uint32_t access_mask)
 {
-	DBG_DEBUG("[CEPH] kernel_flock\n");
-	/*
-	 * We must return zero here and pretend all is good.
-	 * One day we might have this in CEPH.
-	 */
-	return 0;
+	DBG_ERR("[CEPH] flock unsupported! Consider setting "
+		"\"kernel share modes = no\"\n");
+
+	errno = ENOSYS;
+	return -1;
 }
 
 static bool cephwrap_getlock(struct vfs_handle_struct *handle, files_struct *fsp, off_t *poffset, off_t *pcount, int *ptype, pid_t *ppid)
diff -Npur samba-4.8.4/source3/modules/vfs_fruit.c samba-4.8.5/source3/modules/vfs_fruit.c
--- samba-4.8.4/source3/modules/vfs_fruit.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/modules/vfs_fruit.c	2018-08-24 09:58:20.000000000 +0200
@@ -2386,7 +2386,6 @@ static NTSTATUS fruit_check_access(vfs_h
 				   uint32_t deny_mode)
 {
 	NTSTATUS status = NT_STATUS_OK;
-	struct byte_range_lock *br_lck = NULL;
 	bool open_for_reading, open_for_writing, deny_read, deny_write;
 	off_t off;
 	bool have_read = false;
@@ -2444,6 +2443,8 @@ static NTSTATUS fruit_check_access(vfs_h
 
 		/* Set locks */
 		if ((access_mask & FILE_READ_DATA) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = access_to_netatalk_brl(fork_type, FILE_READ_DATA);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2451,13 +2452,16 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status))  {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 
 		if ((deny_mode & DENY_READ) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = denymode_to_netatalk_brl(fork_type, DENY_READ);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2465,10 +2469,11 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 	}
 
@@ -2494,6 +2499,8 @@ static NTSTATUS fruit_check_access(vfs_h
 
 		/* Set locks */
 		if ((access_mask & FILE_WRITE_DATA) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = access_to_netatalk_brl(fork_type, FILE_WRITE_DATA);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2501,13 +2508,15 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
-
 		}
 		if ((deny_mode & DENY_WRITE) && have_read) {
+			struct byte_range_lock *br_lck = NULL;
+
 			off = denymode_to_netatalk_brl(fork_type, DENY_WRITE);
 			br_lck = do_lock(
 				handle->conn->sconn->msg_ctx, fsp,
@@ -2515,15 +2524,14 @@ static NTSTATUS fruit_check_access(vfs_h
 				READ_LOCK, POSIX_LOCK, false,
 				&status, NULL);
 
+			TALLOC_FREE(br_lck);
+
 			if (!NT_STATUS_IS_OK(status)) {
 				return status;
 			}
-			TALLOC_FREE(br_lck);
 		}
 	}
 
-	TALLOC_FREE(br_lck);
-
 	return status;
 }
 
@@ -5537,6 +5545,9 @@ static int fruit_ftruncate(struct vfs_ha
 		  (intmax_t)offset);
 
 	if (fio == NULL) {
+		if (offset == 0 && global_fruit_config.nego_aapl) {
+			return SMB_VFS_NEXT_UNLINK(handle, fsp->fsp_name);
+		}
 		return SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset);
 	}
 
diff -Npur samba-4.8.4/source3/modules/vfs_time_audit.c samba-4.8.5/source3/modules/vfs_time_audit.c
--- samba-4.8.4/source3/modules/vfs_time_audit.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/modules/vfs_time_audit.c	2018-08-24 09:58:20.000000000 +0200
@@ -1930,13 +1930,12 @@ static NTSTATUS smb_time_audit_offload_r
 	struct tevent_req *req,
 	struct vfs_handle_struct *handle,
 	TALLOC_CTX *mem_ctx,
-	DATA_BLOB *_token_blob)
+	DATA_BLOB *token_blob)
 {
 	struct time_audit_offload_read_state *state = tevent_req_data(
 		req, struct time_audit_offload_read_state);
 	struct timespec ts_recv;
 	double timediff;
-	DATA_BLOB token_blob;
 	NTSTATUS status;
 
 	clock_gettime_mono(&ts_recv);
@@ -1950,13 +1949,8 @@ static NTSTATUS smb_time_audit_offload_r
 		return status;
 	}
 
-	token_blob = data_blob_talloc(mem_ctx,
-				      state->token_blob.data,
-				      state->token_blob.length);
-	if (token_blob.data == NULL) {
-		tevent_req_received(req);
-		return NT_STATUS_NO_MEMORY;
-	}
+	token_blob->length = state->token_blob.length;
+	token_blob->data = talloc_move(mem_ctx, &state->token_blob.data);
 
 	tevent_req_received(req);
 	return NT_STATUS_OK;
diff -Npur samba-4.8.4/source3/script/tests/getset_quota.py samba-4.8.5/source3/script/tests/getset_quota.py
--- samba-4.8.4/source3/script/tests/getset_quota.py	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/source3/script/tests/getset_quota.py	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,154 @@
+#!/usr/bin/env python3
+# Unix SMB/CIFS implementation.
+# Tests for smbcquotas
+# Copyright (C) Noel Power 2017
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+import sys
+import traceback
+import logging
+import os
+
+USER_QUOTAS = 1
+USER_DEFAULT_QUOTAS = 2
+GROUP_QUOTAS = 3
+GROUP_DEFAULT_QUOTAS = 4
+
+#Quota model
+
+class Quota:
+	def __init__(self):
+		self.flags = 0
+		self.quotatype = USER_DEFAULT_QUOTAS
+		self.uid = 0
+		self.usedblocks = 0
+		self.softlimit = 0
+		self.hardlimit = 0
+		self.hardlimit = 0
+		self.usedinodes = 0
+		self.slimitinodes = 0
+		self.hlimitinodes = 0
+
+def quota_to_str(item):
+	result = str(item.flags) + " " + str(item.usedblocks) + " " + str(item.softlimit) + " " + str(item.hardlimit) + " " + str(item.usedinodes) + " " + str(item.slimitinodes) + " " + str(item.hlimitinodes)
+	return result
+
+def quota_to_db_str(item):
+	result = item.uid + " " + str(item.usedblocks) + " " + str(item.softlimit) + " " + str(item.hardlimit) + " " + str(item.usedinodes) + " " + str(item.slimitinodes) + " " + str(item.hlimitinodes)
+	return result
+
+def load_quotas(input_file):
+	fileContents = open(input_file,"r")
+	lineno = 0
+	quotas = []
+	for line in fileContents:
+		if line.strip().startswith("#"):
+			continue
+		content = line.strip().split()
+		quota = Quota()
+		if len(content) < 7:
+			logging.debug("ignoring line %d, doesn't have enough fields\n"%lineno)
+		else:
+			quota.flags = 2
+			quota.uid = content[0]
+			quota.usedblocks = content[1]
+			quota.softlimit = content[2]
+			quota.hardlimit = content[3]
+			quota.usedinodes = content[4]
+			quota.slimitinodes = content[5]
+			quota.hlimitinodes = content[6]
+			quotas.append(quota)
+
+	fileContents.close()
+	return quotas
+
+def set_quotas(quota_list, output_file):
+	filecontents = open(output_file,"w+")
+	if filecontents == None:
+		return False;
+	lines = ""
+	for quota in quota_list:
+		next_line = quota_to_db_str(quota)
+		if next_line:
+			lines = lines + next_line + "\n"
+	filecontents.write(lines)
+	filecontents.close()
+	return True
+
+def get_quotas(uid, quota_list):
+	logging.debug("in get_quotas\n")
+	for quota in quota_list:
+		if quota.uid == uid:
+			return quota
+	return None
+
+def main():
+	logging.basicConfig(format='%(asctime)s %(message)s', level=logging.DEBUG)
+	logging.debug("system args passed are %s\n"% str(sys.argv))
+	quota_file_dir = os.path.dirname(sys.argv[0]);
+	quota_file_db = os.path.join(quota_file_dir,"quotas.db")
+	logging.debug("quota db is located %s\n", quota_file_db)
+	quota_list = load_quotas(quota_file_db)
+	logging.debug("quotas loaded have %s entries\n", len(quota_list))
+	result = None
+	if len(sys.argv) == 4:
+		# Get Quota
+		directory = sys.argv[1]
+		if sys.argv[2] == "1":
+			query_type = USER_QUOTAS
+		elif sys.argv[2] == "2":
+			query_type = USER_DEFAULT_QUOTAS
+		elif sys.argv[2] == "3":
+			query_type = GROUP_QUOTAS
+		elif sys.argv[2] == "4":
+			query_type = GROUP_DEFAULT_QUOTAS
+		uid = sys.argv[3]
+		quota = get_quotas(uid, quota_list)
+		if quota is None:
+			logging.debug("no result for uid %s"%uid)
+		else:
+			result = quota_to_str(quota)
+			logging.debug("got result for uid %s\n"%uid);
+		if result is None:
+			result = "0 0 0 0 0 0 0"
+		logging.debug("for uid %s returning quotas %s\n"%(uid,result))
+		print("%s"%result)
+	elif len(sys.argv) > 8:
+		# Set Quota
+		quota = Quota()
+		directory = sys.argv[1]
+		quota.query_type = sys.argv[2]
+		quota.uid = sys.argv[3]
+		quota.flags = sys.argv[4]
+		quota.softlimit = sys.argv[5]
+		quota.hardlimit = sys.argv[6]
+		quota.slimitinodes = sys.argv[7]
+		quota.hlimitinodes = sys.argv[8]
+		found = get_quotas(quota.uid, quota_list)
+		if found:
+			found.query_type = quota.query_type
+			found.uid = quota.uid
+			found.flags = quota.flags
+			found.softlimit = quota.softlimit
+			found.hardlimit = quota.hardlimit
+			found.slimitinodes = quota.slimitinodes
+			found.hlimitinodes = quota.hlimitinodes
+		else:
+			quota_list.append(quota)
+		if set_quotas(quota_list,quota_file_db):
+			print ("%s\n"%quota_to_str(quota_list[-1]))
+	return
+if __name__ == '__main__':
+    main()
diff -Npur samba-4.8.4/source3/script/tests/test_dfree_quota.sh samba-4.8.5/source3/script/tests/test_dfree_quota.sh
--- samba-4.8.4/source3/script/tests/test_dfree_quota.sh	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/source3/script/tests/test_dfree_quota.sh	2018-08-24 09:58:20.000000000 +0200
@@ -164,13 +164,21 @@ test_smbcquotas() {
     conf="$2"
     user="$3"
     expected="$4"
+    proto="$5"
 	shift
     shift
     shift
     shift
+    shift
 	subunit_start_test "$name"
     setup_conf "$conf" "."
-	output=$($VALGRIND $smbcquotas //$SERVER/dfq $@ 2>/dev/null | tr '\\' '/')
+    if [ "$proto"  = "smb2" ]; then
+        mproto="-m SMB2"
+    else
+        mproto="-m SMB1"
+    fi
+
+	output=$($VALGRIND $smbcquotas $mproto //$SERVER/dfq $@ 2>/dev/null | tr '\\' '/')
 	status=$?
 	if [ "$status" = "0" ]; then
 		received=$(echo "$output" | awk "/$SERVER\\/$user/ {printf \"%s%s%s\", \$3, \$4, \$5}")
@@ -191,7 +199,9 @@ test_smbclient_dfree "Test dfree subdir
 test_smbclient_dfree "Test dfree subdir NT1 no quota" dfq "subdir1" "conf1 . conf2 subdir1" "10 1024. 5" -U$USERNAME%$PASSWORD --option=clientmaxprotocol=NT1 || failed=`expr $failed + 1`
 test_smbclient_dfree "Test large disk" dfq "." "conf3 ." "1125899906842624 1024. 3000" -U$USERNAME%$PASSWORD --option=clientmaxprotocol=SMB3 || failed=`expr $failed + 1`
 #basic quota test (SMB1 only)
-test_smbcquotas "Test user quota" confq1 $USERNAME "40960/4096000/3072000" -U$USERNAME%$PASSWORD --option=clientmaxprotocol=NT1 || failed=`expr $failed + 1`
+test_smbcquotas "Test user quota" confq1 $USERNAME "40960/4096000/3072000" "smb1" -U$USERNAME%$PASSWORD --option=clientmaxprotocol=NT1 || failed=`expr $failed + 1`
+#basic quota test (SMB2 only)
+test_smbcquotas "Test user quota" confq1 $USERNAME "40960/4096000/3072000" "smb2" -U$USERNAME%$PASSWORD --option=clientmaxprotocol=SMB2 || failed=`expr $failed + 1`
 
 # Test dfree cache through queries in two different directories
 test_smbclient_dfree_2 "Test dfree cache" dfq_cache "." "subdir1" \
diff -Npur samba-4.8.4/source3/script/tests/test_smbclient_s3.sh samba-4.8.5/source3/script/tests/test_smbclient_s3.sh
--- samba-4.8.4/source3/script/tests/test_smbclient_s3.sh	2018-05-16 12:09:25.000000000 +0200
+++ samba-4.8.5/source3/script/tests/test_smbclient_s3.sh	2018-08-24 09:58:20.000000000 +0200
@@ -1598,6 +1598,36 @@ EOF
     return 0
 }
 
+test_server_quiet_message()
+{
+    tmpfile=$PREFIX/smbclient_interactive_prompt_commands
+    cat > $tmpfile <<EOF
+ls
+quit
+EOF
+    cmd='CLI_FORCE_INTERACTIVE=yes $SMBCLIENT "$@" -U$USERNAME%$PASSWORD //$SERVER/tmp -I $SERVER_IP $ADDARGS --quiet < $tmpfile 2>&1'
+    eval echo "$cmd"
+    out=`eval $cmd`
+    ret=$?
+    rm -f $tmpfile
+
+    if [ $ret -ne 0 ] ; then
+       echo "$out"
+       echo "failed to connect error $ret"
+       return 1
+    fi
+
+    echo "$out" | grep 'Try "help" to get a list of possible commands.'
+    ret=$?
+    if [ $ret -eq 0 ] ; then
+       echo "$out"
+       echo 'failed - quiet should skip this message.'
+       return 1
+    fi
+
+    return 0
+}
+
 # Test xattr_stream correctly reports mode.
 # BUG: https://bugzilla.samba.org/show_bug.cgi?id=13380
 
@@ -1669,6 +1699,44 @@ EOF
     fi
 }
 
+# Test smbclient non-empty rmdir command
+test_del_nedir()
+{
+    tmpfile=$PREFIX/smbclient_interactive_prompt_commands
+    del_nedir="$LOCAL_PATH/del_nedir"
+
+    rm -rf $del_nedir
+    mkdir $del_nedir
+    touch $del_nedir/afile
+    cat > $tmpfile <<EOF
+rmdir del_nedir
+quit
+EOF
+    cmd='CLI_FORCE_INTERACTIVE=yes $SMBCLIENT "$@" -U$USERNAME%$PASSWORD //$SERVER/tmp -I $SERVER_IP $ADDARGS < $tmpfile 2>&1'
+    eval echo "$cmd"
+    out=`eval $cmd`
+    ret=$?
+    rm -rf $del_nedir
+
+    if [ $ret != 0 ] ; then
+	echo "$out"
+	echo "failed test_del_nedir test with output $ret"
+	false
+	return
+    fi
+
+# Should get NT_STATUS_DIRECTORY_NOT_EMPTY error from rmdir
+    echo "$out" | grep 'NT_STATUS_DIRECTORY_NOT_EMPTY'
+    ret=$?
+    if [ $ret -ne 0 ] ; then
+       echo "$out"
+       echo "test_del_nedir failed - should get an NT_STATUS_DIRECTORY_NOT_EMPTY error"
+       false
+       return
+    fi
+}
+
+#
 #
 LOGDIR_PREFIX=test_smbclient_s3
 
@@ -1789,6 +1857,10 @@ testit "server os message" \
     test_server_os_message || \
     failed=`expr $failed + 1`
 
+testit "test server quiet message" \
+    test_server_quiet_message || \
+    failed=`expr $failed + 1`
+
 testit "setmode test" \
     test_setmode || \
     failed=`expr $failed + 1`
@@ -1809,4 +1881,8 @@ testit "rm -rf $LOGDIR" \
     rm -rf $LOGDIR || \
     failed=`expr $failed + 1`
 
+testit "delete a non empty directory" \
+    test_del_nedir || \
+    failed=`expr $failed + 1`
+
 testok $0 $failed
diff -Npur samba-4.8.4/source3/script/tests/test_smbcquota.py samba-4.8.5/source3/script/tests/test_smbcquota.py
--- samba-4.8.4/source3/script/tests/test_smbcquota.py	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/source3/script/tests/test_smbcquota.py	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,244 @@
+#!/usr/bin/env python3
+# Unix SMB/CIFS implementation.
+# Tests for smbcquotas
+# Copyright (C) Noel Power 2017
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+import os, subprocess, sys
+import traceback
+import logging
+import shutil
+
+USER_QUOTAS = 1
+USER_DEFAULT_QUOTAS = 2
+GROUP_QUOTAS = 3
+GROUP_DEFAULT_QUOTAS = 4
+BLOCK_SIZE = 1024
+DEFAULT_SOFTLIM = 2
+DEFAULT_HARDLIM = 4
+
+class test_env:
+	def __init__(self):
+		self.server = None
+		self.domain = None
+		self.username = None
+		self.password = None
+		self.envdir = None
+		self.quota_db = None
+		self.smbcquotas = None
+		self.users = []
+
+class user_info:
+	def __init__(self):
+		self.uid = 0
+		self.username = ""
+		self.softlim = 0
+		self.hardlim = 0
+
+class Quota:
+	def __init__(self):
+		self.flags = 0
+		self.quotatype = USER_DEFAULT_QUOTAS
+		self.uid = 0
+		self.usedblocks = 0
+		self.softlimit = 0
+		self.hardlimit = 0
+		self.hardlimit = 0
+		self.usedinodes = 0
+		self.slimitinodes = 0
+		self.hlimitinodes = 0
+
+def init_quota_db(users, output_file):
+	filecontents = open(output_file,"w+")
+	lines = ""
+	default_values = "0 " + str(DEFAULT_SOFTLIM) + " " + str(DEFAULT_HARDLIM) + " 0 0 0"
+	for user in users:
+		lines = lines + user.uid + " " + default_values + "\n"
+	filecontents.write(lines)
+	filecontents.close()
+
+def load_quotas(input_file):
+	fileContents = open(input_file,"r")
+	lineno = 0
+	quotas = []
+	for line in fileContents:
+		if line.strip().startswith("#"):
+			continue
+		content = line.strip().split()
+		quota = Quota()
+		if len(content) < 7:
+			logging.debug("ignoring line %d, doesn't have enough fields\n"%lineno)
+		else:
+			quota.flags = 2
+			quota.uid = content[0]
+			quota.usedblocks = content[1]
+			quota.softlimit = content[2]
+			quota.hardlimit = content[3]
+			quota.usedinodes = content[4]
+			quota.slimitinodes = content[5]
+			quota.hlimitinodes = content[6]
+			quotas.append(quota)
+
+	fileContents.close()
+	return quotas
+
+def get_quotas(uid, quota_list):
+	for quota in quota_list:
+		if quota.uid == uid:
+			return quota
+	return None
+
+def get_users():
+	output = subprocess.Popen(['getent', 'passwd'],
+                                 stdout=subprocess.PIPE).communicate()[0].decode("utf-8").split('\n')
+	users = []
+	for line in output:
+		info = line.split(':')
+		if len(info) > 3 and info[0]:
+			user = user_info()
+			user.username = info[0]
+			user.uid = info[2]
+			logging.debug("Adding user ->%s<-\n"%user.username)
+			users.append(user)
+	return users
+
+
+
+def smbcquota_output_to_userinfo(output):
+	infos = []
+	for line in output:
+		if len(line) > 1:
+			username = line.strip(':').split()[0]
+			quota_info = line.split(':')[1].split('/')
+			if len(quota_info) > 2:
+				info = user_info()
+				info.username = username.strip()
+				info.softlim = int(quota_info[1].strip()) / BLOCK_SIZE
+				info.hardlim = int(quota_info[2].strip()) / BLOCK_SIZE
+				infos.append(info)
+	return infos
+
+def check_quota_limits(infos, softlim, hardlim):
+	if len(infos) < 1:
+		logging.debug("no users info to check :-(\n")
+		return False
+	for info in infos:
+		if int(info.softlim) != softlim:
+			logging.debug("expected softlimit %s got ->%s<-\n"%(softlim, info.softlim))
+			return False
+		if int(info.hardlim) != hardlim:
+			logging.debug("expected hardlimit limit %s got %s\n"%(hardlim,info.hardlim))
+			return False
+	return True
+
+class test_base:
+	def __init__(self, env):
+		self.env = env
+	def run(self, protocol):
+		pass
+
+class listtest(test_base):
+	def run(self, protocol):
+		init_quota_db(self.env.users, self.env.quota_db)
+		quotas = load_quotas(self.env.quota_db)
+		args = [self.env.smbcquotas];
+		remaining_args = ['-U' + self.env.username + "%" + self.env.password, '-L', '//' + self.env.server + '/quotadir']
+		if protocol == 'smb2':
+			args.append('-m smb2')
+		args.extend(remaining_args)
+		output = subprocess.Popen([self.env.smbcquotas, '-U' + self.env.username + "%" + self.env.password, '-L', '//' + self.env.server + '/quotadir'], stdout=subprocess.PIPE).communicate()[0].decode("utf-8").split('\n')
+		infos = smbcquota_output_to_userinfo(output)
+		return check_quota_limits(infos, DEFAULT_SOFTLIM, DEFAULT_HARDLIM)
+def get_uid(name, users):
+	for user in users:
+		if user.username == name:
+			return user.uid
+	return None
+
+class gettest(test_base):
+	def run(self, protocol):
+		init_quota_db(self.env.users, self.env.quota_db)
+		quotas = load_quotas(self.env.quota_db)
+		uid = get_uid(self.env.username, self.env.users)
+		output = subprocess.Popen([self.env.smbcquotas, '-U' + self.env.username + "%" + self.env.password, '-u' + self.env.username, '//' + self.env.server + '/quotadir'], stdout=subprocess.PIPE).communicate()[0].decode("utf-8").split('\n')
+		user_infos = smbcquota_output_to_userinfo(output)
+		db_user_info = get_quotas(uid, quotas)
+		# double check, we compare the results from the db file
+		# the quota script the server uses compared to what
+		# smbcquota is telling us
+		return check_quota_limits(user_infos, int(db_user_info.softlimit), int(db_user_info.hardlimit))
+
+class settest(test_base):
+	def run(self, protocol):
+		init_quota_db(self.env.users, self.env.quota_db)
+		quotas = load_quotas(self.env.quota_db)
+		uid = get_uid(self.env.username, self.env.users)
+		old_db_user_info = get_quotas(uid, quotas)
+
+		#increase limits by 2 blocks
+		new_soft_limit = (int(old_db_user_info.softlimit) + 2) * BLOCK_SIZE
+		new_hard_limit = (int(old_db_user_info.hardlimit) + 2) * BLOCK_SIZE
+
+		new_limits = "UQLIM:%s:%d/%d"%(self.env.username, new_soft_limit, new_hard_limit)
+		logging.debug("setting new limits %s"%new_limits)
+
+		output = subprocess.Popen([self.env.smbcquotas, '-U' + self.env.username + "%" + self.env.password, '//' + self.env.server + '/quotadir', '-S', new_limits], stdout=subprocess.PIPE).communicate()[0].decode("utf-8").split('\n')
+		logging.debug("output from smbcquota is %s"%output)
+		user_infos = smbcquota_output_to_userinfo(output)
+		return check_quota_limits(user_infos, new_soft_limit / BLOCK_SIZE, new_hard_limit / BLOCK_SIZE)
+
+# map of tests
+subtest_descriptions = {
+	"list test" : listtest,
+	"get test" : gettest,
+	"set test" : settest
+}
+
+def main():
+	logging.basicConfig(format='%(asctime)s %(message)s', level=logging.DEBUG)
+
+	logging.debug("got args %s\n"%str(sys.argv))
+
+	if len(sys.argv) < 7:
+		logging.debug ("Usage: test_smbcquota.py server domain username password envdir smbcquotas\n")
+		sys.exit(1)
+	env = test_env()
+	env.server = sys.argv[1]
+	env.domain = sys.argv[2]
+	env.username = sys.argv[3]
+	env.password = sys.argv[4]
+	env.envdir = sys.argv[5]
+	env.smbcquotas = sys.argv[6]
+	quota_script = os.path.join(os.path.dirname(sys.argv[0]),
+				"getset_quota.py")
+	#copy the quota script to the evironment
+	shutil.copy2(quota_script, env.envdir)
+
+	env.quota_db = os.path.join(env.envdir, "quotas.db")
+	env.users = get_users()
+	for protocol in ['smb1', 'smb2']:
+		for key in subtest_descriptions.keys():
+			test = subtest_descriptions[key](env)
+			logging.debug("running subtest '%s' using protocol '%s'\n"%(key,protocol))
+			result = test.run(protocol)
+			if result == False:
+				logging.debug("subtest '%s' for '%s' failed\n"%(key,protocol))
+				sys.exit(1)
+			else:
+				logging.debug("subtest '%s' for '%s' passed\n"%(key,protocol))
+	sys.exit(0)
+
+if __name__ == '__main__':
+    main()
diff -Npur samba-4.8.4/source3/script/tests/test_smbcquota.sh samba-4.8.5/source3/script/tests/test_smbcquota.sh
--- samba-4.8.4/source3/script/tests/test_smbcquota.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/source3/script/tests/test_smbcquota.sh	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,46 @@
+#!/bin/sh
+# Unix SMB/CIFS implementation.
+# Tests for smbcquotas
+# Copyright (C) Noel Power 2017
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+#
+
+#
+# Blackbox test wrapper for smbcquota
+#
+if [ $# -lt 6 ]; then
+cat <<EOF
+Usage: test_smbcquota.sh SERVER DOMAIN USERNAME PASSWORD LOCAL_PATH SMBCQUOTAS
+EOF
+exit 1;
+fi
+
+SERVER=$1
+DOMAIN=$2
+USERNAME=$3
+PASSWORD=$4
+ENVDIR=`dirname $5`
+SMBCQUOTAS="$VALGRIND $6"
+shift 6
+
+TEST_SMBCQUOTAS=`dirname $0`/test_smbcquota.py
+
+incdir=`dirname $0`/../../../testprogs/blackbox
+. $incdir/subunit.sh
+
+
+testit "smbcquotas" ${TEST_SMBCQUOTAS} ${SERVER} ${DOMAIN} ${USERNAME} ${PASSWORD} ${ENVDIR} ${SMBCQUOTAS} || failed=`expr $failed + 1`
+
+testok $0 $failed
diff -Npur samba-4.8.4/source3/selftest/tests.py samba-4.8.5/source3/selftest/tests.py
--- samba-4.8.4/source3/selftest/tests.py	2018-08-11 08:16:03.000000000 +0200
+++ samba-4.8.5/source3/selftest/tests.py	2018-08-24 09:58:20.000000000 +0200
@@ -74,7 +74,7 @@ tests = ["FDPASS", "LOCK1", "LOCK2", "LO
         "DIR", "DIR1", "DIR-CREATETIME", "TCON", "TCONDEV", "RW1", "RW2", "RW3", "LARGE_READX", "RW-SIGNING",
         "OPEN", "XCOPY", "RENAME", "DELETE", "DELETE-LN", "WILDDELETE", "PROPERTIES", "W2K",
         "TCON2", "IOCTL", "CHKPATH", "FDSESS", "CHAIN1", "CHAIN2", "OWNER-RIGHTS",
-        "CHAIN3", "PIDHIGH",
+        "CHAIN3", "PIDHIGH", "CLI_SPLICE",
         "UID-REGRESSION-TEST", "SHORTNAME-TEST",
         "CASE-INSENSITIVE-CREATE", "SMB2-BASIC", "NTTRANS-FSCTL", "SMB2-NEGPROT",
         "SMB2-SESSION-REAUTH", "SMB2-SESSION-RECONNECT", "SMB2-FTRUNCATE",
@@ -91,6 +91,9 @@ for t in tests:
         # this is a negative test to verify that the server rejects
         # access without encryption
         plantestsuite("samba3.smbtorture_s3.crypt_server(nt4_dc).%s" % t, "nt4_dc", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmpenc', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH"])
+    if t == "CLI_SPLICE":
+        # We must test this against the SMB1 fallback.
+        plantestsuite("samba3.smbtorture_s3.plain(fileserver).%s" % t, "fileserver", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmp', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH", "-mNT1"])
     plantestsuite("samba3.smbtorture_s3.plain(ad_dc_ntvfs).%s" % t, "ad_dc_ntvfs", [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//$SERVER_IP/tmp', '$USERNAME', '$PASSWORD', smbtorture3, "", "-l $LOCAL_PATH"])
 
 #
@@ -267,6 +270,7 @@ for env in ["fileserver"]:
     plantestsuite("samba3.blackbox.preserve_case (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_preserve_case.sh"), '$SERVER', '$DOMAIN', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3])
     plantestsuite("samba3.blackbox.dfree_command (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_dfree_command.sh"), '$SERVER', '$DOMAIN', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3])
     plantestsuite("samba3.blackbox.dfree_quota (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_dfree_quota.sh"), '$SERVER', '$DOMAIN', '$USERNAME', '$PASSWORD', '$LOCAL_PATH', smbclient3, smbcquotas, smbcacls])
+    plantestsuite("samba3.blackbox.smbcquotas (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_smbcquota.sh"), '$SERVER', '$DOMAIN', '$USERNAME', '$PASSWORD', '$LOCAL_PATH', smbcquotas])
     plantestsuite("samba3.blackbox.valid_users (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_valid_users.sh"), '$SERVER', '$SERVER_IP', '$DOMAIN', '$USERNAME', '$PASSWORD', '$PREFIX', smbclient3])
     plantestsuite("samba3.blackbox.offline (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_offline.sh"), '$SERVER', '$SERVER_IP', '$DOMAIN', '$USERNAME', '$PASSWORD', '$LOCAL_PATH/offline', smbclient3])
     plantestsuite("samba3.blackbox.shadow_copy2 NT1 (%s)" % env, env, [os.path.join(samba3srcdir, "script/tests/test_shadow_copy.sh"), '$SERVER', '$SERVER_IP', '$DOMAIN', '$USERNAME', '$PASSWORD', '$LOCAL_PATH/shadow', smbclient3, '-m', 'NT1'])
@@ -559,13 +563,17 @@ for t in tests:
     elif t == "rpc.samba3.netlogon" or t == "rpc.samba3.sessionkey":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD --option=torture:wksname=samba3rpctest')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD --option=torture:wksname=samba3rpctest')
+    elif t == "smb2.streams":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/streams_xattr -U$USERNAME%$PASSWORD', 'streams_xattr')
     else:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
 
 
 test = 'rpc.lsa.lookupsids'
-auth_options = ["", "ntlm", "spnego", "spnego,ntlm" ]
+auth_options = ["", "ntlm", "spnego", "spnego,ntlm", "spnego,smb1", "spnego,smb2"]
 signseal_options = ["", ",connect", ",packet", ",sign", ",seal"]
 endianness_options = ["", ",bigendian"]
 for s in signseal_options:
diff -Npur samba-4.8.4/source3/smbd/durable.c samba-4.8.5/source3/smbd/durable.c
--- samba-4.8.4/source3/smbd/durable.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/smbd/durable.c	2018-08-24 09:58:20.000000000 +0200
@@ -305,30 +305,6 @@ static bool vfs_default_durable_reconnec
 {
 	int ret;
 
-	if (cookie_st->st_ex_dev != fsp_st->st_ex_dev) {
-		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
-			  "stat_ex.%s differs: "
-			  "cookie:%llu != stat:%llu, "
-			  "denying durable reconnect\n",
-			  name,
-			  "st_ex_dev",
-			  (unsigned long long)cookie_st->st_ex_dev,
-			  (unsigned long long)fsp_st->st_ex_dev));
-		return false;
-	}
-
-	if (cookie_st->st_ex_ino != fsp_st->st_ex_ino) {
-		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
-			  "stat_ex.%s differs: "
-			  "cookie:%llu != stat:%llu, "
-			  "denying durable reconnect\n",
-			  name,
-			  "st_ex_ino",
-			  (unsigned long long)cookie_st->st_ex_ino,
-			  (unsigned long long)fsp_st->st_ex_ino));
-		return false;
-	}
-
 	if (cookie_st->st_ex_mode != fsp_st->st_ex_mode) {
 		DEBUG(1, ("vfs_default_durable_reconnect (%s): "
 			  "stat_ex.%s differs: "
diff -Npur samba-4.8.4/source3/smbd/nttrans.c samba-4.8.5/source3/smbd/nttrans.c
--- samba-4.8.4/source3/smbd/nttrans.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/smbd/nttrans.c	2018-08-24 09:58:20.000000000 +0200
@@ -30,6 +30,8 @@
 #include "smbprofile.h"
 #include "libsmb/libsmb.h"
 #include "lib/util_ea.h"
+#include "librpc/gen_ndr/ndr_quota.h"
+#include "librpc/gen_ndr/ndr_security.h"
 
 extern const struct generic_mapping file_generic_mapping;
 
@@ -2293,6 +2295,272 @@ static void call_nt_transact_ioctl(conne
 
 
 #ifdef HAVE_SYS_QUOTAS
+static enum ndr_err_code fill_qtlist_from_sids(TALLOC_CTX *mem_ctx,
+					       struct files_struct *fsp,
+					       SMB_NTQUOTA_HANDLE *qt_handle,
+					       struct dom_sid *sids,
+					       uint32_t elems)
+{
+	uint32_t i;
+	TALLOC_CTX *list_ctx = NULL;
+
+	list_ctx = talloc_init("quota_sid_list");
+
+	if (list_ctx == NULL) {
+		DBG_ERR("failed to allocate\n");
+		return NDR_ERR_ALLOC;
+	}
+
+	if (qt_handle->quota_list!=NULL) {
+		free_ntquota_list(&(qt_handle->quota_list));
+	}
+	for (i = 0; i < elems; i++) {
+		SMB_NTQUOTA_STRUCT qt;
+		SMB_NTQUOTA_LIST *list_item;
+		bool ok;
+
+		if (!NT_STATUS_IS_OK(vfs_get_ntquota(fsp,
+						     SMB_USER_QUOTA_TYPE,
+						     &sids[i], &qt))) {
+			/* non fatal error, return empty item in result */
+			ZERO_STRUCT(qt);
+			continue;
+		}
+
+
+		list_item = talloc_zero(list_ctx, SMB_NTQUOTA_LIST);
+		if (list_item == NULL) {
+			DBG_ERR("failed to allocate\n");
+			return NDR_ERR_ALLOC;
+		}
+
+		ok = sid_to_uid(&sids[i], &list_item->uid);
+		if (!ok) {
+			char buf[DOM_SID_STR_BUFLEN];
+			dom_sid_string_buf(&sids[i], buf, sizeof(buf));
+			DBG_WARNING("Could not convert SID %s to uid\n", buf);
+			/* No idea what to return here... */
+			return NDR_ERR_INVALID_POINTER;
+		}
+
+		list_item->quotas = talloc_zero(list_item, SMB_NTQUOTA_STRUCT);
+		if (list_item->quotas == NULL) {
+			DBG_ERR("failed to allocate\n");
+			return NDR_ERR_ALLOC;
+		}
+
+		*list_item->quotas = qt;
+		list_item->mem_ctx = list_ctx;
+		DLIST_ADD(qt_handle->quota_list, list_item);
+	}
+	qt_handle->tmp_list = qt_handle->quota_list;
+	return NDR_ERR_SUCCESS;
+}
+
+static enum ndr_err_code extract_sids_from_buf(TALLOC_CTX *mem_ctx,
+				  uint32_t sidlistlength,
+				  DATA_BLOB *sid_buf,
+				  struct dom_sid **sids,
+				  uint32_t *num)
+{
+	DATA_BLOB blob;
+	uint32_t i = 0;
+	enum ndr_err_code err;
+
+	struct sid_list_elem {
+		struct sid_list_elem *prev, *next;
+		struct dom_sid sid;
+	};
+
+	struct sid_list_elem *sid_list = NULL;
+	struct sid_list_elem *iter = NULL;
+	TALLOC_CTX *list_ctx = talloc_init("sid_list");
+	if (!list_ctx) {
+		DBG_ERR("OOM\n");
+		err = NDR_ERR_ALLOC;
+		goto done;
+	}
+
+	*num = 0;
+	*sids = NULL;
+
+	if (sidlistlength) {
+		uint32_t offset = 0;
+		struct ndr_pull *ndr_pull = NULL;
+
+		if (sidlistlength > sid_buf->length) {
+			DBG_ERR("sid_list_length 0x%x exceeds "
+				"available bytes %zx\n",
+				sidlistlength,
+				sid_buf->length);
+			err = NDR_ERR_OFFSET;
+			goto done;
+		}
+		while (true) {
+			struct file_get_quota_info info;
+			struct sid_list_elem *item = NULL;
+			uint32_t new_offset = 0;
+			blob.data = sid_buf->data + offset;
+			blob.length = sidlistlength - offset;
+			ndr_pull = ndr_pull_init_blob(&blob, list_ctx);
+			if (!ndr_pull) {
+				DBG_ERR("OOM\n");
+				err = NDR_ERR_ALLOC;
+				goto done;
+			}
+			err = ndr_pull_file_get_quota_info(ndr_pull,
+					   NDR_SCALARS | NDR_BUFFERS, &info);
+			if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+				DBG_ERR("Failed to pull file_get_quota_info "
+					"from sidlist buffer\n");
+				goto done;
+			}
+			item = talloc_zero(list_ctx, struct sid_list_elem);
+			if (!item) {
+				DBG_ERR("OOM\n");
+				err = NDR_ERR_ALLOC;
+				goto done;
+			}
+			item->sid = info.sid;
+			DLIST_ADD(sid_list, item);
+			i++;
+			if (i == UINT32_MAX) {
+				DBG_ERR("Integer overflow\n");
+				err = NDR_ERR_ARRAY_SIZE;
+				goto done;
+			}
+			new_offset = info.next_entry_offset;
+
+			/* if new_offset == 0 no more sid(s) to read. */
+			if (new_offset == 0) {
+				break;
+			}
+
+			/* Integer wrap? */
+			if ((offset + new_offset) < offset) {
+				DBG_ERR("Integer wrap while adding "
+					"new_offset 0x%x to current "
+					"buffer offset 0x%x\n",
+					new_offset, offset);
+				err = NDR_ERR_OFFSET;
+				goto done;
+			}
+
+			offset += new_offset;
+
+			/* check if new offset is outside buffer boundry. */
+			if (offset >= sidlistlength) {
+				DBG_ERR("bufsize 0x%x exceeded by "
+                                        "new offset 0x%x)\n",
+					sidlistlength,
+					offset);
+				err = NDR_ERR_OFFSET;
+				goto done;
+			}
+		}
+		*sids = talloc_zero_array(mem_ctx, struct dom_sid, i);
+		if (*sids == NULL) {
+			DBG_ERR("OOM\n");
+			err = NDR_ERR_ALLOC;
+			goto done;
+		}
+
+		*num = i;
+
+		for (iter = sid_list, i = 0; iter; iter = iter->next, i++) {
+			(*sids)[i] = iter->sid;
+			DBG_DEBUG("quota SID[%u] %s\n",
+				(unsigned int)i,
+				sid_string_dbg(&iter->sid));
+		}
+	}
+	err = NDR_ERR_SUCCESS;
+done:
+	TALLOC_FREE(list_ctx);
+	return err;
+}
+
+NTSTATUS smbd_do_query_getinfo_quota(TALLOC_CTX *mem_ctx,
+				     files_struct *fsp,
+				     bool restart_scan,
+				     bool return_single,
+				     uint32_t sid_list_length,
+				     DATA_BLOB *sid_buf,
+				     uint32_t max_data_count,
+				     uint8_t **p_data,
+				     uint32_t *p_data_size)
+{
+	NTSTATUS status;
+	SMB_NTQUOTA_HANDLE *qt_handle = NULL;
+	SMB_NTQUOTA_LIST *qt_list = NULL;
+	DATA_BLOB blob = data_blob_null;
+	enum ndr_err_code err;
+
+	qt_handle =
+		(SMB_NTQUOTA_HANDLE *)fsp->fake_file_handle->private_data;
+
+	if (sid_list_length ) {
+		struct dom_sid *sids;
+		uint32_t elems = 0;
+		/*
+		 * error check pulled offsets and lengths for wrap and
+		 * exceeding available bytes.
+		 */
+		if (sid_list_length > sid_buf->length) {
+			DBG_ERR("sid_list_length 0x%x exceeds "
+				"available bytes %zx\n",
+				sid_list_length,
+				sid_buf->length);
+			return NT_STATUS_INVALID_PARAMETER;
+		}
+
+		err = extract_sids_from_buf(mem_ctx, sid_list_length,
+					    sid_buf, &sids, &elems);
+		if (!NDR_ERR_CODE_IS_SUCCESS(err) || elems == 0) {
+			return NT_STATUS_INVALID_PARAMETER;
+		}
+		err = fill_qtlist_from_sids(mem_ctx,
+					    fsp,
+					    qt_handle,
+					    sids,
+					    elems);
+		if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+			return NT_STATUS_INVALID_PARAMETER;
+		}
+	} else if (restart_scan) {
+		if (vfs_get_user_ntquota_list(fsp,
+					      &(qt_handle->quota_list))!=0) {
+			return NT_STATUS_INTERNAL_ERROR;
+		}
+	} else {
+		if (qt_handle->quota_list!=NULL &&
+			qt_handle->tmp_list==NULL) {
+			free_ntquota_list(&(qt_handle->quota_list));
+		}
+	}
+
+	if (restart_scan !=0 ) {
+		qt_list = qt_handle->quota_list;
+	} else {
+		qt_list = qt_handle->tmp_list;
+	}
+	status = fill_quota_buffer(mem_ctx, qt_list,
+				   return_single != 0,
+				   max_data_count,
+				   &blob,
+				   &qt_handle->tmp_list);
+	if (!NT_STATUS_IS_OK(status)) {
+		return status;
+	}
+	if (blob.length > max_data_count) {
+		return NT_STATUS_BUFFER_TOO_SMALL;
+	}
+
+	*p_data = blob.data;
+	*p_data_size = blob.length;
+	return NT_STATUS_OK;
+}
+
 /****************************************************************************
  Reply to get user quota
 ****************************************************************************/
@@ -2310,267 +2578,117 @@ static void call_nt_transact_get_user_qu
 	NTSTATUS nt_status = NT_STATUS_OK;
 	char *params = *ppparams;
 	char *pdata = *ppdata;
-	char *entry;
-	int data_len=0,param_len=0;
-	int qt_len=0;
-	int entry_len = 0;
+	int data_len = 0;
+	int param_len = 0;
 	files_struct *fsp = NULL;
-	uint16_t level = 0;
-	size_t sid_len;
-	struct dom_sid sid;
-	bool start_enum = True;
-	SMB_NTQUOTA_STRUCT qt;
-	SMB_NTQUOTA_LIST *tmp_list;
-	SMB_NTQUOTA_HANDLE *qt_handle = NULL;
-
-	ZERO_STRUCT(qt);
+	DATA_BLOB blob = data_blob_null;
+	struct nttrans_query_quota_params info = {0};
+	enum ndr_err_code err;
+	TALLOC_CTX *tmp_ctx = NULL;
+	uint32_t resp_len = 0;
+	uint8_t *resp_data = 0;
+
+	tmp_ctx = talloc_init("ntquota_list");
+	if (!tmp_ctx) {
+		nt_status = NT_STATUS_NO_MEMORY;
+		goto error;
+	}
 
 	/* access check */
 	if (get_current_uid(conn) != sec_initial_uid()) {
 		DEBUG(1,("get_user_quota: access_denied service [%s] user "
 			 "[%s]\n", lp_servicename(talloc_tos(), SNUM(conn)),
 			 conn->session_info->unix_info->unix_name));
-		reply_nterror(req, NT_STATUS_ACCESS_DENIED);
-		return;
+		nt_status = NT_STATUS_ACCESS_DENIED;
+		goto error;
 	}
 
-	/*
-	 * Ensure minimum number of parameters sent.
-	 */
+	blob.data = (uint8_t*)params;
+	blob.length = parameter_count;
 
-	if (parameter_count < 4) {
-		DEBUG(0,("TRANSACT_GET_USER_QUOTA: requires %d >= 4 bytes parameters\n",parameter_count));
-		reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-		return;
+	err = ndr_pull_struct_blob(&blob, tmp_ctx, &info,
+		(ndr_pull_flags_fn_t)ndr_pull_nttrans_query_quota_params);
+
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		DEBUG(0,("TRANSACT_GET_USER_QUOTA: failed to pull "
+			 "query_quota_params."));
+		nt_status = NT_STATUS_INVALID_PARAMETER;
+		goto error;
+	}
+	DBG_DEBUG("info.return_single_entry = %u, info.restart_scan = %u, "
+		  "info.sid_list_length = %u, info.start_sid_length = %u, "
+		  "info.start_sid_offset = %u\n",
+		  (unsigned int)info.return_single_entry,
+		  (unsigned int)info.restart_scan,
+		  (unsigned int)info.sid_list_length,
+		  (unsigned int)info.start_sid_length,
+		  (unsigned int)info.start_sid_offset);
+
+	/* set blob to point at data for further parsing */
+	blob.data = (uint8_t*)pdata;
+	blob.length = data_count;
+	/*
+	 * Although MS-SMB ref is ambiguous here, a microsoft client will
+	 * only ever send a start sid (as part of a list) with
+	 * sid_list_length & start_sid_offset both set to the actual list
+	 * length. Note: Only a single result is returned in this case
+	 * In the case where either start_sid_offset or start_sid_length
+	 * are set alone or if both set (but have different values) then
+	 * it seems windows will return a number of entries from the start
+	 * of the list of users with quotas set. This behaviour is undocumented
+	 * and windows clients do not send messages of that type. As such we
+	 * currently will reject these requests.
+	 */
+	if (info.start_sid_length
+	|| (info.sid_list_length != info.start_sid_offset)) {
+		DBG_ERR("TRANSACT_GET_USER_QUOTA: unsupported single or "
+                        "compound sid format\n");
+		nt_status = NT_STATUS_INVALID_PARAMETER;
+		goto error;
 	}
 
 	/* maybe we can check the quota_fnum */
-	fsp = file_fsp(req, SVAL(params,0));
+	fsp = file_fsp(req, info.fid);
 	if (!check_fsp_ntquota_handle(conn, req, fsp)) {
 		DEBUG(3,("TRANSACT_GET_USER_QUOTA: no valid QUOTA HANDLE\n"));
-		reply_nterror(req, NT_STATUS_INVALID_HANDLE);
-		return;
+		nt_status = NT_STATUS_INVALID_HANDLE;
+		goto error;
+	}
+	nt_status = smbd_do_query_getinfo_quota(tmp_ctx,
+				  fsp,
+				  info.restart_scan,
+				  info.return_single_entry,
+				  info.sid_list_length,
+				  &blob,
+				  max_data_count,
+				  &resp_data,
+				  &resp_len);
+	if (!NT_STATUS_IS_OK(nt_status)) {
+		if (!NT_STATUS_EQUAL(nt_status, NT_STATUS_NO_MORE_ENTRIES)) {
+			goto error;
+		}
+		nt_status = NT_STATUS_OK;
 	}
 
-	/* the NULL pointer checking for fsp->fake_file_handle->pd
-	 * is done by CHECK_NTQUOTA_HANDLE_OK()
-	 */
-	qt_handle = (SMB_NTQUOTA_HANDLE *)fsp->fake_file_handle->private_data;
-
-	level = SVAL(params,2);
-
-	/* unknown 12 bytes leading in params */
-
-	switch (level) {
-		case TRANSACT_GET_USER_QUOTA_LIST_CONTINUE:
-			/* seems that we should continue with the enum here --metze */
-
-			if (qt_handle->quota_list!=NULL &&
-			    qt_handle->tmp_list==NULL) {
-
-				/* free the list */
-				free_ntquota_list(&(qt_handle->quota_list));
-
-				/* Realloc the size of parameters and data we will return */
-				param_len = 4;
-				params = nttrans_realloc(ppparams, param_len);
-				if(params == NULL) {
-					reply_nterror(req, NT_STATUS_NO_MEMORY);
-					return;
-				}
-
-				data_len = 0;
-				SIVAL(params,0,data_len);
-
-				break;
-			}
-
-			start_enum = False;
-
-		case TRANSACT_GET_USER_QUOTA_LIST_START:
-
-			if (qt_handle->quota_list==NULL &&
-				qt_handle->tmp_list==NULL) {
-				start_enum = True;
-			}
-
-			if (start_enum && vfs_get_user_ntquota_list(fsp,&(qt_handle->quota_list))!=0) {
-				reply_nterror(req, NT_STATUS_INTERNAL_ERROR);
-				return;
-			}
-
-			/* Realloc the size of parameters and data we will return */
-			param_len = 4;
-			params = nttrans_realloc(ppparams, param_len);
-			if(params == NULL) {
-				reply_nterror(req, NT_STATUS_NO_MEMORY);
-				return;
-			}
-
-			/* we should not trust the value in max_data_count*/
-			max_data_count = MIN(max_data_count,2048);
-
-			pdata = nttrans_realloc(ppdata, max_data_count);/* should be max data count from client*/
-			if(pdata == NULL) {
-				reply_nterror(req, NT_STATUS_NO_MEMORY);
-				return;
-			}
-
-			entry = pdata;
-
-			/* set params Size of returned Quota Data 4 bytes*/
-			/* but set it later when we know it */
-
-			/* for each entry push the data */
-
-			if (start_enum) {
-				qt_handle->tmp_list = qt_handle->quota_list;
-			}
-
-			tmp_list = qt_handle->tmp_list;
-
-			for (;((tmp_list!=NULL)&&((qt_len +40+SID_MAX_SIZE)<max_data_count));
-				tmp_list=tmp_list->next,entry+=entry_len,qt_len+=entry_len) {
-
-				sid_len = ndr_size_dom_sid(
-					&tmp_list->quotas->sid, 0);
-				entry_len = 40 + sid_len;
-
-				/* nextoffset entry 4 bytes */
-				SIVAL(entry,0,entry_len);
-
-				/* then the len of the SID 4 bytes */
-				SIVAL(entry,4,sid_len);
-
-				/* unknown data 8 bytes uint64_t */
-				SBIG_UINT(entry,8,(uint64_t)0); /* this is not 0 in windows...-metze*/
-
-				/* the used disk space 8 bytes uint64_t */
-				SBIG_UINT(entry,16,tmp_list->quotas->usedspace);
-
-				/* the soft quotas 8 bytes uint64_t */
-				SBIG_UINT(entry,24,tmp_list->quotas->softlim);
-
-				/* the hard quotas 8 bytes uint64_t */
-				SBIG_UINT(entry,32,tmp_list->quotas->hardlim);
-
-				/* and now the SID */
-				sid_linearize((uint8_t *)(entry+40), sid_len,
-					      &tmp_list->quotas->sid);
-			}
-
-			qt_handle->tmp_list = tmp_list;
-
-			/* overwrite the offset of the last entry */
-			SIVAL(entry-entry_len,0,0);
-
-			data_len = 4+qt_len;
-			/* overwrite the params quota_data_len */
-			SIVAL(params,0,data_len);
-
-			break;
-
-		case TRANSACT_GET_USER_QUOTA_FOR_SID:
-
-			/* unknown 4 bytes IVAL(pdata,0) */
-
-			if (data_count < 8) {
-				DEBUG(0,("TRANSACT_GET_USER_QUOTA_FOR_SID: requires %d >= %d bytes data\n",data_count,8));
-				reply_nterror(req, NT_STATUS_INVALID_LEVEL);
-				return;
-			}
-
-			sid_len = IVAL(pdata,4);
-			/* Ensure this is less than 1mb. */
-			if (sid_len > (1024*1024)) {
-				reply_nterror(req, NT_STATUS_NO_MEMORY);
-				return;
-			}
-
-			if (data_count < 8+sid_len) {
-				DEBUG(0,("TRANSACT_GET_USER_QUOTA_FOR_SID: requires %d >= %lu bytes data\n",data_count,(unsigned long)(8+sid_len)));
-				reply_nterror(req, NT_STATUS_INVALID_LEVEL);
-				return;
-			}
-
-			data_len = 4+40+sid_len;
-
-			if (max_data_count < data_len) {
-				DEBUG(0,("TRANSACT_GET_USER_QUOTA_FOR_SID: max_data_count(%d) < data_len(%d)\n",
-					max_data_count, data_len));
-				param_len = 4;
-				SIVAL(params,0,data_len);
-				data_len = 0;
-				nt_status = NT_STATUS_BUFFER_TOO_SMALL;
-				break;
-			}
-
-			if (!sid_parse((const uint8_t *)(pdata+8), sid_len,
-				       &sid)) {
-				reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-				return;
-			}
-
-			nt_status = vfs_get_ntquota(fsp, SMB_USER_QUOTA_TYPE,
-						    &sid, &qt);
-			if (!NT_STATUS_IS_OK(nt_status)) {
-				reply_nterror(req, nt_status);
-				return;
-			}
-
-			/* Realloc the size of parameters and data we will return */
-			param_len = 4;
-			params = nttrans_realloc(ppparams, param_len);
-			if(params == NULL) {
-				reply_nterror(req, NT_STATUS_NO_MEMORY);
-				return;
-			}
-
-			pdata = nttrans_realloc(ppdata, data_len);
-			if(pdata == NULL) {
-				reply_nterror(req, NT_STATUS_NO_MEMORY);
-				return;
-			}
-
-			entry = pdata;
-
-			/* set params Size of returned Quota Data 4 bytes*/
-			SIVAL(params,0,data_len);
-
-			/* nextoffset entry 4 bytes */
-			SIVAL(entry,0,0);
-
-			/* then the len of the SID 4 bytes */
-			SIVAL(entry,4,sid_len);
-
-			/* unknown data 8 bytes uint64_t */
-			SBIG_UINT(entry,8,(uint64_t)0); /* this is not 0 in windows...-mezte*/
-
-			/* the used disk space 8 bytes uint64_t */
-			SBIG_UINT(entry,16,qt.usedspace);
-
-			/* the soft quotas 8 bytes uint64_t */
-			SBIG_UINT(entry,24,qt.softlim);
-
-			/* the hard quotas 8 bytes uint64_t */
-			SBIG_UINT(entry,32,qt.hardlim);
-
-			/* and now the SID */
-			sid_linearize((uint8_t *)(entry+40), sid_len, &sid);
-
-			break;
-
-		default:
-			DEBUG(0, ("do_nt_transact_get_user_quota: %s: unknown "
-				  "level 0x%04hX\n",
-				  fsp_fnum_dbg(fsp), level));
-			reply_nterror(req, NT_STATUS_INVALID_LEVEL);
-			return;
-			break;
+	param_len = 4;
+	params = nttrans_realloc(ppparams, param_len);
+	if(params == NULL) {
+		nt_status = NT_STATUS_NO_MEMORY;
+		goto error;
 	}
 
+	data_len = resp_len;
+	SIVAL(params, 0, data_len);
+	pdata = nttrans_realloc(ppdata, data_len);
+	memcpy(pdata, resp_data, data_len);
+
+	TALLOC_FREE(tmp_ctx);
 	send_nt_replies(conn, req, nt_status, params, param_len,
 			pdata, data_len);
+	return;
+error:
+	TALLOC_FREE(tmp_ctx);
+	reply_nterror(req, nt_status);
 }
 
 /****************************************************************************
@@ -2591,19 +2709,22 @@ static void call_nt_transact_set_user_qu
 	char *pdata = *ppdata;
 	int data_len=0,param_len=0;
 	SMB_NTQUOTA_STRUCT qt;
-	size_t sid_len;
+	struct file_quota_information info = {0};
+	enum ndr_err_code err;
 	struct dom_sid sid;
+	DATA_BLOB inblob;
 	files_struct *fsp = NULL;
-
+	TALLOC_CTX *ctx = NULL;
+	NTSTATUS status = NT_STATUS_OK;
 	ZERO_STRUCT(qt);
 
 	/* access check */
-	if (get_current_uid(conn) != 0) {
+	if (get_current_uid(conn) != sec_initial_uid()) {
 		DEBUG(1,("set_user_quota: access_denied service [%s] user "
 			 "[%s]\n", lp_servicename(talloc_tos(), SNUM(conn)),
 			 conn->session_info->unix_info->unix_name));
-		reply_nterror(req, NT_STATUS_ACCESS_DENIED);
-		return;
+		status = NT_STATUS_ACCESS_DENIED;
+		goto error;
 	}
 
 	/*
@@ -2612,67 +2733,58 @@ static void call_nt_transact_set_user_qu
 
 	if (parameter_count < 2) {
 		DEBUG(0,("TRANSACT_SET_USER_QUOTA: requires %d >= 2 bytes parameters\n",parameter_count));
-		reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-		return;
+		status = NT_STATUS_INVALID_PARAMETER;
+		goto error;
 	}
 
 	/* maybe we can check the quota_fnum */
 	fsp = file_fsp(req, SVAL(params,0));
 	if (!check_fsp_ntquota_handle(conn, req, fsp)) {
 		DEBUG(3,("TRANSACT_GET_USER_QUOTA: no valid QUOTA HANDLE\n"));
-		reply_nterror(req, NT_STATUS_INVALID_HANDLE);
-		return;
+		status = NT_STATUS_INVALID_HANDLE;
+		goto error;
 	}
 
-	if (data_count < 40) {
-		DEBUG(0,("TRANSACT_SET_USER_QUOTA: requires %d >= %d bytes data\n",data_count,40));
-		reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-		return;
+	ctx = talloc_init("set_user_quota");
+	if (!ctx) {
+		status = NT_STATUS_NO_MEMORY;
+		goto error;
 	}
+	inblob.data = (uint8_t*)pdata;
+	inblob.length = data_count;
 
-	/* offset to next quota record.
-	 * 4 bytes IVAL(pdata,0)
-	 * unused here...
-	 */
-
-	/* sid len */
-	sid_len = IVAL(pdata,4);
+	err = ndr_pull_struct_blob(
+			&inblob,
+			ctx,
+			&info,
+			(ndr_pull_flags_fn_t)ndr_pull_file_quota_information);
 
-	if (data_count < 40+sid_len || (40+sid_len < sid_len)) {
-		DEBUG(0,("TRANSACT_SET_USER_QUOTA: requires %d >= %lu bytes data\n",data_count,(unsigned long)40+sid_len));
-		reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-		return;
+	if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+		DEBUG(0,("TRANSACT_SET_USER_QUOTA: failed to pull "
+			 "file_quota_information\n"));
+		status = NT_STATUS_INVALID_PARAMETER;
+		goto error;
 	}
+	qt.usedspace = info.quota_used;
 
-	/* unknown 8 bytes in pdata
-	 * maybe its the change time in NTTIME
-	 */
-
-	/* the used space 8 bytes (uint64_t)*/
-	qt.usedspace = BVAL(pdata,16);
+	qt.softlim = info.quota_threshold;
 
-	/* the soft quotas 8 bytes (uint64_t)*/
-	qt.softlim = BVAL(pdata,24);
+	qt.hardlim = info.quota_limit;
 
-	/* the hard quotas 8 bytes (uint64_t)*/
-	qt.hardlim = BVAL(pdata,32);
-
-	if (!sid_parse((const uint8_t *)(pdata+40), sid_len, &sid)) {
-		reply_nterror(req, NT_STATUS_INVALID_PARAMETER);
-		return;
-	}
-
-	DEBUGADD(8,("SID: %s\n", sid_string_dbg(&sid)));
-
-	/* 44 unknown bytes left... */
+	sid = info.sid;
 
 	if (vfs_set_ntquota(fsp, SMB_USER_QUOTA_TYPE, &sid, &qt)!=0) {
-		reply_nterror(req, NT_STATUS_INTERNAL_ERROR);
-		return;
+		status = NT_STATUS_INTERNAL_ERROR;
+		goto error;
 	}
 
 	send_nt_replies(conn, req, NT_STATUS_OK, params, param_len,
 			pdata, data_len);
+	TALLOC_FREE(ctx);
+	return;
+error:
+	TALLOC_FREE(ctx);
+	reply_nterror(req, status);
 }
 #endif /* HAVE_SYS_QUOTAS */
 
diff -Npur samba-4.8.4/source3/smbd/open.c samba-4.8.5/source3/smbd/open.c
--- samba-4.8.4/source3/smbd/open.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/smbd/open.c	2018-08-24 09:58:20.000000000 +0200
@@ -5091,6 +5091,7 @@ static NTSTATUS create_file_unixpath(con
 	    && (!(private_flags & NTCREATEX_OPTIONS_PRIVATE_STREAM_DELETE))) {
 		uint32_t base_create_disposition;
 		struct smb_filename *smb_fname_base = NULL;
+		uint32_t base_privflags;
 
 		if (create_options & FILE_DIRECTORY_FILE) {
 			status = NT_STATUS_NOT_A_DIRECTORY;
@@ -5141,13 +5142,17 @@ static NTSTATUS create_file_unixpath(con
 			}
 		}
 
+		base_privflags = NTCREATEX_OPTIONS_PRIVATE_STREAM_BASEOPEN;
+
 		/* Open the base file. */
 		status = create_file_unixpath(conn, NULL, smb_fname_base, 0,
 					      FILE_SHARE_READ
 					      | FILE_SHARE_WRITE
 					      | FILE_SHARE_DELETE,
 					      base_create_disposition,
-					      0, 0, 0, NULL, 0, 0, NULL, NULL,
+					      0, 0, 0, NULL, 0,
+					      base_privflags,
+					      NULL, NULL,
 					      &base_fsp, NULL);
 		TALLOC_FREE(smb_fname_base);
 
diff -Npur samba-4.8.4/source3/smbd/proto.h samba-4.8.5/source3/smbd/proto.h
--- samba-4.8.4/source3/smbd/proto.h	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/source3/smbd/proto.h	2018-08-24 09:58:20.000000000 +0200
@@ -632,6 +632,20 @@ NTSTATUS smbd_do_query_security_desc(con
 					uint32_t max_data_count,
 					uint8_t **ppmarshalled_sd,
 					size_t *psd_size);
+#ifdef HAVE_SYS_QUOTAS
+
+struct smb2_query_quota_info;
+
+NTSTATUS smbd_do_query_getinfo_quota(TALLOC_CTX *mem_ctx,
+				     files_struct *fsp,
+				     bool restart_scan,
+				     bool return_single,
+				     uint32_t sid_list_length,
+				     DATA_BLOB *sidbuffer,
+				     uint32_t max_data_count,
+				     uint8_t **p_data,
+				     uint32_t *p_data_size);
+#endif
 void reply_nttrans(struct smb_request *req);
 void reply_nttranss(struct smb_request *req);
 
diff -Npur samba-4.8.4/source3/smbd/pysmbd.c samba-4.8.5/source3/smbd/pysmbd.c
--- samba-4.8.4/source3/smbd/pysmbd.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/source3/smbd/pysmbd.c	2018-08-24 09:58:20.000000000 +0200
@@ -396,6 +396,7 @@ static PyObject *py_smbd_set_simple_acl(
 
 	conn = get_conn(frame, service);
 	if (!conn) {
+		TALLOC_FREE(frame);
 		return NULL;
 	}
 
diff -Npur samba-4.8.4/source3/smbd/reply.c samba-4.8.5/source3/smbd/reply.c
--- samba-4.8.4/source3/smbd/reply.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source3/smbd/reply.c	2018-08-24 09:58:20.000000000 +0200
@@ -6642,6 +6642,10 @@ NTSTATUS rename_internals_fsp(connection
 		return status;
 	}
 
+	if (file_has_open_streams(fsp)) {
+		return NT_STATUS_ACCESS_DENIED;
+	}
+
 	/* Make a copy of the dst smb_fname structs */
 
 	smb_fname_dst = cp_smb_filename(ctx, smb_fname_dst_in);
diff -Npur samba-4.8.4/source3/smbd/smb2_create.c samba-4.8.5/source3/smbd/smb2_create.c
--- samba-4.8.4/source3/smbd/smb2_create.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/smbd/smb2_create.c	2018-08-24 09:58:20.000000000 +0200
@@ -381,6 +381,7 @@ static NTSTATUS smbd_smb2_create_durable
 	const char *requested_filename, const struct files_struct *fsp,
 	const struct smb2_lease *lease_ptr)
 {
+	char *filename = NULL;
 	struct smb_filename *smb_fname = NULL;
 	uint32_t ucf_flags;
 	NTSTATUS status;
@@ -407,10 +408,23 @@ static NTSTATUS smbd_smb2_create_durable
 		return NT_STATUS_OBJECT_NAME_NOT_FOUND;
 	}
 
+	filename = talloc_strdup(talloc_tos(), requested_filename);
+	if (filename == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* This also converts '\' to '/' */
+	status = check_path_syntax(filename);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(filename);
+		return status;
+	}
+
 	ucf_flags = filename_create_ucf_flags(smb1req, FILE_OPEN);
 	status = filename_convert(talloc_tos(), fsp->conn,
-				  requested_filename, ucf_flags,
+				  filename, ucf_flags,
 				  NULL, &smb_fname);
+	TALLOC_FREE(filename);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(10, ("filename_convert returned %s\n",
 			   nt_errstr(status)));
diff -Npur samba-4.8.4/source3/smbd/smb2_getinfo.c samba-4.8.5/source3/smbd/smb2_getinfo.c
--- samba-4.8.4/source3/smbd/smb2_getinfo.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/smbd/smb2_getinfo.c	2018-08-24 09:58:20.000000000 +0200
@@ -25,6 +25,8 @@
 #include "../libcli/smb/smb_common.h"
 #include "trans2.h"
 #include "../lib/util/tevent_ntstatus.h"
+#include "librpc/gen_ndr/ndr_quota.h"
+#include "librpc/gen_ndr/ndr_security.h"
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_SMB2
@@ -520,9 +522,92 @@ static struct tevent_req *smbd_smb2_geti
 		break;
 	}
 
-	case SMB2_GETINFO_QUOTA:
+	case SMB2_GETINFO_QUOTA: {
+#ifdef HAVE_SYS_QUOTAS
+		struct smb2_query_quota_info info;
+		enum ndr_err_code err;
+		uint8_t *data = NULL;
+		uint32_t data_size = 0;
+		struct ndr_pull *ndr_pull = NULL;
+		DATA_BLOB sid_buf = data_blob_null;
+		TALLOC_CTX *tmp_ctx = talloc_init("geninfo_quota");
+
+		if (!tmp_ctx) {
+			tevent_req_nterror(req, NT_STATUS_NO_MEMORY);
+			return tevent_req_post(req, ev);
+		}
+
+		ndr_pull = ndr_pull_init_blob(&in_input_buffer, tmp_ctx);
+		if (!ndr_pull) {
+			TALLOC_FREE(tmp_ctx);
+			tevent_req_nterror(req, NT_STATUS_NO_MEMORY);
+			return tevent_req_post(req, ev);
+		}
+
+		err = ndr_pull_smb2_query_quota_info(ndr_pull,
+						     NDR_SCALARS | NDR_BUFFERS,
+						     &info);
+
+		if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+			DBG_DEBUG("failed to pull smb2_query_quota_info\n");
+			TALLOC_FREE(tmp_ctx);
+			tevent_req_nterror(req, NT_STATUS_INTERNAL_ERROR);
+			return tevent_req_post(req, ev);
+		}
+
+		DBG_DEBUG("quota list returnsingle %u, restartscan %u, "
+			  "sid_list_length %u, start_sid_length %u, "
+			  "startsidoffset %u\n",
+			  (unsigned int)info.return_single,
+			  (unsigned int)info.restart_scan,
+			  (unsigned int)info.sid_list_length,
+			  (unsigned int)info.start_sid_length,
+			  (unsigned int)info.start_sid_offset);
+
+		/* Currently we do not support the single start sid format */
+		if (info.start_sid_length != 0 || info.start_sid_offset != 0 ) {
+			DBG_INFO("illegal single sid query\n");
+			TALLOC_FREE(tmp_ctx);
+			tevent_req_nterror(req, NT_STATUS_INVALID_PARAMETER);
+			return tevent_req_post(req, ev);
+		}
+
+		if (in_input_buffer.length < ndr_pull->offset) {
+			DBG_INFO("Invalid buffer length\n");
+			TALLOC_FREE(tmp_ctx);
+			tevent_req_nterror(req, NT_STATUS_INVALID_PARAMETER);
+			return tevent_req_post(req, ev);
+		}
+
+		sid_buf.data = in_input_buffer.data + ndr_pull->offset;
+		sid_buf.length = in_input_buffer.length - ndr_pull->offset;
+
+		status = smbd_do_query_getinfo_quota(tmp_ctx,
+				  fsp,
+				  info.restart_scan,
+				  info.return_single,
+				  info.sid_list_length,
+				  &sid_buf,
+				  in_output_buffer_length,
+				  &data,
+				  &data_size);
+
+		if (!NT_STATUS_IS_OK(status)) {
+			TALLOC_FREE(tmp_ctx);
+			tevent_req_nterror(req, status);
+			return tevent_req_post(req, ev);
+		}
+
+		state->out_output_buffer =
+			data_blob_talloc(state, data, data_size);
+		status  = NT_STATUS_OK;
+		TALLOC_FREE(tmp_ctx);
+		break;
+#else
 		tevent_req_nterror(req, NT_STATUS_NOT_SUPPORTED);
 		return tevent_req_post(req, ev);
+#endif
+	}
 
 	default:
 		DEBUG(10,("smbd_smb2_getinfo_send: "
diff -Npur samba-4.8.4/source3/smbd/smb2_setinfo.c samba-4.8.5/source3/smbd/smb2_setinfo.c
--- samba-4.8.4/source3/smbd/smb2_setinfo.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/smbd/smb2_setinfo.c	2018-08-24 09:58:20.000000000 +0200
@@ -28,6 +28,7 @@
 #include "../librpc/gen_ndr/open_files.h"
 #include "source3/lib/dbwrap/dbwrap_watch.h"
 #include "messages.h"
+#include "librpc/gen_ndr/ndr_quota.h"
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_SMB2
@@ -569,6 +570,46 @@ static struct tevent_req *smbd_smb2_seti
 		break;
 	}
 
+	case 0x04:/* SMB2_SETINFO_QUOTA */
+	{
+#ifdef HAVE_SYS_QUOTAS
+		struct file_quota_information info = {0};
+		SMB_NTQUOTA_STRUCT qt = {0};
+		enum ndr_err_code err;
+		int ret;
+
+		if (!fsp->fake_file_handle) {
+			tevent_req_nterror(req, NT_STATUS_INVALID_PARAMETER);
+			return tevent_req_post(req, ev);
+		}
+		err = ndr_pull_struct_blob(
+			&in_input_buffer, state, &info,
+			(ndr_pull_flags_fn_t)ndr_pull_file_quota_information);
+		if (!NDR_ERR_CODE_IS_SUCCESS(err)) {
+			tevent_req_nterror(req, NT_STATUS_UNSUCCESSFUL);
+			return tevent_req_post(req, ev);
+		}
+
+		qt.usedspace = info.quota_used;
+
+		qt.softlim = info.quota_threshold;
+
+		qt.hardlim = info.quota_limit;
+
+		qt.sid = info.sid;
+		ret = vfs_set_ntquota(fsp, SMB_USER_QUOTA_TYPE, &qt.sid, &qt);
+		if (ret !=0 ) {
+			status = map_nt_error_from_unix(errno);
+			tevent_req_nterror(req, status);
+			return tevent_req_post(req, ev);
+		}
+		status = NT_STATUS_OK;
+		break;
+#else
+		tevent_req_nterror(req, NT_STATUS_NOT_SUPPORTED);
+		return tevent_req_post(req, ev);
+#endif
+	}
 	default:
 		tevent_req_nterror(req, NT_STATUS_INVALID_PARAMETER);
 		return tevent_req_post(req, ev);
diff -Npur samba-4.8.4/source3/smbd/trans2.c samba-4.8.5/source3/smbd/trans2.c
--- samba-4.8.4/source3/smbd/trans2.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source3/smbd/trans2.c	2018-08-24 09:58:20.000000000 +0200
@@ -3452,7 +3452,8 @@ NTSTATUS smbd_do_qfsinfo(struct smbXsrv_
 	ZERO_STRUCT(smb_fname);
 	smb_fname.base_name = discard_const_p(char, filename);
 
-	if(SMB_VFS_STAT(conn, &smb_fname) != 0) {
+	if(info_level != SMB_FS_QUOTA_INFORMATION
+	   && SMB_VFS_STAT(conn, &smb_fname) != 0) {
 		DEBUG(2,("stat of . failed (%s)\n", strerror(errno)));
 		return map_nt_error_from_unix(errno);
 	}
diff -Npur samba-4.8.4/source3/smbd/uid.c samba-4.8.5/source3/smbd/uid.c
--- samba-4.8.4/source3/smbd/uid.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/smbd/uid.c	2018-08-24 09:58:20.000000000 +0200
@@ -202,6 +202,7 @@ static bool check_user_ok(connection_str
 			conn->session_info = ent->session_info;
 			conn->read_only = ent->read_only;
 			conn->share_access = ent->share_access;
+			conn->vuid = ent->vuid;
 			return(True);
 		}
 	}
@@ -250,6 +251,7 @@ static bool check_user_ok(connection_str
 	ent->share_access = share_access;
 	free_conn_session_info_if_unused(conn);
 	conn->session_info = ent->session_info;
+	conn->vuid = ent->vuid;
 	if (vuid == UID_FIELD_INVALID) {
 		/*
 		 * Not strictly needed, just make it really
diff -Npur samba-4.8.4/source3/torture/torture.c samba-4.8.5/source3/torture/torture.c
--- samba-4.8.4/source3/torture/torture.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/source3/torture/torture.c	2018-08-24 09:58:20.000000000 +0200
@@ -43,6 +43,7 @@
 #include "lib/util/sys_rw_data.h"
 #include "lib/util/base64.h"
 #include "lib/util/time.h"
+#include "lib/crypto/md5.h"
 
 extern char *optarg;
 extern int optind;
@@ -9239,6 +9240,157 @@ static bool run_cli_echo(int dummy)
 	return NT_STATUS_IS_OK(status);
 }
 
+static int splice_status(off_t written, void *priv)
+{
+        return true;
+}
+
+static bool run_cli_splice(int dummy)
+{
+	uint8_t *buf = NULL;
+	struct cli_state *cli1 = NULL;
+	bool correct = false;
+	const char *fname_src = "\\splice_src.dat";
+	const char *fname_dst = "\\splice_dst.dat";
+	NTSTATUS status;
+	uint16_t fnum1 = UINT16_MAX;
+	uint16_t fnum2 = UINT16_MAX;
+	size_t file_size = 2*1024*1024;
+	size_t splice_size = 1*1024*1024 + 713;
+	MD5_CTX md5_ctx;
+	uint8_t digest1[16], digest2[16];
+	off_t written = 0;
+	size_t nread = 0;
+	TALLOC_CTX *frame = talloc_stackframe();
+
+	printf("starting cli_splice test\n");
+
+	if (!torture_open_connection(&cli1, 0)) {
+		goto out;
+	}
+
+	cli_unlink(cli1, fname_src,
+		FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+	cli_unlink(cli1, fname_dst,
+		FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+
+	/* Create a file */
+	status = cli_ntcreate(cli1, fname_src, 0, GENERIC_ALL_ACCESS,
+			FILE_ATTRIBUTE_NORMAL, 0, FILE_OVERWRITE_IF,
+			0, 0, &fnum1, NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("open %s failed: %s\n", fname_src, nt_errstr(status));
+		goto out;
+	}
+
+	/* Write file_size bytes - must be bigger than splice_size. */
+	buf = talloc_zero_array(frame, uint8_t, file_size);
+	if (buf == NULL) {
+		d_printf("talloc_fail\n");
+		goto out;
+	}
+
+	/* Fill it with random numbers. */
+	generate_random_buffer(buf, file_size);
+
+	/* MD5 the first 1MB + 713 bytes. */
+	MD5Init(&md5_ctx);
+	MD5Update(&md5_ctx, buf, splice_size);
+	MD5Final(digest1, &md5_ctx);
+
+	status = cli_writeall(cli1,
+			      fnum1,
+			      0,
+			      buf,
+			      0,
+			      file_size,
+			      NULL);
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_writeall failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+
+	status = cli_ntcreate(cli1, fname_dst, 0, GENERIC_ALL_ACCESS,
+			FILE_ATTRIBUTE_NORMAL, 0, FILE_OVERWRITE_IF,
+			0, 0, &fnum2, NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("open %s failed: %s\n", fname_dst, nt_errstr(status));
+		goto out;
+	}
+
+	/* Now splice 1MB + 713 bytes. */
+	status = cli_splice(cli1,
+				cli1,
+				fnum1,
+				fnum2,
+				splice_size,
+				0,
+				0,
+				&written,
+				splice_status,
+				NULL);
+
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_splice failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+
+	/* Clear the old buffer. */
+	memset(buf, '\0', file_size);
+
+	/* Read the new file. */
+	status = cli_read(cli1, fnum2, (char *)buf, 0, splice_size, &nread);
+	if (!NT_STATUS_IS_OK(status)) {
+		d_printf("cli_read failed: %s\n", nt_errstr(status));
+		goto out;
+	}
+	if (nread != splice_size) {
+		d_printf("bad read of 0x%x, should be 0x%x\n",
+			(unsigned int)nread,
+			(unsigned int)splice_size);
+		goto out;
+	}
+
+	/* MD5 the first 1MB + 713 bytes. */
+	MD5Init(&md5_ctx);
+	MD5Update(&md5_ctx, buf, splice_size);
+	MD5Final(digest2, &md5_ctx);
+
+	/* Must be the same. */
+	if (memcmp(digest1, digest2, 16) != 0) {
+		d_printf("bad MD5 compare\n");
+		goto out;
+	}
+
+	correct = true;
+	printf("Success on cli_splice test\n");
+
+  out:
+
+	if (cli1) {
+		if (fnum1 != UINT16_MAX) {
+			cli_close(cli1, fnum1);
+		}
+		if (fnum2 != UINT16_MAX) {
+			cli_close(cli1, fnum2);
+		}
+
+		cli_unlink(cli1, fname_src,
+			FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+		cli_unlink(cli1, fname_dst,
+			FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
+
+		if (!torture_close_connection(cli1)) {
+			correct = false;
+		}
+	}
+
+	TALLOC_FREE(frame);
+	return correct;
+}
+
 static bool run_uid_regression_test(int dummy)
 {
 	static struct cli_state *cli;
@@ -11650,6 +11802,7 @@ static struct {
 	{ "NTTRANS-CREATE", run_nttrans_create, 0},
 	{ "NTTRANS-FSCTL", run_nttrans_fsctl, 0},
 	{ "CLI_ECHO", run_cli_echo, 0},
+	{ "CLI_SPLICE", run_cli_splice, 0},
 	{ "TLDAP", run_tldap },
 	{ "STREAMERROR", run_streamerror },
 	{ "NOTIFY-BENCH", run_notify_bench },
diff -Npur samba-4.8.4/source3/utils/smbcquotas.c samba-4.8.5/source3/utils/smbcquotas.c
--- samba-4.8.4/source3/utils/smbcquotas.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source3/utils/smbcquotas.c	2018-08-24 09:58:20.000000000 +0200
@@ -533,7 +533,8 @@ static struct cli_state *connect_one(con
 					    share, "?????",
 					    get_cmdline_auth_info_username(
 						popt_get_cmdline_auth_info()),
-					    lp_workgroup(),
+					    get_cmdline_auth_info_domain(
+						popt_get_cmdline_auth_info()),
 					    get_cmdline_auth_info_password(
 						popt_get_cmdline_auth_info()),
 					    flags,
diff -Npur samba-4.8.4/source3/winbindd/winbindd_util.c samba-4.8.5/source3/winbindd/winbindd_util.c
--- samba-4.8.4/source3/winbindd/winbindd_util.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.5/source3/winbindd/winbindd_util.c	2018-08-24 09:58:20.000000000 +0200
@@ -1605,6 +1605,8 @@ bool parse_domain_user(const char *domus
 		} else if (assume_domain(lp_workgroup())) {
 			fstrcpy(domain, lp_workgroup());
 			fstrcpy(namespace, domain);
+		} else {
+			fstrcpy(namespace, lp_netbios_name());
 		}
 	}
 
diff -Npur samba-4.8.4/source3/wscript_build samba-4.8.5/source3/wscript_build
--- samba-4.8.4/source3/wscript_build	2018-01-25 20:55:34.000000000 +0100
+++ samba-4.8.5/source3/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -458,6 +458,7 @@ bld.SAMBA3_LIBRARY('libsmb',
                         LIBTSOCKET
                         KRBCLIENT
                         NDR_IOCTL
+			NDR_QUOTA
                         cli_smb_common
                         util_cmdline
                         tevent
@@ -728,6 +729,7 @@ bld.SAMBA3_LIBRARY('smbd_base',
                         NDR_IOCTL
                         notifyd
                         vfs_acl_common
+                        NDR_QUOTA
                    ''' +
                    bld.env['dmapi_lib'] +
                    bld.env['legacy_quota_libs'] +
diff -Npur samba-4.8.4/source4/dns_server/dnsserver_common.c samba-4.8.5/source4/dns_server/dnsserver_common.c
--- samba-4.8.4/source4/dns_server/dnsserver_common.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source4/dns_server/dnsserver_common.c	2018-08-24 09:58:20.000000000 +0200
@@ -379,6 +379,7 @@ static struct ldb_parse_tree *build_wild
 			wildcard_query->u.list.elements[l] = el;
 
 			/* skip to the start of the next label */
+			x++;
 			for (;x < name->length && name->data[x] != '.'; x++);
 		}
 
diff -Npur samba-4.8.4/source4/libcli/raw/clitransport.c samba-4.8.5/source4/libcli/raw/clitransport.c
--- samba-4.8.4/source4/libcli/raw/clitransport.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/raw/clitransport.c	2018-08-24 09:58:20.000000000 +0200
@@ -114,6 +114,50 @@ struct smbcli_transport *smbcli_transpor
 }
 
 /*
+  create a transport structure based on an established socket
+*/
+NTSTATUS smbcli_transport_raw_init(TALLOC_CTX *mem_ctx,
+				   struct tevent_context *ev,
+				   struct smbXcli_conn **_conn,
+				   const struct smbcli_options *options,
+				   struct smbcli_transport **_transport)
+{
+	struct smbcli_transport *transport = NULL;
+	NTSTATUS status;
+
+	if (*_conn == NULL) {
+		return NT_STATUS_INVALID_PARAMETER;
+	}
+
+	transport = talloc_zero(mem_ctx, struct smbcli_transport);
+	if (transport == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	transport->ev = ev;
+	transport->options = *options;
+
+	/*
+	 * First only set the pointer without move.
+	 */
+	transport->conn = *_conn;
+	status = smb_raw_negotiate_fill_transport(transport);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(transport);
+		return status;
+	}
+
+	talloc_set_destructor(transport, transport_destructor);
+
+	/*
+	 * Now move it away from the caller...
+	 */
+	transport->conn = talloc_move(transport, _conn);
+	*_transport = transport;
+	return NT_STATUS_OK;
+}
+
+/*
   mark the transport as dead
 */
 void smbcli_transport_dead(struct smbcli_transport *transport, NTSTATUS status)
diff -Npur samba-4.8.4/source4/libcli/raw/clitree.c samba-4.8.5/source4/libcli/raw/clitree.c
--- samba-4.8.4/source4/libcli/raw/clitree.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/raw/clitree.c	2018-08-24 09:58:20.000000000 +0200
@@ -207,6 +207,7 @@ NTSTATUS smbcli_tree_full_connection(TAL
 	io.in.called_name = strupper_talloc(tmp_ctx, dest_host);
 	io.in.service = service;
 	io.in.service_type = service_type;
+	io.in.existing_conn = NULL;
 	io.in.credentials = credentials;
 	io.in.gensec_settings = gensec_settings;
 	io.in.fallback_to_anonymous = false;
diff -Npur samba-4.8.4/source4/libcli/raw/rawnegotiate.c samba-4.8.5/source4/libcli/raw/rawnegotiate.c
--- samba-4.8.4/source4/libcli/raw/rawnegotiate.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source4/libcli/raw/rawnegotiate.c	2018-08-24 09:58:20.000000000 +0200
@@ -28,6 +28,47 @@
 #include "../libcli/smb/smbXcli_base.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+NTSTATUS smb_raw_negotiate_fill_transport(struct smbcli_transport *transport)
+{
+	struct smbcli_negotiate *n = &transport->negotiate;
+	struct smbXcli_conn *c = transport->conn;
+	NTTIME ntt;
+
+	n->protocol = smbXcli_conn_protocol(c);
+	if (n->protocol > PROTOCOL_NT1) {
+		return NT_STATUS_REVISION_MISMATCH;
+	}
+
+	n->sec_mode = smb1cli_conn_server_security_mode(c);
+	n->max_mux  = smbXcli_conn_max_requests(c);
+	n->max_xmit = smb1cli_conn_max_xmit(c);
+	n->sesskey  = smb1cli_conn_server_session_key(c);
+	n->capabilities = smb1cli_conn_capabilities(c);;
+
+	/* this time arrives in real GMT */
+	ntt = smbXcli_conn_server_system_time(c);
+	n->server_time = nt_time_to_unix(ntt);
+	n->server_zone = smb1cli_conn_server_time_zone(c);
+
+	if (n->capabilities & CAP_EXTENDED_SECURITY) {
+		const DATA_BLOB *b = smbXcli_conn_server_gss_blob(c);
+		if (b) {
+			n->secblob = *b;
+		}
+	} else {
+		const uint8_t *p = smb1cli_conn_server_challenge(c);
+		if (p) {
+			n->secblob = data_blob_const(p, 8);
+		}
+	}
+
+	n->readbraw_supported = smb1cli_conn_server_readbraw(c);
+	n->readbraw_supported = smb1cli_conn_server_writebraw(c);
+	n->lockread_supported = smb1cli_conn_server_lockread(c);
+
+	return NT_STATUS_OK;
+}
+
 struct smb_raw_negotiate_state {
 	struct smbcli_transport *transport;
 };
@@ -82,10 +123,7 @@ static void smb_raw_negotiate_done(struc
 	struct smb_raw_negotiate_state *state =
 		tevent_req_data(req,
 		struct smb_raw_negotiate_state);
-	struct smbcli_negotiate *n = &state->transport->negotiate;
-	struct smbXcli_conn *c = state->transport->conn;
 	NTSTATUS status;
-	NTTIME ntt;
 
 	status = smbXcli_negprot_recv(subreq);
 	TALLOC_FREE(subreq);
@@ -93,35 +131,11 @@ static void smb_raw_negotiate_done(struc
 		return;
 	}
 
-	n->protocol = smbXcli_conn_protocol(c);
-
-	n->sec_mode = smb1cli_conn_server_security_mode(c);
-	n->max_mux  = smbXcli_conn_max_requests(c);
-	n->max_xmit = smb1cli_conn_max_xmit(c);
-	n->sesskey  = smb1cli_conn_server_session_key(c);
-	n->capabilities = smb1cli_conn_capabilities(c);;
-
-	/* this time arrives in real GMT */
-	ntt = smbXcli_conn_server_system_time(c);
-	n->server_time = nt_time_to_unix(ntt);
-	n->server_zone = smb1cli_conn_server_time_zone(c);
-
-	if (n->capabilities & CAP_EXTENDED_SECURITY) {
-		const DATA_BLOB *b = smbXcli_conn_server_gss_blob(c);
-		if (b) {
-			n->secblob = *b;
-		}
-	} else {
-		const uint8_t *p = smb1cli_conn_server_challenge(c);
-		if (p) {
-			n->secblob = data_blob_const(p, 8);
-		}
+	status = smb_raw_negotiate_fill_transport(state->transport);
+	if (tevent_req_nterror(req, status)) {
+		return;
 	}
 
-	n->readbraw_supported = smb1cli_conn_server_readbraw(c);
-	n->readbraw_supported = smb1cli_conn_server_writebraw(c);
-	n->lockread_supported = smb1cli_conn_server_lockread(c);
-
 	tevent_req_done(req);
 }
 
diff -Npur samba-4.8.4/source4/libcli/smb2/connect.c samba-4.8.5/source4/libcli/smb2/connect.c
--- samba-4.8.4/source4/libcli/smb2/connect.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb2/connect.c	2018-08-24 09:58:20.000000000 +0200
@@ -35,6 +35,7 @@
 struct smb2_connect_state {
 	struct tevent_context *ev;
 	struct cli_credentials *credentials;
+	bool fallback_to_anonymous;
 	uint64_t previous_session_id;
 	struct resolve_context *resolve_ctx;
 	const char *host;
@@ -50,6 +51,7 @@ struct smb2_connect_state {
 	struct smb2_tree *tree;
 };
 
+static void smb2_connect_session_start(struct tevent_req *req);
 static void smb2_connect_socket_done(struct composite_context *creq);
 
 /*
@@ -63,6 +65,8 @@ struct tevent_req *smb2_connect_send(TAL
 				     const char *share,
 				     struct resolve_context *resolve_ctx,
 				     struct cli_credentials *credentials,
+				     bool fallback_to_anonymous,
+				     struct smbXcli_conn **existing_conn,
 				     uint64_t previous_session_id,
 				     const struct smbcli_options *options,
 				     const char *socket_options,
@@ -81,6 +85,7 @@ struct tevent_req *smb2_connect_send(TAL
 
 	state->ev = ev;
 	state->credentials = credentials;
+	state->fallback_to_anonymous = fallback_to_anonymous;
 	state->previous_session_id = previous_session_id;
 	state->options = *options;
 	state->host = host;
@@ -106,6 +111,25 @@ struct tevent_req *smb2_connect_send(TAL
 		return tevent_req_post(req, ev);
 	}
 
+	if (existing_conn != NULL) {
+		NTSTATUS status;
+
+		status = smb2_transport_raw_init(state, ev,
+						 existing_conn,
+						 options,
+						 &state->transport);
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
+
+		smb2_connect_session_start(req);
+		if (!tevent_req_is_in_progress(req)) {
+			return tevent_req_post(req, ev);
+		}
+
+		return req;
+	}
+
 	creq = smbcli_sock_connect_send(state, NULL, state->ports,
 					state->host, state->resolve_ctx,
 					state->ev, state->socket_options,
@@ -170,10 +194,6 @@ static void smb2_connect_negprot_done(st
 	struct tevent_req *req =
 		tevent_req_callback_data(subreq,
 		struct tevent_req);
-	struct smb2_connect_state *state =
-		tevent_req_data(req,
-		struct smb2_connect_state);
-	struct smb2_transport *transport = state->transport;
 	NTSTATUS status;
 
 	status = smbXcli_negprot_recv(subreq);
@@ -182,6 +202,17 @@ static void smb2_connect_negprot_done(st
 		return;
 	}
 
+	smb2_connect_session_start(req);
+}
+
+static void smb2_connect_session_start(struct tevent_req *req)
+{
+	struct smb2_connect_state *state =
+		tevent_req_data(req,
+		struct smb2_connect_state);
+	struct smb2_transport *transport = state->transport;
+	struct tevent_req *subreq = NULL;
+
 	state->session = smb2_session_init(transport, state->gensec_settings, state);
 	if (tevent_req_nomem(state->session, req)) {
 		return;
@@ -212,6 +243,34 @@ static void smb2_connect_session_done(st
 
 	status = smb2_session_setup_spnego_recv(subreq);
 	TALLOC_FREE(subreq);
+	if (!NT_STATUS_IS_OK(status) &&
+	    !cli_credentials_is_anonymous(state->credentials) &&
+	    state->fallback_to_anonymous) {
+		struct cli_credentials *anon_creds = NULL;
+
+		/*
+		 * The transport was moved to session,
+		 * we need to revert that before removing
+		 * the old broken session.
+		 */
+		state->transport = talloc_move(state, &state->session->transport);
+		TALLOC_FREE(state->session);
+
+		anon_creds = cli_credentials_init_anon(state);
+		if (tevent_req_nomem(anon_creds, req)) {
+			return;
+		}
+		cli_credentials_set_workstation(anon_creds,
+		   cli_credentials_get_workstation(state->credentials),
+		   CRED_SPECIFIED);
+
+		/*
+		 * retry with anonymous credentials
+		 */
+		state->credentials = anon_creds;
+		smb2_connect_session_start(req);
+		return;
+	}
 	if (tevent_req_nterror(req, status)) {
 		return;
 	}
@@ -303,6 +362,8 @@ NTSTATUS smb2_connect_ext(TALLOC_CTX *me
 				   share,
 				   resolve_ctx,
 				   credentials,
+				   false, /* fallback_to_anonymous */
+				   NULL, /* existing_conn */
 				   previous_session_id,
 				   options,
 				   socket_options,
diff -Npur samba-4.8.4/source4/libcli/smb2/session.c samba-4.8.5/source4/libcli/smb2/session.c
--- samba-4.8.4/source4/libcli/smb2/session.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb2/session.c	2018-08-24 09:58:20.000000000 +0200
@@ -196,13 +196,38 @@ struct tevent_req *smb2_session_setup_sp
 
 	if (state->out_secblob.length > 0) {
 		chosen_oid = GENSEC_OID_SPNEGO;
+		status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(1, ("Failed to start set GENSEC client mechanism %s: %s\n",
+				  gensec_get_name_by_oid(session->gensec,
+							 chosen_oid),
+				  nt_errstr(status)));
+			state->out_secblob = data_blob_null;
+			chosen_oid = GENSEC_OID_NTLMSSP;
+			status = gensec_start_mech_by_oid(session->gensec,
+							  chosen_oid);
+			if (!NT_STATUS_IS_OK(status)) {
+				DEBUG(1, ("Failed to start set (fallback) GENSEC client mechanism %s: %s\n",
+					  gensec_get_name_by_oid(session->gensec,
+								 chosen_oid),
+					  nt_errstr(status)));
+			}
+		}
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 	} else {
 		chosen_oid = GENSEC_OID_NTLMSSP;
-	}
-
-	status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
-	if (tevent_req_nterror(req, status)) {
-		return tevent_req_post(req, ev);
+		status = gensec_start_mech_by_oid(session->gensec, chosen_oid);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(1, ("Failed to start set GENSEC client mechanism %s: %s\n",
+				  gensec_get_name_by_oid(session->gensec,
+							 chosen_oid),
+				  nt_errstr(status)));
+		}
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 	}
 
 	smb2_session_setup_spnego_gensec_next(req);
diff -Npur samba-4.8.4/source4/libcli/smb2/transport.c samba-4.8.5/source4/libcli/smb2/transport.c
--- samba-4.8.4/source4/libcli/smb2/transport.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb2/transport.c	2018-08-24 09:58:20.000000000 +0200
@@ -86,6 +86,41 @@ struct smb2_transport *smb2_transport_in
 }
 
 /*
+  create a transport structure based on an established socket
+*/
+NTSTATUS smb2_transport_raw_init(TALLOC_CTX *mem_ctx,
+				 struct tevent_context *ev,
+				 struct smbXcli_conn **_conn,
+				 const struct smbcli_options *options,
+				 struct smb2_transport **_transport)
+{
+	struct smb2_transport *transport = NULL;
+	enum protocol_types protocol;
+
+	if (*_conn == NULL) {
+		return NT_STATUS_INVALID_PARAMETER;
+	}
+
+	protocol = smbXcli_conn_protocol(*_conn);
+	if (protocol < PROTOCOL_SMB2_02) {
+		return NT_STATUS_REVISION_MISMATCH;
+	}
+
+	transport = talloc_zero(mem_ctx, struct smb2_transport);
+	if (transport == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	transport->ev = ev;
+	transport->options = *options;
+	transport->conn = talloc_move(transport, _conn);
+
+	talloc_set_destructor(transport, transport_destructor);
+	*_transport = transport;
+	return NT_STATUS_OK;
+}
+
+/*
   mark the transport as dead
 */
 void smb2_transport_dead(struct smb2_transport *transport, NTSTATUS status)
diff -Npur samba-4.8.4/source4/libcli/smb_composite/connect.c samba-4.8.5/source4/libcli/smb_composite/connect.c
--- samba-4.8.4/source4/libcli/smb_composite/connect.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb_composite/connect.c	2018-08-24 09:58:20.000000000 +0200
@@ -228,18 +228,10 @@ static NTSTATUS connect_session_setup(st
 	return NT_STATUS_OK;
 }
 
-/*
-  a negprot request has completed
-*/
-static NTSTATUS connect_negprot(struct composite_context *c, 
-				struct smb_composite_connect *io)
+static NTSTATUS connect_send_session(struct composite_context *c,
+				     struct smb_composite_connect *io)
 {
 	struct connect_state *state = talloc_get_type(c->private_data, struct connect_state);
-	NTSTATUS status;
-
-	status = smb_raw_negotiate_recv(state->subreq);
-	TALLOC_FREE(state->subreq);
-	NT_STATUS_NOT_OK_RETURN(status);
 
 	/* next step is a session setup */
 	state->session = smbcli_session_init(state->transport, state, true, io->in.session_options);
@@ -282,6 +274,22 @@ static NTSTATUS connect_negprot(struct c
 }
 
 /*
+  a negprot request has completed
+*/
+static NTSTATUS connect_negprot(struct composite_context *c,
+				struct smb_composite_connect *io)
+{
+	struct connect_state *state = talloc_get_type(c->private_data, struct connect_state);
+	NTSTATUS status;
+
+	status = smb_raw_negotiate_recv(state->subreq);
+	TALLOC_FREE(state->subreq);
+	NT_STATUS_NOT_OK_RETURN(status);
+
+	return connect_send_session(c, io);
+}
+
+/*
   setup a negprot send 
 */
 static NTSTATUS connect_send_negprot(struct composite_context *c, 
@@ -432,6 +440,26 @@ struct composite_context *smb_composite_
 	nbt_choose_called_name(state, &state->called,
 			       io->in.called_name, NBT_NAME_SERVER);
 
+	if (io->in.existing_conn != NULL) {
+		NTSTATUS status;
+
+		status = smbcli_transport_raw_init(state,
+						   c->event_ctx,
+						   &io->in.existing_conn,
+						   &io->in.options,
+						   &state->transport);
+		if (!NT_STATUS_IS_OK(status)) {
+			goto failed;
+		}
+
+		status = connect_send_session(c, io);
+		if (!NT_STATUS_IS_OK(status)) {
+			goto failed;
+		}
+
+		return c;
+	}
+
 	state->creq = smbcli_sock_connect_send(state, 
 					       NULL,
 					       io->in.dest_ports,
diff -Npur samba-4.8.4/source4/libcli/smb_composite/connect_nego.c samba-4.8.5/source4/libcli/smb_composite/connect_nego.c
--- samba-4.8.4/source4/libcli/smb_composite/connect_nego.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb_composite/connect_nego.c	2018-08-24 09:58:20.000000000 +0200
@@ -0,0 +1,209 @@
+/*
+   Unix SMB/CIFS implementation.
+
+   Copyright (C) Stefan Metzmacher 2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "includes.h"
+#include "lib/util/tevent_ntstatus.h"
+#include "libcli/composite/composite.h"
+#include "libcli/raw/libcliraw.h"
+#include "libcli/raw/raw_proto.h"
+#include "libcli/smb_composite/smb_composite.h"
+#include "lib/socket/socket.h"
+#include "libcli/resolve/resolve.h"
+#include "librpc/gen_ndr/ndr_nbt.h"
+#include "libcli/smb/smbXcli_base.h"
+
+struct smb_connect_nego_state {
+	struct tevent_context *ev;
+	struct resolve_context *resolve_ctx;
+	const char *socket_options;
+	struct smbcli_options options;
+	const char *dest_hostname;
+	const char *dest_address;
+	const char **dest_ports;
+	const char *target_hostname;
+	struct nbt_name calling, called;
+	struct smbXcli_conn *conn;
+};
+
+static void smb_connect_nego_connect_done(struct composite_context *creq);
+static void smb_connect_nego_nego_done(struct tevent_req *subreq);
+
+struct tevent_req *smb_connect_nego_send(TALLOC_CTX *mem_ctx,
+					 struct tevent_context *ev,
+					 struct resolve_context *resolve_ctx,
+					 const struct smbcli_options *options,
+					 const char *socket_options,
+					 const char *dest_hostname,
+					 const char *dest_address, /* optional */
+					 const char **dest_ports,
+					 const char *target_hostname,
+					 const char *called_name,
+					 const char *calling_name)
+{
+	struct tevent_req *req = NULL;
+	struct smb_connect_nego_state *state = NULL;
+	struct composite_context *creq = NULL;
+
+	req = tevent_req_create(mem_ctx, &state,
+				struct smb_connect_nego_state);
+	if (req == NULL) {
+		return NULL;
+	}
+	state->ev = ev;
+	state->resolve_ctx= resolve_ctx;
+	state->options = *options;
+	state->socket_options = socket_options;
+	state->dest_hostname = dest_hostname;
+	state->dest_address = dest_address;
+	state->dest_ports = dest_ports;
+	state->target_hostname = target_hostname;
+
+	make_nbt_name_client(&state->calling, calling_name);
+
+	nbt_choose_called_name(state, &state->called,
+			       called_name, NBT_NAME_SERVER);
+	if (tevent_req_nomem(state->called.name, req)) {
+		return tevent_req_post(req, ev);
+	}
+
+	creq = smbcli_sock_connect_send(state,
+					state->dest_address,
+					state->dest_ports,
+					state->dest_hostname,
+					state->resolve_ctx,
+					state->ev,
+					state->socket_options,
+					&state->calling,
+					&state->called);
+	if (tevent_req_nomem(creq, req)) {
+		return tevent_req_post(req, ev);
+	}
+	creq->async.private_data = req;
+	creq->async.fn = smb_connect_nego_connect_done;
+
+	return req;
+}
+
+static void smb_connect_nego_connect_done(struct composite_context *creq)
+{
+	struct tevent_req *req =
+		talloc_get_type_abort(creq->async.private_data,
+		struct tevent_req);
+	struct smb_connect_nego_state *state =
+		tevent_req_data(req,
+		struct smb_connect_nego_state);
+	struct tevent_req *subreq = NULL;
+	struct smbcli_socket *sock = NULL;
+	uint32_t smb1_capabilities;
+	uint32_t timeout_msec = state->options.request_timeout * 1000;
+	NTSTATUS status;
+
+	status = smbcli_sock_connect_recv(creq, state, &sock);
+	creq = NULL;
+	if (tevent_req_nterror(req, status)) {
+		return;
+	}
+
+	TALLOC_FREE(sock->event.fde);
+	TALLOC_FREE(sock->event.te);
+
+	smb1_capabilities = 0;
+	smb1_capabilities |= CAP_LARGE_FILES;
+	smb1_capabilities |= CAP_NT_SMBS | CAP_RPC_REMOTE_APIS;
+	smb1_capabilities |= CAP_LOCK_AND_READ | CAP_NT_FIND;
+	smb1_capabilities |= CAP_DFS | CAP_W2K_SMBS;
+	smb1_capabilities |= CAP_LARGE_READX|CAP_LARGE_WRITEX;
+	smb1_capabilities |= CAP_LWIO;
+
+	if (state->options.ntstatus_support) {
+		smb1_capabilities |= CAP_STATUS32;
+	}
+
+	if (state->options.unicode) {
+		smb1_capabilities |= CAP_UNICODE;
+	}
+
+	if (state->options.use_spnego) {
+		smb1_capabilities |= CAP_EXTENDED_SECURITY;
+	}
+
+	if (state->options.use_level2_oplocks) {
+		smb1_capabilities |= CAP_LEVEL_II_OPLOCKS;
+	}
+
+	state->conn = smbXcli_conn_create(state,
+					  sock->sock->fd,
+					  state->target_hostname,
+					  state->options.signing,
+					  smb1_capabilities,
+					  &state->options.client_guid,
+					  state->options.smb2_capabilities);
+	if (tevent_req_nomem(state->conn, req)) {
+		return;
+	}
+	sock->sock->fd = -1;
+	TALLOC_FREE(sock);
+
+	subreq = smbXcli_negprot_send(state,
+				      state->ev,
+				      state->conn,
+				      timeout_msec,
+				      state->options.min_protocol,
+				      state->options.max_protocol,
+				      state->options.max_credits);
+	if (tevent_req_nomem(subreq, req)) {
+		return;
+	}
+	tevent_req_set_callback(subreq, smb_connect_nego_nego_done, req);
+}
+
+static void smb_connect_nego_nego_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req =
+		tevent_req_callback_data(subreq,
+		struct tevent_req);
+	NTSTATUS status;
+
+	status = smbXcli_negprot_recv(subreq);
+	TALLOC_FREE(subreq);
+	if (tevent_req_nterror(req, status)) {
+		return;
+	}
+
+	tevent_req_done(req);
+}
+
+NTSTATUS smb_connect_nego_recv(struct tevent_req *req,
+			       TALLOC_CTX *mem_ctx,
+			       struct smbXcli_conn **_conn)
+{
+	struct smb_connect_nego_state *state =
+		tevent_req_data(req,
+		struct smb_connect_nego_state);
+	NTSTATUS status;
+
+	if (tevent_req_is_nterror(req, &status)) {
+		tevent_req_received(req);
+		return status;
+	}
+
+	*_conn = talloc_move(mem_ctx, &state->conn);
+	tevent_req_received(req);
+	return NT_STATUS_OK;
+}
diff -Npur samba-4.8.4/source4/libcli/smb_composite/fetchfile.c samba-4.8.5/source4/libcli/smb_composite/fetchfile.c
--- samba-4.8.4/source4/libcli/smb_composite/fetchfile.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb_composite/fetchfile.c	2018-08-24 09:58:20.000000000 +0200
@@ -131,7 +131,7 @@ struct composite_context *smb_composite_
 	state = talloc(c, struct fetchfile_state);
 	if (state == NULL) goto failed;
 
-	state->connect = talloc(state, struct smb_composite_connect);
+	state->connect = talloc_zero(state, struct smb_composite_connect);
 	if (state->connect == NULL) goto failed;
 
 	state->io = io;
diff -Npur samba-4.8.4/source4/libcli/smb_composite/smb_composite.h samba-4.8.5/source4/libcli/smb_composite/smb_composite.h
--- samba-4.8.4/source4/libcli/smb_composite/smb_composite.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/smb_composite/smb_composite.h	2018-08-24 09:58:20.000000000 +0200
@@ -102,6 +102,28 @@ NTSTATUS smb_composite_savefile(struct s
 				struct smb_composite_savefile *io);
 
 /*
+  a composite request for a low level connection to a remote server. Includes
+
+    - socket establishment
+    - session request
+    - negprot
+*/
+struct tevent_req *smb_connect_nego_send(TALLOC_CTX *mem_ctx,
+					 struct tevent_context *ev,
+					 struct resolve_context *resolve_ctx,
+					 const struct smbcli_options *options,
+					 const char *socket_options,
+					 const char *dest_hostname,
+					 const char *dest_address, /* optional */
+					 const char **dest_ports,
+					 const char *target_hostname,
+					 const char *called_name,
+					 const char *calling_name);
+NTSTATUS smb_connect_nego_recv(struct tevent_req *req,
+			       TALLOC_CTX *mem_ctx,
+			       struct smbXcli_conn **_conn);
+
+/*
   a composite request for a full connection to a remote server. Includes
 
     - socket establishment
@@ -118,6 +140,7 @@ struct smb_composite_connect {
 		const char *called_name;
 		const char *service;
 		const char *service_type;
+		struct smbXcli_conn *existing_conn; /* optional */
 		struct cli_credentials *credentials;
 		bool fallback_to_anonymous;
 		const char *workgroup;
diff -Npur samba-4.8.4/source4/libcli/wscript_build samba-4.8.5/source4/libcli/wscript_build
--- samba-4.8.4/source4/libcli/wscript_build	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/libcli/wscript_build	2018-08-24 09:58:20.000000000 +0200
@@ -25,11 +25,21 @@ bld.SAMBA_SUBSYSTEM('cli_composite',
 
 
 bld.SAMBA_SUBSYSTEM('LIBCLI_SMB_COMPOSITE',
-	source='smb_composite/loadfile.c smb_composite/savefile.c smb_composite/connect.c smb_composite/sesssetup.c smb_composite/fetchfile.c smb_composite/appendacl.c smb_composite/fsinfo.c smb_composite/smb2.c',
-	deps='LIBCLI_SMB2 tevent-util',
-	public_deps='cli_composite samba-credentials gensec LIBCLI_RESOLVE tevent',
-	private_headers='smb_composite/smb_composite.h',
-	)
+    source='''
+       smb_composite/loadfile.c
+       smb_composite/savefile.c
+       smb_composite/connect_nego.c
+       smb_composite/connect.c
+       smb_composite/sesssetup.c
+       smb_composite/fetchfile.c
+       smb_composite/appendacl.c
+       smb_composite/fsinfo.c
+       smb_composite/smb2.c
+    ''',
+    deps='LIBCLI_SMB2 tevent-util',
+    public_deps='cli_composite samba-credentials gensec LIBCLI_RESOLVE tevent',
+    private_headers='smb_composite/smb_composite.h',
+    )
 
 bld.SAMBA_PYTHON('pysmb',
     source='pysmb.c',
diff -Npur samba-4.8.4/source4/librpc/rpc/dcerpc_connect.c samba-4.8.5/source4/librpc/rpc/dcerpc_connect.c
--- samba-4.8.4/source4/librpc/rpc/dcerpc_connect.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/source4/librpc/rpc/dcerpc_connect.c	2018-08-24 09:58:20.000000000 +0200
@@ -36,6 +36,7 @@
 #include "param/param.h"
 #include "libcli/resolve/resolve.h"
 #include "lib/http/http.h"
+#include "lib/util/util_net.h"
 
 struct dcerpc_pipe_connect {
 	struct dcecli_connection *conn;
@@ -76,6 +77,8 @@ static void continue_pipe_open_smb(struc
 }
 
 static void continue_smb_open(struct composite_context *c);
+static void continue_smb2_connect(struct tevent_req *subreq);
+static void continue_smbXcli_connect(struct tevent_req *subreq);
 
 /*
   Stage 2 of ncacn_np_smb: Open a named pipe after successful smb connection
@@ -132,9 +135,12 @@ static struct composite_context *dcerpc_
 {
 	struct composite_context *c;
 	struct pipe_np_smb_state *s;
-	struct composite_context *conn_req;
+	struct tevent_req *subreq = NULL;
 	struct smb_composite_connect *conn;
 	uint32_t flags;
+	const char *target_hostname = NULL;
+	const char *dest_address = NULL;
+	const char *calling_name = NULL;
 
 	/* composite context allocation and setup */
 	c = composite_create(mem_ctx, io->conn->event_ctx);
@@ -152,12 +158,17 @@ static struct composite_context *dcerpc_
 		return c;
 	}
 
+	if (s->io.creds == NULL) {
+		composite_error(c, NT_STATUS_INVALID_PARAMETER_MIX);
+		return c;
+	}
+
 	/* prepare smb connection parameters: we're connecting to IPC$ share on
 	   remote rpc server */
+	target_hostname = dcerpc_binding_get_string_option(s->io.binding, "target_hostname");
 	conn->in.dest_host = dcerpc_binding_get_string_option(s->io.binding, "host");
 	conn->in.dest_ports = lpcfg_smb_ports(lp_ctx);
-	conn->in.called_name =
-		dcerpc_binding_get_string_option(s->io.binding, "target_hostname");
+	conn->in.called_name = target_hostname;
 	if (conn->in.called_name == NULL) {
 		conn->in.called_name = "*SMBSERVER";
 	}
@@ -184,21 +195,113 @@ static struct composite_context *dcerpc_
 		conn->in.fallback_to_anonymous  = false;
 	}
 
-	conn->in.options.min_protocol = PROTOCOL_NT1;
-	conn->in.options.max_protocol = PROTOCOL_NT1;
+	conn->in.options.min_protocol = lpcfg_client_ipc_min_protocol(lp_ctx);
+	conn->in.options.max_protocol = lpcfg_client_ipc_max_protocol(lp_ctx);
+	if ((flags & DCERPC_SMB1) && (flags & DCERPC_SMB2)) {
+		/* auto */
+	} else if (flags & DCERPC_SMB2) {
+		if (conn->in.options.min_protocol < PROTOCOL_SMB2_02) {
+			conn->in.options.min_protocol = PROTOCOL_SMB2_02;
+		}
+		if (conn->in.options.max_protocol < PROTOCOL_SMB2_02) {
+			conn->in.options.max_protocol = PROTOCOL_LATEST;
+		}
+	} else if (flags & DCERPC_SMB1) {
+		conn->in.options.min_protocol = PROTOCOL_NT1;
+		conn->in.options.max_protocol = PROTOCOL_NT1;
+	} else {
+		/* auto */
+	}
 
 	conn->in.options.signing = lpcfg_client_ipc_signing(lp_ctx);
 
-	/* send smb connect request */
-	conn_req = smb_composite_connect_send(conn, s->io.conn,
-					      s->io.resolve_ctx,
-					      c->event_ctx);
-	if (composite_nomem(conn_req, c)) return c;
+	if (s->conn.in.credentials != NULL) {
+		calling_name = cli_credentials_get_workstation(s->conn.in.credentials);
+	}
+	if (calling_name == NULL) {
+		calling_name = "SMBCLIENT";
+	}
+
+	if (target_hostname == NULL) {
+		target_hostname = conn->in.dest_host;
+	}
+
+	if (is_ipaddress(conn->in.dest_host)) {
+		dest_address = conn->in.dest_host;
+	}
+
+	subreq = smb_connect_nego_send(s,
+				       c->event_ctx,
+				       s->io.resolve_ctx,
+				       &conn->in.options,
+				       conn->in.socket_options,
+				       conn->in.dest_host,
+				       dest_address,
+				       conn->in.dest_ports,
+				       target_hostname,
+				       conn->in.called_name,
+				       calling_name);
+	if (composite_nomem(subreq, c)) return c;
+	tevent_req_set_callback(subreq,
+				continue_smbXcli_connect,
+				c);
 
-	composite_continue(c, conn_req, continue_smb_connect, c);
 	return c;
 }
 
+static void continue_smbXcli_connect(struct tevent_req *subreq)
+{
+	struct composite_context *c =
+		tevent_req_callback_data(subreq,
+		struct composite_context);
+	struct pipe_np_smb_state *s =
+		talloc_get_type_abort(c->private_data,
+		struct pipe_np_smb_state);
+	struct smb_composite_connect *conn = &s->conn;
+	struct composite_context *creq = NULL;
+	enum protocol_types protocol;
+
+	c->status = smb_connect_nego_recv(subreq, s,
+					  &conn->in.existing_conn);
+	TALLOC_FREE(subreq);
+	if (!composite_is_ok(c)) return;
+
+	protocol = smbXcli_conn_protocol(conn->in.existing_conn);
+	if (protocol >= PROTOCOL_SMB2_02) {
+		/*
+		 * continue with smb2 session setup/tree connect
+		 * on the established connection.
+		 */
+		subreq = smb2_connect_send(s, c->event_ctx,
+				conn->in.dest_host,
+				conn->in.dest_ports,
+				conn->in.service,
+				s->io.resolve_ctx,
+				conn->in.credentials,
+				conn->in.fallback_to_anonymous,
+				&conn->in.existing_conn,
+				0, /* previous_session_id */
+				&conn->in.options,
+				conn->in.socket_options,
+				conn->in.gensec_settings);
+		if (composite_nomem(subreq, c)) return;
+		tevent_req_set_callback(subreq, continue_smb2_connect, c);
+		return;
+	}
+
+	/*
+	 * continue with smb1 session setup/tree connect
+	 * on the established connection.
+	 */
+	creq = smb_composite_connect_send(conn, s->io.conn,
+					  s->io.resolve_ctx,
+					  c->event_ctx);
+	if (composite_nomem(creq, c)) return;
+
+	composite_continue(c, creq, continue_smb_connect, c);
+	return;
+}
+
 
 /*
   Receive result of a rpc connection to a rpc pipe on SMB
@@ -238,91 +341,6 @@ static void continue_smb2_connect(struct
 }
 
 
-/* 
-   Initiate async open of a rpc connection request on SMB2 using
-   the binding structure to determine the endpoint and options
-*/
-static struct composite_context *dcerpc_pipe_connect_ncacn_np_smb2_send(
-					TALLOC_CTX *mem_ctx,
-					struct dcerpc_pipe_connect *io,
-					struct loadparm_context *lp_ctx)
-{
-	struct composite_context *c;
-	struct pipe_np_smb_state *s;
-	struct tevent_req *subreq;
-	struct smbcli_options options;
-	const char *host;
-	uint32_t flags;
-
-	/* composite context allocation and setup */
-	c = composite_create(mem_ctx, io->conn->event_ctx);
-	if (c == NULL) return NULL;
-
-	s = talloc_zero(c, struct pipe_np_smb_state);
-	if (composite_nomem(s, c)) return c;
-	c->private_data = s;
-
-	s->io = *io;
-
-	if (smbXcli_conn_is_connected(s->io.smb.conn)) {
-		continue_smb_open(c);
-		return c;
-	}
-
-	host = dcerpc_binding_get_string_option(s->io.binding, "host");
-	flags = dcerpc_binding_get_flags(s->io.binding);
-
-	/*
-	 * provide proper credentials - user supplied or anonymous in case this is
-	 * schannel connection
-	 */
-	if (flags & DCERPC_SCHANNEL) {
-		s->io.creds = cli_credentials_init_anon(mem_ctx);
-		if (composite_nomem(s->io.creds, c)) return c;
-	}
-
-	lpcfg_smbcli_options(lp_ctx, &options);
-
-	options.min_protocol = lpcfg_client_ipc_min_protocol(lp_ctx);
-	if (options.min_protocol < PROTOCOL_SMB2_02) {
-		options.min_protocol = PROTOCOL_SMB2_02;
-	}
-	options.max_protocol = lpcfg_client_ipc_max_protocol(lp_ctx);
-	if (options.max_protocol < PROTOCOL_SMB2_02) {
-		options.max_protocol = PROTOCOL_SMB2_02;
-	}
-
-	options.signing = lpcfg_client_ipc_signing(lp_ctx);
-
-	/* send smb2 connect request */
-	subreq = smb2_connect_send(s, c->event_ctx,
-			host,
-			lpcfg_parm_string_list(mem_ctx, lp_ctx, NULL, "smb2", "ports", NULL),
-			"IPC$",
-			s->io.resolve_ctx,
-			s->io.creds,
-			0, /* previous_session_id */
-			&options,
-			lpcfg_socket_options(lp_ctx),
-			lpcfg_gensec_settings(mem_ctx, lp_ctx));
-	if (composite_nomem(subreq, c)) return c;
-	tevent_req_set_callback(subreq, continue_smb2_connect, c);
-	return c;
-}
-
-
-/*
-  Receive result of a rpc connection to a rpc pipe on SMB2
-*/
-static NTSTATUS dcerpc_pipe_connect_ncacn_np_smb2_recv(struct composite_context *c)
-{
-	NTSTATUS status = composite_wait(c);
-	
-	talloc_free(c);
-	return status;
-}
-
-
 struct pipe_ip_tcp_state {
 	struct dcerpc_pipe_connect io;
 	const char *localaddr;
@@ -751,7 +769,6 @@ struct pipe_connect_state {
 
 static void continue_map_binding(struct composite_context *ctx);
 static void continue_connect(struct composite_context *c, struct pipe_connect_state *s);
-static void continue_pipe_connect_ncacn_np_smb2(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_np_smb(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_ip_tcp(struct composite_context *ctx);
 static void continue_pipe_connect_ncacn_http(struct composite_context *ctx);
@@ -790,15 +807,12 @@ static void continue_connect(struct comp
 	struct dcerpc_pipe_connect pc;
 
 	/* potential exits to another stage by sending an async request */
-	struct composite_context *ncacn_np_smb2_req;
 	struct composite_context *ncacn_np_smb_req;
 	struct composite_context *ncacn_ip_tcp_req;
 	struct composite_context *ncacn_http_req;
 	struct composite_context *ncacn_unix_req;
 	struct composite_context *ncalrpc_req;
 	enum dcerpc_transport_t transport;
-	enum protocol_types min_ipc_protocol;
-	uint32_t flags;
 
 	/* dcerpc pipe connect input parameters */
 	ZERO_STRUCT(pc);
@@ -809,29 +823,16 @@ static void continue_connect(struct comp
 	pc.resolve_ctx  = lpcfg_resolve_context(s->lp_ctx);
 
 	transport = dcerpc_binding_get_transport(s->binding);
-	flags = dcerpc_binding_get_flags(s->binding);
-
-	min_ipc_protocol = lpcfg_client_ipc_min_protocol(s->lp_ctx);
-	if (min_ipc_protocol >= PROTOCOL_SMB2_02) {
-		flags |= DCERPC_SMB2;
-	}
 
 	/* connect dcerpc pipe depending on required transport */
 	switch (transport) {
 	case NCACN_NP:
-		if (flags & DCERPC_SMB2) {
-			/* new varient of SMB a.k.a. SMB2 */
-			ncacn_np_smb2_req = dcerpc_pipe_connect_ncacn_np_smb2_send(c, &pc, s->lp_ctx);
-			composite_continue(c, ncacn_np_smb2_req, continue_pipe_connect_ncacn_np_smb2, c);
-			return;
-
-		} else {
-			/* good old ordinary SMB */
-			ncacn_np_smb_req = dcerpc_pipe_connect_ncacn_np_smb_send(c, &pc, s->lp_ctx);
-			composite_continue(c, ncacn_np_smb_req, continue_pipe_connect_ncacn_np_smb, c);
-			return;
-		}
-		break;
+		/*
+		 * SMB1/2/3...
+		 */
+		ncacn_np_smb_req = dcerpc_pipe_connect_ncacn_np_smb_send(c, &pc, s->lp_ctx);
+		composite_continue(c, ncacn_np_smb_req, continue_pipe_connect_ncacn_np_smb, c);
+		return;
 
 	case NCACN_IP_TCP:
 		ncacn_ip_tcp_req = dcerpc_pipe_connect_ncacn_ip_tcp_send(c, &pc);
@@ -864,24 +865,6 @@ static void continue_connect(struct comp
 }
 
 
-/*
-  Stage 3 of pipe_connect_b: Receive result of pipe connect request on
-  named pipe on smb2
-*/
-static void continue_pipe_connect_ncacn_np_smb2(struct composite_context *ctx)
-{
-	struct composite_context *c = talloc_get_type(ctx->async.private_data,
-						      struct composite_context);
-	struct pipe_connect_state *s = talloc_get_type(c->private_data,
-						       struct pipe_connect_state);
-
-	c->status = dcerpc_pipe_connect_ncacn_np_smb2_recv(ctx);
-	if (!composite_is_ok(c)) return;
-
-	continue_pipe_connect(c, s);
-}
-
-
 /*
   Stage 3 of pipe_connect_b: Receive result of pipe connect request on
   named pipe on smb
diff -Npur samba-4.8.4/source4/ntvfs/cifs/vfs_cifs.c samba-4.8.5/source4/ntvfs/cifs/vfs_cifs.c
--- samba-4.8.4/source4/ntvfs/cifs/vfs_cifs.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.5/source4/ntvfs/cifs/vfs_cifs.c	2018-08-24 09:58:20.000000000 +0200
@@ -296,6 +296,7 @@ static NTSTATUS cvfs_connect(struct ntvf
 	io.in.dest_ports = lpcfg_smb_ports(ntvfs->ctx->lp_ctx);
 	io.in.socket_options = lpcfg_socket_options(ntvfs->ctx->lp_ctx);
 	io.in.called_name = host;
+	io.in.existing_conn = NULL;
 	io.in.credentials = credentials;
 	io.in.fallback_to_anonymous = false;
 	io.in.workgroup = lpcfg_workgroup(ntvfs->ctx->lp_ctx);
diff -Npur samba-4.8.4/source4/torture/basic/delete.c samba-4.8.5/source4/torture/basic/delete.c
--- samba-4.8.4/source4/torture/basic/delete.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source4/torture/basic/delete.c	2018-08-24 09:58:20.000000000 +0200
@@ -2101,6 +2101,92 @@ static bool deltest20b(struct torture_co
 	return correct;
 }
 
+/* Test 20c */
+/* Along the lines of deltest20 we try to open a non-empty directory with delete
+ * on close set and subsequent close to verify its presence in the tree.
+ */
+static bool deltest20c(struct torture_context *tctx, struct smbcli_state *cli1, struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	int dnum1 = -1;
+	int ret;
+	char *fullname;
+
+	del_clean_area(cli1, cli2);
+
+	smbcli_deltree(cli1->tree, dname);
+
+	/* Firstly open and create with all access */
+	dnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				      SEC_FILE_READ_DATA|
+				      SEC_FILE_WRITE_DATA|
+				      SEC_STD_DELETE,
+				      FILE_ATTRIBUTE_DIRECTORY,
+				      NTCREATEX_SHARE_ACCESS_READ|
+				      NTCREATEX_SHARE_ACCESS_WRITE|
+				      NTCREATEX_SHARE_ACCESS_DELETE,
+				      NTCREATEX_DISP_CREATE,
+				      NTCREATEX_OPTIONS_DIRECTORY, 0);
+	torture_assert(tctx, dnum1 != -1, talloc_asprintf(tctx, "open of %s failed: %s",
+		       dname, smbcli_errstr(cli1->tree)));
+
+	/* And close - just to create the directory */
+	smbcli_close(cli1->tree, dnum1);
+
+	ret = asprintf(&fullname, "\\%s%s", dname, fname);
+	torture_assert(tctx, ret != -1, "asprintf failed");
+
+	/* Open and create with all access */
+	fnum1 = smbcli_nt_create_full(cli1->tree, fullname, 0,
+				      SEC_RIGHTS_FILE_ALL,
+				      FILE_ATTRIBUTE_NORMAL,
+				      NTCREATEX_SHARE_ACCESS_READ|
+				      NTCREATEX_SHARE_ACCESS_WRITE|
+				      NTCREATEX_SHARE_ACCESS_DELETE,
+				      NTCREATEX_DISP_CREATE,
+				      0, 0);
+	torture_assert(tctx, fnum1 != -1, talloc_asprintf(tctx, "open of %s failed: %s",
+		       fname, smbcli_errstr(cli1->tree)));
+
+	/* And close - just to create the file. */
+	smbcli_close(cli1->tree, fnum1);
+
+	/* Open with all access, but add delete on close */
+	dnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				      SEC_FILE_READ_DATA|
+				      SEC_FILE_WRITE_DATA|
+				      SEC_STD_DELETE,
+				      FILE_ATTRIBUTE_DIRECTORY,
+				      NTCREATEX_SHARE_ACCESS_READ|
+				      NTCREATEX_SHARE_ACCESS_WRITE|
+				      NTCREATEX_SHARE_ACCESS_DELETE,
+				      NTCREATEX_DISP_OPEN,
+				      NTCREATEX_OPTIONS_DIRECTORY|NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+	/* Should work */
+	torture_assert(tctx, dnum1 != -1, talloc_asprintf(tctx, "open of %s failed: %s",
+		       dname, smbcli_errstr(cli1->tree)));
+
+	smbcli_close(cli1->tree, dnum1);
+
+	/* Try to open again */
+	dnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				      SEC_FILE_READ_DATA|
+				      SEC_FILE_WRITE_DATA|
+				      SEC_STD_DELETE,
+				      FILE_ATTRIBUTE_DIRECTORY,
+				      NTCREATEX_SHARE_ACCESS_READ|
+				      NTCREATEX_SHARE_ACCESS_WRITE|
+				      NTCREATEX_SHARE_ACCESS_DELETE,
+				      NTCREATEX_DISP_OPEN,
+				      NTCREATEX_OPTIONS_DIRECTORY, 0);
+	/* Directory should be still present*/
+	torture_assert(tctx, dnum1 != -1, talloc_asprintf(tctx, "open of %s failed: %s",
+		       dname, smbcli_errstr(cli1->tree)));
+
+	smbcli_close(cli1->tree, dnum1);
+
+	return true;
+}
 
 /* Test 21 ... */
 static bool deltest21(struct torture_context *tctx)
@@ -2526,6 +2612,7 @@ struct torture_suite *torture_test_delet
 	torture_suite_add_2smb_test(suite, "deltest20", deltest20);
 	torture_suite_add_2smb_test(suite, "deltest20a", deltest20a);
 	torture_suite_add_2smb_test(suite, "deltest20b", deltest20b);
+	torture_suite_add_2smb_test(suite, "deltest20c", deltest20c);
 	torture_suite_add_simple_test(suite, "deltest21", deltest21);
 	torture_suite_add_simple_test(suite, "deltest22", deltest22);
 	torture_suite_add_2smb_test(suite, "deltest23", deltest23);
diff -Npur samba-4.8.4/source4/torture/smb2/durable_v2_open.c samba-4.8.5/source4/torture/smb2/durable_v2_open.c
--- samba-4.8.4/source4/torture/smb2/durable_v2_open.c	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.5/source4/torture/smb2/durable_v2_open.c	2018-08-24 09:58:20.000000000 +0200
@@ -1518,9 +1518,15 @@ bool test_durable_v2_open_reopen2_lease_
 
 	options = tree->session->transport->options;
 
+	smb2_deltree(tree, __func__);
+	status = torture_smb2_testdir(tree, __func__, &_h);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir failed\n");
+	smb2_util_close(tree, _h);
+
 	/* Choose a random name in case the state is left a little funky. */
-	snprintf(fname, 256, "durable_v2_open_reopen2_%s.dat",
-		 generate_random_str(tctx, 8));
+	snprintf(fname, 256, "%s\\durable_v2_open_reopen2_%s.dat",
+		 __func__, generate_random_str(tctx, 8));
 
 	smb2_util_unlink(tree, fname);
 
@@ -1726,6 +1732,7 @@ done:
 	}
 
 	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, __func__);
 
 	talloc_free(tree);
 
diff -Npur samba-4.8.4/source4/torture/smb2/streams.c samba-4.8.5/source4/torture/smb2/streams.c
--- samba-4.8.4/source4/torture/smb2/streams.c	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.5/source4/torture/smb2/streams.c	2018-08-24 09:58:20.000000000 +0200
@@ -1830,6 +1830,86 @@ done:
 	return ret;
 }
 
+static bool test_basefile_rename_with_open_stream(struct torture_context *tctx,
+						  struct smb2_tree *tree)
+{
+	bool ret = true;
+	NTSTATUS status;
+	struct smb2_tree *tree2 = NULL;
+	struct smb2_create create, create2;
+	struct smb2_handle h1 = {{0}}, h2 = {{0}};
+	const char *fname = "test_rename_openfile";
+	const char *sname = "test_rename_openfile:foo";
+	const char *fname_renamed = "test_rename_openfile_renamed";
+	union smb_setfileinfo sinfo;
+	const char *data = "test data";
+
+	ret = torture_smb2_connection(tctx, &tree2);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_smb2_connection failed\n");
+
+	torture_comment(tctx, "Creating file with stream\n");
+
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_ALL;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN_IF;
+	create.in.impersonation_level = SMB2_IMPERSONATION_IMPERSONATION;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	h1 = create.out.file.handle;
+
+	torture_comment(tctx, "Writing to stream\n");
+
+	status = smb2_util_write(tree, h1, data, 0, strlen(data));
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
+	torture_comment(tctx, "Renaming base file\n");
+
+	ZERO_STRUCT(create2);
+	create2.in.desired_access = SEC_FILE_ALL;
+	create2.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create2.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create2.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create2.in.impersonation_level = SMB2_IMPERSONATION_IMPERSONATION;
+	create2.in.fname = fname;
+
+	status = smb2_create(tree2, tctx, &create2);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	h2 = create2.out.file.handle;
+
+	ZERO_STRUCT(sinfo);
+	sinfo.rename_information.level = RAW_SFILEINFO_RENAME_INFORMATION;
+	sinfo.rename_information.in.file.handle = h2;
+	sinfo.rename_information.in.new_name = fname_renamed;
+
+	status = smb2_setinfo_file(tree2, &sinfo);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_ACCESS_DENIED, ret, done,
+		"smb2_setinfo_file didn't return NT_STATUS_ACCESS_DENIED\n");
+
+	smb2_util_close(tree2, h2);
+
+done:
+	if (!smb2_util_handle_empty(h1)) {
+		smb2_util_close(tree, h1);
+	}
+	if (!smb2_util_handle_empty(h2)) {
+		smb2_util_close(tree2, h2);
+	}
+	smb2_util_unlink(tree, fname);
+	smb2_util_unlink(tree, fname_renamed);
+
+	return ret;
+}
 
 /*
    basic testing of streams calls SMB2
@@ -1850,6 +1930,8 @@ struct torture_suite *torture_smb2_strea
 	torture_suite_add_1smb2_test(suite, "attributes", test_stream_attributes);
 	torture_suite_add_1smb2_test(suite, "delete", test_stream_delete);
 	torture_suite_add_1smb2_test(suite, "zero-byte", test_zero_byte_stream);
+	torture_suite_add_1smb2_test(suite, "basefile-rename-with-open-stream",
+					test_basefile_rename_with_open_stream);
 
 	suite->description = talloc_strdup(suite, "SMB2-STREAM tests");
 
diff -Npur samba-4.8.4/source4/torture/vfs/fruit.c samba-4.8.5/source4/torture/vfs/fruit.c
--- samba-4.8.4/source4/torture/vfs/fruit.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.5/source4/torture/vfs/fruit.c	2018-08-24 09:58:20.000000000 +0200
@@ -1594,11 +1594,11 @@ static bool test_write_atalk_rfork_io(st
 
 	ret &= write_stream(tree, __location__, tctx, mem_ctx,
 			    fname, AFPRESOURCE_STREAM_NAME,
-			    (off_t)1<<32, 10, rfork_content);
+			    (off_t)64*1024*1024, 10, rfork_content);
 
 	ret &= check_stream(tree, __location__, tctx, mem_ctx,
 			    fname, AFPRESOURCE_STREAM_NAME,
-			    (off_t)1<<32, 10, 0, 10, rfork_content);
+			    (off_t)64*1024*1024, 10, 0, 10, rfork_content);
 
 	/* Truncate back to size of 1 byte */
 
@@ -3897,7 +3897,6 @@ static bool test_rename_and_read_rsrc(st
 	const char *fname_renamed = "test_rename_openfile_renamed";
 	const char *data = "1234567890";
 	union smb_setfileinfo sinfo;
-	struct smb2_read r;
 
 	ret = enable_aapl(tctx, tree);
 	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
@@ -3949,28 +3948,12 @@ static bool test_rename_and_read_rsrc(st
 	sinfo.rename_information.in.new_name = fname_renamed;
 
 	status = smb2_setinfo_file(tree, &sinfo);
-	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_setinfo_file failed");
-
-	smb2_util_close(tree, h2);
-
-	ZERO_STRUCT(r);
-	r.in.file.handle = h1;
-	r.in.length      = 10;
-	r.in.offset      = 0;
-
-	torture_comment(tctx, "Read resource fork of renamed file\n");
-
-	status = smb2_read(tree, tree, &r);
-	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_read failed");
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_ACCESS_DENIED, ret, done,
+		"smb2_setinfo_file failed");
 
 	smb2_util_close(tree, h1);
-
-	torture_assert_goto(tctx, r.out.data.length == 10, ret, done,
-			    talloc_asprintf(tctx, "smb2_read returned %jd bytes, expected 10\n",
-					    (intmax_t)r.out.data.length));
-
-	torture_assert_goto(tctx, memcmp(r.out.data.data, data, 10) == 0, ret, done,
-			    talloc_asprintf(tctx, "Bad data in stream\n"));
+	smb2_util_close(tree, h2);
 
 done:
 	smb2_util_unlink(tree, fname);
@@ -4595,6 +4578,202 @@ done:
 	return ret;
 }
 
+static bool test_setinfo_stream_eof(struct torture_context *tctx,
+				    struct smb2_tree *tree)
+{
+	bool ret = true;
+	NTSTATUS status;
+	struct smb2_create create;
+	union smb_setfileinfo sfinfo;
+	union smb_fileinfo finfo;
+	struct smb2_handle h1;
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	const char *fname = BASEDIR "\\file";
+	const char *sname = BASEDIR "\\file:foo";
+
+	torture_assert_goto(tctx, mem_ctx != NULL, ret, done,
+			    "talloc_new failed\n");
+
+	torture_comment(tctx, "Test setting EOF on a stream\n");
+
+	smb2_deltree(tree, BASEDIR);
+	status = torture_smb2_testdir(tree, BASEDIR, &h1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir\n");
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile(tree, fname, &h1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	status = smb2_util_write(tree, h1, "1234567890", 0, 10);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+	smb2_util_close(tree, h1);
+
+	/*
+	 * Test setting EOF to 21
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 21\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 21;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status,
+					ret, done, "set EOF 21 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 21,
+			    ret, done, "size != 21\n");
+
+	/*
+	 * Test setting EOF to 0
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 0\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 0;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed\n");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 0,
+			    ret, done, "size != 0\n");
+
+	/*
+	 * Test setinfo end-of-file info to 1
+	 */
+
+	torture_comment(tctx, "Setting stream EOF to 1\n");
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 1;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set EOF 1 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(finfo);
+	finfo.generic.level = RAW_FILEINFO_STANDARD_INFORMATION;
+	finfo.generic.in.file.handle = h1;
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed\n");
+
+	smb2_util_close(tree, h1);
+
+	torture_assert_goto(tctx, finfo.standard_info.out.size == 1,
+			    ret, done, "size != 1\n");
+
+	/*
+	 * Test setting EOF to 0 with AAPL enabled, should delete stream
+	 */
+
+	torture_comment(tctx, "Enabling AAPL extensions\n");
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed\n");
+
+	torture_comment(tctx, "Setting stream EOF to 0\n");
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 0;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	smb2_util_close(tree, h1);
+
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_READ_ATTRIBUTE;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND, ret, done,
+		"Unexpected status\n");
+
+done:
+	smb2_util_unlink(tree, fname);
+	smb2_util_rmdir(tree, BASEDIR);
+	return ret;
+}
+
 /*
  * Note: This test depends on "vfs objects = catia fruit streams_xattr".  For
  * some tests torture must be run on the host it tests and takes an additional
@@ -4627,6 +4806,7 @@ struct torture_suite *torture_vfs_fruit(
 	torture_suite_add_1smb2_test(suite, "create delete-on-close AFP_AfpResource", test_create_delete_on_close_resource);
 	torture_suite_add_1smb2_test(suite, "setinfo delete-on-close AFP_AfpResource", test_setinfo_delete_on_close_resource);
 	torture_suite_add_1smb2_test(suite, "setinfo eof AFP_AfpResource", test_setinfo_eof_resource);
+	torture_suite_add_1smb2_test(suite, "setinfo eof stream", test_setinfo_stream_eof);
 	torture_suite_add_1smb2_test(suite, "null afpinfo", test_null_afpinfo);
 	torture_suite_add_1smb2_test(suite, "delete", test_delete_file_with_rfork);
 	torture_suite_add_1smb2_test(suite, "read open rsrc after rename", test_rename_and_read_rsrc);
@@ -4706,6 +4886,93 @@ done:
 	return ret;
 }
 
+static bool test_fruit_locking_conflict(struct torture_context *tctx,
+					struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx;
+	struct smb2_create create;
+	struct smb2_handle h;
+	struct smb2_lock lck;
+	struct smb2_lock_element el;
+	const char *fname = BASEDIR "\\locking_conflict.txt";
+	NTSTATUS status;
+	bool ret = false;
+
+	mem_ctx = talloc_new(tctx);
+	torture_assert_not_null(tctx, mem_ctx, "talloc_new failed");
+
+	/* clean slate ...*/
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &h);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	smb2_util_close(tree, h);
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_FILE_READ,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.share_access =
+		NTCREATEX_SHARE_ACCESS_READ|
+		NTCREATEX_SHARE_ACCESS_WRITE,
+		.in.create_disposition = NTCREATEX_DISP_CREATE,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = fname,
+	};
+
+	status = smb2_create(tree, mem_ctx, &create);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	h = create.out.file.handle;
+
+	el = (struct smb2_lock_element) {
+		.offset = 0xfffffffffffffffc,
+		.length = 1,
+		.flags = SMB2_LOCK_FLAG_EXCLUSIVE,
+	};
+	lck = (struct smb2_lock) {
+		.in.lock_count = 1,
+		.in.file.handle = h,
+		.in.locks = &el,
+	};
+
+	status = smb2_lock(tree, &lck);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	el = (struct smb2_lock_element) {
+		.offset = 0,
+		.length = 0x7fffffffffffffff,
+		.flags = SMB2_LOCK_FLAG_EXCLUSIVE,
+	};
+	status = smb2_lock(tree, &lck);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	create = (struct smb2_create) {
+		.in.desired_access =
+		SEC_RIGHTS_FILE_READ|SEC_RIGHTS_FILE_WRITE,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = fname,
+	};
+
+	status = smb2_create(tree, mem_ctx, &create);
+	CHECK_STATUS(status, NT_STATUS_FILE_LOCK_CONFLICT);
+
+	{
+		struct smb2_close cl = {
+			.level = RAW_CLOSE_SMB2,
+			.in.file.handle = h,
+		};
+		smb2_close(tree, &cl);
+	}
+
+	ret = true;
+done:
+	return ret;
+}
+
 struct torture_suite *torture_vfs_fruit_netatalk(TALLOC_CTX *ctx)
 {
 	struct torture_suite *suite = torture_suite_create(
@@ -4715,6 +4982,8 @@ struct torture_suite *torture_vfs_fruit_
 
 	torture_suite_add_1smb2_test(suite, "read netatalk metadata", test_read_netatalk_metadata);
 	torture_suite_add_1smb2_test(suite, "stream names with locally created xattr", test_stream_names_local);
+	torture_suite_add_1smb2_test(
+		suite, "locking conflict", test_fruit_locking_conflict);
 
 	return suite;
 }
diff -Npur samba-4.8.4/testsuite/unittests/test_lib_util_modules.c samba-4.8.5/testsuite/unittests/test_lib_util_modules.c
--- samba-4.8.4/testsuite/unittests/test_lib_util_modules.c	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.5/testsuite/unittests/test_lib_util_modules.c	2018-08-24 09:58:20.000000000 +0200
@@ -26,7 +26,7 @@ static void test_samba_module_probe(void
 {
 	NTSTATUS status;
 
-	status = smb_probe_module("auth", "unix");
+	status = smb_probe_module("auth", "skel");
 	assert_true(NT_STATUS_IS_OK(status));
 }
 
diff -Npur samba-4.8.4/third_party/nss_wrapper/wscript samba-4.8.5/third_party/nss_wrapper/wscript
--- samba-4.8.4/third_party/nss_wrapper/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/third_party/nss_wrapper/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -38,6 +38,7 @@ def configure(conf):
             ''',
             'HAVE_DESTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library destructor support')
 
         # check HAVE_ATTRIBUTE_PRINTF_FORMAT
@@ -50,6 +51,7 @@ def configure(conf):
             ''',
             'HAVE_ATTRIBUTE_PRINTF_FORMAT',
             addmain=False,
+            strict=True,
             msg='Checking for printf format validation support')
 
         conf.CHECK_FUNCS('gethostbyaddr_r gethostbyname_r')
diff -Npur samba-4.8.4/third_party/pam_wrapper/wscript samba-4.8.5/third_party/pam_wrapper/wscript
--- samba-4.8.4/third_party/pam_wrapper/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/third_party/pam_wrapper/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -44,6 +44,7 @@ def configure(conf):
             ''',
             'HAVE_DESTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library destructor support')
 
         # check HAVE_FUNCTION_ATTRIBUTE_FORMAT
@@ -56,6 +57,7 @@ def configure(conf):
             ''',
             'HAVE_FUNCTION_ATTRIBUTE_FORMAT',
             addmain=False,
+            strict=True,
             msg='Checking for printf format validation support')
 
         conf.CHECK_HEADERS('security/pam_appl.h')
diff -Npur samba-4.8.4/third_party/resolv_wrapper/wscript samba-4.8.5/third_party/resolv_wrapper/wscript
--- samba-4.8.4/third_party/resolv_wrapper/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/third_party/resolv_wrapper/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -36,6 +36,7 @@ def configure(conf):
             ''',
             'HAVE_DESTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library destructor support')
 
         # check HAVE_ATTRIBUTE_PRINTF_FORMAT
@@ -48,6 +49,7 @@ def configure(conf):
             ''',
             'HAVE_ATTRIBUTE_PRINTF_FORMAT',
             addmain=False,
+            strict=True,
             msg='Checking for printf format validation support')
 
         conf.CHECK_HEADERS('resolv.h')
diff -Npur samba-4.8.4/third_party/socket_wrapper/wscript samba-4.8.5/third_party/socket_wrapper/wscript
--- samba-4.8.4/third_party/socket_wrapper/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/third_party/socket_wrapper/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -36,6 +36,7 @@ def configure(conf):
             ''',
             'HAVE_DESTRUCTOR_ATTRIBUTE',
             addmain=False,
+            strict=True,
             msg='Checking for library destructor support')
 
         # check HAVE_FUNCTION_ATTRIBUTE_FORMAT
@@ -48,6 +49,7 @@ def configure(conf):
             ''',
             'HAVE_FUNCTION_ATTRIBUTE_FORMAT',
             addmain=False,
+            strict=True,
             msg='Checking for printf format validation support')
 
         conf.CHECK_HEADERS('sys/signalfd.h')
@@ -109,6 +111,6 @@ def build(bld):
         # breaks preloading!
         bld.SAMBA_LIBRARY('socket_wrapper',
                           source='socket_wrapper.c',
-                          deps='dl pthread',
+                          deps='dl pthread tirpc',
                           install=False,
                           realname='libsocket-wrapper.so')
diff -Npur samba-4.8.4/third_party/uid_wrapper/wscript samba-4.8.5/third_party/uid_wrapper/wscript
--- samba-4.8.4/third_party/uid_wrapper/wscript	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.5/third_party/uid_wrapper/wscript	2018-08-24 09:58:20.000000000 +0200
@@ -51,7 +51,8 @@ def configure(conf):
                 ''',
                 'HAVE_ADDRESS_SANITIZER_ATTRIBUTE',
                 addmain=False,
-                cflags='-Wall -Wextra -Werror',
+                cflags='-Wall -Wextra',
+                strict=True,
                 msg='Checking for address sanitizer attribute')
 
         # check HAVE_FUNCTION_ATTRIBUTE_FORMAT
@@ -64,6 +65,7 @@ def configure(conf):
             ''',
             'HAVE_FUNCTION_ATTRIBUTE_FORMAT',
             addmain=False,
+            strict=True,
             msg='Checking for printf format validation support')
 	# Prototype checks
 	conf.CHECK_C_PROTOTYPE('setgroups',
