diff -Npur samba-4.8.7/WHATSNEW.txt samba-4.8.8/WHATSNEW.txt
--- samba-4.8.7/WHATSNEW.txt	2018-11-26 09:02:18.000000000 +0100
+++ samba-4.8.8/WHATSNEW.txt	2018-12-13 10:08:39.000000000 +0100
@@ -1,4 +1,105 @@
                    =============================
+                   Release Notes for Samba 4.8.8
+                         December 13, 2018
+                   =============================
+
+
+This is the latest stable release of the Samba 4.8 release series.
+
+Major bug fixes include:
+------------------------
+
+   o dns: Fix CNAME loop prevention using counter regression (bug #13600).
+
+
+Changes since 4.8.7:
+--------------------
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13633: s3: smbd: Prevent valgrind errors in smbtorture3 POSIX test.
+
+o  Andrew Bartlett <abartlet@samba.org>
+   * BUG 13418: dsdb: Add comments explaining the limitations of our current
+     backlink behaviour.
+   * BUG 13495: dbcheck: Use symbolic control name for
+     DSDB_CONTROL_DBCHECK_FIX_DUPLICATE_LINKS.
+
+o  Tim Beale <timbeale@catalyst.net.nz>
+   * BUG 13495: dbchecker: Fixing up incorrect DNs wasn't working.
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 9175: libcli/smb: Don't overwrite status code.
+   * BUG 12164: 'wbinfo --group-info' 'NT AUTHORITY\System' does not work.
+   * BUG 13175: Fix accessing ZFS snapshot directories over SMB.
+   * BUG 13642: vfs_fruit should be able to cleanup AppleDouble files.
+   * BUG 13465: testparm crashes with PANIC: Messaging not initialized on
+     SLES 12 SP3.
+   * BUG 13646: File saving issues with vfs_fruit on samba >= 4.8.5.
+   * BUG 13649: Enabling vfs_fruit looses FinderInfo.
+   * BUG 13661: Session setup reauth fails to sign response.
+   * BUG 13667: Cancelling of SMB2 aio reads and writes returns wrong error
+     NT_STATUS_INTERNAL_ERROR.
+   * BUG 13677: Fix copy with vfs_fruit if AFP_AfpInfo stream file
+     size > 60bytes.
+
+o  Isaac Boukris <iboukris@gmail.com>
+   * BUG 13571: CVE-2018-16853: Fix S4U2Self crash with MIT KDC build.
+
+o  Amitay Isaacs <amitay@gmail.com>
+   * BUG 13641: Fix CTDB recovery record resurrection from inactive nodes and
+     simplify vacuuming.
+   * BUG 13659: Fix bugs in CTDB event handling.
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13465: examples: Fix the smb2mount build.
+   * BUG 13662: winbindd_cache: Fix timeout calculation for sid<->name cache.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13418: Extended DN SID component missing for member after switching
+     group membership.
+   * BUG 13600: CVE-2018-14629 dns: Fix CNAME loop prevention using counter
+     regression.
+   * BUG 13624: STATUS_SESSION_EXPIRED error is returned unencrypted, if the
+     request was encrypted.
+
+o  Christof Schmitt <cs@samba.org>
+   * BUG 13465: testparm crashes with PANIC: Messaging not initialized on
+     SLES 12 SP3.
+   * BUG 13673: smbd: Fix DELETE_ON_CLOSE behaviour on files with READ_ONLY
+     attribute.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 13571: CVE-2018-16853: Fix S4U2Self crash with MIT KDC build.
+   * BUG 13679: Fix a segfault in pyglue.
+
+o  Martin Schwenke <martin@meltin.net>
+   * BUG 13670: ctdb-recovery: Ban a node that causes recovery failure.
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
+                   =============================
                    Release Notes for Samba 4.8.7
                          November 27, 2018
                    =============================
@@ -94,8 +195,8 @@ database (https://bugzilla.samba.org/).
 ======================================================================
 
 
-Release notes for older releases follow:
-----------------------------------------
+----------------------------------------------------------------------
+
 
                    =============================
                    Release Notes for Samba 4.8.6
diff -Npur samba-4.8.7/ctdb/common/sock_daemon.c samba-4.8.8/ctdb/common/sock_daemon.c
--- samba-4.8.7/ctdb/common/sock_daemon.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/ctdb/common/sock_daemon.c	2018-12-13 10:08:39.000000000 +0100
@@ -517,9 +517,15 @@ int sock_daemon_add_unix(struct sock_dae
 	return 0;
 }
 
-void sock_daemon_set_startup_fd(struct sock_daemon_context *sockd, int fd)
+bool sock_daemon_set_startup_fd(struct sock_daemon_context *sockd, int fd)
 {
+	if (! set_close_on_exec(fd)) {
+		D_ERR("Failed to set close-on-exec on startup fd\n");
+		return false;
+	}
+
 	sockd->startup_fd = fd;
+	return true;
 }
 
 /*
diff -Npur samba-4.8.7/ctdb/common/sock_daemon.h samba-4.8.8/ctdb/common/sock_daemon.h
--- samba-4.8.7/ctdb/common/sock_daemon.h	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/ctdb/common/sock_daemon.h	2018-12-13 10:08:39.000000000 +0100
@@ -214,8 +214,9 @@ int sock_daemon_add_unix(struct sock_dae
  *
  * @param[in] sockd Socket daemon context
  * @param[in] fd File descriptor
+ * @return true on success, false on error
  */
-void sock_daemon_set_startup_fd(struct sock_daemon_context *sockd, int fd);
+bool sock_daemon_set_startup_fd(struct sock_daemon_context *sockd, int fd);
 
 /**
  * @brief Async computation start to run a socket daemon
diff -Npur samba-4.8.7/ctdb/doc/ctdb-etcd.7 samba-4.8.8/ctdb/doc/ctdb-etcd.7
--- samba-4.8.7/ctdb/doc/ctdb-etcd.7	2018-11-26 09:08:09.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb-etcd.7	2018-12-13 10:11:17.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb-statistics.7 samba-4.8.8/ctdb/doc/ctdb-statistics.7
--- samba-4.8.7/ctdb/doc/ctdb-statistics.7	2018-11-26 09:08:08.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb-statistics.7	2018-12-13 10:11:16.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb-tunables.7 samba-4.8.8/ctdb/doc/ctdb-tunables.7
--- samba-4.8.7/ctdb/doc/ctdb-tunables.7	2018-11-26 09:08:08.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb-tunables.7	2018-12-13 10:11:16.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb.1 samba-4.8.8/ctdb/doc/ctdb.1
--- samba-4.8.7/ctdb/doc/ctdb.1	2018-11-26 09:08:05.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb.1	2018-12-13 10:11:13.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb.7 samba-4.8.8/ctdb/doc/ctdb.7
--- samba-4.8.7/ctdb/doc/ctdb.7	2018-11-26 09:08:08.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb.7	2018-12-13 10:11:16.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb_diagnostics.1 samba-4.8.8/ctdb/doc/ctdb_diagnostics.1
--- samba-4.8.7/ctdb/doc/ctdb_diagnostics.1	2018-11-26 09:08:06.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb_diagnostics.1	2018-12-13 10:11:14.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.8.8/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.8.7/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-11-26 09:08:09.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-12-13 10:11:17.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdbd.1 samba-4.8.8/ctdb/doc/ctdbd.1
--- samba-4.8.7/ctdb/doc/ctdbd.1	2018-11-26 09:08:05.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdbd.1	2018-12-13 10:11:13.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdbd.conf.5 samba-4.8.8/ctdb/doc/ctdbd.conf.5
--- samba-4.8.7/ctdb/doc/ctdbd.conf.5	2018-11-26 09:08:07.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdbd.conf.5	2018-12-13 10:11:15.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ctdbd_wrapper.1 samba-4.8.8/ctdb/doc/ctdbd_wrapper.1
--- samba-4.8.7/ctdb/doc/ctdbd_wrapper.1	2018-11-26 09:08:07.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ctdbd_wrapper.1	2018-12-13 10:11:15.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ltdbtool.1 samba-4.8.8/ctdb/doc/ltdbtool.1
--- samba-4.8.7/ctdb/doc/ltdbtool.1	2018-11-26 09:08:06.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ltdbtool.1	2018-12-13 10:11:14.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/onnode.1 samba-4.8.8/ctdb/doc/onnode.1
--- samba-4.8.7/ctdb/doc/onnode.1	2018-11-26 09:08:07.000000000 +0100
+++ samba-4.8.8/ctdb/doc/onnode.1	2018-12-13 10:11:15.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/doc/ping_pong.1 samba-4.8.8/ctdb/doc/ping_pong.1
--- samba-4.8.7/ctdb/doc/ping_pong.1	2018-11-26 09:08:06.000000000 +0100
+++ samba-4.8.8/ctdb/doc/ping_pong.1	2018-12-13 10:11:14.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "11/26/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "12/13/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/ctdb/include/ctdb_private.h samba-4.8.8/ctdb/include/ctdb_private.h
--- samba-4.8.7/ctdb/include/ctdb_private.h	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/ctdb/include/ctdb_private.h	2018-12-13 10:08:39.000000000 +0100
@@ -387,6 +387,7 @@ struct ctdb_db_context {
 	uint32_t freeze_transaction_id;
 	uint32_t generation;
 
+	bool invalid_records;
 	bool push_started;
 	void *push_state;
 
@@ -822,8 +823,6 @@ int32_t ctdb_control_start_recovery(stru
 
 int32_t ctdb_control_try_delete_records(struct ctdb_context *ctdb,
 					TDB_DATA indata, TDB_DATA *outdata);
-int32_t ctdb_control_receive_records(struct ctdb_context *ctdb,
-				     TDB_DATA indata, TDB_DATA *outdata);
 
 int32_t ctdb_control_get_capabilities(struct ctdb_context *ctdb,
 				      TDB_DATA *outdata);
diff -Npur samba-4.8.7/ctdb/protocol/protocol.h samba-4.8.8/ctdb/protocol/protocol.h
--- samba-4.8.7/ctdb/protocol/protocol.h	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/ctdb/protocol/protocol.h	2018-12-13 10:08:39.000000000 +0100
@@ -355,7 +355,7 @@ enum ctdb_controls {CTDB_CONTROL_PROCESS
 		    CTDB_CONTROL_SET_DB_STICKY           = 133,
 		    CTDB_CONTROL_RELOAD_PUBLIC_IPS       = 134,
 		    CTDB_CONTROL_TRAVERSE_ALL_EXT        = 135,
-		    CTDB_CONTROL_RECEIVE_RECORDS         = 136,
+		    CTDB_CONTROL_RECEIVE_RECORDS         = 136, /* obsolete */
 		    CTDB_CONTROL_IPREALLOCATED           = 137,
 		    CTDB_CONTROL_GET_RUNSTATE            = 138,
 		    CTDB_CONTROL_DB_DETACH               = 139,
diff -Npur samba-4.8.7/ctdb/protocol/protocol_api.h samba-4.8.8/ctdb/protocol/protocol_api.h
--- samba-4.8.7/ctdb/protocol/protocol_api.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/protocol/protocol_api.h	2018-12-13 10:08:39.000000000 +0100
@@ -530,12 +530,6 @@ int ctdb_reply_control_set_db_sticky(str
 void ctdb_req_control_reload_public_ips(struct ctdb_req_control *request);
 int ctdb_reply_control_reload_public_ips(struct ctdb_reply_control *reply);
 
-void ctdb_req_control_receive_records(struct ctdb_req_control *request,
-				      struct ctdb_rec_buffer *recbuf);
-int ctdb_reply_control_receive_records(struct ctdb_reply_control *reply,
-				       TALLOC_CTX *mem_ctx,
-				       struct ctdb_rec_buffer **recbuf);
-
 void ctdb_req_control_ipreallocated(struct ctdb_req_control *request);
 int ctdb_reply_control_ipreallocated(struct ctdb_reply_control *reply);
 
diff -Npur samba-4.8.7/ctdb/protocol/protocol_client.c samba-4.8.8/ctdb/protocol/protocol_client.c
--- samba-4.8.7/ctdb/protocol/protocol_client.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/protocol/protocol_client.c	2018-12-13 10:08:39.000000000 +0100
@@ -1948,35 +1948,6 @@ int ctdb_reply_control_reload_public_ips
 
 /* CTDB_CONTROL_TRAVERSE_ALL_EXT */
 
-/* CTDB_CONTROL_RECEIVE_RECORDS */
-
-void ctdb_req_control_receive_records(struct ctdb_req_control *request,
-				      struct ctdb_rec_buffer *recbuf)
-{
-	request->opcode = CTDB_CONTROL_RECEIVE_RECORDS;
-	request->pad = 0;
-	request->srvid = 0;
-	request->client_id = 0;
-	request->flags = 0;
-
-	request->rdata.opcode = CTDB_CONTROL_RECEIVE_RECORDS;
-	request->rdata.data.recbuf = recbuf;
-}
-
-int ctdb_reply_control_receive_records(struct ctdb_reply_control *reply,
-				       TALLOC_CTX *mem_ctx,
-				       struct ctdb_rec_buffer **recbuf)
-{
-	if (reply->rdata.opcode != CTDB_CONTROL_RECEIVE_RECORDS) {
-		return EPROTO;
-	}
-
-	if (reply->status == 0) {
-		*recbuf = talloc_steal(mem_ctx, reply->rdata.data.recbuf);
-	}
-	return reply->status;
-}
-
 /* CTDB_CONTROL_IPREALLOCATED */
 
 void ctdb_req_control_ipreallocated(struct ctdb_req_control *request)
diff -Npur samba-4.8.7/ctdb/protocol/protocol_control.c samba-4.8.8/ctdb/protocol/protocol_control.c
--- samba-4.8.7/ctdb/protocol/protocol_control.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/protocol/protocol_control.c	2018-12-13 10:08:39.000000000 +0100
@@ -360,10 +360,6 @@ static size_t ctdb_req_control_data_len(
 		len = ctdb_traverse_all_ext_len(cd->data.traverse_all_ext);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		len = ctdb_rec_buffer_len(cd->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
@@ -660,10 +656,6 @@ static void ctdb_req_control_data_push(s
 					   &np);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		ctdb_rec_buffer_push(cd->data.recbuf, buf, &np);
-		break;
-
 	case CTDB_CONTROL_DB_DETACH:
 		ctdb_uint32_push(&cd->data.db_id, buf, &np);
 		break;
@@ -988,11 +980,6 @@ static int ctdb_req_control_data_pull(ui
 						 &np);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		ret = ctdb_rec_buffer_pull(buf, buflen, mem_ctx,
-					   &cd->data.recbuf, &np);
-		break;
-
 	case CTDB_CONTROL_DB_DETACH:
 		ret = ctdb_uint32_pull(buf, buflen, &cd->data.db_id, &np);
 		break;
@@ -1368,10 +1355,6 @@ static size_t ctdb_reply_control_data_le
 	case CTDB_CONTROL_TRAVERSE_ALL_EXT:
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		len = ctdb_rec_buffer_len(cd->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
@@ -1562,10 +1545,6 @@ static void ctdb_reply_control_data_push
 		ctdb_db_statistics_push(cd->data.dbstats, buf, &np);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		ctdb_rec_buffer_push(cd->data.recbuf, buf, &np);
-		break;
-
 	case CTDB_CONTROL_GET_RUNSTATE:
 		ctdb_uint32_push(&cd->data.runstate, buf, &np);
 		break;
@@ -1753,11 +1732,6 @@ static int ctdb_reply_control_data_pull(
 					      &cd->data.dbstats, &np);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		ret = ctdb_rec_buffer_pull(buf, buflen, mem_ctx,
-					   &cd->data.recbuf, &np);
-		break;
-
 	case CTDB_CONTROL_GET_RUNSTATE:
 		ret = ctdb_uint32_pull(buf, buflen, &cd->data.runstate, &np);
 		break;
diff -Npur samba-4.8.7/ctdb/server/ctdb_control.c samba-4.8.8/ctdb/server/ctdb_control.c
--- samba-4.8.7/ctdb/server/ctdb_control.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/ctdb/server/ctdb_control.c	2018-12-13 10:08:39.000000000 +0100
@@ -650,7 +650,7 @@ static int32_t ctdb_control_dispatch(str
 		return ctdb_control_reload_public_ips(ctdb, c, async_reply);
 
 	case CTDB_CONTROL_RECEIVE_RECORDS:
-		return ctdb_control_receive_records(ctdb, indata, outdata);
+		return control_not_implemented("RECEIVE_RECORDS", NULL);
 
 	case CTDB_CONTROL_DB_DETACH:
 		return ctdb_control_db_detach(ctdb, indata, client_id);
diff -Npur samba-4.8.7/ctdb/server/ctdb_eventd.c samba-4.8.8/ctdb/server/ctdb_eventd.c
--- samba-4.8.7/ctdb/server/ctdb_eventd.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/ctdb/server/ctdb_eventd.c	2018-12-13 10:08:39.000000000 +0100
@@ -990,6 +990,7 @@ int main(int argc, const char **argv)
 	struct sock_socket_funcs socket_funcs;
 	struct stat statbuf;
 	int opt, ret;
+	bool ok;
 
 	/* Set default options */
 	options.pid = -1;
@@ -1073,7 +1074,10 @@ int main(int argc, const char **argv)
 	}
 
 	if (options.startup_fd != -1) {
-		sock_daemon_set_startup_fd(sockd, options.startup_fd);
+		ok = sock_daemon_set_startup_fd(sockd, options.startup_fd);
+		if (!ok) {
+			goto fail;
+		}
 	}
 
 	ret = sock_daemon_run(ev, sockd,
diff -Npur samba-4.8.7/ctdb/server/ctdb_freeze.c samba-4.8.8/ctdb/server/ctdb_freeze.c
--- samba-4.8.7/ctdb/server/ctdb_freeze.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/server/ctdb_freeze.c	2018-12-13 10:08:39.000000000 +0100
@@ -140,6 +140,9 @@ static int ctdb_db_freeze_handle_destruc
 	ctdb_db->freeze_mode = CTDB_FREEZE_NONE;
 	ctdb_db->freeze_handle = NULL;
 
+	/* Clear invalid records flag */
+	ctdb_db->invalid_records = false;
+
 	talloc_free(h->lreq);
 	return 0;
 }
@@ -394,6 +397,19 @@ static int db_freeze_waiter_destructor(s
 }
 
 /**
+ * Invalidate the records in the database.
+ * This only applies to volatile databases.
+ */
+static int db_invalidate(struct ctdb_db_context *ctdb_db, void *private_data)
+{
+	if (ctdb_db_volatile(ctdb_db)) {
+		ctdb_db->invalid_records = true;
+	}
+
+	return 0;
+}
+
+/**
  * Count the number of databases
  */
 static int db_count(struct ctdb_db_context *ctdb_db, void *private_data)
@@ -436,13 +452,17 @@ static int db_freeze(struct ctdb_db_cont
 }
 
 /*
-  start the freeze process for a certain priority
+  start the freeze process for all databases
+  This is only called from ctdb_control_freeze(), which is called
+  only on node becoming INACTIVE.  So mark the records invalid.
  */
 static void ctdb_start_freeze(struct ctdb_context *ctdb)
 {
 	struct ctdb_freeze_handle *h;
 	int ret;
 
+	ctdb_db_iterator(ctdb, db_invalidate, NULL);
+
 	if (ctdb->freeze_mode == CTDB_FREEZE_FROZEN) {
 		int count = 0;
 
@@ -534,6 +554,8 @@ static int ctdb_freeze_waiter_destructor
 
 /*
   freeze all the databases
+  This control is only used when freezing database on node becoming INACTIVE.
+  So mark the records invalid in ctdb_start_freeze().
  */
 int32_t ctdb_control_freeze(struct ctdb_context *ctdb,
 			    struct ctdb_req_control_old *c, bool *async_reply)
diff -Npur samba-4.8.7/ctdb/server/ctdb_recover.c samba-4.8.8/ctdb/server/ctdb_recover.c
--- samba-4.8.7/ctdb/server/ctdb_recover.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/server/ctdb_recover.c	2018-12-13 10:08:39.000000000 +0100
@@ -279,6 +279,11 @@ int32_t ctdb_control_pull_db(struct ctdb
 				     ctdb_db->db_name, ctdb_db->unhealthy_reason));
 	}
 
+	/* If the records are invalid, we are done */
+	if (ctdb_db->invalid_records) {
+		goto done;
+	}
+
 	if (ctdb_lockdb_mark(ctdb_db) != 0) {
 		DEBUG(DEBUG_ERR,(__location__ " Failed to get lock on entire db - failing\n"));
 		return -1;
@@ -293,6 +298,7 @@ int32_t ctdb_control_pull_db(struct ctdb
 
 	ctdb_lockdb_unmark(ctdb_db);
 
+done:
 	outdata->dptr = (uint8_t *)params.pulldata;
 	outdata->dsize = params.len;
 
@@ -388,6 +394,11 @@ int32_t ctdb_control_db_pull(struct ctdb
 	state.srvid = pulldb_ext->srvid;
 	state.num_records = 0;
 
+	/* If the records are invalid, we are done */
+	if (ctdb_db->invalid_records) {
+		goto done;
+	}
+
 	if (ctdb_lockdb_mark(ctdb_db) != 0) {
 		DEBUG(DEBUG_ERR,
 		      (__location__ " Failed to get lock on entire db - failing\n"));
@@ -422,6 +433,7 @@ int32_t ctdb_control_db_pull(struct ctdb
 
 	ctdb_lockdb_unmark(ctdb_db);
 
+done:
 	outdata->dptr = talloc_size(outdata, sizeof(uint32_t));
 	if (outdata->dptr == NULL) {
 		DEBUG(DEBUG_ERR, (__location__ " Memory allocation error\n"));
@@ -1318,205 +1330,6 @@ int32_t ctdb_control_try_delete_records(
 	return 0;
 }
 
-/**
- * Store a record as part of the vacuum process:
- * This is called from the RECEIVE_RECORD control which
- * the lmaster uses to send the current empty copy
- * to all nodes for storing, before it lets the other
- * nodes delete the records in the second phase with
- * the TRY_DELETE_RECORDS control.
- *
- * Only store if we are not lmaster or dmaster, and our
- * rsn is <= the provided rsn. Use non-blocking locks.
- *
- * return 0 if the record was successfully stored.
- * return !0 if the record still exists in the tdb after returning.
- */
-static int store_tdb_record(struct ctdb_context *ctdb,
-			    struct ctdb_db_context *ctdb_db,
-			    struct ctdb_rec_data_old *rec)
-{
-	TDB_DATA key, data, data2;
-	struct ctdb_ltdb_header *hdr, *hdr2;
-	int ret;
-
-	key.dsize = rec->keylen;
-	key.dptr = &rec->data[0];
-	data.dsize = rec->datalen;
-	data.dptr = &rec->data[rec->keylen];
-
-	if (ctdb_lmaster(ctdb, &key) == ctdb->pnn) {
-		DEBUG(DEBUG_INFO, (__location__ " Called store_tdb_record "
-				   "where we are lmaster\n"));
-		return -1;
-	}
-
-	if (data.dsize != sizeof(struct ctdb_ltdb_header)) {
-		DEBUG(DEBUG_ERR, (__location__ " Bad record size\n"));
-		return -1;
-	}
-
-	hdr = (struct ctdb_ltdb_header *)data.dptr;
-
-	/* use a non-blocking lock */
-	if (tdb_chainlock_nonblock(ctdb_db->ltdb->tdb, key) != 0) {
-		DEBUG(DEBUG_INFO, (__location__ " Failed to lock chain in non-blocking mode\n"));
-		return -1;
-	}
-
-	data2 = tdb_fetch(ctdb_db->ltdb->tdb, key);
-	if (data2.dptr == NULL || data2.dsize < sizeof(struct ctdb_ltdb_header)) {
-		if (tdb_store(ctdb_db->ltdb->tdb, key, data, 0) == -1) {
-			DEBUG(DEBUG_ERR, (__location__ "Failed to store record\n"));
-			ret = -1;
-			goto done;
-		}
-		DEBUG(DEBUG_INFO, (__location__ " Stored record\n"));
-		ret = 0;
-		goto done;
-	}
-
-	hdr2 = (struct ctdb_ltdb_header *)data2.dptr;
-
-	if (hdr2->rsn > hdr->rsn) {
-		DEBUG(DEBUG_INFO, (__location__ " Skipping record with "
-				   "rsn=%llu - called with rsn=%llu\n",
-				   (unsigned long long)hdr2->rsn,
-				   (unsigned long long)hdr->rsn));
-		ret = -1;
-		goto done;
-	}
-
-	/* do not allow vacuuming of records that have readonly flags set. */
-	if (hdr->flags & CTDB_REC_RO_FLAGS) {
-		DEBUG(DEBUG_INFO,(__location__ " Skipping record with readonly "
-				  "flags set\n"));
-		ret = -1;
-		goto done;
-	}
-	if (hdr2->flags & CTDB_REC_RO_FLAGS) {
-		DEBUG(DEBUG_INFO,(__location__ " Skipping record with readonly "
-				  "flags set\n"));
-		ret = -1;
-		goto done;
-	}
-
-	if (hdr2->dmaster == ctdb->pnn) {
-		DEBUG(DEBUG_INFO, (__location__ " Attempted to store record "
-				   "where we are the dmaster\n"));
-		ret = -1;
-		goto done;
-	}
-
-	if (tdb_store(ctdb_db->ltdb->tdb, key, data, 0) != 0) {
-		DEBUG(DEBUG_INFO,(__location__ " Failed to store record\n"));
-		ret = -1;
-		goto done;
-	}
-
-	ret = 0;
-
-done:
-	tdb_chainunlock(ctdb_db->ltdb->tdb, key);
-	free(data2.dptr);
-	return  ret;
-}
-
-
-
-/**
- * Try to store all these records as part of the vacuuming process
- * and return the records we failed to store.
- */
-int32_t ctdb_control_receive_records(struct ctdb_context *ctdb,
-				     TDB_DATA indata, TDB_DATA *outdata)
-{
-	struct ctdb_marshall_buffer *reply = (struct ctdb_marshall_buffer *)indata.dptr;
-	struct ctdb_db_context *ctdb_db;
-	int i;
-	struct ctdb_rec_data_old *rec;
-	struct ctdb_marshall_buffer *records;
-
-	if (indata.dsize < offsetof(struct ctdb_marshall_buffer, data)) {
-		DEBUG(DEBUG_ERR,
-		      (__location__ " invalid data in receive_records\n"));
-		return -1;
-	}
-
-	ctdb_db = find_ctdb_db(ctdb, reply->db_id);
-	if (!ctdb_db) {
-		DEBUG(DEBUG_ERR, (__location__ " Unknown db 0x%08x\n",
-				  reply->db_id));
-		return -1;
-	}
-
-	DEBUG(DEBUG_DEBUG, ("starting receive_records of %u records for "
-			    "dbid 0x%x\n", reply->count, reply->db_id));
-
-	/* create a blob to send back the records we could not store */
-	records = (struct ctdb_marshall_buffer *)
-			talloc_zero_size(outdata,
-				offsetof(struct ctdb_marshall_buffer, data));
-	if (records == NULL) {
-		DEBUG(DEBUG_ERR, (__location__ " Out of memory\n"));
-		return -1;
-	}
-	records->db_id = ctdb_db->db_id;
-
-	rec = (struct ctdb_rec_data_old *)&reply->data[0];
-	for (i=0; i<reply->count; i++) {
-		TDB_DATA key, data;
-
-		key.dptr = &rec->data[0];
-		key.dsize = rec->keylen;
-		data.dptr = &rec->data[key.dsize];
-		data.dsize = rec->datalen;
-
-		if (data.dsize < sizeof(struct ctdb_ltdb_header)) {
-			DEBUG(DEBUG_CRIT, (__location__ " bad ltdb record "
-					   "in indata\n"));
-			talloc_free(records);
-			return -1;
-		}
-
-		/*
-		 * If we can not store the record we must add it to the reply
-		 * so the lmaster knows it may not purge this record.
-		 */
-		if (store_tdb_record(ctdb, ctdb_db, rec) != 0) {
-			size_t old_size;
-			struct ctdb_ltdb_header *hdr;
-
-			hdr = (struct ctdb_ltdb_header *)data.dptr;
-			data.dptr += sizeof(*hdr);
-			data.dsize -= sizeof(*hdr);
-
-			DEBUG(DEBUG_INFO, (__location__ " Failed to store "
-					   "record with hash 0x%08x in vacuum "
-					   "via RECEIVE_RECORDS\n",
-					   ctdb_hash(&key)));
-
-			old_size = talloc_get_size(records);
-			records = talloc_realloc_size(outdata, records,
-						      old_size + rec->length);
-			if (records == NULL) {
-				DEBUG(DEBUG_ERR, (__location__ " Failed to "
-						  "expand\n"));
-				return -1;
-			}
-			records->count++;
-			memcpy(old_size+(uint8_t *)records, rec, rec->length);
-		}
-
-		rec = (struct ctdb_rec_data_old *)(rec->length + (uint8_t *)rec);
-	}
-
-	*outdata = ctdb_marshall_finish(records);
-
-	return 0;
-}
-
-
 /*
   report capabilities
  */
diff -Npur samba-4.8.7/ctdb/server/ctdb_recovery_helper.c samba-4.8.8/ctdb/server/ctdb_recovery_helper.c
--- samba-4.8.7/ctdb/server/ctdb_recovery_helper.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/server/ctdb_recovery_helper.c	2018-12-13 10:08:39.000000000 +0100
@@ -2570,22 +2570,28 @@ static void recovery_db_recovery_done(st
 
 		/* If pulling database fails multiple times */
 		if (max_credits >= NUM_RETRIES) {
-			struct ctdb_req_message message;
-
-			D_ERR("Assigning banning credits to node %u\n",
-			      max_pnn);
-
-			message.srvid = CTDB_SRVID_BANNING;
-			message.data.pnn = max_pnn;
-
-			subreq = ctdb_client_message_send(
-					state, state->ev, state->client,
-					ctdb_client_pnn(state->client),
-					&message);
+			struct ctdb_ban_state ban_state = {
+				.pnn = max_pnn,
+				.time = state->tun_list->recovery_ban_period,
+			};
+
+			D_ERR("Banning node %u for %u seconds\n",
+			      ban_state.pnn,
+			      ban_state.time);
+
+			ctdb_req_control_set_ban_state(&request,
+						       &ban_state);
+			subreq = ctdb_client_control_send(state,
+							  state->ev,
+							  state->client,
+							  ban_state.pnn,
+							  TIMEOUT(),
+							  &request);
 			if (tevent_req_nomem(subreq, req)) {
 				return;
 			}
-			tevent_req_set_callback(subreq, recovery_failed_done,
+			tevent_req_set_callback(subreq,
+						recovery_failed_done,
 						req);
 		} else {
 			tevent_req_error(req, EIO);
@@ -2608,15 +2614,25 @@ static void recovery_failed_done(struct
 {
 	struct tevent_req *req = tevent_req_callback_data(
 		subreq, struct tevent_req);
+	struct recovery_state *state = tevent_req_data(
+		req, struct recovery_state);
+	struct ctdb_reply_control *reply;
 	int ret;
 	bool status;
 
-	status = ctdb_client_message_recv(subreq, &ret);
+	status = ctdb_client_control_recv(subreq, &ret, state, &reply);
 	TALLOC_FREE(subreq);
 	if (! status) {
-		D_ERR("failed to assign banning credits, ret=%d\n", ret);
+		D_ERR("failed to ban node, ret=%d\n", ret);
+		goto done;
+	}
+
+	ret = ctdb_reply_control_set_ban_state(reply);
+	if (ret != 0) {
+		D_ERR("control SET_BAN_STATE failed, ret=%d\n", ret);
 	}
 
+done:
 	tevent_req_error(req, EIO);
 }
 
diff -Npur samba-4.8.7/ctdb/server/ctdb_vacuum.c samba-4.8.8/ctdb/server/ctdb_vacuum.c
--- samba-4.8.7/ctdb/server/ctdb_vacuum.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/ctdb/server/ctdb_vacuum.c	2018-12-13 10:08:39.000000000 +0100
@@ -107,6 +107,7 @@ struct delete_record_data {
 	struct ctdb_context *ctdb;
 	struct ctdb_db_context *ctdb_db;
 	struct ctdb_ltdb_header hdr;
+	uint32_t remote_fail_count;
 	TDB_DATA key;
 	uint8_t keydata[1];
 };
@@ -149,6 +150,7 @@ static int insert_delete_record_data_int
 	memcpy(dd->keydata, key.dptr, key.dsize);
 
 	dd->hdr = *hdr;
+	dd->remote_fail_count = 0;
 
 	hash = ctdb_hash(&key);
 
@@ -309,118 +311,6 @@ static int delete_marshall_traverse(void
 }
 
 /**
- * Variant of delete_marshall_traverse() that bumps the
- * RSN of each traversed record in the database.
- *
- * This is needed to ensure that when rolling out our
- * empty record copy before remote deletion, we as the
- * record's dmaster keep a higher RSN than the non-dmaster
- * nodes. This is needed to prevent old copies from
- * resurrection in recoveries.
- */
-static int delete_marshall_traverse_first(void *param, void *data)
-{
-	struct delete_record_data *dd = talloc_get_type(data, struct delete_record_data);
-	struct delete_records_list *recs = talloc_get_type(param, struct delete_records_list);
-	struct ctdb_db_context *ctdb_db = dd->ctdb_db;
-	struct ctdb_context *ctdb = ctdb_db->ctdb;
-	struct ctdb_ltdb_header header;
-	uint32_t lmaster;
-	uint32_t hash = ctdb_hash(&(dd->key));
-	int res;
-
-	res = tdb_chainlock_nonblock(ctdb_db->ltdb->tdb, dd->key);
-	if (res != 0) {
-		recs->vdata->count.delete_list.skipped++;
-		recs->vdata->count.delete_list.left--;
-		talloc_free(dd);
-		return 0;
-	}
-
-	/*
-	 * Verify that the record is still empty, its RSN has not
-	 * changed and that we are still its lmaster and dmaster.
-	 */
-
-	res = tdb_parse_record(ctdb_db->ltdb->tdb, dd->key,
-			       vacuum_record_parser, &header);
-	if (res != 0) {
-		goto skip;
-	}
-
-	if (header.flags & CTDB_REC_RO_FLAGS) {
-		DEBUG(DEBUG_INFO, (__location__ ": record with hash [0x%08x] "
-				   "on database db[%s] has read-only flags. "
-				   "skipping.\n",
-				   hash, ctdb_db->db_name));
-		goto skip;
-	}
-
-	if (header.dmaster != ctdb->pnn) {
-		DEBUG(DEBUG_INFO, (__location__ ": record with hash [0x%08x] "
-				   "on database db[%s] has been migrated away. "
-				   "skipping.\n",
-				   hash, ctdb_db->db_name));
-		goto skip;
-	}
-
-	if (header.rsn != dd->hdr.rsn) {
-		DEBUG(DEBUG_INFO, (__location__ ": record with hash [0x%08x] "
-				   "on database db[%s] seems to have been "
-				   "migrated away and back again (with empty "
-				   "data). skipping.\n",
-				   hash, ctdb_db->db_name));
-		goto skip;
-	}
-
-	lmaster = ctdb_lmaster(ctdb_db->ctdb, &dd->key);
-
-	if (lmaster != ctdb->pnn) {
-		DEBUG(DEBUG_INFO, (__location__ ": not lmaster for record in "
-				   "delete list (key hash [0x%08x], db[%s]). "
-				   "Strange! skipping.\n",
-				   hash, ctdb_db->db_name));
-		goto skip;
-	}
-
-	/*
-	 * Increment the record's RSN to ensure the dmaster (i.e. the current
-	 * node) has the highest RSN of the record in the cluster.
-	 * This is to prevent old record copies from resurrecting in recoveries
-	 * if something should fail during the deletion process.
-	 * Note that ctdb_ltdb_store_server() increments the RSN if called
-	 * on the record's dmaster.
-	 */
-
-	res = ctdb_ltdb_store(ctdb_db, dd->key, &header, tdb_null);
-	if (res != 0) {
-		DEBUG(DEBUG_ERR, (__location__ ": Failed to store record with "
-				  "key hash [0x%08x] on database db[%s].\n",
-				  hash, ctdb_db->db_name));
-		goto skip;
-	}
-
-	tdb_chainunlock(ctdb_db->ltdb->tdb, dd->key);
-
-	goto done;
-
-skip:
-	tdb_chainunlock(ctdb_db->ltdb->tdb, dd->key);
-
-	recs->vdata->count.delete_list.skipped++;
-	recs->vdata->count.delete_list.left--;
-	talloc_free(dd);
-	dd = NULL;
-
-done:
-	if (dd == NULL) {
-		return 0;
-	}
-
-	return delete_marshall_traverse(param, data);
-}
-
-/**
  * traverse function for the traversal of the delete_queue,
  * the fast-path vacuuming list.
  *
@@ -563,6 +453,13 @@ static int delete_record_traverse(void *
 	uint32_t lmaster;
 	uint32_t hash = ctdb_hash(&(dd->key));
 
+	if (dd->remote_fail_count > 0) {
+		vdata->count.delete_list.remote_error++;
+		vdata->count.delete_list.left--;
+		talloc_free(dd);
+		return 0;
+	}
+
 	res = tdb_chainlock(ctdb_db->ltdb->tdb, dd->key);
 	if (res != 0) {
 		DEBUG(DEBUG_ERR,
@@ -602,12 +499,10 @@ static int delete_record_traverse(void *
 		goto skip;
 	}
 
-	if (header.rsn != dd->hdr.rsn + 1) {
+	if (header.rsn != dd->hdr.rsn) {
 		/*
 		 * The record has been migrated off the node and back again.
 		 * But not requeued for deletion. Skip it.
-		 * (Note that the first marshall traverse has bumped the RSN
-		 *  on disk.)
 		 */
 		DEBUG(DEBUG_INFO, (__location__ ": record with hash [0x%08x] "
 				   "on database db[%s] seems to have been "
@@ -805,15 +700,9 @@ static void ctdb_process_vacuum_fetch_li
  * at least some of these records previously from the former dmasters
  * with the vacuum fetch message.
  *
- * This last step is implemented as a 3-phase process to protect from
- * races leading to data corruption:
- *
- *  1) Send the lmaster's copy to all other active nodes with the
- *     RECEIVE_RECORDS control: The remote nodes store the lmaster's copy.
- *  2) Send the records that could successfully be stored remotely
- *     in step #1 to all active nodes with the TRY_DELETE_RECORDS
+ *  1) Send the records to all active nodes with the TRY_DELETE_RECORDS
  *     control. The remote notes delete their local copy.
- *  3) The lmaster locally deletes its copies of all records that
+ *  2) The lmaster locally deletes its copies of all records that
  *     could successfully be deleted remotely in step #2.
  */
 static void ctdb_process_delete_list(struct ctdb_db_context *ctdb_db,
@@ -861,17 +750,9 @@ static void ctdb_process_delete_list(str
 	num_active_nodes = talloc_get_size(active_nodes)/sizeof(*active_nodes);
 
 	/*
-	 * Now delete the records all active nodes in a three-phase process:
-	 * 1) send all active remote nodes the current empty copy with this
-	 *    node as DMASTER
-	 * 2) if all nodes could store the new copy,
-	 *    tell all the active remote nodes to delete all their copy
-	 * 3) if all remote nodes deleted their record copy, delete it locally
-	 */
-
-	/*
-	 * Step 1:
-	 * Send currently empty record copy to all active nodes for storing.
+	 * Now delete the records all active nodes in a two-phase process:
+	 * 1) tell all active remote nodes to delete all their copy
+	 * 2) if all remote nodes deleted their record copy, delete it locally
 	 */
 
 	recs = talloc_zero(tmp_ctx, struct delete_records_list);
@@ -879,122 +760,16 @@ static void ctdb_process_delete_list(str
 		DEBUG(DEBUG_ERR,(__location__ " Out of memory\n"));
 		goto done;
 	}
-	recs->records = (struct ctdb_marshall_buffer *)
-		talloc_zero_size(recs,
-				 offsetof(struct ctdb_marshall_buffer, data));
-	if (recs->records == NULL) {
-		DEBUG(DEBUG_ERR,(__location__ " Out of memory\n"));
-		goto done;
-	}
-	recs->records->db_id = ctdb_db->db_id;
-	recs->vdata = vdata;
-
-	/*
-	 * traverse the tree of all records we want to delete and
-	 * create a blob we can send to the other nodes.
-	 *
-	 * We call delete_marshall_traverse_first() to bump the
-	 * records' RSNs in the database, to ensure we (as dmaster)
-	 * keep the highest RSN of the records in the cluster.
-	 */
-	ret = trbt_traversearray32(vdata->delete_list, 1,
-				   delete_marshall_traverse_first, recs);
-	if (ret != 0) {
-		DEBUG(DEBUG_ERR, (__location__ " Error traversing the "
-		      "delete list for first marshalling.\n"));
-		goto done;
-	}
-
-	indata = ctdb_marshall_finish(recs->records);
-
-	for (i = 0; i < num_active_nodes; i++) {
-		struct ctdb_marshall_buffer *records;
-		struct ctdb_rec_data_old *rec;
-		int32_t res;
-		TDB_DATA outdata;
-
-		ret = ctdb_control(ctdb, active_nodes[i], 0,
-				CTDB_CONTROL_RECEIVE_RECORDS, 0,
-				indata, recs, &outdata, &res,
-				NULL, NULL);
-		if (ret != 0 || res != 0) {
-			DEBUG(DEBUG_ERR, ("Error storing record copies on "
-					  "node %u: ret[%d] res[%d]\n",
-					  active_nodes[i], ret, res));
-			goto done;
-		}
-
-		/*
-		 * outdata contains the list of records coming back
-		 * from the node: These are the records that the
-		 * remote node could not store. We remove these from
-		 * the list to process further.
-		 */
-		records = (struct ctdb_marshall_buffer *)outdata.dptr;
-		rec = (struct ctdb_rec_data_old *)&records->data[0];
-		while (records->count-- > 1) {
-			TDB_DATA reckey, recdata;
-			struct ctdb_ltdb_header *rechdr;
-			struct delete_record_data *dd;
-
-			reckey.dptr = &rec->data[0];
-			reckey.dsize = rec->keylen;
-			recdata.dptr = &rec->data[reckey.dsize];
-			recdata.dsize = rec->datalen;
-
-			if (recdata.dsize < sizeof(struct ctdb_ltdb_header)) {
-				DEBUG(DEBUG_CRIT,(__location__ " bad ltdb record\n"));
-				goto done;
-			}
-			rechdr = (struct ctdb_ltdb_header *)recdata.dptr;
-			recdata.dptr += sizeof(*rechdr);
-			recdata.dsize -= sizeof(*rechdr);
-
-			dd = (struct delete_record_data *)trbt_lookup32(
-					vdata->delete_list,
-					ctdb_hash(&reckey));
-			if (dd != NULL) {
-				/*
-				 * The other node could not store the record
-				 * copy and it is the first node that failed.
-				 * So we should remove it from the tree and
-				 * update statistics.
-				 */
-				talloc_free(dd);
-				vdata->count.delete_list.remote_error++;
-				vdata->count.delete_list.left--;
-			} else {
-				DEBUG(DEBUG_ERR, (__location__ " Failed to "
-				      "find record with hash 0x%08x coming "
-				      "back from RECEIVE_RECORDS "
-				      "control in delete list.\n",
-				      ctdb_hash(&reckey)));
-				vdata->count.delete_list.local_error++;
-				vdata->count.delete_list.left--;
-			}
-
-			rec = (struct ctdb_rec_data_old *)(rec->length + (uint8_t *)rec);
-		}
-	}
-
-	if (vdata->count.delete_list.left == 0) {
-		goto success;
-	}
 
 	/*
-	 * Step 2:
-	 * Send the remaining records to all active nodes for deletion.
-	 *
-	 * The lmaster's (i.e. our) copies of these records have been stored
-	 * successfully on the other nodes.
+	 * Step 1:
+	 * Send all records to all active nodes for deletion.
 	 */
 
 	/*
 	 * Create a marshall blob from the remaining list of records to delete.
 	 */
 
-	talloc_free(recs->records);
-
 	recs->records = (struct ctdb_marshall_buffer *)
 		talloc_zero_size(recs,
 				 offsetof(struct ctdb_marshall_buffer, data));
@@ -1062,34 +837,25 @@ static void ctdb_process_delete_list(str
 					ctdb_hash(&reckey));
 			if (dd != NULL) {
 				/*
-				 * The other node could not delete the
-				 * record and it is the first node that
-				 * failed. So we should remove it from
-				 * the tree and update statistics.
+				 * The remote node could not delete the
+				 * record.  Since other remote nodes can
+				 * also fail, we just mark the record.
 				 */
-				talloc_free(dd);
-				vdata->count.delete_list.remote_error++;
-				vdata->count.delete_list.left--;
+				dd->remote_fail_count++;
 			} else {
 				DEBUG(DEBUG_ERR, (__location__ " Failed to "
 				      "find record with hash 0x%08x coming "
 				      "back from TRY_DELETE_RECORDS "
 				      "control in delete list.\n",
 				      ctdb_hash(&reckey)));
-				vdata->count.delete_list.local_error++;
-				vdata->count.delete_list.left--;
 			}
 
 			rec = (struct ctdb_rec_data_old *)(rec->length + (uint8_t *)rec);
 		}
 	}
 
-	if (vdata->count.delete_list.left == 0) {
-		goto success;
-	}
-
 	/*
-	 * Step 3:
+	 * Step 2:
 	 * Delete the remaining records locally.
 	 *
 	 * These records have successfully been deleted on all
@@ -1103,8 +869,6 @@ static void ctdb_process_delete_list(str
 		      "delete list for deletion.\n"));
 	}
 
-success:
-
 	if (vdata->count.delete_list.left != 0) {
 		DEBUG(DEBUG_ERR, (__location__ " Vaccum db[%s] error: "
 		      "there are %u records left for deletion after "
diff -Npur samba-4.8.7/ctdb/server/eventscript.c samba-4.8.8/ctdb/server/eventscript.c
--- samba-4.8.7/ctdb/server/eventscript.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/ctdb/server/eventscript.c	2018-12-13 10:08:39.000000000 +0100
@@ -370,13 +370,8 @@ static void eventd_dead_handler(struct t
 				struct tevent_fd *fde, uint16_t flags,
 				void *private_data)
 {
-	struct eventd_context *ectx = talloc_get_type_abort(
-		private_data, struct eventd_context);
-
-	DEBUG(DEBUG_ERR, ("Eventd went away\n"));
-
-	TALLOC_FREE(ectx->eventd_fde);
-	ectx->eventd_pid = -1;
+	D_ERR("Eventd went away - exiting\n");
+	exit(1);
 }
 
 void ctdb_stop_eventd(struct ctdb_context *ctdb)
@@ -661,6 +656,7 @@ int ctdb_event_script_run(struct ctdb_co
 		DEBUG(DEBUG_ERR,
 		      ("Refusing to run event '%s' while in recovery\n",
 		       ctdb_eventscript_call_names[event]));
+		return -1;
 	}
 
 	state = talloc_zero(mem_ctx, struct ctdb_event_script_run_state);
diff -Npur samba-4.8.7/ctdb/tests/simple/69_recovery_resurrect_deleted.sh samba-4.8.8/ctdb/tests/simple/69_recovery_resurrect_deleted.sh
--- samba-4.8.7/ctdb/tests/simple/69_recovery_resurrect_deleted.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/ctdb/tests/simple/69_recovery_resurrect_deleted.sh	2018-12-13 10:08:39.000000000 +0100
@@ -0,0 +1,84 @@
+#!/bin/bash
+
+test_info()
+{
+    cat <<EOF
+Ensure recovery doesn't resurrect deleted records from recently inactive nodes
+EOF
+}
+
+. "${TEST_SCRIPTS_DIR}/integration.bash"
+
+ctdb_test_init "$@"
+
+set -e
+
+cluster_is_healthy
+
+# Reset configuration
+ctdb_restart_when_done
+
+testdb="rec_test.tdb"
+
+echo "Getting list of nodes..."
+try_command_on_node -v any "onnode -pq all ctdb pnn | grep '^[0-9][0-9]*$'"
+
+first=$(echo "$out" | sed -n -e '1p')
+second=$(echo "$out" | sed -n -e '2p')
+notfirst=$(echo "$out" | tail -n +2)
+
+echo "Create/wipe test database ${testdb}"
+try_command_on_node $first $CTDB attach "$testdb"
+try_command_on_node $first $CTDB wipedb "$testdb"
+
+echo "store key(test1) data(value1)"
+try_command_on_node $first $CTDB writekey "$testdb" test1 value1
+
+echo "Migrate key(test1) to all nodes"
+try_command_on_node all $CTDB readkey "$testdb" test1
+
+echo "Stop node ${first}"
+try_command_on_node $first $CTDB stop
+wait_until_node_has_status $first stopped
+
+echo "Delete key(test1)"
+try_command_on_node $second $CTDB deletekey "$testdb" test1
+
+database_has_zero_records ()
+{
+	local n
+	for n in $notfirst ; do
+		try_command_on_node $n $CTDB cattdb "$testdb"
+		if echo "$out" | grep -q '^key(' ; then
+			return 1
+		fi
+	done
+
+	return 0
+}
+
+echo "Get vacuum interval"
+try_command_on_node -v $second $CTDB getvar VacuumInterval
+vacuum_interval="${out#* = }"
+
+echo "Wait until vacuuming deletes the record on active nodes"
+# Why 4?  Steps are:
+# 1. Original node processes delete queue, asks lmaster to fetch
+# 2. lmaster recoverd fetches
+# 3. lmaster processes delete queue
+# If vacuuming is just missed then need an extra interval.
+wait_until $((vacuum_interval * 4)) database_has_zero_records
+
+echo "Continue node ${first}"
+try_command_on_node $first $CTDB continue
+wait_until_node_has_status $first notstopped
+
+echo "Get database contents"
+try_command_on_node -v $first $CTDB catdb "$testdb"
+
+if echo "$out" | grep -q '^key(' ; then
+	echo "BAD: Deleted record has been resurrected"
+	exit 1
+fi
+
+echo "GOOD: Deleted record is still gone"
diff -Npur samba-4.8.7/ctdb/tests/src/protocol_common_ctdb.c samba-4.8.8/ctdb/tests/src/protocol_common_ctdb.c
--- samba-4.8.7/ctdb/tests/src/protocol_common_ctdb.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/ctdb/tests/src/protocol_common_ctdb.c	2018-12-13 10:08:39.000000000 +0100
@@ -536,12 +536,6 @@ void fill_ctdb_req_control_data(TALLOC_C
 		fill_ctdb_traverse_all_ext(mem_ctx, cd->data.traverse_all_ext);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		cd->data.recbuf = talloc(mem_ctx, struct ctdb_rec_buffer);
-		assert(cd->data.recbuf != NULL);
-		fill_ctdb_rec_buffer(mem_ctx, cd->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
@@ -958,10 +952,6 @@ void verify_ctdb_req_control_data(struct
 					     cd2->data.traverse_all_ext);
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		verify_ctdb_rec_buffer(cd->data.recbuf, cd2->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
@@ -1400,12 +1390,6 @@ void fill_ctdb_reply_control_data(TALLOC
 	case CTDB_CONTROL_TRAVERSE_ALL_EXT:
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		cd->data.recbuf = talloc(mem_ctx, struct ctdb_rec_buffer);
-		assert(cd->data.recbuf != NULL);
-		fill_ctdb_rec_buffer(mem_ctx, cd->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
@@ -1758,10 +1742,6 @@ void verify_ctdb_reply_control_data(stru
 	case CTDB_CONTROL_TRAVERSE_ALL_EXT:
 		break;
 
-	case CTDB_CONTROL_RECEIVE_RECORDS:
-		verify_ctdb_rec_buffer(cd->data.recbuf, cd2->data.recbuf);
-		break;
-
 	case CTDB_CONTROL_IPREALLOCATED:
 		break;
 
diff -Npur samba-4.8.7/docs/manpages/cifsdd.8 samba-4.8.8/docs/manpages/cifsdd.8
--- samba-4.8.7/docs/manpages/cifsdd.8	2018-11-26 09:08:10.000000000 +0100
+++ samba-4.8.8/docs/manpages/cifsdd.8	2018-12-13 10:11:19.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "CIFSDD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/dbwrap_tool.1 samba-4.8.8/docs/manpages/dbwrap_tool.1
--- samba-4.8.7/docs/manpages/dbwrap_tool.1	2018-11-26 09:08:11.000000000 +0100
+++ samba-4.8.8/docs/manpages/dbwrap_tool.1	2018-12-13 10:11:19.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -301,7 +301,7 @@ dbwrap_tool
 Use with caution!
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/eventlogadm.8 samba-4.8.8/docs/manpages/eventlogadm.8
--- samba-4.8.7/docs/manpages/eventlogadm.8	2018-11-26 09:08:11.000000000 +0100
+++ samba-4.8.8/docs/manpages/eventlogadm.8	2018-12-13 10:11:19.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "EVENTLOGADM" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -339,7 +339,7 @@ Filter messages from the system log into
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/findsmb.1 samba-4.8.8/docs/manpages/findsmb.1
--- samba-4.8.7/docs/manpages/findsmb.1	2018-11-26 09:08:11.000000000 +0100
+++ samba-4.8.8/docs/manpages/findsmb.1	2018-12-13 10:11:19.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "FINDSMB" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -119,7 +119,7 @@ IP ADDR         NETBIOS NAME   WORKGROUP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/idmap_ad.8 samba-4.8.8/docs/manpages/idmap_ad.8
--- samba-4.8.7/docs/manpages/idmap_ad.8	2018-11-26 09:08:11.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_ad.8	2018-12-13 10:11:20.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_AD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_autorid.8 samba-4.8.8/docs/manpages/idmap_autorid.8
--- samba-4.8.7/docs/manpages/idmap_autorid.8	2018-11-26 09:08:12.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_autorid.8	2018-12-13 10:11:20.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_hash.8 samba-4.8.8/docs/manpages/idmap_hash.8
--- samba-4.8.7/docs/manpages/idmap_hash.8	2018-11-26 09:08:12.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_hash.8	2018-12-13 10:11:20.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_HASH" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_ldap.8 samba-4.8.8/docs/manpages/idmap_ldap.8
--- samba-4.8.7/docs/manpages/idmap_ldap.8	2018-11-26 09:08:12.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_ldap.8	2018-12-13 10:11:20.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_nss.8 samba-4.8.8/docs/manpages/idmap_nss.8
--- samba-4.8.7/docs/manpages/idmap_nss.8	2018-11-26 09:08:12.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_nss.8	2018-12-13 10:11:20.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_NSS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_rfc2307.8 samba-4.8.8/docs/manpages/idmap_rfc2307.8
--- samba-4.8.7/docs/manpages/idmap_rfc2307.8	2018-11-26 09:08:12.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_rfc2307.8	2018-12-13 10:11:21.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_rid.8 samba-4.8.8/docs/manpages/idmap_rid.8
--- samba-4.8.7/docs/manpages/idmap_rid.8	2018-11-26 09:08:13.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_rid.8	2018-12-13 10:11:21.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_RID" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_script.8 samba-4.8.8/docs/manpages/idmap_script.8
--- samba-4.8.7/docs/manpages/idmap_script.8	2018-11-26 09:08:13.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_script.8	2018-12-13 10:11:21.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_tdb.8 samba-4.8.8/docs/manpages/idmap_tdb.8
--- samba-4.8.7/docs/manpages/idmap_tdb.8	2018-11-26 09:08:13.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_tdb.8	2018-12-13 10:11:21.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_TDB" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/idmap_tdb2.8 samba-4.8.8/docs/manpages/idmap_tdb2.8
--- samba-4.8.7/docs/manpages/idmap_tdb2.8	2018-11-26 09:08:13.000000000 +0100
+++ samba-4.8.8/docs/manpages/idmap_tdb2.8	2018-12-13 10:11:21.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/libsmbclient.7 samba-4.8.8/docs/manpages/libsmbclient.7
--- samba-4.8.7/docs/manpages/libsmbclient.7	2018-11-26 09:08:13.000000000 +0100
+++ samba-4.8.8/docs/manpages/libsmbclient.7	2018-12-13 10:11:22.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: 7
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "11/26/2018" "Samba 4\&.8\&.7" "7"
+.TH "LIBSMBCLIENT" "7" "12/13/2018" "Samba 4\&.8\&.8" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ parameter was not included in the URL\&.
 Watch this space for future updates\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/lmhosts.5 samba-4.8.8/docs/manpages/lmhosts.5
--- samba-4.8.7/docs/manpages/lmhosts.5	2018-11-26 09:08:14.000000000 +0100
+++ samba-4.8.8/docs/manpages/lmhosts.5	2018-12-13 10:11:22.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "11/26/2018" "Samba 4\&.8\&.7" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "12/13/2018" "Samba 4\&.8\&.8" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ or
 /usr/local/samba/lib\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbclient\fR(1),
diff -Npur samba-4.8.7/docs/manpages/log2pcap.1 samba-4.8.8/docs/manpages/log2pcap.1
--- samba-4.8.7/docs/manpages/log2pcap.1	2018-11-26 09:08:14.000000000 +0100
+++ samba-4.8.8/docs/manpages/log2pcap.1	2018-12-13 10:11:22.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "LOG2PCAP" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -107,7 +107,7 @@ Convert to pcap using text2pcap:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "BUGS"
 .PP
 Only SMB data is extracted from the samba logs, no LDAP, NetBIOS lookup or other data\&.
diff -Npur samba-4.8.7/docs/manpages/mvxattr.1 samba-4.8.8/docs/manpages/mvxattr.1
--- samba-4.8.7/docs/manpages/mvxattr.1	2018-11-26 09:08:14.000000000 +0100
+++ samba-4.8.8/docs/manpages/mvxattr.1	2018-12-13 10:11:22.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "MVXATTR" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Force overwriting of destination xattr\&
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/net.8 samba-4.8.8/docs/manpages/net.8
--- samba-4.8.7/docs/manpages/net.8	2018-11-26 09:08:14.000000000 +0100
+++ samba-4.8.8/docs/manpages/net.8	2018-12-13 10:11:22.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "NET" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "NET" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/nmbd.8 samba-4.8.8/docs/manpages/nmbd.8
--- samba-4.8.7/docs/manpages/nmbd.8	2018-11-26 09:08:15.000000000 +0100
+++ samba-4.8.8/docs/manpages/nmbd.8	2018-12-13 10:11:23.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "NMBD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -278,7 +278,7 @@ The debug log level of nmbd may be raise
 (SIGUSR[1|2] signals are no longer used since Samba 2\&.2)\&. This is to allow transient problems to be diagnosed, whilst still running at a normally low log level\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBinetd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/nmblookup.1 samba-4.8.8/docs/manpages/nmblookup.1
--- samba-4.8.7/docs/manpages/nmblookup.1	2018-11-26 09:08:15.000000000 +0100
+++ samba-4.8.8/docs/manpages/nmblookup.1	2018-12-13 10:11:23.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "NMBLOOKUP" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -214,7 +214,7 @@ nmblookup \-U samba\&.org \-R \*(AqIRIX#
 would query the WINS server samba\&.org for the domain master browser (1B name type) for the IRIX workgroup\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/ntlm_auth.1 samba-4.8.8/docs/manpages/ntlm_auth.1
--- samba-4.8.7/docs/manpages/ntlm_auth.1	2018-11-26 09:08:15.000000000 +0100
+++ samba-4.8.8/docs/manpages/ntlm_auth.1	2018-12-13 10:11:23.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "NTLM_AUTH" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -421,7 +421,7 @@ If you\*(Aqre experiencing problems with
 the Microsoft Knowledge Base article #239869 and follow instructions described there\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/pam_winbind.8 samba-4.8.8/docs/manpages/pam_winbind.8
--- samba-4.8.7/docs/manpages/pam_winbind.8	2018-11-26 09:08:15.000000000 +0100
+++ samba-4.8.8/docs/manpages/pam_winbind.8	2018-12-13 10:11:23.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: 8
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "11/26/2018" "Samba 4\&.8\&.7" "8"
+.TH "PAM_WINBIND" "8" "12/13/2018" "Samba 4\&.8\&.8" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -172,7 +172,7 @@ This is the profile path set in the prof
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of Samba\&.
+This man page is part of version 4\&.8\&.8 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/pam_winbind.conf.5 samba-4.8.8/docs/manpages/pam_winbind.conf.5
--- samba-4.8.7/docs/manpages/pam_winbind.conf.5	2018-11-26 09:08:15.000000000 +0100
+++ samba-4.8.8/docs/manpages/pam_winbind.conf.5	2018-12-13 10:11:24.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: 5
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "11/26/2018" "Samba 4\&.8\&.7" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "12/13/2018" "Samba 4\&.8\&.8" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -137,7 +137,7 @@ Defines number of days before pam_winbin
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of Samba\&.
+This man page is part of version 4\&.8\&.8 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/pdbedit.8 samba-4.8.8/docs/manpages/pdbedit.8
--- samba-4.8.7/docs/manpages/pdbedit.8	2018-11-26 09:08:16.000000000 +0100
+++ samba-4.8.8/docs/manpages/pdbedit.8	2018-12-13 10:11:24.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "PDBEDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -619,7 +619,7 @@ option "<name>" to value "<value>" from
 This command may be used only by root\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.7/docs/manpages/profiles.1 samba-4.8.8/docs/manpages/profiles.1
--- samba-4.8.7/docs/manpages/profiles.1	2018-11-26 09:08:16.000000000 +0100
+++ samba-4.8.8/docs/manpages/profiles.1	2018-12-13 10:11:24.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "PROFILES" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/rpcclient.1 samba-4.8.8/docs/manpages/rpcclient.1
--- samba-4.8.7/docs/manpages/rpcclient.1	2018-11-26 09:08:16.000000000 +0100
+++ samba-4.8.8/docs/manpages/rpcclient.1	2018-12-13 10:11:24.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "RPCCLIENT" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -803,7 +803,7 @@ and
 that are incompatible for some commands or services\&. Additionally, the developers are sending reports to Microsoft, and problems found or reported to Microsoft are fixed in Service Packs, which may result in incompatibilities\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/samba-regedit.8 samba-4.8.8/docs/manpages/samba-regedit.8
--- samba-4.8.7/docs/manpages/samba-regedit.8	2018-11-26 09:08:16.000000000 +0100
+++ samba-4.8.8/docs/manpages/samba-regedit.8	2018-12-13 10:11:24.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -207,7 +207,7 @@ The supplied password is the NT hash\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/samba-tool.8 samba-4.8.8/docs/manpages/samba-tool.8
--- samba-4.8.7/docs/manpages/samba-tool.8	2018-11-26 09:08:16.000000000 +0100
+++ samba-4.8.8/docs/manpages/samba-tool.8	2018-12-13 10:11:25.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -470,7 +470,7 @@ because the repsFrom/To objects are not
 Gives usage information\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.7 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/samba.7 samba-4.8.8/docs/manpages/samba.7
--- samba-4.8.7/docs/manpages/samba.7	2018-11-26 09:08:17.000000000 +0100
+++ samba-4.8.8/docs/manpages/samba.7	2018-12-13 10:11:25.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: Miscellanea
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "11/26/2018" "Samba 4\&.8\&.7" "Miscellanea"
+.TH "SAMBA" "7" "12/13/2018" "Samba 4\&.8\&.8" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -237,7 +237,7 @@ https://lists\&.samba\&.org
 you can find a lot of information in the archives and you can subscribe to the samba list and ask for help or discuss things\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "CONTRIBUTIONS"
 .PP
 If you wish to contribute to the Samba project, then I suggest you join the Samba mailing list at
diff -Npur samba-4.8.7/docs/manpages/samba.8 samba-4.8.8/docs/manpages/samba.8
--- samba-4.8.7/docs/manpages/samba.8	2018-11-26 09:08:17.000000000 +0100
+++ samba-4.8.8/docs/manpages/samba.8	2018-12-13 10:11:25.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SAMBA" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -198,7 +198,7 @@ The number and nature of diagnostics ava
 Most messages are reasonably self\-explanatory\&. Unfortunately, at the time this man page was created, there are too many diagnostics available in the source code to warrant describing each and every diagnostic\&. At this stage your best bet is still to grep the source code and inspect the conditions that gave rise to the diagnostics you are seeing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBhosts_access\fR(5)
diff -Npur samba-4.8.7/docs/manpages/sharesec.1 samba-4.8.8/docs/manpages/sharesec.1
--- samba-4.8.7/docs/manpages/sharesec.1	2018-11-26 09:08:17.000000000 +0100
+++ samba-4.8.8/docs/manpages/sharesec.1	2018-12-13 10:11:25.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SHARESEC" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -337,7 +337,7 @@ List all ACEs for
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/smb.conf.5 samba-4.8.8/docs/manpages/smb.conf.5
--- samba-4.8.7/docs/manpages/smb.conf.5	2018-11-26 09:08:19.000000000 +0100
+++ samba-4.8.8/docs/manpages/smb.conf.5	2018-12-13 10:11:27.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "11/26/2018" "Samba 4\&.8\&.7" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "12/13/2018" "Samba 4\&.8\&.8" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -12953,7 +12953,7 @@ and
 special sections make life for an administrator easy, but the various combinations of default attributes can be tricky\&. Take extreme care when designing these sections\&. In particular, ensure that the permissions on spool directories are correct\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsamba\fR(7),
diff -Npur samba-4.8.7/docs/manpages/smbcacls.1 samba-4.8.8/docs/manpages/smbcacls.1
--- samba-4.8.7/docs/manpages/smbcacls.1	2018-11-26 09:08:19.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbcacls.1	2018-12-13 10:11:27.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBCACLS" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -491,7 +491,7 @@ smbcacls
 couldn\*(Aqt connect to the specified server, or there was an error getting or setting the ACLs, an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/smbclient.1 samba-4.8.8/docs/manpages/smbclient.1
--- samba-4.8.7/docs/manpages/smbclient.1	2018-11-26 09:08:19.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbclient.1	2018-12-13 10:11:27.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBCLIENT" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -1151,7 +1151,7 @@ Most diagnostics issued by the client ar
 The number and nature of diagnostics available depends on the debug level used by the client\&. If you have problems, set the debug level to 3 and peruse the log files\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/smbcontrol.1 samba-4.8.8/docs/manpages/smbcontrol.1
--- samba-4.8.7/docs/manpages/smbcontrol.1	2018-11-26 09:08:19.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbcontrol.1	2018-12-13 10:11:27.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBCONTROL" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -309,7 +309,7 @@ Query the number of smbd child processes
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8)
diff -Npur samba-4.8.7/docs/manpages/smbcquotas.1 samba-4.8.8/docs/manpages/smbcquotas.1
--- samba-4.8.7/docs/manpages/smbcquotas.1	2018-11-26 09:08:19.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbcquotas.1	2018-12-13 10:11:28.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBCQUOTAS" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -247,7 +247,7 @@ smbcquotas
 couldn\*(Aqt connect to the specified server, or when there was an error getting or setting the quota(s), an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/smbd.8 samba-4.8.8/docs/manpages/smbd.8
--- samba-4.8.7/docs/manpages/smbd.8	2018-11-26 09:08:20.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbd.8	2018-12-13 10:11:28.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SMBD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -252,7 +252,7 @@ parameter\&. When this is set, the follo
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "DIAGNOSTICS"
 .PP
 Most diagnostics issued by the server are logged in a specified log file\&. The log file name is specified at compile time, but may be overridden on the command line\&.
diff -Npur samba-4.8.7/docs/manpages/smbget.1 samba-4.8.8/docs/manpages/smbget.1
--- samba-4.8.7/docs/manpages/smbget.1	2018-11-26 09:08:20.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbget.1	2018-12-13 10:11:28.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBGET" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -189,7 +189,7 @@ smbget \-Rr smb://rhonwyn/
 Permission denied is returned in some cases where the cause of the error is unknown (such as an illegally formatted smb:// url or trying to get a directory without \-R turned on)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/smbgetrc.5 samba-4.8.8/docs/manpages/smbgetrc.5
--- samba-4.8.7/docs/manpages/smbgetrc.5	2018-11-26 09:08:20.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbgetrc.5	2018-12-13 10:11:28.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "11/26/2018" "Samba 4\&.8\&.7" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "12/13/2018" "Samba 4\&.8\&.8" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -87,7 +87,7 @@ Number of bytes to put in a block\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbget\fR(1)
diff -Npur samba-4.8.7/docs/manpages/smbpasswd.5 samba-4.8.8/docs/manpages/smbpasswd.5
--- samba-4.8.7/docs/manpages/smbpasswd.5	2018-11-26 09:08:20.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbpasswd.5	2018-12-13 10:11:28.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "11/26/2018" "Samba 4\&.8\&.7" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "12/13/2018" "Samba 4\&.8\&.8" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -165,7 +165,7 @@ This field consists of the time the acco
 All other colon separated fields are ignored at this time\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/smbpasswd.8 samba-4.8.8/docs/manpages/smbpasswd.8
--- samba-4.8.7/docs/manpages/smbpasswd.8	2018-11-26 09:08:20.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbpasswd.8	2018-12-13 10:11:29.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SMBPASSWD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -316,7 +316,7 @@ file and neglecting to allow "localhost"
 In addition, the smbpasswd command is only useful if Samba has been set up to use encrypted passwords\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.7/docs/manpages/smbspool.8 samba-4.8.8/docs/manpages/smbspool.8
--- samba-4.8.7/docs/manpages/smbspool.8	2018-11-26 09:08:21.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbspool.8	2018-12-13 10:11:29.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SMBSPOOL" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -173,7 +173,7 @@ The filename argument (argv[6]) contains
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.7/docs/manpages/smbspool_krb5_wrapper.8 samba-4.8.8/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.8.7/docs/manpages/smbspool_krb5_wrapper.8	2018-11-26 09:08:21.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbspool_krb5_wrapper.8	2018-12-13 10:11:29.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/smbstatus.1 samba-4.8.8/docs/manpages/smbstatus.1
--- samba-4.8.7/docs/manpages/smbstatus.1	2018-11-26 09:08:21.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbstatus.1	2018-12-13 10:11:29.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBSTATUS" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -154,7 +154,7 @@ causes smbstatus to display numeric UIDs
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.7/docs/manpages/smbtar.1 samba-4.8.8/docs/manpages/smbtar.1
--- samba-4.8.7/docs/manpages/smbtar.1	2018-11-26 09:08:21.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbtar.1	2018-12-13 10:11:29.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBTAR" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -145,7 +145,7 @@ section for the
 command\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.7/docs/manpages/smbtree.1 samba-4.8.8/docs/manpages/smbtree.1
--- samba-4.8.7/docs/manpages/smbtree.1	2018-11-26 09:08:22.000000000 +0100
+++ samba-4.8.8/docs/manpages/smbtree.1	2018-12-13 10:11:30.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "SMBTREE" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -191,7 +191,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/testparm.1 samba-4.8.8/docs/manpages/testparm.1
--- samba-4.8.7/docs/manpages/testparm.1	2018-11-26 09:08:22.000000000 +0100
+++ samba-4.8.8/docs/manpages/testparm.1	2018-12-13 10:11:30.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "TESTPARM" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -169,7 +169,7 @@ This is usually the name of the configur
 The program will issue a message saying whether the configuration file loaded OK or not\&. This message may be preceded by errors and warnings if the file did not load\&. If the file was loaded OK, the program then dumps all known service details to stdout\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmb.conf\fR(5),
diff -Npur samba-4.8.7/docs/manpages/traffic_learner.7 samba-4.8.8/docs/manpages/traffic_learner.7
--- samba-4.8.7/docs/manpages/traffic_learner.7	2018-11-26 09:08:22.000000000 +0100
+++ samba-4.8.8/docs/manpages/traffic_learner.7	2018-12-13 10:11:30.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: traffic_learner
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "TRAFFIC_LEARNER" "7" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "TRAFFIC_LEARNER" "7" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ There are two special packet types here\
 The other special packet is "\-", which represents the limit of the conversation\&. In the example, this indicates that one observed conversation ended after this particular ngram\&. This special opcode is also used at the beginning of conversations, which are indicated by the ngram "\-\et\-"\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.7 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_replay\fR(7)\&.
diff -Npur samba-4.8.7/docs/manpages/traffic_replay.7 samba-4.8.8/docs/manpages/traffic_replay.7
--- samba-4.8.7/docs/manpages/traffic_replay.7	2018-11-26 09:08:22.000000000 +0100
+++ samba-4.8.8/docs/manpages/traffic_replay.7	2018-12-13 10:11:30.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: traffic_replay
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "TRAFFIC_REPLAY" "7" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "TRAFFIC_REPLAY" "7" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -327,7 +327,7 @@ traffic_replay traffic\-model\&.txt my\-
 The users created by the test will have names like STGU\-0\-xyz\&. The groups generated have names like STGG\-0\-xyz\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.7 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_learner\fR(7)\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_acl_tdb.8 samba-4.8.8/docs/manpages/vfs_acl_tdb.8
--- samba-4.8.7/docs/manpages/vfs_acl_tdb.8	2018-11-26 09:08:22.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_acl_tdb.8	2018-12-13 10:11:30.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_acl_xattr.8 samba-4.8.8/docs/manpages/vfs_acl_xattr.8
--- samba-4.8.7/docs/manpages/vfs_acl_xattr.8	2018-11-26 09:08:23.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_acl_xattr.8	2018-12-13 10:11:31.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_aio_fork.8 samba-4.8.8/docs/manpages/vfs_aio_fork.8
--- samba-4.8.7/docs/manpages/vfs_aio_fork.8	2018-11-26 09:08:23.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_aio_fork.8	2018-12-13 10:11:31.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Straight forward use:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_aio_pthread.8 samba-4.8.8/docs/manpages/vfs_aio_pthread.8
--- samba-4.8.7/docs/manpages/vfs_aio_pthread.8	2018-11-26 09:08:23.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_aio_pthread.8	2018-12-13 10:11:31.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -78,7 +78,7 @@ By default this is set to 100\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_audit.8 samba-4.8.8/docs/manpages/vfs_audit.8
--- samba-4.8.7/docs/manpages/vfs_audit.8	2018-11-26 09:08:23.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_audit.8	2018-12-13 10:11:31.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_AUDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -118,7 +118,7 @@ Log operations on all shares using the L
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_btrfs.8 samba-4.8.8/docs/manpages/vfs_btrfs.8
--- samba-4.8.7/docs/manpages/vfs_btrfs.8	2018-11-26 09:08:23.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_btrfs.8	2018-12-13 10:11:31.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_BTRFS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -104,7 +104,7 @@ to Windows Explorer as file / directory
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_cacheprime.8 samba-4.8.8/docs/manpages/vfs_cacheprime.8
--- samba-4.8.7/docs/manpages/vfs_cacheprime.8	2018-11-26 09:08:24.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_cacheprime.8	2018-12-13 10:11:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ cacheprime
 is not a substitute for a general\-purpose readahead mechanism\&. It is intended for use only in very specific environments where disk operations must be aligned and sized to known values (as much as that is possible)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_cap.8 samba-4.8.8/docs/manpages/vfs_cap.8
--- samba-4.8.7/docs/manpages/vfs_cap.8	2018-11-26 09:08:24.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_cap.8	2018-12-13 10:11:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_CAP" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -63,7 +63,7 @@ On a system using GNU libiconv, use CAP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_catia.8 samba-4.8.8/docs/manpages/vfs_catia.8
--- samba-4.8.7/docs/manpages/vfs_catia.8	2018-11-26 09:08:24.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_catia.8	2018-12-13 10:11:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_CATIA" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_ceph.8 samba-4.8.8/docs/manpages/vfs_ceph.8
--- samba-4.8.7/docs/manpages/vfs_ceph.8	2018-11-26 09:08:24.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_ceph.8	2018-12-13 10:11:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_CEPH" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -94,7 +94,7 @@ Example: ceph:user_id = samba
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_commit.8 samba-4.8.8/docs/manpages/vfs_commit.8
--- samba-4.8.7/docs/manpages/vfs_commit.8	2018-11-26 09:08:24.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_commit.8	2018-12-13 10:11:32.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_COMMIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -116,7 +116,7 @@ commit
 may reduce performance\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_crossrename.8 samba-4.8.8/docs/manpages/vfs_crossrename.8
--- samba-4.8.7/docs/manpages/vfs_crossrename.8	2018-11-26 09:08:25.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_crossrename.8	2018-12-13 10:11:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -89,7 +89,7 @@ To add server\-side cross\-device rename
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_default_quota.8 samba-4.8.8/docs/manpages/vfs_default_quota.8
--- samba-4.8.7/docs/manpages/vfs_default_quota.8	2018-11-26 09:08:25.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_default_quota.8	2018-12-13 10:11:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ Store the default quota record in the qu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_dirsort.8 samba-4.8.8/docs/manpages/vfs_dirsort.8
--- samba-4.8.7/docs/manpages/vfs_dirsort.8	2018-11-26 09:08:25.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_dirsort.8	2018-12-13 10:11:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Sort directories for all shares:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_extd_audit.8 samba-4.8.8/docs/manpages/vfs_extd_audit.8
--- samba-4.8.7/docs/manpages/vfs_extd_audit.8	2018-11-26 09:08:25.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_extd_audit.8	2018-12-13 10:11:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -55,7 +55,7 @@ is identical to
 This module is stackable\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_fake_perms.8 samba-4.8.8/docs/manpages/vfs_fake_perms.8
--- samba-4.8.7/docs/manpages/vfs_fake_perms.8	2018-11-26 09:08:25.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_fake_perms.8	2018-12-13 10:11:33.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -58,7 +58,7 @@ This module is stackable\&.
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_fileid.8 samba-4.8.8/docs/manpages/vfs_fileid.8
--- samba-4.8.7/docs/manpages/vfs_fileid.8	2018-11-26 09:08:26.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_fileid.8	2018-12-13 10:11:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_FILEID" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ algorithm:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_fruit.8 samba-4.8.8/docs/manpages/vfs_fruit.8
--- samba-4.8.7/docs/manpages/vfs_fruit.8	2018-11-26 09:08:26.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_fruit.8	2018-12-13 10:11:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_FRUIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -488,6 +488,23 @@ Return the user\*(Aqs effective maximum
 The default is
 \fIyes\fR\&.
 .RE
+.PP
+fruit:wipe_intentionally_left_blank_rfork = yes | no
+.RS 4
+Whether to wipe Resource Fork data that matches the special 286 bytes sized placeholder blob that macOS client create on occasion\&. The blob contains a string
+\(lqThis resource fork intentionally left blank\(rq, the remaining bytes being mostly zero\&. There being no one use of this data, it is probably safe to discard it\&. When this option is enabled, this module truncates the Resource Fork stream to 0 bytes\&.
+.sp
+The default is
+\fIno\fR\&.
+.RE
+.PP
+fruit:delete_empty_adfiles = yes | no
+.RS 4
+Whether to delete empty AppleDouble files\&. Empty means that the resource fork entry in the AppleDouble files is of size 0, or the size is exactly 286 bytes and the content matches a special boilerplate resource fork created my macOS\&.
+.sp
+The default is
+\fIno\fR\&.
+.RE
 .SH "EXAMPLES"
 .sp
 .if n \{\
diff -Npur samba-4.8.7/docs/manpages/vfs_full_audit.8 samba-4.8.8/docs/manpages/vfs_full_audit.8
--- samba-4.8.7/docs/manpages/vfs_full_audit.8	2018-11-26 09:08:26.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_full_audit.8	2018-12-13 10:11:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -400,7 +400,7 @@ Log file and directory open operations o
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_glusterfs.8 samba-4.8.8/docs/manpages/vfs_glusterfs.8
--- samba-4.8.7/docs/manpages/vfs_glusterfs.8	2018-11-26 09:08:26.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_glusterfs.8	2018-12-13 10:11:34.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -109,7 +109,7 @@ Defines the glusterfs volumename to use
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_gpfs.8 samba-4.8.8/docs/manpages/vfs_gpfs.8
--- samba-4.8.7/docs/manpages/vfs_gpfs.8	2018-11-26 09:08:27.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_gpfs.8	2018-12-13 10:11:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_GPFS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -692,7 +692,7 @@ gpfs\&.h
 in gpfs versions newer than 3\&.2\&.1 PTF8\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.8.8/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.8.7/docs/manpages/vfs_linux_xfs_sgid.8	2018-11-26 09:08:27.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_linux_xfs_sgid.8	2018-12-13 10:11:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_media_harmony.8 samba-4.8.8/docs/manpages/vfs_media_harmony.8
--- samba-4.8.7/docs/manpages/vfs_media_harmony.8	2018-11-26 09:08:27.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_media_harmony.8	2018-12-13 10:11:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ vfs_media_harmony
 is designed to work with Avid editing applications that look in the Avid MediaFiles or OMFI MediaFiles directories for media\&. It is not designed to work as expected in all circumstances for general use\&. For example: It is possible to open a client\-specific file such as msmMMOB\&.mdb_192\&.168\&.1\&.10_userx even though it doesn\*(Aqt show up in a directory listing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_netatalk.8 samba-4.8.8/docs/manpages/vfs_netatalk.8
--- samba-4.8.7/docs/manpages/vfs_netatalk.8	2018-11-26 09:08:27.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_netatalk.8	2018-12-13 10:11:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_NETATALK" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Hide \&.AppleDouble files on the [data]
 This module is largely historic and unlikely to be of use in modern networks since current Apple systems are able to mount CIFS shares natively\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_nfs4acl_xattr.8 samba-4.8.8/docs/manpages/vfs_nfs4acl_xattr.8
--- samba-4.8.7/docs/manpages/vfs_nfs4acl_xattr.8	2018-11-26 09:08:27.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_nfs4acl_xattr.8	2018-12-13 10:11:35.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_nfs4acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_NFS4ACL_XATTR" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_NFS4ACL_XATTR" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_offline.8 samba-4.8.8/docs/manpages/vfs_offline.8
--- samba-4.8.7/docs/manpages/vfs_offline.8	2018-11-26 09:08:28.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_offline.8	2018-12-13 10:11:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Mark all files in a share as offline:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_prealloc.8 samba-4.8.8/docs/manpages/vfs_prealloc.8
--- samba-4.8.7/docs/manpages/vfs_prealloc.8	2018-11-26 09:08:28.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_prealloc.8	2018-12-13 10:11:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ vfs_prealloc
 is not supported on all platforms and filesystems\&. Currently only XFS filesystems on Linux and IRIX are supported\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_preopen.8 samba-4.8.8/docs/manpages/vfs_preopen.8
--- samba-4.8.7/docs/manpages/vfs_preopen.8	2018-11-26 09:08:28.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_preopen.8	2018-12-13 10:11:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -67,7 +67,7 @@ Number of files that should be speculati
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_readahead.8 samba-4.8.8/docs/manpages/vfs_readahead.8
--- samba-4.8.7/docs/manpages/vfs_readahead.8	2018-11-26 09:08:28.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_readahead.8	2018-12-13 10:11:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ G
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_readonly.8 samba-4.8.8/docs/manpages/vfs_readonly.8
--- samba-4.8.7/docs/manpages/vfs_readonly.8	2018-11-26 09:08:28.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_readonly.8	2018-12-13 10:11:36.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_READONLY" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -81,7 +81,7 @@ Mark the [backup] share as read only dur
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_recycle.8 samba-4.8.8/docs/manpages/vfs_recycle.8
--- samba-4.8.7/docs/manpages/vfs_recycle.8	2018-11-26 09:08:29.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_recycle.8	2018-12-13 10:11:37.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -136,7 +136,7 @@ instead of deleting them:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_shadow_copy.8 samba-4.8.8/docs/manpages/vfs_shadow_copy.8
--- samba-4.8.7/docs/manpages/vfs_shadow_copy.8	2018-11-26 09:08:29.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_shadow_copy.8	2018-12-13 10:11:37.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -167,7 +167,7 @@ vfs_shadow_copy
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_shadow_copy2.8 samba-4.8.8/docs/manpages/vfs_shadow_copy2.8
--- samba-4.8.7/docs/manpages/vfs_shadow_copy2.8	2018-11-26 09:08:29.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_shadow_copy2.8	2018-12-13 10:11:37.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -519,7 +519,7 @@ vfs_shadow_copy2
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_shell_snap.8 samba-4.8.8/docs/manpages/vfs_shell_snap.8
--- samba-4.8.7/docs/manpages/vfs_shell_snap.8	2018-11-26 09:08:29.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_shell_snap.8	2018-12-13 10:11:37.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ Samba\*(Aqs FSRVP server must be configu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_snapper.8 samba-4.8.8/docs/manpages/vfs_snapper.8
--- samba-4.8.7/docs/manpages/vfs_snapper.8	2018-11-26 09:08:30.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_snapper.8	2018-12-13 10:11:37.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -85,7 +85,7 @@ Remote snapshot creation and deletion is
 The DiskShadow\&.exe FSRVP client initially authenticates as the Active Directory computer account\&. This account must therefore be granted the same permissions as the user account issuing the snapshot creation and deletion requests\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_streams_depot.8 samba-4.8.8/docs/manpages/vfs_streams_depot.8
--- samba-4.8.7/docs/manpages/vfs_streams_depot.8	2018-11-26 09:08:30.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_streams_depot.8	2018-12-13 10:11:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_streams_xattr.8 samba-4.8.8/docs/manpages/vfs_streams_xattr.8
--- samba-4.8.7/docs/manpages/vfs_streams_xattr.8	2018-11-26 09:08:30.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_streams_xattr.8	2018-12-13 10:11:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_syncops.8 samba-4.8.8/docs/manpages/vfs_syncops.8
--- samba-4.8.7/docs/manpages/vfs_syncops.8	2018-11-26 09:08:30.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_syncops.8	2018-12-13 10:11:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_time_audit.8 samba-4.8.8/docs/manpages/vfs_time_audit.8
--- samba-4.8.7/docs/manpages/vfs_time_audit.8	2018-11-26 09:08:30.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_time_audit.8	2018-12-13 10:11:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -72,7 +72,7 @@ This would log VFS calls that take longe
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_tsmsm.8 samba-4.8.8/docs/manpages/vfs_tsmsm.8
--- samba-4.8.7/docs/manpages/vfs_tsmsm.8	2018-11-26 09:08:31.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_tsmsm.8	2018-12-13 10:11:38.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_TSMSM" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -83,7 +83,7 @@ A GPFS mount with TSM support can be exp
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_unityed_media.8 samba-4.8.8/docs/manpages/vfs_unityed_media.8
--- samba-4.8.7/docs/manpages/vfs_unityed_media.8	2018-11-26 09:08:31.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_unityed_media.8	2018-12-13 10:11:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -111,7 +111,7 @@ Enable unityed_media for Mac and Windows
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_virusfilter.8 samba-4.8.8/docs/manpages/vfs_virusfilter.8
--- samba-4.8.7/docs/manpages/vfs_virusfilter.8	2018-11-26 09:08:31.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_virusfilter.8	2018-12-13 10:11:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_virusfilter
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.8
 .\"  Language: English
 .\"
-.TH "VFS_VIRUSFILTER" "8" "11/26/2018" "Samba 4\&.8" "System Administration tools"
+.TH "VFS_VIRUSFILTER" "8" "12/13/2018" "Samba 4\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_worm.8 samba-4.8.8/docs/manpages/vfs_worm.8
--- samba-4.8.7/docs/manpages/vfs_worm.8	2018-11-26 09:08:31.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_worm.8	2018-12-13 10:11:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_WORM" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -68,7 +68,7 @@ Deny the write access to files and folde
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfs_xattr_tdb.8 samba-4.8.8/docs/manpages/vfs_xattr_tdb.8
--- samba-4.8.7/docs/manpages/vfs_xattr_tdb.8	2018-11-26 09:08:31.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_xattr_tdb.8	2018-12-13 10:11:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.7/docs/manpages/vfs_zfsacl.8 samba-4.8.8/docs/manpages/vfs_zfsacl.8
--- samba-4.8.7/docs/manpages/vfs_zfsacl.8	2018-11-26 09:08:32.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfs_zfsacl.8	2018-12-13 10:11:39.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ A ZFS mount can be exported via Samba as
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/vfstest.1 samba-4.8.8/docs/manpages/vfstest.1
--- samba-4.8.7/docs/manpages/vfstest.1	2018-11-26 09:08:32.000000000 +0100
+++ samba-4.8.8/docs/manpages/vfstest.1	2018-12-13 10:11:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "VFSTEST" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -807,7 +807,7 @@ exit
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/wbinfo.1 samba-4.8.8/docs/manpages/wbinfo.1
--- samba-4.8.7/docs/manpages/wbinfo.1	2018-11-26 09:08:32.000000000 +0100
+++ samba-4.8.8/docs/manpages/wbinfo.1	2018-12-13 10:11:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "11/26/2018" "Samba 4\&.8\&.7" "User Commands"
+.TH "WBINFO" "1" "12/13/2018" "Samba 4\&.8\&.8" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -440,7 +440,7 @@ wbinfo
 will always return failure\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBwinbindd\fR(8)
diff -Npur samba-4.8.7/docs/manpages/winbind_krb5_localauth.8 samba-4.8.8/docs/manpages/winbind_krb5_localauth.8
--- samba-4.8.7/docs/manpages/winbind_krb5_localauth.8	2018-11-26 09:08:32.000000000 +0100
+++ samba-4.8.8/docs/manpages/winbind_krb5_localauth.8	2018-12-13 10:11:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_localauth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: 8
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCALAU" "8" "11/26/2018" "Samba 4\&.8\&.7" "8"
+.TH "WINBIND_KRB5_LOCALAU" "8" "12/13/2018" "Samba 4\&.8\&.8" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -66,7 +66,7 @@ file\&.
 .sp
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/winbind_krb5_locator.8 samba-4.8.8/docs/manpages/winbind_krb5_locator.8
--- samba-4.8.7/docs/manpages/winbind_krb5_locator.8	2018-11-26 09:08:33.000000000 +0100
+++ samba-4.8.8/docs/manpages/winbind_krb5_locator.8	2018-12-13 10:11:40.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_locator
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: 8
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCATOR" "8" "11/26/2018" "Samba 4\&.8\&.7" "8"
+.TH "WINBIND_KRB5_LOCATOR" "8" "12/13/2018" "Samba 4\&.8\&.8" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -57,7 +57,7 @@ After copying the locator plugin to the
 /etc/krb5\&.conf\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.7/docs/manpages/winbindd.8 samba-4.8.8/docs/manpages/winbindd.8
--- samba-4.8.7/docs/manpages/winbindd.8	2018-11-26 09:08:33.000000000 +0100
+++ samba-4.8.8/docs/manpages/winbindd.8	2018-12-13 10:11:41.000000000 +0100
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 11/26/2018
+.\"      Date: 12/13/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.7
+.\"    Source: Samba 4.8.8
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "11/26/2018" "Samba 4\&.8\&.7" "System Administration tools"
+.TH "WINBINDD" "8" "12/13/2018" "Samba 4\&.8\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -579,7 +579,7 @@ Storage for cached user and group inform
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.7 of the Samba suite\&.
+This man page is part of version 4\&.8\&.8 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 nsswitch\&.conf(5),
diff -Npur samba-4.8.7/docs-xml/manpages/vfs_fruit.8.xml samba-4.8.8/docs-xml/manpages/vfs_fruit.8.xml
--- samba-4.8.7/docs-xml/manpages/vfs_fruit.8.xml	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/docs-xml/manpages/vfs_fruit.8.xml	2018-12-13 10:08:39.000000000 +0100
@@ -378,6 +378,31 @@
 	    </listitem>
 	  </varlistentry>
 
+	  <varlistentry>
+	    <term>fruit:wipe_intentionally_left_blank_rfork = yes | no</term>
+	    <listitem>
+	      <para>Whether to wipe Resource Fork data that matches the special
+	      286 bytes sized placeholder blob that macOS client create on
+	      occasion. The blob contains a string <quote>This resource fork
+	      intentionally left blank</quote>, the remaining bytes being mostly
+	      zero. There being no one use of this data, it is probably safe to
+	      discard it. When this option is enabled, this module truncates the
+	      Resource Fork stream to 0 bytes.</para>
+	      <para>The default is <emphasis>no</emphasis>.</para>
+	    </listitem>
+	  </varlistentry>
+
+	  <varlistentry>
+	    <term>fruit:delete_empty_adfiles = yes | no</term>
+	    <listitem>
+	      <para>Whether to delete empty AppleDouble files. Empty means that
+	      the resource fork entry in the AppleDouble files is of size 0, or
+	      the size is exactly 286 bytes and the content matches a special
+	      boilerplate resource fork created my macOS.</para>
+	      <para>The default is <emphasis>no</emphasis>.</para>
+	    </listitem>
+	  </varlistentry>
+
 	</variablelist>
 </refsect1>
 
diff -Npur samba-4.8.7/examples/fuse/smb2mount.c samba-4.8.8/examples/fuse/smb2mount.c
--- samba-4.8.7/examples/fuse/smb2mount.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/examples/fuse/smb2mount.c	2018-12-13 10:08:39.000000000 +0100
@@ -20,7 +20,7 @@
 
 #include "source3/include/includes.h"
 #include "popt.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "client.h"
 #include "libsmb/proto.h"
 #include "clifuse.h"
diff -Npur samba-4.8.7/examples/fuse/wscript_build samba-4.8.8/examples/fuse/wscript_build
--- samba-4.8.7/examples/fuse/wscript_build	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/examples/fuse/wscript_build	2018-12-13 10:08:39.000000000 +0100
@@ -3,5 +3,5 @@
 if bld.env.HAVE_FUSE:
     bld.SAMBA_BINARY('smb2mount',
                      source='smb2mount.c clifuse.c',
-                     deps='smbconf popt_samba3 libsmb fuse',
+                     deps='smbconf popt_samba3_cmdline libsmb fuse',
                      install=False)
diff -Npur samba-4.8.7/lib/util/debug.c samba-4.8.8/lib/util/debug.c
--- samba-4.8.7/lib/util/debug.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/lib/util/debug.c	2018-12-13 10:08:39.000000000 +0100
@@ -549,10 +549,10 @@ static const char *default_classname_tab
  * This is to allow reading of DEBUGLEVEL_CLASS before the debug
  * system has been initialized.
  */
-static const int debug_class_list_initial[ARRAY_SIZE(default_classname_table)];
+static int debug_class_list_initial[ARRAY_SIZE(default_classname_table)];
 
 static size_t debug_num_classes = 0;
-int     *DEBUGLEVEL_CLASS = discard_const_p(int, debug_class_list_initial);
+int     *DEBUGLEVEL_CLASS = debug_class_list_initial;
 
 
 /* -------------------------------------------------------------------------- **
diff -Npur samba-4.8.7/libcli/security/dom_sid.h samba-4.8.8/libcli/security/dom_sid.h
--- samba-4.8.7/libcli/security/dom_sid.h	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.8/libcli/security/dom_sid.h	2018-12-13 10:08:39.000000000 +0100
@@ -74,6 +74,7 @@ NTSTATUS dom_sid_lookup_predefined_sid(c
 				       enum lsa_SidType *type,
 				       const struct dom_sid **authority_sid,
 				       const char **authority_name);
+bool dom_sid_lookup_is_predefined_domain(const char *domain);
 
 int dom_sid_compare_auth(const struct dom_sid *sid1,
 			 const struct dom_sid *sid2);
diff -Npur samba-4.8.7/libcli/security/util_sid.c samba-4.8.8/libcli/security/util_sid.c
--- samba-4.8.7/libcli/security/util_sid.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.8/libcli/security/util_sid.c	2018-12-13 10:08:39.000000000 +0100
@@ -879,6 +879,39 @@ NTSTATUS dom_sid_lookup_predefined_name(
 	return NT_STATUS_NONE_MAPPED;
 }
 
+bool dom_sid_lookup_is_predefined_domain(const char *domain)
+{
+	size_t di;
+	bool match;
+
+	if (domain == NULL) {
+		domain = "";
+	}
+
+	match = strequal(domain, "");
+	if (match) {
+		/*
+		 * Strange, but that's what W2012R2 does.
+		 */
+		domain = "BUILTIN";
+	}
+
+	for (di = 0; di < ARRAY_SIZE(predefined_domains); di++) {
+		const struct predefined_domain_mapping *d =
+			&predefined_domains[di];
+		int cmp;
+
+		cmp = strcasecmp(d->domain, domain);
+		if (cmp != 0) {
+			continue;
+		}
+
+		return true;
+	}
+
+	return false;
+}
+
 NTSTATUS dom_sid_lookup_predefined_sid(const struct dom_sid *sid,
 				       const char **name,
 				       enum lsa_SidType *type,
diff -Npur samba-4.8.7/libcli/smb/smbXcli_base.c samba-4.8.8/libcli/smb/smbXcli_base.c
--- samba-4.8.7/libcli/smb/smbXcli_base.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/libcli/smb/smbXcli_base.c	2018-12-13 10:08:39.000000000 +0100
@@ -161,6 +161,7 @@ struct smb2cli_session {
 	uint64_t nonce_low;
 	uint16_t channel_sequence;
 	bool replay_active;
+	bool require_signed_response;
 };
 
 struct smbXcli_session {
@@ -227,6 +228,8 @@ struct smbXcli_req_state {
 
 	struct tevent_req *write_req;
 
+	struct timeval endtime;
+
 	struct {
 		/* Space for the header including the wct */
 		uint8_t hdr[HDR_VWV];
@@ -287,6 +290,7 @@ struct smbXcli_req_state {
 		uint64_t encryption_session_id;
 
 		bool signing_skipped;
+		bool require_signed_response;
 		bool notify_async;
 		bool got_async;
 		uint16_t cancel_flags;
@@ -1583,10 +1587,8 @@ struct tevent_req *smb1cli_req_create(TA
 	state->smb1.iov_count = iov_count + 4;
 
 	if (timeout_msec > 0) {
-		struct timeval endtime;
-
-		endtime = timeval_current_ofs_msec(timeout_msec);
-		if (!tevent_req_set_endtime(req, ev, endtime)) {
+		state->endtime = timeval_current_ofs_msec(timeout_msec);
+		if (!tevent_req_set_endtime(req, ev, state->endtime)) {
 			return req;
 		}
 	}
@@ -2892,6 +2894,14 @@ static void smb2cli_req_cancel_done(stru
 	TALLOC_FREE(subreq);
 }
 
+struct timeval smbXcli_req_endtime(struct tevent_req *req)
+{
+	struct smbXcli_req_state *state = tevent_req_data(
+		req, struct smbXcli_req_state);
+
+	return state->endtime;
+}
+
 struct tevent_req *smb2cli_req_create(TALLOC_CTX *mem_ctx,
 				      struct tevent_context *ev,
 				      struct smbXcli_conn *conn,
@@ -2954,6 +2964,8 @@ struct tevent_req *smb2cli_req_create(TA
 
 		state->smb2.should_sign = session->smb2->should_sign;
 		state->smb2.should_encrypt = session->smb2->should_encrypt;
+		state->smb2.require_signed_response =
+			session->smb2->require_signed_response;
 
 		if (cmd == SMB2_OP_SESSSETUP &&
 		    session->smb2_channel.signing_key.length == 0 &&
@@ -3041,10 +3053,8 @@ struct tevent_req *smb2cli_req_create(TA
 	}
 
 	if (timeout_msec > 0) {
-		struct timeval endtime;
-
-		endtime = timeval_current_ofs_msec(timeout_msec);
-		if (!tevent_req_set_endtime(req, ev, endtime)) {
+		state->endtime = timeval_current_ofs_msec(timeout_msec);
+		if (!tevent_req_set_endtime(req, ev, state->endtime)) {
 			return req;
 		}
 	}
@@ -3742,12 +3752,6 @@ static NTSTATUS smb2cli_conn_dispatch_in
 		}
 		last_session = session;
 
-		if (state->smb2.should_sign) {
-			if (!(flags & SMB2_HDR_FLAG_SIGNED)) {
-				return NT_STATUS_ACCESS_DENIED;
-			}
-		}
-
 		if (flags & SMB2_HDR_FLAG_SIGNED) {
 			uint64_t uid = BVAL(inhdr, SMB2_HDR_SESSION_ID);
 
@@ -3794,6 +3798,27 @@ static NTSTATUS smb2cli_conn_dispatch_in
 				 */
 				signing_key = NULL;
 			}
+
+			if (!NT_STATUS_IS_OK(status)) {
+				/*
+				 * Only check the signature of the last response
+				 * of a successfull session auth. This matches
+				 * Windows behaviour for NTLM auth and reauth.
+				 */
+				state->smb2.require_signed_response = false;
+			}
+		}
+
+		if (state->smb2.should_sign ||
+		    state->smb2.require_signed_response)
+		{
+			if (!(flags & SMB2_HDR_FLAG_SIGNED)) {
+				return NT_STATUS_ACCESS_DENIED;
+			}
+		}
+
+		if (signing_key == NULL && state->smb2.require_signed_response) {
+			signing_key = &session->smb2_channel.signing_key;
 		}
 
 		if (cur[0].iov_len == SMB2_TF_HDR_SIZE) {
@@ -3882,15 +3907,17 @@ static NTSTATUS smb2cli_conn_dispatch_in
 		}
 
 		if (signing_key) {
-			status = smb2_signing_check_pdu(*signing_key,
-							state->conn->protocol,
-							&cur[1], 3);
-			if (!NT_STATUS_IS_OK(status)) {
+			NTSTATUS signing_status;
+
+			signing_status = smb2_signing_check_pdu(*signing_key,
+								state->conn->protocol,
+								&cur[1], 3);
+			if (!NT_STATUS_IS_OK(signing_status)) {
 				/*
 				 * If the signing check fails, we disconnect
 				 * the connection.
 				 */
-				return status;
+				return signing_status;
 			}
 		}
 
@@ -5711,6 +5738,12 @@ void smb2cli_session_stop_replay(struct
 	session->smb2->replay_active = false;
 }
 
+void smb2cli_session_require_signed_response(struct smbXcli_session *session,
+					     bool require_signed_response)
+{
+	session->smb2->require_signed_response = require_signed_response;
+}
+
 NTSTATUS smb2cli_session_update_preauth(struct smbXcli_session *session,
 					const struct iovec *iov)
 {
diff -Npur samba-4.8.7/libcli/smb/smbXcli_base.h samba-4.8.8/libcli/smb/smbXcli_base.h
--- samba-4.8.7/libcli/smb/smbXcli_base.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/libcli/smb/smbXcli_base.h	2018-12-13 10:08:39.000000000 +0100
@@ -74,6 +74,7 @@ NTSTATUS smbXcli_conn_samba_suicide(stru
 
 void smbXcli_req_unset_pending(struct tevent_req *req);
 bool smbXcli_req_set_pending(struct tevent_req *req);
+struct timeval smbXcli_req_endtime(struct tevent_req *req);
 
 uint32_t smb1cli_conn_capabilities(struct smbXcli_conn *conn);
 uint32_t smb1cli_conn_max_xmit(struct smbXcli_conn *conn);
@@ -491,6 +492,8 @@ uint16_t smb2cli_session_reset_channel_s
 uint16_t smb2cli_session_current_channel_sequence(struct smbXcli_session *session);
 void smb2cli_session_start_replay(struct smbXcli_session *session);
 void smb2cli_session_stop_replay(struct smbXcli_session *session);
+void smb2cli_session_require_signed_response(struct smbXcli_session *session,
+					     bool require_signed_response);
 NTSTATUS smb2cli_session_update_preauth(struct smbXcli_session *session,
 					const struct iovec *iov);
 NTSTATUS smb2cli_session_set_session_key(struct smbXcli_session *session,
diff -Npur samba-4.8.7/nsswitch/tests/test_wbinfo.sh samba-4.8.8/nsswitch/tests/test_wbinfo.sh
--- samba-4.8.7/nsswitch/tests/test_wbinfo.sh	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/nsswitch/tests/test_wbinfo.sh	2018-12-13 10:08:39.000000000 +0100
@@ -125,6 +125,24 @@ else
 	echo "success: wbinfo -n check for sane mapping"
 fi
 
+echo "test: wbinfo -n NT Authority/Authenticated Users"
+$wbinfo -n "NT Authority/Authenticated Users"
+if [ $? -ne 0 ] ; then
+    echo "failure: wbinfo -n NT Authority/Authenticated Users"
+    failed=`expr $failed + 1`
+else
+    echo "success: wbinfo -n NT Authority/Authenticated Users"
+fi
+
+echo "test: wbinfo --group-info NT Authority/Authenticated Users"
+$wbinfo --group-info "NT Authority/Authenticated Users"
+if [ $? -ne 0 ] ; then
+    echo "failure: wbinfo --group-info NT Authority/Authenticated Users"
+    failed=`expr $failed + 1`
+else
+    echo "success: wbinfo --group-info NT Authority/Authenticated Users"
+fi
+
 testit "wbinfo -U against $TARGET" $wbinfo -U 30000 || failed=`expr $failed + 1`
 
 echo "test: wbinfo -U check for sane mapping"
diff -Npur samba-4.8.7/python/samba/dbchecker.py samba-4.8.8/python/samba/dbchecker.py
--- samba-4.8.7/python/samba/dbchecker.py	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.8/python/samba/dbchecker.py	2018-12-13 10:08:39.000000000 +0100
@@ -59,6 +59,7 @@ class dbcheck(object):
         self.fix_all_string_dn_component_mismatch = False
         self.fix_all_GUID_dn_component_mismatch = False
         self.fix_all_SID_dn_component_mismatch = False
+        self.fix_all_SID_dn_component_missing = False
         self.fix_all_old_dn_string_component_mismatch = False
         self.fix_all_metadata = False
         self.fix_time_metadata = False
@@ -378,10 +379,11 @@ systemFlags: -1946157056%s""" % (dn, gui
 
     def do_modify(self, m, controls, msg, validate=True):
         '''perform a modify with optional verbose output'''
+        controls = controls + ["local_oid:%s:0" % dsdb.DSDB_CONTROL_DBCHECK]
         if self.verbose:
             self.report(self.samdb.write_ldif(m, ldb.CHANGETYPE_MODIFY))
+            self.report("controls: %r" % controls)
         try:
-            controls = controls + ["local_oid:%s:0" % dsdb.DSDB_CONTROL_DBCHECK]
             self.samdb.modify(m, controls=controls, validate=validate)
         except Exception, err:
             if self.in_transaction:
@@ -650,7 +652,8 @@ newSuperior: %s""" % (str(from_dn), str(
         m.dn = dn
         m['old_value'] = ldb.MessageElement(val, ldb.FLAG_MOD_DELETE, attrname)
         m['new_value'] = ldb.MessageElement(str(dsdb_dn), ldb.FLAG_MOD_ADD, attrname)
-        if self.do_modify(m, ["show_recycled:1"],
+        if self.do_modify(m, ["show_recycled:1",
+                              "local_oid:%s:1" % dsdb.DSDB_CONTROL_DBCHECK_FIX_LINK_DN_NAME],
                           "Failed to fix old DN string on attribute %s" % (attrname)):
             self.report("Fixed old DN string on attribute %s" % (attrname))
 
@@ -671,6 +674,38 @@ newSuperior: %s""" % (str(from_dn), str(
                           "Failed to fix incorrect DN %s on attribute %s" % (mismatch_type, attrname)):
             self.report("Fixed incorrect DN %s on attribute %s" % (mismatch_type, attrname))
 
+    def err_dn_component_missing_target_sid(self, dn, attrname, val, dsdb_dn, target_sid_blob):
+        """handle a DN string being incorrect"""
+        self.report("ERROR: missing DN SID component for %s in object %s - %s" % (attrname, dn, val))
+
+        if len(dsdb_dn.prefix) != 0:
+            self.report("Not fixing missing DN SID on DN+BINARY or DN+STRING")
+            return
+
+        correct_dn = ldb.Dn(self.samdb, dsdb_dn.dn.extended_str())
+        correct_dn.set_extended_component("SID", target_sid_blob)
+
+        if not self.confirm_all('Change DN to %s?' % correct_dn.extended_str(),
+                                'fix_all_SID_dn_component_missing'):
+            self.report("Not fixing missing DN SID component")
+            return
+
+        target_guid_blob = correct_dn.get_extended_component("GUID")
+        guid_sid_dn = ldb.Dn(self.samdb, "")
+        guid_sid_dn.set_extended_component("GUID", target_guid_blob)
+        guid_sid_dn.set_extended_component("SID", target_sid_blob)
+
+        m = ldb.Message()
+        m.dn = dn
+        m['new_value'] = ldb.MessageElement(guid_sid_dn.extended_str(), ldb.FLAG_MOD_ADD, attrname)
+        controls = [
+            "show_recycled:1",
+            "local_oid:%s:1" % dsdb.DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID
+        ]
+        if self.do_modify(m, controls,
+                          "Failed to ADD missing DN SID on attribute %s" % (attrname)):
+            self.report("Fixed missing DN SID on attribute %s" % (attrname))
+
     def err_unknown_attribute(self, obj, attrname):
         '''handle an unknown attribute error'''
         self.report("ERROR: unknown attribute '%s' in %s" % (attrname, obj.dn))
@@ -759,7 +794,7 @@ newSuperior: %s""" % (str(from_dn), str(
         m = ldb.Message()
         m.dn = obj.dn
         m['value'] = ldb.MessageElement(forward_vals, ldb.FLAG_MOD_REPLACE, forward_attr)
-        if self.do_modify(m, ["local_oid:1.3.6.1.4.1.7165.4.3.19.2:1"],
+        if self.do_modify(m, ["local_oid:%s:1" % dsdb.DSDB_CONTROL_DBCHECK_FIX_DUPLICATE_LINKS],
                 "Failed to fix duplicate links in attribute '%s'" % forward_attr):
             self.report("Fixed duplicate links in attribute '%s'" % (forward_attr))
             duplicate_cache_key = "%s:%s" % (str(obj.dn), forward_attr)
@@ -1283,20 +1318,35 @@ newSuperior: %s""" % (str(from_dn), str(
                                                       res[0].dn, "GUID")
                 continue
 
-            if res[0].dn.get_extended_component("SID") != dsdb_dn.dn.get_extended_component("SID"):
+            target_sid = res[0].dn.get_extended_component("SID")
+            link_sid = dsdb_dn.dn.get_extended_component("SID")
+            if link_sid is None and target_sid is not None:
+                error_count += 1
+                self.err_dn_component_missing_target_sid(obj.dn, attrname, val,
+                                                         dsdb_dn, target_sid)
+                continue
+            if link_sid != target_sid:
                 error_count += 1
                 self.err_dn_component_target_mismatch(obj.dn, attrname, val, dsdb_dn,
                                                       res[0].dn, "SID")
                 continue
 
+            # Only for non-links, not even forward-only links
+            # (otherwise this breaks repl_meta_data):
+            #
             # Now we have checked the GUID and SID, offer to fix old
-            # DN strings as a non-error (for forward links with no
+            # DN strings as a non-error (DNs, not links so no
             # backlink).  Samba does not maintain this string
             # otherwise, so we don't increment error_count.
             if reverse_link_name is None:
-                if str(res[0].dn) != str(dsdb_dn.dn):
-                    self.err_dn_string_component_old(obj.dn, attrname, val, dsdb_dn,
-                                                     res[0].dn)
+                if linkID == 0 and str(res[0].dn) != str(dsdb_dn.dn):
+                    # Pass in the old/bad DN without the <GUID=...> part,
+                    # otherwise the LDB code will correct it on the way through
+                    # (Note: we still want to preserve the DSDB DN prefix in the
+                    # case of binary DNs)
+                    bad_dn = dsdb_dn.prefix + dsdb_dn.dn.get_linearized()
+                    self.err_dn_string_component_old(obj.dn, attrname, bad_dn,
+                                                     dsdb_dn, res[0].dn)
                 continue
 
             # check the reverse_link is correct if there should be one
diff -Npur samba-4.8.7/python/samba/tests/dns.py samba-4.8.8/python/samba/tests/dns.py
--- samba-4.8.7/python/samba/tests/dns.py	2018-11-26 08:54:31.000000000 +0100
+++ samba-4.8.8/python/samba/tests/dns.py	2018-12-13 10:08:39.000000000 +0100
@@ -821,6 +821,106 @@ class TestComplexQueries(DNSTest):
         max_recursion_depth = 20
         self.assertEquals(len(response.answers), max_recursion_depth)
 
+    # Make sure cname limit doesn't count other records.  This is a generic
+    # test called in tests below
+    def max_rec_test(self, rtype, rec_gen):
+        name = "limittestrec{0}.{1}".format(rtype, self.get_dns_domain())
+        limit = 20
+        num_recs_to_enter = limit + 5
+
+        for i in range(1, num_recs_to_enter+1):
+            ip = rec_gen(i)
+            self.make_dns_update(name, ip, rtype)
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        q = self.make_name_question(name,
+                                    rtype,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+        self.finish_name_packet(p, questions)
+
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+
+        self.assertEqual(len(response.answers), num_recs_to_enter)
+
+    def test_record_limit_A(self):
+        def ip4_gen(i):
+            return "127.0.0." + str(i)
+        self.max_rec_test(rtype=dns.DNS_QTYPE_A, rec_gen=ip4_gen)
+
+    def test_record_limit_AAAA(self):
+        def ip6_gen(i):
+            return "AAAA:0:0:0:0:0:0:" + str(i)
+        self.max_rec_test(rtype=dns.DNS_QTYPE_AAAA, rec_gen=ip6_gen)
+
+    def test_record_limit_SRV(self):
+        def srv_gen(i):
+            rec = dns.srv_record()
+            rec.priority = 1
+            rec.weight = 1
+            rec.port = 92
+            rec.target = "srvtestrec" + str(i)
+            return rec
+        self.max_rec_test(rtype=dns.DNS_QTYPE_SRV, rec_gen=srv_gen)
+
+    # Same as test_record_limit_A but with a preceding CNAME follow
+    def test_cname_limit(self):
+        cname1 = "cnamelimittestrec." + self.get_dns_domain()
+        cname2 = "cnamelimittestrec2." + self.get_dns_domain()
+        cname3 = "cnamelimittestrec3." + self.get_dns_domain()
+        ip_prefix = '127.0.0.'
+        limit = 20
+        num_recs_to_enter = limit + 5
+
+        self.make_dns_update(cname1, cname2, dnsp.DNS_TYPE_CNAME)
+        self.make_dns_update(cname2, cname3, dnsp.DNS_TYPE_CNAME)
+        num_arecs_to_enter = num_recs_to_enter - 2
+        for i in range(1, num_arecs_to_enter+1):
+            ip = ip_prefix + str(i)
+            self.make_dns_update(cname3, ip, dns.DNS_QTYPE_A)
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        q = self.make_name_question(cname1,
+                                    dns.DNS_QTYPE_A,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+        self.finish_name_packet(p, questions)
+
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+
+        self.assertEqual(len(response.answers), num_recs_to_enter)
+
+    # ANY query on cname record shouldn't follow the link
+    def test_cname_any_query(self):
+        cname1 = "cnameanytestrec." + self.get_dns_domain()
+        cname2 = "cnameanytestrec2." + self.get_dns_domain()
+        cname3 = "cnameanytestrec3." + self.get_dns_domain()
+
+        self.make_dns_update(cname1, cname2, dnsp.DNS_TYPE_CNAME)
+        self.make_dns_update(cname2, cname3, dnsp.DNS_TYPE_CNAME)
+
+        p = self.make_name_packet(dns.DNS_OPCODE_QUERY)
+        questions = []
+
+        q = self.make_name_question(cname1,
+                                    dns.DNS_QTYPE_ALL,
+                                    dns.DNS_QCLASS_IN)
+        questions.append(q)
+        self.finish_name_packet(p, questions)
+
+        (response, response_packet) =\
+            self.dns_transaction_udp(p, host=self.server_ip)
+
+        self.assertEqual(len(response.answers), 1)
+        self.assertEqual(response.answers[0].name, cname1)
+        self.assertEqual(response.answers[0].rdata, cname2)
+
 
 class TestInvalidQueries(DNSTest):
     def setUp(self):
diff -Npur samba-4.8.7/python/samba/tests/docs.py samba-4.8.8/python/samba/tests/docs.py
--- samba-4.8.7/python/samba/tests/docs.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/python/samba/tests/docs.py	2018-12-13 10:08:39.000000000 +0100
@@ -163,7 +163,8 @@ class SmbDotConfTests(TestCase):
                           'registry shares',
                           'smb ports',
                           'rpc server dynamic port range',
-                          'name resolve order'])
+                          'name resolve order',
+                          'clustering'])
         self._test_empty(['bin/testparm'])
 
     def test_default_s4(self):
diff -Npur samba-4.8.7/selftest/knownfail.d/dns samba-4.8.8/selftest/knownfail.d/dns
--- samba-4.8.7/selftest/knownfail.d/dns	2018-11-26 08:54:31.000000000 +0100
+++ samba-4.8.8/selftest/knownfail.d/dns	2018-12-13 10:08:39.000000000 +0100
@@ -47,7 +47,17 @@ samba.tests.dns.__main__.TestSimpleQueri
 samba.tests.dns.__main__.TestSimpleQueries.test_one_SOA_query\(rodc:local\)
 
 #
-# rodc and vampire_dc require signed dns updates, so the test setup
-# fails, but the test does run on fl2003dc
+# rodc and vampire_dc require signed dns updates, so these tests' setups
+# fail, but they pass on fl2003dc
 ^samba.tests.dns.__main__.TestComplexQueries.test_cname_loop\(rodc:local\)
 ^samba.tests.dns.__main__.TestComplexQueries.test_cname_loop\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_A\(rodc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_A\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_AAAA\(rodc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_AAAA\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_SRV\(rodc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_record_limit_SRV\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_cname_limit\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_cname_limit\(rodc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_cname_any_query\(vampire_dc:local\)
+^samba.tests.dns.__main__.TestComplexQueries.test_cname_any_query\(rodc:local\)
diff -Npur samba-4.8.7/selftest/knownfail.d/samba3.vfs.fruit samba-4.8.8/selftest/knownfail.d/samba3.vfs.fruit
--- samba-4.8.7/selftest/knownfail.d/samba3.vfs.fruit	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/selftest/knownfail.d/samba3.vfs.fruit	2018-12-13 10:08:39.000000000 +0100
@@ -1 +1,2 @@
 ^samba3.vfs.fruit streams_depot.OS X AppleDouble file conversion\(nt4_dc\)
+^samba3.vfs.fruit streams_depot.OS X AppleDouble file conversion without embedded xattr\(nt4_dc\)
diff -Npur samba-4.8.7/selftest/target/Samba3.pm samba-4.8.8/selftest/target/Samba3.pm
--- samba-4.8.7/selftest/target/Samba3.pm	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/selftest/target/Samba3.pm	2018-12-13 10:08:40.000000000 +0100
@@ -1981,6 +1981,24 @@ sub provision($$$$$$$$$)
 	fruit:time machine = yes
 	fruit:time machine max size = 32K
 
+[vfs_fruit_wipe_intentionally_left_blank_rfork]
+	path = $shrdir
+	vfs objects = fruit streams_xattr acl_xattr xattr_tdb
+	fruit:resource = file
+	fruit:metadata = stream
+	fruit:wipe_intentionally_left_blank_rfork = true
+	fruit:delete_empty_adfiles = false
+	fruit:veto_appledouble = no
+
+[vfs_fruit_delete_empty_adfiles]
+	path = $shrdir
+	vfs objects = fruit streams_xattr acl_xattr xattr_tdb
+	fruit:resource = file
+	fruit:metadata = stream
+	fruit:wipe_intentionally_left_blank_rfork = true
+	fruit:delete_empty_adfiles = true
+	fruit:veto_appledouble = no
+
 [badname-tmp]
 	path = $badnames_shrdir
 	guest ok = yes
@@ -2207,6 +2225,16 @@ sub provision($$$$$$$$$)
 	kernel oplocks = no
 	posix locking = no
 	include = $libdir/delay_inject.conf
+
+[aio_delay_inject]
+	copy = tmp
+	vfs objects = delay_inject
+	delay_inject:pread_send = 2000
+	delay_inject:pwrite_send = 2000
+
+[delete_readonly]
+	path = $prefix_abs/share
+	delete readonly = yes
 	";
 	close(CONF);
 
diff -Npur samba-4.8.7/source3/client/client.c samba-4.8.8/source3/client/client.c
--- samba-4.8.7/source3/client/client.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/client/client.c	2018-12-13 10:08:40.000000000 +0100
@@ -23,7 +23,7 @@
 
 #include "includes.h"
 #include "system/filesys.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "rpc_client/cli_pipe.h"
 #include "client/client_proto.h"
 #include "client/clitar_proto.h"
diff -Npur samba-4.8.7/source3/include/messages.h samba-4.8.8/source3/include/messages.h
--- samba-4.8.7/source3/include/messages.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/include/messages.h	2018-12-13 10:08:40.000000000 +0100
@@ -46,9 +46,6 @@ struct messaging_rec;
 
 struct messaging_context *messaging_init(TALLOC_CTX *mem_ctx, 
 					 struct tevent_context *ev);
-NTSTATUS messaging_init_client(TALLOC_CTX *mem_ctx,
-			       struct tevent_context *ev,
-			       struct messaging_context **pmsg_ctx);
 
 struct server_id messaging_server_id(const struct messaging_context *msg_ctx);
 struct tevent_context *messaging_tevent_context(
diff -Npur samba-4.8.7/source3/include/popt_common.h samba-4.8.8/source3/include/popt_common.h
--- samba-4.8.7/source3/include/popt_common.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/include/popt_common.h	2018-12-13 10:08:40.000000000 +0100
@@ -21,7 +21,6 @@
 #define _POPT_COMMON_H
 
 #include <popt.h>
-#include "auth_info.h"
 
 /* Common popt structures */
 extern struct poptOption popt_common_samba[];
@@ -41,19 +40,10 @@ extern const struct poptOption popt_comm
 #define POPT_COMMON_CONNECTION { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_connection, 0, "Connection options:", NULL },
 #define POPT_COMMON_VERSION { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_version, 0, "Common samba options:", NULL },
 #define POPT_COMMON_CONFIGFILE { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_configfile, 0, "Common samba config:", NULL },
-#define POPT_COMMON_CREDENTIALS { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_credentials, 0, "Authentication options:", NULL },
 #define POPT_COMMON_DYNCONFIG { NULL, 0, POPT_ARG_INCLUDE_TABLE, \
     discard_const_p(poptOption, popt_common_dynconfig), 0, \
     "Build-time configuration overrides:", NULL },
 #define POPT_COMMON_DEBUGLEVEL { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_debuglevel, 0, "Common samba debugging:", NULL },
 #define POPT_COMMON_OPTION { NULL, 0, POPT_ARG_INCLUDE_TABLE, popt_common_option, 0, "Common samba commandline config:", NULL },
 
-struct user_auth_info *popt_get_cmdline_auth_info(void);
-void popt_free_cmdline_auth_info(void);
-
-void popt_common_credentials_set_ignore_missing_conf(void);
-void popt_common_credentials_set_delay_post(void);
-void popt_common_credentials_post(void);
-void popt_burn_cmdline_password(int argc, char *argv[]);
-
 #endif /* _POPT_COMMON_H */
diff -Npur samba-4.8.7/source3/include/popt_common_cmdline.h samba-4.8.8/source3/include/popt_common_cmdline.h
--- samba-4.8.7/source3/include/popt_common_cmdline.h	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/source3/include/popt_common_cmdline.h	2018-12-13 10:08:40.000000000 +0100
@@ -0,0 +1,47 @@
+/*
+   Unix SMB/CIFS implementation.
+   Common popt arguments
+   Copyright (C) Jelmer Vernooij	2003
+   Copyright (C) Christof Schmitt	2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+
+#ifndef _POPT_COMMON_CREDENTIALS_H
+#define _POPT_COMMON_CREDENTIALS_H
+
+#include "popt_common.h"
+
+extern struct poptOption popt_common_credentials[];
+#define POPT_COMMON_CREDENTIALS \
+	{ \
+		NULL,						\
+		0,						\
+		POPT_ARG_INCLUDE_TABLE,			\
+		popt_common_credentials,			\
+		0,						\
+		"Authentication options:",			\
+		NULL						\
+	},
+
+struct user_auth_info *popt_get_cmdline_auth_info(void);
+void popt_free_cmdline_auth_info(void);
+
+void popt_common_credentials_set_ignore_missing_conf(void);
+void popt_common_credentials_set_delay_post(void);
+void popt_common_credentials_post(void);
+void popt_burn_cmdline_password(int argc, char *argv[]);
+
+#endif
diff -Npur samba-4.8.7/source3/lib/cmdline_contexts.c samba-4.8.8/source3/lib/cmdline_contexts.c
--- samba-4.8.7/source3/lib/cmdline_contexts.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/source3/lib/cmdline_contexts.c	2018-12-13 10:08:40.000000000 +0100
@@ -0,0 +1,70 @@
+/*
+   Unix SMB/CIFS implementation.
+   cmdline context wrapper.
+
+   Copyright (C) Christof Schmitt <cs@samba.org> 2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "cmdline_contexts.h"
+#include "includes.h"
+#include "messages.h"
+
+struct messaging_context *cmdline_messaging_context(const char *config_file)
+{
+	struct messaging_context *msg_ctx = NULL;
+
+	/*
+	 * Ensure that a config is loaded, in case the underlying
+	 * messaging_init needs to create directories or sockets.
+	 */
+	if (!lp_loaded()) {
+		if (!lp_load_initial_only(config_file)) {
+			return NULL;
+		}
+	}
+
+	/*
+	 * Clustered Samba can only work as root due to required
+	 * access to the registry and ctdb, which in turn requires
+	 * messaging access as root.
+	 */
+	if (lp_clustering() && geteuid() != 0) {
+		fprintf(stderr, "Cluster mode requires running as root.\n");
+		exit(1);
+	}
+
+	msg_ctx = server_messaging_context();
+	if (msg_ctx == NULL) {
+		if (geteuid() == 0) {
+			fprintf(stderr,
+				"Unable to initialize messaging context!\n");
+			exit(1);
+		} else {
+			/*
+			 * Non-cluster, non-root: Log error, but leave
+			 * it up to the caller how to proceed.
+			 */
+			DBG_NOTICE("Unable to initialize messaging context.\n");
+		}
+	}
+
+	return msg_ctx;
+}
+
+void cmdline_messaging_context_free(void)
+{
+	server_messaging_context_free();
+}
diff -Npur samba-4.8.7/source3/lib/cmdline_contexts.h samba-4.8.8/source3/lib/cmdline_contexts.h
--- samba-4.8.7/source3/lib/cmdline_contexts.h	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/source3/lib/cmdline_contexts.h	2018-12-13 10:08:40.000000000 +0100
@@ -0,0 +1,27 @@
+/*
+   Unix SMB/CIFS implementation.
+   cmdline context wrapper.
+
+   Copyright (C) Christof Schmitt <cs@samba.org> 2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef _LIB_CMDLINE_CONTEXTS_H
+#define _LIB_CMDLINE_CONTEXTS_H
+
+struct messaging_context *cmdline_messaging_context(const char *config_file);
+void cmdline_messaging_context_free(void);
+
+#endif
diff -Npur samba-4.8.7/source3/lib/messages.c samba-4.8.8/source3/lib/messages.c
--- samba-4.8.7/source3/lib/messages.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.8/source3/lib/messages.c	2018-12-13 10:08:40.000000000 +0100
@@ -595,15 +595,6 @@ struct messaging_context *messaging_init
 	return ctx;
 }
 
-NTSTATUS messaging_init_client(TALLOC_CTX *mem_ctx,
-			       struct tevent_context *ev,
-			       struct messaging_context **pmsg_ctx)
-{
-	return messaging_init_internal(mem_ctx,
-					ev,
-					pmsg_ctx);
-}
-
 struct server_id messaging_server_id(const struct messaging_context *msg_ctx)
 {
 	return msg_ctx->id;
diff -Npur samba-4.8.7/source3/lib/popt_common.c samba-4.8.8/source3/lib/popt_common.c
--- samba-4.8.7/source3/lib/popt_common.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/lib/popt_common.c	2018-12-13 10:08:40.000000000 +0100
@@ -93,6 +93,10 @@ static void popt_common_callback(poptCon
 			}
 		}
 
+		if (override_logfile) {
+			setup_logging(lp_logfile(talloc_tos()), DEBUG_FILE );
+		}
+
 		/* Further 'every Samba program must do this' hooks here. */
 		return;
 	}
@@ -209,215 +213,3 @@ struct poptOption popt_common_option[] =
 	{ "option",         0, POPT_ARG_STRING, NULL, OPT_OPTION, "Set smb.conf option from command line", "name=value" },
 	POPT_TABLEEND
 };
-
-/* Handle command line options:
- *		-U,--user
- *		-A,--authentication-file
- *		-k,--use-kerberos
- *		-N,--no-pass
- *		-S,--signing
- *              -P --machine-pass
- * 		-e --encrypt
- * 		-C --use-ccache
- */
-
-static struct user_auth_info *cmdline_auth_info;
-
-struct user_auth_info *popt_get_cmdline_auth_info(void)
-{
-	return cmdline_auth_info;
-}
-void popt_free_cmdline_auth_info(void)
-{
-	TALLOC_FREE(cmdline_auth_info);
-}
-
-static bool popt_common_credentials_ignore_missing_conf;
-static bool popt_common_credentials_delay_post;
-
-void popt_common_credentials_set_ignore_missing_conf(void)
-{
-	popt_common_credentials_delay_post = true;
-}
-
-void popt_common_credentials_set_delay_post(void)
-{
-	popt_common_credentials_delay_post = true;
-}
-
-void popt_common_credentials_post(void)
-{
-	if (get_cmdline_auth_info_use_machine_account(cmdline_auth_info) &&
-	    !set_cmdline_auth_info_machine_account_creds(cmdline_auth_info))
-	{
-		fprintf(stderr,
-			"Failed to use machine account credentials\n");
-		exit(1);
-	}
-
-	set_cmdline_auth_info_getpass(cmdline_auth_info);
-
-	/*
-	 * When we set the username during the handling of the options passed to
-	 * the binary we haven't loaded the config yet. This means that we
-	 * didnn't take the 'winbind separator' into account.
-	 *
-	 * The username might contain the domain name and thus it hasn't been
-	 * correctly parsed yet. If we have a username we need to set it again
-	 * to run the string parser for the username correctly.
-	 */
-	reset_cmdline_auth_info_username(cmdline_auth_info);
-}
-
-static void popt_common_credentials_callback(poptContext con,
-					enum poptCallbackReason reason,
-					const struct poptOption *opt,
-					const char *arg, const void *data)
-{
-	if (reason == POPT_CALLBACK_REASON_PRE) {
-		struct user_auth_info *auth_info =
-				user_auth_info_init(NULL);
-		if (auth_info == NULL) {
-			fprintf(stderr, "user_auth_info_init() failed\n");
-			exit(1);
-		}
-		cmdline_auth_info = auth_info;
-		return;
-	}
-
-	if (reason == POPT_CALLBACK_REASON_POST) {
-		bool ok;
-
-		if (override_logfile) {
-			setup_logging(lp_logfile(talloc_tos()), DEBUG_FILE );
-		}
-
-		ok = lp_load_client(get_dyn_CONFIGFILE());
-		if (!ok) {
-			const char *pname = poptGetInvocationName(con);
-
-			fprintf(stderr, "%s: Can't load %s - run testparm to debug it\n",
-				pname, get_dyn_CONFIGFILE());
-			if (!popt_common_credentials_ignore_missing_conf) {
-				exit(1);
-			}
-		}
-
-		load_interfaces();
-
-		set_cmdline_auth_info_guess(cmdline_auth_info);
-
-		if (popt_common_credentials_delay_post) {
-			return;
-		}
-
-		popt_common_credentials_post();
-		return;
-	}
-
-	switch(opt->val) {
-	case 'U':
-		set_cmdline_auth_info_username(cmdline_auth_info, arg);
-		break;
-
-	case 'A':
-		set_cmdline_auth_info_from_file(cmdline_auth_info, arg);
-		break;
-
-	case 'k':
-#ifndef HAVE_KRB5
-		d_printf("No kerberos support compiled in\n");
-		exit(1);
-#else
-		set_cmdline_auth_info_use_krb5_ticket(cmdline_auth_info);
-#endif
-		break;
-
-	case 'S':
-		if (!set_cmdline_auth_info_signing_state(cmdline_auth_info,
-				arg)) {
-			fprintf(stderr, "Unknown signing option %s\n", arg );
-			exit(1);
-		}
-		break;
-	case 'P':
-		set_cmdline_auth_info_use_machine_account(cmdline_auth_info);
-		break;
-	case 'N':
-		set_cmdline_auth_info_password(cmdline_auth_info, "");
-		break;
-	case 'e':
-		set_cmdline_auth_info_smb_encrypt(cmdline_auth_info);
-		break;
-	case 'C':
-		set_cmdline_auth_info_use_ccache(cmdline_auth_info, true);
-		break;
-	case 'H':
-		set_cmdline_auth_info_use_pw_nt_hash(cmdline_auth_info, true);
-		break;
-	}
-}
-
-/**
- * @brief Burn the commandline password.
- *
- * This function removes the password from the command line so we
- * don't leak the password e.g. in 'ps aux'.
- *
- * It should be called after processing the options and you should pass down
- * argv from main().
- *
- * @param[in]  argc     The number of arguments.
- *
- * @param[in]  argv[]   The argument array we will find the array.
- */
-void popt_burn_cmdline_password(int argc, char *argv[])
-{
-	bool found = false;
-	char *p = NULL;
-	int i, ulen = 0;
-
-	for (i = 0; i < argc; i++) {
-		p = argv[i];
-		if (strncmp(p, "-U", 2) == 0) {
-			ulen = 2;
-			found = true;
-		} else if (strncmp(p, "--user", 6) == 0) {
-			ulen = 6;
-			found = true;
-		}
-
-		if (found) {
-			if (p == NULL) {
-				return;
-			}
-
-			if (strlen(p) == ulen) {
-				continue;
-			}
-
-			p = strchr_m(p, '%');
-			if (p != NULL) {
-				memset(p, '\0', strlen(p));
-			}
-			found = false;
-		}
-	}
-}
-
-struct poptOption popt_common_credentials[] = {
-	{ NULL, 0, POPT_ARG_CALLBACK|POPT_CBFLAG_PRE|POPT_CBFLAG_POST,
-	  (void *)popt_common_credentials_callback, 0, NULL },
-	{ "user", 'U', POPT_ARG_STRING, NULL, 'U', "Set the network username", "USERNAME" },
-	{ "no-pass", 'N', POPT_ARG_NONE, NULL, 'N', "Don't ask for a password" },
-	{ "kerberos", 'k', POPT_ARG_NONE, NULL, 'k', "Use kerberos (active directory) authentication" },
-	{ "authentication-file", 'A', POPT_ARG_STRING, NULL, 'A', "Get the credentials from a file", "FILE" },
-	{ "signing", 'S', POPT_ARG_STRING, NULL, 'S', "Set the client signing state", "on|off|required" },
-	{"machine-pass", 'P', POPT_ARG_NONE, NULL, 'P', "Use stored machine account password" },
-	{"encrypt", 'e', POPT_ARG_NONE, NULL, 'e', "Encrypt SMB transport" },
-	{"use-ccache", 'C', POPT_ARG_NONE, NULL, 'C',
-	 "Use the winbind ccache for authentication" },
-	{"pw-nt-hash", '\0', POPT_ARG_NONE, NULL, 'H',
-	 "The supplied password is the NT hash" },
-	POPT_TABLEEND
-};
diff -Npur samba-4.8.7/source3/lib/popt_common_cmdline.c samba-4.8.8/source3/lib/popt_common_cmdline.c
--- samba-4.8.7/source3/lib/popt_common_cmdline.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/source3/lib/popt_common_cmdline.c	2018-12-13 10:08:40.000000000 +0100
@@ -0,0 +1,249 @@
+/*
+   Unix SMB/CIFS implementation.
+   Common popt routines only used by cmdline utils
+
+   Copyright (C) Tim Potter 2001,2002
+   Copyright (C) Jelmer Vernooij 2002,2003
+   Copyright (C) James Peach 2006
+   Copyright (C) Christof Schmitt 2018
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+/* Handle command line options:
+ *		-U,--user
+ *		-A,--authentication-file
+ *		-k,--use-kerberos
+ *		-N,--no-pass
+ *		-S,--signing
+ *		-P --machine-pass
+ *		-e --encrypt
+ *		-C --use-ccache
+ */
+
+#include "popt_common_cmdline.h"
+#include "includes.h"
+#include "auth_info.h"
+#include "cmdline_contexts.h"
+
+static struct user_auth_info *cmdline_auth_info;
+
+struct user_auth_info *popt_get_cmdline_auth_info(void)
+{
+	return cmdline_auth_info;
+}
+void popt_free_cmdline_auth_info(void)
+{
+	TALLOC_FREE(cmdline_auth_info);
+}
+
+static bool popt_common_credentials_ignore_missing_conf;
+static bool popt_common_credentials_delay_post;
+
+void popt_common_credentials_set_ignore_missing_conf(void)
+{
+	popt_common_credentials_delay_post = true;
+}
+
+void popt_common_credentials_set_delay_post(void)
+{
+	popt_common_credentials_delay_post = true;
+}
+
+void popt_common_credentials_post(void)
+{
+	if (get_cmdline_auth_info_use_machine_account(cmdline_auth_info) &&
+	    !set_cmdline_auth_info_machine_account_creds(cmdline_auth_info))
+	{
+		fprintf(stderr,
+			"Failed to use machine account credentials\n");
+		exit(1);
+	}
+
+	set_cmdline_auth_info_getpass(cmdline_auth_info);
+
+	/*
+	 * When we set the username during the handling of the options passed to
+	 * the binary we haven't loaded the config yet. This means that we
+	 * didn't take the 'winbind separator' into account.
+	 *
+	 * The username might contain the domain name and thus it hasn't been
+	 * correctly parsed yet. If we have a username we need to set it again
+	 * to run the string parser for the username correctly.
+	 */
+	reset_cmdline_auth_info_username(cmdline_auth_info);
+}
+
+static void popt_common_credentials_callback(poptContext con,
+					enum poptCallbackReason reason,
+					const struct poptOption *opt,
+					const char *arg, const void *data)
+{
+	if (reason == POPT_CALLBACK_REASON_PRE) {
+		struct user_auth_info *auth_info =
+				user_auth_info_init(NULL);
+		if (auth_info == NULL) {
+			fprintf(stderr, "user_auth_info_init() failed\n");
+			exit(1);
+		}
+		cmdline_auth_info = auth_info;
+		return;
+	}
+
+	if (reason == POPT_CALLBACK_REASON_POST) {
+		struct messaging_context *msg_ctx = NULL;
+		bool ok;
+
+		msg_ctx = cmdline_messaging_context(get_dyn_CONFIGFILE());
+		if (msg_ctx == NULL) {
+			fprintf(stderr, "Unable to initialize "
+				"messaging context\n");
+		}
+
+		ok = lp_load_client(get_dyn_CONFIGFILE());
+		if (!ok) {
+			const char *pname = poptGetInvocationName(con);
+
+			fprintf(stderr, "%s: Can't load %s - run testparm to debug it\n",
+				pname, get_dyn_CONFIGFILE());
+			if (!popt_common_credentials_ignore_missing_conf) {
+				exit(1);
+			}
+		}
+
+		load_interfaces();
+
+		set_cmdline_auth_info_guess(cmdline_auth_info);
+
+		if (popt_common_credentials_delay_post) {
+			return;
+		}
+
+		popt_common_credentials_post();
+		return;
+	}
+
+	switch(opt->val) {
+	case 'U':
+		set_cmdline_auth_info_username(cmdline_auth_info, arg);
+		break;
+
+	case 'A':
+		set_cmdline_auth_info_from_file(cmdline_auth_info, arg);
+		break;
+
+	case 'k':
+#ifndef HAVE_KRB5
+		d_printf("No kerberos support compiled in\n");
+		exit(1);
+#else
+		set_cmdline_auth_info_use_krb5_ticket(cmdline_auth_info);
+#endif
+		break;
+
+	case 'S':
+		if (!set_cmdline_auth_info_signing_state(cmdline_auth_info,
+				arg)) {
+			fprintf(stderr, "Unknown signing option %s\n", arg );
+			exit(1);
+		}
+		break;
+	case 'P':
+		set_cmdline_auth_info_use_machine_account(cmdline_auth_info);
+		break;
+	case 'N':
+		set_cmdline_auth_info_password(cmdline_auth_info, "");
+		break;
+	case 'e':
+		set_cmdline_auth_info_smb_encrypt(cmdline_auth_info);
+		break;
+	case 'C':
+		set_cmdline_auth_info_use_ccache(cmdline_auth_info, true);
+		break;
+	case 'H':
+		set_cmdline_auth_info_use_pw_nt_hash(cmdline_auth_info, true);
+		break;
+	}
+}
+
+/**
+ * @brief Burn the commandline password.
+ *
+ * This function removes the password from the command line so we
+ * don't leak the password e.g. in 'ps aux'.
+ *
+ * It should be called after processing the options and you should pass down
+ * argv from main().
+ *
+ * @param[in]  argc     The number of arguments.
+ *
+ * @param[in]  argv[]   The argument array we will find the array.
+ */
+void popt_burn_cmdline_password(int argc, char *argv[])
+{
+	bool found = false;
+	char *p = NULL;
+	int i, ulen = 0;
+
+	for (i = 0; i < argc; i++) {
+		p = argv[i];
+		if (strncmp(p, "-U", 2) == 0) {
+			ulen = 2;
+			found = true;
+		} else if (strncmp(p, "--user", 6) == 0) {
+			ulen = 6;
+			found = true;
+		}
+
+		if (found) {
+			if (p == NULL) {
+				return;
+			}
+
+			if (strlen(p) == ulen) {
+				continue;
+			}
+
+			p = strchr_m(p, '%');
+			if (p != NULL) {
+				memset(p, '\0', strlen(p));
+			}
+			found = false;
+		}
+	}
+}
+
+struct poptOption popt_common_credentials[] = {
+	{ NULL, 0, POPT_ARG_CALLBACK|POPT_CBFLAG_PRE|POPT_CBFLAG_POST,
+	  (void *)popt_common_credentials_callback, 0, NULL },
+	{ "user", 'U', POPT_ARG_STRING, NULL, 'U',
+	  "Set the network username", "USERNAME" },
+	{ "no-pass", 'N', POPT_ARG_NONE, NULL, 'N',
+	  "Don't ask for a password" },
+	{ "kerberos", 'k', POPT_ARG_NONE, NULL, 'k',
+	  "Use kerberos (active directory) authentication" },
+	{ "authentication-file", 'A', POPT_ARG_STRING, NULL, 'A',
+	  "Get the credentials from a file", "FILE" },
+	{ "signing", 'S', POPT_ARG_STRING, NULL, 'S',
+	  "Set the client signing state", "on|off|required" },
+	{"machine-pass", 'P', POPT_ARG_NONE, NULL, 'P',
+	 "Use stored machine account password" },
+	{"encrypt", 'e', POPT_ARG_NONE, NULL, 'e',
+	 "Encrypt SMB transport" },
+	{"use-ccache", 'C', POPT_ARG_NONE, NULL, 'C',
+	 "Use the winbind ccache for authentication" },
+	{"pw-nt-hash", '\0', POPT_ARG_NONE, NULL, 'H',
+	 "The supplied password is the NT hash" },
+	POPT_TABLEEND
+};
diff -Npur samba-4.8.7/source3/lib/server_contexts.c samba-4.8.8/source3/lib/server_contexts.c
--- samba-4.8.7/source3/lib/server_contexts.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/lib/server_contexts.c	2018-12-13 10:08:40.000000000 +0100
@@ -21,7 +21,7 @@
 #include "includes.h"
 #include "messages.h"
 
-struct tevent_context *server_event_ctx = NULL;
+static struct tevent_context *server_event_ctx = NULL;
 
 struct tevent_context *server_event_context(void)
 {
@@ -44,7 +44,7 @@ void server_event_context_free(void)
 	TALLOC_FREE(server_event_ctx);
 }
 
-struct messaging_context *server_msg_ctx = NULL;
+static struct messaging_context *server_msg_ctx = NULL;
 
 struct messaging_context *server_messaging_context(void)
 {
diff -Npur samba-4.8.7/source3/modules/vfs_delay_inject.c samba-4.8.8/source3/modules/vfs_delay_inject.c
--- samba-4.8.7/source3/modules/vfs_delay_inject.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/source3/modules/vfs_delay_inject.c	2018-12-13 10:08:40.000000000 +0100
@@ -19,6 +19,7 @@
 
 #include "includes.h"
 #include "smbd/smbd.h"
+#include "lib/util/tevent_unix.h"
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_VFS
@@ -46,8 +47,269 @@ static int vfs_delay_inject_ntimes(vfs_h
 	return SMB_VFS_NEXT_NTIMES(handle, smb_fname, ft);
 }
 
+struct vfs_delay_inject_pread_state {
+	struct tevent_context *ev;
+	struct vfs_handle_struct *handle;
+	struct files_struct *fsp;
+	void *data;
+	size_t n;
+	off_t offset;
+	ssize_t ret;
+	struct vfs_aio_state vfs_aio_state;
+};
+
+static void vfs_delay_inject_pread_wait_done(struct tevent_req *subreq);
+static void vfs_delay_inject_pread_done(struct tevent_req *subreq);
+
+static struct tevent_req *vfs_delay_inject_pread_send(
+				struct vfs_handle_struct *handle,
+				TALLOC_CTX *mem_ctx,
+				struct tevent_context *ev,
+				struct files_struct *fsp,
+				void *data,
+				size_t n,
+				off_t offset)
+{
+	struct tevent_req *req = NULL, *subreq = NULL;
+	struct vfs_delay_inject_pread_state *state = NULL;
+	int delay;
+	struct timeval delay_tv;
+
+	delay = lp_parm_int(
+		SNUM(handle->conn), "delay_inject", "pread_send", 0);
+	delay_tv = tevent_timeval_current_ofs(delay / 1000,
+					      (delay * 1000) % 1000000);
+
+	req = tevent_req_create(mem_ctx, &state,
+				struct vfs_delay_inject_pread_state);
+	if (req == NULL) {
+		return NULL;
+	}
+	*state = (struct vfs_delay_inject_pread_state) {
+		.ev = ev,
+		.handle = handle,
+		.fsp = fsp,
+		.data = data,
+		.n = n,
+		.offset = offset,
+	};
+
+	if (delay == 0) {
+		subreq = SMB_VFS_NEXT_PREAD_SEND(state,
+						 state->ev,
+						 state->handle,
+						 state->fsp,
+						 state->data,
+						 state->n,
+						 state->offset);
+		if (tevent_req_nomem(subreq, req)) {
+			return tevent_req_post(req, ev);
+		}
+		tevent_req_set_callback(subreq,
+					vfs_delay_inject_pread_done,
+					req);
+		return req;
+	}
+
+	subreq = tevent_wakeup_send(state, ev, delay_tv);
+	if (tevent_req_nomem(subreq, req)) {
+		return tevent_req_post(req, ev);
+	}
+	tevent_req_set_callback(subreq, vfs_delay_inject_pread_wait_done, req);
+	return req;
+}
+
+
+static void vfs_delay_inject_pread_wait_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req = tevent_req_callback_data(
+		subreq, struct tevent_req);
+	struct vfs_delay_inject_pread_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pread_state);
+	bool ok;
+
+	ok = tevent_wakeup_recv(subreq);
+	TALLOC_FREE(subreq);
+	if (!ok) {
+		tevent_req_error(req, EIO);
+		return;
+	}
+
+	subreq = SMB_VFS_NEXT_PREAD_SEND(state,
+					 state->ev,
+					 state->handle,
+					 state->fsp,
+					 state->data,
+					 state->n,
+					 state->offset);
+	if (tevent_req_nomem(subreq, req)) {
+		return;
+	}
+	tevent_req_set_callback(subreq, vfs_delay_inject_pread_done, req);
+}
+
+static void vfs_delay_inject_pread_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req = tevent_req_callback_data(
+		subreq, struct tevent_req);
+	struct vfs_delay_inject_pread_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pread_state);
+
+	state->ret = SMB_VFS_PREAD_RECV(subreq, &state->vfs_aio_state);
+	TALLOC_FREE(subreq);
+
+	tevent_req_done(req);
+}
+
+static ssize_t vfs_delay_inject_pread_recv(struct tevent_req *req,
+				struct vfs_aio_state *vfs_aio_state)
+{
+	struct vfs_delay_inject_pread_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pread_state);
+
+	if (tevent_req_is_unix_error(req, &vfs_aio_state->error)) {
+		return -1;
+	}
+
+	*vfs_aio_state = state->vfs_aio_state;
+	return state->ret;
+}
+
+struct vfs_delay_inject_pwrite_state {
+	struct tevent_context *ev;
+	struct vfs_handle_struct *handle;
+	struct files_struct *fsp;
+	const void *data;
+	size_t n;
+	off_t offset;
+	ssize_t ret;
+	struct vfs_aio_state vfs_aio_state;
+};
+
+static void vfs_delay_inject_pwrite_wait_done(struct tevent_req *subreq);
+static void vfs_delay_inject_pwrite_done(struct tevent_req *subreq);
+
+static struct tevent_req *vfs_delay_inject_pwrite_send(
+				struct vfs_handle_struct *handle,
+				TALLOC_CTX *mem_ctx,
+				struct tevent_context *ev,
+				struct files_struct *fsp,
+				const void *data,
+				size_t n,
+				off_t offset)
+{
+	struct tevent_req *req = NULL, *subreq = NULL;
+	struct vfs_delay_inject_pwrite_state *state = NULL;
+	int delay;
+	struct timeval delay_tv;
+
+	delay = lp_parm_int(
+		SNUM(handle->conn), "delay_inject", "pwrite_send", 0);
+	delay_tv = tevent_timeval_current_ofs(delay / 1000,
+					      (delay * 1000) % 1000000);
+
+	req = tevent_req_create(mem_ctx, &state,
+				struct vfs_delay_inject_pwrite_state);
+	if (req == NULL) {
+		return NULL;
+	}
+	*state = (struct vfs_delay_inject_pwrite_state) {
+		.ev = ev,
+		.handle = handle,
+		.fsp = fsp,
+		.data = data,
+		.n = n,
+		.offset = offset,
+	};
+
+	if (delay == 0) {
+		subreq = SMB_VFS_NEXT_PWRITE_SEND(state,
+						 state->ev,
+						 state->handle,
+						 state->fsp,
+						 state->data,
+						 state->n,
+						 state->offset);
+		if (tevent_req_nomem(subreq, req)) {
+			return tevent_req_post(req, ev);
+		}
+		tevent_req_set_callback(subreq,
+					vfs_delay_inject_pwrite_done,
+					req);
+		return req;
+	}
+
+	subreq = tevent_wakeup_send(state, ev, delay_tv);
+	if (tevent_req_nomem(subreq, req)) {
+		return tevent_req_post(req, ev);
+	}
+	tevent_req_set_callback(
+		subreq, vfs_delay_inject_pwrite_wait_done, req);
+	return req;
+}
+
+
+static void vfs_delay_inject_pwrite_wait_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req = tevent_req_callback_data(
+		subreq, struct tevent_req);
+	struct vfs_delay_inject_pwrite_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pwrite_state);
+	bool ok;
+
+	ok = tevent_wakeup_recv(subreq);
+	TALLOC_FREE(subreq);
+	if (!ok) {
+		tevent_req_error(req, EIO);
+		return;
+	}
+
+	subreq = SMB_VFS_NEXT_PWRITE_SEND(state,
+					 state->ev,
+					 state->handle,
+					 state->fsp,
+					 state->data,
+					 state->n,
+					 state->offset);
+	if (tevent_req_nomem(subreq, req)) {
+		return;
+	}
+	tevent_req_set_callback(subreq, vfs_delay_inject_pwrite_done, req);
+}
+
+static void vfs_delay_inject_pwrite_done(struct tevent_req *subreq)
+{
+	struct tevent_req *req = tevent_req_callback_data(
+		subreq, struct tevent_req);
+	struct vfs_delay_inject_pwrite_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pwrite_state);
+
+	state->ret = SMB_VFS_PWRITE_RECV(subreq, &state->vfs_aio_state);
+	TALLOC_FREE(subreq);
+
+	tevent_req_done(req);
+}
+
+static ssize_t vfs_delay_inject_pwrite_recv(struct tevent_req *req,
+				struct vfs_aio_state *vfs_aio_state)
+{
+	struct vfs_delay_inject_pwrite_state *state = tevent_req_data(
+		req, struct vfs_delay_inject_pwrite_state);
+
+	if (tevent_req_is_unix_error(req, &vfs_aio_state->error)) {
+		return -1;
+	}
+
+	*vfs_aio_state = state->vfs_aio_state;
+	return state->ret;
+}
+
 static struct vfs_fn_pointers vfs_delay_inject_fns = {
 	.ntimes_fn = vfs_delay_inject_ntimes,
+	.pread_send_fn = vfs_delay_inject_pread_send,
+	.pread_recv_fn = vfs_delay_inject_pread_recv,
+	.pwrite_send_fn = vfs_delay_inject_pwrite_send,
+	.pwrite_recv_fn = vfs_delay_inject_pwrite_recv,
 };
 
 static_decl_vfs;
diff -Npur samba-4.8.7/source3/modules/vfs_fruit.c samba-4.8.8/source3/modules/vfs_fruit.c
--- samba-4.8.7/source3/modules/vfs_fruit.c	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source3/modules/vfs_fruit.c	2018-12-13 10:08:40.000000000 +0100
@@ -142,6 +142,8 @@ struct fruit_config_data {
 	const char *model;
 	bool time_machine;
 	off_t time_machine_max_size;
+	bool wipe_intentionally_left_blank_rfork;
+	bool delete_empty_adfiles;
 
 	/*
 	 * Additional options, all enabled by default,
@@ -262,6 +264,7 @@ typedef enum {ADOUBLE_META, ADOUBLE_RSRC
 #define ADEDLEN_VERSION     4
 #define ADEDLEN_FILLER      16
 #define AD_FILLER_TAG       "Netatalk        " /* should be 16 bytes */
+#define AD_FILLER_TAG_OSX   "Mac OS X        " /* should be 16 bytes */
 #define ADEDLEN_NENTRIES    2
 #define AD_HEADER_LEN       (ADEDLEN_MAGIC + ADEDLEN_VERSION + \
 			     ADEDLEN_FILLER + ADEDLEN_NENTRIES) /* 26 */
@@ -414,6 +417,7 @@ struct adouble {
 	adouble_type_t            ad_type;
 	uint32_t                  ad_magic;
 	uint32_t                  ad_version;
+	uint8_t                   ad_filler[ADEDLEN_FILLER];
 	struct ad_entry           ad_eid[ADEID_MAX];
 	char                     *ad_data;
 	struct ad_xattr_header    adx_header;
@@ -465,12 +469,65 @@ static const uint32_t set_eid[] = {
 	AD_DEV, AD_INO, AD_SYN, AD_ID
 };
 
+static char empty_resourcefork[] = {
+	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E,
+	0x54, 0x68, 0x69, 0x73, 0x20, 0x72, 0x65, 0x73,
+	0x6F, 0x75, 0x72, 0x63, 0x65, 0x20, 0x66, 0x6F,
+	0x72, 0x6B, 0x20, 0x69, 0x6E, 0x74, 0x65, 0x6E,
+	0x74, 0x69, 0x6F, 0x6E, 0x61, 0x6C, 0x6C, 0x79,
+	0x20, 0x6C, 0x65, 0x66, 0x74, 0x20, 0x62, 0x6C,
+	0x61, 0x6E, 0x6B, 0x20, 0x20, 0x20, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x1C, 0x00, 0x1E, 0xFF, 0xFF
+};
+
 struct fio {
 	/* tcon config handle */
 	struct fruit_config_data *config;
 
 	/* Denote stream type, meta or rsrc */
 	adouble_type_t type;
+
+	/* Whether the create created the stream */
+	bool created;
+
+	/*
+	 * AFP_AfpInfo stream created, but not written yet, thus still a fake
+	 * pipe fd. This is set to true in fruit_open_meta if there was no
+	 * exisiting stream but the caller requested O_CREAT. It is later set to
+	 * false when we get a write on the stream that then does open and
+	 * create the stream.
+	 */
+	bool fake_fd;
+	int flags;
+	int mode;
 };
 
 /*
@@ -837,6 +894,8 @@ static bool ad_unpack(struct adouble *ad
 		return false;
 	}
 
+	memcpy(ad->ad_filler, ad->ad_data + ADEDOFF_FILLER, ADEDLEN_FILLER);
+
 	adentries = RSVAL(ad->ad_data, ADEDOFF_NENTRIES);
 	if (adentries != nentries) {
 		DEBUG(1, ("invalid number of entries: %zu\n",
@@ -938,16 +997,75 @@ static bool ad_unpack(struct adouble *ad
 	return true;
 }
 
+static bool ad_convert_move_reso(struct adouble *ad,
+				 const struct smb_filename *smb_fname)
+{
+	char *map = MAP_FAILED;
+	size_t maplen;
+	ssize_t len;
+	int rc;
+	bool ok;
+
+	if (ad_getentrylen(ad, ADEID_RFORK) == 0) {
+		return true;
+	}
+
+	maplen = ad_getentryoff(ad, ADEID_RFORK) +
+		ad_getentrylen(ad, ADEID_RFORK);
+
+	/* FIXME: direct use of mmap(), vfs_aio_fork does it too */
+	map = mmap(NULL, maplen, PROT_READ|PROT_WRITE, MAP_SHARED,
+		   ad->ad_fd, 0);
+	if (map == MAP_FAILED) {
+		DBG_ERR("mmap AppleDouble: %s\n", strerror(errno));
+		return false;
+	}
+
+
+	memmove(map + ADEDOFF_RFORK_DOT_UND,
+		map + ad_getentryoff(ad, ADEID_RFORK),
+		ad_getentrylen(ad, ADEID_RFORK));
+
+	rc = munmap(map, maplen);
+	if (rc != 0) {
+		DBG_ERR("munmap failed: %s\n", strerror(errno));
+		return false;
+	}
+
+	ad_setentryoff(ad, ADEID_RFORK, ADEDOFF_RFORK_DOT_UND);
+
+	ok = ad_pack(ad);
+	if (!ok) {
+		DBG_WARNING("ad_pack [%s] failed\n", smb_fname->base_name);
+		return false;
+	}
+
+	len = sys_pwrite(ad->ad_fd, ad->ad_data, AD_DATASZ_DOT_UND, 0);
+	if (len != AD_DATASZ_DOT_UND) {
+		DBG_ERR("%s: bad size: %zd\n", smb_fname->base_name, len);
+		return false;
+	}
+
+	return true;
+}
+
 static bool ad_convert_xattr(struct adouble *ad,
 			     const struct smb_filename *smb_fname,
-			     char *map)
+			     bool *converted_xattr)
 {
 	static struct char_mappings **string_replace_cmaps = NULL;
+	char *map = MAP_FAILED;
+	size_t maplen;
 	uint16_t i;
+	ssize_t len;
 	int saved_errno = 0;
 	NTSTATUS status;
+	int rc;
+	bool ok;
 
-	if (ad->adx_header.adx_num_attrs == 0) {
+	*converted_xattr = false;
+
+	if (ad_getentrylen(ad, ADEID_FINDERI) == ADEDLEN_FINDERI) {
 		return true;
 	}
 
@@ -963,6 +1081,17 @@ static bool ad_convert_xattr(struct adou
 		TALLOC_FREE(mappings);
 	}
 
+	maplen = ad_getentryoff(ad, ADEID_RFORK) +
+		ad_getentrylen(ad, ADEID_RFORK);
+
+	/* FIXME: direct use of mmap(), vfs_aio_fork does it too */
+	map = mmap(NULL, maplen, PROT_READ|PROT_WRITE, MAP_SHARED,
+		   ad->ad_fd, 0);
+	if (map == MAP_FAILED) {
+		DBG_ERR("mmap AppleDouble: %s\n", strerror(errno));
+		return false;
+	}
+
 	for (i = 0; i < ad->adx_header.adx_num_attrs; i++) {
 		struct ad_xattr_entry *e = &ad->adx_entries[i];
 		char *mapped_name = NULL;
@@ -981,14 +1110,16 @@ static bool ad_convert_xattr(struct adou
 		    !NT_STATUS_EQUAL(status, NT_STATUS_NONE_MAPPED))
 		{
 			DBG_ERR("string_replace_allocate failed\n");
-			return -1;
+			ok = false;
+			goto fail;
 		}
 
 		tmp = mapped_name;
 		mapped_name = talloc_asprintf(talloc_tos(), ":%s", tmp);
 		TALLOC_FREE(tmp);
 		if (mapped_name == NULL) {
-			return -1;
+			ok = false;
+			goto fail;
 		}
 
 		stream_name = synthetic_smb_fname(talloc_tos(),
@@ -999,7 +1130,8 @@ static bool ad_convert_xattr(struct adou
 		TALLOC_FREE(mapped_name);
 		if (stream_name == NULL) {
 			DBG_ERR("synthetic_smb_fname failed\n");
-			return -1;
+			ok = false;
+			goto fail;
 		}
 
 		DBG_DEBUG("stream_name: %s\n", smb_fname_str_dbg(stream_name));
@@ -1026,7 +1158,8 @@ static bool ad_convert_xattr(struct adou
 		TALLOC_FREE(stream_name);
 		if (!NT_STATUS_IS_OK(status)) {
 			DBG_ERR("SMB_VFS_CREATE_FILE failed\n");
-			return -1;
+			ok = false;
+			goto fail;
 		}
 
 		nwritten = SMB_VFS_PWRITE(fsp,
@@ -1038,16 +1171,269 @@ static bool ad_convert_xattr(struct adou
 			saved_errno = errno;
 			close_file(NULL, fsp, ERROR_CLOSE);
 			errno = saved_errno;
-			return -1;
+			ok = false;
+			goto fail;
 		}
 
 		status = close_file(NULL, fsp, NORMAL_CLOSE);
 		if (!NT_STATUS_IS_OK(status)) {
-			return -1;
+			ok = false;
+			goto fail;
 		}
 		fsp = NULL;
 	}
 
+	ad_setentrylen(ad, ADEID_FINDERI, ADEDLEN_FINDERI);
+
+	ok = ad_pack(ad);
+	if (!ok) {
+		DBG_WARNING("ad_pack [%s] failed\n", smb_fname->base_name);
+		goto fail;
+	}
+
+	len = sys_pwrite(ad->ad_fd, ad->ad_data, AD_DATASZ_DOT_UND, 0);
+	if (len != AD_DATASZ_DOT_UND) {
+		DBG_ERR("%s: bad size: %zd\n", smb_fname->base_name, len);
+		ok = false;
+		goto fail;
+	}
+
+	ok = ad_convert_move_reso(ad, smb_fname);
+	if (!ok) {
+		goto fail;
+	}
+
+	*converted_xattr = true;
+	ok = true;
+
+fail:
+	rc = munmap(map, maplen);
+	if (rc != 0) {
+		DBG_ERR("munmap failed: %s\n", strerror(errno));
+		return false;
+	}
+
+	return ok;
+}
+
+static bool ad_convert_finderinfo(struct adouble *ad,
+				  const struct smb_filename *smb_fname)
+{
+	char *p_ad = NULL;
+	AfpInfo *ai = NULL;
+	DATA_BLOB aiblob;
+	struct smb_filename *stream_name = NULL;
+	files_struct *fsp = NULL;
+	size_t size;
+	ssize_t nwritten;
+	NTSTATUS status;
+	int saved_errno = 0;
+	int cmp;
+
+	cmp = memcmp(ad->ad_filler, AD_FILLER_TAG_OSX, ADEDLEN_FILLER);
+	if (cmp != 0) {
+		return true;
+	}
+
+	p_ad = ad_get_entry(ad, ADEID_FINDERI);
+	if (p_ad == NULL) {
+		return false;
+	}
+
+	ai = afpinfo_new(talloc_tos());
+	if (ai == NULL) {
+		return false;
+	}
+
+	memcpy(ai->afpi_FinderInfo, p_ad, ADEDLEN_FINDERI);
+
+	aiblob = data_blob_talloc(talloc_tos(), NULL, AFP_INFO_SIZE);
+	if (aiblob.data == NULL) {
+		TALLOC_FREE(ai);
+		return false;
+	}
+
+	size = afpinfo_pack(ai, (char *)aiblob.data);
+	TALLOC_FREE(ai);
+	if (size != AFP_INFO_SIZE) {
+		return false;
+	}
+
+	stream_name = synthetic_smb_fname(talloc_tos(),
+					  smb_fname->base_name,
+					  AFPINFO_STREAM,
+					  NULL,
+					  smb_fname->flags);
+	if (stream_name == NULL) {
+		data_blob_free(&aiblob);
+		DBG_ERR("synthetic_smb_fname failed\n");
+		return false;
+	}
+
+	DBG_DEBUG("stream_name: %s\n", smb_fname_str_dbg(stream_name));
+
+	status = SMB_VFS_CREATE_FILE(
+		ad->ad_handle->conn,		/* conn */
+		NULL,				/* req */
+		0,				/* root_dir_fid */
+		stream_name,			/* fname */
+		FILE_GENERIC_WRITE,		/* access_mask */
+		FILE_SHARE_READ | FILE_SHARE_WRITE, /* share_access */
+		FILE_OPEN_IF,			/* create_disposition */
+		0,				/* create_options */
+		0,				/* file_attributes */
+		INTERNAL_OPEN_ONLY,		/* oplock_request */
+		NULL,				/* lease */
+		0,				/* allocation_size */
+		0,				/* private_flags */
+		NULL,				/* sd */
+		NULL,				/* ea_list */
+		&fsp,				/* result */
+		NULL,				/* psbuf */
+		NULL, NULL);			/* create context */
+	TALLOC_FREE(stream_name);
+	if (!NT_STATUS_IS_OK(status)) {
+		DBG_ERR("SMB_VFS_CREATE_FILE failed\n");
+		return false;
+	}
+
+	nwritten = SMB_VFS_PWRITE(fsp,
+				  aiblob.data,
+				  aiblob.length,
+				  0);
+	if (nwritten == -1) {
+		DBG_ERR("SMB_VFS_PWRITE failed\n");
+		saved_errno = errno;
+		close_file(NULL, fsp, ERROR_CLOSE);
+		errno = saved_errno;
+		return false;
+	}
+
+	status = close_file(NULL, fsp, NORMAL_CLOSE);
+	if (!NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+	fsp = NULL;
+
+	return true;
+}
+
+static bool ad_convert_truncate(struct adouble *ad,
+				const struct smb_filename *smb_fname)
+{
+	int rc;
+
+	/*
+	 * FIXME: direct ftruncate(), but we don't have a fsp for the
+	 * VFS call
+	 */
+	rc = ftruncate(ad->ad_fd, ADEDOFF_RFORK_DOT_UND +
+		       ad_getentrylen(ad, ADEID_RFORK));
+	if (rc != 0) {
+		return false;
+	}
+
+	return true;
+}
+
+static bool ad_convert_blank_rfork(struct adouble *ad,
+				   bool *blank)
+{
+	struct fruit_config_data *config = NULL;
+	uint8_t *map = MAP_FAILED;
+	size_t maplen;
+	int cmp;
+	ssize_t len;
+	int rc;
+	bool ok;
+
+	*blank = false;
+
+	SMB_VFS_HANDLE_GET_DATA(ad->ad_handle, config,
+				struct fruit_config_data, return false);
+
+	if (!config->wipe_intentionally_left_blank_rfork) {
+		return true;
+	}
+
+	if (ad_getentrylen(ad, ADEID_RFORK) != sizeof(empty_resourcefork)) {
+		return true;
+	}
+
+	maplen = ad_getentryoff(ad, ADEID_RFORK) +
+		ad_getentrylen(ad, ADEID_RFORK);
+
+	/* FIXME: direct use of mmap(), vfs_aio_fork does it too */
+	map = mmap(NULL, maplen, PROT_READ|PROT_WRITE, MAP_SHARED,
+		   ad->ad_fd, 0);
+	if (map == MAP_FAILED) {
+		DBG_ERR("mmap AppleDouble: %s\n", strerror(errno));
+		return false;
+	}
+
+	cmp = memcmp(map + ADEDOFF_RFORK_DOT_UND,
+		     empty_resourcefork,
+		     sizeof(empty_resourcefork));
+	rc = munmap(map, maplen);
+	if (rc != 0) {
+		DBG_ERR("munmap failed: %s\n", strerror(errno));
+		return false;
+	}
+
+	if (cmp != 0) {
+		return true;
+	}
+
+	ad_setentrylen(ad, ADEID_RFORK, 0);
+
+	ok = ad_pack(ad);
+	if (!ok) {
+		return false;
+	}
+
+	len = sys_pwrite(ad->ad_fd, ad->ad_data, AD_DATASZ_DOT_UND, 0);
+	if (len != AD_DATASZ_DOT_UND) {
+		return false;
+	}
+
+	*blank = true;
+	return true;
+}
+
+static bool ad_convert_delete_adfile(struct adouble *ad,
+				     const struct smb_filename *smb_fname)
+{
+	struct fruit_config_data *config = NULL;
+	struct smb_filename *ad_name = NULL;
+	int rc;
+
+	if (ad_getentrylen(ad, ADEID_RFORK) > 0) {
+		return true;
+	}
+
+	SMB_VFS_HANDLE_GET_DATA(ad->ad_handle, config,
+				struct fruit_config_data, return false);
+
+	if (!config->delete_empty_adfiles) {
+		return true;
+	}
+
+	rc = adouble_path(talloc_tos(), smb_fname, &ad_name);
+	if (rc != 0) {
+		return false;
+	}
+
+	rc = SMB_VFS_NEXT_UNLINK(ad->ad_handle, ad_name);
+	if (rc != 0) {
+		DBG_ERR("Unlinking [%s] failed: %s\n",
+			smb_fname_str_dbg(ad_name), strerror(errno));
+		TALLOC_FREE(ad_name);
+		return false;
+	}
+
+	DBG_WARNING("Unlinked [%s] after conversion\n", smb_fname_str_dbg(ad_name));
+	TALLOC_FREE(ad_name);
+
 	return true;
 }
 
@@ -1055,60 +1441,48 @@ static bool ad_convert_xattr(struct adou
  * Convert from Apple's ._ file to Netatalk
  *
  * Apple's AppleDouble may contain a FinderInfo entry longer then 32
- * bytes containing packed xattrs. Netatalk can't deal with that, so
- * we simply discard the packed xattrs.
+ * bytes containing packed xattrs.
  *
  * @return -1 in case an error occurred, 0 if no conversion was done, 1
  * otherwise
  **/
 static int ad_convert(struct adouble *ad,
-		      const struct smb_filename *smb_fname,
-		      int fd)
+		      const struct smb_filename *smb_fname)
 {
-	int rc = 0;
-	char *map = MAP_FAILED;
-	size_t origlen;
 	bool ok;
+	bool converted_xattr = false;
+	bool blank;
 
-	origlen = ad_getentryoff(ad, ADEID_RFORK) +
-		ad_getentrylen(ad, ADEID_RFORK);
-
-	/* FIXME: direct use of mmap(), vfs_aio_fork does it too */
-	map = mmap(NULL, origlen, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
-	if (map == MAP_FAILED) {
-		DEBUG(2, ("mmap AppleDouble: %s\n", strerror(errno)));
-		rc = -1;
-		goto exit;
+	ok = ad_convert_xattr(ad, smb_fname, &converted_xattr);
+	if (!ok) {
+		return -1;
 	}
 
-	ok = ad_convert_xattr(ad, smb_fname, map);
+	ok = ad_convert_blank_rfork(ad, &blank);
 	if (!ok) {
-		munmap(map, origlen);
 		return -1;
 	}
 
-	if (ad_getentrylen(ad, ADEID_RFORK) > 0) {
-		memmove(map + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI,
-			map + ad_getentryoff(ad, ADEID_RFORK),
-			ad_getentrylen(ad, ADEID_RFORK));
+	if (converted_xattr || blank) {
+		ok = ad_convert_truncate(ad, smb_fname);
+		if (!ok) {
+			return -1;
+		}
 	}
 
-	ad_setentrylen(ad, ADEID_FINDERI, ADEDLEN_FINDERI);
-	ad_setentryoff(ad, ADEID_RFORK,
-		       ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI);
-
-	/*
-	 * FIXME: direct ftruncate(), but we don't have a fsp for the
-	 * VFS call
-	 */
-	rc = ftruncate(fd, ad_getentryoff(ad, ADEID_RFORK)
-		       + ad_getentrylen(ad, ADEID_RFORK));
+	ok = ad_convert_finderinfo(ad, smb_fname);
+	if (!ok) {
+		DBG_ERR("Failed to convert [%s]\n",
+			smb_fname_str_dbg(smb_fname));
+		return -1;
+	}
 
-exit:
-	if (map != MAP_FAILED) {
-		munmap(map, origlen);
+	ok = ad_convert_delete_adfile(ad, smb_fname);
+	if (!ok) {
+		return -1;
 	}
-	return rc;
+
+	return 0;
 }
 
 /**
@@ -1304,15 +1678,8 @@ static ssize_t ad_read_rsrc_adouble(stru
 {
 	SMB_STRUCT_STAT sbuf;
 	char *p_ad = NULL;
-	AfpInfo *ai = NULL;
-	DATA_BLOB aiblob;
-	struct smb_filename *stream_name = NULL;
-	files_struct *fsp = NULL;
-	ssize_t len;
 	size_t size;
-	ssize_t nwritten;
-	NTSTATUS status;
-	int saved_errno = 0;
+	ssize_t len;
 	int ret;
 	bool ok;
 
@@ -1368,115 +1735,17 @@ static ssize_t ad_read_rsrc_adouble(stru
 		return -1;
 	}
 
-	if (ad_getentrylen(ad, ADEID_FINDERI) == ADEDLEN_FINDERI) {
-		return len;
-	}
-
 	/*
 	 * Try to fixup AppleDouble files created by OS X with xattrs
-	 * appended to the ADEID_FINDERI entry. We simply remove the
-	 * xattrs blob, this means any fancy xattr that was stored
-	 * there is lost.
+	 * appended to the ADEID_FINDERI entry.
 	 */
 
-	ret = ad_convert(ad, smb_fname, ad->ad_fd);
+	ret = ad_convert(ad, smb_fname);
 	if (ret != 0) {
 		DBG_WARNING("Failed to convert [%s]\n", smb_fname->base_name);
 		return len;
 	}
 
-	ok = ad_pack(ad);
-	if (!ok) {
-		DBG_WARNING("ad_pack [%s] failed\n", smb_fname->base_name);
-		return -1;
-	}
-
-	len = sys_pwrite(ad->ad_fd, ad->ad_data, AD_DATASZ_DOT_UND, 0);
-	if (len != AD_DATASZ_DOT_UND) {
-		DBG_ERR("%s: bad size: %zd\n", smb_fname->base_name, len);
-		return -1;
-	}
-
-	p_ad = ad_get_entry(ad, ADEID_FINDERI);
-	if (p_ad == NULL) {
-		return -1;
-	}
-
-	ai = afpinfo_new(talloc_tos());
-	if (ai == NULL) {
-		return -1;
-	}
-
-	memcpy(ai->afpi_FinderInfo, p_ad, ADEDLEN_FINDERI);
-
-	aiblob = data_blob_talloc(talloc_tos(), NULL, AFP_INFO_SIZE);
-	if (aiblob.data == NULL) {
-		TALLOC_FREE(ai);
-		return -1;
-	}
-
-	size = afpinfo_pack(ai, (char *)aiblob.data);
-	TALLOC_FREE(ai);
-	if (size != AFP_INFO_SIZE) {
-		return -1;
-	}
-
-	stream_name = synthetic_smb_fname(talloc_tos(),
-					  smb_fname->base_name,
-					  AFPINFO_STREAM,
-					  NULL,
-					  smb_fname->flags);
-	if (stream_name == NULL) {
-		data_blob_free(&aiblob);
-		DBG_ERR("synthetic_smb_fname failed\n");
-		return -1;
-	}
-
-	DBG_DEBUG("stream_name: %s\n", smb_fname_str_dbg(stream_name));
-
-	status = SMB_VFS_CREATE_FILE(
-		ad->ad_handle->conn,		/* conn */
-		NULL,				/* req */
-		0,				/* root_dir_fid */
-		stream_name,			/* fname */
-		FILE_GENERIC_WRITE,		/* access_mask */
-		FILE_SHARE_READ | FILE_SHARE_WRITE, /* share_access */
-		FILE_OPEN_IF,			/* create_disposition */
-		0,				/* create_options */
-		0,				/* file_attributes */
-		INTERNAL_OPEN_ONLY,		/* oplock_request */
-		NULL,				/* lease */
-		0,				/* allocation_size */
-		0,				/* private_flags */
-		NULL,				/* sd */
-		NULL,				/* ea_list */
-		&fsp,				/* result */
-		NULL,				/* psbuf */
-		NULL, NULL);			/* create context */
-	TALLOC_FREE(stream_name);
-	if (!NT_STATUS_IS_OK(status)) {
-		DBG_ERR("SMB_VFS_CREATE_FILE failed\n");
-		return -1;
-	}
-
-	nwritten = SMB_VFS_PWRITE(fsp,
-				  aiblob.data,
-				  aiblob.length,
-				  0);
-	if (nwritten == -1) {
-		DBG_ERR("SMB_VFS_PWRITE failed\n");
-		saved_errno = errno;
-		close_file(NULL, fsp, ERROR_CLOSE);
-		errno = saved_errno;
-		return -1;
-	}
-
-	status = close_file(NULL, fsp, NORMAL_CLOSE);
-	if (!NT_STATUS_IS_OK(status)) {
-		return -1;
-	}
-	fsp = NULL;
-
 	return len;
 }
 
@@ -1992,6 +2261,14 @@ static int init_fruit_config(vfs_handle_
 		config->time_machine_max_size = conv_str_size(tm_size_str);
 	}
 
+	config->wipe_intentionally_left_blank_rfork = lp_parm_bool(
+		SNUM(handle->conn), FRUIT_PARAM_TYPE_NAME,
+		"wipe_intentionally_left_blank_rfork", false);
+
+	config->delete_empty_adfiles = lp_parm_bool(
+		SNUM(handle->conn), FRUIT_PARAM_TYPE_NAME,
+		"delete_empty_adfiles", false);
+
 	SMB_VFS_HANDLE_SET_DATA(handle, config,
 				NULL, struct fruit_config_data,
 				return -1);
@@ -2111,6 +2388,10 @@ static SMB_INO_T fruit_inode(const SMB_S
 	SMB_INO_T result;
 	char *upper_sname;
 
+	DBG_DEBUG("fruit_inode called for %ju/%ju [%s]\n",
+		  (uintmax_t)sbuf->st_ex_dev,
+		  (uintmax_t)sbuf->st_ex_ino, sname);
+
 	upper_sname = talloc_strdup_upper(talloc_tos(), sname);
 	SMB_ASSERT(upper_sname != NULL);
 
@@ -2128,8 +2409,8 @@ static SMB_INO_T fruit_inode(const SMB_S
 	/* Hopefully all the variation is in the lower 4 (or 8) bytes! */
 	memcpy(&result, hash, sizeof(result));
 
-	DEBUG(10, ("fruit_inode \"%s\": ino=0x%llu\n",
-		   sname, (unsigned long long)result));
+	DBG_DEBUG("fruit_inode \"%s\": ino=%ju\n",
+		  sname, (uintmax_t)result);
 
 	return result;
 }
@@ -3122,66 +3403,68 @@ static int fruit_connect(vfs_handle_stru
 	return rc;
 }
 
+static int fruit_fake_fd(void)
+{
+	int pipe_fds[2];
+	int fd;
+	int ret;
+
+	/*
+	 * Return a valid fd, but ensure any attempt to use it returns
+	 * an error (EPIPE). Once we get a write on the handle, we open
+	 * the real fd.
+	 */
+	ret = pipe(pipe_fds);
+	if (ret != 0) {
+		return -1;
+	}
+	fd = pipe_fds[0];
+	close(pipe_fds[1]);
+
+	return fd;
+}
+
 static int fruit_open_meta_stream(vfs_handle_struct *handle,
 				  struct smb_filename *smb_fname,
 				  files_struct *fsp,
 				  int flags,
 				  mode_t mode)
 {
-	AfpInfo *ai = NULL;
-	char afpinfo_buf[AFP_INFO_SIZE];
-	ssize_t len, written;
-	int hostfd = -1;
-	int rc = -1;
+	struct fruit_config_data *config = NULL;
+	struct fio *fio = NULL;
+	int open_flags = flags & ~O_CREAT;
+	int fd;
 
-	hostfd = SMB_VFS_NEXT_OPEN(handle, smb_fname, fsp, flags, mode);
-	if (hostfd == -1) {
-		return -1;
-	}
+	DBG_DEBUG("Path [%s]\n", smb_fname_str_dbg(smb_fname));
 
-	if (!(flags & (O_CREAT | O_TRUNC))) {
-		return hostfd;
-	}
+	SMB_VFS_HANDLE_GET_DATA(handle, config,
+				struct fruit_config_data, return -1);
 
-	ai = afpinfo_new(talloc_tos());
-	if (ai == NULL) {
-		rc = -1;
-		goto fail;
-	}
+	fio = VFS_ADD_FSP_EXTENSION(handle, fsp, struct fio, NULL);
+	fio->type = ADOUBLE_META;
+	fio->config = config;
 
-	len = afpinfo_pack(ai, afpinfo_buf);
-	if (len != AFP_INFO_SIZE) {
-		rc = -1;
-		goto fail;
+	fd = SMB_VFS_NEXT_OPEN(handle, smb_fname, fsp, open_flags, mode);
+	if (fd != -1) {
+		return fd;
 	}
 
-	/* Set fd, needed in SMB_VFS_NEXT_PWRITE() */
-	fsp->fh->fd = hostfd;
-
-	written = SMB_VFS_NEXT_PWRITE(handle, fsp, afpinfo_buf,
-				      AFP_INFO_SIZE, 0);
-	fsp->fh->fd = -1;
-	if (written != AFP_INFO_SIZE) {
-		DBG_ERR("bad write [%zd/%d]\n", written, AFP_INFO_SIZE);
-		rc = -1;
-		goto fail;
+	if (!(flags & O_CREAT)) {
+		VFS_REMOVE_FSP_EXTENSION(handle, fsp);
+		return -1;
 	}
 
-	rc = 0;
+	fd = fruit_fake_fd();
+	if (fd == -1) {
+		VFS_REMOVE_FSP_EXTENSION(handle, fsp);
+		return -1;
+	}
 
-fail:
-	DBG_DEBUG("rc=%d, fd=%d\n", rc, hostfd);
+	fio->fake_fd = true;
+	fio->flags = flags;
+	fio->mode = mode;
 
-	if (rc != 0) {
-		int saved_errno = errno;
-		if (hostfd >= 0) {
-			fsp->fh->fd = hostfd;
-			SMB_VFS_NEXT_CLOSE(handle, fsp);
-		}
-		hostfd = -1;
-		errno = saved_errno;
-	}
-	return hostfd;
+	return fd;
 }
 
 static int fruit_open_meta_netatalk(vfs_handle_struct *handle,
@@ -3190,56 +3473,42 @@ static int fruit_open_meta_netatalk(vfs_
 				    int flags,
 				    mode_t mode)
 {
-	int rc;
-	int fakefd = -1;
+	struct fruit_config_data *config = NULL;
+	struct fio *fio = NULL;
 	struct adouble *ad = NULL;
-	int fds[2];
+	bool meta_exists = false;
+	int fd;
 
 	DBG_DEBUG("Path [%s]\n", smb_fname_str_dbg(smb_fname));
 
-	/*
-	 * Return a valid fd, but ensure any attempt to use it returns an error
-	 * (EPIPE). All operations on the smb_fname or the fsp will use path
-	 * based syscalls.
-	 */
-	rc = pipe(fds);
-	if (rc != 0) {
-		goto exit;
+	ad = ad_get(talloc_tos(), handle, smb_fname, ADOUBLE_META);
+	if (ad != NULL) {
+		meta_exists = true;
 	}
-	fakefd = fds[0];
-	close(fds[1]);
-
-	if (flags & (O_CREAT | O_TRUNC)) {
-		/*
-		 * The attribute does not exist or needs to be truncated,
-		 * create an AppleDouble EA
-		 */
-		ad = ad_init(fsp, handle, ADOUBLE_META);
-		if (ad == NULL) {
-			rc = -1;
-			goto exit;
-		}
 
-		rc = ad_set(ad, fsp->fsp_name);
-		if (rc != 0) {
-			rc = -1;
-			goto exit;
-		}
+	TALLOC_FREE(ad);
 
-		TALLOC_FREE(ad);
+	if (!meta_exists && !(flags & O_CREAT)) {
+		errno = ENOENT;
+		return -1;
 	}
 
-exit:
-	DEBUG(10, ("fruit_open meta rc=%d, fd=%d\n", rc, fakefd));
-	if (rc != 0) {
-		int saved_errno = errno;
-		if (fakefd >= 0) {
-			close(fakefd);
-		}
-		fakefd = -1;
-		errno = saved_errno;
+	fd = fruit_fake_fd();
+	if (fd == -1) {
+		return -1;
 	}
-	return fakefd;
+
+	SMB_VFS_HANDLE_GET_DATA(handle, config,
+				struct fruit_config_data, return -1);
+
+	fio = VFS_ADD_FSP_EXTENSION(handle, fsp, struct fio, NULL);
+	fio->type = ADOUBLE_META;
+	fio->config = config;
+	fio->fake_fd = true;
+	fio->flags = flags;
+	fio->mode = mode;
+
+	return fd;
 }
 
 static int fruit_open_meta(vfs_handle_struct *handle,
@@ -3248,7 +3517,6 @@ static int fruit_open_meta(vfs_handle_st
 {
 	int fd;
 	struct fruit_config_data *config = NULL;
-	struct fio *fio = NULL;
 
 	DBG_DEBUG("path [%s]\n", smb_fname_str_dbg(smb_fname));
 
@@ -3273,14 +3541,6 @@ static int fruit_open_meta(vfs_handle_st
 
 	DBG_DEBUG("path [%s] fd [%d]\n", smb_fname_str_dbg(smb_fname), fd);
 
-	if (fd == -1) {
-		return -1;
-	}
-
-	fio = VFS_ADD_FSP_EXTENSION(handle, fsp, struct fio, NULL);
-	fio->type = ADOUBLE_META;
-	fio->config = config;
-
 	return fd;
 }
 
@@ -3312,12 +3572,9 @@ static int fruit_open_rsrc_adouble(vfs_h
 		goto exit;
 	}
 
-	/* Sanitize flags */
-	if (flags & O_WRONLY) {
-		/* We always need read access for the metadata header too */
-		flags &= ~O_WRONLY;
-		flags |= O_RDWR;
-	}
+	/* We always need read/write access for the metadata header too */
+	flags &= ~(O_RDONLY | O_WRONLY);
+	flags |= O_RDWR;
 
 	hostfd = SMB_VFS_NEXT_OPEN(handle, smb_fname_base, fsp,
 				   flags, mode);
@@ -3404,20 +3661,6 @@ static int fruit_open_rsrc(vfs_handle_st
 	SMB_VFS_HANDLE_GET_DATA(handle, config,
 				struct fruit_config_data, return -1);
 
-	if (((flags & O_ACCMODE) == O_RDONLY)
-	    && (flags & O_CREAT)
-	    && !VALID_STAT(fsp->fsp_name->st))
-	{
-		/*
-		 * This means the stream doesn't exist. macOS SMB server fails
-		 * this with NT_STATUS_OBJECT_NAME_NOT_FOUND, so must we. Cf bug
-		 * 12565 and the test for this combination in
-		 * test_rfork_create().
-		 */
-		errno = ENOENT;
-		return -1;
-	}
-
 	switch (config->rsrc) {
 	case FRUIT_RSRC_STREAM:
 		fd = SMB_VFS_NEXT_OPEN(handle, smb_fname, fsp, flags, mode);
@@ -3930,8 +4173,7 @@ static ssize_t fruit_pread_meta_stream(v
 	int ret;
 
 	nread = SMB_VFS_NEXT_PREAD(handle, fsp, data, n, offset);
-
-	if (nread == n) {
+	if (nread == -1 || nread == n) {
 		return nread;
 	}
 
@@ -4030,6 +4272,25 @@ static ssize_t fruit_pread_meta(vfs_hand
 		return -1;
 	}
 
+	if (nread == -1 && fio->created) {
+		AfpInfo *ai = NULL;
+		char afpinfo_buf[AFP_INFO_SIZE];
+
+		ai = afpinfo_new(talloc_tos());
+		if (ai == NULL) {
+			return -1;
+		}
+
+		nread = afpinfo_pack(ai, afpinfo_buf);
+		TALLOC_FREE(ai);
+		if (nread != AFP_INFO_SIZE) {
+			return -1;
+		}
+
+		memcpy(data, afpinfo_buf, to_return);
+		return to_return;
+	}
+
 	return nread;
 }
 
@@ -4124,9 +4385,7 @@ static bool fruit_must_handle_aio_stream
 		return false;
 	};
 
-	if ((fio->type == ADOUBLE_META) &&
-	    (fio->config->meta == FRUIT_META_NETATALK))
-	{
+	if (fio->type == ADOUBLE_META) {
 		return true;
 	}
 
@@ -4221,32 +4480,78 @@ static ssize_t fruit_pwrite_meta_stream(
 					files_struct *fsp, const void *data,
 					size_t n, off_t offset)
 {
+	struct fio *fio = (struct fio *)VFS_FETCH_FSP_EXTENSION(handle, fsp);
 	AfpInfo *ai = NULL;
 	size_t nwritten;
+	int ret;
 	bool ok;
 
-	ai = afpinfo_unpack(talloc_tos(), data);
-	if (ai == NULL) {
+	DBG_DEBUG("Path [%s] offset=%"PRIdMAX", size=%zd\n",
+		  fsp_str_dbg(fsp), (intmax_t)offset, n);
+
+	if (fio == NULL) {
 		return -1;
 	}
 
-	nwritten = SMB_VFS_NEXT_PWRITE(handle, fsp, data, n, offset);
-	if (nwritten != n) {
-		return -1;
+	if (fio->fake_fd) {
+		int fd;
+
+		ret = SMB_VFS_NEXT_CLOSE(handle, fsp);
+		if (ret != 0) {
+			DBG_ERR("Close [%s] failed: %s\n",
+				fsp_str_dbg(fsp), strerror(errno));
+			fsp->fh->fd = -1;
+			return -1;
+		}
+
+		fd = SMB_VFS_NEXT_OPEN(handle,
+				       fsp->fsp_name,
+				       fsp,
+				       fio->flags,
+				       fio->mode);
+		if (fd == -1) {
+			DBG_ERR("On-demand create [%s] in write failed: %s\n",
+				fsp_str_dbg(fsp), strerror(errno));
+			return -1;
+		}
+		fsp->fh->fd = fd;
+		fio->fake_fd = false;
 	}
 
-	if (!ai_empty_finderinfo(ai)) {
-		return n;
+	ai = afpinfo_unpack(talloc_tos(), data);
+	if (ai == NULL) {
+		return -1;
 	}
 
-	ok = set_delete_on_close(
+	if (ai_empty_finderinfo(ai)) {
+		/*
+		 * Writing an all 0 blob to the metadata stream results in the
+		 * stream being removed on a macOS server. This ensures we
+		 * behave the same and it verified by the "delete AFP_AfpInfo by
+		 * writing all 0" test.
+		 */
+		ret = SMB_VFS_NEXT_FTRUNCATE(handle, fsp, 0);
+		if (ret != 0) {
+			DBG_ERR("SMB_VFS_NEXT_FTRUNCATE on [%s] failed\n",
+				fsp_str_dbg(fsp));
+			return -1;
+		}
+
+		ok = set_delete_on_close(
 			fsp,
 			true,
 			handle->conn->session_info->security_token,
 			handle->conn->session_info->unix_token);
-	if (!ok) {
-		DBG_ERR("set_delete_on_close on [%s] failed\n",
-			fsp_str_dbg(fsp));
+		if (!ok) {
+			DBG_ERR("set_delete_on_close on [%s] failed\n",
+				fsp_str_dbg(fsp));
+			return -1;
+		}
+		return n;
+	}
+
+	nwritten = SMB_VFS_NEXT_PWRITE(handle, fsp, data, n, offset);
+	if (nwritten != n) {
 		return -1;
 	}
 
@@ -4297,6 +4602,12 @@ static ssize_t fruit_pwrite_meta_netatal
 		return n;
 	}
 
+	/*
+	 * Writing an all 0 blob to the metadata stream results in the stream
+	 * being removed on a macOS server. This ensures we behave the same and
+	 * it verified by the "delete AFP_AfpInfo by writing all 0" test.
+	 */
+
 	ok = set_delete_on_close(
 		fsp,
 		true,
@@ -4317,29 +4628,62 @@ static ssize_t fruit_pwrite_meta(vfs_han
 {
 	struct fio *fio = (struct fio *)VFS_FETCH_FSP_EXTENSION(handle, fsp);
 	ssize_t nwritten;
+	uint8_t buf[AFP_INFO_SIZE];
+	size_t to_write;
+	size_t to_copy;
+	int cmp;
 
-	/*
-	 * Writing an all 0 blob to the metadata stream
-	 * results in the stream being removed on a macOS
-	 * server. This ensures we behave the same and it
-	 * verified by the "delete AFP_AfpInfo by writing all
-	 * 0" test.
-	 */
-	if (n != AFP_INFO_SIZE || offset != 0) {
-		DBG_ERR("unexpected offset=%jd or size=%jd\n",
-			(intmax_t)offset, (intmax_t)n);
+	if (n < 3) {
+		errno = EINVAL;
 		return -1;
 	}
 
+	if (offset != 0 && n < 60) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	cmp = memcmp(data, "AFP", 3);
+	if (cmp != 0) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	if (n <= AFP_OFF_FinderInfo) {
+		/*
+		 * Nothing to do here really, just return
+		 */
+		return n;
+	}
+
+	offset = 0;
+
+	to_copy = n;
+	if (to_copy > AFP_INFO_SIZE) {
+		to_copy = AFP_INFO_SIZE;
+	}
+	memcpy(buf, data, to_copy);
+
+	to_write = n;
+	if (to_write != AFP_INFO_SIZE) {
+		to_write = AFP_INFO_SIZE;
+	}
+
 	switch (fio->config->meta) {
 	case FRUIT_META_STREAM:
-		nwritten = fruit_pwrite_meta_stream(handle, fsp, data,
-						    n, offset);
+		nwritten = fruit_pwrite_meta_stream(handle,
+						    fsp,
+						    buf,
+						    to_write,
+						    offset);
 		break;
 
 	case FRUIT_META_NETATALK:
-		nwritten = fruit_pwrite_meta_netatalk(handle, fsp, data,
-						      n, offset);
+		nwritten = fruit_pwrite_meta_netatalk(handle,
+						      fsp,
+						      buf,
+						      to_write,
+						      offset);
 		break;
 
 	default:
@@ -4347,7 +4691,14 @@ static ssize_t fruit_pwrite_meta(vfs_han
 		return -1;
 	}
 
-	return nwritten;
+	if (nwritten != to_write) {
+		return -1;
+	}
+
+	/*
+	 * Return the requested amount, verified against macOS SMB server
+	 */
+	return n;
 }
 
 static ssize_t fruit_pwrite_rsrc_stream(vfs_handle_struct *handle,
@@ -4549,6 +4900,11 @@ static int fruit_stat_base(vfs_handle_st
 		rc = SMB_VFS_NEXT_LSTAT(handle, smb_fname);
 	}
 	smb_fname->stream_name = tmp_stream_name;
+
+	DBG_DEBUG("fruit_stat_base [%s] dev [%ju] ino [%ju]\n",
+		  smb_fname->base_name,
+		  (uintmax_t)smb_fname->st.st_ex_dev,
+		  (uintmax_t)smb_fname->st.st_ex_ino);
 	return rc;
 }
 
@@ -4557,6 +4913,14 @@ static int fruit_stat_meta_stream(vfs_ha
 				  bool follow_links)
 {
 	int ret;
+	ino_t ino;
+
+	ret = fruit_stat_base(handle, smb_fname, false);
+	if (ret != 0) {
+		return -1;
+	}
+
+	ino = fruit_inode(&smb_fname->st, smb_fname->stream_name);
 
 	if (follow_links) {
 		ret = SMB_VFS_NEXT_STAT(handle, smb_fname);
@@ -4564,6 +4928,8 @@ static int fruit_stat_meta_stream(vfs_ha
 		ret = SMB_VFS_NEXT_LSTAT(handle, smb_fname);
 	}
 
+	smb_fname->st.st_ex_ino = ino;
+
 	return ret;
 }
 
@@ -4817,7 +5183,41 @@ static int fruit_fstat_meta_stream(vfs_h
 				   files_struct *fsp,
 				   SMB_STRUCT_STAT *sbuf)
 {
-	return SMB_VFS_NEXT_FSTAT(handle, fsp, sbuf);
+	struct fio *fio = (struct fio *)VFS_FETCH_FSP_EXTENSION(handle, fsp);
+	ino_t ino;
+	int ret;
+
+	if (fio == NULL) {
+		return -1;
+	}
+
+	if (fio->fake_fd) {
+		ret = fruit_stat_base(handle, fsp->base_fsp->fsp_name, false);
+		if (ret != 0) {
+			return -1;
+		}
+
+		*sbuf = fsp->base_fsp->fsp_name->st;
+		sbuf->st_ex_size = AFP_INFO_SIZE;
+		sbuf->st_ex_ino = fruit_inode(sbuf, fsp->fsp_name->stream_name);
+		return 0;
+	}
+
+	ret = fruit_stat_base(handle, fsp->base_fsp->fsp_name, false);
+	if (ret != 0) {
+		return -1;
+	}
+	*sbuf = fsp->base_fsp->fsp_name->st;
+
+	ino = fruit_inode(sbuf, fsp->fsp_name->stream_name);
+
+	ret = SMB_VFS_NEXT_FSTAT(handle, fsp, sbuf);
+	if (ret != 0) {
+		return -1;
+	}
+
+	sbuf->st_ex_ino = ino;
+	return 0;
 }
 
 static int fruit_fstat_meta_netatalk(vfs_handle_struct *handle,
@@ -4969,7 +5369,8 @@ static NTSTATUS delete_invalid_meta_stre
 	const struct smb_filename *smb_fname,
 	TALLOC_CTX *mem_ctx,
 	unsigned int *pnum_streams,
-	struct stream_struct **pstreams)
+	struct stream_struct **pstreams,
+	off_t size)
 {
 	struct smb_filename *sname = NULL;
 	int ret;
@@ -4980,6 +5381,10 @@ static NTSTATUS delete_invalid_meta_stre
 		return NT_STATUS_INTERNAL_ERROR;
 	}
 
+	if (size == 0) {
+		return NT_STATUS_OK;
+	}
+
 	sname = synthetic_smb_fname(talloc_tos(),
 				    smb_fname->base_name,
 				    AFPINFO_STREAM_NAME,
@@ -5008,16 +5413,7 @@ static NTSTATUS fruit_streaminfo_meta_st
 {
 	struct stream_struct *stream = *pstreams;
 	unsigned int num_streams = *pnum_streams;
-	struct smb_filename *sname = NULL;
-	char *full_name = NULL;
-	uint32_t name_hash;
-	struct share_mode_lock *lck = NULL;
-	struct file_id id = {0};
-	bool delete_on_close_set;
 	int i;
-	int ret;
-	NTSTATUS status;
-	bool ok;
 
 	for (i = 0; i < num_streams; i++) {
 		if (strequal_m(stream[i].name, AFPINFO_STREAM)) {
@@ -5033,72 +5429,16 @@ static NTSTATUS fruit_streaminfo_meta_st
 		DBG_ERR("Removing invalid AFPINFO_STREAM size [%jd] from [%s]\n",
 			(intmax_t)stream[i].size, smb_fname_str_dbg(smb_fname));
 
-		return delete_invalid_meta_stream(handle, smb_fname, mem_ctx,
-						  pnum_streams, pstreams);
-	}
-
-	/*
-	 * Now check if there's a delete-on-close pending on the stream. If so,
-	 * hide the stream. This behaviour was verified against a macOS 10.12
-	 * SMB server.
-	 */
-
-	sname = synthetic_smb_fname(talloc_tos(),
-				    smb_fname->base_name,
-				    AFPINFO_STREAM_NAME,
-				    NULL, 0);
-	if (sname == NULL) {
-		status = NT_STATUS_NO_MEMORY;
-		goto out;
+		return delete_invalid_meta_stream(handle,
+						  smb_fname,
+						  mem_ctx,
+						  pnum_streams,
+						  pstreams,
+						  stream[i].size);
 	}
 
-	ret = SMB_VFS_NEXT_STAT(handle, sname);
-	if (ret != 0) {
-		status = map_nt_error_from_unix(errno);
-		goto out;
-	}
 
-	id = SMB_VFS_NEXT_FILE_ID_CREATE(handle, &sname->st);
-
-	lck = get_existing_share_mode_lock(talloc_tos(), id);
-	if (lck == NULL) {
-		status = NT_STATUS_OK;
-		goto out;
-	}
-
-	full_name = talloc_asprintf(talloc_tos(),
-				    "%s%s",
-				    sname->base_name,
-				    AFPINFO_STREAM);
-	if (full_name == NULL) {
-		status = NT_STATUS_NO_MEMORY;
-		goto out;
-	}
-
-	status = file_name_hash(handle->conn, full_name, &name_hash);
-	if (!NT_STATUS_IS_OK(status)) {
-		goto out;
-	}
-
-	delete_on_close_set = is_delete_on_close_set(lck, name_hash);
-	if (delete_on_close_set) {
-		ok = del_fruit_stream(mem_ctx,
-				      pnum_streams,
-				      pstreams,
-				      AFPINFO_STREAM);
-		if (!ok) {
-			status = NT_STATUS_INTERNAL_ERROR;
-			goto out;
-		}
-	}
-
-	status  = NT_STATUS_OK;
-
-out:
-	TALLOC_FREE(sname);
-	TALLOC_FREE(lck);
-	TALLOC_FREE(full_name);
-	return status;
+	return NT_STATUS_OK;
 }
 
 static NTSTATUS fruit_streaminfo_meta_netatalk(
@@ -5332,6 +5672,36 @@ static NTSTATUS fruit_streaminfo_rsrc(vf
 	return status;
 }
 
+static void fruit_filter_empty_streams(unsigned int *pnum_streams,
+				       struct stream_struct **pstreams)
+{
+	unsigned num_streams = *pnum_streams;
+	struct stream_struct *streams = *pstreams;
+	unsigned i = 0;
+
+	if (!global_fruit_config.nego_aapl) {
+		return;
+	}
+
+	while (i < num_streams) {
+		struct smb_filename smb_fname = (struct smb_filename) {
+			.stream_name = streams[i].name,
+		};
+
+		if (is_ntfs_default_stream_smb_fname(&smb_fname)
+		    || streams[i].size > 0)
+		{
+			i++;
+			continue;
+		}
+
+		streams[i] = streams[num_streams - 1];
+		num_streams--;
+	}
+
+	*pnum_streams = num_streams;
+}
+
 static NTSTATUS fruit_streaminfo(vfs_handle_struct *handle,
 				 struct files_struct *fsp,
 				 const struct smb_filename *smb_fname,
@@ -5353,6 +5723,8 @@ static NTSTATUS fruit_streaminfo(vfs_han
 		return status;
 	}
 
+	fruit_filter_empty_streams(pnum_streams, pstreams);
+
 	status = fruit_streaminfo_meta(handle, fsp, smb_fname,
 				       mem_ctx, pnum_streams, pstreams);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -5429,10 +5801,6 @@ static int fruit_ftruncate_rsrc_xattr(st
 				      struct files_struct *fsp,
 				      off_t offset)
 {
-	if (offset == 0) {
-		return SMB_VFS_FREMOVEXATTR(fsp, AFPRESOURCE_EA_NETATALK);
-	}
-
 #ifdef HAVE_ATTROPEN
 	return SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset);
 #endif
@@ -5480,10 +5848,6 @@ static int fruit_ftruncate_rsrc_stream(s
 				       struct files_struct *fsp,
 				       off_t offset)
 {
-	if (offset == 0) {
-		return SMB_VFS_NEXT_UNLINK(handle, fsp->fsp_name);
-	}
-
 	return SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset);
 }
 
@@ -5545,13 +5909,6 @@ static int fruit_ftruncate(struct vfs_ha
 		  (intmax_t)offset);
 
 	if (fio == NULL) {
-		if (offset == 0 &&
-		    global_fruit_config.nego_aapl &&
-		    is_ntfs_stream_smb_fname(fsp->fsp_name) &&
-		    !is_ntfs_default_stream_smb_fname(fsp->fsp_name))
-		{
-			return SMB_VFS_NEXT_UNLINK(handle, fsp->fsp_name);
-		}
 		return SMB_VFS_NEXT_FTRUNCATE(handle, fsp, offset);
 	}
 
@@ -5588,6 +5945,7 @@ static NTSTATUS fruit_create_file(vfs_ha
 	NTSTATUS status;
 	struct fruit_config_data *config = NULL;
 	files_struct *fsp = NULL;
+	struct fio *fio = NULL;
 
 	status = check_aapl(handle, req, in_context_blobs, out_context_blobs);
 	if (!NT_STATUS_IS_OK(status)) {
@@ -5628,13 +5986,19 @@ static NTSTATUS fruit_create_file(vfs_ha
 	 *
 	 * Cf the vfs_fruit torture tests in test_rfork_create().
 	 */
-	if (is_afpresource_stream(fsp->fsp_name) &&
-	    create_disposition == FILE_OPEN)
+	if (global_fruit_config.nego_aapl &&
+	    create_disposition == FILE_OPEN &&
+	    smb_fname->st.st_ex_size == 0 &&
+	    is_ntfs_stream_smb_fname(smb_fname) &&
+	    !(is_ntfs_default_stream_smb_fname(smb_fname)))
 	{
-		if (fsp->fsp_name->st.st_ex_size == 0) {
-			status = NT_STATUS_OBJECT_NAME_NOT_FOUND;
-			goto fail;
-		}
+		status = NT_STATUS_OBJECT_NAME_NOT_FOUND;
+		goto fail;
+	}
+
+	fio = (struct fio *)VFS_FETCH_FSP_EXTENSION(handle, fsp);
+	if (fio != NULL && pinfo != NULL && *pinfo == FILE_WAS_CREATED) {
+		fio->created = true;
 	}
 
 	if (is_ntfs_stream_smb_fname(smb_fname)
diff -Npur samba-4.8.7/source3/modules/vfs_streams_xattr.c samba-4.8.8/source3/modules/vfs_streams_xattr.c
--- samba-4.8.7/source3/modules/vfs_streams_xattr.c	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source3/modules/vfs_streams_xattr.c	2018-12-13 10:08:40.000000000 +0100
@@ -407,6 +407,7 @@ static int streams_xattr_open(vfs_handle
 	char *xattr_name = NULL;
 	int pipe_fds[2];
 	int fakefd = -1;
+	bool set_empty_xattr = false;
 	int ret;
 
 	SMB_VFS_HANDLE_GET_DATA(handle, config, struct streams_xattr_config,
@@ -440,39 +441,37 @@ static int streams_xattr_open(vfs_handle
 		goto fail;
 	}
 
-	/*
-	 * Return a valid fd, but ensure any attempt to use it returns an error
-	 * (EPIPE).
-	 */
-	ret = pipe(pipe_fds);
-	if (ret != 0) {
-		goto fail;
-	}
-
-	close(pipe_fds[1]);
-	pipe_fds[1] = -1;
-	fakefd = pipe_fds[0];
-
 	status = get_ea_value(talloc_tos(), handle->conn, NULL,
 			      smb_fname, xattr_name, &ea);
 
 	DEBUG(10, ("get_ea_value returned %s\n", nt_errstr(status)));
 
-	if (!NT_STATUS_IS_OK(status)
-	    && !NT_STATUS_EQUAL(status, NT_STATUS_NOT_FOUND)) {
-		/*
-		 * The base file is not there. This is an error even if we got
-		 * O_CREAT, the higher levels should have created the base
-		 * file for us.
-		 */
-		DEBUG(10, ("streams_xattr_open: base file %s not around, "
-			   "returning ENOENT\n", smb_fname->base_name));
-		errno = ENOENT;
-		goto fail;
+	if (!NT_STATUS_IS_OK(status)) {
+		if (!NT_STATUS_EQUAL(status, NT_STATUS_NOT_FOUND)) {
+			/*
+			 * The base file is not there. This is an error even if
+			 * we got O_CREAT, the higher levels should have created
+			 * the base file for us.
+			 */
+			DBG_DEBUG("streams_xattr_open: base file %s not around, "
+				  "returning ENOENT\n", smb_fname->base_name);
+			errno = ENOENT;
+			goto fail;
+		}
+
+		if (!(flags & O_CREAT)) {
+			errno = ENOATTR;
+			goto fail;
+		}
+
+		set_empty_xattr = true;
+	}
+
+	if (flags & O_TRUNC) {
+		set_empty_xattr = true;
 	}
 
-	if ((!NT_STATUS_IS_OK(status) && (flags & O_CREAT)) ||
-	    (flags & O_TRUNC)) {
+	if (set_empty_xattr) {
 		/*
 		 * The attribute does not exist or needs to be truncated
 		 */
@@ -495,6 +494,19 @@ static int streams_xattr_open(vfs_handle
 		}
 	}
 
+	/*
+	 * Return a valid fd, but ensure any attempt to use it returns an error
+	 * (EPIPE).
+	 */
+	ret = pipe(pipe_fds);
+	if (ret != 0) {
+		goto fail;
+	}
+
+	close(pipe_fds[1]);
+	pipe_fds[1] = -1;
+	fakefd = pipe_fds[0];
+
         sio = VFS_ADD_FSP_EXTENSION(handle, fsp, struct stream_io, NULL);
         if (sio == NULL) {
                 errno = ENOMEM;
diff -Npur samba-4.8.7/source3/modules/vfs_zfsacl.c samba-4.8.8/source3/modules/vfs_zfsacl.c
--- samba-4.8.7/source3/modules/vfs_zfsacl.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/modules/vfs_zfsacl.c	2018-12-13 10:08:40.000000000 +0100
@@ -238,7 +238,20 @@ static NTSTATUS zfsacl_fget_nt_acl(struc
 				       fsp->fsp_name, &pacl);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(frame);
-		return status;
+		if (!NT_STATUS_EQUAL(status, NT_STATUS_NOT_SUPPORTED)) {
+			return status;
+		}
+
+		status = make_default_filesystem_acl(mem_ctx,
+						     DEFAULT_ACL_POSIX,
+						     fsp->fsp_name->base_name,
+						     &fsp->fsp_name->st,
+						     ppdesc);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+		(*ppdesc)->type |= SEC_DESC_DACL_PROTECTED;
+		return NT_STATUS_OK;
 	}
 
 	status = smb_fget_nt_acl_nfs4(fsp, NULL, security_info, mem_ctx,
@@ -260,7 +273,26 @@ static NTSTATUS zfsacl_get_nt_acl(struct
 	status = zfs_get_nt_acl_common(handle->conn, frame, smb_fname, &pacl);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(frame);
-		return status;
+		if (!NT_STATUS_EQUAL(status, NT_STATUS_NOT_SUPPORTED)) {
+			return status;
+		}
+
+		if (!VALID_STAT(smb_fname->st)) {
+			DBG_ERR("No stat info for [%s]\n",
+				smb_fname_str_dbg(smb_fname));
+			return NT_STATUS_INTERNAL_ERROR;
+		}
+
+		status = make_default_filesystem_acl(mem_ctx,
+						     DEFAULT_ACL_POSIX,
+						     smb_fname->base_name,
+						     &smb_fname->st,
+						     ppdesc);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+		(*ppdesc)->type |= SEC_DESC_DACL_PROTECTED;
+		return NT_STATUS_OK;
 	}
 
 	status = smb_get_nt_acl_nfs4(handle->conn,
diff -Npur samba-4.8.7/source3/param/loadparm.c samba-4.8.8/source3/param/loadparm.c
--- samba-4.8.7/source3/param/loadparm.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/param/loadparm.c	2018-12-13 10:08:40.000000000 +0100
@@ -4116,7 +4116,7 @@ bool lp_load_with_registry_shares(const
 			  false, /* global_only */
 			  true,  /* save_defaults */
 			  false, /* add_ipc */
-			  false, /* reinit_globals */
+			  true, /* reinit_globals */
 			  true,  /* allow_include_registry */
 			  true); /* load_all_shares*/
 }
diff -Npur samba-4.8.7/source3/rpcclient/cmd_spoolss.c samba-4.8.8/source3/rpcclient/cmd_spoolss.c
--- samba-4.8.7/source3/rpcclient/cmd_spoolss.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/rpcclient/cmd_spoolss.c	2018-12-13 10:08:40.000000000 +0100
@@ -33,7 +33,7 @@
 #include "../libcli/security/security_descriptor.h"
 #include "../libcli/registry/util_reg.h"
 #include "libsmb/libsmb.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 
 #define RPCCLIENT_PRINTERNAME(_printername, _cli, _arg) \
 { \
diff -Npur samba-4.8.7/source3/rpcclient/rpcclient.c samba-4.8.8/source3/rpcclient/rpcclient.c
--- samba-4.8.7/source3/rpcclient/rpcclient.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/rpcclient/rpcclient.c	2018-12-13 10:08:40.000000000 +0100
@@ -21,7 +21,7 @@
 
 #include "includes.h"
 #include "../libcli/auth/netlogon_creds_cli.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "rpcclient.h"
 #include "../libcli/auth/libcli_auth.h"
 #include "../librpc/gen_ndr/ndr_lsa_c.h"
@@ -35,6 +35,7 @@
 #include "auth/gensec/gensec.h"
 #include "../libcli/smb/smbXcli_base.h"
 #include "messages.h"
+#include "cmdline_contexts.h"
 
 enum pipe_auth_type_spnego {
 	PIPE_AUTH_TYPE_SPNEGO_NONE = 0,
@@ -950,7 +951,6 @@ out_free:
 	const char *binding_string = NULL;
 	const char *host;
 	int signing_state = SMB_SIGNING_IPC_DEFAULT;
-	struct tevent_context *ev_ctx = NULL;
 
 	/* make sure the vars that get altered (4th field) are in
 	   a fixed location or certain compilers complain */
@@ -1016,30 +1016,7 @@ out_free:
 	poptFreeContext(pc);
 	popt_burn_cmdline_password(argc, argv);
 
-	ev_ctx = samba_tevent_context_init(frame);
-	if (ev_ctx == NULL) {
-		fprintf(stderr, "Could not init event context\n");
-		result = 1;
-		goto done;
-	}
-
-	nt_status = messaging_init_client(ev_ctx,
-					  ev_ctx,
-					  &rpcclient_msg_ctx);
-	if (geteuid() != 0 &&
-			NT_STATUS_EQUAL(nt_status, NT_STATUS_ACCESS_DENIED)) {
-		/*
-		 * Normal to fail to initialize messaging context
-		 * if we're not root as we don't have ability to
-		 * read lock directory.
-		 */
-		DBG_NOTICE("Unable to initialize messaging context. "
-			"Must be root to do that.\n");
-	} else if (!NT_STATUS_IS_OK(nt_status)) {
-		fprintf(stderr, "Could not init messaging context\n");
-		result = 1;
-		goto done;
-	}
+	rpcclient_msg_ctx = cmdline_messaging_context(get_dyn_CONFIGFILE());
 
 	if (!init_names()) {
 		result = 1;
@@ -1258,7 +1235,6 @@ done:
 	popt_free_cmdline_auth_info();
 	netlogon_creds_cli_close_global_db();
 	TALLOC_FREE(rpcclient_msg_ctx);
-	TALLOC_FREE(ev_ctx);
 	TALLOC_FREE(frame);
 	return result;
 }
diff -Npur samba-4.8.7/source3/rpcclient/wscript_build samba-4.8.8/source3/rpcclient/wscript_build
--- samba-4.8.7/source3/rpcclient/wscript_build	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/rpcclient/wscript_build	2018-12-13 10:08:40.000000000 +0100
@@ -25,7 +25,7 @@ bld.SAMBA3_BINARY('rpcclient',
 		 ''',
                  deps='''
                  talloc
-                 popt_samba3
+                 popt_samba3_cmdline
                  pdb
                  libsmb
                  smbconf
diff -Npur samba-4.8.7/source3/selftest/tests.py samba-4.8.8/source3/selftest/tests.py
--- samba-4.8.7/source3/selftest/tests.py	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source3/selftest/tests.py	2018-12-13 10:08:40.000000000 +0100
@@ -418,7 +418,14 @@ nbt = ["nbt.dgram" ]
 
 libsmbclient = ["libsmbclient"]
 
-vfs = ["vfs.fruit", "vfs.acl_xattr", "vfs.fruit_netatalk", "vfs.fruit_file_id", "vfs.fruit_timemachine"]
+vfs = [
+    "vfs.fruit",
+    "vfs.acl_xattr",
+    "vfs.fruit_netatalk",
+    "vfs.fruit_file_id",
+    "vfs.fruit_timemachine",
+    "vfs.fruit_conversion",
+]
 
 tests= base + raw + smb2 + rpc + unix + local + rap + nbt + libsmbclient + idmap + vfs
 
@@ -453,11 +460,17 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "simpleserver", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
-    elif t == "raw.session" or t == "smb2.session":
+    elif t == "raw.session":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD', 'plain')
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmpenc -U$USERNAME%$PASSWORD', 'enc')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -k no -U$USERNAME%$PASSWORD', 'ntlm')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -k yes -U$USERNAME%$PASSWORD', 'krb5')
+    elif t == "smb2.session":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD', 'plain')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmpenc -U$USERNAME%$PASSWORD', 'enc')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -k no -U$USERNAME%$PASSWORD', 'ntlm')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -k yes -U$USERNAME%$PASSWORD', 'krb5')
+        plansmbtorture4testsuite(t, "ad_member", '//$SERVER/tmp -k yes -U$DC_USERNAME@$REALM%$DC_PASSWORD', 'krb5')
     elif t == "rpc.lsa":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD', 'over ncacn_np ')
         plansmbtorture4testsuite(t, "nt4_dc", 'ncacn_ip_tcp:$SERVER_IP -U$USERNAME%$PASSWORD', 'over ncacn_ip_tcp ')
@@ -527,6 +540,9 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_timemachine -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
     elif t == "vfs.fruit_file_id":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit -U$USERNAME%$PASSWORD')
+    elif t == "vfs.fruit_conversion":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD --option=torture:share2=vfs_fruit_wipe_intentionally_left_blank_rfork --option=torture:delete_empty_adfiles=false', 'wipe_intentionally_left_blank_rfork')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD --option=torture:share2=vfs_fruit_delete_empty_adfiles --option=torture:delete_empty_adfiles=true', 'delete_empty_adfiles')
     elif t == "rpc.schannel_anon_setpw":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$%', description="anonymous password set")
         plansmbtorture4testsuite(t, "nt4_dc_schannel", '//$SERVER_IP/tmp -U$%', description="anonymous password set (schannel enforced server-side)")
@@ -567,6 +583,12 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/streams_xattr -U$USERNAME%$PASSWORD', 'streams_xattr')
+    elif t == "smb2.aio_delay":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/aio_delay_inject -U$USERNAME%$PASSWORD')
+    elif t == "smb2.delete-on-close-perms":
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/delete_readonly -U$USERNAME%$PASSWORD --option=torture:delete_readonly=true')
+        plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
     else:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/tmp -U$USERNAME%$PASSWORD')
         plansmbtorture4testsuite(t, "ad_dc", '//$SERVER/tmp -U$USERNAME%$PASSWORD')
diff -Npur samba-4.8.7/source3/smbd/aio.c samba-4.8.8/source3/smbd/aio.c
--- samba-4.8.7/source3/smbd/aio.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/smbd/aio.c	2018-12-13 10:08:40.000000000 +0100
@@ -645,12 +645,16 @@ bool cancel_smb2_aio(struct smb_request
 	}
 
 	/*
-	 * We let the aio request run. Setting fsp to NULL has the
-	 * effect that the _done routines don't send anything out.
+	 * We let the aio request run and don't try to cancel it which means
+	 * processing of the SMB2 request must continue as normal, cf MS-SMB2
+	 * 3.3.5.16:
+	 *
+	 *   If the target request is not successfully canceled, processing of
+	 *   the target request MUST continue and no response is sent to the
+	 *   cancel request.
 	 */
 
-	aio_ex->fsp = NULL;
-	return true;
+	return false;
 }
 
 static void aio_pread_smb2_done(struct tevent_req *req);
@@ -769,14 +773,6 @@ static void aio_pread_smb2_done(struct t
 	DEBUG(10, ("pread_recv returned %d, err = %s\n", (int)nread,
 		   (nread == -1) ? strerror(vfs_aio_state.error) : "no error"));
 
-	if (fsp == NULL) {
-		DEBUG(3, ("%s: request cancelled (mid[%ju])\n",
-			  __func__, (uintmax_t)aio_ex->smbreq->mid));
-		TALLOC_FREE(aio_ex);
-		tevent_req_nterror(subreq, NT_STATUS_INTERNAL_ERROR);
-		return;
-	}
-
 	/* Common error or success code processing for async or sync
 	   read returns. */
 
@@ -934,14 +930,6 @@ static void aio_pwrite_smb2_done(struct
 	DEBUG(10, ("pwrite_recv returned %d, err = %s\n", (int)nwritten,
 		   (nwritten == -1) ? strerror(err) : "no error"));
 
-	if (fsp == NULL) {
-		DEBUG(3, ("%s: request cancelled (mid[%ju])\n",
-			  __func__, (uintmax_t)aio_ex->smbreq->mid));
-		TALLOC_FREE(aio_ex);
-		tevent_req_nterror(subreq, NT_STATUS_INTERNAL_ERROR);
-		return;
-	}
-
 	mark_file_modified(fsp);
 
         status = smb2_write_complete_nosync(subreq, nwritten, err);
diff -Npur samba-4.8.7/source3/smbd/close.c samba-4.8.8/source3/smbd/close.c
--- samba-4.8.7/source3/smbd/close.c	2018-01-25 20:55:34.000000000 +0100
+++ samba-4.8.8/source3/smbd/close.c	2018-12-13 10:08:40.000000000 +0100
@@ -1097,6 +1097,8 @@ static NTSTATUS close_directory(struct s
 	if (lck == NULL) {
 		DEBUG(0, ("close_directory: Could not get share mode lock for "
 			  "%s\n", fsp_str_dbg(fsp)));
+		close_filestruct(fsp);
+		file_free(req, fsp);
 		return NT_STATUS_INVALID_PARAMETER;
 	}
 
@@ -1180,6 +1182,8 @@ static NTSTATUS close_directory(struct s
 			if (!NT_STATUS_IS_OK(status)) {
 				DEBUG(5, ("delete_all_streams failed: %s\n",
 					  nt_errstr(status)));
+				close_filestruct(fsp);
+				file_free(req, fsp);
 				return status;
 			}
 		}
diff -Npur samba-4.8.7/source3/smbd/open.c samba-4.8.8/source3/smbd/open.c
--- samba-4.8.7/source3/smbd/open.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/smbd/open.c	2018-12-13 10:08:40.000000000 +0100
@@ -3237,6 +3237,18 @@ static NTSTATUS open_file_ntcreate(conne
 		request_time = fsp->open_time;
 	}
 
+	if ((create_options & FILE_DELETE_ON_CLOSE) &&
+			(flags2 & O_CREAT) &&
+			!file_existed) {
+		/* Delete on close semantics for new files. */
+		status = can_set_delete_on_close(fsp,
+						new_dos_attributes);
+		if (!NT_STATUS_IS_OK(status)) {
+			fd_close(fsp);
+			return status;
+		}
+	}
+
 	/*
 	 * Ensure we pay attention to default ACLs on directories if required.
 	 */
@@ -3689,15 +3701,17 @@ static NTSTATUS open_file_ntcreate(conne
 
 	/* Handle strange delete on close create semantics. */
 	if (create_options & FILE_DELETE_ON_CLOSE) {
-
-		status = can_set_delete_on_close(fsp, new_dos_attributes);
-
-		if (!NT_STATUS_IS_OK(status)) {
-			/* Remember to delete the mode we just added. */
-			del_share_mode(lck, fsp);
-			TALLOC_FREE(lck);
-			fd_close(fsp);
-			return status;
+		if (!new_file_created) {
+			status = can_set_delete_on_close(fsp,
+					 existing_dos_attributes);
+
+			if (!NT_STATUS_IS_OK(status)) {
+				/* Remember to delete the mode we just added. */
+				del_share_mode(lck, fsp);
+				TALLOC_FREE(lck);
+				fd_close(fsp);
+				return status;
+			}
 		}
 		/* Note that here we set the *inital* delete on close flag,
 		   not the regular one. The magic gets handled in close. */
diff -Npur samba-4.8.7/source3/smbd/posix_acls.c samba-4.8.8/source3/smbd/posix_acls.c
--- samba-4.8.7/source3/smbd/posix_acls.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/smbd/posix_acls.c	2018-12-13 10:08:40.000000000 +0100
@@ -4779,7 +4779,7 @@ int posix_sys_acl_blob_get_fd(vfs_handle
 
 static NTSTATUS make_default_acl_posix(TALLOC_CTX *ctx,
 				       const char *name,
-				       SMB_STRUCT_STAT *psbuf,
+				       const SMB_STRUCT_STAT *psbuf,
 				       struct security_descriptor **ppdesc)
 {
 	struct dom_sid owner_sid, group_sid;
@@ -4886,7 +4886,7 @@ static NTSTATUS make_default_acl_posix(T
 
 static NTSTATUS make_default_acl_windows(TALLOC_CTX *ctx,
 					 const char *name,
-					 SMB_STRUCT_STAT *psbuf,
+					 const SMB_STRUCT_STAT *psbuf,
 					 struct security_descriptor **ppdesc)
 {
 	struct dom_sid owner_sid, group_sid;
@@ -4958,7 +4958,7 @@ static NTSTATUS make_default_acl_windows
 
 static NTSTATUS make_default_acl_everyone(TALLOC_CTX *ctx,
 					  const char *name,
-					  SMB_STRUCT_STAT *psbuf,
+					  const SMB_STRUCT_STAT *psbuf,
 					  struct security_descriptor **ppdesc)
 {
 	struct dom_sid owner_sid, group_sid;
@@ -5022,7 +5022,7 @@ NTSTATUS make_default_filesystem_acl(
 	TALLOC_CTX *ctx,
 	enum default_acl_style acl_style,
 	const char *name,
-	SMB_STRUCT_STAT *psbuf,
+	const SMB_STRUCT_STAT *psbuf,
 	struct security_descriptor **ppdesc)
 {
 	NTSTATUS status;
diff -Npur samba-4.8.7/source3/smbd/proto.h samba-4.8.8/source3/smbd/proto.h
--- samba-4.8.7/source3/smbd/proto.h	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/smbd/proto.h	2018-12-13 10:08:40.000000000 +0100
@@ -828,7 +828,7 @@ NTSTATUS make_default_filesystem_acl(
 	TALLOC_CTX *ctx,
 	enum default_acl_style acl_style,
 	const char *name,
-	SMB_STRUCT_STAT *psbuf,
+	const SMB_STRUCT_STAT *psbuf,
 	struct security_descriptor **ppdesc);
 
 /* The following definitions come from smbd/process.c  */
diff -Npur samba-4.8.7/source3/smbd/smb2_server.c samba-4.8.8/source3/smbd/smb2_server.c
--- samba-4.8.7/source3/smbd/smb2_server.c	2018-10-15 08:57:23.000000000 +0200
+++ samba-4.8.8/source3/smbd/smb2_server.c	2018-12-13 10:08:40.000000000 +0100
@@ -2364,7 +2364,11 @@ NTSTATUS smbd_smb2_request_dispatch(stru
 
 	req->async_internal = false;
 	req->do_signing = false;
-	req->do_encryption = false;
+	if (opcode != SMB2_OP_SESSSETUP) {
+		req->do_encryption = encryption_desired;
+	} else {
+		req->do_encryption = false;
+	}
 	req->was_encrypted = false;
 	if (intf_v->iov_len == SMB2_TF_HDR_SIZE) {
 		const uint8_t *intf = SMBD_SMB2_IN_TF_PTR(req);
@@ -2388,9 +2392,11 @@ NTSTATUS smbd_smb2_request_dispatch(stru
 		}
 
 		req->was_encrypted = true;
+		req->do_encryption = true;
 	}
 
 	if (encryption_required && !req->was_encrypted) {
+		req->do_encryption = true;
 		return smbd_smb2_request_error(req,
 				NT_STATUS_ACCESS_DENIED);
 	}
@@ -2526,15 +2532,14 @@ NTSTATUS smbd_smb2_request_dispatch(stru
 			encryption_required = true;
 		}
 		if (encryption_required && !req->was_encrypted) {
+			req->do_encryption = true;
 			return smbd_smb2_request_error(req,
 				NT_STATUS_ACCESS_DENIED);
+		} else if (encryption_desired) {
+			req->do_encryption = true;
 		}
 	}
 
-	if (req->was_encrypted || encryption_desired) {
-		req->do_encryption = true;
-	}
-
 	if (req->session) {
 		bool update_session_global = false;
 		bool update_tcon_global = false;
diff -Npur samba-4.8.7/source3/smbd/smb2_sesssetup.c samba-4.8.8/source3/smbd/smb2_sesssetup.c
--- samba-4.8.7/source3/smbd/smb2_sesssetup.c	2018-10-25 08:34:30.000000000 +0200
+++ samba-4.8.8/source3/smbd/smb2_sesssetup.c	2018-12-13 10:08:40.000000000 +0100
@@ -525,6 +525,10 @@ static NTSTATUS smbd_smb2_reauth_generic
 
 	reload_services(smb2req->sconn, conn_snum_used, true);
 
+	if (security_session_user_level(session_info, NULL) >= SECURITY_USER) {
+		smb2req->do_signing = true;
+	}
+
 	session->status = NT_STATUS_OK;
 	TALLOC_FREE(session->global->auth_session_info);
 	session->global->auth_session_info = talloc_move(session->global,
@@ -551,10 +555,6 @@ static NTSTATUS smbd_smb2_reauth_generic
 
 	conn_clear_vuid_caches(xconn->client->sconn, session->compat->vuid);
 
-	if (security_session_user_level(session_info, NULL) >= SECURITY_USER) {
-		smb2req->do_signing = true;
-	}
-
 	*out_session_id = session->global->session_wire_id;
 
 	return NT_STATUS_OK;
diff -Npur samba-4.8.7/source3/utils/dbwrap_tool.c samba-4.8.8/source3/utils/dbwrap_tool.c
--- samba-4.8.7/source3/utils/dbwrap_tool.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/dbwrap_tool.c	2018-12-13 10:08:40.000000000 +0100
@@ -28,6 +28,7 @@
 #include "dbwrap/dbwrap_watch.h"
 #include "messages.h"
 #include "util_tdb.h"
+#include "cmdline_contexts.h"
 
 enum dbwrap_op { OP_FETCH, OP_STORE, OP_DELETE, OP_ERASE, OP_LISTKEYS,
 		 OP_EXISTS };
@@ -428,6 +429,8 @@ int main(int argc, const char **argv)
 		while (extra_argv[extra_argc]) extra_argc++;
 	}
 
+	cmdline_messaging_context(get_dyn_CONFIGFILE());
+
 	lp_load_global(get_dyn_CONFIGFILE());
 
 	if ((extra_argc < 2) || (extra_argc > 5)) {
diff -Npur samba-4.8.7/source3/utils/eventlogadm.c samba-4.8.8/source3/utils/eventlogadm.c
--- samba-4.8.7/source3/utils/eventlogadm.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/eventlogadm.c	2018-12-13 10:08:40.000000000 +0100
@@ -30,6 +30,7 @@
 #include "registry/reg_util_token.h"
 #include "registry/reg_backend_db.h"
 #include "../libcli/registry/util_reg.h"
+#include "cmdline_contexts.h"
 
 extern int optind;
 extern char *optarg;
@@ -472,6 +473,9 @@ int main( int argc, char *argv[] )
 		exit( 1 );
 	}
 
+	cmdline_messaging_context(configfile == NULL ?
+				  get_dyn_CONFIGFILE() : configfile);
+
 	if ( configfile == NULL ) {
 		lp_load_global(get_dyn_CONFIGFILE());
 	} else if (!lp_load_global(configfile)) {
diff -Npur samba-4.8.7/source3/utils/net.c samba-4.8.8/source3/utils/net.c
--- samba-4.8.7/source3/utils/net.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/net.c	2018-12-13 10:08:40.000000000 +0100
@@ -41,13 +41,14 @@
 /*****************************************************/
 
 #include "includes.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "utils/net.h"
 #include "secrets.h"
 #include "lib/netapi/netapi.h"
 #include "../libcli/security/security.h"
 #include "passdb.h"
 #include "messages.h"
+#include "cmdline_contexts.h"
 
 #ifdef WITH_FAKE_KASERVER
 #include "utils/net_afs.h"
@@ -916,7 +917,6 @@ static struct functable net_func[] = {
 	poptContext pc;
 	TALLOC_CTX *frame = talloc_stackframe();
 	struct net_context *c = talloc_zero(frame, struct net_context);
-	NTSTATUS status;
 
 	struct poptOption long_options[] = {
 		{"help",	'h', POPT_ARG_NONE,   0, 'h'},
@@ -1030,28 +1030,7 @@ static struct functable net_func[] = {
 		}
 	}
 
-	if (!lp_load_initial_only(get_dyn_CONFIGFILE())) {
-		d_fprintf(stderr, "Can't load %s - run testparm to debug it\n",
-			  get_dyn_CONFIGFILE());
-		exit(1);
-	}
-
-	status = messaging_init_client(c,
-				       samba_tevent_context_init(c),
-				       &c->msg_ctx);
-	if (geteuid() != 0 &&
-			NT_STATUS_EQUAL(status, NT_STATUS_ACCESS_DENIED)) {
-		/*
-		 * Normal to fail to initialize messaging context
-		 * if we're not root as we don't have ability to
-		 * read lock directory.
-		 */
-		DBG_NOTICE("Unable to initialize messaging context. "
-			"Must be root to do that.\n");
-	} else if (!NT_STATUS_IS_OK(status)) {
-		d_fprintf(stderr, "Failed to init messaging context\n");
-		exit(1);
-	}
+	c->msg_ctx = cmdline_messaging_context(get_dyn_CONFIGFILE());
 
 	if (!lp_load_global(get_dyn_CONFIGFILE())) {
 		d_fprintf(stderr, "Can't load %s - run testparm to debug it\n",
diff -Npur samba-4.8.7/source3/utils/ntlm_auth.c samba-4.8.8/source3/utils/ntlm_auth.c
--- samba-4.8.7/source3/utils/ntlm_auth.c	2018-08-11 08:16:03.000000000 +0200
+++ samba-4.8.8/source3/utils/ntlm_auth.c	2018-12-13 10:08:40.000000000 +0100
@@ -47,6 +47,7 @@
 #include "nsswitch/libwbclient/wbclient.h"
 #include "lib/param/loadparm.h"
 #include "lib/util/base64.h"
+#include "cmdline_contexts.h"
 
 #if HAVE_KRB5
 #include "auth/kerberos/pac_utils.h"
@@ -2364,6 +2365,8 @@ enum {
 
 	poptFreeContext(pc);
 
+	cmdline_messaging_context(get_dyn_CONFIGFILE());
+
 	if (!lp_load_global(get_dyn_CONFIGFILE())) {
 		d_fprintf(stderr, "ntlm_auth: error opening config file %s. Error was %s\n",
 			get_dyn_CONFIGFILE(), strerror(errno));
diff -Npur samba-4.8.7/source3/utils/pdbedit.c samba-4.8.8/source3/utils/pdbedit.c
--- samba-4.8.7/source3/utils/pdbedit.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/pdbedit.c	2018-12-13 10:08:40.000000000 +0100
@@ -25,6 +25,7 @@
 #include "../librpc/gen_ndr/samr.h"
 #include "../libcli/security/security.h"
 #include "passdb.h"
+#include "cmdline_contexts.h"
 
 #define BIT_BACKEND	0x00000004
 #define BIT_VERBOSE	0x00000008
@@ -1117,6 +1118,8 @@ int main(int argc, const char **argv)
 	if (user_name == NULL)
 		user_name = poptGetArg(pc);
 
+	cmdline_messaging_context(get_dyn_CONFIGFILE());
+
 	if (!lp_load_global(get_dyn_CONFIGFILE())) {
 		fprintf(stderr, "Can't load %s - run testparm to debug it\n", get_dyn_CONFIGFILE());
 		exit(1);
diff -Npur samba-4.8.7/source3/utils/regedit.c samba-4.8.8/source3/utils/regedit.c
--- samba-4.8.7/source3/utils/regedit.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/regedit.c	2018-12-13 10:08:40.000000000 +0100
@@ -18,7 +18,7 @@
  */
 
 #include "includes.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "lib/util/data_blob.h"
 #include "lib/registry/registry.h"
 #include "regedit.h"
diff -Npur samba-4.8.7/source3/utils/sharesec.c samba-4.8.8/source3/utils/sharesec.c
--- samba-4.8.7/source3/utils/sharesec.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/sharesec.c	2018-12-13 10:08:40.000000000 +0100
@@ -28,6 +28,7 @@ struct cli_state;
 #include "../libcli/security/security.h"
 #include "passdb/machine_sid.h"
 #include "util_sd.h"
+#include "cmdline_contexts.h"
 
 static TALLOC_CTX *ctx;
 
@@ -420,6 +421,7 @@ int main(int argc, const char *argv[])
 
 	setlinebuf(stdout);
 
+	cmdline_messaging_context(get_dyn_CONFIGFILE());
 	lp_load_with_registry_shares(get_dyn_CONFIGFILE());
 
 	/* check for initializing secrets.tdb first */
diff -Npur samba-4.8.7/source3/utils/smbcacls.c samba-4.8.8/source3/utils/smbcacls.c
--- samba-4.8.7/source3/utils/smbcacls.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/utils/smbcacls.c	2018-12-13 10:08:40.000000000 +0100
@@ -22,7 +22,7 @@
 */
 
 #include "includes.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "rpc_client/cli_pipe.h"
 #include "../librpc/gen_ndr/ndr_lsa.h"
 #include "rpc_client/cli_lsarpc.h"
diff -Npur samba-4.8.7/source3/utils/smbcontrol.c samba-4.8.8/source3/utils/smbcontrol.c
--- samba-4.8.7/source3/utils/smbcontrol.c	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.8/source3/utils/smbcontrol.c	2018-12-13 10:08:40.000000000 +0100
@@ -35,6 +35,7 @@
 #include "util_tdb.h"
 #include "../lib/util/pidfile.h"
 #include "serverid.h"
+#include "cmdline_contexts.h"
 
 #if HAVE_LIBUNWIND_H
 #include <libunwind.h>
@@ -1643,21 +1644,23 @@ int main(int argc, const char **argv)
 	if (argc <= 1)
 		usage(pc);
 
+	msg_ctx = cmdline_messaging_context(get_dyn_CONFIGFILE());
+	if (msg_ctx == NULL) {
+		fprintf(stderr,
+			"Could not init messaging context, not root?\n");
+		TALLOC_FREE(frame);
+		exit(1);
+	}
+
+	evt_ctx = server_event_context();
+
 	lp_load_global(get_dyn_CONFIGFILE());
 
 	/* Need to invert sense of return code -- samba
          * routines mostly return True==1 for success, but
          * shell needs 0. */ 
 
-	if (!(evt_ctx = samba_tevent_context_init(NULL)) ||
-	    !(msg_ctx = messaging_init(NULL, evt_ctx))) {
-		fprintf(stderr, "could not init messaging context\n");
-		TALLOC_FREE(frame);
-		exit(1);
-	}
-
 	ret = !do_command(evt_ctx, msg_ctx, argc, argv);
-	TALLOC_FREE(msg_ctx);
 	TALLOC_FREE(frame);
 	return ret;
 }
diff -Npur samba-4.8.7/source3/utils/smbcquotas.c samba-4.8.8/source3/utils/smbcquotas.c
--- samba-4.8.7/source3/utils/smbcquotas.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/utils/smbcquotas.c	2018-12-13 10:08:40.000000000 +0100
@@ -22,7 +22,7 @@
 */
 
 #include "includes.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "rpc_client/cli_pipe.h"
 #include "../librpc/gen_ndr/ndr_lsa.h"
 #include "rpc_client/cli_lsarpc.h"
diff -Npur samba-4.8.7/source3/utils/smbget.c samba-4.8.8/source3/utils/smbget.c
--- samba-4.8.7/source3/utils/smbget.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.8/source3/utils/smbget.c	2018-12-13 10:08:40.000000000 +0100
@@ -18,8 +18,9 @@
 
 #include "includes.h"
 #include "system/filesys.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "libsmbclient.h"
+#include "cmdline_contexts.h"
 
 static int columns = 0;
 
@@ -879,6 +880,8 @@ int main(int argc, char **argv)
 
 	popt_burn_cmdline_password(argc, argv);
 
+	cmdline_messaging_context(get_dyn_CONFIGFILE());
+
 	if (smbc_init(get_auth_data, opt.debuglevel) < 0) {
 		fprintf(stderr, "Unable to initialize libsmbclient\n");
 		return 1;
diff -Npur samba-4.8.7/source3/utils/smbpasswd.c samba-4.8.8/source3/utils/smbpasswd.c
--- samba-4.8.7/source3/utils/smbpasswd.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.8/source3/utils/smbpasswd.c	2018-12-13 10:08:40.000000000 +0100
@@ -23,6 +23,7 @@
 #include "../lib/util/util_pw.h"
 #include "libsmb/proto.h"
 #include "passdb.h"
+#include "cmdline_contexts.h"
 
 /*
  * Next two lines needed for SunOS and don't
@@ -196,6 +197,8 @@ static int process_options(int argc, cha
 		usage();
 	}
 
+	cmdline_messaging_context(configfile);
+
 	if (!lp_load_global(configfile)) {
 		fprintf(stderr, "Can't load %s - run testparm to debug it\n", 
 			configfile);
@@ -614,7 +617,6 @@ static int process_nonroot(int local_fla
 int main(int argc, char **argv)
 {	
 	TALLOC_CTX *frame = talloc_stackframe();
-	struct messaging_context *msg_ctx = NULL;
 	int local_flags = 0;
 	int ret;
 
@@ -632,19 +634,6 @@ int main(int argc, char **argv)
 
 	setup_logging("smbpasswd", DEBUG_STDERR);
 
-	msg_ctx = server_messaging_context();
-	if (msg_ctx == NULL) {
-		if (geteuid() != 0) {
-			DBG_NOTICE("Unable to initialize messaging context. "
-				   "Must be root to do that.\n");
-		} else {
-			fprintf(stderr,
-				"smbpasswd is not able to initialize the "
-				"messaging context!\n");
-			return 1;
-		}
-	}
-
 	/*
 	 * Set the machine NETBIOS name if not already
 	 * set from the config file. 
diff -Npur samba-4.8.7/source3/utils/smbtree.c samba-4.8.8/source3/utils/smbtree.c
--- samba-4.8.7/source3/utils/smbtree.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source3/utils/smbtree.c	2018-12-13 10:08:40.000000000 +0100
@@ -20,7 +20,7 @@
 */
 
 #include "includes.h"
-#include "popt_common.h"
+#include "popt_common_cmdline.h"
 #include "rpc_client/cli_pipe.h"
 #include "../librpc/gen_ndr/ndr_srvsvc_c.h"
 #include "libsmb/libsmb.h"
diff -Npur samba-4.8.7/source3/utils/status.c samba-4.8.8/source3/utils/status.c
--- samba-4.8.7/source3/utils/status.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/utils/status.c	2018-12-13 10:08:40.000000000 +0100
@@ -48,6 +48,7 @@
 #include "serverid.h"
 #include "status_profile.h"
 #include "smbd/notifyd/notifyd.h"
+#include "cmdline_contexts.h"
 
 #define SMB_MAXPIDS		2048
 static uid_t 		Ucrit_uid = 0;               /* added by OH */
@@ -605,21 +606,9 @@ int main(int argc, const char *argv[])
 		d_printf("using configfile = %s\n", get_dyn_CONFIGFILE());
 	}
 
-	if (!lp_load_initial_only(get_dyn_CONFIGFILE())) {
-		fprintf(stderr, "Can't load %s - run testparm to debug it\n",
-			get_dyn_CONFIGFILE());
-		ret = -1;
-		goto done;
-	}
-
-
-	/*
-	 * This implicitly initializes the global ctdbd connection,
-	 * usable by the db_open() calls further down.
-	 */
-	msg_ctx = messaging_init(NULL, samba_tevent_context_init(NULL));
+	msg_ctx = cmdline_messaging_context(get_dyn_CONFIGFILE());
 	if (msg_ctx == NULL) {
-		fprintf(stderr, "messaging_init failed\n");
+		fprintf(stderr, "Could not initialize messaging, not root?\n");
 		ret = -1;
 		goto done;
 	}
diff -Npur samba-4.8.7/source3/utils/testparm.c samba-4.8.8/source3/utils/testparm.c
--- samba-4.8.7/source3/utils/testparm.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source3/utils/testparm.c	2018-12-13 10:08:40.000000000 +0100
@@ -35,6 +35,7 @@
 #include "system/filesys.h"
 #include "popt_common.h"
 #include "lib/param/loadparm.h"
+#include "cmdline_contexts.h"
 
 #include <regex.h>
 
@@ -698,6 +699,8 @@ static void do_per_share_checks(int s)
 		goto done;
 	}
 
+	cmdline_messaging_context(config_file);
+
 	fprintf(stderr,"Load smb config files from %s\n",config_file);
 
 	if (!lp_load_with_registry_shares(config_file)) {
diff -Npur samba-4.8.7/source3/utils/wscript_build samba-4.8.8/source3/utils/wscript_build
--- samba-4.8.7/source3/utils/wscript_build	2018-04-26 09:21:03.000000000 +0200
+++ samba-4.8.8/source3/utils/wscript_build	2018-12-13 10:08:40.000000000 +0100
@@ -18,6 +18,7 @@ bld.SAMBA3_BINARY('smbcontrol',
                  talloc
                  smbconf
                  popt_samba3
+                 cmdline_contexts
                  PRINTBASE''')
 
 bld.SAMBA3_BINARY('smbtree',
@@ -27,7 +28,7 @@ bld.SAMBA3_BINARY('smbtree',
                  smbconf
                  libsmb
                  msrpc3
-                 popt_samba3
+                 popt_samba3_cmdline
                  RPC_NDR_SRVSVC''')
 
 bld.SAMBA3_BINARY('smbpasswd',
@@ -37,7 +38,9 @@ bld.SAMBA3_BINARY('smbpasswd',
                  smbconf
                  pdb
                  PASSWD_UTIL
-                 PASSCHANGE''')
+                 PASSCHANGE
+                 cmdline_contexts
+                 ''')
 
 bld.SAMBA3_BINARY('pdbedit',
                  source='pdbedit.c',
@@ -45,6 +48,7 @@ bld.SAMBA3_BINARY('pdbedit',
                  talloc
                  smbconf
                  popt_samba3
+                 cmdline_contexts
                  pdb
                  PASSWD_UTIL''')
 
@@ -52,7 +56,7 @@ bld.SAMBA3_BINARY('smbget',
                  source='smbget.c',
                  deps='''
                  talloc
-                 popt_samba3
+                 popt_samba3_cmdline
                  smbclient''')
 
 bld.SAMBA3_BINARY('nmblookup',
@@ -67,7 +71,7 @@ bld.SAMBA3_BINARY('smbcacls',
                  source='smbcacls.c ../lib/util_sd.c',
                  deps='''
                  talloc
-                 popt_samba3
+                 popt_samba3_cmdline
                  msrpc3
                  libcli_lsa3
                  krb5samba''')
@@ -76,7 +80,7 @@ bld.SAMBA3_BINARY('smbcquotas',
                  source='smbcquotas.c',
                  deps='''
                  talloc
-                 popt_samba3
+                 popt_samba3_cmdline
                  libsmb
                  msrpc3
                  libcli_lsa3''')
@@ -86,7 +90,8 @@ bld.SAMBA3_BINARY('eventlogadm',
                  deps='''
                  talloc
                  smbconf
-                 LIBEVENTLOG''')
+                 LIBEVENTLOG
+                 cmdline_contexts''')
 
 bld.SAMBA3_BINARY('sharesec',
                  source='sharesec.c ../lib/util_sd.c',
@@ -94,7 +99,9 @@ bld.SAMBA3_BINARY('sharesec',
                  talloc
                  msrpc3
                  libcli_lsa3
-                 popt_samba3''')
+                 popt_samba3
+                 cmdline_contexts
+                 ''')
 
 bld.SAMBA3_BINARY('log2pcap',
                  source='log2pcaphex.c',
@@ -122,13 +129,16 @@ bld.SAMBA3_BINARY('ntlm_auth',
                  tiniparser
                  libsmb
                  popt_samba3
+                 cmdline_contexts
                  gse gensec''')
 
 bld.SAMBA3_BINARY('dbwrap_tool',
                  source='dbwrap_tool.c',
                  deps='''
                  talloc
-                 popt_samba3''')
+                 popt_samba3
+                 cmdline_contexts
+                 ''')
 
 bld.SAMBA3_BINARY('dbwrap_torture',
                  source='dbwrap_torture.c',
@@ -149,7 +159,9 @@ bld.SAMBA3_BINARY('samba-regedit',
                             regedit_wrap.c regedit_treeview.c
                             regedit_valuelist.c regedit_dialog.c
                             regedit_hexedit.c regedit_list.c""",
-                  deps='ncurses menu panel form registry smbconf popt_samba3',
+                  deps='''
+                  ncurses menu panel form registry smbconf popt_samba3_cmdline
+                  ''',
                   enabled=bld.env.build_regedit)
 
 bld.SAMBA3_BINARY('testparm',
@@ -157,7 +169,9 @@ bld.SAMBA3_BINARY('testparm',
                  deps='''
                  talloc
                  smbconf
-                 popt_samba3''')
+                 popt_samba3
+                 cmdline_contexts
+                 ''')
 
 bld.SAMBA3_BINARY('net',
                  source='''net.c
@@ -216,7 +230,7 @@ bld.SAMBA3_BINARY('net',
                  netapi
                  addns
                  samba_intl
-                 popt_samba3
+                 popt_samba3_cmdline
                  pdb
                  libsmb
                  smbconf
diff -Npur samba-4.8.7/source3/winbindd/winbindd_cache.c samba-4.8.8/source3/winbindd/winbindd_cache.c
--- samba-4.8.7/source3/winbindd/winbindd_cache.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.8/source3/winbindd/winbindd_cache.c	2018-12-13 10:08:40.000000000 +0100
@@ -1749,7 +1749,7 @@ static void wcache_name_to_sid_fn(const
 
 	*state->sid = *sid;
 	*state->type = type;
-	state->found = (state->offline || (timeout < time(NULL)));
+	state->found = (state->offline || (timeout > time(NULL)));
 }
 
 static NTSTATUS wcache_name_to_sid(struct winbindd_domain *domain,
@@ -1884,7 +1884,7 @@ static void wcache_sid_to_name_fn(const
 		return;
 	}
 	*state->type = type;
-	state->found = (state->offline || (timeout < time(NULL)));
+	state->found = (state->offline || (timeout > time(NULL)));
 }
 
 static NTSTATUS wcache_sid_to_name(struct winbindd_domain *domain,
diff -Npur samba-4.8.7/source3/winbindd/winbindd_util.c samba-4.8.8/source3/winbindd/winbindd_util.c
--- samba-4.8.7/source3/winbindd/winbindd_util.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/winbindd/winbindd_util.c	2018-12-13 10:08:40.000000000 +0100
@@ -108,15 +108,6 @@ static bool is_internal_domain(const str
 	return (sid_check_is_our_sam(sid) || sid_check_is_builtin(sid));
 }
 
-static bool is_in_internal_domain(const struct dom_sid *sid)
-{
-	if (sid == NULL)
-		return False;
-
-	return (sid_check_is_in_our_sam(sid) || sid_check_is_in_builtin(sid));
-}
-
-
 /* Add a trusted domain to our list of domains.
    If the domain already exists in the list,
    return it and don't re-initialize.  */
@@ -1475,20 +1466,18 @@ struct winbindd_domain *find_lookup_doma
 	     sid_check_is_unix_groups(sid) ||
 	     sid_check_is_in_unix_users(sid) ||
 	     sid_check_is_unix_users(sid) ||
-	     sid_check_is_wellknown_domain(sid, NULL) ||
-	     sid_check_is_in_wellknown_domain(sid) )
+	     sid_check_is_our_sam(sid) ||
+             sid_check_is_in_our_sam(sid) )
 	{
 		return find_domain_from_sid(get_global_sam_sid());
 	}
 
-	/*
-	 * On member servers the internal domains are different: These are part
-	 * of the local SAM.
-	 */
-
-	if (is_internal_domain(sid) || is_in_internal_domain(sid)) {
-		DEBUG(10, ("calling find_domain_from_sid\n"));
-		return find_domain_from_sid(sid);
+	if ( sid_check_is_builtin(sid) ||
+	     sid_check_is_in_builtin(sid) ||
+	     sid_check_is_wellknown_domain(sid, NULL) ||
+	     sid_check_is_in_wellknown_domain(sid) )
+	{
+		return find_domain_from_sid(&global_sid_Builtin);
 	}
 
 	if (IS_DC) {
@@ -1515,6 +1504,8 @@ struct winbindd_domain *find_lookup_doma
 
 struct winbindd_domain *find_lookup_domain_from_name(const char *domain_name)
 {
+	bool predefined;
+
 	if ( strequal(domain_name, unix_users_domain_name() ) ||
 	     strequal(domain_name, unix_groups_domain_name() ) )
 	{
@@ -1526,8 +1517,14 @@ struct winbindd_domain *find_lookup_doma
 	}
 
 	if (strequal(domain_name, "BUILTIN") ||
-	    strequal(domain_name, get_global_sam_name()))
+	    strequal(domain_name, get_global_sam_name())) {
 		return find_domain_from_name_noinit(domain_name);
+	}
+
+	predefined = dom_sid_lookup_is_predefined_domain(domain_name);
+	if (predefined) {
+		return find_domain_from_name_noinit(builtin_domain_name());
+	}
 
 	if (IS_DC) {
 		struct winbindd_domain *domain = NULL;
diff -Npur samba-4.8.7/source3/wscript_build samba-4.8.8/source3/wscript_build
--- samba-4.8.7/source3/wscript_build	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source3/wscript_build	2018-12-13 10:08:40.000000000 +0100
@@ -257,7 +257,12 @@ bld.SAMBA3_SUBSYSTEM('REG_FULL',
 
 bld.SAMBA3_LIBRARY('popt_samba3',
                    source='lib/popt_common.c',
-                   deps='popt samba-util util_cmdline',
+                   deps='popt samba-util smbconf',
+                   private_library=True)
+
+bld.SAMBA3_LIBRARY('popt_samba3_cmdline',
+                   source='lib/popt_common_cmdline.c',
+                   deps='popt_samba3 util_cmdline cmdline_contexts',
                    private_library=True)
 
 bld.SAMBA3_LIBRARY('util_cmdline',
@@ -265,6 +270,11 @@ bld.SAMBA3_LIBRARY('util_cmdline',
                    deps='secrets3',
                    private_library=True)
 
+bld.SAMBA3_LIBRARY('cmdline_contexts',
+                   source='lib/cmdline_contexts.c',
+                   deps='samba3core',
+                   private_library=True)
+
 bld.SAMBA3_SUBSYSTEM('KRBCLIENT',
                      source='libads/kerberos.c libads/ads_status.c',
                      public_deps='krb5samba asn1util k5crypto gssapi LIBTSOCKET CLDAP LIBNMB')
@@ -1083,7 +1093,7 @@ bld.SAMBA3_BINARY('client/smbclient',
                         ''',
                  deps='''
                       talloc
-                      popt_samba3
+                      popt_samba3_cmdline
                       smbconf
                       ndr-standard
                       SMBREADLINE
@@ -1136,6 +1146,7 @@ bld.SAMBA3_BINARY('smbstatus',
                       talloc
                       smbconf
                       popt_samba3
+                      cmdline_contexts
                       smbd_base
                       LOCKING
                       PROFILE
diff -Npur samba-4.8.7/source4/dns_server/dns_query.c samba-4.8.8/source4/dns_server/dns_query.c
--- samba-4.8.7/source4/dns_server/dns_query.c	2018-11-26 08:54:31.000000000 +0100
+++ samba-4.8.8/source4/dns_server/dns_query.c	2018-12-13 10:08:40.000000000 +0100
@@ -388,7 +388,8 @@ static struct tevent_req *handle_authori
 	TALLOC_CTX *mem_ctx, struct tevent_context *ev,
 	struct dns_server *dns, const char *forwarder,
 	struct dns_name_question *question,
-	struct dns_res_rec **answers, struct dns_res_rec **nsrecs);
+	struct dns_res_rec **answers, struct dns_res_rec **nsrecs,
+	size_t cname_depth);
 static WERROR handle_authoritative_recv(struct tevent_req *req);
 
 struct handle_dnsrpcrec_state {
@@ -404,7 +405,8 @@ static struct tevent_req *handle_dnsrpcr
 	struct dns_server *dns, const char *forwarder,
 	const struct dns_name_question *question,
 	struct dnsp_DnssrvRpcRecord *rec,
-	struct dns_res_rec **answers, struct dns_res_rec **nsrecs)
+	struct dns_res_rec **answers, struct dns_res_rec **nsrecs,
+	size_t cname_depth)
 {
 	struct tevent_req *req, *subreq;
 	struct handle_dnsrpcrec_state *state;
@@ -420,7 +422,7 @@ static struct tevent_req *handle_dnsrpcr
 	state->answers = answers;
 	state->nsrecs = nsrecs;
 
-	if (talloc_array_length(*answers) >= MAX_Q_RECURSION_DEPTH) {
+	if (cname_depth >= MAX_Q_RECURSION_DEPTH) {
 		tevent_req_done(req);
 		return tevent_req_post(req, ev);
 	}
@@ -465,7 +467,8 @@ static struct tevent_req *handle_dnsrpcr
 	if (dns_authoritative_for_zone(dns, new_q->name)) {
 		subreq = handle_authoritative_send(
 			state, ev, dns, forwarder, new_q,
-			state->answers, state->nsrecs);
+			state->answers, state->nsrecs,
+			cname_depth + 1);
 		if (tevent_req_nomem(subreq, req)) {
 			return tevent_req_post(req, ev);
 		}
@@ -549,6 +552,8 @@ struct handle_authoritative_state {
 
 	struct dns_res_rec **answers;
 	struct dns_res_rec **nsrecs;
+
+	size_t cname_depth;
 };
 
 static void handle_authoritative_done(struct tevent_req *subreq);
@@ -557,7 +562,8 @@ static struct tevent_req *handle_authori
 	TALLOC_CTX *mem_ctx, struct tevent_context *ev,
 	struct dns_server *dns, const char *forwarder,
 	struct dns_name_question *question,
-	struct dns_res_rec **answers, struct dns_res_rec **nsrecs)
+	struct dns_res_rec **answers, struct dns_res_rec **nsrecs,
+	size_t cname_depth)
 {
 	struct tevent_req *req, *subreq;
 	struct handle_authoritative_state *state;
@@ -575,6 +581,7 @@ static struct tevent_req *handle_authori
 	state->forwarder = forwarder;
 	state->answers = answers;
 	state->nsrecs = nsrecs;
+	state->cname_depth = cname_depth;
 
 	werr = dns_name2dn(dns, state, question->name, &dn);
 	if (tevent_req_werror(req, werr)) {
@@ -595,7 +602,8 @@ static struct tevent_req *handle_authori
 	subreq = handle_dnsrpcrec_send(
 		state, state->ev, state->dns, state->forwarder,
 		state->question, &state->recs[state->recs_done],
-		state->answers, state->nsrecs);
+		state->answers, state->nsrecs,
+		state->cname_depth);
 	if (tevent_req_nomem(subreq, req)) {
 		return tevent_req_post(req, ev);
 	}
@@ -627,7 +635,8 @@ static void handle_authoritative_done(st
 	subreq = handle_dnsrpcrec_send(
 		state, state->ev, state->dns, state->forwarder,
 		state->question, &state->recs[state->recs_done],
-		state->answers, state->nsrecs);
+		state->answers, state->nsrecs,
+		state->cname_depth);
 	if (tevent_req_nomem(subreq, req)) {
 		return;
 	}
@@ -999,7 +1008,8 @@ struct tevent_req *dns_server_process_qu
 
 		subreq = handle_authoritative_send(
 			state, ev, dns, (forwarders == NULL ? NULL : forwarders[0]),
-			&in->questions[0], &state->answers, &state->nsrecs);
+			&in->questions[0], &state->answers, &state->nsrecs,
+			0); /* cname_depth */
 		if (tevent_req_nomem(subreq, req)) {
 			return tevent_req_post(req, ev);
 		}
@@ -1101,7 +1111,8 @@ static void dns_server_process_query_got
 		subreq = handle_authoritative_send(state, state->ev, state->dns,
 						   state->forwarders->forwarder,
 						   state->question, &state->answers,
-						   &state->nsrecs);
+						   &state->nsrecs,
+						   0); /* cname_depth */
 
 		if (tevent_req_nomem(subreq, req)) {
 			return;
diff -Npur samba-4.8.7/source4/dsdb/pydsdb.c samba-4.8.8/source4/dsdb/pydsdb.c
--- samba-4.8.7/source4/dsdb/pydsdb.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source4/dsdb/pydsdb.c	2018-12-13 10:08:40.000000000 +0100
@@ -1569,6 +1569,9 @@ void initdsdb(void)
 	ADD_DSDB_STRING(DSDB_SYNTAX_OR_NAME);
 	ADD_DSDB_STRING(DSDB_CONTROL_DBCHECK);
 	ADD_DSDB_STRING(DSDB_CONTROL_DBCHECK_MODIFY_RO_REPLICA);
+	ADD_DSDB_STRING(DSDB_CONTROL_DBCHECK_FIX_DUPLICATE_LINKS);
+	ADD_DSDB_STRING(DSDB_CONTROL_DBCHECK_FIX_LINK_DN_NAME);
+	ADD_DSDB_STRING(DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID);
 	ADD_DSDB_STRING(DSDB_CONTROL_REPLMD_VANISH_LINKS);
 	ADD_DSDB_STRING(DSDB_CONTROL_PERMIT_INTERDOMAIN_TRUST_UAC_OID);
 	ADD_DSDB_STRING(DSDB_CONTROL_SKIP_DUPLICATES_CHECK_OID);
diff -Npur samba-4.8.7/source4/dsdb/samdb/ldb_modules/extended_dn_store.c samba-4.8.8/source4/dsdb/samdb/ldb_modules/extended_dn_store.c
--- samba-4.8.7/source4/dsdb/samdb/ldb_modules/extended_dn_store.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source4/dsdb/samdb/ldb_modules/extended_dn_store.c	2018-12-13 10:08:40.000000000 +0100
@@ -376,6 +376,7 @@ static int extended_dn_modify(struct ldb
 	unsigned int i, j;
 	struct extended_dn_context *ac;
 	struct ldb_control *fix_links_control = NULL;
+	struct ldb_control *fix_link_sid_ctrl = NULL;
 	int ret;
 
 	if (ldb_dn_is_special(req->op.mod.message->dn)) {
@@ -400,6 +401,12 @@ static int extended_dn_modify(struct ldb
 		return ldb_next_request(module, req);
 	}
 
+	fix_link_sid_ctrl = ldb_request_get_control(ac->req,
+					DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID);
+	if (fix_link_sid_ctrl != NULL) {
+		return ldb_next_request(module, req);
+	}
+
 	for (i=0; i < req->op.mod.message->num_elements; i++) {
 		const struct ldb_message_element *el = &req->op.mod.message->elements[i];
 		const struct dsdb_attribute *schema_attr
diff -Npur samba-4.8.7/source4/dsdb/samdb/ldb_modules/linked_attributes.c samba-4.8.8/source4/dsdb/samdb/ldb_modules/linked_attributes.c
--- samba-4.8.7/source4/dsdb/samdb/ldb_modules/linked_attributes.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source4/dsdb/samdb/ldb_modules/linked_attributes.c	2018-12-13 10:08:40.000000000 +0100
@@ -25,7 +25,23 @@
  *
  *  Component: ldb linked_attributes module
  *
- *  Description: Module to ensure linked attribute pairs remain in sync
+ *  Description: Module to ensure linked attribute pairs (i.e. forward-links
+ *  and backlinks) remain in sync.
+ *
+ *  Backlinks are 'plain' links (without extra metadata). When the link target
+ *  object is modified (e.g. renamed), we use the backlinks to keep the link
+ *  source object updated. Note there are some cases where we can't do this:
+ *    - one-way links, which don't have a corresponding backlink
+ *    - two-way deactivated links, i.e. when a user is removed from a group,
+ *      the forward 'member' link still exists (but is inactive), however, the
+ *      'memberOf' backlink is deleted.
+ *  In these cases, we can end up with a dangling forward link which is
+ *  incorrect (i.e. the target has been renamed or deleted). We have dbcheck
+ *  rules to detect and fix this, and cope otherwise by filtering at runtime
+ *  (i.e. in the extended_dn module).
+ *
+ *  See also repl_meta_data.c, which handles updating links for deleted
+ *  objects, as well as link changes received from another DC.
  *
  *  Author: Andrew Bartlett
  */
diff -Npur samba-4.8.7/source4/dsdb/samdb/ldb_modules/repl_meta_data.c samba-4.8.8/source4/dsdb/samdb/ldb_modules/repl_meta_data.c
--- samba-4.8.7/source4/dsdb/samdb/ldb_modules/repl_meta_data.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.8/source4/dsdb/samdb/ldb_modules/repl_meta_data.c	2018-12-13 10:08:40.000000000 +0100
@@ -112,6 +112,8 @@ struct replmd_replicated_request {
 	bool is_urgent;
 
 	bool isDeleted;
+
+	bool fix_link_sid;
 };
 
 static int replmd_replicated_apply_merge(struct replmd_replicated_request *ar);
@@ -2398,12 +2400,11 @@ static int replmd_update_la_val(TALLOC_C
  */
 static int replmd_modify_la_add(struct ldb_module *module,
 				struct replmd_private *replmd_private,
-				const struct dsdb_schema *schema,
+				struct replmd_replicated_request *ac,
 				struct ldb_message *msg,
 				struct ldb_message_element *el,
 				struct ldb_message_element *old_el,
 				const struct dsdb_attribute *schema_attr,
-				uint64_t seq_num,
 				time_t t,
 				struct ldb_dn *msg_dn,
 				struct ldb_request *parent)
@@ -2416,17 +2417,10 @@ static int replmd_modify_la_add(struct l
 	unsigned old_num_values = old_el ? old_el->num_values : 0;
 	unsigned num_values = 0;
 	unsigned max_num_values;
-	const struct GUID *invocation_id;
 	struct ldb_context *ldb = ldb_module_get_ctx(module);
 	NTTIME now;
 	unix_to_nt_time(&now, t);
 
-	invocation_id = samdb_ntds_invocation_id(ldb);
-	if (!invocation_id) {
-		talloc_free(tmp_ctx);
-		return LDB_ERR_OPERATIONS_ERROR;
-	}
-
 	/* get the DNs to be added, fully parsed.
 	 *
 	 * We need full parsing because they came off the wire and we don't
@@ -2453,7 +2447,7 @@ static int replmd_modify_la_add(struct l
 	max_num_values = old_num_values + el->num_values;
 	if (max_num_values < old_num_values) {
 		DEBUG(0, ("we seem to have overflow in replmd_modify_la_add. "
-			  "old values: %u, new values: %u, sum: %u",
+			  "old values: %u, new values: %u, sum: %u\n",
 			  old_num_values, el->num_values, max_num_values));
 		talloc_free(tmp_ctx);
 		return LDB_ERR_OPERATIONS_ERROR;
@@ -2489,6 +2483,109 @@ static int replmd_modify_la_add(struct l
 			return err;
 		}
 
+		if (ac->fix_link_sid) {
+			char *fixed_dnstring = NULL;
+			struct dom_sid tmp_sid = { 0, };
+			DATA_BLOB sid_blob = data_blob_null;
+			enum ndr_err_code ndr_err;
+			NTSTATUS status;
+			int num;
+
+			if (exact == NULL) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			if (dns[i].dsdb_dn->dn_format != DSDB_NORMAL_DN) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			/*
+			 * Only "<GUID=...><SID=...>" is allowed.
+			 *
+			 * We get the GUID to just to find the old
+			 * value and the SID in order to add it
+			 * to the found value.
+			 */
+
+			num = ldb_dn_get_comp_num(dns[i].dsdb_dn->dn);
+			if (num != 0) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			num = ldb_dn_get_extended_comp_num(dns[i].dsdb_dn->dn);
+			if (num != 2) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			status = dsdb_get_extended_dn_sid(exact->dsdb_dn->dn,
+							  &tmp_sid, "SID");
+			if (NT_STATUS_EQUAL(status, NT_STATUS_OBJECT_NAME_NOT_FOUND)) {
+				/* this is what we expect */
+			} else if (NT_STATUS_IS_OK(status)) {
+				struct GUID_txt_buf guid_str;
+				ldb_debug_set(ldb, LDB_DEBUG_FATAL,
+						       "i[%u] SID NOT MISSING... Attribute %s already "
+						       "exists for target GUID %s, SID %s, DN: %s",
+						       i, el->name,
+						       GUID_buf_string(&exact->guid,
+								       &guid_str),
+						       dom_sid_string(tmp_ctx, &tmp_sid),
+						       dsdb_dn_get_extended_linearized(tmp_ctx,
+							       exact->dsdb_dn, 1));
+				talloc_free(tmp_ctx);
+				return LDB_ERR_ATTRIBUTE_OR_VALUE_EXISTS;
+			} else {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			status = dsdb_get_extended_dn_sid(dns[i].dsdb_dn->dn,
+							  &tmp_sid, "SID");
+			if (!NT_STATUS_IS_OK(status)) {
+				struct GUID_txt_buf guid_str;
+				ldb_asprintf_errstring(ldb,
+						       "NO SID PROVIDED... Attribute %s already "
+						       "exists for target GUID %s",
+						       el->name,
+						       GUID_buf_string(&exact->guid,
+								       &guid_str));
+				talloc_free(tmp_ctx);
+				return LDB_ERR_ATTRIBUTE_OR_VALUE_EXISTS;
+			}
+
+			ndr_err = ndr_push_struct_blob(&sid_blob, tmp_ctx, &tmp_sid,
+						       (ndr_push_flags_fn_t)ndr_push_dom_sid);
+			if (!NDR_ERR_CODE_IS_SUCCESS(ndr_err)) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			ret = ldb_dn_set_extended_component(exact->dsdb_dn->dn, "SID", &sid_blob);
+			data_blob_free(&sid_blob);
+			if (ret != LDB_SUCCESS) {
+				talloc_free(tmp_ctx);
+				return ret;
+			}
+
+			fixed_dnstring = dsdb_dn_get_extended_linearized(
+					new_values, exact->dsdb_dn, 1);
+			if (fixed_dnstring == NULL) {
+				talloc_free(tmp_ctx);
+				return ldb_operr(ldb);
+			}
+
+			/*
+			 * We just replace the existing value...
+			 */
+			*exact->v = data_blob_string_const(fixed_dnstring);
+
+			continue;
+		}
+
 		if (exact != NULL) {
 			/*
 			 * We are trying to add one that exists, which is only
@@ -2522,15 +2619,16 @@ static int replmd_modify_la_add(struct l
 			ret = replmd_update_la_val(new_values, exact->v,
 						   dns[i].dsdb_dn,
 						   exact->dsdb_dn,
-						   invocation_id, seq_num,
-						   seq_num, now, false);
+						   &ac->our_invocation_id,
+						   ac->seq_num, ac->seq_num,
+						   now, false);
 			if (ret != LDB_SUCCESS) {
 				talloc_free(tmp_ctx);
 				return ret;
 			}
 
 			ret = replmd_add_backlink(module, replmd_private,
-						  schema,
+						  ac->schema,
 						  msg_dn,
 						  &dns[i].guid, 
 						  true,
@@ -2572,14 +2670,14 @@ static int replmd_modify_la_add(struct l
 		}
 
 		ret = replmd_add_backlink(module, replmd_private,
-					  schema, msg_dn,
+					  ac->schema, msg_dn,
 					  &dns[i].guid,
 					  true, schema_attr,
 					  parent);
 		/* Make the new linked attribute ldb_val. */
 		ret = replmd_build_la_val(new_values, &new_values[num_values],
-					  dns[i].dsdb_dn, invocation_id,
-					  seq_num, now);
+					  dns[i].dsdb_dn, &ac->our_invocation_id,
+					  ac->seq_num, now);
 		if (ret != LDB_SUCCESS) {
 			talloc_free(tmp_ctx);
 			return ret;
@@ -2618,12 +2716,11 @@ static int replmd_modify_la_add(struct l
  */
 static int replmd_modify_la_delete(struct ldb_module *module,
 				   struct replmd_private *replmd_private,
-				   const struct dsdb_schema *schema,
+				   struct replmd_replicated_request *ac,
 				   struct ldb_message *msg,
 				   struct ldb_message_element *el,
 				   struct ldb_message_element *old_el,
 				   const struct dsdb_attribute *schema_attr,
-				   uint64_t seq_num,
 				   time_t t,
 				   struct ldb_dn *msg_dn,
 				   struct ldb_request *parent)
@@ -2637,16 +2734,10 @@ static int replmd_modify_la_delete(struc
 	bool vanish_links = false;
 	unsigned int num_to_delete = el->num_values;
 	uint32_t rmd_flags;
-	const struct GUID *invocation_id;
 	NTTIME now;
 
 	unix_to_nt_time(&now, t);
 
-	invocation_id = samdb_ntds_invocation_id(ldb);
-	if (!invocation_id) {
-		return LDB_ERR_OPERATIONS_ERROR;
-	}
-
 	if (old_el == NULL || old_el->num_values == 0) {
 		/* there is nothing to delete... */
 		if (num_to_delete == 0) {
@@ -2710,7 +2801,7 @@ static int replmd_modify_la_delete(struc
 				}
 			}
 			ret = replmd_add_backlink(module, replmd_private,
-						  schema, msg_dn, &p->guid,
+						  ac->schema, msg_dn, &p->guid,
 						  false, schema_attr,
 						  parent);
 			if (ret != LDB_SUCCESS) {
@@ -2728,8 +2819,9 @@ static int replmd_modify_la_delete(struc
 
 			ret = replmd_update_la_val(old_el->values, p->v,
 						   p->dsdb_dn, p->dsdb_dn,
-						   invocation_id, seq_num,
-						   seq_num, now, true);
+						   &ac->our_invocation_id,
+						   ac->seq_num, ac->seq_num,
+						   now, true);
 			if (ret != LDB_SUCCESS) {
 				talloc_free(tmp_ctx);
 				return ret;
@@ -2791,7 +2883,7 @@ static int replmd_modify_la_delete(struc
 			/* remove the backlink */
 			ret = replmd_add_backlink(module,
 						  replmd_private,
-						  schema, 
+						  ac->schema,
 						  msg_dn,
 						  &p->guid,
 						  false, schema_attr,
@@ -2825,14 +2917,15 @@ static int replmd_modify_la_delete(struc
 
 		ret = replmd_update_la_val(old_el->values, exact->v,
 					   exact->dsdb_dn, exact->dsdb_dn,
-					   invocation_id, seq_num, seq_num,
+					   &ac->our_invocation_id,
+					   ac->seq_num, ac->seq_num,
 					   now, true);
 		if (ret != LDB_SUCCESS) {
 			talloc_free(tmp_ctx);
 			return ret;
 		}
 		ret = replmd_add_backlink(module, replmd_private,
-					  schema, msg_dn,
+					  ac->schema, msg_dn,
 					  &p->guid,
 					  false, schema_attr,
 					  parent);
@@ -2882,12 +2975,11 @@ static int replmd_modify_la_delete(struc
  */
 static int replmd_modify_la_replace(struct ldb_module *module,
 				    struct replmd_private *replmd_private,
-				    const struct dsdb_schema *schema,
+				    struct replmd_replicated_request *ac,
 				    struct ldb_message *msg,
 				    struct ldb_message_element *el,
 				    struct ldb_message_element *old_el,
 				    const struct dsdb_attribute *schema_attr,
-				    uint64_t seq_num,
 				    time_t t,
 				    struct ldb_dn *msg_dn,
 				    struct ldb_request *parent)
@@ -2896,7 +2988,6 @@ static int replmd_modify_la_replace(stru
 	struct parsed_dn *dns, *old_dns;
 	TALLOC_CTX *tmp_ctx = talloc_new(msg);
 	int ret;
-	const struct GUID *invocation_id;
 	struct ldb_context *ldb = ldb_module_get_ctx(module);
 	struct ldb_val *new_values = NULL;
 	const char *ldap_oid = schema_attr->syntax->ldap_oid;
@@ -2907,11 +2998,6 @@ static int replmd_modify_la_replace(stru
 
 	unix_to_nt_time(&now, t);
 
-	invocation_id = samdb_ntds_invocation_id(ldb);
-	if (!invocation_id) {
-		return LDB_ERR_OPERATIONS_ERROR;
-	}
-
 	/*
 	 * The replace operation is unlike the replace and delete cases in that
 	 * we need to look at every existing link to see whether it is being
@@ -3011,8 +3097,8 @@ static int replmd_modify_la_replace(stru
 				ret = replmd_update_la_val(new_values, old_p->v,
 							   old_p->dsdb_dn,
 							   old_p->dsdb_dn,
-							   invocation_id,
-							   seq_num, seq_num,
+							   &ac->our_invocation_id,
+							   ac->seq_num, ac->seq_num,
 							   now, true);
 				if (ret != LDB_SUCCESS) {
 					talloc_free(tmp_ctx);
@@ -3020,7 +3106,7 @@ static int replmd_modify_la_replace(stru
 				}
 
 				ret = replmd_add_backlink(module, replmd_private,
-							  schema, 
+							  ac->schema,
 							  msg_dn,
 							  &old_p->guid, false,
 							  schema_attr,
@@ -3045,8 +3131,8 @@ static int replmd_modify_la_replace(stru
 			ret = replmd_update_la_val(new_values, old_p->v,
 						   new_p->dsdb_dn,
 						   old_p->dsdb_dn,
-						   invocation_id,
-						   seq_num, seq_num,
+						   &ac->our_invocation_id,
+						   ac->seq_num, ac->seq_num,
 						   now, false);
 			if (ret != LDB_SUCCESS) {
 				talloc_free(tmp_ctx);
@@ -3056,7 +3142,7 @@ static int replmd_modify_la_replace(stru
 			rmd_flags = dsdb_dn_rmd_flags(old_p->dsdb_dn->dn);
 			if ((rmd_flags & DSDB_RMD_FLAG_DELETED) != 0) {
 				ret = replmd_add_backlink(module, replmd_private,
-							  schema, 
+							  ac->schema,
 							  msg_dn,
 							  &new_p->guid, true,
 							  schema_attr,
@@ -3078,14 +3164,14 @@ static int replmd_modify_la_replace(stru
 			ret = replmd_build_la_val(new_values,
 						  new_p->v,
 						  new_p->dsdb_dn,
-						  invocation_id,
-						  seq_num, now);
+						  &ac->our_invocation_id,
+						  ac->seq_num, now);
 			if (ret != LDB_SUCCESS) {
 				talloc_free(tmp_ctx);
 				return ret;
 			}
 			ret = replmd_add_backlink(module, replmd_private,
-						  schema,
+						  ac->schema,
 						  msg_dn,
 						  &new_p->guid, true,
 						  schema_attr,
@@ -3116,8 +3202,9 @@ static int replmd_modify_la_replace(stru
  */
 static int replmd_modify_handle_linked_attribs(struct ldb_module *module,
 					       struct replmd_private *replmd_private,
+					       struct replmd_replicated_request *ac,
 					       struct ldb_message *msg,
-					       uint64_t seq_num, time_t t,
+					       time_t t,
 					       struct ldb_request *parent)
 {
 	struct ldb_result *res;
@@ -3126,8 +3213,6 @@ static int replmd_modify_handle_linked_a
 	struct ldb_context *ldb = ldb_module_get_ctx(module);
 	struct ldb_message *old_msg;
 
-	const struct dsdb_schema *schema;
-
 	if (dsdb_functional_level(ldb) == DS_DOMAIN_FUNCTION_2000) {
 		/*
 		 * Nothing special is required for modifying or vanishing links
@@ -3161,10 +3246,6 @@ static int replmd_modify_handle_linked_a
 	if (ret != LDB_SUCCESS) {
 		return ret;
 	}
-	schema = dsdb_get_schema(ldb, res);
-	if (!schema) {
-		return LDB_ERR_OPERATIONS_ERROR;
-	}
 
 	old_msg = res->msgs[0];
 
@@ -3173,7 +3254,7 @@ static int replmd_modify_handle_linked_a
 		struct ldb_message_element *old_el, *new_el;
 		unsigned int mod_type = LDB_FLAG_MOD_TYPE(el->flags);
 		const struct dsdb_attribute *schema_attr
-			= dsdb_attribute_by_lDAPDisplayName(schema, el->name);
+			= dsdb_attribute_by_lDAPDisplayName(ac->schema, el->name);
 		if (!schema_attr) {
 			ldb_asprintf_errstring(ldb,
 					       "%s: attribute %s is not a valid attribute in schema",
@@ -3209,22 +3290,22 @@ static int replmd_modify_handle_linked_a
 		switch (mod_type) {
 		case LDB_FLAG_MOD_REPLACE:
 			ret = replmd_modify_la_replace(module, replmd_private,
-						       schema, msg, el, old_el,
-						       schema_attr, seq_num, t,
+						       ac, msg, el, old_el,
+						       schema_attr, t,
 						       old_msg->dn,
 						       parent);
 			break;
 		case LDB_FLAG_MOD_DELETE:
 			ret = replmd_modify_la_delete(module, replmd_private,
-						      schema, msg, el, old_el,
-						      schema_attr, seq_num, t,
+						      ac, msg, el, old_el,
+						      schema_attr, t,
 						      old_msg->dn,
 						      parent);
 			break;
 		case LDB_FLAG_MOD_ADD:
 			ret = replmd_modify_la_add(module, replmd_private,
-						   schema, msg, el, old_el,
-						   schema_attr, seq_num, t,
+						   ac, msg, el, old_el,
+						   schema_attr, t,
 						   old_msg->dn,
 						   parent);
 			break;
@@ -3329,6 +3410,8 @@ static int replmd_modify(struct ldb_modu
 	const struct ldb_message_element *guid_el = NULL;
 	struct ldb_control *sd_propagation_control;
 	struct ldb_control *fix_links_control = NULL;
+	struct ldb_control *fix_dn_name_control = NULL;
+	struct ldb_control *fix_dn_sid_control = NULL;
 	struct replmd_private *replmd_private =
 		talloc_get_type(ldb_module_get_private(module), struct replmd_private);
 
@@ -3387,6 +3470,69 @@ static int replmd_modify(struct ldb_modu
 		return ldb_next_request(module, req);
 	}
 
+	fix_dn_name_control = ldb_request_get_control(req,
+					DSDB_CONTROL_DBCHECK_FIX_LINK_DN_NAME);
+	if (fix_dn_name_control != NULL) {
+		struct dsdb_schema *schema = NULL;
+		const struct dsdb_attribute *sa = NULL;
+
+		if (req->op.mod.message->num_elements != 2) {
+			return ldb_module_operr(module);
+		}
+
+		if (req->op.mod.message->elements[0].flags != LDB_FLAG_MOD_DELETE) {
+			return ldb_module_operr(module);
+		}
+
+		if (req->op.mod.message->elements[1].flags != LDB_FLAG_MOD_ADD) {
+			return ldb_module_operr(module);
+		}
+
+		if (req->op.mod.message->elements[0].num_values != 1) {
+			return ldb_module_operr(module);
+		}
+
+		if (req->op.mod.message->elements[1].num_values != 1) {
+			return ldb_module_operr(module);
+		}
+
+		schema = dsdb_get_schema(ldb, req);
+		if (schema == NULL) {
+			return ldb_module_operr(module);
+		}
+
+		if (ldb_attr_cmp(req->op.mod.message->elements[0].name,
+				 req->op.mod.message->elements[1].name) != 0) {
+			return ldb_module_operr(module);
+		}
+
+		sa = dsdb_attribute_by_lDAPDisplayName(schema,
+				req->op.mod.message->elements[0].name);
+		if (sa == NULL) {
+			return ldb_module_operr(module);
+		}
+
+		if (sa->dn_format == DSDB_INVALID_DN) {
+			return ldb_module_operr(module);
+		}
+
+		if (sa->linkID != 0) {
+			return ldb_module_operr(module);
+		}
+
+		/*
+		 * If we are run from dbcheck and we are not updating
+		 * a link (as these would need to be sorted and so
+		 * can't go via such a simple update, then do not
+		 * trigger replicated updates and a new USN from this
+		 * change, it wasn't a real change, just a new
+		 * (correct) string DN
+		 */
+
+		fix_dn_name_control->critical = false;
+		return ldb_next_request(module, req);
+	}
+
 	ldb_debug(ldb, LDB_DEBUG_TRACE, "replmd_modify\n");
 
 	guid_el = ldb_msg_find_element(req->op.mod.message, "objectGUID");
@@ -3411,6 +3557,44 @@ static int replmd_modify(struct ldb_modu
 		return LDB_ERR_OPERATIONS_ERROR;
 	}
 
+	fix_dn_sid_control = ldb_request_get_control(req,
+					DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID);
+	if (fix_dn_sid_control != NULL) {
+		const struct dsdb_attribute *sa = NULL;
+
+		if (msg->num_elements != 1) {
+			talloc_free(ac);
+			return ldb_module_operr(module);
+		}
+
+		if (msg->elements[0].flags != LDB_FLAG_MOD_ADD) {
+			talloc_free(ac);
+			return ldb_module_operr(module);
+		}
+
+		if (msg->elements[0].num_values != 1) {
+			talloc_free(ac);
+			return ldb_module_operr(module);
+		}
+
+		sa = dsdb_attribute_by_lDAPDisplayName(ac->schema,
+				msg->elements[0].name);
+		if (sa == NULL) {
+			talloc_free(ac);
+			return ldb_module_operr(module);
+		}
+
+		if (sa->dn_format != DSDB_NORMAL_DN) {
+			talloc_free(ac);
+			return ldb_module_operr(module);
+		}
+
+		fix_dn_sid_control->critical = false;
+		ac->fix_link_sid = true;
+
+		goto handle_linked_attribs;
+	}
+
 	ldb_msg_remove_attr(msg, "whenChanged");
 	ldb_msg_remove_attr(msg, "uSNChanged");
 
@@ -3431,8 +3615,9 @@ static int replmd_modify(struct ldb_modu
 		return ret;
 	}
 
+ handle_linked_attribs:
 	ret = replmd_modify_handle_linked_attribs(module, replmd_private,
-						  msg, ac->seq_num, t, req);
+						  ac, msg, t, req);
 	if (ret != LDB_SUCCESS) {
 		talloc_free(ac);
 		return ret;
@@ -4182,6 +4367,10 @@ static int replmd_delete_internals(struc
 	     - preserved if in above list, or is rDN
 	  - remove all linked attribs from this object
 	  - remove all links from other objects to this object
+	    (note we use the backlinks to do this, so we won't find one-way
+	     links that still point to this object, or deactivated two-way
+	     links, i.e. 'member' after the user has been removed from the
+	     group)
 	  - add lastKnownParent
 	  - update replPropertyMetaData?
 
@@ -4303,12 +4492,12 @@ static int replmd_delete_internals(struc
 
 			if (sa->linkID & 1) {
 				/*
-				  we have a backlink in this object
-				  that needs to be removed. We're not
-				  allowed to remove it directly
-				  however, so we instead setup a
-				  modify to delete the corresponding
-				  forward link
+				 * we have a backlink in this object
+				 * that needs to be removed. We're not
+				 * allowed to remove it directly
+				 * however, so we instead setup a
+				 * modify to delete the corresponding
+				 * forward link
 				 */
 				ret = replmd_delete_remove_link(module, schema,
 								replmd_private,
@@ -7441,6 +7630,14 @@ static int replmd_delete_link_value(stru
 	/* if the existing link is active, remove its backlink */
 	if (is_active) {
 
+		/*
+		 * NOTE WELL: After this we will never (at runtime) be
+		 * able to find this forward link (for instant
+		 * removal) if/when the link target is deleted.
+		 *
+		 * We have dbcheck rules to cover this and cope otherwise
+		 * by filtering at runtime (i.e. in the extended_dn module).
+		 */
 		ret = replmd_add_backlink(module, replmd_private, schema,
 					  src_obj_dn, target_guid, false,
 					  attr, NULL);
diff -Npur samba-4.8.7/source4/dsdb/samdb/ldb_modules/samldb.c samba-4.8.8/source4/dsdb/samdb/ldb_modules/samldb.c
--- samba-4.8.7/source4/dsdb/samdb/ldb_modules/samldb.c	2018-06-26 16:42:46.000000000 +0200
+++ samba-4.8.8/source4/dsdb/samdb/ldb_modules/samldb.c	2018-12-13 10:08:40.000000000 +0100
@@ -1642,9 +1642,14 @@ static int samldb_prim_group_change(stru
 	struct ldb_result *res, *group_res;
 	struct ldb_message_element *el;
 	struct ldb_message *msg;
+	uint32_t search_flags =
+		DSDB_FLAG_NEXT_MODULE | DSDB_SEARCH_SHOW_EXTENDED_DN;
 	uint32_t prev_rid, new_rid, uac;
 	struct dom_sid *prev_sid, *new_sid;
 	struct ldb_dn *prev_prim_group_dn, *new_prim_group_dn;
+	const char *new_prim_group_dn_ext_str = NULL;
+	struct ldb_dn *user_dn = NULL;
+	const char *user_dn_ext_str = NULL;
 	int ret;
 	const char * const noattrs[] = { NULL };
 
@@ -1658,10 +1663,15 @@ static int samldb_prim_group_change(stru
 	/* Fetch information from the existing object */
 
 	ret = dsdb_module_search_dn(ac->module, ac, &res, ac->msg->dn, attrs,
-				    DSDB_FLAG_NEXT_MODULE, ac->req);
+				    search_flags, ac->req);
 	if (ret != LDB_SUCCESS) {
 		return ret;
 	}
+	user_dn = res->msgs[0]->dn;
+	user_dn_ext_str = ldb_dn_get_extended_linearized(ac, user_dn, 1);
+	if (user_dn_ext_str == NULL) {
+		return ldb_operr(ldb);
+	}
 
 	uac = ldb_msg_find_attr_as_uint(res->msgs[0], "userAccountControl", 0);
 
@@ -1725,7 +1735,7 @@ static int samldb_prim_group_change(stru
 	ret = dsdb_module_search(ac->module, ac, &group_res,
 				 ldb_get_default_basedn(ldb),
 				 LDB_SCOPE_SUBTREE,
-				 noattrs, DSDB_FLAG_NEXT_MODULE,
+				 noattrs, search_flags,
 				 ac->req,
 				 "(objectSid=%s)",
 				 ldap_encode_ndr_dom_sid(ac, prev_sid));
@@ -1745,7 +1755,7 @@ static int samldb_prim_group_change(stru
 	ret = dsdb_module_search(ac->module, ac, &group_res,
 				 ldb_get_default_basedn(ldb),
 				 LDB_SCOPE_SUBTREE,
-				 noattrs, DSDB_FLAG_NEXT_MODULE,
+				 noattrs, search_flags,
 				 ac->req,
 				 "(objectSid=%s)",
 				 ldap_encode_ndr_dom_sid(ac, new_sid));
@@ -1758,11 +1768,16 @@ static int samldb_prim_group_change(stru
 		return LDB_ERR_UNWILLING_TO_PERFORM;
 	}
 	new_prim_group_dn = group_res->msgs[0]->dn;
+	new_prim_group_dn_ext_str = ldb_dn_get_extended_linearized(ac,
+							new_prim_group_dn, 1);
+	if (new_prim_group_dn_ext_str == NULL) {
+		return ldb_operr(ldb);
+	}
 
 	/* We need to be already a normal member of the new primary
 	 * group in order to be successful. */
 	el = samdb_find_attribute(ldb, res->msgs[0], "memberOf",
-				  ldb_dn_get_linearized(new_prim_group_dn));
+				  new_prim_group_dn_ext_str);
 	if (el == NULL) {
 		return LDB_ERR_UNWILLING_TO_PERFORM;
 	}
@@ -1774,8 +1789,7 @@ static int samldb_prim_group_change(stru
 	}
 	msg->dn = new_prim_group_dn;
 
-	ret = samdb_msg_add_delval(ldb, msg, msg, "member",
-				   ldb_dn_get_linearized(ac->msg->dn));
+	ret = samdb_msg_add_delval(ldb, msg, msg, "member", user_dn_ext_str);
 	if (ret != LDB_SUCCESS) {
 		return ret;
 	}
@@ -1793,8 +1807,7 @@ static int samldb_prim_group_change(stru
 	}
 	msg->dn = prev_prim_group_dn;
 
-	ret = samdb_msg_add_addval(ldb, msg, msg, "member",
-				   ldb_dn_get_linearized(ac->msg->dn));
+	ret = samdb_msg_add_addval(ldb, msg, msg, "member", user_dn_ext_str);
 	if (ret != LDB_SUCCESS) {
 		return ret;
 	}
@@ -3770,9 +3783,15 @@ static int samldb_modify(struct ldb_modu
 
 	el = ldb_msg_find_element(ac->msg, "member");
 	if (el != NULL) {
-		ret = samldb_member_check(ac);
-		if (ret != LDB_SUCCESS) {
-			return ret;
+		struct ldb_control *fix_link_sid_ctrl = NULL;
+
+		fix_link_sid_ctrl = ldb_request_get_control(ac->req,
+					DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID);
+		if (fix_link_sid_ctrl == NULL) {
+			ret = samldb_member_check(ac);
+			if (ret != LDB_SUCCESS) {
+				return ret;
+			}
 		}
 	}
 
diff -Npur samba-4.8.7/source4/dsdb/samdb/samdb.h samba-4.8.8/source4/dsdb/samdb/samdb.h
--- samba-4.8.7/source4/dsdb/samdb/samdb.h	2018-03-13 20:05:54.000000000 +0100
+++ samba-4.8.8/source4/dsdb/samdb/samdb.h	2018-12-13 10:08:40.000000000 +0100
@@ -130,6 +130,12 @@ struct dsdb_control_password_change {
 /* passed by dbcheck to fix duplicate linked attributes (bug #13095) */
 #define DSDB_CONTROL_DBCHECK_FIX_DUPLICATE_LINKS "1.3.6.1.4.1.7165.4.3.19.2"
 
+/* passed by dbcheck to fix the DN string of a one-way-link (bug #13495) */
+#define DSDB_CONTROL_DBCHECK_FIX_LINK_DN_NAME "1.3.6.1.4.1.7165.4.3.19.3"
+
+/* passed by dbcheck to fix the DN SID of a one-way-link (bug #13418) */
+#define DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID "1.3.6.1.4.1.7165.4.3.19.4"
+
 /* passed when importing plain text password on upgrades */
 #define DSDB_CONTROL_PASSWORD_BYPASS_LAST_SET_OID "1.3.6.1.4.1.7165.4.3.20"
 
diff -Npur samba-4.8.7/source4/kdc/mit-kdb/kdb_samba_policies.c samba-4.8.8/source4/kdc/mit-kdb/kdb_samba_policies.c
--- samba-4.8.7/source4/kdc/mit-kdb/kdb_samba_policies.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.8/source4/kdc/mit-kdb/kdb_samba_policies.c	2018-12-13 10:08:40.000000000 +0100
@@ -81,6 +81,7 @@ krb5_error_code kdb_samba_db_check_polic
 	char *netbios_name = NULL;
 	char *realm = NULL;
 	bool password_change = false;
+	krb5_const_principal client_princ;
 	DATA_BLOB int_data = { NULL, 0 };
 	krb5_data d;
 	krb5_pa_data **e_data;
@@ -90,7 +91,10 @@ krb5_error_code kdb_samba_db_check_polic
 		return KRB5_KDB_DBNOTINITED;
 	}
 
-	if (ks_is_kadmin(context, kdcreq->client)) {
+	/* Prefer canonicalised name from client entry */
+	client_princ = client ? client->princ : kdcreq->client;
+
+	if (client_princ == NULL || ks_is_kadmin(context, client_princ)) {
 		return KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN;
 	}
 
@@ -111,7 +115,7 @@ krb5_error_code kdb_samba_db_check_polic
 		goto done;
 	}
 
-	code = krb5_unparse_name(context, kdcreq->client, &client_name);
+	code = krb5_unparse_name(context, client_princ, &client_name);
 	if (code) {
 		goto done;
 	}
@@ -457,6 +461,14 @@ void kdb_samba_db_audit_as_req(krb5_cont
 			       krb5_timestamp authtime,
 			       krb5_error_code error_code)
 {
+	/*
+	 * FIXME: This segfaulted with a FAST test
+	 * FIND_FAST: <unknown client> for <unknown server>, Unknown FAST armor type 0
+	 */
+	if (client == NULL) {
+		return;
+	}
+
 	samba_bad_password_count(client, error_code);
 
 	/* TODO: perform proper audit logging for addresses */
@@ -469,6 +481,14 @@ void kdb_samba_db_audit_as_req(krb5_cont
 			       krb5_timestamp authtime,
 			       krb5_error_code error_code)
 {
+	/*
+	 * FIXME: This segfaulted with a FAST test
+	 * FIND_FAST: <unknown client> for <unknown server>, Unknown FAST armor type 0
+	 */
+	if (client == NULL) {
+		return;
+	}
+
 	samba_bad_password_count(client, error_code);
 }
 #endif
diff -Npur samba-4.8.7/source4/kdc/mit_samba.c samba-4.8.8/source4/kdc/mit_samba.c
--- samba-4.8.7/source4/kdc/mit_samba.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.8/source4/kdc/mit_samba.c	2018-12-13 10:08:40.000000000 +0100
@@ -855,7 +855,7 @@ krb5_error_code encode_krb5_padata_seque
 static void samba_kdc_build_edata_reply(NTSTATUS nt_status, DATA_BLOB *e_data)
 {
 	krb5_error_code ret = 0;
-	krb5_pa_data pa, *ppa = NULL;
+	krb5_pa_data pa, *ppa[2];
 	krb5_data *d = NULL;
 
 	if (!e_data)
@@ -876,9 +876,10 @@ static void samba_kdc_build_edata_reply(
 	SIVAL(pa.contents, 4, 0);
 	SIVAL(pa.contents, 8, 1);
 
-	ppa = &pa;
+	ppa[0] = &pa;
+	ppa[1] = NULL;
 
-	ret = encode_krb5_padata_sequence(&ppa, &d);
+	ret = encode_krb5_padata_sequence(ppa, &d);
 	free(pa.contents);
 	if (ret) {
 		return;
diff -Npur samba-4.8.7/source4/libcli/smb2/transport.c samba-4.8.8/source4/libcli/smb2/transport.c
--- samba-4.8.7/source4/libcli/smb2/transport.c	2018-08-24 09:58:20.000000000 +0200
+++ samba-4.8.8/source4/libcli/smb2/transport.c	2018-12-13 10:08:40.000000000 +0100
@@ -293,7 +293,24 @@ static void smb2_request_done(struct tev
 
 	req->status = smb2cli_req_recv(req->subreq, req, &req->recv_iov, NULL, 0);
 	if (NT_STATUS_EQUAL(req->status, STATUS_PENDING)) {
+		struct timeval endtime = smbXcli_req_endtime(subreq);
+		bool ok;
+
 		req->cancel.can_cancel = true;
+		if (timeval_is_zero(&endtime)) {
+			return;
+		}
+
+		ok = tevent_req_set_endtime(
+			subreq, req->transport->ev, endtime);
+		if (!ok) {
+			req->status = NT_STATUS_INTERNAL_ERROR;
+			req->state = SMB2_REQUEST_ERROR;
+			if (req->async.fn) {
+				req->async.fn(req);
+			}
+			return;
+		}
 		return;
 	}
 	TALLOC_FREE(req->subreq);
diff -Npur samba-4.8.7/source4/selftest/tests.py samba-4.8.8/source4/selftest/tests.py
--- samba-4.8.7/source4/selftest/tests.py	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/source4/selftest/tests.py	2018-12-13 10:08:40.000000000 +0100
@@ -318,6 +318,7 @@ smb2_s3only = [
     "smb2.credits",
     "smb2.kernel-oplocks",
     "smb2.durable-v2-delay",
+    "smb2.aio_delay",
 ]
 smb2 = [x for x in smbtorture4_testsuites("smb2.") if x not in smb2_s3only]
 
@@ -406,6 +407,8 @@ for env in ["ad_member", "s4member", "ad
 plantestsuite("samba4.blackbox.samba_tool(ad_dc_ntvfs:local)", "ad_dc_ntvfs:local", [os.path.join(samba4srcdir, "utils/tests/test_samba_tool.sh"), '$SERVER', '$SERVER_IP', '$USERNAME', '$PASSWORD', '$DOMAIN', smbclient4])
 plantestsuite("samba4.blackbox.net_rpc_user(ad_dc)", "ad_dc", [os.path.join(bbdir, "test_net_rpc_user.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$DOMAIN'])
 
+plantestsuite("samba4.blackbox.test_primary_group", "ad_dc:local", [os.path.join(bbdir, "test_primary_group.sh"), '$SERVER', '$USERNAME', '$PASSWORD', '$DOMAIN', '$PREFIX_ABS'])
+
 if have_heimdal_support:
     for env in ["ad_dc_ntvfs", "ad_dc"]:
         plantestsuite("samba4.blackbox.pkinit(%s:local)" % env, "%s:local" % env, [os.path.join(bbdir, "test_pkinit_heimdal.sh"), '$SERVER', 'pkinit', '$PASSWORD', '$REALM', '$DOMAIN', '$PREFIX/%s' % env, "aes256-cts-hmac-sha1-96", smbclient4, configuration])
diff -Npur samba-4.8.7/source4/setup/schema_samba4.ldif samba-4.8.8/source4/setup/schema_samba4.ldif
--- samba-4.8.7/source4/setup/schema_samba4.ldif	2018-03-13 20:05:54.000000000 +0100
+++ samba-4.8.8/source4/setup/schema_samba4.ldif	2018-12-13 10:08:40.000000000 +0100
@@ -214,6 +214,8 @@
 #Allocated: DSDB_CONTROL_DBCHECK 1.3.6.1.4.1.7165.4.3.19
 #Allocated: DSDB_CONTROL_DBCHECK_MODIFY_RO_REPLICA 1.3.6.1.4.1.7165.4.3.19.1
 #Allocated: DSDB_CONTROL_DBCHECK_FIX_DUPLICATE_LINKS 1.3.6.1.4.1.7165.4.3.19.2
+#Allocated: DSDB_CONTROL_DBCHECK_FIX_LINK_DN_NAME 1.3.6.1.4.1.7165.4.3.19.3
+#Allocated: DSDB_CONTROL_DBCHECK_FIX_LINK_DN_SID 1.3.6.1.4.1.7165.4.3.19.4
 #Allocated: DSDB_CONTROL_PASSWORD_BYPASS_LAST_SET_OID 1.3.6.1.4.1.7165.4.3.20
 #Allocated: DSDB_CONTROL_SEC_DESC_PROPAGATION_OID 1.3.6.1.4.1.7165.4.3.21
 #Allocated: DSDB_CONTROL_PERMIT_INTERDOMAIN_TRUST_UAC_OID 1.3.6.1.4.1.7165.4.3.23
diff -Npur samba-4.8.7/source4/torture/smb2/delete-on-close.c samba-4.8.8/source4/torture/smb2/delete-on-close.c
--- samba-4.8.7/source4/torture/smb2/delete-on-close.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.8/source4/torture/smb2/delete-on-close.c	2018-12-13 10:08:40.000000000 +0100
@@ -580,6 +580,124 @@ static bool test_doc_find_and_set_doc(st
 	return true;
 }
 
+static bool test_doc_read_only(struct torture_context *tctx,
+			       struct smb2_tree *tree)
+{
+	struct smb2_handle dir_handle;
+	union smb_setfileinfo sfinfo = { };
+	struct smb2_create create = { };
+	struct smb2_close close = { };
+	NTSTATUS status, expected_status;
+	bool ret = true, delete_readonly;
+
+	/*
+	 * Allow testing of the Samba 'delete readonly' option.
+	 */
+	delete_readonly = torture_setting_bool(tctx, "delete_readonly", false);
+	expected_status = delete_readonly ?
+		NT_STATUS_OK : NT_STATUS_CANNOT_DELETE;
+
+	smb2_deltree(tree, DNAME);
+
+	status = torture_smb2_testdir(tree, DNAME, &dir_handle);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CREATE directory failed\n");
+
+	create = (struct smb2_create) { };
+	create.in.desired_access = SEC_RIGHTS_DIR_ALL;
+	create.in.create_options = NTCREATEX_OPTIONS_NON_DIRECTORY_FILE |
+		NTCREATEX_OPTIONS_DELETE_ON_CLOSE;
+	create.in.file_attributes = FILE_ATTRIBUTE_READONLY;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_CREATE;
+	create.in.fname = FNAME;
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(tctx, status, expected_status, ret,
+					   done, "Unexpected status for CREATE "
+					   "of new file.\n");
+
+	if (delete_readonly) {
+		close.in.file.handle = create.out.file.handle;
+		status = smb2_close(tree, &close);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"CLOSE of READONLY file "
+						"failed.\n");
+	}
+
+	torture_comment(tctx, "Creating file with READ_ONLY attribute.\n");
+
+	create = (struct smb2_create) { };
+	create.in.desired_access = SEC_RIGHTS_DIR_ALL;
+	create.in.create_options = NTCREATEX_OPTIONS_NON_DIRECTORY_FILE;
+	create.in.file_attributes = FILE_ATTRIBUTE_READONLY;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_CREATE;
+	create.in.fname = FNAME;
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CREATE of READONLY file failed.\n");
+
+	close.in.file.handle = create.out.file.handle;
+	status = smb2_close(tree, &close);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CLOSE of READONLY file failed.\n");
+
+	torture_comment(tctx, "Testing CREATE with DELETE_ON_CLOSE on "
+			"READ_ONLY attribute file.\n");
+
+	create = (struct smb2_create) { };
+	create.in.desired_access = SEC_RIGHTS_FILE_READ | SEC_STD_DELETE;
+	create.in.create_options = NTCREATEX_OPTIONS_DELETE_ON_CLOSE;
+	create.in.file_attributes = 0;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = FNAME;
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   expected_status, ret, done,
+					   "CREATE returned unexpected "
+					   "status.\n");
+
+	torture_comment(tctx, "Testing setting DELETE_ON_CLOSE disposition on "
+			" file with READONLY attribute.\n");
+
+	create = (struct smb2_create) { };
+	create.in.desired_access = SEC_RIGHTS_FILE_READ | SEC_STD_DELETE;;
+	create.in.create_options = 0;
+	create.in.file_attributes = 0;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_READ |
+		NTCREATEX_SHARE_ACCESS_WRITE |
+		NTCREATEX_SHARE_ACCESS_DELETE;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = FNAME;
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"Opening file failed.\n");
+
+	sfinfo.disposition_info.in.delete_on_close = 1;
+	sfinfo.generic.level = RAW_SFILEINFO_DISPOSITION_INFORMATION;
+	sfinfo.generic.in.file.handle = create.out.file.handle;
+
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_equal(tctx, status, expected_status,
+				      "Set DELETE_ON_CLOSE disposition "
+				      "returned un expected status.\n");
+
+	status = smb2_util_close(tree, create.out.file.handle);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"CLOSE failed\n");
+
+done:
+	smb2_deltree(tree, DNAME);
+	return ret;
+}
+
 
 /*
  *  Extreme testing of Delete On Close and permissions
@@ -595,6 +713,7 @@ struct torture_suite *torture_smb2_doc_i
 	torture_suite_add_1smb2_test(suite, "CREATE_IF", test_doc_create_if);
 	torture_suite_add_1smb2_test(suite, "CREATE_IF Existing", test_doc_create_if_exist);
 	torture_suite_add_1smb2_test(suite, "FIND_and_set_DOC", test_doc_find_and_set_doc);
+	torture_suite_add_1smb2_test(suite,  "READONLY", test_doc_read_only);
 
 	suite->description = talloc_strdup(suite, "SMB2-Delete-on-Close-Perms tests");
 
diff -Npur samba-4.8.7/source4/torture/smb2/read.c samba-4.8.8/source4/torture/smb2/read.c
--- samba-4.8.7/source4/torture/smb2/read.c	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.8/source4/torture/smb2/read.c	2018-12-13 10:08:40.000000000 +0100
@@ -22,6 +22,7 @@
 #include "includes.h"
 #include "libcli/smb2/smb2.h"
 #include "libcli/smb2/smb2_calls.h"
+#include <tevent.h>
 
 #include "torture/torture.h"
 #include "torture/smb2/proto.h"
@@ -317,3 +318,118 @@ struct torture_suite *torture_smb2_read_
 	return suite;
 }
 
+static bool test_aio_cancel(struct torture_context *tctx,
+			    struct smb2_tree *tree)
+{
+	struct smb2_handle h;
+	uint8_t buf[64 * 1024];
+	struct smb2_read r;
+	struct smb2_request *req = NULL;
+	int rc;
+	NTSTATUS status;
+	bool ret = true;
+
+	ZERO_STRUCT(buf);
+
+	smb2_util_unlink(tree, FNAME);
+
+	status = torture_smb2_testfile(tree, FNAME, &h);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"torture_smb2_testfile failed\n");
+
+	status = smb2_util_write(tree, h, buf, 0, ARRAY_SIZE(buf));
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"smb2_util_write failed\n");
+
+	status = smb2_util_close(tree, h);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"smb2_util_close failed\n");
+
+	status = torture_smb2_testfile_access(
+		tree, FNAME, &h, SEC_RIGHTS_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"torture_smb2_testfile_access failed\n");
+
+	r = (struct smb2_read) {
+		.in.file.handle = h,
+		.in.length      = 1,
+		.in.offset      = 0,
+		.in.min_count   = 1,
+	};
+
+	req = smb2_read_send(tree, &r);
+	torture_assert_goto(
+		tctx,
+		req != NULL,
+		ret,
+		done,
+		"smb2_read_send failed\n");
+
+	while (!req->cancel.can_cancel) {
+		rc = tevent_loop_once(tctx->ev);
+		torture_assert_goto(
+			tctx,
+			rc == 0,
+			ret,
+			done,
+			"tevent_loop_once failed\n");
+	}
+
+	status = smb2_cancel(req);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"smb2_cancel failed\n");
+
+	status = smb2_read_recv(req, tree, &r);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"smb2_read_recv failed\n");
+
+	status = smb2_util_close(tree, h);
+	torture_assert_ntstatus_ok_goto(
+		tctx,
+		status,
+		ret,
+		done,
+		"smb2_util_close failed\n");
+
+done:
+	smb2_util_unlink(tree, FNAME);
+	return ret;
+}
+
+/*
+ * aio testing against share with VFS module "delay_inject"
+ */
+struct torture_suite *torture_smb2_aio_delay_init(TALLOC_CTX *ctx)
+{
+	struct torture_suite *suite = torture_suite_create(ctx, "aio_delay");
+
+	torture_suite_add_1smb2_test(suite, "aio_cancel", test_aio_cancel);
+
+	suite->description = talloc_strdup(suite, "SMB2 delayed aio tests");
+
+	return suite;
+}
diff -Npur samba-4.8.7/source4/torture/smb2/session.c samba-4.8.8/source4/torture/smb2/session.c
--- samba-4.8.7/source4/torture/smb2/session.c	2018-10-15 08:57:23.000000000 +0200
+++ samba-4.8.8/source4/torture/smb2/session.c	2018-12-13 10:08:40.000000000 +0100
@@ -1046,7 +1046,9 @@ done:
 }
 
 
-static bool test_session_expire1(struct torture_context *tctx)
+static bool test_session_expire1i(struct torture_context *tctx,
+				  bool force_signing,
+				  bool force_encryption)
 {
 	NTSTATUS status;
 	bool ret = false;
@@ -1072,9 +1074,14 @@ static bool test_session_expire1(struct
 	torture_assert_int_equal(tctx, use_kerberos, CRED_MUST_USE_KERBEROS,
 				 "please use -k yes");
 
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
 	lpcfg_set_option(tctx->lp_ctx, "gensec_gssapi:requested_life_time=4");
 
 	lpcfg_smbcli_options(tctx->lp_ctx, &options);
+	if (force_signing) {
+		options.signing = SMB_SIGNING_REQUIRED;
+	}
 
 	status = smb2_connect(tctx,
 			      host,
@@ -1091,6 +1098,12 @@ static bool test_session_expire1(struct
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"smb2_connect failed");
 
+	if (force_encryption) {
+		status = smb2cli_session_encryption_on(tree->session->smbXcli);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2cli_session_encryption_on failed");
+	}
+
 	/* Add some random component to the file name. */
 	snprintf(fname, sizeof(fname), "session_expire1_%s.dat",
 		 generate_random_str(tctx, 8));
@@ -1144,12 +1157,20 @@ static bool test_session_expire1(struct
 		 */
 		cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
 
+		if (!force_encryption) {
+			smb2cli_session_require_signed_response(
+				tree->session->smbXcli, true);
+		}
+
 		torture_comment(tctx, "reauth => OK\n");
 		status = smb2_session_setup_spnego(tree->session,
 						   credentials,
 						   0 /* previous_session_id */);
 		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"smb2_session_setup_spnego failed");
+
+		smb2cli_session_require_signed_response(
+			tree->session->smbXcli, false);
 	}
 
 	ZERO_STRUCT(qfinfo.access_information.out);
@@ -1159,6 +1180,8 @@ static bool test_session_expire1(struct
 
 	ret = true;
 done:
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
 	if (h1 != NULL) {
 		smb2_util_close(tree, *h1);
 	}
@@ -1168,7 +1191,29 @@ done:
 	return ret;
 }
 
-static bool test_session_expire2(struct torture_context *tctx)
+static bool test_session_expire1n(struct torture_context *tctx)
+{
+	return test_session_expire1i(tctx,
+				     false,   /* force_signing */
+				     false); /* force_encryption */
+}
+
+static bool test_session_expire1s(struct torture_context *tctx)
+{
+	return test_session_expire1i(tctx,
+				     true,   /* force_signing */
+				     false); /* force_encryption */
+}
+
+static bool test_session_expire1e(struct torture_context *tctx)
+{
+	return test_session_expire1i(tctx,
+				     true,   /* force_signing */
+				     true); /* force_encryption */
+}
+
+static bool test_session_expire2i(struct torture_context *tctx,
+				  bool force_encryption)
 {
 	NTSTATUS status;
 	bool ret = false;
@@ -1215,9 +1260,12 @@ static bool test_session_expire2(struct
 	torture_assert_int_equal(tctx, use_kerberos, CRED_MUST_USE_KERBEROS,
 				 "please use -k yes");
 
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
 	lpcfg_set_option(tctx->lp_ctx, "gensec_gssapi:requested_life_time=4");
 
 	lpcfg_smbcli_options(tctx->lp_ctx, &options);
+	options.signing = SMB_SIGNING_REQUIRED;
 
 	unc = talloc_asprintf(tctx, "\\\\%s\\%s", host, share);
 	torture_assert(tctx, unc != NULL, "talloc_asprintf");
@@ -1237,6 +1285,12 @@ static bool test_session_expire2(struct
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"smb2_connect failed");
 
+	if (force_encryption) {
+		status = smb2cli_session_encryption_on(tree->session->smbXcli);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2cli_session_encryption_on failed");
+	}
+
 	caps = smb2cli_conn_server_capabilities(tree->session->transport->conn);
 
 	/* Add some random component to the file name. */
@@ -1519,6 +1573,128 @@ static bool test_session_expire2(struct
 
 	ret = true;
 done:
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
+	if (h1 != NULL) {
+		smb2_util_close(tree, *h1);
+	}
+
+	talloc_free(tree);
+	lpcfg_set_option(tctx->lp_ctx, "gensec_gssapi:requested_life_time=0");
+	return ret;
+}
+
+static bool test_session_expire2s(struct torture_context *tctx)
+{
+	return test_session_expire2i(tctx,
+				     false); /* force_encryption */
+}
+
+static bool test_session_expire2e(struct torture_context *tctx)
+{
+	return test_session_expire2i(tctx,
+				     true); /* force_encryption */
+}
+
+static bool test_session_expire_disconnect(struct torture_context *tctx)
+{
+	NTSTATUS status;
+	bool ret = false;
+	struct smbcli_options options;
+	const char *host = torture_setting_string(tctx, "host", NULL);
+	const char *share = torture_setting_string(tctx, "share", NULL);
+	struct cli_credentials *credentials = popt_get_cmdline_credentials();
+	struct smb2_tree *tree = NULL;
+	enum credentials_use_kerberos use_kerberos;
+	char fname[256];
+	struct smb2_handle _h1;
+	struct smb2_handle *h1 = NULL;
+	struct smb2_create io1;
+	union smb_fileinfo qfinfo;
+	bool connected;
+
+	use_kerberos = cli_credentials_get_kerberos_state(credentials);
+	if (use_kerberos != CRED_MUST_USE_KERBEROS) {
+		torture_warning(tctx, "smb2.session.expire1 requires -k yes!");
+		torture_skip(tctx, "smb2.session.expire1 requires -k yes!");
+	}
+
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
+	lpcfg_set_option(tctx->lp_ctx, "gensec_gssapi:requested_life_time=4");
+	lpcfg_smbcli_options(tctx->lp_ctx, &options);
+	options.signing = SMB_SIGNING_REQUIRED;
+
+	status = smb2_connect(tctx,
+			      host,
+			      lpcfg_smb_ports(tctx->lp_ctx),
+			      share,
+			      lpcfg_resolve_context(tctx->lp_ctx),
+			      credentials,
+			      &tree,
+			      tctx->ev,
+			      &options,
+			      lpcfg_socket_options(tctx->lp_ctx),
+			      lpcfg_gensec_settings(tctx, tctx->lp_ctx)
+			      );
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_connect failed");
+
+	smbXcli_session_set_disconnect_expired(tree->session->smbXcli);
+
+	/* Add some random component to the file name. */
+	snprintf(fname, sizeof(fname), "session_expire1_%s.dat",
+		 generate_random_str(tctx, 8));
+
+	smb2_util_unlink(tree, fname);
+
+	smb2_oplock_create_share(&io1, fname,
+				 smb2_util_share_access(""),
+				 smb2_util_oplock_level("b"));
+	io1.in.create_options |= NTCREATEX_OPTIONS_DELETE_ON_CLOSE;
+
+	status = smb2_create(tree, tctx, &io1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed");
+	_h1 = io1.out.file.handle;
+	h1 = &_h1;
+	CHECK_CREATED(tctx, &io1, CREATED, FILE_ATTRIBUTE_ARCHIVE);
+	torture_assert_int_equal(tctx, io1.out.oplock_level,
+					smb2_util_oplock_level("b"),
+					"oplock_level incorrect");
+
+	/* get the security descriptor */
+
+	ZERO_STRUCT(qfinfo);
+
+	qfinfo.access_information.level = RAW_FILEINFO_ACCESS_INFORMATION;
+	qfinfo.access_information.in.file.handle = _h1;
+
+	torture_comment(tctx, "query info => OK\n");
+
+	ZERO_STRUCT(qfinfo.access_information.out);
+	status = smb2_getinfo_file(tree, tctx, &qfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_getinfo_file failed");
+
+	torture_comment(tctx, "sleep 10 seconds\n");
+	smb_msleep(10*1000);
+
+	torture_comment(tctx, "query info => EXPIRED\n");
+	ZERO_STRUCT(qfinfo.access_information.out);
+	status = smb2_getinfo_file(tree, tctx, &qfinfo);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   NT_STATUS_NETWORK_SESSION_EXPIRED,
+					   ret, done, "smb2_getinfo_file "
+					   "returned unexpected status");
+
+	connected = smbXcli_conn_is_connected(tree->session->transport->conn);
+	torture_assert_goto(tctx, !connected, ret, done, "connected\n");
+
+	ret = true;
+done:
+	cli_credentials_invalidate_ccache(credentials, CRED_SPECIFIED);
+
 	if (h1 != NULL) {
 		smb2_util_close(tree, *h1);
 	}
@@ -1681,8 +1857,13 @@ struct torture_suite *torture_smb2_sessi
 	torture_suite_add_1smb2_test(suite, "reauth4", test_session_reauth4);
 	torture_suite_add_1smb2_test(suite, "reauth5", test_session_reauth5);
 	torture_suite_add_1smb2_test(suite, "reauth6", test_session_reauth6);
-	torture_suite_add_simple_test(suite, "expire1", test_session_expire1);
-	torture_suite_add_simple_test(suite, "expire2", test_session_expire2);
+	torture_suite_add_simple_test(suite, "expire1n", test_session_expire1n);
+	torture_suite_add_simple_test(suite, "expire1s", test_session_expire1s);
+	torture_suite_add_simple_test(suite, "expire1e", test_session_expire1e);
+	torture_suite_add_simple_test(suite, "expire2s", test_session_expire2s);
+	torture_suite_add_simple_test(suite, "expire2e", test_session_expire2e);
+	torture_suite_add_simple_test(suite, "expire_disconnect",
+				      test_session_expire_disconnect);
 	torture_suite_add_1smb2_test(suite, "bind1", test_session_bind1);
 
 	suite->description = talloc_strdup(suite, "SMB2-SESSION tests");
diff -Npur samba-4.8.7/source4/torture/smb2/smb2.c samba-4.8.8/source4/torture/smb2/smb2.c
--- samba-4.8.7/source4/torture/smb2/smb2.c	2018-10-09 09:46:34.000000000 +0200
+++ samba-4.8.8/source4/torture/smb2/smb2.c	2018-12-13 10:08:40.000000000 +0100
@@ -152,6 +152,7 @@ NTSTATUS torture_smb2_init(TALLOC_CTX *c
 	torture_suite_add_simple_test(suite, "setinfo", torture_smb2_setinfo);
 	torture_suite_add_suite(suite, torture_smb2_lock_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_read_init(suite));
+	torture_suite_add_suite(suite, torture_smb2_aio_delay_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_create_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_acls_init(suite));
 	torture_suite_add_suite(suite, torture_smb2_notify_init(suite));
diff -Npur samba-4.8.7/source4/torture/smb2/util.c samba-4.8.8/source4/torture/smb2/util.c
--- samba-4.8.7/source4/torture/smb2/util.c	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source4/torture/smb2/util.c	2018-12-13 10:08:40.000000000 +0100
@@ -528,6 +528,36 @@ NTSTATUS torture_smb2_testfile(struct sm
 }
 
 /*
+  create and return a handle to a test file
+  with a specific access mask
+*/
+NTSTATUS torture_smb2_open(struct smb2_tree *tree,
+			   const char *fname,
+			   uint32_t desired_access,
+			   struct smb2_handle *handle)
+{
+	struct smb2_create io;
+	NTSTATUS status;
+
+	io = (struct smb2_create) {
+		.in.fname = fname,
+		.in.desired_access = desired_access,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_MASK,
+	};
+
+	status = smb2_create(tree, tree, &io);
+	if (!NT_STATUS_IS_OK(status)) {
+		return status;
+	}
+
+	*handle = io.out.file.handle;
+
+	return NT_STATUS_OK;
+}
+
+/*
   create and return a handle to a test directory
   with specific desired access
 */
diff -Npur samba-4.8.7/source4/torture/vfs/fruit.c samba-4.8.8/source4/torture/vfs/fruit.c
--- samba-4.8.7/source4/torture/vfs/fruit.c	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source4/torture/vfs/fruit.c	2018-12-13 10:08:40.000000000 +0100
@@ -886,6 +886,147 @@ static char osx_adouble_w_xattr[] = {
 	0x00, 0x00, 0x00, 0x1c, 0x00, 0x1e, 0xff, 0xff
 };
 
+/*
+ * The buf below contains the following AppleDouble encoded data:
+ *
+ * -------------------------------------------------------------------------------
+ * MagicNumber: 00051607                                        : AppleDouble
+ * Version    : 00020000                                        : Version 2
+ * Filler     : 4D 61 63 20 4F 53 20 58 20 20 20 20 20 20 20 20 : Mac OS X
+ * Num. of ent: 0002                                            : 2
+ *
+ * -------------------------------------------------------------------------------
+ * Entry ID   : 00000002 : Resource Fork
+ * Offset     : 00000052 : 82
+ * Length     : 0000011E : 286
+ *
+ * -RAW DUMP--:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+ * 00000000   : 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 1E : ................
+ * 00000010   : 54 68 69 73 20 72 65 73 6F 75 72 63 65 20 66 6F : This resource fo
+ * 00000020   : 72 6B 20 69 6E 74 65 6E 74 69 6F 6E 61 6C 6C 79 : rk intentionally
+ * 00000030   : 20 6C 65 66 74 20 62 6C 61 6E 6B 20 20 20 00 00 :  left blank   ..
+ * 00000040   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000050   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000060   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000070   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000080   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000090   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000A0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000B0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000C0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000D0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000E0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 000000F0   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ * 00000100   : 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 1E : ................
+ * 00000110   : 00 00 00 00 00 00 00 00 00 1C 00 1E FF FF       : ..............
+ *
+ * Entry ID   : 00000009 : Finder Info
+ * Offset     : 00000032 : 50
+ * Length     : 00000020 : 32
+ *
+ * -NOTE------: cannot detect whether FInfo or DInfo. assume FInfo.
+ *
+ * -FInfo-----:
+ * Type       : 57415645 : WAVE
+ * Creator    : 5054756C : PTul
+ * isAlias    : 0
+ * Invisible  : 0
+ * hasBundle  : 0
+ * nameLocked : 0
+ * Stationery : 0
+ * CustomIcon : 0
+ * Reserved   : 0
+ * Inited     : 0
+ * NoINITS    : 0
+ * Shared     : 0
+ * SwitchLaunc: 0
+ * Hidden Ext : 0
+ * color      : 000      : none
+ * isOnDesk   : 0
+ * Location v : 0000     : 0
+ * Location h : 0000     : 0
+ * Fldr       : 0000     : ..
+ *
+ * -FXInfo----:
+ * Rsvd|IconID: 0000     : 0
+ * Rsvd       : 0000     : ..
+ * Rsvd       : 0000     : ..
+ * Rsvd       : 0000     : ..
+ * AreInvalid : 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * CustomBadge: 0
+ * ObjctIsBusy: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * RoutingInfo: 0
+ * unknown bit: 0
+ * unknown bit: 0
+ * Rsvd|commnt: 0000     : 0
+ * PutAway    : 00000000 : 0
+ *
+ * -RAW DUMP--:  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F : (ASCII)
+ * 00000000   : 57 41 56 45 50 54 75 6C 00 00 00 00 00 00 00 00 : WAVEPTul........
+ * 00000010   : 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 : ................
+ *  *
+ * It was created with:
+ * $ hexdump -ve '"\t" 7/1 "0x%02x, " 1/1 " 0x%02x," "\n"'
+ */
+static char osx_adouble_without_xattr[] = {
+	0x00, 0x05, 0x16, 0x07, 0x00, 0x02, 0x00, 0x00,
+	0x4d, 0x61, 0x63, 0x20, 0x4f, 0x53, 0x20, 0x58,
+	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
+	0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
+	0x00, 0x52, 0x00, 0x00, 0x01, 0x1e, 0x00, 0x00,
+	0x00, 0x09, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00,
+	0x00, 0x20, 0x57, 0x41, 0x56, 0x45, 0x50, 0x54,
+	0x75, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
+	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x1e, 0x54, 0x68, 0x69, 0x73, 0x20, 0x72,
+	0x65, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x20,
+	0x66, 0x6f, 0x72, 0x6b, 0x20, 0x69, 0x6e, 0x74,
+	0x65, 0x6e, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c,
+	0x6c, 0x79, 0x20, 0x6c, 0x65, 0x66, 0x74, 0x20,
+	0x62, 0x6c, 0x61, 0x6e, 0x6b, 0x20, 0x20, 0x20,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
+	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+	0x00, 0x00, 0x00, 0x1c, 0x00, 0x1e, 0xff, 0xff
+};
+
 /**
  * talloc and intialize an AfpInfo
  **/
@@ -1669,6 +1810,9 @@ static bool test_rfork_truncate(struct t
 	struct smb2_handle fh1, fh2, fh3;
 	union smb_setfileinfo sinfo;
 
+	ret = enable_aapl(tctx, tree);
+	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
+
 	smb2_util_unlink(tree, fname);
 
 	status = torture_smb2_testdir(tree, BASEDIR, &testdirh);
@@ -1787,6 +1931,9 @@ static bool test_rfork_create(struct tor
 	};
 	union smb_fileinfo finfo;
 
+	ret = enable_aapl(tctx, tree);
+	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
+
 	smb2_util_unlink(tree, fname);
 
 	status = torture_smb2_testdir(tree, BASEDIR, &testdirh);
@@ -1904,7 +2051,7 @@ static bool test_rfork_create_ro(struct
 	}
 
 	torture_comment(tctx, "(%s) Try opening read-only with "
-			"open_if create disposition, should return ENOENT\n",
+			"open_if create disposition, should work\n",
 			__location__);
 
 	ZERO_STRUCT(create);
@@ -1914,32 +2061,6 @@ static bool test_rfork_create_ro(struct
 	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
 	create.in.share_access = FILE_SHARE_READ | FILE_SHARE_DELETE;
 	status = smb2_create(tree, mem_ctx, &(create));
-	torture_assert_ntstatus_equal_goto(tctx, status,
-					NT_STATUS_OBJECT_NAME_NOT_FOUND,
-					ret, done, "smb2_create failed\n");
-
-	torture_comment(tctx, "(%s) Now write something to the "
-			"rsrc stream, then the same open should succeed\n",
-			__location__);
-
-	ret = write_stream(tree, __location__, tctx, mem_ctx,
-			   fname, AFPRESOURCE_STREAM_NAME,
-			   0, 3, "foo");
-	torture_assert_goto(tctx, ret == true, ret, done,
-			"write_stream failed\n");
-
-	ret = check_stream(tree, __location__, tctx, mem_ctx,
-			   fname, AFPRESOURCE_STREAM,
-			   0, 3, 0, 3, "foo");
-	torture_assert_goto(tctx, ret == true, ret, done, "check_stream");
-
-	ZERO_STRUCT(create);
-	create.in.fname = rfork;
-	create.in.create_disposition = NTCREATEX_DISP_OPEN_IF;
-	create.in.desired_access = SEC_FILE_READ_DATA | SEC_STD_READ_CONTROL;
-	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
-	create.in.share_access = FILE_SHARE_READ | FILE_SHARE_DELETE;
-	status = smb2_create(tree, mem_ctx, &(create));
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 		"smb2_create failed\n");
 
@@ -1970,6 +2091,11 @@ static bool test_adouble_conversion(stru
 		":com.apple.metadata" "\xef\x80\xa2" "_kMDItemUserTags:$DATA",
 		":foo" "\xef\x80\xa2" "bar:$DATA", /* "foo:bar:$DATA" */
 	};
+	bool is_osx = torture_setting_bool(tctx, "osx", false);
+
+	if (is_osx) {
+		torture_skip(tctx, "Test only works with Samba\n");
+	}
 
 	smb2_deltree(tree, BASEDIR);
 
@@ -2021,6 +2147,127 @@ done:
 	return ret;
 }
 
+/*
+ * Test conversion of AppleDouble file without embedded xattr data
+ */
+static bool test_adouble_conversion_wo_xattr(struct torture_context *tctx,
+					     struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	const char *fname = BASEDIR "\\test_adouble_conversion";
+	const char *adname = BASEDIR "/._test_adouble_conversion";
+	NTSTATUS status;
+	struct smb2_handle testdirh;
+	bool ret = true;
+	const char *streams[] = {
+		"::$DATA",
+		AFPINFO_STREAM,
+		AFPRESOURCE_STREAM
+	};
+	struct smb2_create create;
+	struct smb2_find find;
+	unsigned int count;
+	union smb_search_data *d;
+	const char *data = "This resource fork intentionally left blank";
+	size_t datalen = strlen(data);
+	bool is_osx = torture_setting_bool(tctx, "osx", false);
+
+	if (is_osx) {
+		torture_skip(tctx, "Test only works with Samba\n");
+	}
+
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &testdirh);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir failed\n");
+	smb2_util_close(tree, testdirh);
+
+	ret = torture_setup_file(tctx, tree, fname, false);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_setup_file failed\n");
+
+	ret = torture_setup_file(tctx, tree, adname, false);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_setup_file failed\n");
+
+	ret = write_stream(tree, __location__, tctx, mem_ctx,
+			   adname, NULL, 0,
+			   sizeof(osx_adouble_without_xattr),
+			   osx_adouble_without_xattr);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "write_stream failed\n");
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
+
+	/*
+	 * Issue a smb2_find(), this triggers the server-side conversion
+	 */
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_DIR_READ,
+		.in.create_options = NTCREATEX_OPTIONS_DIRECTORY,
+		.in.file_attributes = FILE_ATTRIBUTE_DIRECTORY,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = BASEDIR,
+	};
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	find = (struct smb2_find) {
+		.in.file.handle = create.out.file.handle,
+		.in.pattern = "*",
+		.in.max_response_size = 0x1000,
+		.in.level = SMB2_FIND_ID_BOTH_DIRECTORY_INFO,
+	};
+
+	status = smb2_find_level(tree, tree, &find, &count, &d);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_find_level failed\n");
+
+	status = smb2_util_close(tree, create.out.file.handle);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_close failed");
+
+	/*
+	 * Check number of streams
+	 */
+
+	ret = check_stream_list(tree, tctx, fname, 3, streams, false);
+	torture_assert_goto(tctx, ret == true, ret, done, "check_stream_list");
+
+
+	/*
+	 * Check Resourcefork data can be read.
+	 */
+
+	ret = check_stream(tree, __location__, tctx, mem_ctx,
+			   fname, AFPRESOURCE_STREAM,
+			   16, datalen, 0, datalen, data);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "check AFPRESOURCE_STREAM failed\n");
+
+	/*
+	 * Check FinderInfo data has been migrated to stream.
+	 */
+
+	ret = check_stream(tree, __location__, tctx, mem_ctx,
+			   fname, AFPINFO_STREAM,
+			   0, 60, 16, 8, "WAVEPTul");
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "check AFPINFO_STREAM failed\n");
+
+done:
+	smb2_deltree(tree, BASEDIR);
+	talloc_free(mem_ctx);
+	return ret;
+}
+
 static bool test_aapl(struct torture_context *tctx,
 		      struct smb2_tree *tree)
 {
@@ -2039,11 +2286,13 @@ static bool test_aapl(struct torture_con
 	uint32_t aapl_reply_bitmap;
 	uint32_t aapl_server_caps;
 	uint32_t aapl_vol_caps;
+	uint32_t expected_vol_caps = 0;
 	char *model;
 	struct smb2_find f;
 	unsigned int count;
 	union smb_search_data *d;
 	uint64_t rfork_len;
+	bool is_osx_server = torture_setting_bool(tctx, "osx", false);
 
 	smb2_deltree(tree, BASEDIR);
 
@@ -2100,7 +2349,10 @@ static bool test_aapl(struct torture_con
 		goto done;
 	}
 
-	if (aapl->data.length != 50) {
+	if (!is_osx_server) {
+		size_t expected_aapl_ctx_size;
+		bool size_ok;
+
 		/*
 		 * uint32_t CommandCode = kAAPL_SERVER_QUERY
 		 * uint32_t Reserved = 0;
@@ -2113,11 +2365,12 @@ static bool test_aapl(struct torture_con
 		 *                       kAAPL_CASE_SENSITIVE;
 		 * uint32_t Pad2 = 0;
 		 * uint32_t ModelStringLen = 10;
-		 * ucs2_t ModelString[5] = "Samba";
+		 * ucs2_t ModelString[5] = "MacSamba";
 		 */
-		torture_warning(tctx,
-				"(%s) unexpected AAPL context length: %zd, expected 50",
-				__location__, aapl->data.length);
+		expected_aapl_ctx_size = strlen("MacSamba") * 2 + 40;
+
+		size_ok = aapl->data.length == expected_aapl_ctx_size;
+		torture_assert_goto(tctx, size_ok, ret, done, "bad AAPL size");
 	}
 
 	aapl_cmd = IVAL(aapl->data.data, 0);
@@ -2152,8 +2405,11 @@ static bool test_aapl(struct torture_con
 		goto done;
 	}
 
+	if (is_osx_server) {
+		expected_vol_caps = 5;
+	}
 	aapl_vol_caps = BVAL(aapl->data.data, 24);
-	if (aapl_vol_caps != 0) {
+	if (aapl_vol_caps != expected_vol_caps) {
 		/* this will fail on a case insensitive fs ... */
 		torture_result(tctx, TORTURE_FAIL,
 				"(%s) unexpected vol_caps: %d",
@@ -2781,6 +3037,7 @@ static bool check_stream_list(struct smb
 	create.in.desired_access = SEC_FILE_ALL;
 	create.in.create_options = is_dir ? NTCREATEX_OPTIONS_DIRECTORY : 0;
 	create.in.file_attributes = is_dir ? FILE_ATTRIBUTE_DIRECTORY : FILE_ATTRIBUTE_NORMAL;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
 	status = smb2_create(tree, tmp_ctx, &create);
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_create");
 	h = create.out.file.handle;
@@ -2825,6 +3082,66 @@ done:
 	return ret;
 }
 
+static bool check_stream_list_handle(struct smb2_tree *tree,
+				     struct torture_context *tctx,
+				     struct smb2_handle h,
+				     int num_exp,
+				     const char **exp,
+				     bool is_dir)
+{
+	bool ret = true;
+	union smb_fileinfo finfo;
+	NTSTATUS status;
+	int i;
+	TALLOC_CTX *tmp_ctx = talloc_new(tctx);
+	char **exp_sort;
+	struct stream_struct *stream_sort;
+
+	torture_assert_goto(tctx, tmp_ctx != NULL, ret, done,
+			    "talloc_new failed\n");
+
+	finfo = (union smb_fileinfo) {
+		.stream_info.level = RAW_FILEINFO_STREAM_INFORMATION,
+		.stream_info.in.file.handle = h,
+	};
+
+	status = smb2_getinfo_file(tree, tctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"get stream info\n");
+
+	torture_assert_int_equal_goto(tctx, finfo.stream_info.out.num_streams,
+				      num_exp, ret, done, "stream count\n");
+
+	if (num_exp == 0) {
+		TALLOC_FREE(tmp_ctx);
+		goto done;
+	}
+
+	exp_sort = talloc_memdup(tmp_ctx, exp, num_exp * sizeof(*exp));
+	torture_assert_goto(tctx, exp_sort != NULL, ret, done, __location__);
+
+	TYPESAFE_QSORT(exp_sort, num_exp, qsort_string);
+
+	stream_sort = talloc_memdup(tmp_ctx, finfo.stream_info.out.streams,
+				    finfo.stream_info.out.num_streams *
+				    sizeof(*stream_sort));
+	torture_assert_goto(tctx, stream_sort != NULL, ret, done, __location__);
+
+	TYPESAFE_QSORT(stream_sort, finfo.stream_info.out.num_streams, qsort_stream);
+
+	for (i=0; i<num_exp; i++) {
+		torture_comment(tctx, "i[%d] exp[%s] got[%s]\n",
+				i, exp_sort[i], stream_sort[i].stream_name.s);
+		torture_assert_str_equal_goto(tctx, stream_sort[i].stream_name.s,
+					      exp_sort[i], ret, done,
+					      "stream name\n");
+	}
+
+done:
+	TALLOC_FREE(tmp_ctx);
+	return ret;
+}
+
 /*
   test stream names
 */
@@ -2855,6 +3172,9 @@ static bool test_stream_names(struct tor
 	CHECK_STATUS(status, NT_STATUS_OK);
 	smb2_util_close(tree, h);
 
+	ret = torture_setup_file(mem_ctx, tree, fname, false);
+	torture_assert_goto(tctx, ret, ret, done, "torture_setup_file");
+
 	torture_comment(tctx, "(%s) testing stream names\n", __location__);
 	ZERO_STRUCT(create);
 	create.in.desired_access = SEC_FILE_WRITE_DATA;
@@ -2869,6 +3189,11 @@ static bool test_stream_names(struct tor
 
 	status = smb2_create(tree, mem_ctx, &create);
 	CHECK_STATUS(status, NT_STATUS_OK);
+
+	status = smb2_util_write(tree, create.out.file.handle, "foo", 0, 3);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
 	smb2_util_close(tree, create.out.file.handle);
 
 	ret = check_stream_list(tree, tctx, fname, 2, streams, false);
@@ -2947,15 +3272,12 @@ static bool test_rename_dir_openfile(str
 		torture_assert_ntstatus_equal(torture, status,
 					      NT_STATUS_ACCESS_DENIED,
 					      "smb2_setinfo_file");
-
-		ZERO_STRUCT(cl.smb2);
-		cl.smb2.level = RAW_CLOSE_SMB2;
-		cl.smb2.in.file.handle = d1;
-		status = smb2_close(tree, &(cl.smb2));
-		torture_assert_ntstatus_ok(torture, status, "smb2_close");
-		ZERO_STRUCT(d1);
 	}
 
+	status = smb2_util_close(tree, d1);
+	torture_assert_ntstatus_ok(torture, status, "smb2_util_close\n");
+	ZERO_STRUCT(d1);
+
 	torture_comment(torture, "Enabling AAPL\n");
 
 	ret = enable_aapl(torture, tree);
@@ -3168,6 +3490,10 @@ static bool test_setinfo_delete_on_close
 	const char *sname = BASEDIR "\\file" AFPINFO_STREAM_NAME;
 	const char *type_creator = "SMB,OLE!";
 	AfpInfo *info = NULL;
+	const char *streams[] = {
+		AFPINFO_STREAM,
+		"::$DATA"
+	};
 	const char *streams_basic[] = {
 		"::$DATA"
 	};
@@ -3209,6 +3535,19 @@ static bool test_setinfo_delete_on_close
 	status = smb2_setinfo_file(tree, &sfinfo);
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "set delete-on-close failed");
 
+	ret = check_stream_list(tree, tctx, fname, 2, streams, false);
+	torture_assert_goto(tctx, ret == true, ret, done, "Bad streams");
+
+	ZERO_STRUCT(create);
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.desired_access = SEC_FILE_ALL;
+	create.in.fname = sname;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.impersonation_level = NTCREATEX_IMPERSONATION_IMPERSONATION;
+	status = smb2_create(tree, mem_ctx, &create);
+	torture_assert_ntstatus_equal_goto(tctx, status, NT_STATUS_DELETE_PENDING,
+					   ret, done, "Got unexpected AFP_AfpInfo stream");
+
 	smb2_util_close(tree, h1);
 
 	ret = check_stream_list(tree, tctx, fname, 1, streams_basic, false);
@@ -3403,8 +3742,8 @@ static bool test_afpinfo_all0(struct tor
 	create.in.fname = fname;
 
 	status = smb2_create(tree, mem_ctx, &create);
-	torture_assert_goto(tctx, ret == true, ret, done,
-			    "smb2_create failed\n");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
 	baseh = create.out.file.handle;
 
 	ZERO_STRUCT(create);
@@ -3414,8 +3753,8 @@ static bool test_afpinfo_all0(struct tor
 	create.in.fname = sname;
 
 	status = smb2_create(tree, mem_ctx, &create);
-	torture_assert_goto(tctx, ret == true, ret, done,
-			    "smb2_create failed\n");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
 	h1 = create.out.file.handle;
 
 	status = smb2_util_write(tree, h1, infobuf, 0, AFP_INFO_SIZE);
@@ -3662,6 +4001,9 @@ static bool test_setinfo_eof_resource(st
 
 	torture_assert_goto(tctx, mem_ctx != NULL, ret, done, "talloc_new");
 
+	ret = enable_aapl(tctx, tree);
+	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
+
 	torture_comment(tctx, "Set AFP_AfpResource EOF to 1 and 0\n");
 
 	smb2_deltree(tree, BASEDIR);
@@ -3792,6 +4134,8 @@ static bool test_null_afpinfo(struct tor
 	AfpInfo *afpinfo = NULL;
 	char *afpinfo_buf = NULL;
 	const char *type_creator = "SMB,OLE!";
+	struct smb2_handle handle2;
+	struct smb2_read r;
 
 	torture_comment(tctx, "Checking create of AfpInfo stream\n");
 
@@ -3830,6 +4174,20 @@ static bool test_null_afpinfo(struct tor
 	status = smb2_read_recv(req[1], tree, &read);
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done, "smb2_read_recv failed");
 
+	status = torture_smb2_testfile_access(tree, sname, &handle2,
+					      SEC_FILE_READ_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+	r = (struct smb2_read) {
+		.in.file.handle = handle2,
+		.in.length      = AFP_INFO_SIZE,
+	};
+
+	status = smb2_read(tree, tree, &r);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+	smb2_util_close(tree, handle2);
+
 	afpinfo = torture_afpinfo_new(mem_ctx);
 	torture_assert_goto(tctx, afpinfo != NULL, ret, done, "torture_afpinfo_new failed");
 
@@ -3897,6 +4255,8 @@ static bool test_rename_and_read_rsrc(st
 	const char *fname_renamed = "test_rename_openfile_renamed";
 	const char *data = "1234567890";
 	union smb_setfileinfo sinfo;
+	bool server_is_macos = torture_setting_bool(tctx, "osx", false);
+	NTSTATUS expected_status;
 
 	ret = enable_aapl(tctx, tree);
 	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
@@ -3947,14 +4307,25 @@ static bool test_rename_and_read_rsrc(st
 	sinfo.rename_information.in.root_fid = 0;
 	sinfo.rename_information.in.new_name = fname_renamed;
 
+	if (server_is_macos) {
+		expected_status = NT_STATUS_SHARING_VIOLATION;
+	} else {
+		expected_status = NT_STATUS_ACCESS_DENIED;
+	}
+
 	status = smb2_setinfo_file(tree, &sinfo);
 	torture_assert_ntstatus_equal_goto(
-		tctx, status, NT_STATUS_ACCESS_DENIED, ret, done,
+		tctx, status, expected_status, ret, done,
 		"smb2_setinfo_file failed");
 
-	smb2_util_close(tree, h1);
 	smb2_util_close(tree, h2);
 
+	status = smb2_util_write(tree, h1, "foo", 0, 3);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"write failed\n");
+
+	smb2_util_close(tree, h1);
+
 done:
 	smb2_util_unlink(tree, fname);
 	smb2_util_unlink(tree, fname_renamed);
@@ -4131,6 +4502,341 @@ done:
 	return ret;
 }
 
+static bool test_writing_afpinfo(struct torture_context *tctx,
+				 struct smb2_tree *tree)
+{
+	const char *fname = "filtest_invalid_afpinfo";
+	const char *sname = "filtest_invalid_afpinfo" AFPINFO_STREAM;
+	const char *streams_afpinfo[] = {
+		"::$DATA",
+		AFPINFO_STREAM
+	};
+	bool ret = true;
+	static AfpInfo *afpi = NULL;
+	char *buf = NULL;
+	char *afpi_buf = NULL;
+	char *zero_buf = NULL;
+	bool broken_osx = torture_setting_bool(tctx, "broken_osx_45759458", false);
+	off_t min_offset_for_2streams = 16;
+	int i;
+	NTSTATUS status;
+	struct test_sizes {
+		off_t offset;
+		size_t size;
+		bool expected_result;
+	} test_sizes[] = {
+		{ 0, 1, false},
+		{ 0, 2, false},
+		{ 0, 3, true},
+		{ 0, 4, true},
+		{ 0, 14, true},
+		{ 0, 15, true},
+		{ 0, 16, true},
+		{ 0, 24, true},
+		{ 0, 34, true},
+		{ 0, 44, true},
+		{ 0, 54, true},
+		{ 0, 55, true},
+		{ 0, 56, true},
+		{ 0, 57, true},
+		{ 0, 58, true},
+		{ 0, 59, true},
+		{ 0, 60, true},
+		{ 0, 61, true},
+		{ 0, 64, true},
+		{ 0, 1024, true},
+		{ 0, 10064, true},
+
+		{ 1, 1, false},
+		{ 1, 2, false},
+		{ 1, 3, false},
+		{ 1, 4, false},
+		{ 1, 14, false},
+		{ 1, 15, false},
+		{ 1, 16, false},
+		{ 1, 24, false},
+		{ 1, 34, false},
+		{ 1, 44, false},
+		{ 1, 54, false},
+		{ 1, 55, false},
+		{ 1, 56, false},
+		{ 1, 57, false},
+		{ 1, 58, false},
+		{ 1, 59, false},
+		{ 1, 60, true},
+		{ 1, 61, true},
+		{ 1, 1024, true},
+		{ 1, 10064, true},
+
+		{ 30, 1, false},
+		{ 30, 2, false},
+		{ 30, 3, false},
+		{ 30, 4, false},
+		{ 30, 14, false},
+		{ 30, 15, false},
+		{ 30, 16, false},
+		{ 30, 24, false},
+		{ 30, 34, false},
+		{ 30, 44, false},
+		{ 30, 54, false},
+		{ 30, 55, false},
+		{ 30, 56, false},
+		{ 30, 57, false},
+		{ 30, 58, false},
+		{ 30, 59, false},
+		{ 30, 60, true},
+		{ 30, 61, true},
+		{ 30, 1024, true},
+		{ 30, 10064, true},
+
+		{ 58, 1, false},
+		{ 58, 2, false},
+		{ 58, 3, false},
+		{ 58, 4, false},
+		{ 58, 14, false},
+		{ 58, 15, false},
+		{ 58, 16, false},
+		{ 58, 24, false},
+		{ 58, 34, false},
+		{ 58, 44, false},
+		{ 58, 54, false},
+		{ 58, 55, false},
+		{ 58, 56, false},
+		{ 58, 57, false},
+		{ 58, 58, false},
+		{ 58, 59, false},
+		{ 58, 60, true},
+		{ 58, 61, true},
+		{ 58, 1024, true},
+		{ 58, 10064, true},
+
+		{ 59, 1, false},
+		{ 59, 2, false},
+		{ 59, 3, false},
+		{ 59, 4, false},
+		{ 59, 14, false},
+		{ 59, 15, false},
+		{ 59, 16, false},
+		{ 59, 24, false},
+		{ 59, 34, false},
+		{ 59, 44, false},
+		{ 59, 54, false},
+		{ 59, 55, false},
+		{ 59, 56, false},
+		{ 59, 57, false},
+		{ 59, 58, false},
+		{ 59, 59, false},
+		{ 59, 60, true},
+		{ 59, 61, true},
+		{ 59, 1024, true},
+		{ 59, 10064, true},
+
+		{ 60, 1, false},
+		{ 60, 2, false},
+		{ 60, 3, false},
+		{ 60, 4, false},
+		{ 60, 14, false},
+		{ 60, 15, false},
+		{ 60, 16, false},
+		{ 60, 24, false},
+		{ 60, 34, false},
+		{ 60, 44, false},
+		{ 60, 54, false},
+		{ 60, 55, false},
+		{ 60, 56, false},
+		{ 60, 57, false},
+		{ 60, 58, false},
+		{ 60, 59, false},
+		{ 60, 60, true},
+		{ 60, 61, true},
+		{ 60, 1024, true},
+		{ 60, 10064, true},
+
+		{ 61, 1, false},
+		{ 61, 2, false},
+		{ 61, 3, false},
+		{ 61, 4, false},
+		{ 61, 14, false},
+		{ 61, 15, false},
+		{ 61, 16, false},
+		{ 61, 24, false},
+		{ 61, 34, false},
+		{ 61, 44, false},
+		{ 61, 54, false},
+		{ 61, 55, false},
+		{ 61, 56, false},
+		{ 61, 57, false},
+		{ 61, 58, false},
+		{ 61, 59, false},
+		{ 61, 60, true},
+		{ 61, 61, true},
+		{ 61, 1024, true},
+		{ 61, 10064, true},
+
+		{ 10000, 1, false},
+		{ 10000, 2, false},
+		{ 10000, 3, false},
+		{ 10000, 4, false},
+		{ 10000, 14, false},
+		{ 10000, 15, false},
+		{ 10000, 16, false},
+		{ 10000, 24, false},
+		{ 10000, 34, false},
+		{ 10000, 44, false},
+		{ 10000, 54, false},
+		{ 10000, 55, false},
+		{ 10000, 56, false},
+		{ 10000, 57, false},
+		{ 10000, 58, false},
+		{ 10000, 59, false},
+		{ 10000, 60, true},
+		{ 10000, 61, true},
+		{ 10000, 1024, true},
+		{ 10000, 10064, true},
+
+		{ -1, 0, false},
+	};
+
+	afpi = torture_afpinfo_new(tctx);
+	torture_assert_not_null_goto(tctx, afpi, ret, done,
+				     "torture_afpinfo_new failed\n");
+
+	memcpy(afpi->afpi_FinderInfo, "FOO BAR ", 8);
+
+	buf = torture_afpinfo_pack(afpi, afpi);
+	torture_assert_not_null_goto(tctx, buf, ret, done,
+				     "torture_afpinfo_pack failed\n");
+
+	afpi_buf = talloc_zero_array(tctx, char, 10064);
+	torture_assert_not_null_goto(tctx, afpi_buf, ret, done,
+				     "talloc_zero_array failed\n");
+	memcpy(afpi_buf, buf, 60);
+
+	zero_buf = talloc_zero_array(tctx, char, 10064);
+	torture_assert_not_null_goto(tctx, zero_buf, ret, done,
+				     "talloc_zero_array failed\n");
+
+	ret = torture_setup_file(tctx, tree, fname, false);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_setup_file\n");
+
+	for (i = 0; test_sizes[i].offset != -1; i++) {
+		struct smb2_handle h;
+		struct smb2_create c;
+		int expected_num_streams;
+		size_t fi_check_size;
+
+		torture_comment(tctx,
+				"Test %d: offset=%jd size=%zu result=%s\n",
+				i,
+				(intmax_t)test_sizes[i].offset,
+				test_sizes[i].size,
+				test_sizes[i].expected_result ? "true":"false");
+
+
+		c = (struct smb2_create) {
+			.in.desired_access = SEC_FILE_WRITE_DATA,
+			.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+			.in.create_disposition = NTCREATEX_DISP_OPEN_IF,
+			.in.fname = sname,
+		};
+
+		status = smb2_create(tree, tree, &c);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_create\n");
+		h = c.out.file.handle;
+
+		status = smb2_util_write(tree,
+					 h,
+					 zero_buf,
+					 test_sizes[i].offset,
+					 test_sizes[i].size);
+		torture_assert_ntstatus_equal_goto(
+			tctx, status, NT_STATUS_INVALID_PARAMETER,
+			ret, done, "smb2_util_write\n");
+
+		status = smb2_util_write(tree,
+					 h,
+					 afpi_buf,
+					 test_sizes[i].offset,
+					 test_sizes[i].size);
+		smb2_util_close(tree, h);
+		if (test_sizes[i].expected_result == true) {
+			torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+							"smb2_util_write\n");
+		} else {
+			torture_assert_ntstatus_equal_goto(
+				tctx, status, NT_STATUS_INVALID_PARAMETER,
+				ret, done, "smb2_util_write\n");
+		}
+
+		if (broken_osx) {
+			/*
+			 * Currently macOS has a bug (Radar #45759458) where it
+			 * writes more bytes then requested from uninitialized
+			 * memory to the filesystem. That means it will likely
+			 * write data to FinderInfo so the stream is not empty
+			 * and thus listed when the number of streams is
+			 * queried.
+			 */
+			min_offset_for_2streams = 2;
+		}
+
+		if ((test_sizes[i].expected_result == true) &&
+		    (test_sizes[i].size > min_offset_for_2streams))
+		{
+			expected_num_streams = 2;
+		} else {
+			expected_num_streams = 1;
+		}
+
+		ret = check_stream_list(tree, tctx, fname,
+					expected_num_streams,
+					streams_afpinfo, false);
+		torture_assert_goto(tctx, ret == true, ret, done,
+				    "Bad streams\n");
+
+		if (test_sizes[i].expected_result == false) {
+			continue;
+		}
+
+		if (test_sizes[i].size <= 16) {
+			/*
+			 * FinderInfo with the "FOO BAR " string we wrote above
+			 * would start at offset 16. Check whether this test
+			 * wrote 1 byte or more.
+			 */
+			goto next;
+		}
+
+		fi_check_size = test_sizes[i].size - 16;
+		fi_check_size = MIN(fi_check_size, 8);
+
+		ret = check_stream(tree, __location__,
+				   tctx, tctx,
+				   fname, AFPINFO_STREAM,
+				   0, 60, 16, fi_check_size, "FOO BAR ");
+		torture_assert_goto(tctx, ret == true, ret, done,
+				    "Bad streams\n");
+
+next:
+		status = smb2_util_unlink(tree, sname);
+		if (NT_STATUS_EQUAL(status, NT_STATUS_OBJECT_NAME_NOT_FOUND)) {
+			bool missing_ok;
+
+			missing_ok = test_sizes[i].expected_result == false;
+			missing_ok |= test_sizes[i].size <= 16;
+
+			torture_assert_goto(tctx, missing_ok,
+					    ret, done, "smb2_util_unlink\n");
+		}
+	}
+
+done:
+	smb2_util_unlink(tree, fname);
+	return ret;
+}
+
 static bool test_zero_file_id(struct torture_context *tctx,
 			      struct smb2_tree *tree)
 {
@@ -4480,6 +5186,11 @@ static bool test_nfs_aces(struct torture
 	struct security_descriptor *psd = NULL;
 	NTSTATUS status;
 	bool ret = true;
+	bool is_osx = torture_setting_bool(tctx, "osx", false);
+
+	if (is_osx) {
+		torture_skip(tctx, "Test only works with Samba\n");
+	}
 
 	ret = enable_aapl(tctx, tree);
 	torture_assert(tctx, ret == true, "enable_aapl failed");
@@ -4594,6 +5305,9 @@ static bool test_setinfo_stream_eof(stru
 	torture_assert_goto(tctx, mem_ctx != NULL, ret, done,
 			    "talloc_new failed\n");
 
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed");
+
 	torture_comment(tctx, "Test setting EOF on a stream\n");
 
 	smb2_deltree(tree, BASEDIR);
@@ -4674,8 +5388,32 @@ static bool test_setinfo_stream_eof(stru
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"set eof 0 failed\n");
 
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_READ_ATTRIBUTE;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND, ret, done,
+		"Unexpected status\n");
+
 	smb2_util_close(tree, h1);
 
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_READ_ATTRIBUTE;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND, ret, done,
+		"Unexpected status\n");
+
 	status = torture_smb2_testfile_access(tree, sname, &h1,
 					      SEC_FILE_WRITE_DATA);
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
@@ -4754,6 +5492,18 @@ static bool test_setinfo_stream_eof(stru
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"set eof 0 failed\n");
 
+	ZERO_STRUCT(create);
+	create.in.desired_access = SEC_FILE_READ_ATTRIBUTE;
+	create.in.share_access = NTCREATEX_SHARE_ACCESS_MASK;
+	create.in.file_attributes = FILE_ATTRIBUTE_NORMAL;
+	create.in.create_disposition = NTCREATEX_DISP_OPEN;
+	create.in.fname = sname;
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND, ret, done,
+		"Unexpected status\n");
+
 	smb2_util_close(tree, h1);
 
 	ZERO_STRUCT(create);
@@ -4813,12 +5563,647 @@ static bool test_setinfo_stream_eof(stru
 	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
 					"torture_smb2_testfile failed\n");
 	smb2_util_close(tree, h1);
+
+	torture_comment(tctx, "Writing to stream after setting EOF to 0\n");
+	status = torture_smb2_testfile_access(tree, sname, &h1,
+					      SEC_FILE_WRITE_DATA);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	status = smb2_util_write(tree, h1, "1234567890", 0, 10);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
+	ZERO_STRUCT(sfinfo);
+	sfinfo.generic.in.file.handle = h1;
+	sfinfo.generic.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION;
+	sfinfo.position_information.in.position = 0;
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	status = smb2_util_write(tree, h1, "1234567890", 0, 10);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
+	smb2_util_close(tree, h1);
+
 done:
 	smb2_util_unlink(tree, fname);
 	smb2_util_rmdir(tree, BASEDIR);
 	return ret;
 }
 
+#define MAX_STREAMS 16
+
+struct tcase {
+	const char *name;
+	uint32_t access;
+	const char *write_data;
+	size_t write_size;
+	struct tcase_results {
+		size_t size;
+		NTSTATUS initial_status;
+		NTSTATUS final_status;
+		int num_streams_open_handle;
+		const char *streams_open_handle[MAX_STREAMS];
+		int num_streams_closed_handle;
+		const char *streams_closed_handle[MAX_STREAMS];
+	} create, write, overwrite, eof, doc;
+};
+
+typedef enum {T_CREATE, T_WRITE, T_OVERWRITE, T_EOF, T_DOC} subtcase_t;
+
+static bool test_empty_stream_do_checks(
+	struct torture_context *tctx,
+	struct smb2_tree *tree,
+	struct smb2_tree *tree2,
+	struct tcase *tcase,
+	TALLOC_CTX *mem_ctx,
+	struct smb2_handle baseh,
+	struct smb2_handle streamh,
+	subtcase_t subcase)
+{
+	bool ret = false;
+	NTSTATUS status;
+	struct smb2_handle h1;
+	union smb_fileinfo finfo;
+	struct tcase_results *tcase_results = NULL;
+
+	switch (subcase) {
+	case T_CREATE:
+		tcase_results = &tcase->create;
+		break;
+	case T_OVERWRITE:
+		tcase_results = &tcase->overwrite;
+		break;
+	case T_WRITE:
+		tcase_results = &tcase->write;
+		break;
+	case T_EOF:
+		tcase_results = &tcase->eof;
+		break;
+	case T_DOC:
+		tcase_results = &tcase->doc;
+		break;
+	}
+
+	finfo = (union smb_fileinfo) {
+		.generic.level = RAW_FILEINFO_STANDARD_INFORMATION,
+		.generic.in.file.handle = streamh,
+	};
+
+	/*
+	 * Test: check size, same client
+	 */
+
+	status = smb2_getinfo_file(tree, mem_ctx, &finfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+
+	torture_assert_int_equal_goto(tctx, finfo.standard_info.out.size,
+				      tcase_results->size,
+				      ret, done, "Wrong size\n");
+
+	/*
+	 * Test: open, same client
+	 */
+
+	status = torture_smb2_open(tree, tcase->name,
+				   SEC_FILE_READ_ATTRIBUTE, &h1);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   tcase_results->initial_status,
+					   ret, done,
+					   "smb2_create failed\n");
+	if (NT_STATUS_IS_OK(status)) {
+		status = smb2_util_close(tree, h1);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_util_close failed\n");
+	}
+
+	/*
+	 * Test: check streams, same client
+	 */
+
+	ret = check_stream_list_handle(tree, tctx, baseh,
+				       tcase_results->num_streams_open_handle,
+				       tcase_results->streams_open_handle,
+				       false);
+	torture_assert_goto(tctx, ret == true, ret, done, "Bad streams");
+
+	/*
+	 * Test: open, different client
+	 */
+
+	status = torture_smb2_open(tree2, tcase->name,
+				   SEC_FILE_READ_ATTRIBUTE, &h1);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   tcase_results->initial_status,
+					   ret, done,
+					   "smb2_create failed\n");
+	if (NT_STATUS_IS_OK(status)) {
+		finfo = (union smb_fileinfo) {
+			.generic.level = RAW_FILEINFO_STANDARD_INFORMATION,
+			.generic.in.file.handle = h1,
+		};
+
+		/*
+		 * Test: check size, different client
+		 */
+
+		status = smb2_getinfo_file(tree2, mem_ctx, &finfo);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_getinfo_file failed\n");
+
+		torture_assert_int_equal_goto(tctx, finfo.standard_info.out.size,
+					      tcase_results->size,
+					      ret, done, "Wrong size\n");
+
+		/*
+		 * Test: check streams, different client
+		 */
+
+		ret = check_stream_list(tree2, tctx, BASEDIR "\\file",
+					tcase_results->num_streams_open_handle,
+					tcase_results->streams_open_handle,
+					false);
+		torture_assert_goto(tctx, ret == true, ret, done, "Bad streams");
+
+		status = smb2_util_close(tree2, h1);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_util_close failed\n");
+	}
+
+	status = smb2_util_close(tree, streamh);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_close failed\n");
+
+	/*
+	 * Test: open after close, same client
+	 */
+
+	status = torture_smb2_open(tree, tcase->name,
+				   SEC_FILE_READ_DATA, &h1);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   tcase_results->final_status,
+					   ret, done,
+					   "smb2_create failed\n");
+	if (NT_STATUS_IS_OK(status)) {
+		status = smb2_util_close(tree, h1);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_util_close failed\n");
+	}
+
+	/*
+	 * Test: open after close, different client
+	 */
+
+	status = torture_smb2_open(tree2, tcase->name,
+				   SEC_FILE_READ_DATA, &h1);
+	torture_assert_ntstatus_equal_goto(tctx, status,
+					   tcase_results->final_status,
+					   ret, done,
+					   "smb2_create failed\n");
+	if (NT_STATUS_IS_OK(status)) {
+		status = smb2_util_close(tree2, h1);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_util_close failed\n");
+	}
+
+	/*
+	 * Test: check streams after close, same client
+	 */
+
+	ret = check_stream_list_handle(tree, tctx, baseh,
+				       tcase_results->num_streams_closed_handle,
+				       tcase_results->streams_closed_handle,
+				       false);
+	torture_assert_goto(tctx, ret == true, ret, done, "Bad streams");
+
+	ret = true;
+
+done:
+	smb2_util_close(tree, streamh);
+	smb2_util_close(tree, baseh);
+	return ret;
+}
+
+static bool test_empty_stream_do_one(
+	struct torture_context *tctx,
+	struct smb2_tree *tree,
+	struct smb2_tree *tree2,
+	struct tcase *tcase)
+{
+	bool ret = false;
+	NTSTATUS status;
+	struct smb2_handle baseh = {{0}};
+	struct smb2_handle streamh;
+	struct smb2_create create;
+	union smb_setfileinfo sfinfo;
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+
+	torture_comment(tctx, "Testing stream [%s]\n", tcase->name);
+
+	torture_assert_goto(tctx, mem_ctx != NULL, ret, done, "talloc_new\n");
+
+	/*
+	 * Subtest: create
+	 */
+	torture_comment(tctx, "Subtest: T_CREATE\n");
+
+	status = smb2_util_unlink(tree, BASEDIR "\\file");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_unlink failed\n");
+
+	status = torture_smb2_testfile_access(tree, BASEDIR "\\file",
+					      &baseh, SEC_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = torture_smb2_testfile_access(tree, tcase->name, &streamh,
+					      tcase->access);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	ret = test_empty_stream_do_checks(tctx, tree, tree2, tcase,
+					  mem_ctx, baseh, streamh, T_CREATE);
+	torture_assert_goto(tctx, ret, ret, done, "test failed\n");
+
+	if (!(tcase->access & SEC_FILE_WRITE_DATA)) {
+		/*
+		 * All subsequent tests require write access
+		 */
+		ret = true;
+		goto done;
+	}
+
+	/*
+	 * Subtest: create and write
+	 */
+	torture_comment(tctx, "Subtest: T_WRITE\n");
+
+	status = smb2_util_unlink(tree, BASEDIR "\\file");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_unlink failed\n");
+
+	status = torture_smb2_testfile_access(tree, BASEDIR "\\file",
+					      &baseh, SEC_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = torture_smb2_testfile_access(tree, tcase->name, &streamh,
+					      tcase->access);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = smb2_util_write(tree, streamh, tcase->write_data, 0,
+				 tcase->write_size);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_open failed\n");
+
+	ret = test_empty_stream_do_checks(tctx, tree, tree2, tcase,
+					  mem_ctx, baseh, streamh, T_WRITE);
+	torture_assert_goto(tctx, ret, ret, done, "test failed\n");
+
+	/*
+	 * Subtest: overwrite
+	 */
+	torture_comment(tctx, "Subtest: T_OVERWRITE\n");
+
+	status = smb2_util_unlink(tree, BASEDIR "\\file");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_unlink failed\n");
+
+	status = torture_smb2_testfile_access(tree, BASEDIR "\\file",
+					      &baseh, SEC_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_FILE_ALL,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_MASK,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.create_disposition = NTCREATEX_DISP_OVERWRITE_IF,
+		.in.fname = tcase->name,
+	};
+
+	status = smb2_create(tree, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile failed\n");
+	streamh = create.out.file.handle;
+
+	ret = test_empty_stream_do_checks(tctx, tree, tree2, tcase,
+					  mem_ctx, baseh, streamh, T_OVERWRITE);
+	torture_assert_goto(tctx, ret, ret, done, "test failed\n");
+
+	/*
+	 * Subtest: setinfo EOF 0
+	 */
+	torture_comment(tctx, "Subtest: T_EOF\n");
+
+	status = smb2_util_unlink(tree, BASEDIR "\\file");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_unlink failed\n");
+
+	status = torture_smb2_testfile_access(tree, BASEDIR "\\file",
+					      &baseh, SEC_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = torture_smb2_testfile_access(tree, tcase->name, &streamh,
+					      tcase->access);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = smb2_util_write(tree, streamh, tcase->write_data, 0,
+				 tcase->write_size);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_open failed\n");
+
+	sfinfo = (union smb_setfileinfo) {
+		.end_of_file_info.level = RAW_SFILEINFO_END_OF_FILE_INFORMATION,
+		.end_of_file_info.in.file.handle = streamh,
+		.end_of_file_info.in.size = 0,
+	};
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	ret = test_empty_stream_do_checks(tctx, tree, tree2, tcase,
+					  mem_ctx, baseh, streamh, T_EOF);
+	torture_assert_goto(tctx, ret, ret, done, "test failed\n");
+
+	/*
+	 * Subtest: delete-on-close
+	 */
+	torture_comment(tctx, "Subtest: T_DOC\n");
+
+	status = smb2_util_unlink(tree, BASEDIR "\\file");
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_unlink failed\n");
+
+	status = torture_smb2_testfile_access(tree, BASEDIR "\\file",
+					      &baseh, SEC_FILE_ALL);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = torture_smb2_testfile_access(tree, tcase->name, &streamh,
+					      tcase->access);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testfile_access failed\n");
+
+	status = smb2_util_write(tree, streamh, tcase->write_data, 0,
+				 tcase->write_size);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_open failed\n");
+
+	sfinfo = (union smb_setfileinfo) {
+		.disposition_info.level = RAW_SFILEINFO_DISPOSITION_INFORMATION,
+		.disposition_info.in.file.handle = streamh,
+		.disposition_info.in.delete_on_close = true,
+	};
+	status = smb2_setinfo_file(tree, &sfinfo);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"set eof 0 failed\n");
+
+	ret = test_empty_stream_do_checks(tctx, tree, tree2, tcase,
+					  mem_ctx, baseh, streamh,
+					  T_DOC);
+	torture_assert_goto(tctx, ret, ret, done, "test failed\n");
+
+	ret = true;
+
+done:
+	smb2_util_close(tree, baseh);
+	TALLOC_FREE(mem_ctx);
+	return ret;
+}
+
+static bool test_empty_stream(struct torture_context *tctx,
+			      struct smb2_tree *tree)
+{
+	struct smb2_tree *tree2 = NULL;
+	struct tcase *tcase = NULL;
+	const char *fname = BASEDIR "\\file";
+	struct smb2_handle h1;
+	bool ret = true;
+	NTSTATUS status;
+	AfpInfo ai = (AfpInfo) {
+		.afpi_Signature = AFP_Signature,
+		.afpi_Version = AFP_Version,
+		.afpi_BackupTime = AFP_BackupTime,
+		.afpi_FinderInfo = "FOO BAR ",
+	};
+	char *ai_blob = torture_afpinfo_pack(tctx, &ai);
+	struct tcase tcase_afpinfo_ro = (struct tcase) {
+		.name = BASEDIR "\\file" AFPINFO_STREAM,
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE,
+		.create.size = 60,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+	};
+	struct tcase tcase_afpinfo_rw = (struct tcase) {
+		.name = BASEDIR "\\file" AFPINFO_STREAM,
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE|SEC_FILE_WRITE_DATA|SEC_STD_DELETE,
+		.write_data = ai_blob,
+		.write_size = AFP_INFO_SIZE,
+		.create.size = 60,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+		.write.size = 60,
+		.write.initial_status = NT_STATUS_OK,
+		.write.final_status = NT_STATUS_OK,
+		.write.num_streams_open_handle = 2,
+		.write.num_streams_closed_handle = 2,
+		.write.streams_open_handle = {"::$DATA", AFPINFO_STREAM},
+		.write.streams_closed_handle = {"::$DATA", AFPINFO_STREAM},
+		.overwrite.size = 60,
+		.overwrite.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.num_streams_open_handle = 1,
+		.overwrite.num_streams_closed_handle = 1,
+		.overwrite.streams_open_handle = {"::$DATA"},
+		.overwrite.streams_closed_handle = {"::$DATA"},
+		.eof.size = 60,
+		.eof.initial_status = NT_STATUS_OK,
+		.eof.final_status = NT_STATUS_OK,
+		.eof.num_streams_open_handle = 2,
+		.eof.num_streams_closed_handle = 2,
+		.eof.streams_open_handle = {"::$DATA", AFPINFO_STREAM},
+		.eof.streams_closed_handle = {"::$DATA", AFPINFO_STREAM},
+		.doc.size = 60,
+		.doc.initial_status = NT_STATUS_DELETE_PENDING,
+		.doc.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.doc.num_streams_open_handle = 2,
+		.doc.num_streams_closed_handle = 1,
+		.doc.streams_open_handle = {"::$DATA", AFPINFO_STREAM},
+		.doc.streams_closed_handle = {"::$DATA"},
+	};
+
+	struct tcase tcase_afpresource_ro = (struct tcase) {
+		.name = BASEDIR "\\file" AFPRESOURCE_STREAM,
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE,
+		.create.size = 0,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+	};
+	struct tcase tcase_afpresource_rw = (struct tcase) {
+		.name = BASEDIR "\\file" AFPRESOURCE_STREAM,
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE|SEC_FILE_WRITE_DATA|SEC_STD_DELETE,
+		.write_data = "foo",
+		.write_size = 3,
+		.create.size = 0,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+		.write.size = 3,
+		.write.initial_status = NT_STATUS_OK,
+		.write.final_status = NT_STATUS_OK,
+		.write.num_streams_open_handle = 2,
+		.write.num_streams_closed_handle = 2,
+		.write.streams_open_handle = {"::$DATA", AFPRESOURCE_STREAM},
+		.write.streams_closed_handle = {"::$DATA", AFPRESOURCE_STREAM},
+		.overwrite.size = 0,
+		.overwrite.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.num_streams_open_handle = 1,
+		.overwrite.num_streams_closed_handle = 1,
+		.overwrite.streams_open_handle = {"::$DATA"},
+		.overwrite.streams_closed_handle = {"::$DATA"},
+		.eof.size = 0,
+		.eof.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.eof.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.eof.num_streams_open_handle = 1,
+		.eof.num_streams_closed_handle = 1,
+		.eof.streams_open_handle = {"::$DATA"},
+		.eof.streams_closed_handle = {"::$DATA"},
+		.doc.size = 3,
+		.doc.initial_status = NT_STATUS_DELETE_PENDING,
+		.doc.final_status = NT_STATUS_OK,
+		.doc.num_streams_open_handle = 2,
+		.doc.num_streams_closed_handle = 2,
+		.doc.streams_open_handle = {"::$DATA", AFPRESOURCE_STREAM},
+		.doc.streams_closed_handle = {"::$DATA", AFPRESOURCE_STREAM},
+	};
+
+	struct tcase tcase_foo_ro = (struct tcase) {
+		.name = BASEDIR "\\file:foo",
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE,
+		.write_data = "foo",
+		.write_size = 3,
+		.create.size = 0,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+	};
+
+	struct tcase tcase_foo_rw = (struct tcase) {
+		.name = BASEDIR "\\file:foo",
+		.access = SEC_FILE_READ_DATA|SEC_FILE_READ_ATTRIBUTE|SEC_FILE_WRITE_DATA|SEC_STD_DELETE,
+		.write_data = "foo",
+		.write_size = 3,
+		.create.size = 0,
+		.create.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.create.num_streams_open_handle = 1,
+		.create.num_streams_closed_handle = 1,
+		.create.streams_open_handle = {"::$DATA"},
+		.create.streams_closed_handle = {"::$DATA"},
+		.write.size = 3,
+		.write.initial_status = NT_STATUS_OK,
+		.write.final_status = NT_STATUS_OK,
+		.write.num_streams_open_handle = 2,
+		.write.num_streams_closed_handle = 2,
+		.write.streams_open_handle = {"::$DATA", ":foo:$DATA"},
+		.write.streams_closed_handle = {"::$DATA", ":foo:$DATA"},
+		.overwrite.size = 0,
+		.overwrite.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.overwrite.num_streams_open_handle = 1,
+		.overwrite.num_streams_closed_handle = 1,
+		.overwrite.streams_open_handle = {"::$DATA"},
+		.overwrite.streams_closed_handle = {"::$DATA"},
+		.eof.size = 0,
+		.eof.initial_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.eof.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.eof.num_streams_open_handle = 1,
+		.eof.num_streams_closed_handle = 1,
+		.eof.streams_open_handle = {"::$DATA"},
+		.eof.streams_closed_handle = {"::$DATA"},
+		.doc.size = 3,
+		.doc.initial_status = NT_STATUS_DELETE_PENDING,
+		.doc.final_status = NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		.doc.num_streams_open_handle = 2,
+		.doc.num_streams_closed_handle = 1,
+		.doc.streams_open_handle = {"::$DATA", ":foo:$DATA"},
+		.doc.streams_closed_handle = {"::$DATA"},
+	};
+
+	struct tcase tcases[] = {
+		tcase_afpinfo_ro,
+		tcase_afpinfo_rw,
+		tcase_afpresource_ro,
+		tcase_afpresource_rw,
+		tcase_foo_ro,
+		tcase_foo_rw,
+		{NULL}
+	};
+
+	ret = torture_smb2_connection(tctx, &tree2);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_smb2_connection failed\n");
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed\n");
+
+	ret = enable_aapl(tctx, tree2);
+	torture_assert(tctx, ret == true, "enable_aapl failed\n");
+
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &h1);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir\n");
+	smb2_util_close(tree, h1);
+
+	for (tcase = &tcases[0]; tcase->name != NULL; tcase++) {
+		ret = torture_setup_file(tctx, tree, fname, false);
+		torture_assert_goto(tctx, ret == true, ret, done,
+				    "torture_setup_file failed\n");
+
+		ret = test_empty_stream_do_one(tctx, tree, tree2, tcase);
+		torture_assert_goto(tctx, ret == true, ret, done,
+				    "subtest failed\n");
+
+		status = smb2_util_unlink(tree, fname);
+		torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+						"smb2_util_unlink failed\n");
+	}
+
+done:
+	smb2_deltree(tree, BASEDIR);
+	TALLOC_FREE(tree2);
+	return ret;
+}
+
 /*
  * Note: This test depends on "vfs objects = catia fruit streams_xattr".  For
  * some tests torture must be run on the host it tests and takes an additional
@@ -4861,6 +6246,9 @@ struct torture_suite *torture_vfs_fruit(
 	torture_suite_add_1smb2_test(suite, "copy-chunk streams", test_copy_chunk_streams);
 	torture_suite_add_1smb2_test(suite, "OS X AppleDouble file conversion", test_adouble_conversion);
 	torture_suite_add_1smb2_test(suite, "NFS ACE entries", test_nfs_aces);
+	torture_suite_add_1smb2_test(suite, "OS X AppleDouble file conversion without embedded xattr", test_adouble_conversion_wo_xattr);
+	torture_suite_add_1smb2_test(suite, "empty_stream", test_empty_stream);
+	torture_suite_add_1smb2_test(suite, "writing_afpinfo", test_writing_afpinfo);
 
 	return suite;
 }
@@ -4913,6 +6301,11 @@ static bool test_stream_names_local(stru
 
 	status = smb2_create(tree, mem_ctx, &create);
 	CHECK_STATUS(status, NT_STATUS_OK);
+
+	status = smb2_util_write(tree, create.out.file.handle, "foo", 0, 3);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_write failed\n");
+
 	smb2_util_close(tree, create.out.file.handle);
 
 	ret = torture_setup_local_xattr(tctx, "localdir", BASEDIR "/stream_names.txt",
@@ -5149,3 +6542,194 @@ struct torture_suite *torture_vfs_fruit_
 
 	return suite;
 }
+
+static bool test_convert_xattr_and_empty_rfork_then_delete(
+	struct torture_context *tctx,
+	struct smb2_tree *tree1,
+	struct smb2_tree *tree2)
+{
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	const char *fname = BASEDIR "\\test_adouble_conversion";
+	const char *adname = BASEDIR "/._test_adouble_conversion";
+	const char *rfork = BASEDIR "\\test_adouble_conversion" AFPRESOURCE_STREAM_NAME;
+	NTSTATUS status;
+	struct smb2_handle testdirh;
+	bool ret = true;
+	const char *streams[] = {
+		"::$DATA",
+		AFPINFO_STREAM,
+		":com.apple.metadata" "\xef\x80\xa2" "_kMDItemUserTags:$DATA",
+		":foo" "\xef\x80\xa2" "bar:$DATA", /* "foo:bar:$DATA" */
+	};
+	struct smb2_create create;
+	struct smb2_find find;
+	unsigned int count;
+	union smb_search_data *d;
+	bool delete_empty_adfiles;
+	int expected_num_files;
+
+	delete_empty_adfiles = torture_setting_bool(tctx,
+						    "delete_empty_adfiles",
+						    false);
+
+	smb2_deltree(tree1, BASEDIR);
+
+	status = torture_smb2_testdir(tree1, BASEDIR, &testdirh);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"torture_smb2_testdir failed\n");
+	smb2_util_close(tree1, testdirh);
+
+	ret = torture_setup_file(tctx, tree1, fname, false);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_setup_file failed\n");
+
+	ret = torture_setup_file(tctx, tree1, adname, false);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "torture_setup_file failed\n");
+
+	ret = write_stream(tree1, __location__, tctx, mem_ctx,
+			   adname, NULL,
+			   0, sizeof(osx_adouble_w_xattr), osx_adouble_w_xattr);
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "write_stream failed\n");
+
+	ret = enable_aapl(tctx, tree2);
+	torture_assert_goto(tctx, ret == true, ret, done, "enable_aapl failed");
+
+	/*
+	 * Issue a smb2_find(), this triggers the server-side conversion
+	 */
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_DIR_READ,
+		.in.create_options = NTCREATEX_OPTIONS_DIRECTORY,
+		.in.file_attributes = FILE_ATTRIBUTE_DIRECTORY,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = BASEDIR,
+	};
+
+	status = smb2_create(tree2, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	find = (struct smb2_find) {
+		.in.file.handle = create.out.file.handle,
+		.in.pattern = "*",
+		.in.max_response_size = 0x1000,
+		.in.level = SMB2_FIND_ID_BOTH_DIRECTORY_INFO,
+	};
+
+	status = smb2_find_level(tree2, tree2, &find, &count, &d);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_find_level failed\n");
+
+	status = smb2_util_close(tree2, create.out.file.handle);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_close failed");
+
+	/*
+	 * Check number of streams
+	 */
+
+	ret = check_stream_list(tree2, tctx, fname, 4, streams, false);
+	torture_assert_goto(tctx, ret == true, ret, done, "check_stream_list");
+
+	/*
+	 * Check Resource Fork is gone
+	 */
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_FILE_READ|SEC_RIGHTS_FILE_WRITE,
+		.in.file_attributes = FILE_ATTRIBUTE_NORMAL,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = rfork,
+	};
+
+	status = smb2_create(tree2, mem_ctx, &create);
+	torture_assert_ntstatus_equal_goto(
+		tctx, status, NT_STATUS_OBJECT_NAME_NOT_FOUND,
+		ret, done, "Bad smb2_create return\n");
+
+	/*
+	 * Check xattr data has been migrated from the AppleDouble file to
+	 * streams.
+	 */
+
+	ret = check_stream(tree2, __location__, tctx, mem_ctx,
+			   fname, AFPINFO_STREAM,
+			   0, 60, 16, 8, "TESTSLOW");
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "check AFPINFO_STREAM failed\n");
+
+	ret = check_stream(tree2, __location__, tctx, mem_ctx,
+			   fname, ":foo" "\xef\x80\xa2" "bar", /* foo:bar */
+			   0, 3, 0, 3, "baz");
+	torture_assert_goto(tctx, ret == true, ret, done,
+			    "check foo stream failed\n");
+
+	/*
+	 * Now check number of files. If delete_empty_adfiles is set, the
+	 * AppleDouble files should have been deleted.
+	 */
+
+	create = (struct smb2_create) {
+		.in.desired_access = SEC_RIGHTS_DIR_READ,
+		.in.create_options = NTCREATEX_OPTIONS_DIRECTORY,
+		.in.file_attributes = FILE_ATTRIBUTE_DIRECTORY,
+		.in.share_access = NTCREATEX_SHARE_ACCESS_READ,
+		.in.create_disposition = NTCREATEX_DISP_OPEN,
+		.in.impersonation_level = SMB2_IMPERSONATION_ANONYMOUS,
+		.in.fname = BASEDIR,
+	};
+
+	status = smb2_create(tree2, tctx, &create);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_create failed\n");
+
+	find = (struct smb2_find) {
+		.in.file.handle = create.out.file.handle,
+		.in.pattern = "*",
+		.in.max_response_size = 0x1000,
+		.in.level = SMB2_FIND_ID_BOTH_DIRECTORY_INFO,
+	};
+
+	status = smb2_find_level(tree2, tree2, &find, &count, &d);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_find_level failed\n");
+
+	status = smb2_util_close(tree2, create.out.file.handle);
+	torture_assert_ntstatus_ok_goto(tctx, status, ret, done,
+					"smb2_util_close failed");
+
+	if (delete_empty_adfiles) {
+		expected_num_files = 3;
+	} else {
+		expected_num_files = 4;
+	}
+	torture_assert_int_equal_goto(tctx, count, expected_num_files, ret, done,
+				      "Wrong number of files\n");
+
+done:
+	smb2_deltree(tree1, BASEDIR);
+	talloc_free(mem_ctx);
+	return ret;
+}
+
+struct torture_suite *torture_vfs_fruit_conversion(TALLOC_CTX *ctx)
+{
+	struct torture_suite *suite = torture_suite_create(
+		ctx, "fruit_conversion");
+
+	suite->description = talloc_strdup(
+		suite, "vfs_fruit conversion tests");
+
+	torture_suite_add_2ns_smb2_test(
+		suite, "convert_xattr_and_empty_rfork_then_delete",
+		test_convert_xattr_and_empty_rfork_then_delete);
+
+	return suite;
+}
diff -Npur samba-4.8.7/source4/torture/vfs/vfs.c samba-4.8.8/source4/torture/vfs/vfs.c
--- samba-4.8.7/source4/torture/vfs/vfs.c	2018-11-07 09:12:44.000000000 +0100
+++ samba-4.8.8/source4/torture/vfs/vfs.c	2018-12-13 10:08:40.000000000 +0100
@@ -113,6 +113,7 @@ NTSTATUS torture_vfs_init(TALLOC_CTX *ct
 	torture_suite_add_suite(suite, torture_acl_xattr(suite));
 	torture_suite_add_suite(suite, torture_vfs_fruit_file_id(suite));
 	torture_suite_add_suite(suite, torture_vfs_fruit_timemachine(suite));
+	torture_suite_add_suite(suite, torture_vfs_fruit_conversion(suite));
 
 	torture_register_suite(ctx, suite);
 
diff -Npur samba-4.8.7/testprogs/blackbox/dbcheck-links.sh samba-4.8.8/testprogs/blackbox/dbcheck-links.sh
--- samba-4.8.7/testprogs/blackbox/dbcheck-links.sh	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.8/testprogs/blackbox/dbcheck-links.sh	2018-12-13 10:08:40.000000000 +0100
@@ -131,6 +131,113 @@ check_expected_after_duplicate_links() {
     fi
 }
 
+missing_link_sid_corruption() {
+    # Step1: add user "missingsidu1"
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/missing_link_sid_corruption1.ldif
+    cat > $ldif <<EOF
+dn: CN=missingsidu1,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: add
+objectclass: user
+samaccountname: missingsidu1
+objectGUID: 0da8f25e-d110-11e8-80b7-3c970ec68461
+objectSid: S-1-5-21-4177067393-1453636373-93818738-771
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --relax $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    # Step2: add user "missingsidu2"
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/missing_link_sid_corruption2.ldif
+    cat > $ldif <<EOF
+dn: CN=missingsidu2,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: add
+objectclass: user
+samaccountname: missingsidu2
+objectGUID: 66eb8f52-d110-11e8-ab9b-3c970ec68461
+objectSid: S-1-5-21-4177067393-1453636373-93818738-772
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --relax $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    # Step3: add group "missingsidg3" and add users as members
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/missing_link_sid_corruption3.ldif
+    cat > $ldif <<EOF
+dn: CN=missingsidg3,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: add
+objectclass: group
+samaccountname: missingsidg3
+objectGUID: fd992424-d114-11e8-bb36-3c970ec68461
+objectSid: S-1-5-21-4177067393-1453636373-93818738-773
+member: CN=missingsidu1,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+member: CN=missingsidu2,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --relax $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    # Step4: remove one user again, so that we have one deleted link
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/missing_link_sid_corruption4.ldif
+    cat > $ldif <<EOF
+dn: CN=missingsidg3,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: modify
+delete: member
+member: CN=missingsidu1,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --relax $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    #
+    # Step5: remove the SIDS from the links
+    #
+    LDIF1=$(TZ=UTC $ldbsearch -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb -b 'CN=missingsidg3,CN=users,DC=release-4-5-0-pre1,DC=samba,DC=corp' -s base --reveal --extended-dn --show-binary member)
+    DN=$(echo "${LDIF1}" | grep '^dn: ')
+    MSG=$(echo "${LDIF1}" | grep -v '^dn: ' | grep -v '^#' | grep -v '^$')
+    ldif=$PREFIX_ABS/${RELEASE}/missing_link_sid_corruption5.ldif
+    {
+	echo "${DN}"
+	echo "changetype: modify"
+	echo "replace: member"
+	#echo "${MSG}"
+	echo "${MSG}" | sed \
+		-e 's!<SID=S-1-5-21-4177067393-1453636373-93818738-771>;!!g' \
+		-e 's!<SID=S-1-5-21-4177067393-1453636373-93818738-772>;!!g' \
+		-e 's!RMD_ADDTIME=[1-9][0-9]*!RMD_ADDTIME=123456789000000000!g' \
+		-e 's!RMD_CHANGETIME=[1-9][0-9]*!RMD_CHANGETIME=123456789000000000!g' \
+		| cat
+    } > $ldif
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb.d/DC%3DRELEASE-4-5-0-PRE1,DC%3DSAMBA,DC%3DCORP.ldb $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    return 0
+}
+
+dbcheck_missing_link_sid_corruption() {
+    dbcheck "-missing-link-sid-corruption" "1" ""
+    return $?
+}
+
 forward_link_corruption() {
     #
     # Step1: add a duplicate forward link from
@@ -205,6 +312,67 @@ check_expected_after_dbcheck_forward_lin
     fi
 }
 
+oneway_link_corruption() {
+    #
+    # Step1: add  OU "dangling-ou"
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/oneway_link_corruption.ldif
+    cat > $ldif <<EOF
+dn: OU=dangling-ou,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: add
+objectclass: organizationalUnit
+objectGUID: 20600e7c-92bb-492e-9552-f3ed7f8a2cad
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --relax $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    #
+    # Step2: add  msExchConfigurationContainer "dangling-msexch"
+    #
+    ldif=$PREFIX_ABS/${RELEASE}/oneway_link_corruption2.ldif
+    cat > $ldif <<EOF
+dn: OU=dangling-from,DC=release-4-5-0-pre1,DC=samba,DC=corp
+changetype: add
+objectclass: organizationalUnit
+seeAlso: OU=dangling-ou,DC=release-4-5-0-pre1,DC=samba,DC=corp
+EOF
+
+    out=$(TZ=UTC $ldbmodify -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb $ldif)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+
+    #
+    # Step3: rename dangling-ou to dangling-ou2
+    #
+    # Because this is a one-way link we don't fix it at runtime
+    #
+    out=$(TZ=UTC $ldbrename -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb OU=dangling-ou,DC=release-4-5-0-pre1,DC=samba,DC=corp OU=dangling-ou2,DC=release-4-5-0-pre1,DC=samba,DC=corp)
+    if [ "$?" != "0" ]; then
+	echo "ldbmodify returned:\n$out"
+	return 1
+    fi
+}
+
+dbcheck_oneway_link_corruption() {
+    dbcheck "-oneway-link-corruption" "0" ""
+    return $?
+}
+
+check_expected_after_dbcheck_oneway_link_corruption() {
+    tmpldif=$PREFIX_ABS/$RELEASE/expected-after-dbcheck-oneway-link-corruption.ldif.tmp
+    TZ=UTC $ldbsearch -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb '(|(ou=dangling-ou)(ou=dangling-ou2)(ou=dangling-from))' -s sub -b DC=release-4-5-0-pre1,DC=samba,DC=corp --show-deleted --sorted seeAlso > $tmpldif
+    diff $tmpldif $release_dir/expected-after-dbcheck-oneway-link-corruption.ldif
+    if [ "$?" != "0" ]; then
+	return 1
+    fi
+}
+
 dbcheck_dangling_multi_valued() {
 
     $PYTHON $BINDIR/samba-tool dbcheck -H tdb://$PREFIX_ABS/${RELEASE}/private/sam.ldb --fix --yes
@@ -276,9 +444,16 @@ if [ -d $release_dir ]; then
     testit "dbcheck_forward_link_corruption" dbcheck_forward_link_corruption
     testit "check_expected_after_dbcheck_forward_link_corruption" check_expected_after_dbcheck_forward_link_corruption
     testit "forward_link_corruption_clean" dbcheck_clean
+    testit "oneway_link_corruption" oneway_link_corruption
+    testit "dbcheck_oneway_link_corruption" dbcheck_oneway_link_corruption
+    testit "check_expected_after_dbcheck_oneway_link_corruption" check_expected_after_dbcheck_oneway_link_corruption
+    testit "oneway_link_corruption_clean" dbcheck_clean
     testit "dangling_one_way_link" dangling_one_way_link
     testit "dbcheck_one_way" dbcheck_one_way
     testit "dbcheck_clean2" dbcheck_clean
+    testit "missing_link_sid_corruption" missing_link_sid_corruption
+    testit "dbcheck_missing_link_sid_corruption" dbcheck_missing_link_sid_corruption
+    testit "missing_link_sid_clean" dbcheck_clean
     testit "dangling_one_way_dn" dangling_one_way_dn
     testit "deleted_one_way_dn" deleted_one_way_dn
     testit "dbcheck_clean3" dbcheck_clean
diff -Npur samba-4.8.7/testprogs/blackbox/test_kinit_mit.sh samba-4.8.8/testprogs/blackbox/test_kinit_mit.sh
--- samba-4.8.7/testprogs/blackbox/test_kinit_mit.sh	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.8/testprogs/blackbox/test_kinit_mit.sh	2018-12-13 10:08:40.000000000 +0100
@@ -24,6 +24,7 @@ samba_srcdir="$SRCDIR/source4"
 samba_kinit=kinit
 samba_kdestroy=kdestroy
 samba_kpasswd=kpasswd
+samba_kvno=kvno
 
 samba_tool="$samba_bindir/samba-tool"
 samba_texpect="$samba_bindir/texpect"
@@ -32,13 +33,13 @@ samba_enableaccount="$samba_tool user en
 machineaccountccache="$samba_srcdir/scripting/bin/machineaccountccache"
 
 ldbmodify="ldbmodify"
-if [ -x "$samba4bindir/ldbmodify" ]; then
-	ldbmodify="$samba4bindir/ldbmodify"
+if [ -x "$samba_bindir/ldbmodify" ]; then
+	ldbmodify="$samba_bindir/ldbmodify"
 fi
 
 ldbsearch="ldbsearch"
-if [ -x "$samba4bindir/ldbsearch" ]; then
-	ldbsearch="$samba4bindir/ldbsearch"
+if [ -x "$samba_bindir/ldbsearch" ]; then
+	ldbsearch="$samba_bindir/ldbsearch"
 fi
 
 . `dirname $0`/subunit.sh
@@ -299,6 +300,17 @@ test_smbclient "Test machine account log
 
 testit "reset password policies" $VALGRIND $samba_tool domain passwordsettings $ADMIN_LDBMODIFY_CONFIG set --complexity=default --history-length=default --min-pwd-length=default --min-pwd-age=default --max-pwd-age=default || failed=`expr $failed + 1`
 
+###########################################################
+### Test basic s4u2self request
+###########################################################
+
+# Use previous acquired machine creds to request a ticket for self.
+# We expect it to fail for now.
+MACHINE_ACCOUNT="$(hostname -s | tr [a-z] [A-Z])\$@$REALM"
+$samba_kvno -U$MACHINE_ACCOUNT $MACHINE_ACCOUNT
+# But we expect the KDC to be up and running still
+testit "kinit with machineaccountccache after s4u2self" $machineaccountccache $CONFIGURATION $KRB5CCNAME || failed=`expr $failed + 1`
+
 ### Cleanup
 
 $samba_kdestroy
diff -Npur samba-4.8.7/testprogs/blackbox/test_pdbtest.sh samba-4.8.8/testprogs/blackbox/test_pdbtest.sh
--- samba-4.8.7/testprogs/blackbox/test_pdbtest.sh	2018-01-14 21:41:59.000000000 +0100
+++ samba-4.8.8/testprogs/blackbox/test_pdbtest.sh	2018-12-13 10:08:40.000000000 +0100
@@ -44,12 +44,12 @@ expect retype new password:
 send ${NEWUSERPASS}\n
 EOF
 
-testit "create user with pdbedit" $texpect ./tmpsmbpasswdscript $VALGRIND $pdbedit -a $USER --account-desc="pdbedit-test-user" $@ || failed=`expr $failed + 1`
+testit "create user with pdbedit" $texpect ./tmpsmbpasswdscript $VALGRIND $pdbedit -s $SMB_CONF -a $USER --account-desc="pdbedit-test-user" $@ || failed=`expr $failed + 1`
 USERPASS=$NEWUSERPASS
 
 test_smbclient "Test login with user (ntlm)" 'ls' "$unc" -k no -U$USER%$NEWUSERPASS $@ || failed=`expr $failed + 1`
 
-testit "modify user"  $VALGRIND $pdbedit --modify $USER --drive="D:" $@ || failed=`expr $failed + 1`
+testit "modify user"  $VALGRIND $pdbedit -s $SMB_CONF --modify $USER --drive="D:" $@ || failed=`expr $failed + 1`
 
 test_smbclient "Test login with user (ntlm)" 'ls' "$unc" -k no -U$USER%$NEWUSERPASS $@|| failed=`expr $failed + 1`
 
@@ -87,11 +87,11 @@ test_smbclient "Test login with no expir
 NEWUSERPASS=testPaSS@03%
 NEWUSERHASH=062519096c45739c1938800f80906731
 
-testit "Set user password with password hash" $VALGRIND $pdbedit -u $USER --set-nt-hash $NEWUSERHASH $@ || failed=`expr $failed + 1`
+testit "Set user password with password hash" $VALGRIND $pdbedit -s $SMB_CONF -u $USER --set-nt-hash $NEWUSERHASH $@ || failed=`expr $failed + 1`
 
 test_smbclient "Test login with new password (from hash)" 'ls' "$unc" -k no -U$USER%$NEWUSERPASS || failed=`expr $failed + 1`
 
-testit "del user"  $VALGRIND $pdbedit -x $USER $@ || failed=`expr $failed + 1`
+testit "del user"  $VALGRIND $pdbedit -s $SMB_CONF -x $USER $@ || failed=`expr $failed + 1`
 
 rm ./tmpsmbpasswdscript
 
diff -Npur samba-4.8.7/testprogs/blackbox/test_primary_group.sh samba-4.8.8/testprogs/blackbox/test_primary_group.sh
--- samba-4.8.7/testprogs/blackbox/test_primary_group.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.8/testprogs/blackbox/test_primary_group.sh	2018-12-13 10:08:40.000000000 +0100
@@ -0,0 +1,90 @@
+#!/bin/bash
+
+if [ $# -lt 5 ]; then
+cat <<EOF
+Usage: test_primary_group.sh SERVER USERNAME PASSWORD DOMAIN PREFIX_ABS
+EOF
+exit 1;
+fi
+
+TMPDIR="$PREFIX_ABS/$(basename $0)"
+export TMPDIR
+
+SERVER=$1
+USERNAME=$2
+PASSWORD=$3
+DOMAIN=$4
+PREFIX_ABS=$5
+shift 5
+failed=0
+
+. `dirname $0`/subunit.sh
+. `dirname $0`/common_test_fns.inc
+
+TZ=UTC
+export TZ
+
+N=$(date +%H%M%S)
+
+testuser="testuser$N"
+testgroup="testgroup$N"
+
+echo "testuser: $testuser"
+echo "testgroup: $testgroup"
+
+testit "mkdir -p '${TMPDIR}'" mkdir -p ${TMPDIR} || failed=`expr $failed + 1`
+
+testit "create '$testuser'" $VALGRIND $PYTHON $BINDIR/samba-tool user create "$testuser" Password.1 || failed=`expr $failed + 1`
+testit "add '$testgroup'" $VALGRIND $PYTHON $BINDIR/samba-tool group add "$testgroup" || failed=`expr $failed + 1`
+testit "addmembers '$testgroup' '$testuser'" $VALGRIND $PYTHON $BINDIR/samba-tool group addmembers "$testgroup" "$testuser" || failed=`expr $failed + 1`
+
+testit "search1" $VALGRIND $BINDIR/ldbsearch -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 sAMAccountName="$testgroup" objectSid || failed=`expr $failed + 1`
+ldif="${TMPDIR}/search1.ldif"
+$VALGRIND $BINDIR/ldbsearch -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 sAMAccountName=$testgroup objectSid > $ldif
+rid=$(cat $ldif | sed -n 's/^objectSid: S-1-5-21-.*-.*-.*-//p')
+
+testit "search2" $VALGRIND $BINDIR/ldbsearch -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 sAMAccountName="$testuser" dn || failed=`expr $failed + 1`
+ldif="${TMPDIR}/search2.ldif"
+$VALGRIND $BINDIR/ldbsearch -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 sAMAccountName=$testuser dn > $ldif
+user_dn=$(cat $ldif | sed -n 's/^dn: //p')
+
+ldif="${TMPDIR}/modify1.ldif"
+cat > $ldif <<EOF
+dn: $user_dn
+changetype: modify
+replace: primaryGroupID
+primaryGroupID: $rid
+EOF
+testit "Change primaryGroupID to $rid" $VALGRIND $BINDIR/ldbmodify -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 --verbose < $ldif || failed=`expr $failed + 1`
+
+testit "dbcheck run1" $VALGRIND $PYTHON $BINDIR/samba-tool dbcheck --attrs=member || failed=`expr $failed + 1`
+
+ldif="${TMPDIR}/modify2.ldif"
+cat > $ldif <<EOF
+dn: $user_dn
+changetype: modify
+replace: primaryGroupID
+primaryGroupID: 513
+EOF
+testit "Change primaryGroupID to 513" $VALGRIND $BINDIR/ldbmodify  -H ldap://$SERVER_IP -U$USERNAME%$PASSWORD -d0 < $ldif || failed=`expr $failed + 1`
+
+testit "dbcheck run2" $VALGRIND $PYTHON $BINDIR/samba-tool dbcheck --attrs=member || failed=`expr $failed + 1`
+
+testit "delete '$testuser'" $VALGRIND $PYTHON $BINDIR/samba-tool user delete "$testuser" || failed=`expr $failed + 1`
+testit "delete '$testgroup'" $VALGRIND $PYTHON $BINDIR/samba-tool group delete "$testgroup" || failed=`expr $failed + 1`
+
+#
+# As we don't support phantom objects and virtual backlinks
+# the deletion of the user prior to the group causes dangling links,
+# which are detected like this:
+#
+# WARNING: target DN is deleted for member in object
+#
+# Specifically, this happens because after the member link is
+# deactivated the memberOf is gone, and so there is no way to find the
+# now redundant forward link to clean it up.
+#
+testit_expect_failure "dbcheck run3" $VALGRIND $PYTHON $BINDIR/samba-tool dbcheck --attrs=member --fix --yes || failed=`expr $failed + 1`
+testit "dbcheck run4" $VALGRIND $PYTHON $BINDIR/samba-tool dbcheck --attrs=member || failed=`expr $failed + 1`
+
+exit $failed
