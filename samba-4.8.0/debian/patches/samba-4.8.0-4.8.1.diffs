diff -Npur samba-4.8.0/WHATSNEW.txt samba-4.8.1/WHATSNEW.txt
--- samba-4.8.0/WHATSNEW.txt	2018-03-13 20:05:54.000000000 +0100
+++ samba-4.8.1/WHATSNEW.txt	2018-04-26 09:21:03.000000000 +0200
@@ -1,4 +1,112 @@
                    =============================
+                   Release Notes for Samba 4.8.1
+                           April 26, 2018
+                   =============================
+
+
+This is the latest stable release of the Samba 4.8 release series.
+
+
+Changes since 4.8.0:
+--------------------
+
+o  Jeremy Allison <jra@samba.org>
+   * BUG 13244: s3: ldap: Ensure the ADS_STRUCT pointer doesn't get freed on
+     error, we don't own it here.
+   * BUG 13270: s3: smbd: Fix possible directory fd leak if the underlying OS
+     doesn't support fdopendir().
+   * BUG 13319: Round-tripping ACL get/set through vfs_fruit will increase the
+     number of ACE entries without limit.
+   * BUG 13347: s3: smbd: SMB2: Add DBGC_SMB2_CREDITS class to specifically
+     debug credit issues.
+   * BUG 13358: s3: smbd: Files or directories can't be opened DELETE_ON_CLOSE
+     without delete access.
+   * BUG 13372: s3: smbd: Fix memory leak in vfswrap_getwd().
+   * BUG 13375: s3: smbd: Unix extensions attempts to change wrong field in
+     fchown call.
+
+o  Bj√∂rn Baumbach <bb@sernet.de>
+   * BUG 13337: ms_schema/samba-tool visualize: Fix python2.6 incompatibility.
+
+o  Timur I. Bakeyev <timur@iXsystems.com>
+   * BUG 13352: Fix invocation of gnutls_aead_cipher_encrypt().
+
+o  Ralph Boehme <slow@samba.org>
+   * BUG 13328: Windows 10 cannot logon on Samba NT4 domain.
+   * BUG 13332: winbindd: Recover loss of netlogon secure channel in case the
+     peer DC is rebooted.
+   * BUG 13363: s3:smbd: Don't use the directory cache for SMB2/3.
+
+o  Amitay Isaacs <amitay@gmail.com>
+   * BUG 13356: ctdb-client: Fix bugs in client code.
+   * BUG 13359: ctdb-scripts: Drop "net serverid wipe" from 50.samba event
+     script.
+
+o  Lutz Justen <ljusten@google.com>
+   * BUG 13368: s3: lib: messages: Don't use the result of sec_init() before
+     calling sec_init().
+
+o  Volker Lendecke <vl@samba.org>
+   * BUG 13273: libads: Fix the build '--without-ads'.
+   * BUG 13332: winbind: Keep "force_reauth" in invalidate_cm_connection,
+     add 'smbcontrol disconnect-dc'.
+   * BUG 13343: vfs_virusfilter: Fix CIDs 1428738-1428740.
+   * BUG 13367: dsdb: Fix CID 1034966 Uninitialized scalar variable.
+   * BUG 13370: rpc_server: Fix core dump in dfsgetinfo.
+   * BUG 13382: smbclient: Fix notify.
+
+o  Stefan Metzmacher <metze@samba.org>
+   * BUG 13215: Fix smbd panic if the client-supplied channel sequence number
+     wraps.
+   * BUG 13328: Windows 10 cannot logon on Samba NT4 domain.
+   * BUG 13342: lib/util: Remove unused '#include <sys/syscall.h>' from
+     tests/tfork.c.
+   * BUG 13343:	Fix build errors with cc from developerstudio 12.5 on Solaris.
+   * BUG 13344: Fix the picky-developer build on FreeBSD 11.
+   * BUG 13345: s3:modules: Fix the build of vfs_aixacl2.c.
+
+o  Anton Nefedov
+   * BUG 13338: s3:smbd: map nterror on smb2_flush errorpath.
+
+o  Noel Power <noel.power@suse.com>
+   * BUG 13341: lib:replace: Fix linking when libtirpc-devel overwrites system
+     headers.
+
+o  Christof Schmitt <cs@samba.org>
+   * BUG 13312: winbindd: 'wbinfo --name-to-sid' returns misleading result on
+     invalid query.
+
+o  Andreas Schneider <asn@samba.org>
+   * BUG 13376: s3:passdb: Do not return OK if we don't have pinfo set up.
+
+o  Eric Vannier <evannier@google.com>
+   * BUG 13302: Allow AESNI to be used on all processor supporting AESNI.
+
+
+#######################################
+Reporting bugs & Development Discussion
+#######################################
+
+Please discuss this release on the samba-technical mailing list or by
+joining the #samba-technical IRC channel on irc.freenode.net.
+
+If you do report problems then please try to send high quality
+feedback. If you don't provide vital information to help us track down
+the problem then you will probably be ignored.  All bug reports should
+be filed under the "Samba 4.1 and newer" product in the project's Bugzilla
+database (https://bugzilla.samba.org/).
+
+
+======================================================================
+== Our Code, Our Bugs, Our Responsibility.
+== The Samba Team
+======================================================================
+
+
+Release notes for older releases follow:
+----------------------------------------
+
+                   =============================
                    Release Notes for Samba 4.8.0
                            March 13, 2018
                    =============================
diff -Npur samba-4.8.0/auth/auth_sam_reply.c samba-4.8.1/auth/auth_sam_reply.c
--- samba-4.8.0/auth/auth_sam_reply.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/auth/auth_sam_reply.c	2018-04-26 09:21:03.000000000 +0200
@@ -333,6 +333,41 @@ NTSTATUS make_user_info_SamBaseInfo(TALL
 	return NT_STATUS_OK;
 }
 
+struct auth_user_info *auth_user_info_copy(TALLOC_CTX *mem_ctx,
+					   const struct auth_user_info *src)
+{
+	struct auth_user_info *dst = NULL;
+
+	dst = talloc_zero(mem_ctx, struct auth_user_info);
+	if (dst == NULL) {
+		return NULL;
+	}
+
+	*dst = *src;
+#define _COPY_STRING(_mem, _str) do { \
+	if ((_str) != NULL) { \
+		(_str) = talloc_strdup((_mem), (_str)); \
+		if ((_str) == NULL) { \
+			TALLOC_FREE(dst); \
+			return NULL; \
+		} \
+	} \
+} while(0)
+	_COPY_STRING(dst, dst->account_name);
+	_COPY_STRING(dst, dst->user_principal_name);
+	_COPY_STRING(dst, dst->domain_name);
+	_COPY_STRING(dst, dst->dns_domain_name);
+	_COPY_STRING(dst, dst->full_name);
+	_COPY_STRING(dst, dst->logon_script);
+	_COPY_STRING(dst, dst->profile_path);
+	_COPY_STRING(dst, dst->home_directory);
+	_COPY_STRING(dst, dst->home_drive);
+	_COPY_STRING(dst, dst->logon_server);
+#undef _COPY_STRING
+
+	return dst;
+}
+
 /**
  * Make a user_info_dc struct from the info3 returned by a domain logon
  */
diff -Npur samba-4.8.0/auth/auth_sam_reply.h samba-4.8.1/auth/auth_sam_reply.h
--- samba-4.8.0/auth/auth_sam_reply.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/auth/auth_sam_reply.h	2018-04-26 09:21:03.000000000 +0200
@@ -38,6 +38,9 @@ NTSTATUS make_user_info_SamBaseInfo(TALL
 				    bool authenticated,
 				    struct auth_user_info **_user_info);
 
+struct auth_user_info *auth_user_info_copy(TALLOC_CTX *mem_ctx,
+					   const struct auth_user_info *src);
+
 NTSTATUS auth_convert_user_info_dc_saminfo6(TALLOC_CTX *mem_ctx,
 					   const struct auth_user_info_dc *user_info_dc,
 					   struct netr_SamInfo6 **_sam6);
diff -Npur samba-4.8.0/ctdb/client/client_connect.c samba-4.8.1/ctdb/client/client_connect.c
--- samba-4.8.0/ctdb/client/client_connect.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/ctdb/client/client_connect.c	2018-04-26 09:21:03.000000000 +0200
@@ -297,7 +297,6 @@ static void client_dead_handler(void *pr
 	ctdb_client_callback_func_t callback = client->callback;
 	void *callback_data = client->private_data;
 
-	talloc_free(client);
 	if (callback != NULL) {
 		callback(callback_data);
 		return;
diff -Npur samba-4.8.0/ctdb/client/client_db.c samba-4.8.1/ctdb/client/client_db.c
--- samba-4.8.0/ctdb/client/client_db.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/ctdb/client/client_db.c	2018-04-26 09:21:03.000000000 +0200
@@ -1191,6 +1191,7 @@ struct tevent_req *ctdb_fetch_lock_send(
 	if (tevent_req_nomem(state->h, req)) {
 		return tevent_req_post(req, ev);
 	}
+	state->h->ev = ev;
 	state->h->client = client;
 	state->h->db = db;
 	state->h->key.dptr = talloc_memdup(state->h, key.dptr, key.dsize);
@@ -1413,14 +1414,19 @@ struct ctdb_record_handle *ctdb_fetch_lo
 		offset = ctdb_ltdb_header_len(&h->header);
 
 		data->dsize = h->data.dsize - offset;
-		data->dptr = talloc_memdup(mem_ctx, h->data.dptr + offset,
-					   data->dsize);
-		if (data->dptr == NULL) {
-			TALLOC_FREE(state->h);
-			if (perr != NULL) {
-				*perr = ENOMEM;
+		if (data->dsize == 0) {
+			data->dptr = NULL;
+		} else {
+			data->dptr = talloc_memdup(mem_ctx,
+						   h->data.dptr + offset,
+						   data->dsize);
+			if (data->dptr == NULL) {
+				TALLOC_FREE(state->h);
+				if (perr != NULL) {
+					*perr = ENOMEM;
+				}
+				return NULL;
 			}
-			return NULL;
 		}
 	}
 
diff -Npur samba-4.8.0/ctdb/config/events.d/50.samba samba-4.8.1/ctdb/config/events.d/50.samba
--- samba-4.8.0/ctdb/config/events.d/50.samba	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/ctdb/config/events.d/50.samba	2018-04-26 09:21:03.000000000 +0200
@@ -53,8 +53,6 @@ service_start ()
     # start Samba service. Start it reniced, as under very heavy load
     # the number of smbd processes will mean that it leaves few cycles
     # for anything else
-    net serverid wipe
-
     if [ -n "$CTDB_SERVICE_NMB" ] ; then
 	nice_service "$CTDB_SERVICE_NMB" start || die "Failed to start nmbd"
     fi
diff -Npur samba-4.8.0/ctdb/doc/ctdb-etcd.7 samba-4.8.1/ctdb/doc/ctdb-etcd.7
--- samba-4.8.0/ctdb/doc/ctdb-etcd.7	2018-03-13 20:16:31.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb-etcd.7	2018-04-26 09:25:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-etcd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-ETCD" "7" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-ETCD" "7" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb-statistics.7 samba-4.8.1/ctdb/doc/ctdb-statistics.7
--- samba-4.8.0/ctdb/doc/ctdb-statistics.7	2018-03-13 20:16:31.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb-statistics.7	2018-04-26 09:25:23.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-statistics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-STATISTICS" "7" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-STATISTICS" "7" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb-tunables.7 samba-4.8.1/ctdb/doc/ctdb-tunables.7
--- samba-4.8.0/ctdb/doc/ctdb-tunables.7	2018-03-13 20:16:31.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb-tunables.7	2018-04-26 09:25:23.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb-tunables
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB\-TUNABLES" "7" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB\-TUNABLES" "7" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb.1 samba-4.8.1/ctdb/doc/ctdb.1
--- samba-4.8.0/ctdb/doc/ctdb.1	2018-03-13 20:16:27.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb.1	2018-04-26 09:25:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb.7 samba-4.8.1/ctdb/doc/ctdb.7
--- samba-4.8.0/ctdb/doc/ctdb.7	2018-03-13 20:16:30.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb.7	2018-04-26 09:25:23.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB" "7" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB" "7" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb_diagnostics.1 samba-4.8.1/ctdb/doc/ctdb_diagnostics.1
--- samba-4.8.0/ctdb/doc/ctdb_diagnostics.1	2018-03-13 20:16:29.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb_diagnostics.1	2018-04-26 09:25:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdb_diagnostics
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDB_DIAGNOSTICS" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDB_DIAGNOSTICS" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdb_mutex_ceph_rados_helper.7 samba-4.8.1/ctdb/doc/ctdb_mutex_ceph_rados_helper.7
--- samba-4.8.0/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-03-13 20:16:32.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdb_mutex_ceph_rados_helper.7	2018-04-26 09:25:24.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: Ceph RADOS Mutex
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CEPH RADOS MUTEX" "7" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CEPH RADOS MUTEX" "7" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdbd.1 samba-4.8.1/ctdb/doc/ctdbd.1
--- samba-4.8.0/ctdb/doc/ctdbd.1	2018-03-13 20:16:28.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdbd.1	2018-04-26 09:25:20.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdbd.conf.5 samba-4.8.1/ctdb/doc/ctdbd.conf.5
--- samba-4.8.0/ctdb/doc/ctdbd.conf.5	2018-03-13 20:16:30.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdbd.conf.5	2018-04-26 09:25:22.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd.conf
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD\&.CONF" "5" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD\&.CONF" "5" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ctdbd_wrapper.1 samba-4.8.1/ctdb/doc/ctdbd_wrapper.1
--- samba-4.8.0/ctdb/doc/ctdbd_wrapper.1	2018-03-13 20:16:29.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ctdbd_wrapper.1	2018-04-26 09:25:22.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ctdbd_wrapper
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "CTDBD_WRAPPER" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "CTDBD_WRAPPER" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ltdbtool.1 samba-4.8.1/ctdb/doc/ltdbtool.1
--- samba-4.8.0/ctdb/doc/ltdbtool.1	2018-03-13 20:16:28.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ltdbtool.1	2018-04-26 09:25:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ltdbtool
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "LTDBTOOL" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "LTDBTOOL" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/onnode.1 samba-4.8.1/ctdb/doc/onnode.1
--- samba-4.8.0/ctdb/doc/onnode.1	2018-03-13 20:16:30.000000000 +0100
+++ samba-4.8.1/ctdb/doc/onnode.1	2018-04-26 09:25:22.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: onnode
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "ONNODE" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "ONNODE" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/doc/ping_pong.1 samba-4.8.1/ctdb/doc/ping_pong.1
--- samba-4.8.0/ctdb/doc/ping_pong.1	2018-03-13 20:16:29.000000000 +0100
+++ samba-4.8.1/ctdb/doc/ping_pong.1	2018-04-26 09:25:21.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ping_pong
 .\"    Author: 
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: CTDB - clustered TDB database
 .\"    Source: ctdb
 .\"  Language: English
 .\"
-.TH "PING_PONG" "1" "03/13/2018" "ctdb" "CTDB \- clustered TDB database"
+.TH "PING_PONG" "1" "04/26/2018" "ctdb" "CTDB \- clustered TDB database"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/ctdb/tests/complex/30_nfs_tickle_killtcp.sh samba-4.8.1/ctdb/tests/complex/30_nfs_tickle_killtcp.sh
--- samba-4.8.0/ctdb/tests/complex/30_nfs_tickle_killtcp.sh	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/30_nfs_tickle_killtcp.sh	2018-04-26 09:21:03.000000000 +0200
@@ -46,7 +46,7 @@ test_port=2049
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with netcat..."
 
-nc -d -w 30 $test_ip $test_port &
+sleep 30 | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/ctdb/tests/complex/31_nfs_tickle.sh samba-4.8.1/ctdb/tests/complex/31_nfs_tickle.sh
--- samba-4.8.0/ctdb/tests/complex/31_nfs_tickle.sh	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/31_nfs_tickle.sh	2018-04-26 09:21:03.000000000 +0200
@@ -54,7 +54,7 @@ test_port=2049
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with netcat..."
 
-nc -d -w $(($monitor_interval * 4)) $test_ip $test_port &
+sleep $((monitor_interval * 4)) | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/ctdb/tests/complex/32_cifs_tickle.sh samba-4.8.1/ctdb/tests/complex/32_cifs_tickle.sh
--- samba-4.8.0/ctdb/tests/complex/32_cifs_tickle.sh	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/32_cifs_tickle.sh	2018-04-26 09:21:03.000000000 +0200
@@ -52,7 +52,7 @@ test_port=445
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with netcat..."
 
-nc -d -w $(($monitor_interval * 4)) $test_ip $test_port &
+sleep $((monitor_interval * 4)) | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/ctdb/tests/complex/34_nfs_tickle_restart.sh samba-4.8.1/ctdb/tests/complex/34_nfs_tickle_restart.sh
--- samba-4.8.0/ctdb/tests/complex/34_nfs_tickle_restart.sh	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/34_nfs_tickle_restart.sh	2018-04-26 09:21:03.000000000 +0200
@@ -53,7 +53,7 @@ test_port=2049
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with netcat..."
 
-nc -d -w 600 $test_ip $test_port &
+sleep 600 | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/ctdb/tests/complex/36_smb_reset_server.sh samba-4.8.1/ctdb/tests/complex/36_smb_reset_server.sh
--- samba-4.8.0/ctdb/tests/complex/36_smb_reset_server.sh	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/36_smb_reset_server.sh	2018-04-26 09:21:03.000000000 +0200
@@ -52,7 +52,7 @@ sleep_for 5
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with nc..."
 
-nc -d -w $(($monitor_interval * 4)) $test_ip $test_port &
+sleep $((monitor_interval * 4)) | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/ctdb/tests/complex/37_nfs_reset_server.sh samba-4.8.1/ctdb/tests/complex/37_nfs_reset_server.sh
--- samba-4.8.0/ctdb/tests/complex/37_nfs_reset_server.sh	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/ctdb/tests/complex/37_nfs_reset_server.sh	2018-04-26 09:21:03.000000000 +0200
@@ -52,7 +52,7 @@ sleep_for 5
 
 echo "Connecting to node ${test_node} on IP ${test_ip}:${test_port} with nc..."
 
-nc -d -w $(($monitor_interval * 4)) $test_ip $test_port &
+sleep $((monitor_interval * 4)) | nc $test_ip $test_port &
 nc_pid=$!
 ctdb_test_exit_hook_add "kill $nc_pid >/dev/null 2>&1"
 
diff -Npur samba-4.8.0/docs/manpages/cifsdd.8 samba-4.8.1/docs/manpages/cifsdd.8
--- samba-4.8.0/docs/manpages/cifsdd.8	2018-03-13 20:16:33.000000000 +0100
+++ samba-4.8.1/docs/manpages/cifsdd.8	2018-04-26 09:25:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: cifsdd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "CIFSDD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "CIFSDD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/dbwrap_tool.1 samba-4.8.1/docs/manpages/dbwrap_tool.1
--- samba-4.8.0/docs/manpages/dbwrap_tool.1	2018-03-13 20:16:33.000000000 +0100
+++ samba-4.8.1/docs/manpages/dbwrap_tool.1	2018-04-26 09:25:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: dbwrap_tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "DBWRAP_TOOL" "1" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "DBWRAP_TOOL" "1" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -301,7 +301,7 @@ dbwrap_tool
 Use with caution!
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/eventlogadm.8 samba-4.8.1/docs/manpages/eventlogadm.8
--- samba-4.8.0/docs/manpages/eventlogadm.8	2018-03-13 20:16:34.000000000 +0100
+++ samba-4.8.1/docs/manpages/eventlogadm.8	2018-04-26 09:25:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: eventlogadm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "EVENTLOGADM" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "EVENTLOGADM" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -339,7 +339,7 @@ Filter messages from the system log into
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/findsmb.1 samba-4.8.1/docs/manpages/findsmb.1
--- samba-4.8.0/docs/manpages/findsmb.1	2018-03-13 20:16:34.000000000 +0100
+++ samba-4.8.1/docs/manpages/findsmb.1	2018-04-26 09:25:26.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: findsmb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "FINDSMB" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "FINDSMB" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -119,7 +119,7 @@ IP ADDR         NETBIOS NAME   WORKGROUP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/idmap_ad.8 samba-4.8.1/docs/manpages/idmap_ad.8
--- samba-4.8.0/docs/manpages/idmap_ad.8	2018-03-13 20:16:34.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_ad.8	2018-04-26 09:25:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ad
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_AD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_AD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_autorid.8 samba-4.8.1/docs/manpages/idmap_autorid.8
--- samba-4.8.0/docs/manpages/idmap_autorid.8	2018-03-13 20:16:34.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_autorid.8	2018-04-26 09:25:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_autorid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_AUTORID" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_AUTORID" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_hash.8 samba-4.8.1/docs/manpages/idmap_hash.8
--- samba-4.8.0/docs/manpages/idmap_hash.8	2018-03-13 20:16:35.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_hash.8	2018-04-26 09:25:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_hash
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_HASH" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_HASH" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_ldap.8 samba-4.8.1/docs/manpages/idmap_ldap.8
--- samba-4.8.0/docs/manpages/idmap_ldap.8	2018-03-13 20:16:35.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_ldap.8	2018-04-26 09:25:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_ldap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_LDAP" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_LDAP" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_nss.8 samba-4.8.1/docs/manpages/idmap_nss.8
--- samba-4.8.0/docs/manpages/idmap_nss.8	2018-03-13 20:16:35.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_nss.8	2018-04-26 09:25:27.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_nss
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_NSS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_NSS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_rfc2307.8 samba-4.8.1/docs/manpages/idmap_rfc2307.8
--- samba-4.8.0/docs/manpages/idmap_rfc2307.8	2018-03-13 20:16:35.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_rfc2307.8	2018-04-26 09:25:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rfc2307
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_RFC2307" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_RFC2307" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_rid.8 samba-4.8.1/docs/manpages/idmap_rid.8
--- samba-4.8.0/docs/manpages/idmap_rid.8	2018-03-13 20:16:35.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_rid.8	2018-04-26 09:25:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_rid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_RID" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_RID" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_script.8 samba-4.8.1/docs/manpages/idmap_script.8
--- samba-4.8.0/docs/manpages/idmap_script.8	2018-03-13 20:16:36.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_script.8	2018-04-26 09:25:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_script
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_SCRIPT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_SCRIPT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_tdb.8 samba-4.8.1/docs/manpages/idmap_tdb.8
--- samba-4.8.0/docs/manpages/idmap_tdb.8	2018-03-13 20:16:36.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_tdb.8	2018-04-26 09:25:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_TDB" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/idmap_tdb2.8 samba-4.8.1/docs/manpages/idmap_tdb2.8
--- samba-4.8.0/docs/manpages/idmap_tdb2.8	2018-03-13 20:16:36.000000000 +0100
+++ samba-4.8.1/docs/manpages/idmap_tdb2.8	2018-04-26 09:25:28.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: idmap_tdb2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "IDMAP_TDB2" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "IDMAP_TDB2" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/libsmbclient.7 samba-4.8.1/docs/manpages/libsmbclient.7
--- samba-4.8.0/docs/manpages/libsmbclient.7	2018-03-13 20:16:36.000000000 +0100
+++ samba-4.8.1/docs/manpages/libsmbclient.7	2018-04-26 09:25:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: libsmbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: 7
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "LIBSMBCLIENT" "7" "03/13/2018" "Samba 4\&.8\&.0" "7"
+.TH "LIBSMBCLIENT" "7" "04/26/2018" "Samba 4\&.8\&.1" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ parameter was not included in the URL\&.
 Watch this space for future updates\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/lmhosts.5 samba-4.8.1/docs/manpages/lmhosts.5
--- samba-4.8.0/docs/manpages/lmhosts.5	2018-03-13 20:16:36.000000000 +0100
+++ samba-4.8.1/docs/manpages/lmhosts.5	2018-04-26 09:25:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: lmhosts
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "LMHOSTS" "5" "03/13/2018" "Samba 4\&.8\&.0" "File Formats and Conventions"
+.TH "LMHOSTS" "5" "04/26/2018" "Samba 4\&.8\&.1" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ or
 /usr/local/samba/lib\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbclient\fR(1),
diff -Npur samba-4.8.0/docs/manpages/log2pcap.1 samba-4.8.1/docs/manpages/log2pcap.1
--- samba-4.8.0/docs/manpages/log2pcap.1	2018-03-13 20:16:37.000000000 +0100
+++ samba-4.8.1/docs/manpages/log2pcap.1	2018-04-26 09:25:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: log2pcap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "LOG2PCAP" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "LOG2PCAP" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -107,7 +107,7 @@ Convert to pcap using text2pcap:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "BUGS"
 .PP
 Only SMB data is extracted from the samba logs, no LDAP, NetBIOS lookup or other data\&.
diff -Npur samba-4.8.0/docs/manpages/mvxattr.1 samba-4.8.1/docs/manpages/mvxattr.1
--- samba-4.8.0/docs/manpages/mvxattr.1	2018-03-13 20:16:37.000000000 +0100
+++ samba-4.8.1/docs/manpages/mvxattr.1	2018-04-26 09:25:29.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: mvxattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "MVXATTR" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "MVXATTR" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Force overwriting of destination xattr\&
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/net.8 samba-4.8.1/docs/manpages/net.8
--- samba-4.8.0/docs/manpages/net.8	2018-03-13 20:16:37.000000000 +0100
+++ samba-4.8.1/docs/manpages/net.8	2018-04-26 09:25:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: net
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "NET" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "NET" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/nmbd.8 samba-4.8.1/docs/manpages/nmbd.8
--- samba-4.8.0/docs/manpages/nmbd.8	2018-03-13 20:16:37.000000000 +0100
+++ samba-4.8.1/docs/manpages/nmbd.8	2018-04-26 09:25:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "NMBD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "NMBD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -278,7 +278,7 @@ The debug log level of nmbd may be raise
 (SIGUSR[1|2] signals are no longer used since Samba 2\&.2)\&. This is to allow transient problems to be diagnosed, whilst still running at a normally low log level\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBinetd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/nmblookup.1 samba-4.8.1/docs/manpages/nmblookup.1
--- samba-4.8.0/docs/manpages/nmblookup.1	2018-03-13 20:16:38.000000000 +0100
+++ samba-4.8.1/docs/manpages/nmblookup.1	2018-04-26 09:25:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: nmblookup
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "NMBLOOKUP" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "NMBLOOKUP" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -214,7 +214,7 @@ nmblookup \-U samba\&.org \-R \*(AqIRIX#
 would query the WINS server samba\&.org for the domain master browser (1B name type) for the IRIX workgroup\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/ntlm_auth.1 samba-4.8.1/docs/manpages/ntlm_auth.1
--- samba-4.8.0/docs/manpages/ntlm_auth.1	2018-03-13 20:16:38.000000000 +0100
+++ samba-4.8.1/docs/manpages/ntlm_auth.1	2018-04-26 09:25:30.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: ntlm_auth
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "NTLM_AUTH" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "NTLM_AUTH" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -421,7 +421,7 @@ If you\*(Aqre experiencing problems with
 the Microsoft Knowledge Base article #239869 and follow instructions described there\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/pam_winbind.8 samba-4.8.1/docs/manpages/pam_winbind.8
--- samba-4.8.0/docs/manpages/pam_winbind.8	2018-03-13 20:16:38.000000000 +0100
+++ samba-4.8.1/docs/manpages/pam_winbind.8	2018-04-26 09:25:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: 8
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND" "8" "03/13/2018" "Samba 4\&.8\&.0" "8"
+.TH "PAM_WINBIND" "8" "04/26/2018" "Samba 4\&.8\&.1" "8"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -172,7 +172,7 @@ This is the profile path set in the prof
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of Samba\&.
+This man page is part of version 4\&.8\&.1 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/pam_winbind.conf.5 samba-4.8.1/docs/manpages/pam_winbind.conf.5
--- samba-4.8.0/docs/manpages/pam_winbind.conf.5	2018-03-13 20:16:38.000000000 +0100
+++ samba-4.8.1/docs/manpages/pam_winbind.conf.5	2018-04-26 09:25:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pam_winbind.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: 5
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "PAM_WINBIND\&.CONF" "5" "03/13/2018" "Samba 4\&.8\&.0" "5"
+.TH "PAM_WINBIND\&.CONF" "5" "04/26/2018" "Samba 4\&.8\&.1" "5"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -137,7 +137,7 @@ Defines number of days before pam_winbin
 \fBsmb.conf\fR(5)
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of Samba\&.
+This man page is part of version 4\&.8\&.1 of Samba\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/pdbedit.8 samba-4.8.1/docs/manpages/pdbedit.8
--- samba-4.8.0/docs/manpages/pdbedit.8	2018-03-13 20:16:39.000000000 +0100
+++ samba-4.8.1/docs/manpages/pdbedit.8	2018-04-26 09:25:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: pdbedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "PDBEDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "PDBEDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -619,7 +619,7 @@ option "<name>" to value "<value>" from
 This command may be used only by root\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.0/docs/manpages/profiles.1 samba-4.8.1/docs/manpages/profiles.1
--- samba-4.8.0/docs/manpages/profiles.1	2018-03-13 20:16:39.000000000 +0100
+++ samba-4.8.1/docs/manpages/profiles.1	2018-04-26 09:25:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: profiles
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "PROFILES" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "PROFILES" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/rpcclient.1 samba-4.8.1/docs/manpages/rpcclient.1
--- samba-4.8.0/docs/manpages/rpcclient.1	2018-03-13 20:16:39.000000000 +0100
+++ samba-4.8.1/docs/manpages/rpcclient.1	2018-04-26 09:25:31.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: rpcclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "RPCCLIENT" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "RPCCLIENT" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -803,7 +803,7 @@ and
 that are incompatible for some commands or services\&. Additionally, the developers are sending reports to Microsoft, and problems found or reported to Microsoft are fixed in Service Packs, which may result in incompatibilities\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/samba-regedit.8 samba-4.8.1/docs/manpages/samba-regedit.8
--- samba-4.8.0/docs/manpages/samba-regedit.8	2018-03-13 20:16:39.000000000 +0100
+++ samba-4.8.1/docs/manpages/samba-regedit.8	2018-04-26 09:25:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-regedit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SAMBA\-REGEDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SAMBA\-REGEDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -207,7 +207,7 @@ The supplied password is the NT hash\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/samba-tool.8 samba-4.8.1/docs/manpages/samba-tool.8
--- samba-4.8.0/docs/manpages/samba-tool.8	2018-03-13 20:16:39.000000000 +0100
+++ samba-4.8.1/docs/manpages/samba-tool.8	2018-04-26 09:25:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba-tool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SAMBA\-TOOL" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SAMBA\-TOOL" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -470,7 +470,7 @@ because the repsFrom/To objects are not
 Gives usage information\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.0 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/samba.7 samba-4.8.1/docs/manpages/samba.7
--- samba-4.8.0/docs/manpages/samba.7	2018-03-13 20:16:40.000000000 +0100
+++ samba-4.8.1/docs/manpages/samba.7	2018-04-26 09:25:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: Miscellanea
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SAMBA" "7" "03/13/2018" "Samba 4\&.8\&.0" "Miscellanea"
+.TH "SAMBA" "7" "04/26/2018" "Samba 4\&.8\&.1" "Miscellanea"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -237,7 +237,7 @@ https://lists\&.samba\&.org
 you can find a lot of information in the archives and you can subscribe to the samba list and ask for help or discuss things\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "CONTRIBUTIONS"
 .PP
 If you wish to contribute to the Samba project, then I suggest you join the Samba mailing list at
diff -Npur samba-4.8.0/docs/manpages/samba.8 samba-4.8.1/docs/manpages/samba.8
--- samba-4.8.0/docs/manpages/samba.8	2018-03-13 20:16:40.000000000 +0100
+++ samba-4.8.1/docs/manpages/samba.8	2018-04-26 09:25:32.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: samba
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SAMBA" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SAMBA" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -198,7 +198,7 @@ The number and nature of diagnostics ava
 Most messages are reasonably self\-explanatory\&. Unfortunately, at the time this man page was created, there are too many diagnostics available in the source code to warrant describing each and every diagnostic\&. At this stage your best bet is still to grep the source code and inspect the conditions that gave rise to the diagnostics you are seeing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBhosts_access\fR(5)
diff -Npur samba-4.8.0/docs/manpages/sharesec.1 samba-4.8.1/docs/manpages/sharesec.1
--- samba-4.8.0/docs/manpages/sharesec.1	2018-03-13 20:16:40.000000000 +0100
+++ samba-4.8.1/docs/manpages/sharesec.1	2018-04-26 09:25:33.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: sharesec
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SHARESEC" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SHARESEC" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -337,7 +337,7 @@ List all ACEs for
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/smb.conf.5 samba-4.8.1/docs/manpages/smb.conf.5
--- samba-4.8.0/docs/manpages/smb.conf.5	2018-03-13 20:16:42.000000000 +0100
+++ samba-4.8.1/docs/manpages/smb.conf.5	2018-04-26 09:25:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smb.conf
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMB\&.CONF" "5" "03/13/2018" "Samba 4\&.8\&.0" "File Formats and Conventions"
+.TH "SMB\&.CONF" "5" "04/26/2018" "Samba 4\&.8\&.1" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -3103,7 +3103,7 @@ Example:
 directory name cache size (S)
 .PP
 .RS 4
-This parameter specifies the size of the directory name cache\&. It will be needed to turn this off for *BSD systems\&.
+This parameter specifies the size of the directory name cache for SMB1 connections\&. It is not used for SMB2\&. It will be needed to turn this off for *BSD systems\&.
 .sp
 Default:
 \fI\fIdirectory name cache size\fR\fR\fI = \fR\fI100\fR\fI \fR
@@ -5784,6 +5784,28 @@ This parameter has been extended since t
 .sp -1
 .IP \(bu 2.3
 .\}
+\fIsmb2\fR
+.RE
+.sp
+.RS 4
+.ie n \{\
+\h'-04'\(bu\h'+03'\c
+.\}
+.el \{\
+.sp -1
+.IP \(bu 2.3
+.\}
+\fIsmb2_credits\fR
+.RE
+.sp
+.RS 4
+.ie n \{\
+\h'-04'\(bu\h'+03'\c
+.\}
+.el \{\
+.sp -1
+.IP \(bu 2.3
+.\}
 \fIrpc_parse\fR
 .RE
 .sp
@@ -12931,7 +12953,7 @@ and
 special sections make life for an administrator easy, but the various combinations of default attributes can be tricky\&. Take extreme care when designing these sections\&. In particular, ensure that the permissions on spool directories are correct\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsamba\fR(7),
diff -Npur samba-4.8.0/docs/manpages/smbcacls.1 samba-4.8.1/docs/manpages/smbcacls.1
--- samba-4.8.0/docs/manpages/smbcacls.1	2018-03-13 20:16:42.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbcacls.1	2018-04-26 09:25:34.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcacls
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBCACLS" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBCACLS" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -491,7 +491,7 @@ smbcacls
 couldn\*(Aqt connect to the specified server, or there was an error getting or setting the ACLs, an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/smbclient.1 samba-4.8.1/docs/manpages/smbclient.1
--- samba-4.8.0/docs/manpages/smbclient.1	2018-03-13 20:16:42.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbclient.1	2018-04-26 09:25:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbclient
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBCLIENT" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBCLIENT" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -1151,7 +1151,7 @@ Most diagnostics issued by the client ar
 The number and nature of diagnostics available depends on the debug level used by the client\&. If you have problems, set the debug level to 3 and peruse the log files\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/smbcontrol.1 samba-4.8.1/docs/manpages/smbcontrol.1
--- samba-4.8.0/docs/manpages/smbcontrol.1	2018-03-13 20:16:42.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbcontrol.1	2018-04-26 09:25:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcontrol
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBCONTROL" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBCONTROL" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -309,7 +309,7 @@ Query the number of smbd child processes
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBnmbd\fR(8)
diff -Npur samba-4.8.0/docs/manpages/smbcquotas.1 samba-4.8.1/docs/manpages/smbcquotas.1
--- samba-4.8.0/docs/manpages/smbcquotas.1	2018-03-13 20:16:43.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbcquotas.1	2018-04-26 09:25:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbcquotas
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBCQUOTAS" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBCQUOTAS" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -247,7 +247,7 @@ smbcquotas
 couldn\*(Aqt connect to the specified server, or when there was an error getting or setting the quota(s), an exit status of 1 is returned\&. If there was an error parsing any command line arguments, an exit status of 2 is returned\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/smbd.8 samba-4.8.1/docs/manpages/smbd.8
--- samba-4.8.0/docs/manpages/smbd.8	2018-03-13 20:16:43.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbd.8	2018-04-26 09:25:35.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SMBD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -252,7 +252,7 @@ parameter\&. When this is set, the follo
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "DIAGNOSTICS"
 .PP
 Most diagnostics issued by the server are logged in a specified log file\&. The log file name is specified at compile time, but may be overridden on the command line\&.
diff -Npur samba-4.8.0/docs/manpages/smbget.1 samba-4.8.1/docs/manpages/smbget.1
--- samba-4.8.0/docs/manpages/smbget.1	2018-03-13 20:16:43.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbget.1	2018-04-26 09:25:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbget
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBGET" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBGET" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -189,7 +189,7 @@ smbget \-Rr smb://rhonwyn/
 Permission denied is returned in some cases where the cause of the error is unknown (such as an illegally formatted smb:// url or trying to get a directory without \-R turned on)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/smbgetrc.5 samba-4.8.1/docs/manpages/smbgetrc.5
--- samba-4.8.0/docs/manpages/smbgetrc.5	2018-03-13 20:16:43.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbgetrc.5	2018-04-26 09:25:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbgetrc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBGETRC" "5" "03/13/2018" "Samba 4\&.8\&.0" "File Formats and Conventions"
+.TH "SMBGETRC" "5" "04/26/2018" "Samba 4\&.8\&.1" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -87,7 +87,7 @@ Number of bytes to put in a block\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbget\fR(1)
diff -Npur samba-4.8.0/docs/manpages/smbpasswd.5 samba-4.8.1/docs/manpages/smbpasswd.5
--- samba-4.8.0/docs/manpages/smbpasswd.5	2018-03-13 20:16:43.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbpasswd.5	2018-04-26 09:25:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: File Formats and Conventions
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "5" "03/13/2018" "Samba 4\&.8\&.0" "File Formats and Conventions"
+.TH "SMBPASSWD" "5" "04/26/2018" "Samba 4\&.8\&.1" "File Formats and Conventions"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -165,7 +165,7 @@ This field consists of the time the acco
 All other colon separated fields are ignored at this time\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/smbpasswd.8 samba-4.8.1/docs/manpages/smbpasswd.8
--- samba-4.8.0/docs/manpages/smbpasswd.8	2018-03-13 20:16:44.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbpasswd.8	2018-04-26 09:25:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbpasswd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBPASSWD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SMBPASSWD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -316,7 +316,7 @@ file and neglecting to allow "localhost"
 In addition, the smbpasswd command is only useful if Samba has been set up to use encrypted passwords\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbpasswd\fR(5),
diff -Npur samba-4.8.0/docs/manpages/smbspool.8 samba-4.8.1/docs/manpages/smbspool.8
--- samba-4.8.0/docs/manpages/smbspool.8	2018-03-13 20:16:44.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbspool.8	2018-04-26 09:25:36.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBSPOOL" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SMBSPOOL" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -173,7 +173,7 @@ The filename argument (argv[6]) contains
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.0/docs/manpages/smbspool_krb5_wrapper.8 samba-4.8.1/docs/manpages/smbspool_krb5_wrapper.8
--- samba-4.8.0/docs/manpages/smbspool_krb5_wrapper.8	2018-03-13 20:16:44.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbspool_krb5_wrapper.8	2018-04-26 09:25:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbspool_krb5_wrapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBSPOOL_KRB5_WRAPPE" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "SMBSPOOL_KRB5_WRAPPE" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/smbstatus.1 samba-4.8.1/docs/manpages/smbstatus.1
--- samba-4.8.0/docs/manpages/smbstatus.1	2018-03-13 20:16:44.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbstatus.1	2018-04-26 09:25:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbstatus
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBSTATUS" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBSTATUS" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -154,7 +154,7 @@ causes smbstatus to display numeric UIDs
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8)
diff -Npur samba-4.8.0/docs/manpages/smbtar.1 samba-4.8.1/docs/manpages/smbtar.1
--- samba-4.8.0/docs/manpages/smbtar.1	2018-03-13 20:16:44.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbtar.1	2018-04-26 09:25:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtar
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBTAR" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBTAR" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -145,7 +145,7 @@ section for the
 command\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmbd\fR(8),
diff -Npur samba-4.8.0/docs/manpages/smbtree.1 samba-4.8.1/docs/manpages/smbtree.1
--- samba-4.8.0/docs/manpages/smbtree.1	2018-03-13 20:16:45.000000000 +0100
+++ samba-4.8.1/docs/manpages/smbtree.1	2018-04-26 09:25:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: smbtree
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "SMBTREE" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "SMBTREE" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -191,7 +191,7 @@ Display brief usage message\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/testparm.1 samba-4.8.1/docs/manpages/testparm.1
--- samba-4.8.0/docs/manpages/testparm.1	2018-03-13 20:16:45.000000000 +0100
+++ samba-4.8.1/docs/manpages/testparm.1	2018-04-26 09:25:37.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: testparm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "TESTPARM" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "TESTPARM" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -169,7 +169,7 @@ This is usually the name of the configur
 The program will issue a message saying whether the configuration file loaded OK or not\&. This message may be preceded by errors and warnings if the file did not load\&. If the file was loaded OK, the program then dumps all known service details to stdout\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBsmb.conf\fR(5),
diff -Npur samba-4.8.0/docs/manpages/traffic_learner.7 samba-4.8.1/docs/manpages/traffic_learner.7
--- samba-4.8.0/docs/manpages/traffic_learner.7	2018-03-13 20:16:45.000000000 +0100
+++ samba-4.8.1/docs/manpages/traffic_learner.7	2018-04-26 09:25:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: traffic_learner
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "TRAFFIC_LEARNER" "7" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "TRAFFIC_LEARNER" "7" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ There are two special packet types here\
 The other special packet is "\-", which represents the limit of the conversation\&. In the example, this indicates that one observed conversation ended after this particular ngram\&. This special opcode is also used at the beginning of conversations, which are indicated by the ngram "\-\et\-"\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.0 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_replay\fR(7)\&.
diff -Npur samba-4.8.0/docs/manpages/traffic_replay.7 samba-4.8.1/docs/manpages/traffic_replay.7
--- samba-4.8.0/docs/manpages/traffic_replay.7	2018-03-13 20:16:45.000000000 +0100
+++ samba-4.8.1/docs/manpages/traffic_replay.7	2018-04-26 09:25:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: traffic_replay
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "TRAFFIC_REPLAY" "7" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "TRAFFIC_REPLAY" "7" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -327,7 +327,7 @@ traffic_replay traffic\-model\&.txt my\-
 The users created by the test will have names like STGU\-0\-xyz\&. The groups generated have names like STGG\-0\-xyz\&.
 .SH "VERSION"
 .PP
-This man page is complete for version 4\&.8\&.0 of the Samba suite\&.
+This man page is complete for version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBtraffic_learner\fR(7)\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_acl_tdb.8 samba-4.8.1/docs/manpages/vfs_acl_tdb.8
--- samba-4.8.0/docs/manpages/vfs_acl_tdb.8	2018-03-13 20:16:46.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_acl_tdb.8	2018-04-26 09:25:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_ACL_TDB" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_ACL_TDB" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_acl_xattr.8 samba-4.8.1/docs/manpages/vfs_acl_xattr.8
--- samba-4.8.0/docs/manpages/vfs_acl_xattr.8	2018-03-13 20:16:46.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_acl_xattr.8	2018-04-26 09:25:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_ACL_XATTR" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_ACL_XATTR" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_aio_fork.8 samba-4.8.1/docs/manpages/vfs_aio_fork.8
--- samba-4.8.0/docs/manpages/vfs_aio_fork.8	2018-03-13 20:16:46.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_aio_fork.8	2018-04-26 09:25:38.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_fork
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_AIO_FORK" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_AIO_FORK" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Straight forward use:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_aio_pthread.8 samba-4.8.1/docs/manpages/vfs_aio_pthread.8
--- samba-4.8.0/docs/manpages/vfs_aio_pthread.8	2018-03-13 20:16:46.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_aio_pthread.8	2018-04-26 09:25:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_aio_pthread
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_AIO_PTHREAD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_AIO_PTHREAD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -78,7 +78,7 @@ By default this is set to 100\&.
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_audit.8 samba-4.8.1/docs/manpages/vfs_audit.8
--- samba-4.8.0/docs/manpages/vfs_audit.8	2018-03-13 20:16:46.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_audit.8	2018-04-26 09:25:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_AUDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_AUDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -118,7 +118,7 @@ Log operations on all shares using the L
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_btrfs.8 samba-4.8.1/docs/manpages/vfs_btrfs.8
--- samba-4.8.0/docs/manpages/vfs_btrfs.8	2018-03-13 20:16:47.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_btrfs.8	2018-04-26 09:25:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_btrfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_BTRFS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_BTRFS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -104,7 +104,7 @@ to Windows Explorer as file / directory
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_cacheprime.8 samba-4.8.1/docs/manpages/vfs_cacheprime.8
--- samba-4.8.0/docs/manpages/vfs_cacheprime.8	2018-03-13 20:16:47.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_cacheprime.8	2018-04-26 09:25:39.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cacheprime
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_CACHEPRIME" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_CACHEPRIME" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ cacheprime
 is not a substitute for a general\-purpose readahead mechanism\&. It is intended for use only in very specific environments where disk operations must be aligned and sized to known values (as much as that is possible)\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_cap.8 samba-4.8.1/docs/manpages/vfs_cap.8
--- samba-4.8.0/docs/manpages/vfs_cap.8	2018-03-13 20:16:47.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_cap.8	2018-04-26 09:25:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_cap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_CAP" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_CAP" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -63,7 +63,7 @@ On a system using GNU libiconv, use CAP
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_catia.8 samba-4.8.1/docs/manpages/vfs_catia.8
--- samba-4.8.0/docs/manpages/vfs_catia.8	2018-03-13 20:16:47.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_catia.8	2018-04-26 09:25:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_catia
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_CATIA" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_CATIA" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_ceph.8 samba-4.8.1/docs/manpages/vfs_ceph.8
--- samba-4.8.0/docs/manpages/vfs_ceph.8	2018-03-13 20:16:47.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_ceph.8	2018-04-26 09:25:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_ceph
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_CEPH" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_CEPH" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -80,7 +80,7 @@ Example: ceph:user_id = samba
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_commit.8 samba-4.8.1/docs/manpages/vfs_commit.8
--- samba-4.8.0/docs/manpages/vfs_commit.8	2018-03-13 20:16:48.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_commit.8	2018-04-26 09:25:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_commit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_COMMIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_COMMIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -116,7 +116,7 @@ commit
 may reduce performance\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_crossrename.8 samba-4.8.1/docs/manpages/vfs_crossrename.8
--- samba-4.8.0/docs/manpages/vfs_crossrename.8	2018-03-13 20:16:48.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_crossrename.8	2018-04-26 09:25:40.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_crossrename
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_CROSSRENAME" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_CROSSRENAME" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -89,7 +89,7 @@ To add server\-side cross\-device rename
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_default_quota.8 samba-4.8.1/docs/manpages/vfs_default_quota.8
--- samba-4.8.0/docs/manpages/vfs_default_quota.8	2018-03-13 20:16:48.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_default_quota.8	2018-04-26 09:25:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_default_quota
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_DEFAULT_QUOTA" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_DEFAULT_QUOTA" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -86,7 +86,7 @@ Store the default quota record in the qu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_dirsort.8 samba-4.8.1/docs/manpages/vfs_dirsort.8
--- samba-4.8.0/docs/manpages/vfs_dirsort.8	2018-03-13 20:16:48.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_dirsort.8	2018-04-26 09:25:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_dirsort
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_DIRSORT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_DIRSORT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Sort directories for all shares:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_extd_audit.8 samba-4.8.1/docs/manpages/vfs_extd_audit.8
--- samba-4.8.0/docs/manpages/vfs_extd_audit.8	2018-03-13 20:16:48.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_extd_audit.8	2018-04-26 09:25:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_extd_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_EXTD_AUDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_EXTD_AUDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -55,7 +55,7 @@ is identical to
 This module is stackable\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_fake_perms.8 samba-4.8.1/docs/manpages/vfs_fake_perms.8
--- samba-4.8.0/docs/manpages/vfs_fake_perms.8	2018-03-13 20:16:49.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_fake_perms.8	2018-04-26 09:25:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fake_perms
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_FAKE_PERMS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_FAKE_PERMS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -58,7 +58,7 @@ This module is stackable\&.
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_fileid.8 samba-4.8.1/docs/manpages/vfs_fileid.8
--- samba-4.8.0/docs/manpages/vfs_fileid.8	2018-03-13 20:16:49.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_fileid.8	2018-04-26 09:25:41.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fileid
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_FILEID" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_FILEID" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ algorithm:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_fruit.8 samba-4.8.1/docs/manpages/vfs_fruit.8
--- samba-4.8.0/docs/manpages/vfs_fruit.8	2018-03-13 20:16:49.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_fruit.8	2018-04-26 09:25:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_fruit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_FRUIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_FRUIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_full_audit.8 samba-4.8.1/docs/manpages/vfs_full_audit.8
--- samba-4.8.0/docs/manpages/vfs_full_audit.8	2018-03-13 20:16:49.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_full_audit.8	2018-04-26 09:25:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_full_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_FULL_AUDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_FULL_AUDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -400,7 +400,7 @@ Log file and directory open operations o
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_glusterfs.8 samba-4.8.1/docs/manpages/vfs_glusterfs.8
--- samba-4.8.0/docs/manpages/vfs_glusterfs.8	2018-03-13 20:16:50.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_glusterfs.8	2018-04-26 09:25:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_glusterfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_GLUSTERFS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_GLUSTERFS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -109,7 +109,7 @@ Defines the glusterfs volumename to use
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_gpfs.8 samba-4.8.1/docs/manpages/vfs_gpfs.8
--- samba-4.8.0/docs/manpages/vfs_gpfs.8	2018-03-13 20:16:50.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_gpfs.8	2018-04-26 09:25:42.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_gpfs
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_GPFS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_GPFS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -692,7 +692,7 @@ gpfs\&.h
 in gpfs versions newer than 3\&.2\&.1 PTF8\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_linux_xfs_sgid.8 samba-4.8.1/docs/manpages/vfs_linux_xfs_sgid.8
--- samba-4.8.0/docs/manpages/vfs_linux_xfs_sgid.8	2018-03-13 20:16:50.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_linux_xfs_sgid.8	2018-04-26 09:25:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_media_harmony.8 samba-4.8.1/docs/manpages/vfs_media_harmony.8
--- samba-4.8.0/docs/manpages/vfs_media_harmony.8	2018-03-13 20:16:50.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_media_harmony.8	2018-04-26 09:25:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_media_harmony
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_MEDIA_HARMONY" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_MEDIA_HARMONY" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -138,7 +138,7 @@ vfs_media_harmony
 is designed to work with Avid editing applications that look in the Avid MediaFiles or OMFI MediaFiles directories for media\&. It is not designed to work as expected in all circumstances for general use\&. For example: It is possible to open a client\-specific file such as msmMMOB\&.mdb_192\&.168\&.1\&.10_userx even though it doesn\*(Aqt show up in a directory listing\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_netatalk.8 samba-4.8.1/docs/manpages/vfs_netatalk.8
--- samba-4.8.0/docs/manpages/vfs_netatalk.8	2018-03-13 20:16:50.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_netatalk.8	2018-04-26 09:25:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_netatalk
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_NETATALK" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_NETATALK" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -62,7 +62,7 @@ Hide \&.AppleDouble files on the [data]
 This module is largely historic and unlikely to be of use in modern networks since current Apple systems are able to mount CIFS shares natively\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_nfs4acl_xattr.8 samba-4.8.1/docs/manpages/vfs_nfs4acl_xattr.8
--- samba-4.8.0/docs/manpages/vfs_nfs4acl_xattr.8	2018-03-13 20:16:51.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_nfs4acl_xattr.8	2018-04-26 09:25:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_nfs4acl_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_NFS4ACL_XATTR" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_NFS4ACL_XATTR" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_offline.8 samba-4.8.1/docs/manpages/vfs_offline.8
--- samba-4.8.0/docs/manpages/vfs_offline.8	2018-03-13 20:16:51.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_offline.8	2018-04-26 09:25:43.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_offline
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_OFFLINE" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_OFFLINE" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -59,7 +59,7 @@ Mark all files in a share as offline:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_prealloc.8 samba-4.8.1/docs/manpages/vfs_prealloc.8
--- samba-4.8.0/docs/manpages/vfs_prealloc.8	2018-03-13 20:16:51.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_prealloc.8	2018-04-26 09:25:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_prealloc
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_PREALLOC" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_PREALLOC" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -112,7 +112,7 @@ vfs_prealloc
 is not supported on all platforms and filesystems\&. Currently only XFS filesystems on Linux and IRIX are supported\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_preopen.8 samba-4.8.1/docs/manpages/vfs_preopen.8
--- samba-4.8.0/docs/manpages/vfs_preopen.8	2018-03-13 20:16:51.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_preopen.8	2018-04-26 09:25:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_preopen
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_PREOPEN" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_PREOPEN" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -67,7 +67,7 @@ Number of files that should be speculati
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_readahead.8 samba-4.8.1/docs/manpages/vfs_readahead.8
--- samba-4.8.0/docs/manpages/vfs_readahead.8	2018-03-13 20:16:51.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_readahead.8	2018-04-26 09:25:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readahead
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_READAHEAD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_READAHEAD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -115,7 +115,7 @@ G
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_readonly.8 samba-4.8.1/docs/manpages/vfs_readonly.8
--- samba-4.8.0/docs/manpages/vfs_readonly.8	2018-03-13 20:16:52.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_readonly.8	2018-04-26 09:25:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_readonly
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_READONLY" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_READONLY" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -81,7 +81,7 @@ Mark the [backup] share as read only dur
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_recycle.8 samba-4.8.1/docs/manpages/vfs_recycle.8
--- samba-4.8.0/docs/manpages/vfs_recycle.8	2018-03-13 20:16:52.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_recycle.8	2018-04-26 09:25:44.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_recycle
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_RECYCLE" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_RECYCLE" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -136,7 +136,7 @@ instead of deleting them:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_shadow_copy.8 samba-4.8.1/docs/manpages/vfs_shadow_copy.8
--- samba-4.8.0/docs/manpages/vfs_shadow_copy.8	2018-03-13 20:16:52.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_shadow_copy.8	2018-04-26 09:25:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SHADOW_COPY" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -167,7 +167,7 @@ vfs_shadow_copy
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_shadow_copy2.8 samba-4.8.1/docs/manpages/vfs_shadow_copy2.8
--- samba-4.8.0/docs/manpages/vfs_shadow_copy2.8	2018-03-13 20:16:52.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_shadow_copy2.8	2018-04-26 09:25:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shadow_copy2
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SHADOW_COPY2" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SHADOW_COPY2" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -519,7 +519,7 @@ vfs_shadow_copy2
 is designed to be an end\-user tool only\&. It does not replace or enhance your backup and archival solutions and should in no way be considered as such\&. Additionally, if you need version control, implement a version control system\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_shell_snap.8 samba-4.8.1/docs/manpages/vfs_shell_snap.8
--- samba-4.8.0/docs/manpages/vfs_shell_snap.8	2018-03-13 20:16:53.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_shell_snap.8	2018-04-26 09:25:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_shell_snap
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SHELL_SNAP" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SHELL_SNAP" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ Samba\*(Aqs FSRVP server must be configu
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_snapper.8 samba-4.8.1/docs/manpages/vfs_snapper.8
--- samba-4.8.0/docs/manpages/vfs_snapper.8	2018-03-13 20:16:53.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_snapper.8	2018-04-26 09:25:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_snapper
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SNAPPER" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SNAPPER" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -85,7 +85,7 @@ Remote snapshot creation and deletion is
 The DiskShadow\&.exe FSRVP client initially authenticates as the Active Directory computer account\&. This account must therefore be granted the same permissions as the user account issuing the snapshot creation and deletion requests\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_streams_depot.8 samba-4.8.1/docs/manpages/vfs_streams_depot.8
--- samba-4.8.0/docs/manpages/vfs_streams_depot.8	2018-03-13 20:16:53.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_streams_depot.8	2018-04-26 09:25:45.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_depot
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_DEPOT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_STREAMS_DEPOT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_streams_xattr.8 samba-4.8.1/docs/manpages/vfs_streams_xattr.8
--- samba-4.8.0/docs/manpages/vfs_streams_xattr.8	2018-03-13 20:16:53.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_streams_xattr.8	2018-04-26 09:25:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_streams_xattr
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_STREAMS_XATTR" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_STREAMS_XATTR" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_syncops.8 samba-4.8.1/docs/manpages/vfs_syncops.8
--- samba-4.8.0/docs/manpages/vfs_syncops.8	2018-03-13 20:16:53.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_syncops.8	2018-04-26 09:25:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_syncops
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_SYNCOPS" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_SYNCOPS" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -76,7 +76,7 @@ Add syncops functionality for [share]:
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_time_audit.8 samba-4.8.1/docs/manpages/vfs_time_audit.8
--- samba-4.8.0/docs/manpages/vfs_time_audit.8	2018-03-13 20:16:54.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_time_audit.8	2018-04-26 09:25:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_time_audit
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_TIME_AUDIT" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_TIME_AUDIT" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -72,7 +72,7 @@ This would log VFS calls that take longe
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_tsmsm.8 samba-4.8.1/docs/manpages/vfs_tsmsm.8
--- samba-4.8.0/docs/manpages/vfs_tsmsm.8	2018-03-13 20:16:54.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_tsmsm.8	2018-04-26 09:25:46.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_tsmsm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_TSMSM" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_TSMSM" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -83,7 +83,7 @@ A GPFS mount with TSM support can be exp
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_unityed_media.8 samba-4.8.1/docs/manpages/vfs_unityed_media.8
--- samba-4.8.0/docs/manpages/vfs_unityed_media.8	2018-03-13 20:16:54.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_unityed_media.8	2018-04-26 09:25:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_unityed_media
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_UNITYED_MEDIA" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_UNITYED_MEDIA" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -111,7 +111,7 @@ Enable unityed_media for Mac and Windows
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_virusfilter.8 samba-4.8.1/docs/manpages/vfs_virusfilter.8
--- samba-4.8.0/docs/manpages/vfs_virusfilter.8	2018-03-13 20:16:54.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_virusfilter.8	2018-04-26 09:25:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_virusfilter
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
 .\"    Source: Samba 4.8
 .\"  Language: English
 .\"
-.TH "VFS_VIRUSFILTER" "8" "03/13/2018" "Samba 4\&.8" "System Administration tools"
+.TH "VFS_VIRUSFILTER" "8" "04/26/2018" "Samba 4\&.8" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_worm.8 samba-4.8.1/docs/manpages/vfs_worm.8
--- samba-4.8.0/docs/manpages/vfs_worm.8	2018-03-13 20:16:54.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_worm.8	2018-04-26 09:25:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_worm
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_WORM" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_WORM" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -68,7 +68,7 @@ Deny the write access to files and folde
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfs_xattr_tdb.8 samba-4.8.1/docs/manpages/vfs_xattr_tdb.8
--- samba-4.8.0/docs/manpages/vfs_xattr_tdb.8	2018-03-13 20:16:55.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_xattr_tdb.8	2018-04-26 09:25:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_xattr_tdb
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_XATTR_TDB" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_XATTR_TDB" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -Npur samba-4.8.0/docs/manpages/vfs_zfsacl.8 samba-4.8.1/docs/manpages/vfs_zfsacl.8
--- samba-4.8.0/docs/manpages/vfs_zfsacl.8	2018-03-13 20:16:55.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfs_zfsacl.8	2018-04-26 09:25:47.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfs_zfsacl
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFS_ZFSACL" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "VFS_ZFSACL" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -215,7 +215,7 @@ A ZFS mount can be exported via Samba as
 .\}
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/vfstest.1 samba-4.8.1/docs/manpages/vfstest.1
--- samba-4.8.0/docs/manpages/vfstest.1	2018-03-13 20:16:55.000000000 +0100
+++ samba-4.8.1/docs/manpages/vfstest.1	2018-04-26 09:25:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: vfstest
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "VFSTEST" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "VFSTEST" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -807,7 +807,7 @@ exit
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/wbinfo.1 samba-4.8.1/docs/manpages/wbinfo.1
--- samba-4.8.0/docs/manpages/wbinfo.1	2018-03-13 20:16:55.000000000 +0100
+++ samba-4.8.1/docs/manpages/wbinfo.1	2018-04-26 09:25:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: wbinfo
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: User Commands
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "WBINFO" "1" "03/13/2018" "Samba 4\&.8\&.0" "User Commands"
+.TH "WBINFO" "1" "04/26/2018" "Samba 4\&.8\&.1" "User Commands"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -440,7 +440,7 @@ wbinfo
 will always return failure\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 \fBwinbindd\fR(8)
diff -Npur samba-4.8.0/docs/manpages/winbind_krb5_locator.7 samba-4.8.1/docs/manpages/winbind_krb5_locator.7
--- samba-4.8.0/docs/manpages/winbind_krb5_locator.7	2018-03-13 20:16:55.000000000 +0100
+++ samba-4.8.1/docs/manpages/winbind_krb5_locator.7	2018-04-26 09:25:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbind_krb5_locator
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: 7
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "WINBIND_KRB5_LOCATOR" "7" "03/13/2018" "Samba 4\&.8\&.0" "7"
+.TH "WINBIND_KRB5_LOCATOR" "7" "04/26/2018" "Samba 4\&.8\&.1" "7"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -57,7 +57,7 @@ After copying the locator plugin to the
 /etc/krb5\&.conf\&.
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "AUTHOR"
 .PP
 The original Samba software and related utilities were created by Andrew Tridgell\&. Samba is now developed by the Samba Team as an Open Source project similar to the way the Linux kernel is developed\&.
diff -Npur samba-4.8.0/docs/manpages/winbindd.8 samba-4.8.1/docs/manpages/winbindd.8
--- samba-4.8.0/docs/manpages/winbindd.8	2018-03-13 20:16:56.000000000 +0100
+++ samba-4.8.1/docs/manpages/winbindd.8	2018-04-26 09:25:48.000000000 +0200
@@ -2,12 +2,12 @@
 .\"     Title: winbindd
 .\"    Author: [see the "AUTHOR" section]
 .\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
-.\"      Date: 03/13/2018
+.\"      Date: 04/26/2018
 .\"    Manual: System Administration tools
-.\"    Source: Samba 4.8.0
+.\"    Source: Samba 4.8.1
 .\"  Language: English
 .\"
-.TH "WINBINDD" "8" "03/13/2018" "Samba 4\&.8\&.0" "System Administration tools"
+.TH "WINBINDD" "8" "04/26/2018" "Samba 4\&.8\&.1" "System Administration tools"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -579,7 +579,7 @@ Storage for cached user and group inform
 .RE
 .SH "VERSION"
 .PP
-This man page is part of version 4\&.8\&.0 of the Samba suite\&.
+This man page is part of version 4\&.8\&.1 of the Samba suite\&.
 .SH "SEE ALSO"
 .PP
 nsswitch\&.conf(5),
diff -Npur samba-4.8.0/docs-xml/smbdotconf/logging/loglevel.xml samba-4.8.1/docs-xml/smbdotconf/logging/loglevel.xml
--- samba-4.8.0/docs-xml/smbdotconf/logging/loglevel.xml	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/docs-xml/smbdotconf/logging/loglevel.xml	2018-04-26 09:21:03.000000000 +0200
@@ -22,6 +22,8 @@
 	<listitem><para><parameter moreinfo="none">printdrivers</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">lanman</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">smb</parameter></para></listitem>
+	<listitem><para><parameter moreinfo="none">smb2</parameter></para></listitem>
+	<listitem><para><parameter moreinfo="none">smb2_credits</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_parse</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_srv</parameter></para></listitem>
 	<listitem><para><parameter moreinfo="none">rpc_cli</parameter></para></listitem>
diff -Npur samba-4.8.0/docs-xml/smbdotconf/misc/directorynamecachesize.xml samba-4.8.1/docs-xml/smbdotconf/misc/directorynamecachesize.xml
--- samba-4.8.0/docs-xml/smbdotconf/misc/directorynamecachesize.xml	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/docs-xml/smbdotconf/misc/directorynamecachesize.xml	2018-04-26 09:21:03.000000000 +0200
@@ -4,8 +4,9 @@
                  xmlns:samba="http://www.samba.org/samba/DTD/samba-doc">
 <description>
 	<para>
-	This parameter specifies the size of the directory name cache.
-	It will be needed to turn this off for *BSD systems.
+	This parameter specifies the size of the directory name cache for SMB1
+	connections. It is not used for SMB2. It will be needed to turn this off
+	for *BSD systems.
 	</para>
 
 </description>
diff -Npur samba-4.8.0/lib/crypto/aes.c samba-4.8.1/lib/crypto/aes.c
--- samba-4.8.0/lib/crypto/aes.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/lib/crypto/aes.c	2018-04-26 09:21:03.000000000 +0200
@@ -66,22 +66,6 @@ static bool has_intel_aes_instructions(v
 		return (bool)has_aes_instructions;
 	}
 
-	__cpuid(cpuid_results, 0);
-	/*
-	 *        MSB         LSB
-	 *  EBX = 'u' 'n' 'e' 'G'
-	 *  EDX = 'I' 'e' 'n' 'i'
-	 *  ECX = 'l' 'e' 't' 'n'
-	 */
-	if (memcmp((unsigned char *)&cpuid_results[1], "Genu", 4) != 0 ||
-			memcmp((unsigned char *)&cpuid_results[3],
-				"ineI", 4) != 0 ||
-			memcmp((unsigned char *)&cpuid_results[2],
-				"ntel", 4) != 0) {
-		has_aes_instructions = 0;
-		return (bool)has_aes_instructions;
-	}
-
 	__cpuid(cpuid_results, 1);
 	has_aes_instructions = !!(cpuid_results[2] & (1 << 25));
 	return (bool)has_aes_instructions;
@@ -252,18 +236,20 @@ void
 AES_encrypt(const unsigned char *in, unsigned char *out, const AES_KEY *key)
 {
 	if (has_intel_aes_instructions()) {
-		return AES_encrypt_aesni(in, out, key);
+		AES_encrypt_aesni(in, out, key);
+		return;
 	}
-	return AES_encrypt_rj(in, out, key);
+	AES_encrypt_rj(in, out, key);
 }
 
 void
 AES_decrypt(const unsigned char *in, unsigned char *out, const AES_KEY *key)
 {
 	if (has_intel_aes_instructions()) {
-		return AES_decrypt_aesni(in, out, key);
+		AES_decrypt_aesni(in, out, key);
+		return;
 	}
-	return AES_decrypt_rj(in, out, key);
+	AES_decrypt_rj(in, out, key);
 }
 
 #endif /* SAMBA_RIJNDAEL */
diff -Npur samba-4.8.0/lib/ldb/tests/ldb_mod_op_test.c samba-4.8.1/lib/ldb/tests/ldb_mod_op_test.c
--- samba-4.8.0/lib/ldb/tests/ldb_mod_op_test.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/lib/ldb/tests/ldb_mod_op_test.c	2018-04-26 09:21:03.000000000 +0200
@@ -1914,22 +1914,22 @@ static void test_ldb_modify_during_searc
 
 static void test_ldb_modify_during_indexed_search(void **state)
 {
-	return test_ldb_modify_during_search(state, true, false);
+	test_ldb_modify_during_search(state, true, false);
 }
 
 static void test_ldb_modify_during_unindexed_search(void **state)
 {
-	return test_ldb_modify_during_search(state, false, false);
+	test_ldb_modify_during_search(state, false, false);
 }
 
 static void test_ldb_rename_during_indexed_search(void **state)
 {
-	return test_ldb_modify_during_search(state, true, true);
+	test_ldb_modify_during_search(state, true, true);
 }
 
 static void test_ldb_rename_during_unindexed_search(void **state)
 {
-	return test_ldb_modify_during_search(state, false, true);
+	test_ldb_modify_during_search(state, false, true);
 }
 
 /*
diff -Npur samba-4.8.0/lib/replace/replace.h samba-4.8.1/lib/replace/replace.h
--- samba-4.8.0/lib/replace/replace.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/lib/replace/replace.h	2018-04-26 09:21:03.000000000 +0200
@@ -691,10 +691,12 @@ typedef int bool;
 
 #if !defined(HAVE_INTPTR_T)
 typedef long long intptr_t ;
+#define __intptr_t_defined
 #endif
 
 #if !defined(HAVE_UINTPTR_T)
 typedef unsigned long long uintptr_t ;
+#define __uintptr_t_defined
 #endif
 
 #if !defined(HAVE_PTRDIFF_T)
diff -Npur samba-4.8.0/lib/replace/wscript samba-4.8.1/lib/replace/wscript
--- samba-4.8.0/lib/replace/wscript	2018-01-25 20:55:34.000000000 +0100
+++ samba-4.8.1/lib/replace/wscript	2018-04-26 09:21:03.000000000 +0200
@@ -68,7 +68,15 @@ def configure(conf):
     conf.CHECK_HEADERS('aio.h sys/unistd.h alloca.h float.h')
 
     conf.SET_TARGET_TYPE('tirpc', 'EMPTY')
-    conf.CHECK_HEADERS('rpc/rpc.h rpc/nettype.h')
+
+    if conf.CHECK_CODE(
+            '\n#ifndef _TIRPC_RPC_H\n#error "no tirpc headers in system path"\n#endif\n',
+            'HAVE_RPC_RPC_HEADERS',
+            headers=['rpc/rpc.h', 'rpc/nettype.h'],
+            msg='Checking for tirpc rpc headers in default system path'):
+        if conf.CONFIG_SET('HAVE_RPC_RPC_H'):
+            conf.undefine('HAVE_RPC_RPC_H')
+
     if not conf.CONFIG_SET('HAVE_RPC_RPC_H'):
         if conf.CHECK_CFG(package='libtirpc', args='--cflags --libs',
                        msg='Checking for libtirpc headers',
diff -Npur samba-4.8.0/lib/util/debug.c samba-4.8.1/lib/util/debug.c
--- samba-4.8.0/lib/util/debug.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/lib/util/debug.c	2018-04-26 09:21:03.000000000 +0200
@@ -541,6 +541,8 @@ static const char *default_classname_tab
 	[DBGC_AUTH_AUDIT_JSON] = "auth_json_audit",
 	[DBGC_KERBEROS] =       "kerberos",
 	[DBGC_DRS_REPL] =       "drs_repl",
+	[DBGC_SMB2] =           "smb2",
+	[DBGC_SMB2_CREDITS] =   "smb2_credits",
 };
 
 /*
diff -Npur samba-4.8.0/lib/util/debug.h samba-4.8.1/lib/util/debug.h
--- samba-4.8.0/lib/util/debug.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/lib/util/debug.h	2018-04-26 09:21:03.000000000 +0200
@@ -93,6 +93,8 @@ bool dbghdr( int level, const char *loca
 #define DBGC_AUTH_AUDIT_JSON	25
 #define DBGC_KERBEROS           26
 #define DBGC_DRS_REPL           27
+#define DBGC_SMB2               28
+#define DBGC_SMB2_CREDITS       29
 
 /* So you can define DBGC_CLASS before including debug.h */
 #ifndef DBGC_CLASS
@@ -216,6 +218,14 @@ extern int  *DEBUGLEVEL_CLASS;
 		&& (dbgtext("%s: ", __func__))				\
 		&& (dbgtext body) )
 
+/* Prefix messages with the function name - class specific */
+#define DBGC_PREFIX(dbgc_class, level, body ) \
+	(void)( ((level) <= MAX_DEBUG_LEVEL) &&			\
+		unlikely(DEBUGLEVEL_CLASS[ dbgc_class ] >= (level))	\
+		&& (dbghdrclass(level, dbgc_class, __location__, __func__ )) \
+		&& (dbgtext("%s: ", __func__))				\
+		&& (dbgtext body) )
+
 /*
  * Debug levels matching RFC 3164
  */
@@ -231,12 +241,34 @@ extern int  *DEBUGLEVEL_CLASS;
 #define DBG_INFO(...)		DBG_PREFIX(DBGLVL_INFO,		(__VA_ARGS__))
 #define DBG_DEBUG(...)		DBG_PREFIX(DBGLVL_DEBUG,	(__VA_ARGS__))
 
+#define DBGC_ERR(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_ERR, (__VA_ARGS__))
+#define DBGC_WARNING(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_WARNING,	(__VA_ARGS__))
+#define DBGC_NOTICE(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_NOTICE,	(__VA_ARGS__))
+#define DBGC_INFO(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_INFO,	(__VA_ARGS__))
+#define DBGC_DEBUG(dbgc_class, ...)	DBGC_PREFIX(dbgc_class, \
+						DBGLVL_DEBUG,	(__VA_ARGS__))
+
 #define D_ERR(...)		DEBUG(DBGLVL_ERR,	(__VA_ARGS__))
 #define D_WARNING(...)		DEBUG(DBGLVL_WARNING,	(__VA_ARGS__))
 #define D_NOTICE(...)		DEBUG(DBGLVL_NOTICE,	(__VA_ARGS__))
 #define D_INFO(...)		DEBUG(DBGLVL_INFO,	(__VA_ARGS__))
 #define D_DEBUG(...)		DEBUG(DBGLVL_DEBUG,	(__VA_ARGS__))
 
+#define DC_ERR(...)		DEBUGC(dbgc_class, \
+					DBGLVL_ERR,	(__VA_ARGS__))
+#define DC_WARNING(...)		DEBUGC(dbgc_class, \
+					DBGLVL_WARNING,	(__VA_ARGS__))
+#define DC_NOTICE(...)		DEBUGC(dbgc_class, \
+					DBGLVL_NOTICE,	(__VA_ARGS__))
+#define DC_INFO(...)		DEBUGC(dbgc_class, \
+					DBGLVL_INFO,	(__VA_ARGS__))
+#define DC_DEBUG(...)		DEBUGC(dbgc_class, \
+					DBGLVL_DEBUG,	(__VA_ARGS__))
+
 /* The following definitions come from lib/debug.c  */
 
 /** Possible destinations for the debug log (in order of precedence -
diff -Npur samba-4.8.0/lib/util/tests/tfork.c samba-4.8.1/lib/util/tests/tfork.c
--- samba-4.8.0/lib/util/tests/tfork.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/lib/util/tests/tfork.c	2018-04-26 09:21:03.000000000 +0200
@@ -32,7 +32,6 @@
 #include "lib/util/sys_rw.h"
 #ifdef HAVE_PTHREAD
 #include <pthread.h>
-#include <sys/syscall.h>
 #endif
 
 static bool test_tfork_simple(struct torture_context *tctx)
diff -Npur samba-4.8.0/libcli/security/session.c samba-4.8.1/libcli/security/session.c
--- samba-4.8.0/libcli/security/session.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/libcli/security/session.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 enum security_user_level security_session_user_level(struct auth_session_info *session_info,
 						     const struct dom_sid *domain_sid)
 {
+	bool authenticated = false;
+	bool guest = false;
+
 	if (!session_info) {
 		return SECURITY_ANONYMOUS;
 	}
@@ -38,8 +41,13 @@ enum security_user_level security_sessio
 		return SECURITY_ANONYMOUS;
 	}
 
-	if (security_token_has_builtin_guests(session_info->security_token)) {
-		return SECURITY_GUEST;
+	authenticated = security_token_has_nt_authenticated_users(session_info->security_token);
+	guest = security_token_has_builtin_guests(session_info->security_token);
+	if (!authenticated) {
+		if (guest) {
+			return SECURITY_GUEST;
+		}
+		return SECURITY_ANONYMOUS;
 	}
 
 	if (security_token_has_builtin_administrators(session_info->security_token)) {
@@ -60,9 +68,5 @@ enum security_user_level security_sessio
 		return SECURITY_DOMAIN_CONTROLLER;
 	}
 
-	if (security_token_has_nt_authenticated_users(session_info->security_token)) {
-		return SECURITY_USER;
-	}
-
-	return SECURITY_ANONYMOUS;
+	return SECURITY_USER;
 }
diff -Npur samba-4.8.0/libcli/smb/smb2cli_notify.c samba-4.8.1/libcli/smb/smb2cli_notify.c
--- samba-4.8.0/libcli/smb/smb2cli_notify.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/libcli/smb/smb2cli_notify.c	2018-04-26 09:21:03.000000000 +0200
@@ -30,9 +30,12 @@ struct smb2cli_notify_state {
 	struct iovec *recv_iov;
 	uint8_t *data;
 	uint32_t data_length;
+
+	struct tevent_req *subreq;
 };
 
 static void smb2cli_notify_done(struct tevent_req *subreq);
+static void smb2cli_notify_timedout(struct tevent_req *subreq);
 
 struct tevent_req *smb2cli_notify_send(TALLOC_CTX *mem_ctx,
 				       struct tevent_context *ev,
@@ -64,21 +67,50 @@ struct tevent_req *smb2cli_notify_send(T
 	SIVAL(fixed, 24, completion_filter);
 	SIVAL(fixed, 28, 0); 	/* reserved */
 
-	subreq = smb2cli_req_send(state, ev, conn, SMB2_OP_NOTIFY,
-				  0, 0, /* flags */
-				  timeout_msec,
-				  tcon,
-				  session,
-				  state->fixed, sizeof(state->fixed),
-				  NULL, 0, /* dyn* */
-				  0); /* max_dyn_len */
+	state->subreq = smb2cli_req_send(state, ev, conn, SMB2_OP_NOTIFY,
+					 0, 0, /* flags */
+					 0,	/* timeout_msec */
+					 tcon,
+					 session,
+					 state->fixed, sizeof(state->fixed),
+					 NULL, 0, /* dyn* */
+					 0); /* max_dyn_len */
+	if (tevent_req_nomem(state->subreq, req)) {
+		return tevent_req_post(req, ev);
+	}
+	tevent_req_set_callback(state->subreq, smb2cli_notify_done, req);
+
+	subreq = tevent_wakeup_send(state, ev,
+				    timeval_current_ofs_msec(timeout_msec));
 	if (tevent_req_nomem(subreq, req)) {
 		return tevent_req_post(req, ev);
 	}
-	tevent_req_set_callback(subreq, smb2cli_notify_done, req);
+	tevent_req_set_callback(subreq, smb2cli_notify_timedout, req);
+
 	return req;
 }
 
+static void smb2cli_notify_timedout(struct tevent_req *subreq)
+{
+	struct tevent_req *req = tevent_req_callback_data(
+		subreq, struct tevent_req);
+	struct smb2cli_notify_state *state = tevent_req_data(
+		req, struct smb2cli_notify_state);
+	bool ok;
+
+	ok = tevent_wakeup_recv(subreq);
+	if (!ok) {
+		tevent_req_nterror(req, NT_STATUS_INTERNAL_ERROR);
+		return;
+	}
+
+	ok = tevent_req_cancel(state->subreq);
+	if (!ok) {
+		tevent_req_nterror(req, NT_STATUS_INTERNAL_ERROR);
+		return;
+	}
+}
+
 static void smb2cli_notify_done(struct tevent_req *subreq)
 {
 	struct tevent_req *req = tevent_req_callback_data(
@@ -98,6 +130,10 @@ static void smb2cli_notify_done(struct t
 	status = smb2cli_req_recv(subreq, state, &iov,
 				  expected, ARRAY_SIZE(expected));
 	TALLOC_FREE(subreq);
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_CANCELLED)) {
+		status = NT_STATUS_IO_TIMEOUT;
+	}
 	if (tevent_req_nterror(req, status)) {
 		return;
 	}
diff -Npur samba-4.8.0/librpc/idl/messaging.idl samba-4.8.1/librpc/idl/messaging.idl
--- samba-4.8.0/librpc/idl/messaging.idl	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.1/librpc/idl/messaging.idl	2018-04-26 09:21:03.000000000 +0200
@@ -124,6 +124,7 @@ interface messaging
 		MSG_WINBIND_DOMAIN_ONLINE	= 0x040B,
 		MSG_WINBIND_DOMAIN_OFFLINE	= 0x040C,
 		MSG_WINBIND_RELOAD_TRUSTED_DOMAINS = 0x040D,
+		MSG_WINBIND_DISCONNECT_DC       = 0x040E,
 
 		/* event messages */
 		MSG_DUMP_EVENT_LIST		= 0x0500,
diff -Npur samba-4.8.0/nsswitch/libwbclient/tests/wbclient.c samba-4.8.1/nsswitch/libwbclient/tests/wbclient.c
--- samba-4.8.0/nsswitch/libwbclient/tests/wbclient.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/libwbclient/tests/wbclient.c	2018-04-26 09:21:03.000000000 +0200
@@ -296,6 +296,7 @@ static bool test_wbc_users(struct tortur
 	char *name = NULL;
 	char *sid_string = NULL;
 	wbcErr ret = false;
+	char separator;
 
 	torture_assert_wbc_ok(tctx, wbcInterfaceDetails(&details),
 		"%s", "wbcInterfaceDetails failed");
@@ -306,6 +307,7 @@ static bool test_wbc_users(struct tortur
 			    ret,
 			    fail,
 			    "Failed to allocate domain_name");
+	separator = details->winbind_separator;
 	wbcFreeMemory(details);
 	details = NULL;
 
@@ -323,9 +325,38 @@ static bool test_wbc_users(struct tortur
 		struct wbcDomainSid sid;
 		enum wbcSidType name_type;
 		uint32_t num_sids;
+		const char *user;
+		char *c;
+
+		c = strchr(users[i], separator);
+
+		if (c == NULL) {
+			/*
+			 * NT4 DC
+			 * user name does not contain DOMAIN SEPARATOR prefix.
+			 */
+
+			user = users[i];
+		} else {
+			/*
+			 * AD DC
+			 * user name starts with DOMAIN SEPARATOR prefix.
+			 */
+			const char *dom;
+
+			*c = '\0';
+			dom = users[i];
+			user = c + 1;
+
+			torture_assert_str_equal_goto(tctx, dom, domain_name,
+						      ret, fail, "Domain part "
+						      "of user name does not "
+						      "match domain name.\n");
+		}
 
 		torture_assert_wbc_ok_goto_fail(tctx,
-						wbcLookupName(domain_name, users[i], &sid, &name_type),
+						wbcLookupName(domain_name, user,
+							      &sid, &name_type),
 						"wbcLookupName of %s failed",
 						users[i]);
 		torture_assert_int_equal_goto(tctx,
@@ -399,6 +430,7 @@ static bool test_wbc_groups(struct tortu
 	char *domain = NULL;
 	char *name = NULL;
 	char *sid_string = NULL;
+	char separator;
 
 	torture_assert_wbc_ok(tctx, wbcInterfaceDetails(&details),
 			      "%s", "wbcInterfaceDetails failed");
@@ -409,6 +441,7 @@ static bool test_wbc_groups(struct tortu
 			    ret,
 			    fail,
 			    "Failed to allocate domain_name");
+	separator = details->winbind_separator;
 	wbcFreeMemory(details);
 	details = NULL;
 
@@ -425,10 +458,39 @@ static bool test_wbc_groups(struct tortu
 	for (i=0; i < MIN(num_groups,100); i++) {
 		struct wbcDomainSid sid;
 		enum wbcSidType name_type;
+		const char *group;
+		char *c;
+
+		c = strchr(groups[i], separator);
+
+		if (c == NULL) {
+			/*
+			 * NT4 DC
+			 * group name does not contain DOMAIN SEPARATOR prefix.
+			 */
+
+			group = groups[i];
+		} else {
+			/*
+			 * AD DC
+			 * group name starts with DOMAIN SEPARATOR prefix.
+			 */
+			const char *dom;
+
+
+			*c = '\0';
+			dom = groups[i];
+			group = c + 1;
+
+			torture_assert_str_equal_goto(tctx, dom, domain_name,
+						      ret, fail, "Domain part "
+						      "of group name does not "
+						      "match domain name.\n");
+		}
 
 		torture_assert_wbc_ok_goto_fail(tctx,
 						wbcLookupName(domain_name,
-							      groups[i],
+							      group,
 							      &sid,
 							      &name_type),
 						"wbcLookupName for %s failed",
diff -Npur samba-4.8.0/nsswitch/tests/test_wbinfo_name_lookup.sh samba-4.8.1/nsswitch/tests/test_wbinfo_name_lookup.sh
--- samba-4.8.0/nsswitch/tests/test_wbinfo_name_lookup.sh	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.1/nsswitch/tests/test_wbinfo_name_lookup.sh	2018-04-26 09:21:03.000000000 +0200
@@ -0,0 +1,40 @@
+#!/bin/sh
+# Blackbox test for wbinfo name lookup
+if [ $# -lt 2 ]; then
+cat <<EOF
+Usage: test_wbinfo.sh DOMAIN DC_USERNAME
+EOF
+exit 1;
+fi
+
+DOMAIN=$1
+DC_USERNAME=$2
+shift 2
+
+failed=0
+sambabindir="$BINDIR"
+wbinfo="$VALGRIND $sambabindir/wbinfo"
+
+. `dirname $0`/../../testprogs/blackbox/subunit.sh
+
+# Correct query is expected to work
+testit "name-to-sid.single-separator" \
+       $wbinfo -n $DOMAIN/$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Two separator characters should fail
+testit_expect_failure "name-to-sid.double-separator" \
+		      $wbinfo -n $DOMAIN//$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Invalid domain is expected to fail
+testit_expect_failure "name-to-sid.invalid-domain" \
+		      $wbinfo -n INVALID/$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+# Invalid domain with two separator characters is expected to fail
+testit_expect_failure "name-to-sid.double-separator-invalid-domain" \
+		      $wbinfo -n INVALID//$DC_USERNAME || \
+	failed=$(expr $failed + 1)
+
+exit $failed
diff -Npur samba-4.8.0/nsswitch/winbind_nss.h samba-4.8.1/nsswitch/winbind_nss.h
--- samba-4.8.0/nsswitch/winbind_nss.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss.h	2018-04-26 09:21:03.000000000 +0200
@@ -30,6 +30,7 @@
  */
 
 #include "nsswitch/winbind_nss_solaris.h"
+#include "nsswitch/winbind_nss_linux.h"
 
 #elif HAVE_NSS_H
 
@@ -37,6 +38,10 @@
  * Linux (glibc)
  */
 
+#include <nss.h>
+
+typedef enum nss_status NSS_STATUS;
+
 #include "nsswitch/winbind_nss_linux.h"
 
 #elif HAVE_NS_API_H
@@ -60,6 +65,7 @@
  */
 
 #include "nsswitch/winbind_nss_netbsd.h"
+#include "nsswitch/winbind_nss_linux.h"
 
 #else /* Nothing's defined. Neither gnu nor netbsd nor sun nor hp */
 
diff -Npur samba-4.8.0/nsswitch/winbind_nss_freebsd.c samba-4.8.1/nsswitch/winbind_nss_freebsd.c
--- samba-4.8.0/nsswitch/winbind_nss_freebsd.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss_freebsd.c	2018-04-26 09:21:03.000000000 +0200
@@ -24,25 +24,6 @@
 #include "winbind_client.h"
 
 /* Make sure that the module gets registered needed by freebsd 5.1 */
-extern enum nss_status _nss_winbind_getgrent_r(struct group *, char *, size_t,
-    int *);
-extern enum nss_status _nss_winbind_getgrnam_r(const char *, struct group *,
-    char *, size_t, int *);
-extern enum nss_status _nss_winbind_getgrgid_r(gid_t gid, struct group *, char *,
-    size_t, int *);
-extern enum nss_status _nss_winbind_setgrent(void);
-extern enum nss_status _nss_winbind_endgrent(void);
-extern enum nss_status _nss_winbind_initgroups_dyn(char *, gid_t, long int *,
-    long int *, gid_t **, long int , int *);
-
-extern enum nss_status _nss_winbind_getpwent_r(struct passwd *, char *, size_t,
-    int *);
-extern enum nss_status _nss_winbind_getpwnam_r(const char *, struct passwd *,
-    char *, size_t, int *);
-extern enum nss_status _nss_winbind_getpwuid_r(gid_t gid, struct passwd *, char *,
-    size_t, int *);
-extern enum nss_status _nss_winbind_setpwent(void);
-extern enum nss_status _nss_winbind_endpwent(void);
 ns_mtab *nss_module_register(const char *, unsigned int *, nss_module_unregister_fn *);
 
 NSS_METHOD_PROTOTYPE(__nss_compat_getgrnam_r);
diff -Npur samba-4.8.0/nsswitch/winbind_nss_linux.c samba-4.8.1/nsswitch/winbind_nss_linux.c
--- samba-4.8.0/nsswitch/winbind_nss_linux.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss_linux.c	2018-04-26 09:21:03.000000000 +0200
@@ -36,28 +36,6 @@ static pthread_mutex_t winbind_nss_mutex
 #define MAX_GETPWENT_USERS 250
 #define MAX_GETGRENT_USERS 250
 
-NSS_STATUS _nss_winbind_setpwent(void);
-NSS_STATUS _nss_winbind_endpwent(void);
-NSS_STATUS _nss_winbind_getpwent_r(struct passwd *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getpwuid_r(uid_t uid, struct passwd *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getpwnam_r(const char *name, struct passwd *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_setgrent(void);
-NSS_STATUS _nss_winbind_endgrent(void);
-NSS_STATUS _nss_winbind_getgrent_r(struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrlst_r(struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrnam_r(const char *name, struct group *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrgid_r(gid_t gid, struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_initgroups_dyn(char *user, gid_t group, long int *start,
-				       long int *size, gid_t **groups,
-				       long int limit, int *errnop);
-
 /*************************************************************************
  ************************************************************************/
 
@@ -1046,7 +1024,7 @@ _nss_winbind_getgrgid_r(gid_t gid,
 /* Initialise supplementary groups */
 
 NSS_STATUS
-_nss_winbind_initgroups_dyn(char *user, gid_t group, long int *start,
+_nss_winbind_initgroups_dyn(const char *user, gid_t group, long int *start,
 			    long int *size, gid_t **groups, long int limit,
 			    int *errnop)
 {
diff -Npur samba-4.8.0/nsswitch/winbind_nss_linux.h samba-4.8.1/nsswitch/winbind_nss_linux.h
--- samba-4.8.0/nsswitch/winbind_nss_linux.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss_linux.h	2018-04-26 09:21:03.000000000 +0200
@@ -22,8 +22,26 @@
 #ifndef _WINBIND_NSS_LINUX_H
 #define _WINBIND_NSS_LINUX_H
 
-#include <nss.h>
-
-typedef enum nss_status NSS_STATUS;
+NSS_STATUS _nss_winbind_setpwent(void);
+NSS_STATUS _nss_winbind_endpwent(void);
+NSS_STATUS _nss_winbind_getpwent_r(struct passwd *result, char *buffer,
+				   size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_getpwuid_r(uid_t uid, struct passwd *result,
+				   char *buffer, size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_getpwnam_r(const char *name, struct passwd *result,
+				   char *buffer, size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_setgrent(void);
+NSS_STATUS _nss_winbind_endgrent(void);
+NSS_STATUS _nss_winbind_getgrent_r(struct group *result, char *buffer,
+				   size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_getgrlst_r(struct group *result, char *buffer,
+				   size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_getgrnam_r(const char *name, struct group *result,
+				   char *buffer, size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_getgrgid_r(gid_t gid, struct group *result, char *buffer,
+				   size_t buflen, int *errnop);
+NSS_STATUS _nss_winbind_initgroups_dyn(const char *user, gid_t group, long int *start,
+				       long int *size, gid_t **groups,
+				       long int limit, int *errnop);
 
 #endif /* _WINBIND_NSS_LINUX_H */
diff -Npur samba-4.8.0/nsswitch/winbind_nss_netbsd.c samba-4.8.1/nsswitch/winbind_nss_netbsd.c
--- samba-4.8.0/nsswitch/winbind_nss_netbsd.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss_netbsd.c	2018-04-26 09:21:03.000000000 +0200
@@ -38,32 +38,6 @@
 static struct group	_winbind_group;
 static char		_winbind_groupbuf[1024];
 
-/*
- * We need a proper prototype for this :-)
- */
-
-NSS_STATUS _nss_winbind_setpwent(void);
-NSS_STATUS _nss_winbind_endpwent(void);
-NSS_STATUS _nss_winbind_getpwent_r(struct passwd *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getpwuid_r(uid_t uid, struct passwd *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getpwnam_r(const char *name, struct passwd *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_setgrent(void);
-NSS_STATUS _nss_winbind_endgrent(void);
-NSS_STATUS _nss_winbind_getgrent_r(struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrlst_r(struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrnam_r(const char *name, struct group *result,
-				   char *buffer, size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrgid_r(gid_t gid, struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_initgroups_dyn(char *user, gid_t group, long int *start,
-				       long int *size, gid_t **groups,
-				       long int limit, int *errnop);
-
 int
 netbsdwinbind_endgrent(void *nsrv, void *nscb, va_list ap)
 {
diff -Npur samba-4.8.0/nsswitch/winbind_nss_solaris.h samba-4.8.1/nsswitch/winbind_nss_solaris.h
--- samba-4.8.0/nsswitch/winbind_nss_solaris.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/winbind_nss_solaris.h	2018-04-26 09:21:03.000000000 +0200
@@ -34,30 +34,4 @@ typedef nss_status_t NSS_STATUS;
 #define NSS_STATUS_UNAVAIL     NSS_UNAVAIL
 #define NSS_STATUS_TRYAGAIN    NSS_TRYAGAIN
 
-/* The solaris winbind is implemented as a wrapper around the linux
-   version. */
-
-NSS_STATUS _nss_winbind_setpwent(void);
-NSS_STATUS _nss_winbind_endpwent(void);
-NSS_STATUS _nss_winbind_getpwent_r(struct passwd* result, char* buffer,
-				   size_t buflen, int* errnop);
-NSS_STATUS _nss_winbind_getpwuid_r(uid_t, struct passwd*, char* buffer,
-				   size_t buflen, int* errnop);
-NSS_STATUS _nss_winbind_getpwnam_r(const char* name, struct passwd* result,
-				   char* buffer, size_t buflen, int* errnop);
-
-NSS_STATUS _nss_winbind_setgrent(void);
-NSS_STATUS _nss_winbind_endgrent(void);
-NSS_STATUS _nss_winbind_getgrent_r(struct group* result, char* buffer,
-				   size_t buflen, int* errnop);
-NSS_STATUS _nss_winbind_getgrnam_r(const char *name,
-				   struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_getgrgid_r(gid_t gid,
-				   struct group *result, char *buffer,
-				   size_t buflen, int *errnop);
-NSS_STATUS _nss_winbind_initgroups_dyn(char *user, gid_t group, long int *start,
-				       long int *size, gid_t **groups,
-				       long int limit, int *errnop);
-
 #endif /* _WINBIND_NSS_SOLARIS_H */
diff -Npur samba-4.8.0/nsswitch/wins.c samba-4.8.1/nsswitch/wins.c
--- samba-4.8.0/nsswitch/wins.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/nsswitch/wins.c	2018-04-26 09:21:03.000000000 +0200
@@ -19,7 +19,7 @@
 */
 
 #include "includes.h"
-#include "nsswitch/winbind_nss.h"
+#include "nsswitch/winbind_client.h"
 #include "nsswitch/libwbclient/wbclient.h"
 
 #ifdef HAVE_NS_API_H
diff -Npur samba-4.8.0/python/samba/ms_schema.py samba-4.8.1/python/samba/ms_schema.py
--- samba-4.8.0/python/samba/ms_schema.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/python/samba/ms_schema.py	2018-04-26 09:21:03.000000000 +0200
@@ -277,7 +277,7 @@ def __transform_entry(entry, objectClass
 
     header.append(["objectGUID", str(uuid.uuid4()), False])
 
-    entry = header + [x for x in entry if x[0].lower() not in {'dn', 'changetype', 'objectcategory'}]
+    entry = header + [x for x in entry if x[0].lower() not in set(['dn', 'changetype', 'objectcategory'])]
 
     return entry
 
diff -Npur samba-4.8.0/python/samba/netcmd/visualize.py samba-4.8.1/python/samba/netcmd/visualize.py
--- samba-4.8.0/python/samba/netcmd/visualize.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/python/samba/netcmd/visualize.py	2018-04-26 09:21:03.000000000 +0200
@@ -176,7 +176,11 @@ def get_partition_maps(samdb):
         "DNSDOMAIN": "DC=DomainDnsZones,%s" % base_dn,
         "DNSFOREST": "DC=ForestDnsZones,%s" % base_dn
     }
-    long_to_short = {v: k for k, v in short_to_long.iteritems()}
+
+    long_to_short = {}
+    for s, l in short_to_long.iteritems():
+        long_to_short[l] = s
+
     return short_to_long, long_to_short
 
 
diff -Npur samba-4.8.0/selftest/target/Samba3.pm samba-4.8.1/selftest/target/Samba3.pm
--- samba-4.8.0/selftest/target/Samba3.pm	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/selftest/target/Samba3.pm	2018-04-26 09:21:03.000000000 +0200
@@ -1929,6 +1929,16 @@ sub provision($$$$$$$$$)
 
 [vfs_fruit]
 	path = $shrdir
+	vfs objects = catia fruit streams_xattr acl_xattr xattr_tdb
+	fruit:resource = file
+	fruit:metadata = netatalk
+	fruit:locking = netatalk
+	fruit:encoding = native
+	fruit:veto_appledouble = no
+
+[vfs_fruit_xattr]
+	path = $shrdir
+        # This is used by vfs.fruit tests that require real fs xattr
 	vfs objects = catia fruit streams_xattr acl_xattr
 	fruit:resource = file
 	fruit:metadata = netatalk
@@ -1938,29 +1948,29 @@ sub provision($$$$$$$$$)
 
 [vfs_fruit_metadata_stream]
 	path = $shrdir
-	vfs objects = fruit streams_xattr acl_xattr
+	vfs objects = fruit streams_xattr acl_xattr xattr_tdb
 	fruit:resource = file
 	fruit:metadata = stream
 	fruit:veto_appledouble = no
 
 [vfs_fruit_stream_depot]
 	path = $shrdir
-	vfs objects = fruit streams_depot acl_xattr
+	vfs objects = fruit streams_depot acl_xattr xattr_tdb
 	fruit:resource = stream
 	fruit:metadata = stream
 	fruit:veto_appledouble = no
 
 [vfs_wo_fruit]
 	path = $shrdir
-	vfs objects = streams_xattr acl_xattr
+	vfs objects = streams_xattr acl_xattr xattr_tdb
 
 [vfs_wo_fruit_stream_depot]
 	path = $shrdir
-	vfs objects = streams_depot acl_xattr
+	vfs objects = streams_depot acl_xattr xattr_tdb
 
 [vfs_fruit_timemachine]
 	path = $shrdir
-	vfs objects = fruit streams_xattr acl_xattr
+	vfs objects = fruit streams_xattr acl_xattr xattr_tdb
 	fruit:resource = file
 	fruit:metadata = stream
 	fruit:time machine = yes
diff -Npur samba-4.8.0/source3/auth/auth_builtin.c samba-4.8.1/source3/auth/auth_builtin.c
--- samba-4.8.0/source3/auth/auth_builtin.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/auth/auth_builtin.c	2018-04-26 09:21:03.000000000 +0200
@@ -81,7 +81,7 @@ static NTSTATUS check_guest_security(con
 		break;
 	}
 
-	return make_server_info_guest(NULL, server_info);
+	return make_server_info_anonymous(NULL, server_info);
 }
 
 /* Guest modules initialisation */
diff -Npur samba-4.8.0/source3/auth/auth_ntlmssp.c samba-4.8.1/source3/auth/auth_ntlmssp.c
--- samba-4.8.0/source3/auth/auth_ntlmssp.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/auth/auth_ntlmssp.c	2018-04-26 09:21:03.000000000 +0200
@@ -65,10 +65,7 @@ NTSTATUS auth3_generate_session_info(str
 
 		cmp = dom_sid_compare(sid, &global_sid_Anonymous);
 		if (cmp == 0) {
-			/*
-			 * TODO: use auth_anonymous_session_info() here?
-			 */
-			return make_session_info_guest(mem_ctx, session_info);
+			return make_session_info_anonymous(mem_ctx, session_info);
 		}
 
 		return NT_STATUS_INTERNAL_ERROR;
diff -Npur samba-4.8.0/source3/auth/auth_util.c samba-4.8.1/source3/auth/auth_util.c
--- samba-4.8.0/source3/auth/auth_util.c	2018-01-25 20:55:34.000000000 +0100
+++ samba-4.8.1/source3/auth/auth_util.c	2018-04-26 09:21:03.000000000 +0200
@@ -37,6 +37,7 @@
 #include "lib/param/loadparm.h"
 #include "../lib/tsocket/tsocket.h"
 #include "rpc_client/util_netlogon.h"
+#include "source4/auth/auth.h"
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_AUTH
@@ -471,6 +472,26 @@ NTSTATUS create_local_token(TALLOC_CTX *
 		return NT_STATUS_LOGON_FAILURE;
 	}
 
+	if (server_info->cached_session_info != NULL) {
+		session_info = copy_session_info(mem_ctx,
+				server_info->cached_session_info);
+		if (session_info == NULL) {
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		/* This is a potentially untrusted username for use in %U */
+		alpha_strcpy(tmp, smb_username, ". _-$", sizeof(tmp));
+		session_info->unix_info->sanitized_username =
+				talloc_strdup(session_info->unix_info, tmp);
+		if (session_info->unix_info->sanitized_username == NULL) {
+			TALLOC_FREE(session_info);
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		*session_info_out = session_info;
+		return NT_STATUS_OK;
+	}
+
 	session_info = talloc_zero(mem_ctx, struct auth_session_info);
 	if (!session_info) {
 		return NT_STATUS_NO_MEMORY;
@@ -525,30 +546,6 @@ NTSTATUS create_local_token(TALLOC_CTX *
 		return status;
 	}
 
-	if (server_info->security_token) {
-		/* Just copy the token, it has already been finalised
-		 * (nasty hack to support a cached guest/system session_info
-		 */
-
-		session_info->security_token = dup_nt_token(session_info, server_info->security_token);
-		if (!session_info->security_token) {
-			TALLOC_FREE(session_info);
-			return NT_STATUS_NO_MEMORY;
-		}
-
-		session_info->unix_token->ngroups = server_info->utok.ngroups;
-		if (server_info->utok.ngroups != 0) {
-			session_info->unix_token->groups = (gid_t *)talloc_memdup(
-				session_info->unix_token, server_info->utok.groups,
-				sizeof(gid_t)*session_info->unix_token->ngroups);
-		} else {
-			session_info->unix_token->groups = NULL;
-		}
-
-		*session_info_out = session_info;
-		return NT_STATUS_OK;
-	}
-
 	/*
 	 * If winbind is not around, we can not make much use of the SIDs the
 	 * domain controller provided us with. Likewise if the user name was
@@ -633,7 +630,11 @@ NTSTATUS create_local_token(TALLOC_CTX *
 	 */
 
 	uid_to_unix_users_sid(session_info->unix_token->uid, &tmp_sid);
+	add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+				&session_info->security_token->sids,
+				&session_info->security_token->num_sids);
 
+	gid_to_unix_groups_sid(session_info->unix_token->gid, &tmp_sid);
 	add_sid_to_array_unique(session_info->security_token, &tmp_sid,
 				&session_info->security_token->sids,
 				&session_info->security_token->num_sids);
@@ -661,6 +662,558 @@ NTSTATUS create_local_token(TALLOC_CTX *
 	return NT_STATUS_OK;
 }
 
+NTSTATUS auth3_user_info_dc_add_hints(struct auth_user_info_dc *user_info_dc,
+				      uid_t uid,
+				      gid_t gid,
+				      uint32_t flags)
+{
+	uint32_t orig_num_sids = user_info_dc->num_sids;
+	struct dom_sid tmp_sid = { 0, };
+	NTSTATUS status;
+
+	/*
+	 * We add S-5-88-1-X in order to pass the uid
+	 * for the unix token.
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Users,
+		    (uint32_t)uid);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	/*
+	 * We add S-5-88-2-X in order to pass the gid
+	 * for the unix token.
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Groups,
+		    (uint32_t)gid);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	/*
+	 * We add S-5-88-3-X in order to pass some flags
+	 * (AUTH3_UNIX_HINT_*) to auth3_create_session_info().
+	 */
+	sid_compose(&tmp_sid,
+		    &global_sid_Unix_NFS_Mode,
+		    flags);
+	status = add_sid_to_array_unique(user_info_dc->sids,
+					 &tmp_sid,
+					 &user_info_dc->sids,
+					 &user_info_dc->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("add_sid_to_array_unique failed: %s\n",
+			  nt_errstr(status)));
+		goto fail;
+	}
+
+	return NT_STATUS_OK;
+
+fail:
+	user_info_dc->num_sids = orig_num_sids;
+	return status;
+}
+
+NTSTATUS auth3_session_info_create(TALLOC_CTX *mem_ctx,
+				   const struct auth_user_info_dc *user_info_dc,
+				   const char *original_user_name,
+				   uint32_t session_info_flags,
+				   struct auth_session_info **session_info_out)
+{
+	TALLOC_CTX *frame = talloc_stackframe();
+	struct auth_session_info *session_info = NULL;
+	uid_t hint_uid = -1;
+	bool found_hint_uid = false;
+	uid_t hint_gid = -1;
+	bool found_hint_gid = false;
+	uint32_t hint_flags = 0;
+	bool found_hint_flags = false;
+	bool need_getpwuid = false;
+	struct unixid *ids = NULL;
+	uint32_t num_gids = 0;
+	gid_t *gids = NULL;
+	struct dom_sid tmp_sid = { 0, };
+	fstring tmp = { 0, };
+	NTSTATUS status;
+	size_t i;
+	bool ok;
+
+	*session_info_out = NULL;
+
+	if (user_info_dc->num_sids == 0) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (user_info_dc->info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (user_info_dc->info->account_name == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	session_info = talloc_zero(mem_ctx, struct auth_session_info);
+	if (session_info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+	/* keep this under frame for easier cleanup */
+	talloc_reparent(mem_ctx, frame, session_info);
+
+	session_info->info = auth_user_info_copy(session_info,
+						 user_info_dc->info);
+	if (session_info->info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	session_info->security_token = talloc_zero(session_info,
+						   struct security_token);
+	if (session_info->security_token == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/*
+	 * Avoid a lot of reallocations and allocate what we'll
+	 * use in most cases.
+	 */
+	session_info->security_token->sids = talloc_zero_array(
+						session_info->security_token,
+						struct dom_sid,
+						user_info_dc->num_sids);
+	if (session_info->security_token->sids == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	for (i = PRIMARY_USER_SID_INDEX; i < user_info_dc->num_sids; i++) {
+		struct security_token *nt_token = session_info->security_token;
+		int cmp;
+
+		/*
+		 * S-1-5-88-X-Y sids are only used to give hints
+		 * to the unix token construction.
+		 *
+		 * S-1-5-88-1-Y gives the uid=Y
+		 * S-1-5-88-2-Y gives the gid=Y
+		 * S-1-5-88-3-Y gives flags=Y: AUTH3_UNIX_HINT_*
+		 */
+		cmp = dom_sid_compare_domain(&global_sid_Unix_NFS,
+					     &user_info_dc->sids[i]);
+		if (cmp == 0) {
+			bool match;
+			uint32_t hint = 0;
+
+			match = sid_peek_rid(&user_info_dc->sids[i], &hint);
+			if (!match) {
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Users,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_uid) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_uid = true;
+				hint_uid = (uid_t)hint;
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Groups,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_gid) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_gid = true;
+				hint_gid = (gid_t)hint;
+				continue;
+			}
+
+			match = dom_sid_in_domain(&global_sid_Unix_NFS_Mode,
+						  &user_info_dc->sids[i]);
+			if (match) {
+				if (found_hint_flags) {
+					TALLOC_FREE(frame);
+					return NT_STATUS_INVALID_TOKEN;
+				}
+				found_hint_flags = true;
+				hint_flags = hint;
+				continue;
+			}
+
+			continue;
+		}
+
+		status = add_sid_to_array_unique(nt_token->sids,
+						 &user_info_dc->sids[i],
+						 &nt_token->sids,
+						 &nt_token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			TALLOC_FREE(frame);
+			return status;
+		}
+	}
+
+	/*
+	 * We need at least one usable SID
+	 */
+	if (session_info->security_token->num_sids == 0) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	/*
+	 * We need all tree hints: uid, gid, flags
+	 * or none of them.
+	 */
+	if (found_hint_uid || found_hint_gid || found_hint_flags) {
+		if (!found_hint_uid) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+
+		if (!found_hint_gid) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+
+		if (!found_hint_flags) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+	}
+
+	if (session_info->info->authenticated) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(session_info->security_token,
+					 session_info_flags);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	/*
+	 * unless set otherwise, the session key is the user session
+	 * key from the auth subsystem
+	 */
+	if (user_info_dc->user_session_key.length != 0) {
+		session_info->session_key = data_blob_dup_talloc(session_info,
+						user_info_dc->user_session_key);
+		if (session_info->session_key.data == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+
+	if (!(session_info_flags & AUTH_SESSION_INFO_UNIX_TOKEN)) {
+		goto done;
+	}
+
+	session_info->unix_token = talloc_zero(session_info, struct security_unix_token);
+	if (session_info->unix_token == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+	session_info->unix_token->uid = -1;
+	session_info->unix_token->gid = -1;
+
+	session_info->unix_info = talloc_zero(session_info, struct auth_user_info_unix);
+	if (session_info->unix_info == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* Convert the SIDs to uid/gids. */
+
+	ids = talloc_zero_array(frame, struct unixid,
+				session_info->security_token->num_sids);
+	if (ids == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	if (!(hint_flags & AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS)) {
+		ok = sids_to_unixids(session_info->security_token->sids,
+				     session_info->security_token->num_sids,
+				     ids);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+
+	if (found_hint_uid) {
+		session_info->unix_token->uid = hint_uid;
+	} else if (ids[0].type == ID_TYPE_UID) {
+		/*
+		 * The primary SID resolves to a UID only.
+		 */
+		session_info->unix_token->uid = ids[0].id;
+	} else if (ids[0].type == ID_TYPE_BOTH) {
+		/*
+		 * The primary SID resolves to a UID and GID,
+		 * use it as uid and add it as first element
+		 * to the groups array.
+		 */
+		session_info->unix_token->uid = ids[0].id;
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     session_info->unix_token->uid,
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else {
+		/*
+		 * It we can't get a uid, we can't imporsonate
+		 * the user.
+		 */
+		TALLOC_FREE(frame);
+		return NT_STATUS_INVALID_TOKEN;
+	}
+
+	if (found_hint_gid) {
+		session_info->unix_token->gid = hint_gid;
+	} else {
+		need_getpwuid = true;
+	}
+
+	if (hint_flags & AUTH3_UNIX_HINT_QUALIFIED_NAME) {
+		session_info->unix_info->unix_name =
+			talloc_asprintf(session_info->unix_info,
+					"%s%c%s",
+					session_info->info->domain_name,
+					*lp_winbind_separator(),
+					session_info->info->account_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else if (hint_flags & AUTH3_UNIX_HINT_ISLOLATED_NAME) {
+		session_info->unix_info->unix_name =
+			talloc_strdup(session_info->unix_info,
+				      session_info->info->account_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	} else {
+		need_getpwuid = true;
+	}
+
+	if (need_getpwuid) {
+		struct passwd *pwd = NULL;
+
+		/*
+		 * Ask the system for the primary gid
+		 * and the real unix name.
+		 */
+		pwd = getpwuid_alloc(frame, session_info->unix_token->uid);
+		if (pwd == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+		if (!found_hint_gid) {
+			session_info->unix_token->gid = pwd->pw_gid;
+		}
+
+		session_info->unix_info->unix_name =
+			talloc_strdup(session_info->unix_info, pwd->pw_name);
+		if (session_info->unix_info->unix_name == NULL) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+
+		TALLOC_FREE(pwd);
+	}
+
+	ok = add_gid_to_array_unique(session_info->unix_token,
+				     session_info->unix_token->gid,
+				     &session_info->unix_token->groups,
+				     &session_info->unix_token->ngroups);
+	if (!ok) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	/* This is a potentially untrusted username for use in %U */
+	alpha_strcpy(tmp, original_user_name, ". _-$", sizeof(tmp));
+	session_info->unix_info->sanitized_username =
+				talloc_strdup(session_info->unix_info, tmp);
+	if (session_info->unix_info->sanitized_username == NULL) {
+		TALLOC_FREE(frame);
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	for (i=0; i < session_info->security_token->num_sids; i++) {
+
+		if (ids[i].type != ID_TYPE_GID &&
+		    ids[i].type != ID_TYPE_BOTH) {
+			struct security_token *nt_token =
+				session_info->security_token;
+
+			DEBUG(10, ("Could not convert SID %s to gid, "
+				   "ignoring it\n",
+				   sid_string_dbg(&nt_token->sids[i])));
+			continue;
+		}
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     ids[i].id,
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+	TALLOC_FREE(ids);
+
+	/*
+	 * Now we must get any groups this user has been
+	 * added to in /etc/group and merge them in.
+	 * This has to be done in every code path
+	 * that creates an NT token, as remote users
+	 * may have been added to the local /etc/group
+	 * database. Tokens created merely from the
+	 * info3 structs (via the DC or via the krb5 PAC)
+	 * won't have these local groups. Note the
+	 * groups added here will only be UNIX groups
+	 * (S-1-22-2-XXXX groups) as getgroups_unix_user()
+	 * turns off winbindd before calling getgroups().
+	 *
+	 * NB. This is duplicating work already
+	 * done in the 'unix_user:' case of
+	 * create_token_from_sid() but won't
+	 * do anything other than be inefficient
+	 * in that case.
+	 */
+	if (!(hint_flags & AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS)) {
+		ok = getgroups_unix_user(frame,
+					 session_info->unix_info->unix_name,
+					 session_info->unix_token->gid,
+					 &gids, &num_gids);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_INVALID_TOKEN;
+		}
+	}
+
+	for (i=0; i < num_gids; i++) {
+
+		ok = add_gid_to_array_unique(session_info->unix_token,
+					     gids[i],
+					     &session_info->unix_token->groups,
+					     &session_info->unix_token->ngroups);
+		if (!ok) {
+			TALLOC_FREE(frame);
+			return NT_STATUS_NO_MEMORY;
+		}
+	}
+	TALLOC_FREE(gids);
+
+	if (hint_flags & AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS) {
+		/*
+		 * We should not translate the unix token uid/gids
+		 * to S-1-22-X-Y SIDs.
+		 */
+		goto done;
+	}
+
+	/*
+	 * Add the "Unix Group" SID for each gid to catch mapped groups
+	 * and their Unix equivalent.  This is to solve the backwards
+	 * compatibility problem of 'valid users = +ntadmin' where
+	 * ntadmin has been paired with "Domain Admins" in the group
+	 * mapping table.  Otherwise smb.conf would need to be changed
+	 * to 'valid user = "Domain Admins"'.  --jerry
+	 *
+	 * For consistency we also add the "Unix User" SID,
+	 * so that the complete unix token is represented within
+	 * the nt token.
+	 */
+
+	uid_to_unix_users_sid(session_info->unix_token->uid, &tmp_sid);
+	status = add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+					 &session_info->security_token->sids,
+					 &session_info->security_token->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	gid_to_unix_groups_sid(session_info->unix_token->gid, &tmp_sid);
+	status = add_sid_to_array_unique(session_info->security_token, &tmp_sid,
+					 &session_info->security_token->sids,
+					 &session_info->security_token->num_sids);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	for (i=0; i < session_info->unix_token->ngroups; i++ ) {
+		struct security_token *nt_token = session_info->security_token;
+
+		gid_to_unix_groups_sid(session_info->unix_token->groups[i],
+				       &tmp_sid);
+		status = add_sid_to_array_unique(nt_token->sids,
+						 &tmp_sid,
+						 &nt_token->sids,
+						 &nt_token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			TALLOC_FREE(frame);
+			return status;
+		}
+	}
+
+done:
+	security_token_debug(DBGC_AUTH, 10, session_info->security_token);
+	if (session_info->unix_token != NULL) {
+		debug_unix_user_token(DBGC_AUTH, 10,
+				      session_info->unix_token->uid,
+				      session_info->unix_token->gid,
+				      session_info->unix_token->ngroups,
+				      session_info->unix_token->groups);
+	}
+
+	status = log_nt_token(session_info->security_token);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(frame);
+		return status;
+	}
+
+	*session_info_out = talloc_move(mem_ctx, &session_info);
+	TALLOC_FREE(frame);
+	return NT_STATUS_OK;
+}
+
 /***************************************************************************
  Make (and fill) a server_info struct from a 'struct passwd' by conversion
  to a struct samu
@@ -712,31 +1265,6 @@ done:
 	return status;
 }
 
-static NTSTATUS get_system_info3(TALLOC_CTX *mem_ctx,
-				 struct netr_SamInfo3 *info3)
-{
-	NTSTATUS status;
-
-	/* Set account name */
-	init_lsa_String(&info3->base.account_name, "SYSTEM");
-
-	/* Set domain name */
-	init_lsa_StringLarge(&info3->base.logon_domain, "NT AUTHORITY");
-
-
-	status = dom_sid_split_rid(mem_ctx, &global_sid_System,
-				   &info3->base.domain_sid,
-				   &info3->base.rid);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
-	}
-
-	/* Primary gid is the same */
-	info3->base.primary_gid = info3->base.rid;
-
-	return NT_STATUS_OK;
-}
-
 static NTSTATUS get_guest_info3(TALLOC_CTX *mem_ctx,
 				struct netr_SamInfo3 *info3)
 {
@@ -865,80 +1393,148 @@ done:
 static NTSTATUS make_new_session_info_system(TALLOC_CTX *mem_ctx,
 					    struct auth_session_info **session_info)
 {
+	TALLOC_CTX *frame = talloc_stackframe();
+	struct auth_user_info_dc *user_info_dc = NULL;
+	uid_t uid = -1;
+	gid_t gid = -1;
+	uint32_t hint_flags = 0;
+	uint32_t session_info_flags = 0;
 	NTSTATUS status;
-	struct auth_serversupplied_info *server_info;
-	TALLOC_CTX *tmp_ctx;
-
-	tmp_ctx = talloc_stackframe();
-	if (tmp_ctx == NULL) {
-		return NT_STATUS_NO_MEMORY;
-	}
 
-	server_info = make_server_info(tmp_ctx);
-	if (!server_info) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("failed making server_info\n"));
+	status = auth_system_user_info_dc(frame, lp_netbios_name(),
+					  &user_info_dc);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth_system_user_info_dc failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	server_info->info3 = talloc_zero(server_info, struct netr_SamInfo3);
-	if (!server_info->info3) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc failed setting info3\n"));
+	/*
+	 * Just get the initial uid/gid
+	 * and don't expand the unix groups.
+	 */
+	uid = sec_initial_uid();
+	gid = sec_initial_gid();
+	hint_flags |= AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS;
+
+	/*
+	 * Also avoid sid mapping to gids,
+	 * as well as adding the unix_token uid/gids as
+	 * S-1-22-X-Y SIDs to the nt token.
+	 */
+	hint_flags |= AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS;
+	hint_flags |= AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS;
+
+	/*
+	 * The unix name will be "NT AUTHORITY+SYSTEM",
+	 * where '+' is the "winbind separator" character.
+	 */
+	hint_flags |= AUTH3_UNIX_HINT_QUALIFIED_NAME;
+	status = auth3_user_info_dc_add_hints(user_info_dc,
+					      uid,
+					      gid,
+					      hint_flags);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth3_user_info_dc_add_hints failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	status = get_system_info3(server_info, server_info->info3);
+	session_info_flags |= AUTH_SESSION_INFO_SIMPLE_PRIVILEGES;
+	session_info_flags |= AUTH_SESSION_INFO_UNIX_TOKEN;
+	status = auth3_session_info_create(mem_ctx, user_info_dc,
+					   user_info_dc->info->account_name,
+					   session_info_flags,
+					   session_info);
 	if (!NT_STATUS_IS_OK(status)) {
-		DEBUG(0, ("Failed creating system info3 with %s\n",
+		DEBUG(0, ("auth3_session_info_create failed: %s\n",
 			  nt_errstr(status)));
 		goto done;
 	}
 
-	server_info->utok.uid = sec_initial_uid();
-	server_info->utok.gid = sec_initial_gid();
-	server_info->unix_name = talloc_asprintf(server_info,
-						 "NT AUTHORITY%cSYSTEM",
-						 *lp_winbind_separator());
+done:
+	TALLOC_FREE(frame);
+	return status;
+}
 
-	if (!server_info->unix_name) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc_asprintf failed setting unix_name\n"));
-		goto done;
-	}
+static NTSTATUS make_new_session_info_anonymous(TALLOC_CTX *mem_ctx,
+					struct auth_session_info **session_info)
+{
+	TALLOC_CTX *frame = talloc_stackframe();
+	const char *guest_account = lp_guest_account();
+	struct auth_user_info_dc *user_info_dc = NULL;
+	struct passwd *pwd = NULL;
+	uint32_t hint_flags = 0;
+	uint32_t session_info_flags = 0;
+	NTSTATUS status;
 
-	server_info->security_token = talloc_zero(server_info, struct security_token);
-	if (!server_info->security_token) {
-		status = NT_STATUS_NO_MEMORY;
-		DEBUG(0, ("talloc failed setting security token\n"));
+	/*
+	 * We use the guest account for the unix token
+	 * while we use a true anonymous nt token.
+	 *
+	 * It's very important to have a separate
+	 * nt token for anonymous.
+	 */
+
+	pwd = Get_Pwnam_alloc(frame, guest_account);
+	if (pwd == NULL) {
+		DBG_ERR("Unable to locate guest account [%s]!\n",
+			guest_account);
+		status = NT_STATUS_NO_SUCH_USER;
 		goto done;
 	}
 
-	status = add_sid_to_array_unique(server_info->security_token->sids,
-					 &global_sid_System,
-					 &server_info->security_token->sids,
-					 &server_info->security_token->num_sids);
+	status = auth_anonymous_user_info_dc(frame, lp_netbios_name(),
+					     &user_info_dc);
 	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth_anonymous_user_info_dc failed: %s\n",
+			  nt_errstr(status)));
 		goto done;
 	}
 
-	/* SYSTEM has all privilages */
-	server_info->security_token->privilege_mask = ~0;
-
-	/* Now turn the server_info into a session_info with the full token etc */
-	status = create_local_token(mem_ctx, server_info, NULL, "SYSTEM", session_info);
-	talloc_free(server_info);
+	/*
+	 * Note we don't pass AUTH3_UNIX_HINT_QUALIFIED_NAME
+	 * nor AUTH3_UNIX_HINT_ISOLATED_NAME here
+	 * as we want the unix name be found by getpwuid_alloc().
+	 */
 
+	status = auth3_user_info_dc_add_hints(user_info_dc,
+					      pwd->pw_uid,
+					      pwd->pw_gid,
+					      hint_flags);
 	if (!NT_STATUS_IS_OK(status)) {
-		DEBUG(0, ("create_local_token failed: %s\n",
+		DEBUG(0, ("auth3_user_info_dc_add_hints failed: %s\n",
 			  nt_errstr(status)));
 		goto done;
 	}
 
-	talloc_steal(mem_ctx, *session_info);
+	/*
+	 * In future we may want to remove
+	 * AUTH_SESSION_INFO_DEFAULT_GROUPS.
+	 *
+	 * Similar to Windows with EveryoneIncludesAnonymous
+	 * and RestrictAnonymous.
+	 *
+	 * We may introduce AUTH_SESSION_INFO_ANON_WORLD...
+	 *
+	 * But for this is required to keep the existing tests
+	 * working.
+	 */
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	session_info_flags |= AUTH_SESSION_INFO_SIMPLE_PRIVILEGES;
+	session_info_flags |= AUTH_SESSION_INFO_UNIX_TOKEN;
+	status = auth3_session_info_create(mem_ctx, user_info_dc,
+					   "",
+					   session_info_flags,
+					   session_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(0, ("auth3_session_info_create failed: %s\n",
+			  nt_errstr(status)));
+		goto done;
+	}
 
 done:
-	TALLOC_FREE(tmp_ctx);
+	TALLOC_FREE(frame);
 	return status;
 }
 
@@ -1019,7 +1615,6 @@ static struct auth_serversupplied_info *
 	SMB_ASSERT(src->unix_info);
 
 	dst->guest = true;
-	dst->system = false;
 
 	/* This element must be provided to convert back to an
 	 * auth_serversupplied_info.  This needs to be from the
@@ -1042,12 +1637,6 @@ static struct auth_serversupplied_info *
 	 * to take the wrong path */
 	SMB_ASSERT(src->security_token);
 
-	dst->security_token = dup_nt_token(dst, src->security_token);
-	if (!dst->security_token) {
-		TALLOC_FREE(dst);
-		return NULL;
-	}
-
 	dst->session_key = data_blob_talloc( dst, src->session_key.data,
 						src->session_key.length);
 
@@ -1070,6 +1659,7 @@ static struct auth_serversupplied_info *
 		return NULL;
 	}
 
+	dst->cached_session_info = src;
 	return dst;
 }
 
@@ -1128,15 +1718,30 @@ bool session_info_set_session_key(struct
 }
 
 static struct auth_session_info *guest_info = NULL;
+static struct auth_session_info *anonymous_info = NULL;
 
 static struct auth_serversupplied_info *guest_server_info = NULL;
 
 bool init_guest_info(void)
 {
+	NTSTATUS status;
+
 	if (guest_info != NULL)
 		return true;
 
-	return NT_STATUS_IS_OK(make_new_session_info_guest(&guest_info, &guest_server_info));
+	status = make_new_session_info_guest(&guest_info,
+					     &guest_server_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+
+	status = make_new_session_info_anonymous(NULL,
+						 &anonymous_info);
+	if (!NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+
+	return true;
 }
 
 NTSTATUS make_server_info_guest(TALLOC_CTX *mem_ctx,
@@ -1157,6 +1762,51 @@ NTSTATUS make_session_info_guest(TALLOC_
 	return (*session_info != NULL) ? NT_STATUS_OK : NT_STATUS_NO_MEMORY;
 }
 
+NTSTATUS make_server_info_anonymous(TALLOC_CTX *mem_ctx,
+				    struct auth_serversupplied_info **server_info)
+{
+	if (anonymous_info == NULL) {
+		return NT_STATUS_UNSUCCESSFUL;
+	}
+
+	/*
+	 * This is trickier than it would appear to need to be because
+	 * we are trying to avoid certain costly operations when the
+	 * structure is converted to a 'auth_session_info' again in
+	 * create_local_token()
+	 *
+	 * We use a guest server_info, but with the anonymous session info,
+	 * which means create_local_token() will return a copy
+	 * of the anonymous token.
+	 *
+	 * The server info is just used as legacy in order to
+	 * keep existing code working. Maybe some debug messages
+	 * will still refer to guest instead of anonymous.
+	 */
+	*server_info = copy_session_info_serverinfo_guest(mem_ctx, anonymous_info,
+							  guest_server_info);
+	if (*server_info == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	return NT_STATUS_OK;
+}
+
+NTSTATUS make_session_info_anonymous(TALLOC_CTX *mem_ctx,
+				     struct auth_session_info **session_info)
+{
+	if (anonymous_info == NULL) {
+		return NT_STATUS_UNSUCCESSFUL;
+	}
+
+	*session_info = copy_session_info(mem_ctx, anonymous_info);
+	if (*session_info == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
+
+	return NT_STATUS_OK;
+}
+
 static struct auth_session_info *system_info = NULL;
 
 NTSTATUS init_system_session_info(void)
diff -Npur samba-4.8.0/source3/auth/proto.h samba-4.8.1/source3/auth/proto.h
--- samba-4.8.0/source3/auth/proto.h	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.1/source3/auth/proto.h	2018-04-26 09:21:03.000000000 +0200
@@ -221,6 +221,38 @@ NTSTATUS create_local_token(TALLOC_CTX *
 			    DATA_BLOB *session_key,
 			    const char *smb_name,
 			    struct auth_session_info **session_info_out);
+
+/*
+ * The unix name should be constructed as DOMAIN+ACCOUNT,
+ * while '+' will be the "winbind separator" character.
+ */
+#define AUTH3_UNIX_HINT_QUALIFIED_NAME             0x00000001
+/*
+ * The unix name will be just ACCOUNT
+ */
+#define AUTH3_UNIX_HINT_ISLOLATED_NAME             0x00000002
+/*
+ * Don't translate the nt token SIDS into uid/gids
+ */
+#define AUTH3_UNIX_HINT_DONT_TRANSLATE_FROM_SIDS   0x00000004
+/*
+ * Don't translate the unix token uid/gids to S-1-22-X-Y SIDS
+ */
+#define AUTH3_UNIX_HINT_DONT_TRANSLATE_TO_SIDS     0x00000008
+/*
+ * The unix token won't get expanded gid values
+ * from getgroups_unix_user()
+ */
+#define AUTH3_UNIX_HINT_DONT_EXPAND_UNIX_GROUPS    0x00000010
+NTSTATUS auth3_user_info_dc_add_hints(struct auth_user_info_dc *user_info_dc,
+				      uid_t uid,
+				      gid_t gid,
+				      uint32_t flags);
+NTSTATUS auth3_session_info_create(TALLOC_CTX *mem_ctx,
+				   const struct auth_user_info_dc *user_info_dc,
+				   const char *original_user_name,
+				   uint32_t session_info_flags,
+				   struct auth_session_info **session_info_out);
 NTSTATUS create_token_from_username(TALLOC_CTX *mem_ctx, const char *username,
 				    bool is_guest,
 				    uid_t *uid, gid_t *gid,
@@ -248,6 +280,10 @@ NTSTATUS make_server_info_guest(TALLOC_C
 				struct auth_serversupplied_info **server_info);
 NTSTATUS make_session_info_guest(TALLOC_CTX *mem_ctx,
 				struct auth_session_info **server_info);
+NTSTATUS make_server_info_anonymous(TALLOC_CTX *mem_ctx,
+				    struct auth_serversupplied_info **server_info);
+NTSTATUS make_session_info_anonymous(TALLOC_CTX *mem_ctx,
+				     struct auth_session_info **psession_info);
 NTSTATUS make_session_info_system(TALLOC_CTX *mem_ctx,
 				 struct auth_session_info **session_info);
 const struct auth_session_info *get_session_info_system(void);
@@ -357,6 +393,8 @@ struct security_token *create_local_nt_t
 					    bool is_guest,
 					    int num_groupsids,
 					    const struct dom_sid *groupsids);
+NTSTATUS finalize_local_nt_token(struct security_token *result,
+				 uint32_t session_info_flags);
 NTSTATUS get_user_sid_info3_and_extra(const struct netr_SamInfo3 *info3,
 				      const struct extra_auth_info *extra,
 				      struct dom_sid *sid);
diff -Npur samba-4.8.0/source3/auth/token_util.c samba-4.8.1/source3/auth/token_util.c
--- samba-4.8.0/source3/auth/token_util.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/auth/token_util.c	2018-04-26 09:21:03.000000000 +0200
@@ -190,6 +190,9 @@ static NTSTATUS add_builtin_administrato
 	if ( IS_DC ) {
 		sid_copy( &domadm, get_global_sam_sid() );
 	} else {
+		if (dom_sid == NULL) {
+			return NT_STATUS_INVALID_PARAMETER_MIX;
+		}
 		sid_copy(&domadm, dom_sid);
 	}
 	sid_append_rid( &domadm, DOMAIN_RID_ADMINS );
@@ -208,8 +211,76 @@ static NTSTATUS add_builtin_administrato
 	return NT_STATUS_OK;
 }
 
-static NTSTATUS finalize_local_nt_token(struct security_token *result,
-					bool is_guest);
+static NTSTATUS add_builtin_guests(struct security_token *token,
+				   const struct dom_sid *dom_sid)
+{
+	struct dom_sid tmp_sid;
+	NTSTATUS status;
+
+	/*
+	 * First check the local GUEST account.
+	 */
+	sid_copy(&tmp_sid, get_global_sam_sid());
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUEST);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	/*
+	 * First check the local GUESTS group.
+	 */
+	sid_copy(&tmp_sid, get_global_sam_sid());
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUESTS);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	if (lp_server_role() != ROLE_DOMAIN_MEMBER) {
+		return NT_STATUS_OK;
+	}
+
+	if (dom_sid == NULL) {
+		return NT_STATUS_INVALID_PARAMETER_MIX;
+	}
+
+	/*
+	 * First check the domain GUESTS group.
+	 */
+	sid_copy(&tmp_sid, dom_sid);
+	sid_append_rid(&tmp_sid, DOMAIN_RID_GUESTS);
+
+	if (nt_token_check_sid(&tmp_sid, token)) {
+		status = add_sid_to_array_unique(token,
+					&global_sid_Builtin_Guests,
+					&token->sids, &token->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+
+		return NT_STATUS_OK;
+	}
+
+	return NT_STATUS_OK;
+}
+
+static NTSTATUS add_local_groups(struct security_token *result,
+				 bool is_guest);
 
 NTSTATUS get_user_sid_info3_and_extra(const struct netr_SamInfo3 *info3,
 				      const struct extra_auth_info *extra,
@@ -240,6 +311,7 @@ NTSTATUS create_local_nt_token_from_info
 					  struct security_token **ntok)
 {
 	struct security_token *usrtok = NULL;
+	uint32_t session_info_flags = 0;
 	NTSTATUS status;
 	int i;
 
@@ -323,7 +395,19 @@ NTSTATUS create_local_nt_token_from_info
 		}
 	}
 
-	status = finalize_local_nt_token(usrtok, is_guest);
+	status = add_local_groups(usrtok, is_guest);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(3, ("Failed to add local groups\n"));
+		TALLOC_FREE(usrtok);
+		return status;
+	}
+
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	if (!is_guest) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(usrtok, session_info_flags);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(3, ("Failed to finalize nt token\n"));
 		TALLOC_FREE(usrtok);
@@ -347,6 +431,7 @@ struct security_token *create_local_nt_t
 	struct security_token *result = NULL;
 	int i;
 	NTSTATUS status;
+	uint32_t session_info_flags = 0;
 
 	DEBUG(10, ("Create local NT token for %s\n",
 		   sid_string_dbg(user_sid)));
@@ -392,12 +477,46 @@ struct security_token *create_local_nt_t
 		}
 	}
 
-	status = finalize_local_nt_token(result, is_guest);
+	status = add_local_groups(result, is_guest);
+	if (!NT_STATUS_IS_OK(status)) {
+		TALLOC_FREE(result);
+		return NULL;
+	}
+
+	session_info_flags |= AUTH_SESSION_INFO_DEFAULT_GROUPS;
+	if (!is_guest) {
+		session_info_flags |= AUTH_SESSION_INFO_AUTHENTICATED;
+	}
+
+	status = finalize_local_nt_token(result, session_info_flags);
 	if (!NT_STATUS_IS_OK(status)) {
 		TALLOC_FREE(result);
 		return NULL;
 	}
 
+	if (is_guest) {
+		/*
+		 * It's ugly, but for now it's
+		 * needed to add Builtin_Guests
+		 * here, the "local" token only
+		 * consist of S-1-22-* SIDs
+		 * and finalize_local_nt_token()
+		 * doesn't have the chance to
+		 * to detect it need to
+		 * add Builtin_Guests via
+		 * add_builtin_guests().
+		 */
+		status = add_sid_to_array_unique(result,
+						 &global_sid_Builtin_Guests,
+						 &result->sids,
+						 &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			DEBUG(3, ("Failed to add SID to nt token\n"));
+			TALLOC_FREE(result);
+			return NULL;
+		}
+	}
+
 	return result;
 }
 
@@ -495,41 +614,53 @@ static NTSTATUS add_local_groups(struct
 	return NT_STATUS_OK;
 }
 
-static NTSTATUS finalize_local_nt_token(struct security_token *result,
-					bool is_guest)
+NTSTATUS finalize_local_nt_token(struct security_token *result,
+				 uint32_t session_info_flags)
 {
-	struct dom_sid dom_sid;
+	struct dom_sid _dom_sid = { 0, };
+	struct dom_sid *domain_sid = NULL;
 	NTSTATUS status;
 	struct acct_info *info;
+	bool ok;
 
-	/* Add any local groups. */
+	result->privilege_mask = 0;
+	result->rights_mask = 0;
 
-	status = add_local_groups(result, is_guest);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	if (result->num_sids == 0) {
+		return NT_STATUS_INVALID_TOKEN;
 	}
 
-	/* Add in BUILTIN sids */
+	if (session_info_flags & AUTH_SESSION_INFO_DEFAULT_GROUPS) {
+		status = add_sid_to_array(result, &global_sid_World,
+					  &result->sids, &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+		status = add_sid_to_array(result, &global_sid_Network,
+					  &result->sids, &result->num_sids);
+		if (!NT_STATUS_IS_OK(status)) {
+			return status;
+		}
+	}
 
-	status = add_sid_to_array(result, &global_sid_World,
-				  &result->sids, &result->num_sids);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	/*
+	 * Don't expand nested groups of system, anonymous etc
+	 *
+	 * Note that they still get SID_WORLD and SID_NETWORK
+	 * for now in order let existing tests pass.
+	 *
+	 * But SYSTEM doesn't get AUTHENTICATED_USERS
+	 * and ANONYMOUS doesn't get BUILTIN GUESTS anymore.
+	 */
+	if (security_token_is_anonymous(result)) {
+		return NT_STATUS_OK;
 	}
-	status = add_sid_to_array(result, &global_sid_Network,
-				  &result->sids, &result->num_sids);
-	if (!NT_STATUS_IS_OK(status)) {
-		return status;
+	if (security_token_is_system(result)) {
+		result->privilege_mask = ~0;
+		return NT_STATUS_OK;
 	}
 
-	if (is_guest) {
-		status = add_sid_to_array(result, &global_sid_Builtin_Guests,
-					  &result->sids,
-					  &result->num_sids);
-		if (!NT_STATUS_IS_OK(status)) {
-			return status;
-		}
-	} else {
+	if (session_info_flags & AUTH_SESSION_INFO_AUTHENTICATED) {
 		status = add_sid_to_array(result,
 					  &global_sid_Authenticated_Users,
 					  &result->sids,
@@ -539,6 +670,18 @@ static NTSTATUS finalize_local_nt_token(
 		}
 	}
 
+	/* Add in BUILTIN sids */
+
+	become_root();
+	ok = secrets_fetch_domain_sid(lp_workgroup(), &_dom_sid);
+	if (ok) {
+		domain_sid = &_dom_sid;
+	} else {
+		DEBUG(3, ("Failed to fetch domain sid for %s\n",
+			  lp_workgroup()));
+	}
+	unbecome_root();
+
 	info = talloc_zero(talloc_tos(), struct acct_info);
 	if (info == NULL) {
 		DEBUG(0, ("talloc failed!\n"));
@@ -553,18 +696,12 @@ static NTSTATUS finalize_local_nt_token(
 	if (!NT_STATUS_IS_OK(status)) {
 
 		become_root();
-		if (!secrets_fetch_domain_sid(lp_workgroup(), &dom_sid)) {
-			status = NT_STATUS_OK;
-			DEBUG(3, ("Failed to fetch domain sid for %s\n",
-				  lp_workgroup()));
-		} else {
-			status = create_builtin_administrators(&dom_sid);
-		}
+		status = create_builtin_administrators(domain_sid);
 		unbecome_root();
 
 		if (NT_STATUS_EQUAL(status, NT_STATUS_PROTOCOL_UNREACHABLE)) {
 			/* Add BUILTIN\Administrators directly to token. */
-			status = add_builtin_administrators(result, &dom_sid);
+			status = add_builtin_administrators(result, domain_sid);
 			if ( !NT_STATUS_IS_OK(status) ) {
 				DEBUG(3, ("Failed to check for local "
 					  "Administrators membership (%s)\n",
@@ -585,13 +722,7 @@ static NTSTATUS finalize_local_nt_token(
 	if (!NT_STATUS_IS_OK(status)) {
 
 		become_root();
-		if (!secrets_fetch_domain_sid(lp_workgroup(), &dom_sid)) {
-			status = NT_STATUS_OK;
-			DEBUG(3, ("Failed to fetch domain sid for %s\n",
-				  lp_workgroup()));
-		} else {
-			status = create_builtin_users(&dom_sid);
-		}
+		status = create_builtin_users(domain_sid);
 		unbecome_root();
 
 		if (!NT_STATUS_EQUAL(status, NT_STATUS_PROTOCOL_UNREACHABLE) &&
@@ -602,6 +733,28 @@ static NTSTATUS finalize_local_nt_token(
 		}
 	}
 
+	/*
+	 * Add BUILTIN\Guests directly to token.
+	 * But only if the token already indicates
+	 * real guest access by:
+	 * - local GUEST account
+	 * - local GUESTS group
+	 * - domain GUESTS group
+	 *
+	 * Even if a user was authenticated, it
+	 * can be member of a guest related group.
+	 */
+	status = add_builtin_guests(result, domain_sid);
+	if (!NT_STATUS_IS_OK(status)) {
+		DEBUG(3, ("Failed to check for local "
+			  "Guests membership (%s)\n",
+			  nt_errstr(status)));
+		/*
+		 * This is a hard error.
+		 */
+		return status;
+	}
+
 	TALLOC_FREE(info);
 
 	/* Deal with local groups */
@@ -631,10 +784,16 @@ static NTSTATUS finalize_local_nt_token(
 		unbecome_root();
 	}
 
-	/* Add privileges based on current user sids */
 
-	get_privileges_for_sids(&result->privilege_mask, result->sids,
-				result->num_sids);
+	if (session_info_flags & AUTH_SESSION_INFO_SIMPLE_PRIVILEGES) {
+		if (security_token_has_builtin_administrators(result)) {
+			result->privilege_mask = ~0;
+		}
+	} else {
+		/* Add privileges based on current user sids */
+		get_privileges_for_sids(&result->privilege_mask, result->sids,
+					result->num_sids);
+	}
 
 	return NT_STATUS_OK;
 }
diff -Npur samba-4.8.0/source3/client/client.c samba-4.8.1/source3/client/client.c
--- samba-4.8.0/source3/client/client.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/client/client.c	2018-04-26 09:21:03.000000000 +0200
@@ -4561,12 +4561,17 @@ static int cmd_notify(void)
 	}
 
 	while (1) {
-		uint32_t i, num_changes;
-		struct notify_change *changes;
+		uint32_t i;
+		uint32_t num_changes = 0;
+		struct notify_change *changes = NULL;
 
 		status = cli_notify(cli, fnum, 1000, FILE_NOTIFY_CHANGE_ALL,
 				    true,
 				    talloc_tos(), &num_changes, &changes);
+		if (NT_STATUS_EQUAL(status, STATUS_NOTIFY_ENUM_DIR)) {
+			printf("NOTIFY_ENUM_DIR\n");
+			status = NT_STATUS_OK;
+		}
 		if (!NT_STATUS_IS_OK(status)) {
 			d_printf("notify returned %s\n",
 				 nt_errstr(status));
diff -Npur samba-4.8.0/source3/include/auth.h samba-4.8.1/source3/include/auth.h
--- samba-4.8.0/source3/include/auth.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/include/auth.h	2018-04-26 09:21:03.000000000 +0200
@@ -30,20 +30,18 @@ struct extra_auth_info {
 
 struct auth_serversupplied_info {
 	bool guest;
-	bool system;
 
 	struct security_unix_token utok;
 
 	/*
-	 * NT group information taken from the info3 structure
+	 * A complete auth_session_info
 	 *
 	 * This is not normally filled in, during the typical
 	 * authentication process.  If filled in, it has already been
 	 * finalised by a nasty hack to support a cached guest/system
 	 * session_info
 	 */
-
-	struct security_token *security_token;
+	const struct auth_session_info *cached_session_info;
 
 	/* These are the intermediate session keys, as provided by a
 	 * NETLOGON server and used by NTLMSSP to negotiate key
diff -Npur samba-4.8.0/source3/lib/messages.c samba-4.8.1/source3/lib/messages.c
--- samba-4.8.0/source3/lib/messages.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/lib/messages.c	2018-04-26 09:21:03.000000000 +0200
@@ -457,6 +457,13 @@ static NTSTATUS messaging_init_internal(
 	const char *priv_path;
 	bool ok;
 
+	/*
+	 * sec_init() *must* be called before any other
+	 * functions that use sec_XXX(). e.g. sec_initial_uid().
+	 */
+
+	sec_init();
+
 	lck_path = lock_path("msg.lock");
 	if (lck_path == NULL) {
 		return NT_STATUS_NO_MEMORY;
@@ -507,8 +514,6 @@ static NTSTATUS messaging_init_internal(
 		goto done;
 	}
 
-	sec_init();
-
 	ctx->msg_dgm_ref = messaging_dgm_ref(ctx,
 					     ctx->event_ctx,
 					     &ctx->id.unique_id,
diff -Npur samba-4.8.0/source3/libads/kerberos_keytab.c samba-4.8.1/source3/libads/kerberos_keytab.c
--- samba-4.8.0/source3/libads/kerberos_keytab.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/libads/kerberos_keytab.c	2018-04-26 09:21:03.000000000 +0200
@@ -640,7 +640,11 @@ int ads_keytab_list(const char *keytab_n
 	}
 
 	if (keytab_name == NULL) {
+#ifdef HAVE_ADS
 		ret = ads_keytab_open(context, &keytab);
+#else
+		ret = ENOENT;
+#endif
 	} else {
 		ret = smb_krb5_kt_open(context, keytab_name, False, &keytab);
 	}
diff -Npur samba-4.8.0/source3/libads/ldap_utils.c samba-4.8.1/source3/libads/ldap_utils.c
--- samba-4.8.0/source3/libads/ldap_utils.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/libads/ldap_utils.c	2018-04-26 09:21:03.000000000 +0200
@@ -105,9 +105,18 @@ static ADS_STATUS ads_do_search_retry_in
 		status = ads_connect(ads);
 
 		if (!ADS_ERR_OK(status)) {
+			bool orig_is_mine = ads->is_mine;
+
 			DEBUG(1,("ads_search_retry: failed to reconnect (%s)\n",
 				 ads_errstr(status)));
+			/*
+			 * We need to keep the ads pointer
+			 * from being freed here as we don't own it and
+			 * callers depend on it being around.
+			 */
+			ads->is_mine = false;
 			ads_destroy(&ads);
+			ads->is_mine = orig_is_mine;
 			SAFE_FREE(bp);
 			return status;
 		}
diff -Npur samba-4.8.0/source3/libsmb/cli_smb2_fnum.c samba-4.8.1/source3/libsmb/cli_smb2_fnum.c
--- samba-4.8.0/source3/libsmb/cli_smb2_fnum.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/libsmb/cli_smb2_fnum.c	2018-04-26 09:21:03.000000000 +0200
@@ -4192,6 +4192,15 @@ NTSTATUS cli_smb2_notify(struct cli_stat
 				completion_filter, recursive,
 				frame, &base, &len);
 
+	if (NT_STATUS_EQUAL(status, NT_STATUS_IO_TIMEOUT)) {
+		len = 0;
+		status = NT_STATUS_OK;
+	}
+
+	if (!NT_STATUS_IS_OK(status)) {
+		goto fail;
+	}
+
 	ofs = 0;
 
 	while (len - ofs >= 12) {
diff -Npur samba-4.8.0/source3/modules/vfs_aixacl2.c samba-4.8.1/source3/modules/vfs_aixacl2.c
--- samba-4.8.0/source3/modules/vfs_aixacl2.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/modules/vfs_aixacl2.c	2018-04-26 09:21:03.000000000 +0200
@@ -476,7 +476,8 @@ int aixjfs2_sys_acl_set_file(vfs_handle_
 	acl_type_t	acl_type_info;
 	int	rc;
 
-	DEBUG(10, ("aixjfs2_sys_acl_set_file invoked for %s", name));
+	DEBUG(10, ("aixjfs2_sys_acl_set_file invoked for %s",
+		   smb_fname->base_name));
 
 	rc = aixjfs2_query_acl_support((char *)smb_fname->base_name,
 			ACL_AIXC, &acl_type_info);
@@ -490,7 +491,7 @@ int aixjfs2_sys_acl_set_file(vfs_handle_
 		return -1;
 
 	rc = aclx_put(
-		(char *)name,
+		(char *)smb_fname->base_name,
 		SET_ACL, /* set only the ACL, not mode bits */
 		acl_type_info,
 		acl_aixc,
diff -Npur samba-4.8.0/source3/modules/vfs_default.c samba-4.8.1/source3/modules/vfs_default.c
--- samba-4.8.0/source3/modules/vfs_default.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/modules/vfs_default.c	2018-04-26 09:21:03.000000000 +0200
@@ -2229,9 +2229,12 @@ static struct smb_filename *vfswrap_getw
 				NULL,
 				NULL,
 				0);
-	if (smb_fname == NULL) {
-		SAFE_FREE(result);
-	}
+	/*
+	 * sys_getwd() *always* returns malloced memory.
+	 * We must free here to avoid leaks:
+	 * BUG:https://bugzilla.samba.org/show_bug.cgi?id=13372
+	 */
+	SAFE_FREE(result);
 	return smb_fname;
 }
 
diff -Npur samba-4.8.0/source3/modules/vfs_fruit.c samba-4.8.1/source3/modules/vfs_fruit.c
--- samba-4.8.0/source3/modules/vfs_fruit.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source3/modules/vfs_fruit.c	2018-04-26 09:21:03.000000000 +0200
@@ -2954,10 +2954,54 @@ static NTSTATUS readdir_attr_macmeta(str
 	return status;
 }
 
+static NTSTATUS remove_virtual_nfs_aces(struct security_descriptor *psd)
+{
+	NTSTATUS status;
+	uint32_t i;
+
+	if (psd->dacl == NULL) {
+		return NT_STATUS_OK;
+	}
+
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		/* MS NFS style mode/uid/gid */
+		int cmp = dom_sid_compare_domain(
+				&global_sid_Unix_NFS,
+				&psd->dacl->aces[i].trustee);
+		if (cmp != 0) {
+			/* Normal ACE entry. */
+			continue;
+		}
+
+		/*
+		 * security_descriptor_dacl_del()
+		 * *must* return NT_STATUS_OK as we know
+		 * we have something to remove.
+		 */
+
+		status = security_descriptor_dacl_del(psd,
+				&psd->dacl->aces[i].trustee);
+		if (!NT_STATUS_IS_OK(status)) {
+			DBG_WARNING("failed to remove MS NFS style ACE: %s\n",
+				nt_errstr(status));
+			return status;
+		}
+
+		/*
+		 * security_descriptor_dacl_del() may delete more
+		 * then one entry subsequent to this one if the
+		 * SID matches, but we only need to ensure that
+		 * we stay looking at the same element in the array.
+		 */
+		i--;
+	}
+	return NT_STATUS_OK;
+}
+
 /* Search MS NFS style ACE with UNIX mode */
 static NTSTATUS check_ms_nfs(vfs_handle_struct *handle,
 			     files_struct *fsp,
-			     const struct security_descriptor *psd,
+			     struct security_descriptor *psd,
 			     mode_t *pmode,
 			     bool *pdo_chmod)
 {
@@ -2991,7 +3035,12 @@ static NTSTATUS check_ms_nfs(vfs_handle_
 		}
 	}
 
-	return NT_STATUS_OK;
+	/*
+	 * Remove any incoming virtual ACE entries generated by
+	 * fruit_fget_nt_acl().
+	 */
+
+	return remove_virtual_nfs_aces(psd);
 }
 
 /****************************************************************************
@@ -5708,6 +5757,13 @@ static NTSTATUS fruit_fget_nt_acl(vfs_ha
 		return NT_STATUS_OK;
 	}
 
+	/* First remove any existing ACE's with NFS style mode/uid/gid SIDs. */
+	status = remove_virtual_nfs_aces(*ppdesc);
+	if (!NT_STATUS_IS_OK(status)) {
+		DBG_WARNING("failed to remove MS NFS style ACEs\n");
+		return status;
+	}
+
 	/* MS NFS style mode */
 	sid_compose(&sid, &global_sid_Unix_NFS_Mode, fsp->fsp_name->st.st_ex_mode);
 	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
@@ -5741,24 +5797,53 @@ static NTSTATUS fruit_fget_nt_acl(vfs_ha
 static NTSTATUS fruit_fset_nt_acl(vfs_handle_struct *handle,
 				  files_struct *fsp,
 				  uint32_t security_info_sent,
-				  const struct security_descriptor *psd)
+				  const struct security_descriptor *orig_psd)
 {
 	NTSTATUS status;
 	bool do_chmod;
 	mode_t ms_nfs_mode = 0;
 	int result;
+	struct security_descriptor *psd = NULL;
+	uint32_t orig_num_aces = 0;
+
+	if (orig_psd->dacl != NULL) {
+		orig_num_aces = orig_psd->dacl->num_aces;
+	}
+
+	psd = security_descriptor_copy(talloc_tos(), orig_psd);
+	if (psd == NULL) {
+		return NT_STATUS_NO_MEMORY;
+	}
 
 	DBG_DEBUG("fruit_fset_nt_acl: %s\n", fsp_str_dbg(fsp));
 
 	status = check_ms_nfs(handle, fsp, psd, &ms_nfs_mode, &do_chmod);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("fruit_fset_nt_acl: check_ms_nfs failed%s\n", fsp_str_dbg(fsp)));
+		TALLOC_FREE(psd);
 		return status;
 	}
 
+	/*
+	 * If only ms_nfs ACE entries were sent, ensure we set the DACL
+	 * sent/present flags correctly now we've removed them.
+	 */
+
+	if (orig_num_aces != 0) {
+		/*
+		 * Are there any ACE's left ?
+		 */
+		if (psd->dacl->num_aces == 0) {
+			/* No - clear the DACL sent/present flags. */
+			security_info_sent &= ~SECINFO_DACL;
+			psd->type &= ~SEC_DESC_DACL_PRESENT;
+		}
+	}
+
 	status = SMB_VFS_NEXT_FSET_NT_ACL(handle, fsp, security_info_sent, psd);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("fruit_fset_nt_acl: SMB_VFS_NEXT_FSET_NT_ACL failed%s\n", fsp_str_dbg(fsp)));
+		TALLOC_FREE(psd);
 		return status;
 	}
 
@@ -5776,10 +5861,12 @@ static NTSTATUS fruit_fset_nt_acl(vfs_ha
 				  result, (unsigned)ms_nfs_mode,
 				  strerror(errno)));
 			status = map_nt_error_from_unix(errno);
+			TALLOC_FREE(psd);
 			return status;
 		}
 	}
 
+	TALLOC_FREE(psd);
 	return NT_STATUS_OK;
 }
 
diff -Npur samba-4.8.0/source3/modules/vfs_virusfilter.c samba-4.8.1/source3/modules/vfs_virusfilter.c
--- samba-4.8.0/source3/modules/vfs_virusfilter.c	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.1/source3/modules/vfs_virusfilter.c	2018-04-26 09:21:03.000000000 +0200
@@ -275,8 +275,9 @@ static int virusfilter_vfs_connect(
 	temp_quarantine_dir_mode = lp_parm_const_string(
 		snum, "virusfilter", "quarantine directory mode", "0755");
 	if (temp_quarantine_dir_mode != NULL) {
-		sscanf(temp_quarantine_dir_mode, "%o",
-		       &config->quarantine_dir_mode);
+		unsigned int mode = 0;
+		sscanf(temp_quarantine_dir_mode, "%o", &mode);
+		config->quarantine_dir_mode = mode;
 	}
 
 	config->quarantine_prefix = lp_parm_const_string(
diff -Npur samba-4.8.0/source3/modules/vfs_virusfilter_utils.c samba-4.8.1/source3/modules/vfs_virusfilter_utils.c
--- samba-4.8.0/source3/modules/vfs_virusfilter_utils.c	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.1/source3/modules/vfs_virusfilter_utils.c	2018-04-26 09:21:03.000000000 +0200
@@ -147,11 +147,18 @@ bool virusfilter_io_connect_path(
 {
 	struct sockaddr_un addr;
 	NTSTATUS status;
-	int socket, bes_result, flags, ret;
+	int socket, ret;
+	size_t len;
+	bool ok;
 
 	ZERO_STRUCT(addr);
 	addr.sun_family = AF_UNIX;
-	strncpy(addr.sun_path, path, sizeof(addr.sun_path));
+
+	len = strlcpy(addr.sun_path, path, sizeof(addr.sun_path));
+	if (len >= sizeof(addr.sun_path)) {
+		io_h->stream = NULL;
+		return false;
+	}
 
 	status = open_socket_out((struct sockaddr_storage *)&addr, 0,
 				 io_h->connect_timeout,
@@ -162,23 +169,23 @@ bool virusfilter_io_connect_path(
 	}
 
 	/* We must not block */
-	flags = fcntl(socket, F_GETFL);
-	if (flags <= 0) {
-		/* Handle error by ignoring */;
-		flags = 0;
-		DBG_WARNING("Could not get flags on socket (%s).\n",
-			    strerror(errno));
-	}
-	flags |= SOCK_NONBLOCK;
-	ret = fcntl(socket, F_SETFL, flags);
+	ret = set_blocking(socket, false);
 	if (ret == -1) {
-		/* Handle error by ignoring for now */
-		DBG_WARNING("Could not set flags on socket: %s.\n",
-			    strerror(errno));
+		close(socket);
+		io_h->stream = NULL;
+		return false;
 	}
 
-	bes_result = tstream_bsd_existing_socket(io_h, socket, &io_h->stream);
-	if (bes_result < 0) {
+	ok = smb_set_close_on_exec(socket);
+	if (!ok) {
+		close(socket);
+		io_h->stream = NULL;
+		return false;
+	}
+
+	ret = tstream_bsd_existing_socket(io_h, socket, &io_h->stream);
+	if (ret == -1) {
+		close(socket);
 		DBG_ERR("Could not convert socket to tstream: %s.\n",
 			strerror(errno));
 		io_h->stream = NULL;
@@ -389,7 +396,7 @@ bool virusfilter_io_writefl(
 {
 	va_list ap;
 	char data[VIRUSFILTER_IO_BUFFER_SIZE + VIRUSFILTER_IO_EOL_SIZE];
-	size_t data_size;
+	int data_size;
 
 	va_start(ap, data_fmt);
 	data_size = vsnprintf(data, VIRUSFILTER_IO_BUFFER_SIZE, data_fmt, ap);
@@ -411,7 +418,7 @@ bool virusfilter_io_vwritefl(
 	const char *data_fmt, va_list ap)
 {
 	char data[VIRUSFILTER_IO_BUFFER_SIZE + VIRUSFILTER_IO_EOL_SIZE];
-	size_t data_size;
+	int data_size;
 
 	data_size = vsnprintf(data, VIRUSFILTER_IO_BUFFER_SIZE, data_fmt, ap);
 
diff -Npur samba-4.8.0/source3/passdb/machine_account_secrets.c samba-4.8.1/source3/passdb/machine_account_secrets.c
--- samba-4.8.0/source3/passdb/machine_account_secrets.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/passdb/machine_account_secrets.c	2018-04-26 09:21:03.000000000 +0200
@@ -1317,7 +1317,7 @@ NTSTATUS secrets_fetch_or_upgrade_domain
 
 	last_set_time = secrets_fetch_pass_last_set_time(domain);
 	if (last_set_time == 0) {
-		return NT_STATUS_OK;
+		return NT_STATUS_CANT_ACCESS_DOMAIN_INFO;
 	}
 	unix_to_nt_time(&last_set_nt, last_set_time);
 
diff -Npur samba-4.8.0/source3/passdb/pdb_util.c samba-4.8.1/source3/passdb/pdb_util.c
--- samba-4.8.0/source3/passdb/pdb_util.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/passdb/pdb_util.c	2018-04-26 09:21:03.000000000 +0200
@@ -130,8 +130,9 @@ NTSTATUS create_builtin_users(const stru
 	}
 
 	/* add domain users */
-	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER))
-		&& sid_compose(&dom_users, dom_sid, DOMAIN_RID_USERS))
+	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER)) &&
+	    (dom_sid != NULL) &&
+	    sid_compose(&dom_users, dom_sid, DOMAIN_RID_USERS))
 	{
 		status = add_sid_to_builtin(&global_sid_Builtin_Users,
 					    &dom_users);
@@ -159,8 +160,9 @@ NTSTATUS create_builtin_administrators(c
 	}
 
 	/* add domain admins */
-	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER))
-		&& sid_compose(&dom_admins, dom_sid, DOMAIN_RID_ADMINS))
+	if ((IS_DC || (lp_server_role() == ROLE_DOMAIN_MEMBER)) &&
+	    (dom_sid != NULL) &&
+	    sid_compose(&dom_admins, dom_sid, DOMAIN_RID_ADMINS))
 	{
 		status = add_sid_to_builtin(&global_sid_Builtin_Administrators,
 					    &dom_admins);
diff -Npur samba-4.8.0/source3/rpc_server/rpc_ncacn_np.c samba-4.8.1/source3/rpc_server/rpc_ncacn_np.c
--- samba-4.8.0/source3/rpc_server/rpc_ncacn_np.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/rpc_server/rpc_ncacn_np.c	2018-04-26 09:21:03.000000000 +0200
@@ -69,14 +69,16 @@ fail:
 	return NULL;
 }
 
-NTSTATUS make_internal_rpc_pipe_socketpair(TALLOC_CTX *mem_ctx,
-					   struct tevent_context *ev_ctx,
-					   struct messaging_context *msg_ctx,
-					   const char *pipe_name,
-					   const struct ndr_syntax_id *syntax,
-					   const struct tsocket_address *remote_address,
-					   const struct auth_session_info *session_info,
-					   struct npa_state **pnpa)
+NTSTATUS make_internal_rpc_pipe_socketpair(
+	TALLOC_CTX *mem_ctx,
+	struct tevent_context *ev_ctx,
+	struct messaging_context *msg_ctx,
+	const char *pipe_name,
+	const struct ndr_syntax_id *syntax,
+	const struct tsocket_address *remote_address,
+	const struct tsocket_address *local_address,
+	const struct auth_session_info *session_info,
+	struct npa_state **pnpa)
 {
 	TALLOC_CTX *tmp_ctx = talloc_stackframe();
 	struct named_pipe_client *npc;
@@ -135,6 +137,19 @@ NTSTATUS make_internal_rpc_pipe_socketpa
 		status = NT_STATUS_NO_MEMORY;
 		goto out;
 	}
+
+	npc->local_server_addr = tsocket_address_copy(local_address, npc);
+	if (npc->local_server_addr == NULL) {
+		status = NT_STATUS_NO_MEMORY;
+		goto out;
+	}
+
+	npc->local_server_name = tsocket_address_inet_addr_string(
+		npc->local_server_addr, npc);
+	if (npc->local_server_name == NULL) {
+		status = NT_STATUS_NO_MEMORY;
+		goto out;
+	}
 
 	npc->session_info = copy_session_info(npc, session_info);
 	if (npc->session_info == NULL) {
diff -Npur samba-4.8.0/source3/rpc_server/rpc_ncacn_np.h samba-4.8.1/source3/rpc_server/rpc_ncacn_np.h
--- samba-4.8.0/source3/rpc_server/rpc_ncacn_np.h	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/rpc_server/rpc_ncacn_np.h	2018-04-26 09:21:03.000000000 +0200
@@ -44,14 +44,16 @@ NTSTATUS make_external_rpc_pipe(TALLOC_C
 				const struct auth_session_info *session_info,
 				struct npa_state **pnpa);
 
-NTSTATUS make_internal_rpc_pipe_socketpair(TALLOC_CTX *mem_ctx,
-					   struct tevent_context *ev_ctx,
-					   struct messaging_context *msg_ctx,
-					   const char *pipe_name,
-					   const struct ndr_syntax_id *syntax,
-					   const struct tsocket_address *remote_address,
-					   const struct auth_session_info *session_info,
-					   struct npa_state **pnpa);
+NTSTATUS make_internal_rpc_pipe_socketpair(
+	TALLOC_CTX *mem_ctx,
+	struct tevent_context *ev_ctx,
+	struct messaging_context *msg_ctx,
+	const char *pipe_name,
+	const struct ndr_syntax_id *syntax,
+	const struct tsocket_address *remote_address,
+	const struct tsocket_address *local_address,
+	const struct auth_session_info *session_info,
+	struct npa_state **pnpa);
 
 struct np_proxy_state {
 	uint16_t file_type;
diff -Npur samba-4.8.0/source3/rpc_server/rpc_server.c samba-4.8.1/source3/rpc_server/rpc_server.c
--- samba-4.8.0/source3/rpc_server/rpc_server.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/rpc_server/rpc_server.c	2018-04-26 09:21:03.000000000 +0200
@@ -1107,14 +1107,11 @@ void dcerpc_ncacn_accept(struct tevent_c
 	}
 
 	if (ncacn_conn->session_info == NULL) {
-		/*
-		 * TODO: use auth_anonymous_session_info() here?
-		 */
-		status = make_session_info_guest(ncacn_conn,
-						 &ncacn_conn->session_info);
+		status = make_session_info_anonymous(ncacn_conn,
+						     &ncacn_conn->session_info);
 		if (!NT_STATUS_IS_OK(status)) {
 			DEBUG(2, ("Failed to create "
-				  "make_session_info_guest - %s\n",
+				  "make_session_info_anonymous - %s\n",
 				  nt_errstr(status)));
 			talloc_free(ncacn_conn);
 			return;
diff -Npur samba-4.8.0/source3/rpc_server/srv_pipe_hnd.c samba-4.8.1/source3/rpc_server/srv_pipe_hnd.c
--- samba-4.8.0/source3/rpc_server/srv_pipe_hnd.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/rpc_server/srv_pipe_hnd.c	2018-04-26 09:21:03.000000000 +0200
@@ -106,14 +106,16 @@ NTSTATUS np_open(TALLOC_CTX *mem_ctx, co
 			return NT_STATUS_OBJECT_NAME_NOT_FOUND;
 		}
 
-		status = make_internal_rpc_pipe_socketpair(handle,
-							   ev_ctx,
-							   msg_ctx,
-							   name,
-							   &syntax,
-							   remote_client_address,
-							   session_info,
-							   &npa);
+		status = make_internal_rpc_pipe_socketpair(
+			handle,
+			ev_ctx,
+			msg_ctx,
+			name,
+			&syntax,
+			remote_client_address,
+			local_server_address,
+			session_info,
+			&npa);
 		if (!NT_STATUS_IS_OK(status)) {
 			talloc_free(handle);
 			return status;
diff -Npur samba-4.8.0/source3/script/tests/test_smbclient_s3.sh samba-4.8.1/source3/script/tests/test_smbclient_s3.sh
--- samba-4.8.0/source3/script/tests/test_smbclient_s3.sh	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/script/tests/test_smbclient_s3.sh	2018-04-26 09:21:03.000000000 +0200
@@ -643,13 +643,17 @@ test_backup_privilege_list()
 {
     tmpfile=$PREFIX/smbclient_backup_privilege_list
 
+    # selftest uses the forward slash as a separator, but "net sam rights
+    # grant" requires the backslash separator
+    USER_TMP=$(printf '%s' "$USERNAME" | tr '/' '\\')
+
     # If we don't have a DOMAIN component to the username, add it.
-    echo "$USERNAME" | grep '\\' 2>&1
+    printf '%s' "$USER_TMP" | grep '\\' 2>&1
     ret=$?
     if [ $ret != 0 ] ; then
-	priv_username="$DOMAIN\\$USERNAME"
+	priv_username="$DOMAIN\\$USER_TMP"
     else
-	priv_username=$USERNAME
+	priv_username="$USER_TMP"
     fi
 
     $NET sam rights grant $priv_username SeBackupPrivilege 2>&1
diff -Npur samba-4.8.0/source3/selftest/tests.py samba-4.8.1/source3/selftest/tests.py
--- samba-4.8.0/source3/selftest/tests.py	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/selftest/tests.py	2018-04-26 09:21:03.000000000 +0200
@@ -78,6 +78,7 @@ tests = ["FDPASS", "LOCK1", "LOCK2", "LO
         "UID-REGRESSION-TEST", "SHORTNAME-TEST",
         "CASE-INSENSITIVE-CREATE", "SMB2-BASIC", "NTTRANS-FSCTL", "SMB2-NEGPROT",
         "SMB2-SESSION-REAUTH", "SMB2-SESSION-RECONNECT", "SMB2-FTRUNCATE",
+        "SMB2-ANONYMOUS",
         "CLEANUP1",
         "CLEANUP2",
         "CLEANUP4",
@@ -206,6 +207,10 @@ for env in ["nt4_member", "ad_member"]:
 env = "ad_member"
 t = "--krb5auth=$DOMAIN/$DC_USERNAME%$DC_PASSWORD"
 plantestsuite("samba3.wbinfo_simple.(%s:local).%s" % (env, t), "%s:local" % env, [os.path.join(srcdir(), "nsswitch/tests/test_wbinfo_simple.sh"), t])
+plantestsuite("samba3.wbinfo_name_lookup", env,
+              [ os.path.join(srcdir(),
+                            "nsswitch/tests/test_wbinfo_name_lookup.sh"),
+                '$DOMAIN', '$DC_USERNAME' ])
 t = "WBCLIENT-MULTI-PING"
 plantestsuite("samba3.smbtorture_s3.%s" % t, env, [os.path.join(samba3srcdir, "script/tests/test_smbtorture_s3.sh"), t, '//foo/bar', '""', '""', smbtorture3, ""])
 plantestsuite("samba3.substitutions", env, [os.path.join(samba3srcdir, "script/tests/test_substitutions.sh"), "$SERVER", "alice", "Secret007", "$PREFIX"])
@@ -499,7 +504,7 @@ for t in tests:
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_metadata_stream -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share --option=torture:share2=vfs_wo_fruit', 'metadata_stream')
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_stream_depot -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share --option=torture:share2=vfs_wo_fruit_stream_depot', 'streams_depot')
     elif t == "vfs.fruit_netatalk":
-        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
+        plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_xattr -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
     elif t == "vfs.fruit_timemachine":
         plansmbtorture4testsuite(t, "nt4_dc", '//$SERVER_IP/vfs_fruit_timemachine -U$USERNAME%$PASSWORD --option=torture:localdir=$SELFTEST_PREFIX/nt4_dc/share')
     elif t == "vfs.fruit_file_id":
diff -Npur samba-4.8.0/source3/smbd/dir.c samba-4.8.1/source3/smbd/dir.c
--- samba-4.8.0/source3/smbd/dir.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/dir.c	2018-04-26 09:21:03.000000000 +0200
@@ -1219,7 +1219,15 @@ bool smbd_dirptr_get_entry(TALLOC_CTX *c
 			mask, smb_fname_str_dbg(&smb_fname),
 			dname, fname));
 
-		DirCacheAdd(dirptr->dir_hnd, dname, cur_offset);
+		if (!conn->sconn->using_smb2) {
+			/*
+			 * The dircache is only needed for SMB1 because SMB1
+			 * uses a name for the resume wheras SMB2 always
+			 * continues from the next position (unless it's told to
+			 * restart or close-and-reopen the listing).
+			 */
+			DirCacheAdd(dirptr->dir_hnd, dname, cur_offset);
+		}
 
 		TALLOC_FREE(dname);
 
@@ -1646,7 +1654,16 @@ static struct smb_Dir *OpenDir_internal(
 	}
 
 	dirp->conn = conn;
-	dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+
+	if (!conn->sconn->using_smb2) {
+		/*
+		 * The dircache is only needed for SMB1 because SMB1 uses a name
+		 * for the resume wheras SMB2 always continues from the next
+		 * position (unless it's told to restart or close-and-reopen the
+		 * listing).
+		 */
+		dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+	}
 
 	if (sconn && !sconn->using_smb2) {
 		sconn->searches.dirhandles_open++;
@@ -1768,7 +1785,16 @@ static struct smb_Dir *OpenDir_fsp(TALLO
 	}
 
 	dirp->conn = conn;
-	dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+
+	if (!conn->sconn->using_smb2) {
+		/*
+		 * The dircache is only needed for SMB1 because SMB1 uses a name
+		 * for the resume wheras SMB2 always continues from the next
+		 * position (unless it's told to restart or close-and-reopen the
+		 * listing).
+		 */
+		dirp->name_cache_size = lp_directory_name_cache_size(SNUM(conn));
+	}
 
 	dirp->dir_smb_fname = cp_smb_filename(dirp, fsp->fsp_name);
 	if (!dirp->dir_smb_fname) {
diff -Npur samba-4.8.0/source3/smbd/open.c samba-4.8.1/source3/smbd/open.c
--- samba-4.8.0/source3/smbd/open.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/open.c	2018-04-26 09:21:03.000000000 +0200
@@ -5074,6 +5074,18 @@ static NTSTATUS create_file_unixpath(con
 		goto fail;
 	}
 
+	/*
+	 * Files or directories can't be opened DELETE_ON_CLOSE without
+	 * delete access.
+	 * BUG: https://bugzilla.samba.org/show_bug.cgi?id=13358
+	 */
+	if (create_options & FILE_DELETE_ON_CLOSE) {
+		if ((access_mask & DELETE_ACCESS) == 0) {
+			status = NT_STATUS_INVALID_PARAMETER;
+			goto fail;
+		}
+	}
+
 	if ((conn->fs_capabilities & FILE_NAMED_STREAMS)
 	    && is_ntfs_stream_smb_fname(smb_fname)
 	    && (!(private_flags & NTCREATEX_OPTIONS_PRIVATE_STREAM_DELETE))) {
diff -Npur samba-4.8.0/source3/smbd/smb2_break.c samba-4.8.1/source3/smbd/smb2_break.c
--- samba-4.8.0/source3/smbd/smb2_break.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_break.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "locking/leases_db.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static NTSTATUS smbd_smb2_request_process_lease_break(
 	struct smbd_smb2_request *req);
 
diff -Npur samba-4.8.0/source3/smbd/smb2_close.c samba-4.8.1/source3/smbd/smb2_close.c
--- samba-4.8.0/source3/smbd/smb2_close.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_close.c	2018-04-26 09:21:03.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "lib/tevent_wait.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_close_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_create.c samba-4.8.1/source3/smbd/smb2_create.c
--- samba-4.8.0/source3/smbd/smb2_create.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_create.c	2018-04-26 09:21:03.000000000 +0200
@@ -29,6 +29,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 int map_smb2_oplock_levels_to_samba(uint8_t in_oplock_level)
 {
 	switch(in_oplock_level) {
diff -Npur samba-4.8.0/source3/smbd/smb2_flush.c samba-4.8.1/source3/smbd/smb2_flush.c
--- samba-4.8.0/source3/smbd/smb2_flush.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_flush.c	2018-04-26 09:21:03.000000000 +0200
@@ -24,6 +24,9 @@
 #include "../libcli/smb/smb_common.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_flush_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
@@ -198,7 +201,7 @@ static void smbd_smb2_flush_done(struct
 	ret = SMB_VFS_FSYNC_RECV(subreq, &vfs_aio_state);
 	TALLOC_FREE(subreq);
 	if (ret == -1) {
-		tevent_req_error(req, vfs_aio_state.error);
+		tevent_req_nterror(req, map_nt_error_from_unix(vfs_aio_state.error));
 		return;
 	}
 	tevent_req_done(req);
diff -Npur samba-4.8.0/source3/smbd/smb2_getinfo.c samba-4.8.1/source3/smbd/smb2_getinfo.c
--- samba-4.8.0/source3/smbd/smb2_getinfo.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_getinfo.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 #include "trans2.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_getinfo_send(TALLOC_CTX *mem_ctx,
 						 struct tevent_context *ev,
 						 struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_glue.c samba-4.8.1/source3/smbd/smb2_glue.c
--- samba-4.8.0/source3/smbd/smb2_glue.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_glue.c	2018-04-26 09:21:03.000000000 +0200
@@ -23,6 +23,9 @@
 #include "smbd/globals.h"
 #include "../libcli/smb/smb_common.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smb_request *smbd_smb2_fake_smb_request(struct smbd_smb2_request *req)
 {
 	struct smb_request *smbreq;
diff -Npur samba-4.8.0/source3/smbd/smb2_ioctl.c samba-4.8.1/source3/smbd/smb2_ioctl.c
--- samba-4.8.0/source3/smbd/smb2_ioctl.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_ioctl.c	2018-04-26 09:21:03.000000000 +0200
@@ -27,6 +27,9 @@
 #include "smb2_ioctl_private.h"
 #include "librpc/gen_ndr/ioctl.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_ioctl_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_ioctl_dfs.c samba-4.8.1/source3/smbd/smb2_ioctl_dfs.c
--- samba-4.8.0/source3/smbd/smb2_ioctl_dfs.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_ioctl_dfs.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 #include "include/ntioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static NTSTATUS fsctl_dfs_get_refers(TALLOC_CTX *mem_ctx,
 				     struct tevent_context *ev,
 				     struct connection_struct *conn,
diff -Npur samba-4.8.0/source3/smbd/smb2_ioctl_filesys.c samba-4.8.1/source3/smbd/smb2_ioctl_filesys.c
--- samba-4.8.0/source3/smbd/smb2_ioctl_filesys.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_ioctl_filesys.c	2018-04-26 09:21:03.000000000 +0200
@@ -31,6 +31,9 @@
 #include "librpc/gen_ndr/ndr_ioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 /*
  * XXX this may reduce dup_extents->byte_count so that it's less than the
  * target file size.
diff -Npur samba-4.8.0/source3/smbd/smb2_ioctl_named_pipe.c samba-4.8.1/source3/smbd/smb2_ioctl_named_pipe.c
--- samba-4.8.0/source3/smbd/smb2_ioctl_named_pipe.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_ioctl_named_pipe.c	2018-04-26 09:21:03.000000000 +0200
@@ -27,6 +27,9 @@
 #include "include/ntioctl.h"
 #include "smb2_ioctl_private.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void smbd_smb2_ioctl_pipe_write_done(struct tevent_req *subreq);
 static void smbd_smb2_ioctl_pipe_read_done(struct tevent_req *subreq);
 
diff -Npur samba-4.8.0/source3/smbd/smb2_ioctl_network_fs.c samba-4.8.1/source3/smbd/smb2_ioctl_network_fs.c
--- samba-4.8.0/source3/smbd/smb2_ioctl_network_fs.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_ioctl_network_fs.c	2018-04-26 09:21:03.000000000 +0200
@@ -31,6 +31,9 @@
 #include "smb2_ioctl_private.h"
 #include "../lib/tsocket/tsocket.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void copychunk_pack_limits(struct srv_copychunk_rsp *cc_rsp)
 {
 	cc_rsp->chunks_written = COPYCHUNK_MAX_CHUNKS;
diff -Npur samba-4.8.0/source3/smbd/smb2_keepalive.c samba-4.8.1/source3/smbd/smb2_keepalive.c
--- samba-4.8.0/source3/smbd/smb2_keepalive.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_keepalive.c	2018-04-26 09:21:03.000000000 +0200
@@ -23,6 +23,9 @@
 #include "smbd/globals.h"
 #include "../libcli/smb/smb_common.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 NTSTATUS smbd_smb2_request_process_keepalive(struct smbd_smb2_request *req)
 {
 	DATA_BLOB outbody;
diff -Npur samba-4.8.0/source3/smbd/smb2_lock.c samba-4.8.1/source3/smbd/smb2_lock.c
--- samba-4.8.0/source3/smbd/smb2_lock.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_lock.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smbd_smb2_lock_element {
 	uint64_t offset;
 	uint64_t length;
diff -Npur samba-4.8.0/source3/smbd/smb2_negprot.c samba-4.8.1/source3/smbd/smb2_negprot.c
--- samba-4.8.0/source3/smbd/smb2_negprot.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_negprot.c	2018-04-26 09:21:03.000000000 +0200
@@ -27,6 +27,9 @@
 #include "../librpc/ndr/libndr.h"
 #include "../libcli/smb/smb_signing.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 extern fstring remote_proto;
 
 /*
diff -Npur samba-4.8.0/source3/smbd/smb2_notify.c samba-4.8.1/source3/smbd/smb2_notify.c
--- samba-4.8.0/source3/smbd/smb2_notify.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_notify.c	2018-04-26 09:21:03.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../libcli/smb/smb_common.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 struct smbd_smb2_notify_state {
 	struct smbd_smb2_request *smb2req;
 	struct smb_request *smbreq;
diff -Npur samba-4.8.0/source3/smbd/smb2_query_directory.c samba-4.8.1/source3/smbd/smb2_query_directory.c
--- samba-4.8.0/source3/smbd/smb2_query_directory.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_query_directory.c	2018-04-26 09:21:03.000000000 +0200
@@ -26,6 +26,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "system/filesys.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_query_directory_send(TALLOC_CTX *mem_ctx,
 					      struct tevent_context *ev,
 					      struct smbd_smb2_request *smb2req,
@@ -343,11 +346,14 @@ static struct tevent_req *smbd_smb2_quer
 	if (in_flags & SMB2_CONTINUE_FLAG_REOPEN) {
 		int flags;
 
-		dptr_CloseDir(fsp);
+		status = fd_close(fsp);
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 
 		/*
-		 * dptr_CloseDir() will close and invalidate the fsp's file
-		 * descriptor, we have to reopen it.
+		 * fd_close() will close and invalidate the fsp's file
+		 * descriptor. So we have to reopen it.
 		 */
 
 		flags = O_RDONLY;
diff -Npur samba-4.8.0/source3/smbd/smb2_read.c samba-4.8.1/source3/smbd/smb2_read.c
--- samba-4.8.0/source3/smbd/smb2_read.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_read.c	2018-04-26 09:21:03.000000000 +0200
@@ -28,6 +28,9 @@
 #include "rpc_server/srv_pipe_hnd.h"
 #include "lib/util/sys_rw_data.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_read_send(TALLOC_CTX *mem_ctx,
 					      struct tevent_context *ev,
 					      struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_server.c samba-4.8.1/source3/smbd/smb2_server.c
--- samba-4.8.0/source3/smbd/smb2_server.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_server.c	2018-04-26 09:21:03.000000000 +0200
@@ -32,6 +32,9 @@
 #include "auth.h"
 #include "lib/crypto/sha512.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static void smbd_smb2_connection_handler(struct tevent_context *ev,
 					 struct tevent_fd *fde,
 					 uint16_t flags,
@@ -613,34 +616,37 @@ static bool smb2_validate_sequence_numbe
 
 	seq_tmp = xconn->smb2.credits.seq_low;
 	if (seq_id < seq_tmp) {
-		DEBUG(0,("smb2_validate_sequence_number: bad message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: bad message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u)\n",
 			(unsigned long long)message_id,
 			(unsigned long long)seq_id,
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
-			(unsigned int)xconn->smb2.credits.seq_range));
+			(unsigned int)xconn->smb2.credits.seq_range);
 		return false;
 	}
 
 	seq_tmp += xconn->smb2.credits.seq_range;
 	if (seq_id >= seq_tmp) {
-		DEBUG(0,("smb2_validate_sequence_number: bad message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: bad message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u)\n",
 			(unsigned long long)message_id,
 			(unsigned long long)seq_id,
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
-			(unsigned int)xconn->smb2.credits.seq_range));
+			(unsigned int)xconn->smb2.credits.seq_range);
 		return false;
 	}
 
 	offset = seq_id % xconn->smb2.credits.max;
 
 	if (bitmap_query(credits_bm, offset)) {
-		DEBUG(0,("smb2_validate_sequence_number: duplicate message_id "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			"smb2_validate_sequence_number: duplicate message_id "
 			"%llu (sequence id %llu) "
 			"(granted = %u, low = %llu, range = %u) "
 			"(bm offset %u)\n",
@@ -649,7 +655,7 @@ static bool smb2_validate_sequence_numbe
 			(unsigned int)xconn->smb2.credits.granted,
 			(unsigned long long)xconn->smb2.credits.seq_low,
 			(unsigned int)xconn->smb2.credits.seq_range,
-			offset));
+			offset);
 		return false;
 	}
 
@@ -665,10 +671,11 @@ static bool smb2_validate_sequence_numbe
 	 * already seen.
 	 */
 	while (bitmap_query(credits_bm, offset)) {
-		DEBUG(10,("smb2_validate_sequence_number: clearing "
+		DBGC_DEBUG(DBGC_SMB2_CREDITS,
+			  "smb2_validate_sequence_number: clearing "
 			  "id %llu (position %u) from bitmap\n",
 			  (unsigned long long)(xconn->smb2.credits.seq_low),
-			  offset));
+			  offset);
 		bitmap_clear(credits_bm, offset);
 
 		xconn->smb2.credits.seq_low += 1;
@@ -697,7 +704,9 @@ static bool smb2_validate_message_id(str
 		credit_charge = MAX(credit_charge, 1);
 	}
 
-	DEBUG(11, ("smb2_validate_message_id: mid %llu (charge %llu), "
+	DEBUGC(11,
+		   DBGC_SMB2_CREDITS,
+		   ("smb2_validate_message_id: mid %llu (charge %llu), "
 		   "credits_granted %llu, "
 		   "seqnum low/range: %llu/%llu\n",
 		   (unsigned long long) message_id,
@@ -707,7 +716,8 @@ static bool smb2_validate_message_id(str
 		   (unsigned long long) xconn->smb2.credits.seq_range));
 
 	if (xconn->smb2.credits.granted < credit_charge) {
-		DEBUG(0, ("smb2_validate_message_id: client used more "
+		DBGC_ERR(DBGC_SMB2_CREDITS,
+			  "smb2_validate_message_id: client used more "
 			  "credits than granted, mid %llu, charge %llu, "
 			  "credits_granted %llu, "
 			  "seqnum low/range: %llu/%llu\n",
@@ -715,7 +725,7 @@ static bool smb2_validate_message_id(str
 			  (unsigned long long) credit_charge,
 			  (unsigned long long) xconn->smb2.credits.granted,
 			  (unsigned long long) xconn->smb2.credits.seq_low,
-			  (unsigned long long) xconn->smb2.credits.seq_range));
+			  (unsigned long long) xconn->smb2.credits.seq_range);
 		return false;
 	}
 
@@ -731,7 +741,9 @@ static bool smb2_validate_message_id(str
 		uint64_t id = message_id + i;
 		bool ok;
 
-		DEBUG(11, ("Iterating mid %llu charge %u (sequence %llu)\n",
+		DEBUGC(11,
+			   DBGC_SMB2_CREDITS,
+			   ("Iterating mid %llu charge %u (sequence %llu)\n",
 			   (unsigned long long)message_id,
 			   credit_charge,
 			   (unsigned long long)id));
@@ -909,7 +921,8 @@ static void smb2_set_operation_credit(st
 	xconn->smb2.credits.granted += credits_granted;
 	xconn->smb2.credits.seq_range += credits_granted;
 
-	DEBUG(10,("smb2_set_operation_credit: requested %u, charge %u, "
+	DBGC_DEBUG(DBGC_SMB2_CREDITS,
+		"smb2_set_operation_credit: requested %u, charge %u, "
 		"granted %u, current possible/max %u/%u, "
 		"total granted/max/low/range %u/%u/%llu/%u\n",
 		(unsigned int)credits_requested,
@@ -920,7 +933,7 @@ static void smb2_set_operation_credit(st
 		(unsigned int)xconn->smb2.credits.granted,
 		(unsigned int)xconn->smb2.credits.max,
 		(unsigned long long)xconn->smb2.credits.seq_low,
-		(unsigned int)xconn->smb2.credits.seq_range));
+		(unsigned int)xconn->smb2.credits.seq_range);
 }
 
 static void smb2_calculate_credits(const struct smbd_smb2_request *inreq,
@@ -1978,13 +1991,15 @@ NTSTATUS smbd_smb2_request_verify_credit
 
 	needed_charge = (data_length - 1)/ 65536 + 1;
 
-	DEBUG(10, ("mid %llu, CreditCharge: %d, NeededCharge: %d\n",
+	DBGC_DEBUG(DBGC_SMB2_CREDITS,
+		   "mid %llu, CreditCharge: %d, NeededCharge: %d\n",
 		   (unsigned long long) BVAL(inhdr, SMB2_HDR_MESSAGE_ID),
-		   credit_charge, needed_charge));
+		   credit_charge, needed_charge);
 
 	if (needed_charge > credit_charge) {
-		DEBUG(2, ("CreditCharge too low, given %d, needed %d\n",
-			  credit_charge, needed_charge));
+		DBGC_WARNING(DBGC_SMB2_CREDITS,
+			  "CreditCharge too low, given %d, needed %d\n",
+			  credit_charge, needed_charge);
 		return NT_STATUS_INVALID_PARAMETER;
 	}
 
@@ -2165,7 +2180,7 @@ static NTSTATUS smbd_smb2_request_dispat
 	bool update_open = false;
 	NTSTATUS status = NT_STATUS_OK;
 
-	req->request_counters_updated = false;
+	SMB_ASSERT(!req->request_counters_updated);
 
 	if (xconn->protocol < PROTOCOL_SMB2_22) {
 		return NT_STATUS_OK;
@@ -2300,6 +2315,8 @@ NTSTATUS smbd_smb2_request_dispatch(stru
 
 	DO_PROFILE_INC(request);
 
+	SMB_ASSERT(!req->request_counters_updated);
+
 	/* TODO: verify more things */
 
 	flags = IVAL(inhdr, SMB2_HDR_FLAGS);
@@ -2740,6 +2757,8 @@ static void smbd_smb2_request_reply_upda
 		return;
 	}
 
+	req->request_counters_updated = false;
+
 	if (xconn->protocol < PROTOCOL_SMB2_22) {
 		return;
 	}
diff -Npur samba-4.8.0/source3/smbd/smb2_sesssetup.c samba-4.8.1/source3/smbd/smb2_sesssetup.c
--- samba-4.8.0/source3/smbd/smb2_sesssetup.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_sesssetup.c	2018-04-26 09:21:03.000000000 +0200
@@ -33,6 +33,9 @@
 #include "lib/crypto/aes_ccm_128.h"
 #include "lib/crypto/aes_gcm_128.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_session_setup_wrap_send(TALLOC_CTX *mem_ctx,
 					struct tevent_context *ev,
 					struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_setinfo.c samba-4.8.1/source3/smbd/smb2_setinfo.c
--- samba-4.8.0/source3/smbd/smb2_setinfo.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_setinfo.c	2018-04-26 09:21:03.000000000 +0200
@@ -29,6 +29,9 @@
 #include "source3/lib/dbwrap/dbwrap_watch.h"
 #include "messages.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_setinfo_send(TALLOC_CTX *mem_ctx,
 						 struct tevent_context *ev,
 						 struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_tcon.c samba-4.8.1/source3/smbd/smb2_tcon.c
--- samba-4.8.0/source3/smbd/smb2_tcon.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_tcon.c	2018-04-26 09:21:03.000000000 +0200
@@ -27,6 +27,9 @@
 #include "lib/param/loadparm.h"
 #include "../lib/util/tevent_ntstatus.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_tree_connect_send(TALLOC_CTX *mem_ctx,
 					struct tevent_context *ev,
 					struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/smb2_write.c samba-4.8.1/source3/smbd/smb2_write.c
--- samba-4.8.0/source3/smbd/smb2_write.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/smb2_write.c	2018-04-26 09:21:03.000000000 +0200
@@ -25,6 +25,9 @@
 #include "../lib/util/tevent_ntstatus.h"
 #include "rpc_server/srv_pipe_hnd.h"
 
+#undef DBGC_CLASS
+#define DBGC_CLASS DBGC_SMB2
+
 static struct tevent_req *smbd_smb2_write_send(TALLOC_CTX *mem_ctx,
 					       struct tevent_context *ev,
 					       struct smbd_smb2_request *smb2req,
diff -Npur samba-4.8.0/source3/smbd/trans2.c samba-4.8.1/source3/smbd/trans2.c
--- samba-4.8.0/source3/smbd/trans2.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/smbd/trans2.c	2018-04-26 09:21:03.000000000 +0200
@@ -7777,10 +7777,10 @@ static NTSTATUS smb_set_file_unix_basic(
 
 		DEBUG(10,("smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC "
 			  "changing group %u for file %s\n",
-			  (unsigned int)set_owner,
+			  (unsigned int)set_grp,
 			  smb_fname_str_dbg(smb_fname)));
 		if (fsp && fsp->fh->fd != -1) {
-			ret = SMB_VFS_FCHOWN(fsp, set_owner, (gid_t)-1);
+			ret = SMB_VFS_FCHOWN(fsp, (uid_t)-1, set_grp);
 		} else {
 			/*
 			 * UNIX extensions calls must always operate
diff -Npur samba-4.8.0/source3/torture/proto.h samba-4.8.1/source3/torture/proto.h
--- samba-4.8.0/source3/torture/proto.h	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/torture/proto.h	2018-04-26 09:21:03.000000000 +0200
@@ -95,6 +95,7 @@ bool run_nttrans_create(int dummy);
 bool run_nttrans_fsctl(int dummy);
 bool run_smb2_basic(int dummy);
 bool run_smb2_negprot(int dummy);
+bool run_smb2_anonymous(int dummy);
 bool run_smb2_session_reconnect(int dummy);
 bool run_smb2_tcon_dependence(int dummy);
 bool run_smb2_multi_channel(int dummy);
diff -Npur samba-4.8.0/source3/torture/test_smb2.c samba-4.8.1/source3/torture/test_smb2.c
--- samba-4.8.0/source3/torture/test_smb2.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/torture/test_smb2.c	2018-04-26 09:21:03.000000000 +0200
@@ -24,6 +24,7 @@
 #include "../libcli/smb/smbXcli_base.h"
 #include "libcli/security/security.h"
 #include "libsmb/proto.h"
+#include "auth/credentials/credentials.h"
 #include "auth/gensec/gensec.h"
 #include "auth_generic.h"
 #include "../librpc/ndr/libndr.h"
@@ -271,6 +272,47 @@ bool run_smb2_negprot(int dummy)
 		return false;
 	}
 
+	return true;
+}
+
+bool run_smb2_anonymous(int dummy)
+{
+	struct cli_state *cli = NULL;
+	NTSTATUS status;
+	struct cli_credentials *anon_creds = NULL;
+	bool guest = false;
+
+	printf("Starting SMB2-ANONYMOUS\n");
+
+	if (!torture_init_connection(&cli)) {
+		return false;
+	}
+
+	status = smbXcli_negprot(cli->conn, cli->timeout,
+				 PROTOCOL_SMB2_02, PROTOCOL_LATEST);
+	if (!NT_STATUS_IS_OK(status)) {
+		printf("smbXcli_negprot returned %s\n", nt_errstr(status));
+		return false;
+	}
+
+	anon_creds = cli_credentials_init_anon(talloc_tos());
+	if (anon_creds == NULL) {
+		printf("cli_credentials_init_anon failed\n");
+		return false;
+	}
+
+	status = cli_session_setup_creds(cli, anon_creds);
+	if (!NT_STATUS_IS_OK(status)) {
+		printf("cli_session_setup returned %s\n", nt_errstr(status));
+		return false;
+	}
+
+	guest = smbXcli_session_is_guest(cli->smb2.session);
+	if (guest) {
+		printf("anonymous session should not have guest authentication\n");
+		return false;
+	}
+
 	return true;
 }
 
diff -Npur samba-4.8.0/source3/torture/torture.c samba-4.8.1/source3/torture/torture.c
--- samba-4.8.0/source3/torture/torture.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/torture/torture.c	2018-04-26 09:21:03.000000000 +0200
@@ -11588,6 +11588,7 @@ static struct {
 	{ "NOTIFY-ONLINE", run_notify_online },
 	{ "SMB2-BASIC", run_smb2_basic },
 	{ "SMB2-NEGPROT", run_smb2_negprot },
+	{ "SMB2-ANONYMOUS", run_smb2_anonymous },
 	{ "SMB2-SESSION-RECONNECT", run_smb2_session_reconnect },
 	{ "SMB2-TCON-DEPENDENCE", run_smb2_tcon_dependence },
 	{ "SMB2-MULTI-CHANNEL", run_smb2_multi_channel },
diff -Npur samba-4.8.0/source3/utils/destroy_netlogon_creds_cli.c samba-4.8.1/source3/utils/destroy_netlogon_creds_cli.c
--- samba-4.8.0/source3/utils/destroy_netlogon_creds_cli.c	1970-01-01 01:00:00.000000000 +0100
+++ samba-4.8.1/source3/utils/destroy_netlogon_creds_cli.c	2018-04-26 09:21:03.000000000 +0200
@@ -0,0 +1,137 @@
+/*
+ * Unix SMB/CIFS implementation.
+ * Garble the netlogon_creds_cli key for testing purposes
+ * Copyright (C) Volker Lendecke 2018
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ */
+
+#include "includes.h"
+#include "system/filesys.h"
+#include <talloc.h>
+#include <tevent.h>
+#include "messages.h"
+#include "lib/util/talloc_stack.h"
+#include "popt_common.h"
+#include "lib/param/loadparm.h"
+#include "lib/param/param.h"
+#include "libcli/auth/netlogon_creds_cli.h"
+#include "lib/dbwrap/dbwrap.h"
+#include "lib/dbwrap/dbwrap_open.h"
+
+int main(int argc, const char *argv[])
+{
+	TALLOC_CTX *mem_ctx = talloc_stackframe();
+	struct tevent_context *ev;
+	struct messaging_context *msg_ctx;
+	struct loadparm_context *lp_ctx;
+	struct db_context *global_db;
+	struct netlogon_creds_cli_context *ctx;
+	struct netlogon_creds_CredentialState *creds;
+	NTSTATUS status;
+	int ret = 1;
+
+	smb_init_locale();
+
+	if (!lp_load_global(get_dyn_CONFIGFILE())) {
+		fprintf(stderr, "error opening config file %s. Error was %s\n",
+			get_dyn_CONFIGFILE(), strerror(errno));
+		goto done;
+	}
+
+	if (argc != 4) {
+		fprintf(stderr, "usage: %s cli_computer domain dc\n", argv[0]);
+		goto done;
+	}
+
+	lp_ctx = loadparm_init_s3(mem_ctx, loadparm_s3_helpers());
+	if (lp_ctx == NULL) {
+		fprintf(stderr, "loadparm_init_s3 failed\n");
+		goto done;
+	}
+
+	ev = samba_tevent_context_init(mem_ctx);
+	if (ev == NULL) {
+		fprintf(stderr, "samba3_tevent_context_init failed\n");
+		goto done;
+	}
+	msg_ctx = messaging_init(mem_ctx, ev);
+	if (msg_ctx == NULL) {
+		fprintf(stderr, "messaging_init failed\n");
+		goto done;
+	}
+
+	global_db = db_open(
+		mem_ctx,
+		lpcfg_private_db_path(mem_ctx, lp_ctx, "netlogon_creds_cli"),
+		0, TDB_CLEAR_IF_FIRST|TDB_INCOMPATIBLE_HASH,
+		O_RDWR|O_CREAT, 0600, DBWRAP_LOCK_ORDER_2,
+		DBWRAP_FLAG_OPTIMIZE_READONLY_ACCESS);
+	if (global_db == NULL) {
+		fprintf(stderr, "db_open failed\n");
+		goto done;
+	}
+
+	status = netlogon_creds_cli_set_global_db(&global_db);
+	if (!NT_STATUS_IS_OK(status)) {
+		fprintf(stderr,
+			"netlogon_creds_cli_set_global_db failed: %s\n",
+			nt_errstr(status));
+		goto done;
+	}
+
+	status = netlogon_creds_cli_context_global(
+		lp_ctx,
+		msg_ctx,
+		talloc_asprintf(mem_ctx, "%s$", argv[1]),
+		SEC_CHAN_WKSTA,
+		argv[3],
+		argv[2],
+		"",
+		mem_ctx,
+		&ctx);
+	if (!NT_STATUS_IS_OK(status)) {
+		fprintf(stderr,
+			"netlogon_creds_cli_context_global failed: %s\n",
+			nt_errstr(status));
+		goto done;
+	}
+
+	status = netlogon_creds_cli_lock(ctx,
+					 mem_ctx,
+					 &creds);
+	if (!NT_STATUS_IS_OK(status)) {
+		fprintf(stderr,
+			"netlogon_creds_cli_get failed: %s\n",
+			nt_errstr(status));
+		goto done;
+	}
+
+	creds->session_key[0]++;
+
+	status = netlogon_creds_cli_store(ctx, creds);
+	if (!NT_STATUS_IS_OK(status)) {
+		fprintf(stderr,
+			"netlogon_creds_cli_store failed: %s\n",
+			nt_errstr(status));
+		goto done;
+	}
+
+	TALLOC_FREE(creds);
+
+	ret = 0;
+done:
+	TALLOC_FREE(mem_ctx);
+	return ret;
+}
diff -Npur samba-4.8.0/source3/utils/smbcontrol.c samba-4.8.1/source3/utils/smbcontrol.c
--- samba-4.8.0/source3/utils/smbcontrol.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/utils/smbcontrol.c	2018-04-26 09:21:03.000000000 +0200
@@ -1258,6 +1258,19 @@ static bool do_winbind_dump_domain_list(
 	return num_replies;
 }
 
+static bool do_msg_disconnect_dc(struct tevent_context *ev_ctx,
+				 struct messaging_context *msg_ctx,
+				 const struct server_id pid,
+				 const int argc, const char **argv)
+{
+	if (argc != 1) {
+		fprintf(stderr, "Usage: smbcontrol <dest> disconnect-dc\n");
+		return False;
+	}
+
+	return send_message(msg_ctx, pid, MSG_WINBIND_DISCONNECT_DC, NULL, 0);
+}
+
 static void winbind_validate_cache_cb(struct messaging_context *msg,
 				      void *private_data,
 				      uint32_t msg_type,
@@ -1436,6 +1449,7 @@ static const struct {
 	{ "validate-cache" , do_winbind_validate_cache,
 	  "Validate winbind's credential cache" },
 	{ "dump-domain-list", do_winbind_dump_domain_list, "Dump winbind domain list"},
+	{ "disconnect-dc", do_msg_disconnect_dc },
 	{ "notify-cleanup", do_notify_cleanup },
 	{ "num-children", do_num_children,
 	  "Print number of smbd child processes" },
diff -Npur samba-4.8.0/source3/utils/wscript_build samba-4.8.1/source3/utils/wscript_build
--- samba-4.8.0/source3/utils/wscript_build	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/utils/wscript_build	2018-04-26 09:21:03.000000000 +0200
@@ -257,3 +257,12 @@ bld.SAMBA3_BINARY('mvxattr',
                  popt_samba3
                  ''',
                  enabled=bld.env.build_mvxattr)
+
+bld.SAMBA3_BINARY('destroy_netlogon_creds_cli',
+                  source='destroy_netlogon_creds_cli.c',
+                  deps = '''
+                      talloc
+                      popt_samba3
+                      NETLOGON_CREDS_CLI
+                  ''',
+                  install=False)
diff -Npur samba-4.8.0/source3/winbindd/winbindd.c samba-4.8.1/source3/winbindd/winbindd.c
--- samba-4.8.0/source3/winbindd/winbindd.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd.c	2018-04-26 09:21:03.000000000 +0200
@@ -1346,6 +1346,10 @@ static void winbindd_register_handlers(s
 			   MSG_DEBUG,
 			   winbind_msg_debug);
 
+	messaging_register(msg_ctx, NULL,
+			   MSG_WINBIND_DISCONNECT_DC,
+			   winbind_disconnect_dc_parent);
+
 	netsamlogon_cache_init(); /* Non-critical */
 
 	/* clear the cached list of trusted domains */
diff -Npur samba-4.8.0/source3/winbindd/winbindd_cm.c samba-4.8.1/source3/winbindd/winbindd_cm.c
--- samba-4.8.0/source3/winbindd/winbindd_cm.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_cm.c	2018-04-26 09:21:03.000000000 +0200
@@ -2078,7 +2078,6 @@ void invalidate_cm_connection(struct win
 	}
 
 	conn->auth_level = DCERPC_AUTH_LEVEL_PRIVACY;
-	conn->netlogon_force_reauth = false;
 	TALLOC_FREE(conn->netlogon_creds_ctx);
 
 	if (conn->cli) {
@@ -3365,6 +3364,7 @@ static NTSTATUS cm_connect_netlogon_tran
 		conn->cli, transport,
 		conn->netlogon_creds_ctx, conn->netlogon_force_reauth, creds,
 		&conn->netlogon_pipe);
+	conn->netlogon_force_reauth = false;
 	if (!NT_STATUS_IS_OK(result)) {
 		DBG_DEBUG("rpccli_connect_netlogon failed: %s\n",
 			  nt_errstr(result));
@@ -3506,3 +3506,19 @@ void winbind_msg_ip_dropped(struct messa
 	}
 	TALLOC_FREE(freeit);
 }
+
+void winbind_msg_disconnect_dc(struct messaging_context *msg_ctx,
+			       void *private_data,
+			       uint32_t msg_type,
+			       struct server_id server_id,
+			       DATA_BLOB *data)
+{
+	struct winbindd_domain *domain;
+
+	for (domain = domain_list(); domain; domain = domain->next) {
+		if (domain->internal) {
+			continue;
+		}
+		invalidate_cm_connection(domain);
+	}
+}
diff -Npur samba-4.8.0/source3/winbindd/winbindd_dual.c samba-4.8.1/source3/winbindd/winbindd_dual.c
--- samba-4.8.0/source3/winbindd/winbindd_dual.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_dual.c	2018-04-26 09:21:03.000000000 +0200
@@ -785,6 +785,23 @@ void winbind_msg_debug(struct messaging_
 			   strlen((char *) data->data) + 1);
 	}
 }
+void winbind_disconnect_dc_parent(struct messaging_context *msg_ctx,
+				  void *private_data,
+				  uint32_t msg_type,
+				  struct server_id server_id,
+				  DATA_BLOB *data)
+{
+	struct winbindd_child *child = NULL;
+
+	DBG_DEBUG("Got disconnect_dc message\n");
+
+	for (child = winbindd_children; child != NULL; child = child->next) {
+		messaging_send_buf(msg_ctx,
+				   pid_to_procid(child->pid),
+				   MSG_WINBIND_DISCONNECT_DC,
+				   NULL, 0);
+	}
+}
 
 /* Set our domains as offline and forward the offline message to our children. */
 
@@ -1667,7 +1684,9 @@ static bool fork_domain_child(struct win
 	messaging_register(server_messaging_context(), NULL,
 			   MSG_WINBIND_IP_DROPPED,
 			   winbind_msg_ip_dropped);
-
+	messaging_register(server_messaging_context(), NULL,
+			   MSG_WINBIND_DISCONNECT_DC,
+			   winbind_msg_disconnect_dc);
 
 	primary_domain = find_our_domain();
 
diff -Npur samba-4.8.0/source3/winbindd/winbindd_dual_srv.c samba-4.8.1/source3/winbindd/winbindd_dual_srv.c
--- samba-4.8.0/source3/winbindd/winbindd_dual_srv.c	2018-02-12 11:27:16.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_dual_srv.c	2018-04-26 09:21:03.000000000 +0200
@@ -41,14 +41,31 @@ void _wbint_Ping(struct pipes_struct *p,
 	*r->out.out_data = r->in.in_data;
 }
 
-static bool reset_cm_connection_on_error(struct winbindd_domain *domain,
-					NTSTATUS status)
-{
-	if (NT_STATUS_EQUAL(status, NT_STATUS_IO_TIMEOUT)) {
+bool reset_cm_connection_on_error(struct winbindd_domain *domain,
+				  struct dcerpc_binding_handle *b,
+				  NTSTATUS status)
+{
+	if (NT_STATUS_EQUAL(status, NT_STATUS_ACCESS_DENIED) ||
+	    NT_STATUS_EQUAL(status, NT_STATUS_RPC_SEC_PKG_ERROR) ||
+	    NT_STATUS_EQUAL(status, NT_STATUS_NETWORK_ACCESS_DENIED)) {
+		invalidate_cm_connection(domain);
+		domain->conn.netlogon_force_reauth = true;
+		return true;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_IO_TIMEOUT) ||
+	    NT_STATUS_EQUAL(status, NT_STATUS_IO_DEVICE_ERROR))
+	{
 		invalidate_cm_connection(domain);
 		/* We invalidated the connection. */
 		return true;
 	}
+
+	if (b != NULL && !dcerpc_binding_handle_is_connected(b)) {
+		invalidate_cm_connection(domain);
+		return true;
+	}
+
 	return false;
 }
 
@@ -66,7 +83,7 @@ NTSTATUS _wbint_LookupSid(struct pipes_s
 
 	status = wb_cache_sid_to_name(domain, p->mem_ctx, r->in.sid,
 				      &dom_name, &name, &type);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		return status;
 	}
@@ -82,6 +99,7 @@ NTSTATUS _wbint_LookupSids(struct pipes_
 	struct winbindd_domain *domain = wb_child_domain();
 	struct lsa_RefDomainList *domains = r->out.domains;
 	NTSTATUS status;
+	bool retry = false;
 
 	if (domain == NULL) {
 		return NT_STATUS_REQUEST_NOT_ACCEPTED;
@@ -93,6 +111,7 @@ NTSTATUS _wbint_LookupSids(struct pipes_
 	 * and winbindd_ad call into lsa_lookupsids anyway. Caching is
 	 * done at the wbint RPC layer.
 	 */
+again:
 	status = rpc_lookup_sids(p->mem_ctx, domain, r->in.sids,
 				 &domains, &r->out.names);
 
@@ -100,7 +119,11 @@ NTSTATUS _wbint_LookupSids(struct pipes_
 		r->out.domains = domains;
 	}
 
-	reset_cm_connection_on_error(domain, status);
+	if (!retry && reset_cm_connection_on_error(domain, NULL, status)) {
+		retry = true;
+		goto again;
+	}
+
 	return status;
 }
 
@@ -116,7 +139,7 @@ NTSTATUS _wbint_LookupName(struct pipes_
 	status = wb_cache_name_to_sid(domain, p->mem_ctx, r->in.domain,
 				      r->in.name, r->in.flags,
 				      r->out.sid, r->out.type);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	return status;
 }
 
@@ -304,7 +327,7 @@ NTSTATUS _wbint_LookupUserAliases(struct
 					     r->in.sids->sids,
 					     &r->out.rids->num_rids,
 					     &r->out.rids->rids);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	return status;
 }
 
@@ -321,7 +344,7 @@ NTSTATUS _wbint_LookupUserGroups(struct
 	status = wb_cache_lookup_usergroups(domain, p->mem_ctx, r->in.sid,
 					    &r->out.sids->num_sids,
 					    &r->out.sids->sids);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	return status;
 }
 
@@ -336,7 +359,7 @@ NTSTATUS _wbint_QuerySequenceNumber(stru
 	}
 
 	status = wb_cache_sequence_number(domain, r->out.sequence);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	return status;
 }
 
@@ -357,7 +380,7 @@ NTSTATUS _wbint_LookupGroupMembers(struc
 	status = wb_cache_lookup_groupmem(domain, p->mem_ctx, r->in.sid,
 					  r->in.type, &num_names, &sid_mem,
 					  &names, &name_types);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		return status;
 	}
@@ -424,7 +447,7 @@ NTSTATUS _wbint_QueryGroupList(struct pi
 		status = wb_cache_enum_local_groups(domain, frame,
 						    &num_local_groups,
 						    &local_groups);
-		reset_cm_connection_on_error(domain, status);
+		reset_cm_connection_on_error(domain, NULL, status);
 		if (!NT_STATUS_IS_OK(status)) {
 			goto out;
 		}
@@ -433,7 +456,7 @@ NTSTATUS _wbint_QueryGroupList(struct pi
 	status = wb_cache_enum_dom_groups(domain, frame,
 					  &num_dom_groups,
 					  &dom_groups);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		goto out;
 	}
@@ -504,7 +527,7 @@ NTSTATUS _wbint_QueryUserRidList(struct
 
 	status = wb_cache_query_user_list(domain, p->mem_ctx,
 					  &r->out.rids->rids);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 
 	if (!NT_STATUS_IS_OK(status)) {
 		return status;
@@ -524,6 +547,8 @@ NTSTATUS _wbint_DsGetDcName(struct pipes
 	WERROR werr;
 	unsigned int orig_timeout;
 	struct dcerpc_binding_handle *b;
+	bool retry = false;
+	bool try_dsrgetdcname = false;
 
 	if (domain == NULL) {
 		return dsgetdcname(p->mem_ctx, server_messaging_context(),
@@ -533,9 +558,14 @@ NTSTATUS _wbint_DsGetDcName(struct pipes
 				   r->out.dc_info);
 	}
 
+	if (domain->active_directory) {
+		try_dsrgetdcname = true;
+	}
+
+reconnect:
 	status = cm_connect_netlogon(domain, &netlogon_pipe);
 
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(10, ("Can't contact the NETLOGON pipe\n"));
 		return status;
@@ -548,7 +578,7 @@ NTSTATUS _wbint_DsGetDcName(struct pipes
 
 	orig_timeout = rpccli_set_timeout(netlogon_pipe, 35000);
 
-	if (domain->active_directory) {
+	if (try_dsrgetdcname) {
 		status = dcerpc_netr_DsRGetDCName(b,
 			p->mem_ctx, domain->dcname,
 			r->in.domain_name, NULL, r->in.domain_guid,
@@ -556,23 +586,14 @@ NTSTATUS _wbint_DsGetDcName(struct pipes
 		if (NT_STATUS_IS_OK(status) && W_ERROR_IS_OK(werr)) {
 			goto done;
 		}
-		if (reset_cm_connection_on_error(domain, status)) {
-			/* Re-initialize. */
-			status = cm_connect_netlogon(domain, &netlogon_pipe);
-
-			reset_cm_connection_on_error(domain, status);
-			if (!NT_STATUS_IS_OK(status)) {
-				DEBUG(10, ("Can't contact the NETLOGON pipe\n"));
-				return status;
-			}
-
-			b = netlogon_pipe->binding_handle;
-
-			/* This call can take a long time - allow the server to time out.
-			   35 seconds should do it. */
-
-			orig_timeout = rpccli_set_timeout(netlogon_pipe, 35000);
+		if (!retry &&
+		    reset_cm_connection_on_error(domain, NULL, status))
+		{
+			retry = true;
+			goto reconnect;
 		}
+		try_dsrgetdcname = false;
+		retry = false;
 	}
 
 	/*
@@ -595,7 +616,10 @@ NTSTATUS _wbint_DsGetDcName(struct pipes
 			r->in.domain_name, &dc_info->dc_unc, &werr);
 	}
 
-	reset_cm_connection_on_error(domain, status);
+	if (!retry && reset_cm_connection_on_error(domain, b, status)) {
+		retry = true;
+		goto reconnect;
+	}
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(10, ("dcerpc_netr_Get[Any]DCName failed: %s\n",
 			   nt_errstr(status)));
@@ -635,7 +659,7 @@ NTSTATUS _wbint_LookupRids(struct pipes_
 	status = wb_cache_rids_to_names(domain, talloc_tos(), r->in.domain_sid,
 					r->in.rids->rids, r->in.rids->num_rids,
 					&domain_name, &names, &types);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		return status;
 	}
@@ -779,7 +803,7 @@ NTSTATUS _wbint_PingDc(struct pipes_stru
 
 reconnect:
 	status = cm_connect_netlogon(domain, &netlogon_pipe);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
         if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(3, ("could not open handle to NETLOGON pipe: %s\n",
 			  nt_errstr(status)));
@@ -805,15 +829,11 @@ reconnect:
 					  logon_server, NETLOGON_CONTROL_QUERY,
 					  2, &info, &werr);
 
-	if (!dcerpc_binding_handle_is_connected(b) && !retry) {
-		DEBUG(10, ("Session might have expired. "
-			   "Reconnect and retry once.\n"));
-		invalidate_cm_connection(domain);
+	if (!retry && reset_cm_connection_on_error(domain, b, status)) {
 		retry = true;
 		goto reconnect;
 	}
 
-	reset_cm_connection_on_error(domain, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(2, ("dcerpc_netr_LogonControl failed: %s\n",
 			nt_errstr(status)));
@@ -838,12 +858,15 @@ NTSTATUS _winbind_DsrUpdateReadOnlyServe
 	NTSTATUS status;
 	struct rpc_pipe_client *netlogon_pipe = NULL;
 	struct netlogon_creds_cli_context *netlogon_creds_ctx = NULL;
+	struct dcerpc_binding_handle *b = NULL;
+	bool retry = false;
 
 	domain = wb_child_domain();
 	if (domain == NULL) {
 		return NT_STATUS_REQUEST_NOT_ACCEPTED;
 	}
 
+reconnect:
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
@@ -852,12 +875,19 @@ NTSTATUS _winbind_DsrUpdateReadOnlyServe
 		goto done;
 	}
 
+	b = netlogon_pipe->binding_handle;
+
 	status = netlogon_creds_cli_DsrUpdateReadOnlyServerDnsRecords(netlogon_creds_ctx,
 								      netlogon_pipe->binding_handle,
 								      r->in.site_name,
 								      r->in.dns_ttl,
 								      r->in.dns_names);
 
+	if (!retry && reset_cm_connection_on_error(domain, b, status)) {
+		retry = true;
+		goto reconnect;
+	}
+
 	/* Pass back result code - zero for success, other values for
 	   specific failures. */
 
@@ -1026,7 +1056,7 @@ static WERROR _winbind_LogonControl_REDI
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (NT_STATUS_EQUAL(status, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {
 		status = NT_STATUS_NO_LOGON_SERVERS;
 	}
@@ -1098,7 +1128,7 @@ static WERROR _winbind_LogonControl_TC_Q
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (NT_STATUS_EQUAL(status, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {
 		status = NT_STATUS_NO_LOGON_SERVERS;
 	}
@@ -1280,7 +1310,7 @@ reconnect:
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (NT_STATUS_EQUAL(status, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {
 		status = NT_STATUS_NO_LOGON_SERVERS;
 	}
@@ -1310,8 +1340,9 @@ reconnect:
 			status = NT_STATUS_OK;
 		}
 		if (!NT_STATUS_IS_OK(status)) {
-			if (!retry && dcerpc_binding_handle_is_connected(b)) {
-				invalidate_cm_connection(domain);
+			if (!retry &&
+			    reset_cm_connection_on_error(domain, b, status))
+			{
 				retry = true;
 				goto reconnect;
 			}
@@ -1376,8 +1407,7 @@ reconnect:
 		goto verify_return;
 	}
 	if (!NT_STATUS_IS_OK(status)) {
-		if (!retry && dcerpc_binding_handle_is_connected(b)) {
-			invalidate_cm_connection(domain);
+		if (!retry && reset_cm_connection_on_error(domain, b, status)) {
 			retry = true;
 			goto reconnect;
 		}
@@ -1503,7 +1533,7 @@ reconnect:
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (NT_STATUS_EQUAL(status, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {
 		status = NT_STATUS_NO_LOGON_SERVERS;
 	}
@@ -1530,8 +1560,7 @@ reconnect:
 				 domain->dcname,
 				 true); /* force */
 	if (!NT_STATUS_IS_OK(status)) {
-		if (!retry && dcerpc_binding_handle_is_connected(b)) {
-			invalidate_cm_connection(domain);
+		if (!retry && reset_cm_connection_on_error(domain, b, status)) {
 			retry = true;
 			goto reconnect;
 		}
@@ -1711,7 +1740,7 @@ reconnect:
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
-	reset_cm_connection_on_error(domain, status);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (NT_STATUS_EQUAL(status, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {
 		status = NT_STATUS_NO_LOGON_SERVERS;
 	}
@@ -1727,8 +1756,7 @@ reconnect:
 							      b, p->mem_ctx,
 							      &new_fti);
 	if (!NT_STATUS_IS_OK(status)) {
-		if (!retry && dcerpc_binding_handle_is_connected(b)) {
-			invalidate_cm_connection(domain);
+		if (!retry && reset_cm_connection_on_error(domain, b, status)) {
 			retry = true;
 			goto reconnect;
 		}
@@ -1823,6 +1851,8 @@ NTSTATUS _winbind_SendToSam(struct pipes
 	NTSTATUS status;
 	struct rpc_pipe_client *netlogon_pipe;
 	struct netlogon_creds_cli_context *netlogon_creds_ctx = NULL;
+	struct dcerpc_binding_handle *b = NULL;
+	bool retry = false;
 
 	DEBUG(5, ("_winbind_SendToSam received\n"));
 	domain = wb_child_domain();
@@ -1830,17 +1860,25 @@ NTSTATUS _winbind_SendToSam(struct pipes
 		return NT_STATUS_REQUEST_NOT_ACCEPTED;
 	}
 
+reconnect:
 	status = cm_connect_netlogon_secure(domain,
 					    &netlogon_pipe,
 					    &netlogon_creds_ctx);
+	reset_cm_connection_on_error(domain, NULL, status);
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(3, ("could not open handle to NETLOGON pipe\n"));
 		return status;
 	}
 
+	b = netlogon_pipe->binding_handle;
+
 	status = netlogon_creds_cli_SendToSam(netlogon_creds_ctx,
-					      netlogon_pipe->binding_handle,
+					      b,
 					      &r->in.message);
+	if (!retry && reset_cm_connection_on_error(domain, b, status)) {
+		retry = true;
+		goto reconnect;
+	}
 
 	return status;
 }
diff -Npur samba-4.8.0/source3/winbindd/winbindd_lookupname.c samba-4.8.1/source3/winbindd/winbindd_lookupname.c
--- samba-4.8.0/source3/winbindd/winbindd_lookupname.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_lookupname.c	2018-04-26 09:21:03.000000000 +0200
@@ -35,7 +35,8 @@ struct tevent_req *winbindd_lookupname_s
 {
 	struct tevent_req *req, *subreq;
 	struct winbindd_lookupname_state *state;
-	char *domname, *name, *p;
+	const char *domname = NULL, *name = NULL;
+	char *p = NULL;
 
 	req = tevent_req_create(mem_ctx, &state,
 				struct winbindd_lookupname_state);
@@ -49,17 +50,25 @@ struct tevent_req *winbindd_lookupname_s
 		sizeof(request->data.name.dom_name)-1]='\0';
 	request->data.name.name[sizeof(request->data.name.name)-1]='\0';
 
-	/* cope with the name being a fully qualified name */
-	p = strstr(request->data.name.name, lp_winbind_separator());
-	if (p) {
-		*p = 0;
-		domname = request->data.name.name;
-		name = p+1;
-	} else if ((p = strchr(request->data.name.name, '@')) != NULL) {
-		/* upn */
-		domname = p + 1;
-		*p = 0;
-		name = request->data.name.name;
+	if (strlen(request->data.name.dom_name) == 0) {
+		/* cope with the name being a fully qualified name */
+		p = strstr(request->data.name.name, lp_winbind_separator());
+		if (p != NULL) {
+			*p = '\0';
+			domname = request->data.name.name;
+			name = p + 1;
+		} else {
+			p = strchr(request->data.name.name, '@');
+			if (p != NULL) {
+				/* upn */
+				domname = p + 1;
+				*p = '\0';
+				name = request->data.name.name;
+			} else {
+				domname = "";
+				name = request->data.name.name;
+			}
+		}
 	} else {
 		domname = request->data.name.dom_name;
 		name = request->data.name.name;
diff -Npur samba-4.8.0/source3/winbindd/winbindd_proto.h samba-4.8.1/source3/winbindd/winbindd_proto.h
--- samba-4.8.0/source3/winbindd/winbindd_proto.h	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_proto.h	2018-04-26 09:21:03.000000000 +0200
@@ -297,6 +297,11 @@ void winbind_msg_debug(struct messaging_
 			 uint32_t msg_type,
 			 struct server_id server_id,
 			 DATA_BLOB *data);
+void winbind_disconnect_dc_parent(struct messaging_context *msg_ctx,
+				  void *private_data,
+				  uint32_t msg_type,
+				  struct server_id server_id,
+				  DATA_BLOB *data);
 void winbind_msg_offline(struct messaging_context *msg_ctx,
 			 void *private_data,
 			 uint32_t msg_type,
@@ -327,6 +332,11 @@ void winbind_msg_ip_dropped(struct messa
 			    uint32_t msg_type,
 			    struct server_id server_id,
 			    DATA_BLOB *data);
+void winbind_msg_disconnect_dc(struct messaging_context *msg_ctx,
+			       void *private_data,
+			       uint32_t msg_type,
+			       struct server_id server_id,
+			       DATA_BLOB *data);
 void winbind_msg_ip_dropped_parent(struct messaging_context *msg_ctx,
 				   void *private_data,
 				   uint32_t msg_type,
@@ -952,4 +962,9 @@ bool reconnect_need_retry(NTSTATUS statu
 /* The following definitions come from winbindd/winbindd_gpupdate.c  */
 void gpupdate_init(void);
 
+/* The following comes from winbindd/winbindd_dual_srv.c */
+bool reset_cm_connection_on_error(struct winbindd_domain *domain,
+				  struct dcerpc_binding_handle *b,
+				  NTSTATUS status);
+
 #endif /*  _WINBINDD_PROTO_H_  */
diff -Npur samba-4.8.0/source3/winbindd/winbindd_reconnect.c samba-4.8.1/source3/winbindd/winbindd_reconnect.c
--- samba-4.8.0/source3/winbindd/winbindd_reconnect.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_reconnect.c	2018-04-26 09:21:03.000000000 +0200
@@ -69,13 +69,7 @@ bool reconnect_need_retry(NTSTATUS statu
 		return false;
 	}
 
-	if (NT_STATUS_EQUAL(status, NT_STATUS_IO_DEVICE_ERROR)) {
-		/*
-		 * RPC call sent on expired session, needs
-		 * reauthentication.
-		 */
-		invalidate_cm_connection(domain);
-	}
+	reset_cm_connection_on_error(domain, NULL, status);
 
 	return true;
 }
diff -Npur samba-4.8.0/source3/winbindd/winbindd_reconnect_ads.c samba-4.8.1/source3/winbindd/winbindd_reconnect_ads.c
--- samba-4.8.0/source3/winbindd/winbindd_reconnect_ads.c	2018-01-14 21:41:58.000000000 +0100
+++ samba-4.8.1/source3/winbindd/winbindd_reconnect_ads.c	2018-04-26 09:21:03.000000000 +0200
@@ -31,6 +31,52 @@
 
 extern struct winbindd_methods ads_methods;
 
+static bool ldap_reconnect_need_retry(NTSTATUS status,
+				      struct winbindd_domain *domain)
+{
+	if (NT_STATUS_IS_OK(status)) {
+		return false;
+	}
+
+	if (!NT_STATUS_IS_ERR(status)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NONE_MAPPED)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_USER)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_GROUP)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_ALIAS)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_MEMBER)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_DOMAIN)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_SUCH_PRIVILEGE)) {
+		return false;
+	}
+
+	if (NT_STATUS_EQUAL(status, NT_STATUS_NO_MEMORY)) {
+		return false;
+	}
+
+	return true;
+}
+
 /* List all users */
 static NTSTATUS query_user_list(struct winbindd_domain *domain,
 				TALLOC_CTX *mem_ctx,
@@ -40,7 +86,7 @@ static NTSTATUS query_user_list(struct w
 
 	result = ads_methods.query_user_list(domain, mem_ctx, rids);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.query_user_list(domain, mem_ctx, rids);
 	}
 
@@ -58,7 +104,7 @@ static NTSTATUS enum_dom_groups(struct w
 	result = ads_methods.enum_dom_groups(domain, mem_ctx,
 					     num_entries, info);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.enum_dom_groups(domain, mem_ctx,
 						     num_entries, info);
 	}
@@ -77,7 +123,7 @@ static NTSTATUS enum_local_groups(struct
 	result = ads_methods.enum_local_groups(domain, mem_ctx,
 					       num_entries, info);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.enum_local_groups(domain, mem_ctx,
 						       num_entries, info);
 	}
@@ -165,7 +211,7 @@ static NTSTATUS lookup_usergroups(struct
 	result = ads_methods.lookup_usergroups(domain, mem_ctx, user_sid,
 					       num_groups, user_gids);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.lookup_usergroups(domain, mem_ctx,
 						       user_sid, num_groups,
 						       user_gids);
@@ -210,7 +256,7 @@ static NTSTATUS lookup_groupmem(struct w
 					     num_names, sid_mem, names,
 					     name_types);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.lookup_groupmem(domain, mem_ctx, group_sid,
 						     type, num_names, sid_mem,
 						     names, name_types);
@@ -226,7 +272,7 @@ static NTSTATUS sequence_number(struct w
 
 	result = ads_methods.sequence_number(domain, seq);
 
-	if (reconnect_need_retry(result, domain)) {
+	if (ldap_reconnect_need_retry(result, domain)) {
 		result = ads_methods.sequence_number(domain, seq);
 	}
 
diff -Npur samba-4.8.0/source4/dsdb/samdb/ldb_modules/encrypted_secrets.c samba-4.8.1/source4/dsdb/samdb/ldb_modules/encrypted_secrets.c
--- samba-4.8.0/source4/dsdb/samdb/ldb_modules/encrypted_secrets.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source4/dsdb/samdb/ldb_modules/encrypted_secrets.c	2018-04-26 09:21:03.000000000 +0200
@@ -750,16 +750,16 @@ static struct ldb_val gnutls_encrypt_aea
 	 * Encrypt the value.
 	 */
 	{
-		size_t el;
-		const unsigned block_size = gnutls_cipher_get_tag_size(
+		const unsigned block_size = gnutls_cipher_get_block_size(
 			data->encryption_algorithm);
-		const unsigned tag_size = gnutls_cipher_get_block_size(
+		const unsigned tag_size = gnutls_cipher_get_tag_size(
 			data->encryption_algorithm);
 		const size_t ed_size = round_to_block_size(
 			block_size,
 			sizeof(struct PlaintextSecret) + val.length);
 		const size_t en_size = ed_size + tag_size;
 		uint8_t *ct = talloc_zero_size(frame, en_size);
+		size_t el = en_size;
 
 		if (ct == NULL) {
 			ldb_set_errstring(ldb,
diff -Npur samba-4.8.0/source4/dsdb/samdb/ldb_modules/samldb.c samba-4.8.1/source4/dsdb/samdb/ldb_modules/samldb.c
--- samba-4.8.0/source4/dsdb/samdb/ldb_modules/samldb.c	2018-03-01 21:18:10.000000000 +0100
+++ samba-4.8.1/source4/dsdb/samdb/ldb_modules/samldb.c	2018-04-26 09:21:03.000000000 +0200
@@ -875,6 +875,7 @@ static int samldb_add_handle_msDS_IntId(
 		 * order to be sure.
 		 */
 		if (dsdb_attribute_by_attributeID_id(schema, msds_intid)) {
+			id_exists = true;
 			msds_intid = generate_random() % 0X3FFFFFFF;
 			msds_intid += 0x80000000;
 			continue;
diff -Npur samba-4.8.0/source4/torture/basic/delete.c samba-4.8.1/source4/torture/basic/delete.c
--- samba-4.8.0/source4/torture/basic/delete.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source4/torture/basic/delete.c	2018-04-26 09:21:03.000000000 +0200
@@ -476,24 +476,127 @@ static bool deltest8(struct torture_cont
 static bool deltest9(struct torture_context *tctx, struct smbcli_state *cli1, struct smbcli_state *cli2)
 {
 	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_SUPERSEDE,
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_CREATE,
+			NTCREATEX_DISP_OPEN_IF};
+	unsigned int i;
 
 	del_clean_area(cli1, cli2);
 
-	/* This should fail - we need to set DELETE_ACCESS. */
-	fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
-				      SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
-				      FILE_ATTRIBUTE_NORMAL, 
-				      NTCREATEX_SHARE_ACCESS_NONE, 
-				      NTCREATEX_DISP_OVERWRITE_IF, 
-				      NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
-	
-	torture_assert(tctx, fnum1 == -1, 
-				   talloc_asprintf(tctx, "open of %s succeeded should have failed!", 
-		       fname));
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		/* This should fail - we need to set DELETE_ACCESS. */
+
+		/*
+		 * A file or directory create with DELETE_ON_CLOSE but
+		 * without DELETE_ACCESS should fail with
+		 * NT_STATUS_INVALID_PARAMETER.
+		 */
+
+		fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
+				SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
+				FILE_ATTRIBUTE_NORMAL,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			fname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+
+		/* This should fail - the file should not have been created. */
+		status = smbcli_getatr(cli1->tree, fname, NULL, NULL, NULL);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_OBJECT_NAME_NOT_FOUND,
+			talloc_asprintf(tctx, "getattr of %s succeeded should "
+				"not have been created !",
+			fname));
+	}
 
 	return true;
 }
 
+/* Test 9a ... */
+static bool deltest9a(struct torture_context *tctx,
+			struct smbcli_state *cli1,
+			struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_OPEN,
+			NTCREATEX_DISP_OVERWRITE,
+			NTCREATEX_DISP_OPEN_IF};
+
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	/* Create the file, and try with open calls. */
+	fnum1 = smbcli_open(cli1->tree, fname, O_CREAT|O_RDWR, DENY_NONE);
+	torture_assert(tctx,
+			fnum1 != -1,
+			talloc_asprintf(tctx, "open of %s failed (%s)",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	status = smbcli_close(cli1->tree, fnum1);
+	torture_assert_ntstatus_ok(tctx,
+				status,
+				talloc_asprintf(tctx, "close failed"));
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		fnum1 = smbcli_nt_create_full(cli1->tree, fname, 0,
+				SEC_FILE_READ_DATA|SEC_FILE_WRITE_DATA,
+				FILE_ATTRIBUTE_NORMAL,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			fname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should succeed - the file should not have been deleted.
+		 */
+		status = smbcli_getatr(cli1->tree, fname, NULL, NULL, NULL);
+		torture_assert_ntstatus_ok(tctx,
+			status,
+			talloc_asprintf(tctx, "getattr of %s failed %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	}
+
+	del_clean_area(cli1, cli2);
+	return true;
+}
+
 /* Test 10 ... */
 static bool deltest10(struct torture_context *tctx, struct smbcli_state *cli1, struct smbcli_state *cli2)
 {
@@ -2256,6 +2359,135 @@ static bool deltest24(struct torture_con
 	return correct;
 }
 
+/* Test 25 ... */
+static bool deltest25(struct torture_context *tctx,
+			struct smbcli_state *cli1,
+			struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_SUPERSEDE,
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_CREATE,
+			NTCREATEX_DISP_OPEN_IF};
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		/* This should fail - we need to set DELETE_ACCESS. */
+
+		/*
+		 * A file or directory create with DELETE_ON_CLOSE but
+		 * without DELETE_ACCESS should fail with
+		 * NT_STATUS_INVALID_PARAMETER.
+		 */
+
+		fnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				SEC_FILE_READ_DATA,
+				FILE_ATTRIBUTE_DIRECTORY,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DIRECTORY|
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			dname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			dname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should fail - the directory
+		 * should not have been created.
+		 */
+		status = smbcli_getatr(cli1->tree, dname, NULL, NULL, NULL);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_OBJECT_NAME_NOT_FOUND,
+			talloc_asprintf(tctx, "getattr of %s succeeded should "
+				"not have been created !",
+			dname));
+	}
+
+	return true;
+}
+
+/* Test 25a... */
+static bool deltest25a(struct torture_context *tctx,
+		struct smbcli_state *cli1,
+		struct smbcli_state *cli2)
+{
+	int fnum1 = -1;
+	NTSTATUS status;
+	uint32_t disps[4] = {
+			NTCREATEX_DISP_OVERWRITE_IF,
+			NTCREATEX_DISP_OPEN,
+			NTCREATEX_DISP_OVERWRITE,
+			NTCREATEX_DISP_OPEN_IF};
+
+	unsigned int i;
+
+	del_clean_area(cli1, cli2);
+
+	/* Create the directory, and try with open calls. */
+	status = smbcli_mkdir(cli1->tree, dname);
+	torture_assert_ntstatus_ok(tctx,
+		status,
+		talloc_asprintf(tctx, "mkdir of %s failed %s",
+		dname,
+		smbcli_errstr(cli1->tree)));
+
+	for (i = 0; i < sizeof(disps)/sizeof(disps[0]); i++) {
+		fnum1 = smbcli_nt_create_full(cli1->tree, dname, 0,
+				SEC_FILE_READ_DATA,
+				FILE_ATTRIBUTE_DIRECTORY,
+				NTCREATEX_SHARE_ACCESS_NONE,
+				disps[i],
+				NTCREATEX_OPTIONS_DIRECTORY|
+				NTCREATEX_OPTIONS_DELETE_ON_CLOSE, 0);
+
+		torture_assert(tctx, fnum1 == -1,
+			talloc_asprintf(tctx, "open of %s succeeded "
+				"should have failed!",
+			dname));
+
+		/* Must fail with NT_STATUS_INVALID_PARAMETER. */
+		status = smbcli_nt_error(cli1->tree);
+		torture_assert_ntstatus_equal(tctx,
+			status,
+			NT_STATUS_INVALID_PARAMETER,
+			talloc_asprintf(tctx, "create of %s should return "
+				"NT_STATUS_INVALID_PARAMETER, got %s",
+			dname,
+			smbcli_errstr(cli1->tree)));
+
+		/*
+		 * This should succeed - the directory
+		 * should not have been deleted.
+		 */
+		status = smbcli_getatr(cli1->tree, dname, NULL, NULL, NULL);
+		torture_assert_ntstatus_ok(tctx,
+			status,
+			talloc_asprintf(tctx, "getattr of %s failed %s",
+			fname,
+			smbcli_errstr(cli1->tree)));
+	}
+
+	del_clean_area(cli1, cli2);
+	return true;
+}
+
 /*
   Test delete on close semantics.
  */
@@ -2273,6 +2505,7 @@ struct torture_suite *torture_test_delet
 	torture_suite_add_2smb_test(suite, "deltest7", deltest7);
 	torture_suite_add_2smb_test(suite, "deltest8", deltest8);
 	torture_suite_add_2smb_test(suite, "deltest9", deltest9);
+	torture_suite_add_2smb_test(suite, "deltest9a", deltest9a);
 	torture_suite_add_2smb_test(suite, "deltest10", deltest10);
 	torture_suite_add_2smb_test(suite, "deltest11", deltest11);
 	torture_suite_add_2smb_test(suite, "deltest12", deltest12);
@@ -2297,6 +2530,8 @@ struct torture_suite *torture_test_delet
 	torture_suite_add_simple_test(suite, "deltest22", deltest22);
 	torture_suite_add_2smb_test(suite, "deltest23", deltest23);
 	torture_suite_add_simple_test(suite, "deltest24", deltest24);
+	torture_suite_add_2smb_test(suite, "deltest25", deltest25);
+	torture_suite_add_2smb_test(suite, "deltest25a", deltest25a);
 
 	return suite;
 }
diff -Npur samba-4.8.0/source4/torture/smb2/compound.c samba-4.8.1/source4/torture/smb2/compound.c
--- samba-4.8.0/source4/torture/smb2/compound.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source4/torture/smb2/compound.c	2018-04-26 09:21:03.000000000 +0200
@@ -1030,6 +1030,81 @@ done:
 	return ret;
 }
 
+static bool test_compound_invalid4(struct torture_context *tctx,
+				   struct smb2_tree *tree)
+{
+	struct smb2_create cr;
+	struct smb2_read rd;
+	NTSTATUS status;
+	const char *fname = "compound_invalid4.dat";
+	struct smb2_close cl;
+	bool ret = true;
+	bool ok;
+	struct smb2_request *req[2];
+
+	smb2_transport_credits_ask_num(tree->session->transport, 2);
+
+	smb2_util_unlink(tree, fname);
+
+	ZERO_STRUCT(cr);
+	cr.in.security_flags	  = 0x00;
+	cr.in.oplock_level	  = 0;
+	cr.in.impersonation_level = NTCREATEX_IMPERSONATION_IMPERSONATION;
+	cr.in.create_flags	  = 0x00000000;
+	cr.in.reserved		  = 0x00000000;
+	cr.in.desired_access	  = SEC_RIGHTS_FILE_ALL;
+	cr.in.file_attributes	  = FILE_ATTRIBUTE_NORMAL;
+	cr.in.share_access	  = NTCREATEX_SHARE_ACCESS_READ |
+				    NTCREATEX_SHARE_ACCESS_WRITE |
+				    NTCREATEX_SHARE_ACCESS_DELETE;
+	cr.in.create_disposition  = NTCREATEX_DISP_OPEN_IF;
+	cr.in.create_options	  = NTCREATEX_OPTIONS_SEQUENTIAL_ONLY |
+				    NTCREATEX_OPTIONS_ASYNC_ALERT	|
+				    NTCREATEX_OPTIONS_NON_DIRECTORY_FILE |
+				    0x00200000;
+	cr.in.fname		  = fname;
+
+	status = smb2_create(tree, tctx, &cr);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	smb2_transport_compound_start(tree->session->transport, 2);
+
+	ZERO_STRUCT(rd);
+	rd.in.file.handle = cr.out.file.handle;
+	rd.in.length      = 1;
+	rd.in.offset      = 0;
+	req[0] = smb2_read_send(tree, &rd);
+
+	smb2_transport_compound_set_related(tree->session->transport, true);
+
+	/*
+	 * Send a completely bogus request as second compound
+	 * element. This triggers smbd_smb2_request_error() in in
+	 * smbd_smb2_request_dispatch() before calling
+	 * smbd_smb2_request_dispatch_update_counts().
+	 */
+
+	req[1] = smb2_request_init_tree(tree, 0xff, 0x04, false, 0);
+	smb2_transport_send(req[1]);
+
+	status = smb2_read_recv(req[0], tctx, &rd);
+	CHECK_STATUS(status, NT_STATUS_END_OF_FILE);
+
+	ok = smb2_request_receive(req[1]);
+	torture_assert(tctx, ok, "Invalid request failed\n");
+	CHECK_STATUS(req[1]->status, NT_STATUS_INVALID_PARAMETER);
+
+	ZERO_STRUCT(cl);
+	cl.in.file.handle = cr.out.file.handle;
+
+	status = smb2_close(tree, &cl);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	smb2_util_unlink(tree, fname);
+done:
+	return ret;
+}
+
 /* Send a compound request where we expect the last request (Create, Notify)
  * to go asynchronous. This works against a Win7 server and the reply is
  * sent in two different packets. */
@@ -1297,6 +1372,8 @@ struct torture_suite *torture_smb2_compo
 	torture_suite_add_1smb2_test(suite, "invalid1", test_compound_invalid1);
 	torture_suite_add_1smb2_test(suite, "invalid2", test_compound_invalid2);
 	torture_suite_add_1smb2_test(suite, "invalid3", test_compound_invalid3);
+	torture_suite_add_1smb2_test(
+		suite, "invalid4", test_compound_invalid4);
 	torture_suite_add_1smb2_test(suite, "interim1",  test_compound_interim1);
 	torture_suite_add_1smb2_test(suite, "interim2",  test_compound_interim2);
 	torture_suite_add_1smb2_test(suite, "compound-break", test_compound_break);
diff -Npur samba-4.8.0/source4/torture/vfs/fruit.c samba-4.8.1/source4/torture/vfs/fruit.c
--- samba-4.8.0/source4/torture/vfs/fruit.c	2018-01-17 09:08:39.000000000 +0100
+++ samba-4.8.1/source4/torture/vfs/fruit.c	2018-04-26 09:21:03.000000000 +0200
@@ -36,6 +36,10 @@
 #include "torture/smb2/proto.h"
 #include "torture/vfs/proto.h"
 #include "librpc/gen_ndr/ndr_ioctl.h"
+#include "libcli/security/dom_sid.h"
+#include "../librpc/gen_ndr/ndr_security.h"
+#include "libcli/security/secace.h"
+#include "libcli/security/security_descriptor.h"
 
 #define BASEDIR "vfs_fruit_dir"
 #define FNAME_CC_SRC "testfsctl.dat"
@@ -4426,6 +4430,172 @@ done:
 }
 
 /*
+ * Ensure this security descriptor has exactly one mode, uid
+ * and gid.
+ */
+
+static NTSTATUS check_nfs_sd(const struct security_descriptor *psd)
+{
+	uint32_t i;
+	bool got_one_mode = false;
+	bool got_one_uid = false;
+	bool got_one_gid = false;
+
+	if (psd->dacl == NULL) {
+		return NT_STATUS_INVALID_SECURITY_DESCR;
+	}
+
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Mode,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_mode == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_mode = true;
+		}
+	}
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Users,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_uid == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_uid = true;
+		}
+	}
+	for (i = 0; i < psd->dacl->num_aces; i++) {
+		if (dom_sid_compare_domain(&global_sid_Unix_NFS_Groups,
+					   &psd->dacl->aces[i].trustee) == 0) {
+			if (got_one_gid == true) {
+				/* Can't have more than one. */
+				return NT_STATUS_INVALID_SECURITY_DESCR;
+			}
+			got_one_gid = true;
+		}
+	}
+	/* Must have at least one of each. */
+	if (got_one_mode == false ||
+			got_one_uid == false ||
+			got_one_gid == false) {
+		return NT_STATUS_INVALID_SECURITY_DESCR;
+	}
+	return NT_STATUS_OK;
+}
+
+static bool test_nfs_aces(struct torture_context *tctx,
+			  struct smb2_tree *tree)
+{
+	TALLOC_CTX *mem_ctx = talloc_new(tctx);
+	struct security_ace ace;
+	struct dom_sid sid;
+	const char *fname = BASEDIR "\\nfs_aces.txt";
+	struct smb2_handle h = {{0}};
+	union smb_fileinfo finfo2;
+	union smb_setfileinfo set;
+	struct security_descriptor *psd = NULL;
+	NTSTATUS status;
+	bool ret = true;
+
+	ret = enable_aapl(tctx, tree);
+	torture_assert(tctx, ret == true, "enable_aapl failed");
+
+	/* clean slate ...*/
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+
+	status = torture_smb2_testdir(tree, BASEDIR, &h);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	smb2_util_close(tree, h);
+
+	/* Create a test file. */
+	status = torture_smb2_testfile_access(tree,
+				fname,
+				&h,
+				SEC_STD_READ_CONTROL |
+				SEC_STD_WRITE_DAC |
+				SEC_RIGHTS_FILE_ALL);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Get the ACL. */
+	finfo2.query_secdesc.in.secinfo_flags =
+		SECINFO_OWNER |
+		SECINFO_GROUP |
+		SECINFO_DACL;
+	finfo2.generic.level = RAW_FILEINFO_SEC_DESC;
+	finfo2.generic.in.file.handle = h;
+	status = smb2_getinfo_file(tree, tctx, &finfo2);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	psd = finfo2.query_secdesc.out.sd;
+
+	/* Ensure we have only single mode/uid/gid NFS entries. */
+	status = check_nfs_sd(psd);
+	if (!NT_STATUS_IS_OK(status)) {
+		NDR_PRINT_DEBUG(
+			security_descriptor,
+			discard_const_p(struct security_descriptor, psd));
+	}
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Add a couple of extra NFS uids and gids. */
+	sid_compose(&sid, &global_sid_Unix_NFS_Users, 27);
+	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	sid_compose(&sid, &global_sid_Unix_NFS_Groups, 300);
+	init_sec_ace(&ace, &sid, SEC_ACE_TYPE_ACCESS_DENIED, 0, 0);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+	status = security_descriptor_dacl_add(psd, &ace);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Now set on the file handle. */
+	set.set_secdesc.level = RAW_SFILEINFO_SEC_DESC;
+	set.set_secdesc.in.file.handle = h;
+	set.set_secdesc.in.secinfo_flags = SECINFO_DACL;
+	set.set_secdesc.in.sd = psd;
+	status = smb2_setinfo_file(tree, &set);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	/* Get the ACL again. */
+	finfo2.query_secdesc.in.secinfo_flags =
+		SECINFO_OWNER |
+		SECINFO_GROUP |
+		SECINFO_DACL;
+	finfo2.generic.level = RAW_FILEINFO_SEC_DESC;
+	finfo2.generic.in.file.handle = h;
+	status = smb2_getinfo_file(tree, tctx, &finfo2);
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+	psd = finfo2.query_secdesc.out.sd;
+
+	/* Ensure we have only single mode/uid/gid NFS entries. */
+	status = check_nfs_sd(psd);
+	if (!NT_STATUS_IS_OK(status)) {
+		NDR_PRINT_DEBUG(
+			security_descriptor,
+			discard_const_p(struct security_descriptor, psd));
+	}
+	CHECK_STATUS(status, NT_STATUS_OK);
+
+done:
+	if (!smb2_util_handle_empty(h)) {
+		smb2_util_close(tree, h);
+	}
+	smb2_util_unlink(tree, fname);
+	smb2_deltree(tree, fname);
+	smb2_deltree(tree, BASEDIR);
+	talloc_free(mem_ctx);
+	return ret;
+}
+
+/*
  * Note: This test depends on "vfs objects = catia fruit streams_xattr".  For
  * some tests torture must be run on the host it tests and takes an additional
  * argument with the local path to the share:
@@ -4465,6 +4635,7 @@ struct torture_suite *torture_vfs_fruit(
 	torture_suite_add_1smb2_test(suite, "creating rsrc with read-only access", test_rfork_create_ro);
 	torture_suite_add_1smb2_test(suite, "copy-chunk streams", test_copy_chunk_streams);
 	torture_suite_add_1smb2_test(suite, "OS X AppleDouble file conversion", test_adouble_conversion);
+	torture_suite_add_1smb2_test(suite, "NFS ACE entries", test_nfs_aces);
 
 	return suite;
 }
