Index: Linux-PAM/Make.Rules.in
===================================================================
RCS file: /afs/sipb/project/debian/cvs/pam/Linux-PAM/Make.Rules.in,v
retrieving revision 1.3
diff -u -r1.3 Make.Rules.in
--- Linux-PAM/Make.Rules.in	15 Sep 2002 20:17:56 -0000	1.3
+++ Linux-PAM/Make.Rules.in	22 Sep 2002 19:35:35 -0000
@@ -106,5 +106,5 @@
 RANLIB=@RANLIB@
 STRIP=@STRIP@
 CC_STATIC=@CC_STATIC@
-
-LINKLIBS = $(NEED_LINK_LIB_C) $(LIBDL)
+LIBS=@LIBS@
+LINKLIBS = $(NEED_LINK_LIB_C) $(LIBDL) 
Index: Linux-PAM/_pam_aconf.h.in
===================================================================
RCS file: /afs/sipb/project/debian/cvs/pam/Linux-PAM/_pam_aconf.h.in,v
retrieving revision 1.2
diff -u -r1.2 _pam_aconf.h.in
--- Linux-PAM/_pam_aconf.h.in	21 Sep 2002 18:11:03 -0000	1.2
+++ Linux-PAM/_pam_aconf.h.in	22 Sep 2002 19:35:35 -0000
@@ -74,12 +74,15 @@
 /* read both confs - read /etc/pam.d and /etc/pam.conf in serial */
 #undef PAM_READ_BOTH_CONFS
 
+#undef HAVE_SYS_CAPABILITY_H
+
 #undef HAVE_PATHS_H
 #ifdef HAVE_PATHS_H
 #include <paths.h>
 #endif
 /* location of the mail spool directory */
 #undef PAM_PATH_MAILDIR
+
 
 /* where should we include setfsuid's prototype from? If this is not
    defined, we get it from unistd.h */
Index: Linux-PAM/configure.in
===================================================================
RCS file: /afs/sipb/project/debian/cvs/pam/Linux-PAM/configure.in,v
retrieving revision 1.13
diff -u -r1.13 configure.in
--- Linux-PAM/configure.in	21 Sep 2002 18:38:49 -0000	1.13
+++ Linux-PAM/configure.in	22 Sep 2002 19:46:38 -0000
@@ -235,7 +235,7 @@
 AC_HEADER_DIRENT
 AC_HEADER_STDC
 AC_HEADER_SYS_WAIT
-AC_CHECK_HEADERS(fcntl.h limits.h malloc.h sys/file.h sys/ioctl.h sys/time.h syslog.h net/if.h termios.h unistd.h sys/fsuid.h)
+AC_CHECK_HEADERS(fcntl.h limits.h malloc.h sys/file.h sys/ioctl.h sys/time.h syslog.h net/if.h termios.h unistd.h sys/fsuid.h sys/capability.h )
 
 dnl Linux wants features.h in some of the source files.
 AC_CHECK_HEADERS(features.h)
@@ -401,6 +401,7 @@
 AC_FUNC_MEMCMP
 AC_FUNC_VPRINTF
 AC_CHECK_FUNCS(gethostname gettimeofday mkdir select strcspn strdup strerror strspn strstr strtol uname)
+AC_CHECK_LIB(cap, cap_init)
 
 AC_CHECK_FUNCS(getpwnam_r getgrnam_r)
 
Index: Linux-PAM/modules/pam_limits/pam_limits.c
===================================================================
RCS file: /afs/sipb/project/debian/cvs/pam/Linux-PAM/modules/pam_limits/pam_limits.c,v
retrieving revision 1.10
diff -u -r1.10 pam_limits.c
--- Linux-PAM/modules/pam_limits/pam_limits.c	22 Sep 2002 00:04:48 -0000	1.10
+++ Linux-PAM/modules/pam_limits/pam_limits.c	22 Sep 2002 19:43:07 -0000
@@ -19,6 +19,10 @@
 
 #include <security/_pam_aconf.h>
 
+#ifdef HAVE_SYS_CAPABILITY_H
+#include <sys/capability.h>
+#include <sys/prctl.h>
+#endif /* HAVE_SYS_CAPABILITY_H */
 #include <stdio.h>
 #include <unistd.h>
 #include <string.h>
@@ -72,6 +76,10 @@
 			      specific user or to count all logins */
     int priority;	 /* the priority to run user process with */
   char chroot_dir[8092] ;	/* directory to chroot into */
+#ifdef HAVE_SYS_CAPABILITY_H
+  cap_t capabilities; /*capability handle*/
+  int caps_set;
+#endif /* HAVE_SYS_CAPABILITY_H */
     int supported[RLIM_NLIMITS];
     struct user_limits_struct limits[RLIM_NLIMITS];
     char conf_file[BUFSIZ];
@@ -83,6 +91,7 @@
 
 #define LIMIT_PRI RLIM_NLIMITS+3
 #define LIMIT_CHROOT RLIM_NLIMITS+4
+#define LIMIT_CAPS RLIM_NLIMITS+5
 
 #define LIMIT_SOFT  1
 #define LIMIT_HARD  2
@@ -308,6 +317,10 @@
     pl->login_limit = -2;
     pl->login_limit_def = LIMITS_DEF_NONE;
 
+#ifdef HAVE_SYS_CAPABILITY_H
+    pl->capabilities = cap_init();
+    pl->caps_set = 0;
+#endif /* HAVE_SYS_CAPABILITY_H */
     pl->chroot_dir[0] = '\0';
     
     return retval;
@@ -364,6 +377,10 @@
 	limit_item = LIMIT_PRI;
     } else if (strcmp(lim_item, "chroot") == 0) {
 	limit_item = LIMIT_CHROOT;
+#ifdef HAVE_SYS_CAPABILITY_H
+    } else if (strcmp(lim_item, "capabilities") == 0) {
+	limit_item = LIMIT_CAPS;
+#endif /* HAVE_SYS_CAPABILITY_H */
     } else {
         _pam_log(LOG_DEBUG,"unknown limit item '%s'", lim_item);
         return;
@@ -430,7 +447,9 @@
     if ( (limit_item != LIMIT_LOGIN)
 	 && (limit_item != LIMIT_NUMSYSLOGINS)
 	 && (limit_item != LIMIT_PRI)
-	 && (limit_item != LIMIT_CHROOT)) {
+	 && (limit_item != LIMIT_CHROOT)
+	 && (limit_item != LIMIT_CAPS)
+	 ) {
         if (limit_type & LIMIT_SOFT) {
 	    if (pl->limits[limit_item].src_soft < source) {
                 return;
@@ -454,7 +473,15 @@
 		pl->priority = limit_value;
 	} else if (limit_item == LIMIT_CHROOT) {
 	  strncpy(pl->chroot_dir, value_orig, sizeof(pl->chroot_dir));
-	} else {
+	}
+#ifdef HAVE_SYS_CAPABILITY_H
+	else if (limit_item == LIMIT_CAPS) {
+	  pl->capabilities = cap_from_text(value_orig);
+	  prctl(PR_SET_KEEPCAPS, 1);
+	  pl->caps_set = 1;
+ 	}
+#endif /*HAVE_SYS_CAPABILITY_H*/
+	else {
 	        if (pl->login_limit_def < source) {
 	            return;
 	        } else {
@@ -631,6 +658,12 @@
 	if (i != 0)
 	    retval = LIMIT_ERR;
     }
+#ifdef HAVE_SYS_CAPABILITY_H
+    if (!retval && pl->caps_set) {
+	retval = cap_set_proc(pl->capabilities) ? LIMIT_ERR : 0;
+	cap_free(pl->capabilities);
+    }
+#endif /* HAVE_SYS_CAPABILITY_H */
     return retval;
 }
             
