? Linux-PAM/modules/pammodutil/tty_secure.c
Index: Linux-PAM/modules/pam_securetty/pam_securetty.c
===================================================================
RCS file: /afs/sipb.mit.edu/project/debian/cvs/pam/Linux-PAM/modules/pam_securetty/pam_securetty.c,v
retrieving revision 1.4
diff -u -r1.4 pam_securetty.c
--- Linux-PAM/modules/pam_securetty/pam_securetty.c	21 Sep 2002 18:18:42 -0000	1.4
+++ Linux-PAM/modules/pam_securetty/pam_securetty.c	4 Apr 2004 22:59:54 -0000
@@ -34,6 +34,7 @@
 #define PAM_SM_AUTH
 
 #include <security/pam_modules.h>
+#include <security/_pam_modutil.h>
 
 /* some syslogging */
 
@@ -80,10 +81,8 @@
     int retval = PAM_AUTH_ERR;
     const char *username;
     char *uttyname;
-    char ttyfileline[256];
-    struct stat ttyfileinfo;
     struct passwd *user_pwd;
-    FILE *ttyfile;
+
     int ctrl;
 
     /* parse the arguments */
@@ -106,10 +105,6 @@
 	return PAM_SERVICE_ERR;
     }
 
-    /* The PAM_TTY item may be prefixed with "/dev/" - skip that */
-    if (strncmp(TTY_PREFIX, uttyname, sizeof(TTY_PREFIX)-1) == 0)
-	uttyname += sizeof(TTY_PREFIX)-1;
-
     user_pwd = getpwnam(username);
     if (user_pwd == NULL) {
 	return PAM_IGNORE;
@@ -119,44 +114,7 @@
 	return PAM_SUCCESS;
     }
 
-    if (stat(SECURETTY_FILE, &ttyfileinfo)) {
-	_pam_log(LOG_NOTICE, "Couldn't open " SECURETTY_FILE);
-	return PAM_SUCCESS; /* for compatibility with old securetty handling,
-			       this needs to succeed.  But we still log the
-			       error. */
-    }
-
-    if ((ttyfileinfo.st_mode & S_IWOTH)
-	|| !S_ISREG(ttyfileinfo.st_mode)) {
-	/* If the file is world writable or is not a
-	   normal file, return error */
-	_pam_log(LOG_ERR, SECURETTY_FILE
-		 " is either world writable or not a normal file");
-	return PAM_AUTH_ERR;
-    }
-
-    ttyfile = fopen(SECURETTY_FILE,"r");
-    if(ttyfile == NULL) { /* Check that we opened it successfully */
-	_pam_log(LOG_ERR,
-		 "Error opening " SECURETTY_FILE);
-	return PAM_SERVICE_ERR;
-    }
-    /* There should be no more errors from here on */
-    retval=PAM_AUTH_ERR;
-    /* This loop assumes that PAM_SUCCESS == 0
-       and PAM_AUTH_ERR != 0 */
-    while((fgets(ttyfileline,sizeof(ttyfileline)-1, ttyfile) != NULL) 
-	  && retval) {
-	if(ttyfileline[strlen(ttyfileline) - 1] == '\n')
-	    ttyfileline[strlen(ttyfileline) - 1] = '\0';
-	retval = strcmp(ttyfileline,uttyname);
-    }
-    fclose(ttyfile);
-    if(retval) {
-      _pam_log(LOG_WARNING, "access denied: tty '%s' is not secure !",
-		     uttyname);
-	retval = PAM_AUTH_ERR;
-    }
+    retval = _pammodutil_tty_secure( uttyname);
     if ((retval == PAM_SUCCESS) && (ctrl & PAM_DEBUG_ARG))
 	_pam_log(LOG_DEBUG, "access allowed for '%s' on '%s'",
 		 username, uttyname);
Index: Linux-PAM/modules/pammodutil/Makefile
===================================================================
RCS file: /afs/sipb.mit.edu/project/debian/cvs/pam/Linux-PAM/modules/pammodutil/Makefile,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Makefile
--- Linux-PAM/modules/pammodutil/Makefile	15 Sep 2002 20:09:04 -0000	1.1.1.1
+++ Linux-PAM/modules/pammodutil/Makefile	4 Apr 2004 22:59:54 -0000
@@ -18,7 +18,7 @@
   -DLIBPAM_VERSION_MINOR=$(MINOR_REL)
 
 # all the object files we care about
-LIBOBJECTS = modutil_cleanup.o modutil_getpwnam.o modutil_getpwuid.o
+LIBOBJECTS = modutil_cleanup.o modutil_getpwnam.o modutil_getpwuid.o tty_secure.o
 
 # static library name
 LIBSTATIC = $(LIBNAME).a
Index: Linux-PAM/modules/pammodutil/include/security/_pam_modutil.h
===================================================================
RCS file: /afs/sipb.mit.edu/project/debian/cvs/pam/Linux-PAM/modules/pammodutil/include/security/_pam_modutil.h,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 _pam_modutil.h
--- Linux-PAM/modules/pammodutil/include/security/_pam_modutil.h	15 Sep 2002 20:09:04 -0000	1.1.1.1
+++ Linux-PAM/modules/pammodutil/include/security/_pam_modutil.h	4 Apr 2004 22:59:54 -0000
@@ -30,4 +30,6 @@
 extern void _pammodutil_cleanup(pam_handle_t *pamh, void *data,
 				int error_status);
 
+extern int _pammodutil_tty_secure( const char *uttyname);
+
 #endif /* _PAM_MODUTIL_H */
