Backport of:

From 25f837646be8c2017c914d34be71ca435dfc0e07 Mon Sep 17 00:00:00 2001
From: "djm@openbsd.org" <djm@openbsd.org>
Date: Wed, 15 Mar 2017 02:25:09 +0000
Subject: [PATCH] upstream commit

fix regression in 7.4: deletion of PKCS#11-hosted keys
would fail unless they were specified by full physical pathname. Report and
fix from Jakub Jelen via bz#2682; ok dtucker@

Upstream-ID: 5b5bc20ca11cacb5d5eb29c3f93fd18425552268
---
 ssh-agent.c | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

Index: openssh-6.6p1/ssh-agent.c
===================================================================
--- openssh-6.6p1.orig/ssh-agent.c	2018-01-18 08:39:25.361183517 -0500
+++ openssh-6.6p1/ssh-agent.c	2018-01-18 08:39:48.625238746 -0500
@@ -668,7 +668,7 @@ send:
 static void
 process_remove_smartcard_key(SocketEntry *e)
 {
-	char *provider = NULL, *pin = NULL;
+	char *provider = NULL, *pin = NULL, canonical_provider[PATH_MAX];
 	int version, success = 0;
 	Identity *id, *nxt;
 	Idtab *tab;
@@ -677,6 +677,13 @@ process_remove_smartcard_key(SocketEntry
 	pin = buffer_get_string(&e->request, NULL);
 	free(pin);
 
+	if (realpath(provider, canonical_provider) == NULL) {
+		verbose("failed PKCS#11 add of \"%.100s\": realpath: %s",
+		    provider, strerror(errno));
+		goto send;
+	}
+
+	debug("%s: remove %.100s", __func__, canonical_provider);
 	for (version = 1; version < 3; version++) {
 		tab = idtab_lookup(version);
 		for (id = TAILQ_FIRST(&tab->idlist); id; id = nxt) {
@@ -684,14 +691,14 @@ process_remove_smartcard_key(SocketEntry
 			/* Skip file--based keys */
 			if (id->provider == NULL)
 				continue;
-			if (!strcmp(provider, id->provider)) {
+			if (!strcmp(canonical_provider, id->provider)) {
 				TAILQ_REMOVE(&tab->idlist, id, next);
 				free_identity(id);
 				tab->nentries--;
 			}
 		}
 	}
-	if (pkcs11_del_provider(provider) == 0)
+	if (pkcs11_del_provider(canonical_provider) == 0)
 		success = 1;
 	else
 		error("process_remove_smartcard_key:"
