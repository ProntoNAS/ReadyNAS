Origin: debian, openssh_1:6.0p1-4+deb7u7
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>

From 28652bca29046f62c7045e933e6b931de1d16737 Mon Sep 17 00:00:00 2001
From: "markus@openbsd.org" <markus@openbsd.org>
Date: Mon, 19 Sep 2016 19:02:19 +0000
Subject: upstream commit

move inbound NEWKEYS handling to kex layer; otherwise
early NEWKEYS causes NULL deref; found by Robert Swiecki/honggfuzz; fixed
with & ok djm@

Upstream-ID: 9a68b882892e9f51dc7bfa9f5a423858af358b2f
---
 kex.c    | 4 +++-
 packet.c | 6 ++----
 2 files changed, 5 insertions(+), 5 deletions(-)

--- a/kex.c
+++ b/kex.c
@@ -183,6 +183,7 @@ kex_finish(Kex *kex)
 	packet_read_expect(SSH2_MSG_NEWKEYS);
 	packet_check_eom();
 	debug("SSH2_MSG_NEWKEYS received");
+	set_newkeys(MODE_IN);
 
 	kex->done = 1;
 	buffer_clear(&kex->peer);
--- a/packet.c
+++ b/packet.c
@@ -1367,9 +1367,7 @@ packet_read_poll2(u_int32_t *seqnr_p)
 	type = buffer_get_char(&active_state->incoming_packet);
 	if (type < SSH2_MSG_MIN || type >= SSH2_MSG_LOCAL_MIN)
 		packet_disconnect("Invalid ssh2 packet type: %d", type);
-	if (type == SSH2_MSG_NEWKEYS)
-		set_newkeys(MODE_IN);
-	else if (type == SSH2_MSG_USERAUTH_SUCCESS &&
+	if (type == SSH2_MSG_USERAUTH_SUCCESS &&
 	    !active_state->server_side)
 		packet_enable_delayed_compress();
 #ifdef PACKET_DEBUG
