#! /bin/sh -e

# DP: Fixes directory traversal
# DP: http://gcc.gnu.org/bugzilla/show_bug.cgi?id=28359

dir=
if [ $# -eq 3 -a "$2" = '-d' ]; then
    pdir="-d $3"
    dir="$3/"
elif [ $# -ne 1 ]; then
    echo >&2 "`basename $0`: script expects -patch|-unpatch as argument"
    exit 1
fi
case "$1" in
    -patch)
        patch $pdir -f --no-backup-if-mismatch -p1 < $0
        #cd ${dir}gcc && autoconf
        ;;
    -unpatch)
        patch $pdir -f --no-backup-if-mismatch -R -p1 < $0
        #rm ${dir}gcc/configure
        ;;
    *)
        echo >&2 "`basename $0`: script expects -patch|-unpatch as argument"
        exit 1
esac
exit 0

diff -u -p -Nr --exclude CVS src.orig/fastjar/jartool.c src/fastjar/jartool.c
--- src.orig/fastjar/jartool.c	2006-08-04 11:59:22.000000000 +0200
+++ src/fastjar/jartool.c	2006-08-04 12:04:39.000000000 +0200
@@ -1717,6 +1717,7 @@ int extract_jar(int fd, char **files, in
       const ub1 *start = filename;
       char *tmp_buff;
       struct stat sbuf;
+      int depth = 0;
 
       tmp_buff = malloc(sizeof(char) * strlen((const char *)filename));
 
@@ -1737,7 +1738,14 @@ int extract_jar(int fd, char **files, in
 #ifdef DEBUG    
         printf("checking the existance of %s\n", tmp_buff);
 #endif
-
+      if(strcmp(tmp_buff, "..") == 0){
+        --depth;
+        if (depth < 0){
+          fprintf(stderr, "Traversal to parent directories during unpacking!\n");
+          exit(1);
+        }
+      } else if (strcmp(tmp_buff, ".") != 0)
+        ++depth;
         if(stat(tmp_buff, &sbuf) < 0){
           if(errno != ENOENT){
             perror("stat");
