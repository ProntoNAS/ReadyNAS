#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This version at least shares the same ABI, used in the dh_makeshlibs calls.
SHLIBS=2.4.3

include /usr/share/quilt/quilt.make

DEB_HOST_ARCH_OS ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)
ifeq ($(DEB_HOST_ARCH_OS),)
  DEB_HOST_ARCH_OS := $(subst -gnu,,$(shell dpkg-architecture -qDEB_HOST_GNU_SYSTEM))
  ifeq ($(DEB_HOST_ARCH_OS),gnu)
      DEB_HOST_ARCH_OS := hurd
  endif
endif

ifeq ($(DEB_HOST_ARCH_OS),hurd)
  CONFIGURE_OPTIONS += --without-libusb
endif

major=2

CFLAGS = -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
    CFLAGS += -O0
else
    CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
    INSTALL_PROGRAM += -s
endif

configure: configure-stamp
configure-stamp: $(QUILT_STAMPFN)
	dh_testdir
	CFLAGS="$(CFLAGS)" ./configure --prefix=/usr --sysconfdir=/etc --mandir=\$${prefix}/share/man --with-drivers=all --enable-static $(CONFIGURE_OPTIONS)
	touch configure-stamp

build: build-stamp
build-stamp: configure-stamp 
	dh_testdir
	#$(MAKE) all-local  # necessary to get headers into gphoto2/
	$(MAKE)
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -f config.log config.status confdefs.h
	rm -f libgphoto2_port/config.log libgphoto2_port/config.status
	-rm -rf `pwd`/debian/tmp `pwd`/debian/libgphoto2 `pwd`/debian/libgphoto2-dev
	rm -f po/stamp-po po/*.gmo

	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	export LIBRARY_PATH=`pwd`/debian/tmp/usr/lib; $(MAKE) install prefix=`pwd`/debian/tmp/usr

	# remove upstream 0-byte files to make lintian happy
	-find debian/tmp/ -size 0 -exec rm '{}' ';'

	# Ok the GPL is already on the target system
	rm debian/tmp/usr/share/doc/libgphoto2/COPYING

	# remove the recursive symlink
	rm debian/tmp/usr/include/gphoto2/gphoto2

	dh_movefiles

	mv debian/libgphoto2-$(major)/usr/share/doc/libgphoto2 \
		debian/libgphoto2-$(major)/usr/share/doc/libgphoto2-$(major)
	mv debian/libgphoto2-port0/usr/share/doc/libgphoto2_port \
		debian/libgphoto2-port0/usr/share/doc/libgphoto2-port0

ifeq ($(DEB_HOST_ARCH_OS),linux)
	# we don't need this any more with current udev
	rm debian/tmp/usr/lib/udev/check-ptp-camera

	# create udev rules
	CAMLIBS=`ls -d debian/libgphoto2-$(major)/usr/lib/libgphoto2/2*` ./packaging/generic/print-camera-list udev-rules version 136 mode 0664 group plugdev > debian/libgphoto2-$(major).udev
	dh_installudev
	rm debian/libgphoto2-$(major).udev

	-test -e debian/tmp/usr/lib/udev/check-mtp-device && \
		mkdir -p debian/libgphoto2-port0/lib/udev && \
		mv debian/tmp/usr/lib/udev/check-mtp-device \
			debian/libgphoto2-port0/lib/udev/check-mtp-device

	# create hal FDI
	mkdir -p debian/libgphoto2-$(major)/usr/share/hal/fdi/preprobe/10osvendor/
	CAMLIBS=`ls -d debian/libgphoto2-$(major)/usr/lib/libgphoto2/2*` ./packaging/generic/print-camera-list hal-fdi > \
			debian/libgphoto2-$(major)/usr/share/hal/fdi/preprobe/10osvendor/20-libgphoto2.fdi
endif

	# remove *.la files before trying to remove debian/tmp
	find debian/tmp/usr/lib -name '*.la' -maxdepth 1 -type f -delete

	-find debian/tmp -type d | sort -r | xargs rmdir 2>&1 > /dev/null
	# debian/tmp should be empty here : if not fail:
	test ! -d debian/tmp

binary-indep: build install
# We have nothing to do by default.

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs doc/DAEMON
	dh_installchangelogs ChangeLog
	dh_link -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a --exclude usbcam
	# By comparing the symbols, a strict dependency on the latest upstream version
	# can be avoided. $SHLIBS represents the latest version with the same ABI, and
	# is set at the top of this file.
	dh_makeshlibs -plibgphoto2-$(major) -V 'libgphoto2-$(major) (>= $(SHLIBS))'
	dh_makeshlibs -plibgphoto2-port0    -V 'libgphoto2-port0    (>= $(SHLIBS))'
	dh_installdeb
	dh_shlibdeps -ldebian/libgphoto2-$(major)/usr/lib/:debian/libgphoto2-port0/usr/lib/
	dh_gencontrol -plibgphoto2-$(major)-dev
	dh_gencontrol -plibgphoto2-port0
ifeq (linux,$(DEB_HOST_ARCH_OS))
	dh_gencontrol -plibgphoto2-$(major) -- -Vudev-hotplug='udev (>= 0.136)'
else
	dh_gencontrol -plibgphoto2-$(major)
endif
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
