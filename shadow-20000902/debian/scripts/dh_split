#!/usr/bin/perl -w

# Special just for shadow (does not create for a base package, so
# not compatible with debhelper)
#LOCAL#

$control = 'debian/control';
$dir = 'debian';
$needclean = 0;
$needlist = 0;
$needdeps = 0;

if (@ARGV) {
    $temp = shift;
    if ($temp eq "clean") { $needclean = 1; }
    elsif ($temp eq "makedeps") { $needlist = 1; }
    elsif ($temp eq "gendeps") { $needdeps = 1; }
}

@packages = ();

open (CONTROL, "< $control");

while (<CONTROL>) {
    if (m/^Package:/) {
	$package = (split)[1];
	if ( -f "${dir}/${package}.in" ) {
	    push @packages, $package;
	}
    }
}

close CONTROL;

while (@packages) {
    $package = shift(@packages);
    $inhead = 1;
    $opened = 0;
    if ($needdeps) {
	print "${dir}/${package}.in ";
	next;
    }
    open (IN, "< ${dir}/${package}.in");
    while (<IN>) {
	if (m/^\%(.*)\%$/) {
	    if ($needclean) {
		system("rm -f ${dir}/${package}.${1}");
	    } elsif ($needlist) {
		print "${dir}/${package}.${1} ";
	    } else {
		$inhead = 0;
		if ($opened) { close OUT; } else { $opened = 1; }
		open OUT, "> ${dir}/${package}.${1}";
	    }
	} elsif (!$inhead) {
	    print OUT $_;
	}
    }
    close OUT;
    close IN;
}
