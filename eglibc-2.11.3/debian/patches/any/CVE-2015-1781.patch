From: Arjun Shankar <arjun.is@lostca.se>
Date: Tue, 21 Apr 2015 12:06:31 +0000 (+0200)
Subject: CVE-2015-1781: resolv/nss_dns/dns-host.c buffer overflow [BZ#18287]
X-Git-Url: https://sourceware.org/git/?p=glibc.git;a=commitdiff_plain;h=2959eda9272a03386

A buffer overflow in gethostbyname_r and related functions performing DNS
requests has been fixed.  If the NSS functions were called with a
misaligned buffer, the buffer length change due to pointer alignment was
not taken into account.  This could result in application crashes or,
potentially arbitrary code execution, using crafted, but syntactically
valid DNS responses.  (CVE-2015-1781)

CVE-2015-1781: resolv/nss_dns/dns-host.c buffer overflow [BZ#18287]
---

--- a/resolv/nss_dns/dns-host.c
+++ b/resolv/nss_dns/dns-host.c
@@ -601,7 +601,8 @@ getanswer_r (const querybuf *answer, int
   int have_to_map = 0;
   uintptr_t pad = -(uintptr_t) buffer % __alignof__ (struct host_data);
   buffer += pad;
-  if (__builtin_expect (buflen < sizeof (struct host_data) + pad, 0))
+  buflen = buflen > pad ? buflen - pad : 0;
+  if (__builtin_expect (buflen < sizeof (struct host_data), 0))
     {
       /* The buffer is too small.  */
     too_small:
