From 63646dd0bc38cb404a401f7252938a69e2142004 Mon Sep 17 00:00:00 2001
Message-Id: <63646dd0bc38cb404a401f7252938a69e2142004.1443275139.git.agx@sigxcpu.org>
From: =?UTF-8?q?Guido=20G=C3=BCnther?= <agx@sigxcpu.org>
Date: Sat, 26 Sep 2015 15:45:00 +0200
Subject: [PATCH] Ignore LD_POINTER_GUARD for set-user-ID/set-group-ID binaries

https://sourceware.org/ml/libc-alpha/2015-09/msg00164.html

Fixes TEMP-0000000-1FEA47
---
 elf/rtld.c                  | 3 ++-
 sysdeps/generic/unsecvars.h | 1 +
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/elf/rtld.c b/elf/rtld.c
index 2609693..7d43411 100644
--- a/elf/rtld.c
+++ b/elf/rtld.c
@@ -2624,7 +2624,8 @@ process_envvars (enum mode *modep)
 	      break;
 	    }
 
-	  if (memcmp (envline, "POINTER_GUARD", 13) == 0)
+	  if (!__libc_enable_secure
+	      && memcmp (envline, "POINTER_GUARD", 13) == 0)
 	    GLRO(dl_pointer_guard) = envline[14] != '0';
 	  break;
 
diff --git a/sysdeps/generic/unsecvars.h b/sysdeps/generic/unsecvars.h
index d5b8119..9f1946a 100644
--- a/sysdeps/generic/unsecvars.h
+++ b/sysdeps/generic/unsecvars.h
@@ -11,6 +11,7 @@
   "LD_DYNAMIC_WEAK\0"							      \
   "LD_LIBRARY_PATH\0"							      \
   "LD_ORIGIN_PATH\0"							      \
+  "LD_POINTER_GUARD\0"							      \
   "LD_PRELOAD\0"							      \
   "LD_PROFILE\0"							      \
   "LD_SHOW_AUXV\0"							      \
-- 
2.1.4

