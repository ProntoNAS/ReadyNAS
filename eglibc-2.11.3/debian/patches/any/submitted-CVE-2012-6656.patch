From 6e230d11837f3ae7b375ea69d7905f0d18eb79e5 Mon Sep 17 00:00:00 2001
From: Siddhesh Poyarekar <siddhesh@redhat.com>
Date: Wed, 6 Jun 2012 18:39:10 +0530
Subject: [PATCH] Fix validation check when converting from ibm930 to utf

[BZ #14134]

When converting IBM930 code with iconv(), if IBM930 code which
includes invalid multibyte character "0xffff" is specified, then
iconv() segfaults. This is easy to see using the following command:

echo '0x0e 0x43 0x8c 0xff 0xff 0x43 0xbd 0x43 0xbd' | xxd -r |
	iconv -f IBM930 -t UTF-8
---
 ChangeLog          |    7 +++++++
 NEWS               |    2 +-
 iconvdata/ibm930.c |    5 +++--
 3 files changed, 11 insertions(+), 3 deletions(-)

Index: eglibc-2.11.3/ChangeLog
===================================================================
--- eglibc-2.11.3.orig/ChangeLog	2014-11-23 19:55:37.000000000 +0100
+++ eglibc-2.11.3/ChangeLog	2014-11-23 19:56:33.000000000 +0100
@@ -1,3 +1,10 @@
+2012-06-06  Siddhesh Poyarekar  <siddhesh@redhat.com>
+
+       [BZ #14134]
+       * iconvdata/ibm930.c (BODY) [FROM_LOOP]: Check for invalid
+       character 0xffff that matches the last element of the
+       conversion table.
+
 2011-05-29  Ulrich Drepper  <drepper@gmail.com>
 
 	[BZ #12350]
Index: eglibc-2.11.3/NEWS
===================================================================
--- eglibc-2.11.3.orig/NEWS	2014-11-23 19:55:37.000000000 +0100
+++ eglibc-2.11.3/NEWS	2014-11-23 19:58:08.000000000 +0100
@@ -5,6 +5,12 @@
 Please send GNU C library bug reports via <http://sources.redhat.com/bugzilla/>
 using `glibc' in the "product" field.
 
+Squeeze LTS version
+
+* The following bugs are resolved with this release:
+
+  14134
+
 Version 2.11
 
 * New interfaces: execvpe, pthread_sigqueue, mkstemps, mkstemps64, mkostemps,
Index: eglibc-2.11.3/iconvdata/ibm930.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm930.c	2014-11-23 19:55:37.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm930.c	2014-11-23 19:55:37.000000000 +0100
@@ -1,5 +1,5 @@
 /* Conversion from and to IBM930.
-   Copyright (C) 2000-2002, 2008 Free Software Foundation, Inc.
+   Copyright (C) 2000-2012 Free Software Foundation, Inc.
    This file is part of the GNU C Library.
    Contributed by Masahide Washizawa <washi@yamato.ibm.co.jp>, 2000.
 
@@ -163,7 +163,8 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (ch < rp2->start, 0)			      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
+	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm930db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
 	  {								      \
