From 41488498b6d9440ee66ab033808cce8323bba7ac Mon Sep 17 00:00:00 2001
From: Florian Weimer <fweimer@redhat.com>
Date: Wed, 3 Sep 2014 19:45:43 +0200
Subject: [PATCH] CVE-2014-6040: Crashes on invalid input in IBM gconv modules [BZ #17325]

These changes are based on the fix for BZ #14134 in commit
6e230d11837f3ae7b375ea69d7905f0d18eb79e5.
---
 ChangeLog                   |   17 +++++++++++++++++
 NEWS                        |    7 ++++++-
 iconvdata/Makefile          |    1 +
 iconvdata/ibm1364.c         |    3 ++-
 iconvdata/ibm932.c          |    5 +++--
 iconvdata/ibm933.c          |    2 +-
 iconvdata/ibm935.c          |    2 +-
 iconvdata/ibm937.c          |    2 +-
 iconvdata/ibm939.c          |    2 +-
 iconvdata/ibm943.c          |    5 +++--
 iconvdata/run-iconv-test.sh |   18 ++++++++++++++++++
 11 files changed, 54 insertions(+), 10 deletions(-)

Index: eglibc-2.11.3/ChangeLog
===================================================================
--- eglibc-2.11.3.orig/ChangeLog	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/ChangeLog	2014-11-24 13:48:24.000000000 +0100
@@ -1,3 +1,20 @@
+2014-09-03  Florian Weimer  <fweimer@redhat.com>
+
+       [BZ #17325]
+       * iconvdata/ibm1364.c (BODY): Fix check for sentinel.
+       * iconvdata/ibm932.c (BODY): Replace invalid sentinel check with
+       assert.
+       * iconvdata/ibm933.c (BODY): Fix check for sentinel.
+       * iconvdata/ibm935.c (BODY): Likewise.
+       * iconvdata/ibm937.c (BODY): Likewise.
+       * iconvdata/ibm939.c (BODY): Likewise.
+       * iconvdata/ibm943.c (BODY): Replace invalid sentinel check with
+       assert.
+       * iconvdata/Makefile (iconv-test.out): Pass module list to test
+       script.
+       * iconvdata/run-iconv-test.sh: New test loop for checking for
+       decoder crashers.
+
 2012-06-06  Siddhesh Poyarekar  <siddhesh@redhat.com>
 
        [BZ #14134]
Index: eglibc-2.11.3/NEWS
===================================================================
--- eglibc-2.11.3.orig/NEWS	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/NEWS	2014-11-24 13:49:25.000000000 +0100
@@ -9,7 +9,12 @@
 
 * The following bugs are resolved with this release:
 
-  14134
+  14134, 17325
+
+* Decoding a crafted input sequence in the character sets IBM933, IBM935,
+  IBM937, IBM939, IBM1364 could result in an out-of-bounds array read,
+  resulting a denial-of-service security vulnerability in applications which
+  use functions related to iconv. (CVE-2014-6040)
 
 Version 2.11
 
Index: eglibc-2.11.3/iconvdata/Makefile
===================================================================
--- eglibc-2.11.3.orig/iconvdata/Makefile	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/Makefile	2014-11-24 15:08:29.000000000 +0100
@@ -379,6 +379,7 @@
 $(objpfx)iconv-test.out: run-iconv-test.sh $(objpfx)gconv-modules \
 			 $(addprefix $(objpfx),$(modules.so)) \
 			 $(common-objdir)/iconv/iconv_prog TESTS
+	iconv_modules="$(modules)" \
 	$(SHELL) -e $< $(common-objdir) '$(cross-test-wrapper)' > $@
 
 $(objpfx)tst-tables.out: tst-tables.sh $(objpfx)gconv-modules \
Index: eglibc-2.11.3/iconvdata/ibm1364.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm1364.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm1364.c	2014-11-24 13:47:56.000000000 +0100
@@ -221,7 +221,8 @@
 	  ++rp2;							      \
 									      \
 	uint32_t res;							      \
-	if (__builtin_expect (ch < rp2->start, 0)			      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
+	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = DB_TO_UCS4[ch + rp2->idx],			      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
 	  {								      \
Index: eglibc-2.11.3/iconvdata/ibm932.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm932.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm932.c	2014-11-24 13:47:56.000000000 +0100
@@ -74,11 +74,12 @@
 	  }								      \
 									      \
 	ch = (ch * 0x100) + inptr[1];					      \
+	/* ch was less than 0xfd.  */					      \
+	assert (ch < 0xfd00);						      \
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
-	    || __builtin_expect (ch < rp2->start, 0)			      \
+	if (__builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm932db_to_ucs4[ch + rp2->idx],		      \
 	    __builtin_expect (res, '\1') == 0 && ch !=0))		      \
 	  {								      \
Index: eglibc-2.11.3/iconvdata/ibm933.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm933.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm933.c	2014-11-24 13:47:56.000000000 +0100
@@ -162,7 +162,7 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
 	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm933db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
Index: eglibc-2.11.3/iconvdata/ibm935.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm935.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm935.c	2014-11-24 13:47:56.000000000 +0100
@@ -162,7 +162,7 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
 	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm935db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
Index: eglibc-2.11.3/iconvdata/ibm937.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm937.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm937.c	2014-11-24 13:47:56.000000000 +0100
@@ -162,7 +162,7 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
 	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm937db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
Index: eglibc-2.11.3/iconvdata/ibm939.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm939.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm939.c	2014-11-24 13:47:56.000000000 +0100
@@ -162,7 +162,7 @@
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
+	if (__builtin_expect (rp2->start == 0xffff, 0)			      \
 	    || __builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm939db_to_ucs4[ch + rp2->idx],		      \
 		__builtin_expect (res, L'\1') == L'\0' && ch != '\0'))	      \
Index: eglibc-2.11.3/iconvdata/ibm943.c
===================================================================
--- eglibc-2.11.3.orig/iconvdata/ibm943.c	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/ibm943.c	2014-11-24 13:47:56.000000000 +0100
@@ -75,11 +75,12 @@
 	  }								      \
 									      \
 	ch = (ch * 0x100) + inptr[1];					      \
+	/* ch was less than 0xfd.  */					      \
+	assert (ch < 0xfd00);						      \
 	while (ch > rp2->end)						      \
 	  ++rp2;							      \
 									      \
-	if (__builtin_expect (rp2 == NULL, 0)				      \
-	    || __builtin_expect (ch < rp2->start, 0)			      \
+	if (__builtin_expect (ch < rp2->start, 0)			      \
 	    || (res = __ibm943db_to_ucs4[ch + rp2->idx],		      \
 	    __builtin_expect (res, '\1') == 0 && ch !=0))		      \
 	  {								      \
Index: eglibc-2.11.3/iconvdata/run-iconv-test.sh
===================================================================
--- eglibc-2.11.3.orig/iconvdata/run-iconv-test.sh	2014-11-24 13:47:56.000000000 +0100
+++ eglibc-2.11.3/iconvdata/run-iconv-test.sh	2014-11-24 13:47:56.000000000 +0100
@@ -201,6 +201,24 @@
 done
 exec 5<&-
 
+# Check for crashes in decoders.
+printf '\016\377\377\377\377\377\377\377' > $temp1
+for from in $iconv_modules ; do
+    echo $ac_n "test decoder $from $ac_c"
+    PROG=`eval echo $ICONV`
+    if $PROG < $temp1 >/dev/null 2>&1 ; then
+	: # fall through
+    else
+	status=$?
+	if test $status -gt 1 ; then
+	    echo "/FAILED"
+	    failed=1
+	    continue
+	fi
+    fi
+    echo "OK"
+done
+
 exit $failed
 # Local Variables:
 #  mode:shell-script
