From fd7e0c02e272913a0a8b6d492c7260dfca0b1408 Mon Sep 17 00:00:00 2001
From: Tim Kientzle <kientzle@acm.org>
Date: Sat, 14 May 2016 12:37:37 -0700
Subject: [PATCH] Reject cpio symlinks that exceed 1MB

---
 libarchive/archive_read_support_format_cpio.c | 5 +++++
 1 file changed, 5 insertions(+)

Index: libarchive-3.1.2/libarchive/archive_read_support_format_cpio.c
===================================================================
--- libarchive-3.1.2.orig/libarchive/archive_read_support_format_cpio.c	2016-07-13 09:19:49.756376780 -0400
+++ libarchive-3.1.2/libarchive/archive_read_support_format_cpio.c	2016-07-13 09:19:49.752376731 -0400
@@ -399,6 +399,11 @@
 
 	/* If this is a symlink, read the link contents. */
 	if (archive_entry_filetype(entry) == AE_IFLNK) {
+		if (cpio->entry_bytes_remaining > 1024 * 1024) {
+			archive_set_error(&a->archive, ENOMEM,
+			    "Rejecting malformed cpio archive: symlink contents exceed 1 megabyte");
+			return (ARCHIVE_FATAL);
+		}
 		h = __archive_read_ahead(a,
 			(size_t)cpio->entry_bytes_remaining, NULL);
 		if (h == NULL)
