From be77c461777f1b87ba9e03ec1cf60c96eed2f6fe Mon Sep 17 00:00:00 2001
From: Justin Maggard <jmaggard10@gmail.com>
Date: Tue, 26 Aug 2014 11:04:35 -0700
Subject: [PATCH] btrfsck: add --fix-crc option.

---
 cmds-check.c |   21 ++++++++++++++++++++-
 disk-io.c    |   13 +++++++++++--
 2 files changed, 31 insertions(+), 3 deletions(-)

diff --git a/cmds-check.c b/cmds-check.c
index 268e588..05fe4a5 100644
--- a/cmds-check.c
+++ b/cmds-check.c
@@ -1438,6 +1438,11 @@ static int walk_down_tree(struct btrfs_root *root, struct btrfs_path *path,
 		WARN_ON(*level < 0);
 		WARN_ON(*level >= BTRFS_MAX_LEVEL);
 		cur = path->nodes[*level];
+		if (!cur) {
+			fprintf(stderr, "Warning: path->nodes[%d] == 0\n",
+				*level);
+			return 0;
+		}
 
 		if (btrfs_header_level(cur) != *level)
 			WARN_ON(1);
@@ -7543,9 +7548,12 @@ static struct option long_options[] = {
 	{ "init-csum-tree", 0, NULL, 0 },
 	{ "init-extent-tree", 0, NULL, 0 },
 	{ "check-data-csum", 0, NULL, 0 },
-	{ "backup", 0, NULL, 0 },
+	{ "backup", 0, NULL, 'b' },
 	{ "subvol-extents", 1, NULL, 'E' },
 	{ "qgroup-report", 0, NULL, 'Q' },
+#ifdef __arm__
+	{ "fix-crc", 0, NULL, 0 },
+#endif
 	{ NULL, 0, NULL, 0}
 };
 
@@ -7561,9 +7569,14 @@ const char * const cmd_check_usage[] = {
 	"--check-data-csum           verify checkums of data blocks",
 	"--qgroup-report             print a report on qgroup consistency",
 	"--subvol-extents <subvolid> print subvolume extents and sharing state",
+#ifdef __arm__
+	"--fix-crc                   try to fix bad CRCs",
+#endif
 	NULL
 };
 
+extern int fix_crc;
+
 int cmd_check(int argc, char **argv)
 {
 	struct cache_tree root_cache;
@@ -7628,6 +7641,12 @@ int cmd_check(int argc, char **argv)
 			repair = 1;
 		} else if (option_index == 4) {
 			check_data_csum = 1;
+#ifdef __arm__
+		} else if (option_index == 8) {
+			printf("Fixing bad CRC\n");
+			fix_crc = 1;
+			ctree_flags |= OPEN_CTREE_WRITES;
+#endif
 		}
 	}
 	argc = argc - optind;
diff --git a/disk-io.c b/disk-io.c
index f71f5ca..295d381 100644
--- a/disk-io.c
+++ b/disk-io.c
@@ -71,6 +71,7 @@ void btrfs_csum_final(u32 crc, char *result)
 	*(__le32 *)result = ~cpu_to_le32(crc);
 }
 
+int fix_crc;
 static int __csum_tree_block_size(struct extent_buffer *buf, u16 csum_size,
 				  int verify, int silent)
 {
@@ -88,13 +89,21 @@ static int __csum_tree_block_size(struct extent_buffer *buf, u16 csum_size,
 
 	if (verify) {
 		if (memcmp_extent_buffer(buf, result, 0, csum_size)) {
-			if (!silent)
+			int rval = 1;
+
+			if (!silent || fix_crc)
 				printk("checksum verify failed on %llu found %08X wanted %08X\n",
 				       (unsigned long long)buf->start,
 				       *((u32 *)result),
 				       *((u32*)(char *)buf->data));
+			if (fix_crc) {
+				write_extent_buffer(buf, result, 0, csum_size);
+				write_extent_to_disk(buf);
+				printk(">> Fixed\n");
+				rval = 0;
+			}
 			free(result);
-			return 1;
+			return rval;
 		}
 	} else {
 		write_extent_buffer(buf, result, 0, csum_size);
