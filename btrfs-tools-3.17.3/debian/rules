#!/usr/bin/make -f

include /usr/share/dpkg/architecture.mk
ifneq ($(DEB_HOST_GNU_TYPE),$(DEB_BUILD_GNU_TYPE))
  CC := $(DEB_HOST_GNU_TYPE)-gcc
else
  CC := gcc
endif

SHELL := sh -e

CFLAGS := $(shell dpkg-buildflags --get CFLAGS)
CFLAGS := $(patsubst -O2,-Os,$(CFLAGS))
DEB_BUILD_OPTIONS := nocheck
export DEB_BUILD_OPTIONS

%:
	dh ${@}

override_dh_auto_build:
	dh_auto_build -- all btrfs-select-super btrfs-calc-size CFLAGS="$(CFLAGS)" CC="$(CC)" #BUILD_VERBOSE=1

override_dh_auto_install:
	dh_auto_install -- prefix=/usr bindir=/sbin mandir=/usr/share/man libdir=/usr/lib/$(DEB_HOST_MULTIARCH)

	# Fixing 'manpage-not-compressed-with-max-compression'
	for _MANPAGE in $(CURDIR)/debian/tmp/usr/share/man/*/*.gz; \
	do \
		cd $$(dirname $${_MANPAGE}); \
		[ -f $$(basename $${_MANPAGE}) ] && gunzip $$(basename $${_MANPAGE}); \
	done

override_dh_install:
	dh_install --fail-missing

override_dh_strip:
	dh_strip --dbg-package=btrfs-tools-dbg

# distclean target does not exist and make would waste time generating
# dependency files and version.h before failing. debhelper < 9.20130624
# would even think distclean exists because something is printed.
override_dh_auto_clean:
	make clean
	-rm test.img fsck-test*.txt
	-rm Documentation/*.8 Documentation/*.xml Documentation/*.gz
