#!/usr/bin/make -f

include /usr/share/quilt/quilt.make

DEB_VERSION := $(shell dpkg-parsechangelog | sed -n 's/^Version: //p')
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | sed -r 's/[^:]+://; s/-[^-]+$$//')

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

NCPUS := $(shell getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)

ifeq ($(NCPUS),-1)
	NCPUS:=1
endif

ifeq ($(NCPUS),0)
	NCPUS:=1
endif

DEBIAN_ARCH = $(shell dpkg-architecture -qDEB_BUILD_ARCH)

CFLAGS := $(shell dpkg-buildflags --get CFLAGS)
CPPFLAGS := $(shell dpkg-buildflags --get CPPFLAGS)
LDFLAGS := $(shell dpkg-buildflags --get LDFLAGS)

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS +=
endif

CONFIG_ALL = --prefix=/usr --extra-cflags="$(CFLAGS)" --extra-ldflags="$(LDFLAGS)" --cc="$(CC)" \
	--libdir=/usr/lib/$(DEB_HOST_MULTIARCH) --shlibdir=/usr/lib/$(DEB_HOST_MULTIARCH) \
	--enable-shared --disable-stripping --enable-small \
	--disable-amd3dnow --disable-cuvid --disable-cuda --disable-bsfs \
	--disable-ffserver \
	--enable-avresample \
	--disable-devices \
	--disable-protocols \
		--enable-protocol=file \
		--enable-protocol=pipe \
	--disable-parsers \
		--enable-parser=aac \
		--enable-parser=ac3 \
		--enable-parser=dvbsub \
		--enable-parser=dvdsub \
		--enable-parser=flac \
		--enable-parser=h261 \
		--enable-parser=h263 \
		--enable-parser=h264 \
		--enable-parser=mjpeg \
		--enable-parser=mlp \
		--enable-parser=mpeg4video \
		--enable-parser=mpegaudio \
		--enable-parser=mpegvideo \
		--enable-parser=vc1 \
		--enable-parser=vorbis \
		--enable-parser=vp3 \
		--enable-parser=vp8 \
	--disable-demuxers \
		--enable-demuxer=aac \
		--enable-demuxer=ac3 \
		--enable-demuxer=aiff \
		--enable-demuxer=asf \
		--enable-demuxer=avi \
		--enable-demuxer=dts \
		--enable-demuxer=dv \
		--enable-demuxer=eac3 \
		--enable-demuxer=flac \
		--enable-demuxer=flv \
		--enable-demuxer=h261 \
		--enable-demuxer=h263 \
		--enable-demuxer=h264 \
		--enable-demuxer=matroska \
		--enable-demuxer=mjpeg \
		--enable-demuxer=mov \
		--enable-demuxer=m4v \
		--enable-demuxer=mp3 \
		--enable-demuxer=mpegps \
		--enable-demuxer=mpegts \
		--enable-demuxer=mpegtsraw \
		--enable-demuxer=mpegvideo \
		--enable-demuxer=ogg \
		--enable-demuxer=rtsp \
		--enable-demuxer=vc1 \
		--enable-demuxer=wav \
	--disable-decoders \
		--enable-decoder=aac \
		--enable-decoder=alac \
		--enable-decoder=eac3 \
		--enable-decoder=flac \
		--enable-decoder=flv \
		--enable-decoder=h264 \
		--enable-decoder=mp3 \
		--enable-decoder=mpeg2video \
		--enable-decoder=mpeg4 \
		--enable-decoder=pcm_s16be \
		--enable-decoder=pcm_s16le \
		--enable-decoder=vorbis \
		--enable-decoder=wmalossless \
		--enable-decoder=wmapro \
		--enable-decoder=wmav1 \
		--enable-decoder=wmav2 \
	--disable-muxers \
		--enable-muxer=mp3 \
		--enable-muxer=pcm_s16be \
		--enable-muxer=pcm_s16le \
	--disable-encoders \
		--enable-libmp3lame \
		--enable-encoder=libmp3lame \
		--enable-encoder=pcm_s16be \
		--enable-encoder=pcm_s16le \
	--disable-filters \
		--enable-filter=aresample

ifeq "$(DEBIAN_ARCH)" "armel" 
	CFLAGS += -fPIC -DPIC
endif

configure: configure-stamp
configure-stamp: debian/stamp-patched
	dh_testdir

	./configure $(CONFIG_ALL)

ifneq (,$(findstring kfreebsd,$(DEBIAN_ARCH)))
	perl -i -pe 's,CONFIG_SCTP_PROTOCOL=yes,CONFIG_SCTP_PROTOCOL=no,' config.mak
	perl -i -pe 's,HAVE_NETINET_SCTP_H=yes,HAVE_NETINET_SCTP_H=no,' config.mak  
	perl -i -pe 's,#define HAVE_NETINET_SCTP_H 1,#define HAVE_NETINET_SCTP_H 0,' config.h
	perl -i -pe 's,#define CONFIG_SCTP_PROTOCOL 1,#define CONFIG_SCTP_PROTOCOL 0,' config.h
	perl -i -pe 's,%define HAVE_NETINET_SCTP_H 1,%define HAVE_NETINET_SCTP_H 0,' config.asm
	perl -i -pe 's,%define CONFIG_SCTP_PROTOCOL 1,%define CONFIG_SCTP_PROTOCOL 0,' config.asm 
endif

#	exit 1

##	echo "#define FFMPEG_VERSION \"$(UPSTREAM_VERSION)\"" > version.h

# Add V=1 for verbose build
	$(MAKE) -j $(NCPUS)
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp

ifneq "$(CONFIG_OPT)"""
	$(MAKE) distclean
	./configure $(CONFIG_ALL) $(CONFIG_OPT)

##	echo "#define FFMPEG_VERSION \"$(UPSTREAM_VERSION)\"" > version.h

endif
	touch $@

build: build-stamp
build-stamp: configure-stamp
	dh_testdir

# Add V=1 for verbose build
	$(MAKE) -j $(NCPUS)
	$(MAKE) tools/qt-faststart

#	exit 1

	touch $@

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	-$(MAKE) distclean
	[ ! -f doc/Makefile ] || $(MAKE) -C doc clean

	debian/rules unpatch 

	dh_clean output_example qt-faststart libavformat/libavformat.so \
	libavcodec/amrwb_float/*.o config.log *.pc libavcodec/amr_float/*.o \
	libavutil/libavutil.so.52 libavcodec/libavcodec.so.54 config.err \
	libpostproc/libpostproc.so.51 *.o tools/qt-faststart.d libavutil/avconfig.h \
	doc/*.d doc/examples/pc-uninstalled/* tools/qt-faststart \
	libavcodec/codec_names.h doc/print_options .config config.fate

	find -name *.o |xargs -r rm
	find -name *.d |xargs -r rm

	-rm -rf doxy

install: build
	dh_testdir
	dh_testroot
#	dh_prep
	dh_installdirs

	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp

	rm -rf debian/tmp/usr/share/ffmpeg/examples

# Build architecture-independent files here.
binary-indep: build install
#	[ -d doxy ] || doxygen
	dh_install -pffmpeg-doc
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs
	dh_installdocs -i
	dh_lintian -i
	dh_link -i
	dh_compress -i
	dh_fixperms  -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i -- -Zxz

# Build architecture-dependent files here.
binary-arch: build install
	dh_install -a --fail-missing
	dh_testdir -a
	dh_testroot -a
	dh_installchangelogs
	dh_installdocs -a
	dh_lintian -a
	dh_link -a
	dh_strip -a --dbg-package=ffmpeg-dbg
	dh_compress -a
	dh_fixperms  -a
	dh_makeshlibs -a -V
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a -- -Zxz

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
