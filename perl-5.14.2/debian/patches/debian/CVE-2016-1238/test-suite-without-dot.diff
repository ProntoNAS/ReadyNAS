From 9bd33abe59d0f251976151ff40c09bd7a812ab9c Mon Sep 17 00:00:00 2001
From: Todd Rinaldo <toddr@cpan.org>
Date: Thu, 31 Mar 2016 17:04:29 -0500
Subject: Patch unit tests to explicitly insert "." into @INC when needed.

(Backported to Debian 5.14 by Dominic Hargreaves)

Bug: https://rt.perl.org/Public/Bug/Display.html?id=127810
Patch-Name: debian/CVE-2016-1238/test-suite-without-dot.diff
---
 Makefile.SH         |  2 +-
 lib/strict.t        |  2 +-
 lib/warnings.t      |  2 +-
 makedef.pl          | 33 +++++++++++++++++++++++++++++++++
 regen.pl            |  3 +--
 t/comp/line_debug.t |  2 ++
 t/lib/warnings/op   |  1 +
 t/op/goto.t         |  2 +-
 t/porting/regen.t   |  2 +-
 t/run/switches.t    |  6 +++---
 t/test.pl           |  3 ++-
 11 files changed, 47 insertions(+), 11 deletions(-)

diff --git a/Makefile.SH b/Makefile.SH
index 1dac585..7c9d5b5 100755
--- a/Makefile.SH
+++ b/Makefile.SH
@@ -298,7 +298,7 @@ MINIPERL = \$(LDLIBPTH) \$(RUN) ./miniperl\$(EXE_EXT) -Ilib
 
 # Macros to invoke a copy of our fully operational perl during the build.
 PERL_EXE = perl\$(EXE_EXT)
-RUN_PERL = \$(LDLIBPTH) \$(RUN) ./perl\$(EXE_EXT)
+RUN_PERL = \$(LDLIBPTH) \$(RUN) ./perl\$(EXE_EXT) -Ilib -I.
 
 # Macros to run our tests
 RUN_TESTS = \$(LDLIBPTH) ./runtests
diff --git a/lib/strict.t b/lib/strict.t
index e067793..d252c8d 100644
--- a/lib/strict.t
+++ b/lib/strict.t
@@ -1,7 +1,7 @@
 #!./perl
 
 chdir 't' if -d 't';
-@INC = '../lib';
+@INC = ( '.', '../lib' );
 
 our $local_tests = 4;
 require "../t/lib/common.pl";
diff --git a/lib/warnings.t b/lib/warnings.t
index ee696fe..7c24f3a 100644
--- a/lib/warnings.t
+++ b/lib/warnings.t
@@ -1,7 +1,7 @@
 #!./perl
 
 chdir 't' if -d 't';
-@INC = '../lib';
+@INC = ( '.', '../lib' );
 
 our $UTF8 = (${^OPEN} || "") =~ /:utf8/;
 require "../t/lib/common.pl";
diff --git a/makedef.pl b/makedef.pl
index 73a80ad..ce16bd9 100644
--- a/makedef.pl
+++ b/makedef.pl
@@ -85,6 +85,39 @@ if ($PLATFORM eq 'win32' or $PLATFORM eq 'wince' or $PLATFORM eq "aix") {
 	foreach (split /\s+/, $options) {
 		$define{$_} = 1;
 	}
+
+{
+    my @PLATFORM = qw(aix win32 wince os2 netware vms test);
+    my %PLATFORM;
+    @PLATFORM{@PLATFORM} = ();
+
+    die "PLATFORM undefined, must be one of: @PLATFORM\n"
+	unless defined $ARGS{PLATFORM};
+    die "PLATFORM must be one of: @PLATFORM\n"
+	unless exists $PLATFORM{$ARGS{PLATFORM}};
+}
+
+# Is the following guard strictly necessary? Added during refactoring
+# to keep the same behaviour when merging other code into here.
+process_cc_flags(@Config{qw(ccflags optimize)})
+    if $ARGS{PLATFORM} ne 'win32' && $ARGS{PLATFORM} ne 'wince'
+    && $ARGS{PLATFORM} ne 'netware';
+
+# Add the compile-time options that miniperl was built with to %define.
+# On Win32 these are not the same options as perl itself will be built
+# with since miniperl is built with a canned config (one of the win32/
+# config_H.*) and none of the BUILDOPT's that are set in the makefiles,
+# but they do include some #define's that are hard-coded in various
+# source files and header files and don't include any BUILDOPT's that
+# the user might have chosen to disable because the canned configs are
+# minimal configs that don't include any of those options.
+
+#don't use the host Perl's -V defines for the WinCE Perl
+if($ARGS{PLATFORM} ne 'wince') {
+    my @options = sort(Config::bincompat_options(), Config::non_bincompat_options());
+    print STDERR "Options: (@options)\n" unless $ARGS{PLATFORM} eq 'test';
+    $define{$_} = 1 foreach @options;
+>>>>>>> 8cbf26c... Patch unit tests to explicitly insert "." into @INC when needed.
 }
 
 my %exportperlmalloc =
diff --git a/regen.pl b/regen.pl
index 14ef147..79b0de2 100644
--- a/regen.pl
+++ b/regen.pl
@@ -13,7 +13,6 @@ require 5.004;	# keep this compatible, an old perl is all we may have before
 
 use strict;
 
-# Which scripts to run.
 
 my @scripts = qw(
 opcode.pl
@@ -26,7 +25,7 @@ embed.pl
 
 my $tap = $ARGV[0] && $ARGV[0] eq '--tap' ? '# ' : '';
 foreach my $pl (map {"regen/$_"} @scripts) {
-  my @command =  ($^X, $pl, @ARGV);
+  my @command =  ($^X, '-I.', $pl, @ARGV);
   print "$tap@command\n";
   system @command;
 }
diff --git a/t/comp/line_debug.t b/t/comp/line_debug.t
index 175c71a..e861a17 100644
--- a/t/comp/line_debug.t
+++ b/t/comp/line_debug.t
@@ -1,5 +1,7 @@
 #!./perl
 
+BEGIN { unshift @INC, '.' }
+
 chdir 't' if -d 't';
 
 sub ok {
diff --git a/t/lib/warnings/op b/t/lib/warnings/op
index e596e79..099006f 100644
--- a/t/lib/warnings/op
+++ b/t/lib/warnings/op
@@ -862,6 +862,7 @@ END { print "in end\n"; }
 print "in mainline\n";
 1;
 --FILE--
+BEGIN { unshift @INC, '.' }
 require abc;
 do "abc.pm";
 EXPECT
diff --git a/t/op/goto.t b/t/op/goto.t
index 5fa3116..7787b46 100644
--- a/t/op/goto.t
+++ b/t/op/goto.t
@@ -229,7 +229,7 @@ YYY: print "OK\n";
 EOT
 close $f;
 
-$r = runperl(prog => 'use Op_goto01; print qq[DONE\n]');
+$r = runperl(prog => 'BEGIN { unshift @INC, q[.] } use Op_goto01; print qq[DONE\n]');
 is($r, "OK\nDONE\n", "goto within use-d file"); 
 unlink_all "Op_goto01.pm";
 
diff --git a/t/porting/regen.t b/t/porting/regen.t
index 78d0599..e822091 100644
--- a/t/porting/regen.t
+++ b/t/porting/regen.t
@@ -56,5 +56,5 @@ OUTER: foreach my $file (@files) {
 }
 
 foreach (@progs, 'regen.pl') {
-  system "$^X $_ --tap";
+  system "$^X -I. $_ --tap";
 }
diff --git a/t/run/switches.t b/t/run/switches.t
index f636cea..9e24c40 100644
--- a/t/run/switches.t
+++ b/t/run/switches.t
@@ -168,12 +168,12 @@ sub import { print map "<\$_>", \@_ }
 SWTESTPM
     close $f or die "Could not close: $!";
     $r = runperl(
-	switches    => [ "-M$package" ],
+	switches    => [ "-I.", "-M$package" ],
 	prog	    => '1',
     );
     is( $r, "<$package>", '-M' );
     $r = runperl(
-	switches    => [ "-M$package=foo" ],
+	switches    => [ "-I.", "-M$package=foo" ],
 	prog	    => '1',
     );
     is( $r, "<$package><foo>", '-M with import parameter' );
@@ -187,7 +187,7 @@ SWTESTPM
         is( $r, '', '-m' );
     }
     $r = runperl(
-	switches    => [ "-m$package=foo,bar" ],
+	switches    => [ "-I.", "-m$package=foo,bar" ],
 	prog	    => '1',
     );
     is( $r, "<$package><foo><bar>", '-m with import parameters' );
diff --git a/t/test.pl b/t/test.pl
index d9b9432..d5072ca 100644
--- a/t/test.pl
+++ b/t/test.pl
@@ -526,7 +526,7 @@ sub _create_runperl { # Create the string to qx in runperl().
 	$runperl = "$ENV{PERL_RUNPERL_DEBUG} $runperl";
     }
     unless ($args{nolib}) {
-	$runperl = $runperl . ' "-I../lib"'; # doublequotes because of VMS
+	$runperl = $runperl . ' "-I../lib" "-I." '; # doublequotes because of VMS
     }
     if ($args{switches}) {
 	local $Level = 2;
@@ -913,6 +913,7 @@ sub run_multiple_progs {
 	open my $fh, '>', $tmpfile or die "Cannot open >$tmpfile: $!";
 	print $fh q{
         BEGIN {
+            push @INC, '.';
             open STDERR, '>&', STDOUT
               or die "Can't dup STDOUT->STDERR: $!;";
         }
