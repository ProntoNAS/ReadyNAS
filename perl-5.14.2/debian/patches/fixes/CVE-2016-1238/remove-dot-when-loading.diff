From 6bdc805019ad38caa443c30204e8a17b2d7b7cb1 Mon Sep 17 00:00:00 2001
From: John Lightsey <lightsey@debian.org>
Date: Wed, 20 Jul 2016 11:34:05 -0500
Subject: (perl #127834) remove . from the end of @INC if complex modules are
 loaded

While currently Encode and Storable are know to attempt to load modules
not included in the core, updates to other modules may lead to those
also attempting to load new modules, so be safe and remove . for those
as well.

Backport of Tony Cook's 5.22 patch to 5.14. Added CPANPLUS, Devel::DProf,
and Module::Build scripts that were not relevant for 5.22.

Bug: https://rt.perl.org/Public/Bug/Display.html?id=127834
Patch-Name: fixes/CVE-2016-1238/remove-dot-when-loading.diff
---
 cpan/Archive-Tar/bin/ptar                 | 1 +
 cpan/Archive-Tar/bin/ptardiff             | 1 +
 cpan/Archive-Tar/bin/ptargrep             | 1 +
 cpan/CPAN/scripts/cpan                    | 1 +
 cpan/CPANPLUS/bin/cpan2dist               | 1 +
 cpan/CPANPLUS/bin/cpanp                   | 1 +
 cpan/Devel-DProf/bin/dprofpp              | 1 +
 cpan/Digest-SHA/shasum                    | 1 +
 cpan/Encode/bin/enc2xs                    | 1 +
 cpan/Encode/bin/piconv                    | 1 +
 cpan/Encode/bin/ucmlint                   | 1 +
 cpan/Encode/bin/unidump                   | 1 +
 cpan/ExtUtils-MakeMaker/bin/instmodsh     | 1 +
 cpan/JSON-PP/bin/json_pp                  | 1 +
 cpan/Module-Build/bin/config_data         | 1 +
 cpan/Test-Harness/bin/prove               | 1 +
 dist/ExtUtils-ParseXS/lib/ExtUtils/xsubpp | 1 +
 dist/Module-CoreList/corelist             | 1 +
 ext/Pod-Html/pod2html.PL                  | 1 +
 utils/c2ph.PL                             | 1 +
 utils/h2ph.PL                             | 1 +
 utils/h2xs.PL                             | 1 +
 utils/libnetcfg.PL                        | 1 +
 utils/perlbug.PL                          | 1 +
 utils/perldoc.PL                          | 5 ++++-
 utils/perlivp.PL                          | 2 ++
 utils/splain.PL                           | 6 ++++++
 27 files changed, 36 insertions(+), 1 deletion(-)

diff --git a/cpan/Archive-Tar/bin/ptar b/cpan/Archive-Tar/bin/ptar
index 7b7cda7..621125d 100644
--- a/cpan/Archive-Tar/bin/ptar
+++ b/cpan/Archive-Tar/bin/ptar
@@ -1,6 +1,7 @@
 #!/usr/bin/perl
 use strict;
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use File::Find;
 use Getopt::Std;
 use Archive::Tar;
diff --git a/cpan/Archive-Tar/bin/ptardiff b/cpan/Archive-Tar/bin/ptardiff
index 21e7d6c..f41a686 100644
--- a/cpan/Archive-Tar/bin/ptardiff
+++ b/cpan/Archive-Tar/bin/ptardiff
@@ -1,5 +1,6 @@
 #!/usr/bin/perl
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use Archive::Tar;
 use Getopt::Std;
diff --git a/cpan/Archive-Tar/bin/ptargrep b/cpan/Archive-Tar/bin/ptargrep
index f0582d8..a2c9172 100644
--- a/cpan/Archive-Tar/bin/ptargrep
+++ b/cpan/Archive-Tar/bin/ptargrep
@@ -4,6 +4,7 @@
 # archive.  See 'ptargrep --help' for more documentation.
 #
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use warnings;
 
diff --git a/cpan/CPAN/scripts/cpan b/cpan/CPAN/scripts/cpan
index 5e56095..8d47c2f 100644
--- a/cpan/CPAN/scripts/cpan
+++ b/cpan/CPAN/scripts/cpan
@@ -1,4 +1,5 @@
 #!/usr/local/bin/perl
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use vars qw($VERSION);
 
diff --git a/cpan/CPANPLUS/bin/cpan2dist b/cpan/CPANPLUS/bin/cpan2dist
index 2764739..0d7e6fa 100644
--- a/cpan/CPANPLUS/bin/cpan2dist
+++ b/cpan/CPANPLUS/bin/cpan2dist
@@ -1,4 +1,5 @@
 #!/usr/bin/perl -w
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use CPANPLUS::Backend;
 use CPANPLUS::Dist;
diff --git a/cpan/CPANPLUS/bin/cpanp b/cpan/CPANPLUS/bin/cpanp
index a493322..4749a75 100644
--- a/cpan/CPANPLUS/bin/cpanp
+++ b/cpan/CPANPLUS/bin/cpanp
@@ -2,6 +2,7 @@
 # $File: //depot/cpanplus/dist/bin/cpanp $
 # $Revision: #8 $ $Change: 8345 $ $DateTime: 2003/10/05 19:25:48 $
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use vars '$VERSION';
 
diff --git a/cpan/Devel-DProf/bin/dprofpp b/cpan/Devel-DProf/bin/dprofpp
index 4f8caeb..f615e91 100644
--- a/cpan/Devel-DProf/bin/dprofpp
+++ b/cpan/Devel-DProf/bin/dprofpp
@@ -4,6 +4,7 @@ require 5.003;
 
 my $stty;
 BEGIN {
+    pop @INC if $INC[-1] eq '.';
     foreach my $s (qw(/bin/stty /usr/bin/stty)) {
 	if (-x $s) {
 	    $stty = $s;
diff --git a/cpan/Digest-SHA/shasum b/cpan/Digest-SHA/shasum
index 0a584cc..20e93da 100644
--- a/cpan/Digest-SHA/shasum
+++ b/cpan/Digest-SHA/shasum
@@ -81,6 +81,7 @@ L<Digest::SHA::PurePerl>.
 
 END_OF_POD
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use Fcntl;
 use Getopt::Long;
diff --git a/cpan/Encode/bin/enc2xs b/cpan/Encode/bin/enc2xs
index bc1ae1b..d93d933 100644
--- a/cpan/Encode/bin/enc2xs
+++ b/cpan/Encode/bin/enc2xs
@@ -4,6 +4,7 @@ BEGIN {
     # with $ENV{PERL_CORE} set
     # In case we need it in future...
     require Config; import Config;
+    pop @INC if $INC[-1] eq '.';
 }
 use strict;
 use warnings;
diff --git a/cpan/Encode/bin/piconv b/cpan/Encode/bin/piconv
index 9fdebd1..5d26896 100644
--- a/cpan/Encode/bin/piconv
+++ b/cpan/Encode/bin/piconv
@@ -1,6 +1,7 @@
 #!./perl
 # $Id: piconv,v 2.4 2009/07/08 13:34:15 dankogai Exp $
 #
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use 5.8.0;
 use strict;
 use Encode ;
diff --git a/cpan/Encode/bin/ucmlint b/cpan/Encode/bin/ucmlint
index 622376d..25e0d67 100644
--- a/cpan/Encode/bin/ucmlint
+++ b/cpan/Encode/bin/ucmlint
@@ -3,6 +3,7 @@
 # $Id: ucmlint,v 2.2 2008/03/12 09:51:11 dankogai Exp $
 #
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 our  $VERSION = do { my @r = (q$Revision: 2.2 $ =~ /\d+/g); sprintf "%d."."%02d" x $#r, @r };
 
diff --git a/cpan/Encode/bin/unidump b/cpan/Encode/bin/unidump
index ae0da30..f190827 100644
--- a/cpan/Encode/bin/unidump
+++ b/cpan/Encode/bin/unidump
@@ -1,5 +1,6 @@
 #!./perl
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use Encode;
 use Getopt::Std;
diff --git a/cpan/ExtUtils-MakeMaker/bin/instmodsh b/cpan/ExtUtils-MakeMaker/bin/instmodsh
index 6a2f03e..0c905ea 100644
--- a/cpan/ExtUtils-MakeMaker/bin/instmodsh
+++ b/cpan/ExtUtils-MakeMaker/bin/instmodsh
@@ -1,5 +1,6 @@
 #!/usr/bin/perl -w
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use IO::File;
 use ExtUtils::Packlist;
diff --git a/cpan/JSON-PP/bin/json_pp b/cpan/JSON-PP/bin/json_pp
index df9d243..896cd2f 100644
--- a/cpan/JSON-PP/bin/json_pp
+++ b/cpan/JSON-PP/bin/json_pp
@@ -1,5 +1,6 @@
 #!/usr/bin/perl
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use Getopt::Long;
 
diff --git a/cpan/Module-Build/bin/config_data b/cpan/Module-Build/bin/config_data
index 40c8ea4..0647a8e 100644
--- a/cpan/Module-Build/bin/config_data
+++ b/cpan/Module-Build/bin/config_data
@@ -1,5 +1,6 @@
 #!/usr/bin/perl
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use Module::Build 0.25;
 use Getopt::Long;
diff --git a/cpan/Test-Harness/bin/prove b/cpan/Test-Harness/bin/prove
index 7c2d5e6..ef57e65 100644
--- a/cpan/Test-Harness/bin/prove
+++ b/cpan/Test-Harness/bin/prove
@@ -1,5 +1,6 @@
 #!/usr/bin/perl -w
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use App::Prove;
 
diff --git a/dist/ExtUtils-ParseXS/lib/ExtUtils/xsubpp b/dist/ExtUtils-ParseXS/lib/ExtUtils/xsubpp
index e4e5b77..faf31bc 100644
--- a/dist/ExtUtils-ParseXS/lib/ExtUtils/xsubpp
+++ b/dist/ExtUtils-ParseXS/lib/ExtUtils/xsubpp
@@ -1,5 +1,6 @@
 #!./miniperl
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 require 5.002;
 use ExtUtils::ParseXS qw(process_file);
 use Getopt::Long;
diff --git a/dist/Module-CoreList/corelist b/dist/Module-CoreList/corelist
index 08f198f..3cee4ce 100644
--- a/dist/Module-CoreList/corelist
+++ b/dist/Module-CoreList/corelist
@@ -76,6 +76,7 @@ requested perl versions.
 
 =cut
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use Module::CoreList;
 use Getopt::Long;
 use Pod::Usage;
diff --git a/ext/Pod-Html/pod2html.PL b/ext/Pod-Html/pod2html.PL
index 366dc16..64fa195 100644
--- a/ext/Pod-Html/pod2html.PL
+++ b/ext/Pod-Html/pod2html.PL
@@ -172,6 +172,7 @@ This program is distributed under the Artistic License.
 
 =cut
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use Pod::Html;
 
 pod2html @ARGV;
diff --git a/utils/c2ph.PL b/utils/c2ph.PL
index 13389ec..cef0b5c 100644
--- a/utils/c2ph.PL
+++ b/utils/c2ph.PL
@@ -280,6 +280,7 @@ Anyway, here it is.  Should run on perl v4 or greater.  Maybe less.
 
 $RCSID = '$Id: c2ph,v 1.7 95/10/28 10:41:47 tchrist Exp Locker: tchrist $';
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use File::Temp;
 
 ######################################################################
diff --git a/utils/h2ph.PL b/utils/h2ph.PL
index 4545d6d..1a95ee0 100644
--- a/utils/h2ph.PL
+++ b/utils/h2ph.PL
@@ -36,6 +36,7 @@ $Config{startperl}
 
 print OUT <<'!NO!SUBS!';
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 
 use Config;
diff --git a/utils/h2xs.PL b/utils/h2xs.PL
index 634e891..b89fa2f 100644
--- a/utils/h2xs.PL
+++ b/utils/h2xs.PL
@@ -495,6 +495,7 @@ See L<perlxs> and L<perlxstut> for additional details.
 =cut
 
 # ' # Grr
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 
 
diff --git a/utils/libnetcfg.PL b/utils/libnetcfg.PL
index 1f47c24..449265a 100644
--- a/utils/libnetcfg.PL
+++ b/utils/libnetcfg.PL
@@ -97,6 +97,7 @@ Jarkko Hietaniemi, conversion into libnetcfg for inclusion into Perl 5.8.
 
 # $Id: Configure,v 1.8 1997/03/04 09:22:32 gbarr Exp $
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use strict;
 use IO::File;
 use Getopt::Std;
diff --git a/utils/perlbug.PL b/utils/perlbug.PL
index 8318531..64de683 100644
--- a/utils/perlbug.PL
+++ b/utils/perlbug.PL
@@ -57,6 +57,7 @@ print OUT <<'!NO!SUBS!';
 my @patches = Config::local_patches();
 my $patch_tags = join "", map /(\S+)/ ? "+$1 " : (), @patches;
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
 use warnings;
 no warnings 'once'; # Eventually, the $::opt_ stuff should get cleaned up
 use strict;
diff --git a/utils/perldoc.PL b/utils/perldoc.PL
index e201de9..cd60bd4 100644
--- a/utils/perldoc.PL
+++ b/utils/perldoc.PL
@@ -44,7 +44,10 @@ $Config{startperl}
 # This "$file" file was generated by "$0"
 
 require 5;
-BEGIN { \$^W = 1 if \$ENV{'PERLDOCDEBUG'} }
+BEGIN {
+    \$^W = 1 if \$ENV{'PERLDOCDEBUG'};
+    pop \@INC if \$INC[-1] eq '.';
+}
 use Pod::Perldoc;
 exit( Pod::Perldoc->run() );
 
diff --git a/utils/perlivp.PL b/utils/perlivp.PL
index 1401cac..faadd68 100644
--- a/utils/perlivp.PL
+++ b/utils/perlivp.PL
@@ -39,6 +39,8 @@ print OUT "\n# perlivp $^V\n";
 
 print OUT <<'!NO!SUBS!';
 
+BEGIN { pop @INC if $INC[-1] eq '.' }
+
 sub usage {
     warn "@_\n" if @_;
     print << "    EOUSAGE";
diff --git a/utils/splain.PL b/utils/splain.PL
index 9c70b61..cae84a0 100644
--- a/utils/splain.PL
+++ b/utils/splain.PL
@@ -38,6 +38,12 @@ $Config{startperl}
 	if \$running_under_some_shell;
 !GROK!THIS!
 
+print <<'!NO!SUBS!';
+
+BEGIN { pop @INC if $INC[-1] eq '.' }
+
+!NO!SUBS!
+
 while (<IN>) {
     print OUT unless /^package diagnostics/;
 }
