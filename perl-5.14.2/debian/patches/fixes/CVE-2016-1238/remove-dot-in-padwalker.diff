From da2b683f30998e3018690667f3c00fdd4abb5fb9 Mon Sep 17 00:00:00 2001
From: John Lightsey <lightsey@debian.org>
Date: Wed, 20 Jul 2016 14:04:42 -0500
Subject: perl5db.pl: ensure PadWalker is loaded from standard paths

Backport of Tony Cook's 5.22 patch to 5.14.

Bug: https://rt.perl.org/Public/Bug/Display.html?id=127834
Patch-Name: fixes/CVE-2016-1238/remove-dot-in-padwalker.diff
---
 lib/perl5db.pl | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/lib/perl5db.pl b/lib/perl5db.pl
index 79863e3..36d6629 100644
--- a/lib/perl5db.pl
+++ b/lib/perl5db.pl
@@ -2602,7 +2602,10 @@ above the current one and then displays then using C<dumpvar.pl>.
                 $cmd =~ /^y(?:\s+(\d*)\s*(.*))?$/ && do {
 
                     # See if we've got the necessary support.
-                    eval { require PadWalker; PadWalker->VERSION(0.08) }
+                    eval {
+                        local @INC = @INC;
+                        pop @INC if $INC[-1] eq '.';
+                        require PadWalker; PadWalker->VERSION(0.08) }
                       or &warn(
                         $@ =~ /locate/
                         ? "PadWalker module not found - please install\n"
@@ -8653,7 +8656,10 @@ if PadWalker could be loaded.
 
 =cut
 
-        if (not $text =~ /::/ and eval { require PadWalker } ) {
+        if (not $text =~ /::/ and eval {
+            local @INC = @INC;
+            pop @INC if $INC[-1] eq '.';
+            require PadWalker } ) {
             my $level = 1;
             while (1) {
                 my @info = caller($level);
