Index: krb5-1.12.1+dfsg/src/kdc/kdc_util.c
===================================================================
--- krb5-1.12.1+dfsg.orig/src/kdc/kdc_util.c	2019-01-20 20:05:32.202606905 +0100
+++ krb5-1.12.1+dfsg/src/kdc/kdc_util.c	2019-01-20 20:05:32.150606907 +0100
@@ -1494,6 +1494,11 @@
 
         memset(&no_server, 0, sizeof(no_server));
 
+        /* Ignore password expiration and needchange attributes (as Windows
+         * does), since S4U2Self is not password authentication. */
+        princ->pw_expiration = 0;
+        clear(princ->attributes, KRB5_KDB_REQUIRES_PWCHANGE);
+
         code = validate_as_request(kdc_active_realm, request, *princ,
                                    no_server, kdc_time, status, &e_data);
         if (code) {
Index: krb5-1.12.1+dfsg/src/lib/krb5/krb/s4u_creds.c
===================================================================
--- krb5-1.12.1+dfsg.orig/src/lib/krb5/krb/s4u_creds.c	2019-01-20 20:05:32.202606905 +0100
+++ krb5-1.12.1+dfsg/src/lib/krb5/krb/s4u_creds.c	2019-01-20 20:05:32.170606906 +0100
@@ -117,7 +117,7 @@
     code = k5_get_init_creds(context, &creds, client, NULL, NULL, 0, NULL,
                              opts, krb5_get_as_key_noop, &userid, &use_master,
                              NULL);
-    if (code == 0 || code == KRB5_PREAUTH_FAILED) {
+    if (!code || code == KRB5_PREAUTH_FAILED || code == KRB5KDC_ERR_KEY_EXP) {
         *canon_user = userid.user;
         userid.user = NULL;
         code = 0;
Index: krb5-1.12.1+dfsg/src/tests/gssapi/t_s4u.py
===================================================================
--- krb5-1.12.1+dfsg.orig/src/tests/gssapi/t_s4u.py	2019-01-20 20:05:32.202606905 +0100
+++ krb5-1.12.1+dfsg/src/tests/gssapi/t_s4u.py	2019-01-20 20:05:32.178606906 +0100
@@ -20,6 +20,13 @@
 # Get forwardable creds for service1 in the default cache.
 realm.kinit(service1, None, ['-f', '-k'])
 
+# Try S4U2Self for user with a restricted password.
+realm.run_kadminl('modprinc +needchange '+realm.user_princ)
+realm.run(['./t_s4u', puser, '-'])
+realm.run_kadminl('modprinc -needchange -pwexpire 1/1/2000 '+realm.user_princ)
+realm.run(['./t_s4u', puser, '-'])
+realm.run_kadminl('modprinc -pwexpire never '+realm.user_princ)
+
 # Try krb5 -> S4U2Proxy with forwardable user creds.  This should fail
 # at the S4U2Proxy step since the DB2 back end currently has no
 # support for allowing it.
