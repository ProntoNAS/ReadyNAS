From 58c721ac2dc96bccd737f3f544f3a22a50477bbf Mon Sep 17 00:00:00 2001
From: Simon Josefsson <simon@josefsson.org>
Date: Sat, 01 Aug 2015 13:12:10 +0000
Subject: libidn: Fix crash in idna_to_unicode_8z8z and idna_to_unicode_8zlz.

---
--- a/lib/idna.c
+++ b/lib/idna.c
@@ -743,13 +743,16 @@
   int rc;
 
   rc = idna_to_unicode_8z4z (input, &ucs4, flags);
+  if (rc != IDNA_SUCCESS)
+    return rc;
+
   *output = stringprep_ucs4_to_utf8 (ucs4, -1, NULL, NULL);
   free (ucs4);
 
   if (!*output)
     return IDNA_ICONV_ERROR;
 
-  return rc;
+  return IDNA_SUCCESS;
 }
 
 /**
@@ -774,13 +777,16 @@
   int rc;
 
   rc = idna_to_unicode_8z8z (input, &utf8, flags);
+  if (rc != IDNA_SUCCESS)
+    return rc;
+
   *output = stringprep_utf8_to_locale (utf8);
   free (utf8);
 
   if (!*output)
     return IDNA_ICONV_ERROR;
 
-  return rc;
+  return IDNA_SUCCESS;
 }
 
 /**
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -27,7 +27,7 @@
 
 ctests = tst_stringprep tst_punycode tst_idna tst_idna2 tst_idna3	\
 	tst_idna4 tst_nfkc tst_pr29 tst_strerror tst_toutf8		\
-	tst_symbols tst_badutf8
+	tst_symbols tst_badutf8 tst_utf8crash
 if TLD
 ctests += tst_tld
 endif
--- /dev/null
+++ b/tests/tst_utf8crash.c
@@ -0,0 +1,48 @@
+/* tst_utf8crash.c --- Self tests for malformed UTF-8 regressions.
+ * Copyright (C) 2015 Simon Josefsson
+ *
+ * This file is part of GNU Libidn.
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ *
+ */
+
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <stdarg.h>
+#include <string.h>
+
+#include <idna.h>
+#include <idn-free.h>
+
+#include "utils.h"
+
+/* Based on report from Adam Sampson:
+   https://lists.gnu.org/archive/html/help-libidn/2015-07/msg00026.html */
+
+void
+doit (void)
+{
+  const char input[] = "\200bad.com";
+  char *output;
+  int rc;
+
+  rc = idna_to_unicode_8z8z(input, &output, 0);
+  if (rc != IDNA_ICONV_ERROR)
+    fail ("rc %d\n", rc);
+}
--- a/tests/Makefile.in
+++ b/tests/Makefile.in
@@ -149,7 +149,7 @@
 	tst_idna$(EXEEXT) tst_idna2$(EXEEXT) tst_idna3$(EXEEXT) \
 	tst_idna4$(EXEEXT) tst_nfkc$(EXEEXT) tst_pr29$(EXEEXT) \
 	tst_strerror$(EXEEXT) tst_toutf8$(EXEEXT) tst_symbols$(EXEEXT) \
-	tst_badutf8$(EXEEXT) $(am__EXEEXT_1)
+	tst_badutf8$(EXEEXT) tst_utf8crash$(EXEEXT) $(am__EXEEXT_1)
 tst_badutf8_SOURCES = tst_badutf8.c
 tst_badutf8_OBJECTS = tst_badutf8.$(OBJEXT)
 tst_badutf8_LDADD = $(LDADD)
@@ -205,6 +205,10 @@
 tst_toutf8_OBJECTS = tst_toutf8.$(OBJEXT)
 tst_toutf8_LDADD = $(LDADD)
 tst_toutf8_DEPENDENCIES = libutils.a ../lib/libidn.la
+tst_utf8crash_SOURCES = tst_utf8crash.c
+tst_utf8crash_OBJECTS = tst_utf8crash.$(OBJEXT)
+tst_utf8crash_LDADD = $(LDADD)
+tst_utf8crash_DEPENDENCIES = libutils.a ../lib/libidn.la
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/build-aux/depcomp
 am__depfiles_maybe = depfiles
@@ -231,11 +235,11 @@
 SOURCES = $(libutils_a_SOURCES) tst_badutf8.c tst_idna.c tst_idna2.c \
 	tst_idna3.c tst_idna4.c tst_nfkc.c tst_pr29.c tst_punycode.c \
 	tst_strerror.c tst_stringprep.c tst_symbols.c tst_tld.c \
-	tst_toutf8.c
+	tst_toutf8.c tst_utf8crash.c
 DIST_SOURCES = $(libutils_a_SOURCES) tst_badutf8.c tst_idna.c \
 	tst_idna2.c tst_idna3.c tst_idna4.c tst_nfkc.c tst_pr29.c \
 	tst_punycode.c tst_strerror.c tst_stringprep.c tst_symbols.c \
-	tst_tld.c tst_toutf8.c
+	tst_tld.c tst_toutf8.c tst_utf8crash.c
 ETAGS = etags
 CTAGS = ctags
 am__tty_colors = \
@@ -1087,7 +1091,7 @@
 libutils_a_SOURCES = utils.h utils.c
 ctests = tst_stringprep tst_punycode tst_idna tst_idna2 tst_idna3 \
 	tst_idna4 tst_nfkc tst_pr29 tst_strerror tst_toutf8 \
-	tst_symbols tst_badutf8 $(am__append_1)
+	tst_symbols tst_badutf8 tst_utf8crash $(am__append_1)
 EXTRA_DIST = libidn.supp
 TESTS_ENVIRONMENT = $(VALGRIND)
 all: all-am
@@ -1179,6 +1183,9 @@
 tst_toutf8$(EXEEXT): $(tst_toutf8_OBJECTS) $(tst_toutf8_DEPENDENCIES) $(EXTRA_tst_toutf8_DEPENDENCIES) 
 	@rm -f tst_toutf8$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(tst_toutf8_OBJECTS) $(tst_toutf8_LDADD) $(LIBS)
+tst_utf8crash$(EXEEXT): $(tst_utf8crash_OBJECTS) $(tst_utf8crash_DEPENDENCIES) $(EXTRA_tst_utf8crash_DEPENDENCIES) 
+	@rm -f tst_utf8crash$(EXEEXT)
+	$(AM_V_CCLD)$(LINK) $(tst_utf8crash_OBJECTS) $(tst_utf8crash_LDADD) $(LIBS)
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)
@@ -1199,6 +1206,7 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tst_symbols.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tst_tld.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tst_toutf8.Po@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tst_utf8crash.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/utils.Po@am__quote@
 
 .c.o:
