From 89406285f318ffad27af4b200204394b2ee6ba5e Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Wed, 16 Nov 2016 15:14:15 +0000
Subject: [PATCH] * libtiff/tif_dirread.c: in TIFFFetchNormalTag(), do not
 dereference NULL pointer when values of tags with TIFF_SETGET_C16_ASCII /
 TIFF_SETGET_C32_ASCII access are 0-byte arrays. Fixes
 http://bugzilla.maptools.org/show_bug.cgi?id=2593 (regression introduced by
 previous fix done on 2016-11-11 for CVE-2016-9297). Reported by Henri Salo.

---
 ChangeLog             | 9 +++++++++
 libtiff/tif_dirread.c | 4 ++--
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index c408bf7..226f8f8 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,12 @@
+2016-11-16 Even Rouault <even.rouault at spatialys.com>
+
+	* libtiff/tif_dirread.c: in TIFFFetchNormalTag(), do not dereference
+	NULL pointer when values of tags with TIFF_SETGET_C16_ASCII / TIFF_SETGET_C32_ASCII
+	access are 0-byte arrays.
+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2593 (regression introduced
+	by previous fix done on 2016-11-11 for CVE-2016-9297).
+	Reported by Henri Salo.
+
 2016-11-11 Even Rouault <even.rouault at spatialys.com>
 
 	* libtiff/tif_dirread.c: in TIFFFetchNormalTag(), make sure that
diff --git a/libtiff/tif_dirread.c b/libtiff/tif_dirread.c
index 068ed4e..3eec79c 100644
--- a/libtiff/tif_dirread.c
+++ b/libtiff/tif_dirread.c
@@ -4999,7 +4999,7 @@ TIFFFetchNormalTag(TIFF* tif, TIFFDirEntry* dp, int recover)
 					if (err==TIFFReadDirEntryErrOk)
 					{
 						int m;
-                        if( data[dp->tdir_count-1] != '\0' )
+                        if( dp->tdir_count > 0 && data[dp->tdir_count-1] != '\0' )
                         {
                             TIFFWarningExt(tif->tif_clientdata,module,"ASCII value for tag \"%s\" does not end in null byte. Forcing it to be null",fip->field_name);
                             data[dp->tdir_count-1] = '\0';
@@ -5176,7 +5176,7 @@ TIFFFetchNormalTag(TIFF* tif, TIFFDirEntry* dp, int recover)
 				if (err==TIFFReadDirEntryErrOk)
 				{
 					int m;
-                    if( data[dp->tdir_count-1] != '\0' )
+                    if( dp->tdir_count > 0 && data[dp->tdir_count-1] != '\0' )
                     {
                         TIFFWarningExt(tif->tif_clientdata,module,"ASCII value for tag \"%s\" does not end in null byte. Forcing it to be null",fip->field_name);
                         data[dp->tdir_count-1] = '\0';
