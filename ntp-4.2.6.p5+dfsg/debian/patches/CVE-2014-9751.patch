#### ChangeSet ####
2015-01-23 10:29:31+00:00, stenn@psp-fb1.ntp.org
  [Sec 2672] Code cleanup: On some OSes ::1 can be spoofed...

==== ntpd/ntp_io.c ====
2015-01-23 10:29:22+00:00, stenn@psp-fb1.ntp.org +10 -12
  [Sec 2672] Code cleanup: On some OSes ::1 can be spoofed...

Index: ntp-4.2.6.p5+dfsg/ntpd/ntp_io.c
===================================================================
--- ntp-4.2.6.p5+dfsg.orig/ntpd/ntp_io.c	2011-12-01 02:55:17.000000000 +0000
+++ ntp-4.2.6.p5+dfsg/ntpd/ntp_io.c	2015-02-04 20:56:40.002393045 +0000
@@ -3470,6 +3470,29 @@
 		    fd, buflen, stoa(&rb->recv_srcadr)));
 
 	/*
+	** Bug 2672: Some OSes (MacOSX and Linux) don't block spoofed ::1
+	*/
+
+	if (AF_INET6 == itf->family) {
+		DPRINTF(2, ("Got an IPv6 packet, from <%s> (%d) to <%s> (%d)\n",
+			stoa(&rb->recv_srcadr),
+			IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&rb->recv_srcadr)),
+			stoa(&itf->sin),
+			!IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&itf->sin))
+			));
+
+		if (   IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&rb->recv_srcadr))
+		    && !IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&itf->sin))
+		   ) {
+			packets_dropped++;
+			DPRINTF(2, ("DROPPING that packet\n"));
+			freerecvbuf(rb);
+			return buflen;
+		}
+		DPRINTF(2, ("processing that packet\n"));
+	}
+
+	/*
 	 * Got one.  Mark how and when it got here,
 	 * put it on the full list and do bookkeeping.
 	 */
