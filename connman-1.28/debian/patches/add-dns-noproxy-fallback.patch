diff --git a/src/dnsproxy.c b/src/dnsproxy.c
index 5ddb813..ac65918 100644
--- a/src/dnsproxy.c
+++ b/src/dnsproxy.c
@@ -1745,6 +1745,8 @@ out:
 	return NULL;
 }
 
+extern void restart_noproxy(void);
+
 static char *uncompress(int16_t field_count, char *start, char *end,
 			char *ptr, char *uncompressed, int uncomp_len,
 			char **uncompressed_ptr)
@@ -1865,6 +1867,9 @@ static char *uncompress(int16_t field_count, char *start, char *end,
 			 */
 			len_ptr[0] = total_len << 8;
 			len_ptr[1] = total_len & 0xff;
+		} else {
+			restart_noproxy();
+			goto out;
 		}
 
 		*uncompressed_ptr = uptr;
@@ -2080,6 +2085,7 @@ static int forward_dns_reply(unsigned char *reply, int reply_len, int protocol,
 							uptr - answers);
 				if (new_len < 0) {
 					DBG("Corrupted packet");
+					restart_noproxy();
 					return -EINVAL;
 				}
 
diff --git a/src/resolver.c b/src/resolver.c
index 01e7c0e..c0c1076 100644
--- a/src/resolver.c
+++ b/src/resolver.c
@@ -91,6 +91,12 @@ static int resolvfile_export(void)
 
 	content = g_string_new("# Generated by Connection Manager\n");
 
+	if (dnsproxy_enabled) {/* Bypass all the crappy stuff. */
+		g_string_append_printf(content,
+			"nameserver 127.0.0.1\nnameserver ::1\n");
+		goto put;
+	}
+
 	/*
 	 * Domains and nameservers are added in reverse so that the most
 	 * recently appended entry is the primary one. No more than
@@ -127,7 +133,7 @@ static int resolvfile_export(void)
 								entry->server);
 		count++;
 	}
-
+put:
 	old_umask = umask(022);
 
 	fd = open("/etc/resolv.conf", O_RDWR | O_CREAT | O_CLOEXEC,
@@ -157,6 +163,19 @@ done:
 	return err;
 }
 
+void restart_noproxy(void)
+{
+	int index = connman_inet_ifindex("lo");
+
+	if (!dnsproxy_enabled)
+		return;
+
+	__connman_resolvfile_remove(index, NULL, "::1");
+	__connman_resolvfile_remove(index, NULL, "127.0.0.1");
+	dnsproxy_enabled = false;
+	resolvfile_export();
+}
+
 int __connman_resolvfile_append(int index, const char *domain,
 							const char *server)
 {
@@ -229,7 +248,7 @@ static void append_fallback_nameservers(void)
 		if (dnsproxy_enabled) {
 			__connman_dnsproxy_append(entry->index, entry->domain,
 					entry->server);
-		} else {
+		} /*else*/ {
 			__connman_resolvfile_append(entry->index,
 					entry->domain, entry->server);
 		}
@@ -251,7 +270,7 @@ static void remove_fallback_nameservers(void)
 		if (dnsproxy_enabled) {
 			__connman_dnsproxy_remove(entry->index, entry->domain,
 					entry->server);
-		} else {
+		} /*else*/ {
 			__connman_resolvfile_remove(entry->index,
 					entry->domain, entry->server);
 		}
@@ -270,7 +289,7 @@ static void remove_entries(GSList *entries)
 		if (dnsproxy_enabled) {
 			__connman_dnsproxy_remove(entry->index, entry->domain,
 							entry->server);
-		} else {
+		} /*else*/ {
 			__connman_resolvfile_remove(entry->index, entry->domain,
 							entry->server);
 		}
@@ -397,7 +416,7 @@ static int append_resolver(int index, const char *domain,
 
 	if (dnsproxy_enabled)
 		__connman_dnsproxy_append(entry->index, domain, server);
-	else
+	/*else*/
 		__connman_resolvfile_append(entry->index, domain, server);
 
 	return 0;
