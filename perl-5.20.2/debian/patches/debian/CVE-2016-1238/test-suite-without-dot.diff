From 8cbf26c9fdc4e6d7dc617e34ce203b8adbf540a8 Mon Sep 17 00:00:00 2001
From: Todd Rinaldo <toddr@cpan.org>
Date: Thu, 31 Mar 2016 17:04:29 -0500
Subject: Patch unit tests to explicitly insert "." into @INC when needed.

(Backported to Debian 5.20 by Niko Tyni <ntyni@debian.org>)

Bug: https://rt.perl.org/Public/Bug/Display.html?id=127810
Patch-Name: debian/CVE-2016-1238/test-suite-without-dot.diff
---
 Makefile.SH                | 2 +-
 Porting/pod_rules.pl       | 2 +-
 TestInit.pm                | 2 +-
 lib/strict.t               | 2 +-
 lib/warnings.t             | 2 +-
 makedef.pl                 | 2 +-
 regen.pl                   | 2 +-
 regen/genpacksizetables.pl | 2 +-
 regen/mg_vtable.pl         | 2 +-
 t/comp/line_debug.t        | 2 ++
 t/lib/warnings/op          | 1 +
 t/op/goto.t                | 2 +-
 t/porting/regen.t          | 2 +-
 t/re/pat.t                 | 2 +-
 t/run/switches.t           | 6 +++---
 t/test.pl                  | 3 ++-
 16 files changed, 20 insertions(+), 16 deletions(-)

diff --git a/Makefile.SH b/Makefile.SH
index dbff8122b..01c1dca8f 100755
--- a/Makefile.SH
+++ b/Makefile.SH
@@ -324,7 +324,7 @@ RUN_PERL = \$(LDLIBPTH) \$(RUN) $perl\$(EXE_EXT)
 	$spitshell >>$Makefile <<!GROK!THIS!
 # Macros to invoke a copy of our fully operational perl during the build.
 PERL_EXE = perl\$(EXE_EXT)
-RUN_PERL = \$(LDLIBPTH) \$(RUN) ./perl\$(EXE_EXT) -Ilib
+RUN_PERL = \$(LDLIBPTH) \$(RUN) ./perl\$(EXE_EXT) -Ilib -I.
 !GROK!THIS!
 	;;
 esac
diff --git a/Porting/pod_rules.pl b/Porting/pod_rules.pl
index 18abe878d..775311faf 100644
--- a/Porting/pod_rules.pl
+++ b/Porting/pod_rules.pl
@@ -26,7 +26,7 @@ use Getopt::Long;
             # plan9 =>  'plan9/mkfile',
            );
 
-require 'Porting/pod_lib.pl';
+require './Porting/pod_lib.pl';
 sub my_die;
 
 # process command-line switches
diff --git a/TestInit.pm b/TestInit.pm
index 16eb318cc..b00e59f37 100644
--- a/TestInit.pm
+++ b/TestInit.pm
@@ -47,7 +47,7 @@ sub import {
 	} elsif ($_ eq 'T') {
 	    $chdir = '..'
 		unless -f 't/TEST' && -f 'MANIFEST' && -d 'lib' && -d 'ext';
-	    @INC = 'lib';
+	    @INC = qw/ lib . /;
 	    $setopt = 1;
 	} else {
 	    die "Unknown option '$_'";
diff --git a/lib/strict.t b/lib/strict.t
index e067793b8..d252c8da9 100644
--- a/lib/strict.t
+++ b/lib/strict.t
@@ -1,7 +1,7 @@
 #!./perl
 
 chdir 't' if -d 't';
-@INC = '../lib';
+@INC = ( '.', '../lib' );
 
 our $local_tests = 4;
 require "../t/lib/common.pl";
diff --git a/lib/warnings.t b/lib/warnings.t
index ee696fe2a..7c24f3af2 100644
--- a/lib/warnings.t
+++ b/lib/warnings.t
@@ -1,7 +1,7 @@
 #!./perl
 
 chdir 't' if -d 't';
-@INC = '../lib';
+@INC = ( '.', '../lib' );
 
 our $UTF8 = (${^OPEN} || "") =~ /:utf8/;
 require "../t/lib/common.pl";
diff --git a/makedef.pl b/makedef.pl
index a44c014e2..a21e20872 100644
--- a/makedef.pl
+++ b/makedef.pl
@@ -59,7 +59,7 @@ while (@ARGV) {
     }
 }
 
-require "$ARGS{TARG_DIR}regen/embed_lib.pl";
+require "./$ARGS{TARG_DIR}regen/embed_lib.pl";
 
 {
     my @PLATFORM = qw(aix win32 wince os2 netware vms test);
diff --git a/regen.pl b/regen.pl
index 878866835..71a6eda60 100644
--- a/regen.pl
+++ b/regen.pl
@@ -15,7 +15,7 @@ use strict;
 
 my $tap = $ARGV[0] && $ARGV[0] eq '--tap' ? '# ' : '';
 foreach my $pl (map {chomp; "regen/$_"} <DATA>) {
-  my @command =  ($^X, $pl, @ARGV);
+  my @command =  ($^X, '-I.', $pl, @ARGV);
   print "$tap@command\n";
   system @command
     and die "@command failed: $?" 
diff --git a/regen/genpacksizetables.pl b/regen/genpacksizetables.pl
index 742eb6fb3..2e3bec580 100644
--- a/regen/genpacksizetables.pl
+++ b/regen/genpacksizetables.pl
@@ -3,7 +3,7 @@
 # it will generate EBCDIC too. (TODO)
 use strict;
 use Encode;
-require 'regen/regen_lib.pl';
+require './regen/regen_lib.pl';
 
 sub make_text {
     my ($chrmap, $letter, $unpredictable, $nocsum, $size, $condition) = @_;
diff --git a/regen/mg_vtable.pl b/regen/mg_vtable.pl
index 0bbfbfdf6..df9adb640 100644
--- a/regen/mg_vtable.pl
+++ b/regen/mg_vtable.pl
@@ -20,7 +20,7 @@ require 5.004;
 
 BEGIN {
     # Get function prototypes
-    require 'regen/regen_lib.pl';
+    require './regen/regen_lib.pl';
 }
 
 my %mg =
diff --git a/t/comp/line_debug.t b/t/comp/line_debug.t
index 8361194bb..71626bbf3 100644
--- a/t/comp/line_debug.t
+++ b/t/comp/line_debug.t
@@ -1,5 +1,7 @@
 #!./perl
 
+BEGIN { unshift @INC, '.' }
+
 chdir 't' if -d 't';
 
 sub ok {
diff --git a/t/lib/warnings/op b/t/lib/warnings/op
index bca28186a..5a01b9958 100644
--- a/t/lib/warnings/op
+++ b/t/lib/warnings/op
@@ -1472,6 +1472,7 @@ END { print "in end\n"; }
 print "in mainline\n";
 1;
 --FILE--
+BEGIN { unshift @INC, '.' }
 require abc;
 do "abc.pm";
 EXPECT
diff --git a/t/op/goto.t b/t/op/goto.t
index 13e6b042a..32684bfb9 100644
--- a/t/op/goto.t
+++ b/t/op/goto.t
@@ -240,7 +240,7 @@ YYY: print "OK\n";
 EOT
 close $f;
 
-$r = runperl(prog => 'use Op_goto01; print qq[DONE\n]');
+$r = runperl(prog => 'BEGIN { unshift @INC, q[.] } use Op_goto01; print qq[DONE\n]');
 is($r, "OK\nDONE\n", "goto within use-d file"); 
 unlink_all "Op_goto01.pm";
 
diff --git a/t/porting/regen.t b/t/porting/regen.t
index 048a0c0e7..93ac58b76 100644
--- a/t/porting/regen.t
+++ b/t/porting/regen.t
@@ -78,7 +78,7 @@ OUTER: foreach my $file (@files) {
 }
 
 foreach (@progs) {
-    my $command = "$^X $_ --tap";
+    my $command = "$^X -I. $_ --tap";
     system $command
         and die "Failed to run $command: $?";
 }
diff --git a/t/re/pat.t b/t/re/pat.t
index 6e694d743..0442ca9ce 100644
--- a/t/re/pat.t
+++ b/t/re/pat.t
@@ -1607,7 +1607,7 @@ EOP
             # #123562]
 
             my $code='
-                BEGIN{require q(test.pl);}
+                BEGIN{require q(./test.pl);}
                 use Encode qw(_utf8_on);
                 my $malformed = "a\x80\n";
                 _utf8_on($malformed);
diff --git a/t/run/switches.t b/t/run/switches.t
index a2e4bad47..2d88c23cb 100644
--- a/t/run/switches.t
+++ b/t/run/switches.t
@@ -193,12 +193,12 @@ sub import { print map "<\$_>", \@_ }
 SWTESTPM
     close $f or die "Could not close: $!";
     $r = runperl(
-	switches    => [ "-M$package" ],
+	switches    => [ "-I.", "-M$package" ],
 	prog	    => '1',
     );
     is( $r, "<$package>", '-M' );
     $r = runperl(
-	switches    => [ "-M$package=foo" ],
+	switches    => [ "-I.", "-M$package=foo" ],
 	prog	    => '1',
     );
     is( $r, "<$package><foo>", '-M with import parameter' );
@@ -212,7 +212,7 @@ SWTESTPM
         is( $r, '', '-m' );
     }
     $r = runperl(
-	switches    => [ "-m$package=foo,bar" ],
+	switches    => [ "-I.", "-m$package=foo,bar" ],
 	prog	    => '1',
     );
     is( $r, "<$package><foo><bar>", '-m with import parameters' );
diff --git a/t/test.pl b/t/test.pl
index 0fdc4f42a..f9e4166a4 100644
--- a/t/test.pl
+++ b/t/test.pl
@@ -597,7 +597,7 @@ sub _create_runperl { # Create the string to qx in runperl().
 	$runperl = "$ENV{PERL_RUNPERL_DEBUG} $runperl";
     }
     unless ($args{nolib}) {
-	$runperl = $runperl . ' "-I../lib"'; # doublequotes because of VMS
+	$runperl = $runperl . ' "-I../lib" "-I." '; # doublequotes because of VMS
     }
     if ($args{switches}) {
 	local $Level = 2;
@@ -1185,6 +1185,7 @@ sub run_multiple_progs {
 	open my $fh, '>', $tmpfile or die "Cannot open >$tmpfile: $!";
 	print $fh q{
         BEGIN {
+            push @INC, '.';
             open STDERR, '>&', STDOUT
               or die "Can't dup STDOUT->STDERR: $!;";
         }
