From 8717f2a8932ddc69da5822d4325b50c1ea7cf507 Mon Sep 17 00:00:00 2001
From: Tony Cook <tony@develop-help.com>
Date: Thu, 23 Jun 2016 10:41:48 +1000
Subject: perl5db.pl: ensure PadWalker is loaded from standard paths

Origin: backport
Bug: https://rt.perl.org/Public/Bug/Display.html?id=127834
Patch-Name: fixes/CVE-2016-1238/remove-dot-in-padwalker.diff
---
 lib/perl5db.pl | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/lib/perl5db.pl b/lib/perl5db.pl
index f962fb8e0..a1f867b5e 100644
--- a/lib/perl5db.pl
+++ b/lib/perl5db.pl
@@ -1930,7 +1930,10 @@ sub _DB__handle_y_command {
         = $obj->cmd_args =~ /\A(?:(\d*)\s*(.*))?\z/) {
 
         # See if we've got the necessary support.
-        if (!eval { require PadWalker; PadWalker->VERSION(0.08) }) {
+        if (!eval {
+            local @INC = @INC;
+            pop @INC if $INC[-1] eq '.';
+            require PadWalker; PadWalker->VERSION(0.08) }) {
             my $Err = $@;
             _db_warn(
                 $Err =~ /locate/
@@ -9365,7 +9368,10 @@ if PadWalker could be loaded.
 
 =cut
 
-        if (not $text =~ /::/ and eval { require PadWalker } ) {
+        if (not $text =~ /::/ and eval {
+            local @INC = @INC;
+            pop @INC if $INC[-1] eq '.';
+            require PadWalker } ) {
             my $level = 1;
             while (1) {
                 my @info = caller($level);
