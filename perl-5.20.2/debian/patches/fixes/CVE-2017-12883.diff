From 6a4f0b80f4ffedbf30755a0015eca9758661f59c Mon Sep 17 00:00:00 2001
From: Karl Williamson <khw@cpan.org>
Date: Fri, 25 Aug 2017 11:33:58 -0600
Subject: PATCH: [perl #131598]

The cause of this is that the vFAIL macro uses RExC_parse, and that
variable has just been changed in preparation for code after the vFAIL.
The solution is to not change RExC_parse until after the vFAIL.

This is a case where the macro hides stuff that can bite you.

(backported to 5.20 by Niko Tyni)

Origin: backport, https://perl5.git.perl.org/perl.git/commit/2be4edede4ae226e2eebd4eff28cedd2041f300f
Bug: https://rt.perl.org/Public/Bug/Display.html?id=131598
Bug-Debian: https://bugs.debian.org/875597
Patch-Name: fixes/CVE-2017-12883.diff
---
 regcomp.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/regcomp.c b/regcomp.c
index ddb5d12d5..a3406e5f7 100644
--- a/regcomp.c
+++ b/regcomp.c
@@ -10836,12 +10836,14 @@ S_grok_bslash_N(pTHX_ RExC_state_t *pRExC_state, regnode** node_p,
 	}
 	sv_catpv(substitute_parse, ")");
 
-	RExC_parse = SvPV(substitute_parse, len);
+        len = SvCUR(substitute_parse);
 
 	/* Don't allow empty number */
 	if (len < 8) {
 	    vFAIL("Invalid hexadecimal number in \\N{U+...}");
 	}
+
+	RExC_parse = SvPV_nolen(substitute_parse);
 	RExC_end = RExC_parse + len;
 
 	/* The values are Unicode, and therefore not subject to recoding */
