From a9fe54f06cb40c50a757923aa9d49d2562cc8971 Mon Sep 17 00:00:00 2001
From: Niko Tyni <ntyni@debian.org>
Date: Wed, 13 Sep 2017 23:21:31 +0300
Subject: regcomp: Fix out of bound reads

This is a backport of 730480ce9e3e0103efa8f551281a62b39f573b1a
to the 5.20 series, fixing further out of bound reads related
to CVE-2017-12883.

Origin: backport, https://perl5.git.perl.org/perl.git/commit/730480ce9e3e0103efa8f551281a62b39f573b1a
Bug: https://rt.perl.org/Public/Bug/Display.html?id=131598
Bug-Debian: https://bugs.debian.org/875597
Patch-Name: fixes/CVE-2017-12883-5.20.diff
---
 regcomp.c | 21 ++++++++++++---------
 1 file changed, 12 insertions(+), 9 deletions(-)

diff --git a/regcomp.c b/regcomp.c
index a3406e5f7..b37730c38 100644
--- a/regcomp.c
+++ b/regcomp.c
@@ -11170,7 +11170,7 @@ S_regatom(pTHX_ RExC_state_t *pRExC_state, I32 *flagp, U32 depth)
     dVAR;
     regnode *ret = NULL;
     I32 flags = 0;
-    char *parse_start = RExC_parse;
+    char *parse_start;
     U8 op;
     int invert = 0;
 
@@ -11183,6 +11183,7 @@ S_regatom(pTHX_ RExC_state_t *pRExC_state, I32 *flagp, U32 depth)
     PERL_ARGS_ASSERT_REGATOM;
 
 tryagain:
+    parse_start = RExC_parse;
     switch ((U8)*RExC_parse) {
     case '^':
 	RExC_seen_zerolen++;
@@ -11271,7 +11272,7 @@ tryagain:
 	break;
     case '{':
 	if (!regcurly(RExC_parse, FALSE)) {
-	    RExC_parse++;
+	    RExC_parse = parse_start;
 	    goto defchar;
 	}
 	/* FALL THROUGH */
@@ -11488,7 +11489,7 @@ tryagain:
                                 FALSE /* not strict */ )) {
                 if (*flagp & RESTART_UTF8)
                     return NULL;
-                RExC_parse--;
+                RExC_parse = parse_start;
                 goto defchar;
             }
             break;
@@ -11590,6 +11591,7 @@ tryagain:
                             && *RExC_parse != '8' && *RExC_parse != '9'))
                     {
                         /* Probably a character specified in octal, e.g. \35 */
+                        RExC_parse = parse_start;
                         goto defchar;
                     }
                 }
@@ -11640,7 +11642,7 @@ tryagain:
 	default:
 	    /* Do not generate "unrecognized" warnings here, we fall
 	       back into the quick-grab loop below */
-	    parse_start--;
+	    RExC_parse = parse_start;
 	    goto defchar;
 	}
 	break;
@@ -11654,10 +11656,6 @@ tryagain:
 
     default:
 
-            parse_start = RExC_parse - 1;
-
-	    RExC_parse++;
-
 	defchar: {
 	    STRLEN len = 0;
 	    UV ender = 0;
@@ -11721,7 +11719,12 @@ tryagain:
              * could back off to end with only a code point that isn't such a
              * non-final, but it is possible for there not to be any in the
              * entire node. */
-	    for (p = RExC_parse - 1;
+
+            assert(   ! UTF     /* Is at the beginning of a character */
+                   || UTF8_IS_INVARIANT(UCHARAT(RExC_parse))
+                   || UTF8_IS_START(UCHARAT(RExC_parse)));
+
+	    for (p = RExC_parse;
 	         len < upper_parse && p < RExC_end;
 	         len++)
 	    {
